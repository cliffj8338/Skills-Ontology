<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueprint™</title>
    <!-- v4.7.0 | 20260219 | Audit fixes: dead code removal, history nav, resize handler, profile state resets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ===== THEME VARIABLES ===== */
        :root {
            /* Dark theme (default) */
            --bg-base:        #0f0f1e;
            --bg-surface:     #1a1a2e;
            --bg-elevated:    rgba(26,26,46,0.8);
            --bg-card:        rgba(26,26,46,0.6);
            --border:         rgba(96,165,250,0.2);
            --border-strong:  rgba(96,165,250,0.4);
            --text-primary:   #e0e0e0;
            --text-secondary: #9ca3af;
            --text-muted:     #6b7280;
            --accent:         #60a5fa;
            --accent-glow:    rgba(96,165,250,0.15);
            --nav-bg:         rgba(15,15,30,0.95);
            --nav-border:     rgba(96,165,250,0.15);
            --filter-bg:      rgba(15,15,30,0.92);
            --filter-border:  rgba(96,165,250,0.12);
            --chip-bg:        rgba(96,165,250,0.1);
            --chip-hover:     rgba(96,165,250,0.2);
            --input-bg:       rgba(255,255,255,0.05);
            --shadow:         0 8px 32px rgba(0,0,0,0.4);
            --success:        #10b981;
            --warning:        #f59e0b;
            --danger:         #ef4444;
        }

        [data-theme="light"] {
            --bg-base:        #f0f4f8;
            --bg-surface:     #ffffff;
            --bg-elevated:    rgba(255,255,255,0.95);
            --bg-card:        rgba(255,255,255,0.85);
            --border:         rgba(59,130,246,0.2);
            --border-strong:  rgba(59,130,246,0.4);
            --text-primary:   #1e293b;
            --text-secondary: #475569;
            --text-muted:     #94a3b8;
            --accent:         #2563eb;
            --accent-glow:    rgba(37,99,235,0.1);
            --nav-bg:         rgba(255,255,255,0.97);
            --nav-border:     rgba(59,130,246,0.15);
            --filter-bg:      rgba(248,250,252,0.97);
            --filter-border:  rgba(59,130,246,0.1);
            --chip-bg:        rgba(37,99,235,0.08);
            --chip-hover:     rgba(37,99,235,0.15);
            --input-bg:       rgba(0,0,0,0.04);
            --shadow:         0 8px 32px rgba(0,0,0,0.12);
            --success:        #059669;
            --warning:        #d97706;
            --danger:         #dc2626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        [data-theme="light"] body,
        [data-theme="light"] {
            background: linear-gradient(135deg, #e8f0fe 0%, #f0f4f8 100%);
        }

        /* ===== LIGHT THEME COMPONENT OVERRIDES ===== */

        /* Cards & surfaces */
        [data-theme="light"] .domain-card {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        [data-theme="light"] .domain-card:hover {
            border-color: rgba(37,99,235,0.35);
            box-shadow: 0 4px 16px rgba(37,99,235,0.1);
        }
        [data-theme="light"] .domain-title { color: #2563eb; }
        [data-theme="light"] .skill-item {
            background: rgba(0,0,0,0.02);
        }
        [data-theme="light"] .skill-item:hover { background: rgba(37,99,235,0.04); }
        [data-theme="light"] .skill-name { color: #1e293b; }

        /* Opportunity cards */
        [data-theme="light"] .opportunity-card {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        [data-theme="light"] .opportunity-card:hover {
            border-color: rgba(37,99,235,0.4);
            box-shadow: 0 4px 16px rgba(37,99,235,0.1);
        }
        [data-theme="light"] .opportunity-title { color: #1e293b; }
        [data-theme="light"] .opportunity-company { color: #64748b; }

        /* Application cards */
        [data-theme="light"] .application-card {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        [data-theme="light"] .application-meta-value { color: #1e293b; }
        [data-theme="light"] .application-notes {
            background: rgba(37,99,235,0.04);
            color: #475569;
        }
        [data-theme="light"] .application-btn {
            background: rgba(37,99,235,0.08);
            border-color: rgba(37,99,235,0.25);
            color: #2563eb;
        }

        /* Blueprint sections */
        [data-theme="light"] .blueprint-section {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        [data-theme="light"] .outcome-item {
            background: rgba(0,0,0,0.02);
            border-color: rgba(59,130,246,0.15);
        }
        [data-theme="light"] .outcome-item:hover {
            background: rgba(37,99,235,0.04);
            border-color: rgba(37,99,235,0.3);
        }
        [data-theme="light"] .outcome-text { color: #1e293b; }
        [data-theme="light"] .value-card {
            background: #ffffff;
            border-color: rgba(59,130,246,0.2);
        }
        [data-theme="light"] .value-title { color: #1e293b; }
        [data-theme="light"] .value-description { color: #64748b; }
        [data-theme="light"] .coaching-tip {
            background: linear-gradient(135deg, rgba(245,158,11,0.08) 0%, rgba(251,191,36,0.06) 100%);
        }
        [data-theme="light"] .coaching-tip-content { color: #475569; }
        [data-theme="light"] .purpose-editor {
            background: rgba(0,0,0,0.03);
            border-color: rgba(59,130,246,0.25);
            color: #1e293b;
        }
        [data-theme="light"] .purpose-editor:focus {
            background: rgba(37,99,235,0.04);
        }
        [data-theme="light"] .reflection-prompts {
            background: rgba(139,92,246,0.06);
            border-color: rgba(139,92,246,0.2);
        }
        [data-theme="light"] .reflection-prompts li { color: #475569; }

        /* Modal */
        [data-theme="light"] .modal-content {
            background: #ffffff;
            border-color: rgba(59,130,246,0.2);
        }
        [data-theme="light"] .modal-header {
            background: rgba(248,250,252,0.98);
            border-bottom-color: rgba(59,130,246,0.12);
        }
        [data-theme="light"] .modal-title { color: #2563eb; }
        [data-theme="light"] .modal-years { color: #64748b; }
        [data-theme="light"] .evidence-item {
            background: rgba(37,99,235,0.04);
            border-left-color: #2563eb;
            color: #1e293b;
        }
        [data-theme="light"] .story-text {
            background: rgba(0,0,0,0.03);
            color: #334155;
        }

        /* Tooltip */
        [data-theme="light"] .tooltip {
            background: rgba(255,255,255,0.98);
            border-color: rgba(37,99,235,0.3);
            color: #1e293b;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        [data-theme="light"] .tooltip-title { color: #2563eb; }
        [data-theme="light"] .tooltip-roles { color: #475569; }
        [data-theme="light"] .tooltip-role-tag { background: rgba(37,99,235,0.1); }

        /* Settings & forms */
        [data-theme="light"] .settings-input,
        [data-theme="light"] .settings-select {
            background: rgba(0,0,0,0.04);
            border-color: rgba(59,130,246,0.25);
            color: #1e293b;
        }
        [data-theme="light"] .settings-input:focus,
        [data-theme="light"] .settings-select:focus {
            border-color: #2563eb;
            background: rgba(37,99,235,0.04);
        }
        [data-theme="light"] .your-skill-item {
            background: rgba(0,0,0,0.02);
            border-left-color: #2563eb;
        }
        [data-theme="light"] .your-skill-item:hover { background: rgba(37,99,235,0.05); }
        [data-theme="light"] .onet-skill-item {
            background: rgba(0,0,0,0.02);
            border-color: rgba(59,130,246,0.15);
        }
        [data-theme="light"] .onet-skill-item:hover:not(.disabled) {
            background: rgba(37,99,235,0.05);
            border-color: rgba(37,99,235,0.3);
        }
        [data-theme="light"] .onet-skill-name { color: #1e293b; }
        [data-theme="light"] .onet-skill-definition { color: #64748b; }

        /* Action buttons */
        [data-theme="light"] .action-btn {
            background: rgba(37,99,235,0.07);
            border-color: rgba(37,99,235,0.25);
            color: #2563eb;
        }
        [data-theme="light"] .action-btn:hover {
            background: rgba(37,99,235,0.14);
            border-color: rgba(37,99,235,0.4);
        }

        /* Opportunities filter bar */
        [data-theme="light"] .opportunities-filters {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
        }

        /* Network SVG background */
        [data-theme="light"] #networkView {
            background: linear-gradient(135deg, #e8f0fe 0%, #f0f4f8 100%);
        }

        /* General text in content areas */
        [data-theme="light"] .blueprint-tagline { color: #475569; }
        [data-theme="light"] .blueprint-subtitle { color: #64748b; }
        [data-theme="light"] .section-count {
            background: rgba(37,99,235,0.1);
            color: #2563eb;
        }
        [data-theme="light"] .meta-tag.category {
            background: rgba(37,99,235,0.1);
            color: #2563eb;
        }
        [data-theme="light"] .meta-tag.evidence {
            background: rgba(5,150,105,0.1);
            color: #059669;
        }
        [data-theme="light"] .skill-badge {
            background: rgba(217,119,6,0.12);
            color: #b45309;
        }
        /* General content text colors in light mode */
        [data-theme="light"] .matched-skills-title { color: #2563eb; }
        [data-theme="light"] .filter-section-label { color: #2563eb; }
        [data-theme="light"] .opportunities-title { color: #2563eb; }
        [data-theme="light"] .opportunities-subtitle { color: #64748b; }
        [data-theme="light"] .match-label { color: #94a3b8; }
        [data-theme="light"] .meta-item { color: #64748b; }
        [data-theme="light"] .applications-header h1 { color: #1e293b; }
        [data-theme="light"] .modal-section-title { color: #2563eb; }
        [data-theme="light"] .roles-tags .role-tag {
            background: rgba(37,99,235,0.08);
            border-color: rgba(37,99,235,0.2);
            color: #1e293b;
        }
        [data-theme="light"] .related-skill-chip {
            background: rgba(220,38,38,0.06);
            border-color: rgba(220,38,38,0.2);
            color: #dc2626;
        }
        [data-theme="light"] .outcome-coaching {
            background: rgba(245,158,11,0.08);
            color: #b45309;
        }
        [data-theme="light"] .outcome-btn {
            background: rgba(37,99,235,0.07);
            border-color: rgba(37,99,235,0.25);
            color: #2563eb;
        }
        [data-theme="light"] .add-outcome-btn {
            background: rgba(37,99,235,0.04);
            border-color: rgba(37,99,235,0.25);
            color: #2563eb;
        }
        [data-theme="light"] .export-section {
            background: linear-gradient(135deg, rgba(220,38,38,0.06) 0%, rgba(185,28,28,0.06) 100%);
            border-color: rgba(220,38,38,0.2);
        }

        /* Network node labels readable on light background */
        [data-theme="light"] .node text {
            fill: #1e293b;
            text-shadow: 0 0 5px #e8f0fe, 0 0 5px #e8f0fe, 0 0 5px #e8f0fe;
        }
        [data-theme="light"] .node.role text {
            fill: #1e293b;
            text-shadow: 0 0 5px #e8f0fe, 0 0 5px #e8f0fe;
        }
        [data-theme="light"] .node.center text {
            fill: #2563eb;
            text-shadow: 0 0 6px #e8f0fe, 0 0 6px #e8f0fe;
        }
        [data-theme="light"] .node.skill text { fill: #334155; }
        [data-theme="light"] .link { stroke: #94a3b8; }

        /* Settings view panels */
        [data-theme="light"] .settings-tabs,
        [data-theme="light"] .skills-view-tabs,
        [data-theme="light"] .skill-mgmt-content { 
            background: rgba(0,0,0,0.03);
        }
        [data-theme="light"] .settings-tab,
        [data-theme="light"] .skills-tab,
        [data-theme="light"] .skill-mgmt-tab { color: #64748b; }
        [data-theme="light"] .settings-tab:hover,
        [data-theme="light"] .skills-tab:hover { background: rgba(37,99,235,0.06); color: #1e293b; }
        [data-theme="light"] .quick-action-bar .btn-secondary {
            background: rgba(0,0,0,0.05);
            border-color: rgba(0,0,0,0.12);
            color: #475569;
        }
        
        /* ===== NAV BAR ===== */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--nav-bg);
            border-bottom: 1px solid var(--nav-border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .header-logo {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .header-left h1 {
            color: var(--accent);
            font-family: 'Outfit', sans-serif;
            font-size: 0.82em;
            font-weight: 500;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            margin: 0;
            white-space: nowrap;
        }

        .header-left h1 span {
            color: var(--accent);
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 2px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 7px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-size: 0.72em;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            transition: all 0.18s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover {
            background: var(--chip-bg);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 2px 8px rgba(96,165,250,0.3);
        }

        [data-theme="light"] .nav-btn.active {
            box-shadow: 0 2px 8px rgba(37,99,235,0.25);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        /* Theme toggle */
        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        /* Profile switcher */
        .profile-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px 6px 6px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .profile-chip:hover {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .profile-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #818cf8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }

        .profile-name {
            font-size: 0.82em;
            font-weight: 600;
            color: var(--text-primary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .profile-caret {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Profile dropdown */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 220px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 8px;
            display: none;
            z-index: 200;
            backdrop-filter: blur(20px);
        }

        .profile-dropdown.open {
            display: block;
            animation: dropIn 0.15s ease;
        }

        @keyframes dropIn {
            from { opacity: 0; transform: translateY(-6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .profile-dropdown-label {
            font-size: 0.72em;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 4px 8px 8px;
        }

        .profile-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .profile-option:hover {
            background: var(--chip-bg);
        }

        .profile-option.active-profile {
            background: var(--accent-glow);
        }

        .profile-option-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #818cf8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }

        .profile-option-info { flex: 1; overflow: hidden; }
        .profile-option-name {
            font-size: 0.88em;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .profile-option-title {
            font-size: 0.75em;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-option-check {
            color: var(--accent);
            font-size: 12px;
        }

        /* More menu button */
        .more-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.2s;
            letter-spacing: -1px;
        }

        .more-btn:hover, .more-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }
        
        #statsBar {
            display: inline-flex;
            gap: 15px;
            align-items: center;
        }
        
        .stat-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        #consentView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #settingsView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #applicationsView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        .applications-header {
            margin-bottom: 30px;
        }
        
        .applications-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .application-card {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .application-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .application-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .status-applied {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .status-interviewing {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .status-offer {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-rejected {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }
        
        .application-title {
            font-size: 1.2em;
            color: #e0e0e0;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .application-company {
            color: #9ca3af;
            margin-bottom: 15px;
        }
        
        .application-meta-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
        }
        
        .application-meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .application-meta-label {
            font-size: 0.75em;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .application-meta-value {
            color: #e0e0e0;
            font-size: 0.95em;
        }
        
        .application-notes {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid rgba(96, 165, 250, 0.5);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #d1d5db;
            line-height: 1.5;
        }
        
        .application-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .application-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .application-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .application-btn.delete {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .application-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        .settings-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: inherit;
        }
        
        .settings-input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .settings-select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: inherit;
        }
        
        .settings-group {
            margin-bottom: 25px;
        }
        
        .settings-label {
            display: block;
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .settings-help {
            color: #9ca3af;
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            min-height: 45px;
        }
        
        .tag-chip {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tag-remove {
            cursor: pointer;
            color: #ef4444;
            font-weight: bold;
        }
        
        .save-settings-btn {
            width: 100%;
            padding: 15px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .save-settings-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        /* ===== CONTEXTUAL FILTER BAR ===== */
        .controls {
            background: var(--filter-bg);
            border-bottom: 1px solid var(--filter-border);
            padding: 8px 24px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: space-between;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            min-height: 48px;
        }

        .controls-left {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .filter-label {
            color: var(--text-muted);
            font-size: 0.75em;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* Collapsible filter panel */
        .filter-panel {
            display: none;
            width: 100%;
            padding: 10px 0 4px;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            animation: fadeIn 0.15s ease;
        }

        .filter-panel.open {
            display: flex;
        }

        .filter-toggle-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--chip-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
            transition: all 0.18s;
        }

        .filter-toggle-btn:hover, .filter-toggle-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        /* Search input */
        .filter-search {
            padding: 5px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.85em;
            width: 200px;
            transition: all 0.2s;
            outline: none;
        }

        .filter-search:focus {
            border-color: var(--accent);
            background: var(--accent-glow);
            width: 240px;
        }

        .filter-search::placeholder {
            color: var(--text-muted);
        }

        /* View toggle pills */
        .view-pills {
            display: flex;
            gap: 2px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 3px;
        }

        .view-pill {
            padding: 4px 12px;
            border-radius: 5px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .view-pill.active {
            background: var(--accent);
            color: #fff;
        }

        /* Export button */
        .export-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239,68,68,0.3);
        }
        
        .role-chip {
            background: var(--chip-bg);
            border: 1px solid var(--border);
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.18s;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .role-chip:hover {
            background: var(--chip-hover);
            border-color: var(--border-strong);
            color: var(--text-primary);
        }

        .role-chip.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .level-filter {
            display: flex;
            gap: 8px;
        }
        
        .level-chip {
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            border: 1px solid transparent;
        }
        
        .level-chip.mastery {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .level-chip.mastery.active {
            background: #ef4444;
            color: #fff;
        }
        
        .level-chip.advanced {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .level-chip.advanced.active {
            background: #f59e0b;
            color: #fff;
        }
        
        .level-chip.proficient {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .level-chip.proficient.active {
            background: #10b981;
            color: #fff;
        }
        
        .level-chip.expert {
            background: rgba(249, 115, 22, 0.2);
            border-color: rgba(249, 115, 22, 0.3);
        }
        
        .level-chip.expert.active {
            background: #f97316;
            color: #fff;
        }
        
        .level-chip.novice {
            background: rgba(107, 114, 128, 0.2);
            border-color: rgba(107, 114, 128, 0.3);
        }
        
        .level-chip.novice.active {
            background: #6b7280;
            color: #fff;
        }
        
        .label-toggle {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(96, 165, 250, 0.3);
            transition: .3s;
            border-radius: 20px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #60a5fa;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .toggle-label {
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        .main-content {
            position: relative;
            height: calc(100vh - 56px);
        }

        /* When filter bar is visible (Skills tab), reduce height */
        .main-content.with-filters {
            height: calc(100vh - 56px - 48px);
        }
        
        #networkView {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #cardView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        #opportunitiesView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #blueprintView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
            background: var(--bg-base);
        }
        
        .blueprint-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .blueprint-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.3);
        }
        
        .blueprint-title {
            font-size: 2.5em;
            color: #60a5fa;
            margin-bottom: 10px;
        }
        
        .blueprint-subtitle {
            font-size: 1.2em;
            color: #9ca3af;
            margin-bottom: 20px;
        }
        
        .blueprint-tagline {
            font-size: 1em;
            color: #d1d5db;
            font-style: italic;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Blueprint Sub-Navigation */
        .blueprint-subnav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.15);
            padding-bottom: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .bp-tab {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 10px 18px 12px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-muted);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            margin-bottom: -2px;
        }
        
        .bp-tab:hover { color: var(--text-primary); }
        
        .bp-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }
        
        .bp-tab-icon { font-size: 1.1em; }
        
        .bp-tab-count {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            font-size: 0.75em;
            padding: 1px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .bp-tab.active .bp-tab-count {
            background: rgba(96, 165, 250, 0.3);
        }
        
        [data-theme="light"] .bp-tab-count {
            background: rgba(37, 99, 235, 0.12);
            color: #2563eb;
        }

        .blueprint-section {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .blueprint-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        }
        
        .blueprint-section-title {
            font-size: 1.5em;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-icon {
            font-size: 1.3em;
        }
        
        .section-count {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
        }
        
        .coaching-tip {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            border-left: 4px solid #fbbf24;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        
        .coaching-tip-title {
            color: #fbbf24;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .coaching-tip-content {
            color: #d1d5db;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .coaching-tip-content ul {
            margin: 10px 0 0 20px;
        }
        
        .coaching-tip-content li {
            margin: 5px 0;
        }
        
        .outcome-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .outcome-item:hover {
            border-color: rgba(96, 165, 250, 0.4);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .outcome-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .outcome-text {
            flex: 1;
            font-size: 1.05em;
            color: #e0e0e0;
            line-height: 1.5;
        }
        
        .outcome-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .share-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .share-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .share-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(107, 114, 128, 0.3);
            transition: .3s;
            border-radius: 26px;
        }
        
        .share-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        .share-toggle input:checked + .share-toggle-slider {
            background-color: #10b981;
        }
        
        .share-toggle input:checked + .share-toggle-slider:before {
            transform: translateX(24px);
        }
        
        .outcome-meta {
            display: flex;
            gap: 15px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(96, 165, 250, 0.1);
            flex-wrap: wrap;
        }
        
        .meta-tag {
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .meta-tag.category {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .meta-tag.evidence {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .meta-tag.sensitive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .outcome-coaching {
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid #fbbf24;
            padding: 10px 15px;
            margin-top: 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #fbbf24;
        }
        
        .outcome-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .outcome-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .outcome-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .add-outcome-btn {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.05);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .add-outcome-btn:hover {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .reflection-prompts {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .reflection-title {
            color: #a78bfa;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 0.95em;
        }
        
        .reflection-prompts ul {
            list-style: none;
            padding: 0;
        }
        
        .reflection-prompts li {
            color: #d1d5db;
            padding: 8px 0;
            padding-left: 20px;
            position: relative;
            font-size: 0.9em;
        }
        
        .reflection-prompts li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #a78bfa;
        }
        
        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .value-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(96, 165, 250, 0.2);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .value-card.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .value-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .value-title {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 5px;
        }
        
        .value-description {
            font-size: 0.85em;
            color: #9ca3af;
            line-height: 1.4;
        }
        
        .purpose-editor {
            width: 100%;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: #e0e0e0;
            font-size: 1em;
            line-height: 1.6;
            font-family: inherit;
            resize: vertical;
        }
        
        .purpose-editor:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .export-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        
        .export-title {
            color: #ef4444;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .export-btn-large {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: #ef4444;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn-large:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .opportunities-header {
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        
        .opportunities-title {
            font-size: 2em;
            color: #60a5fa;
            margin-bottom: 10px;
        }
        
        .opportunities-subtitle {
            color: #9ca3af;
            font-size: 1.1em;
            margin-bottom: 30px;
        }
        
        .opportunities-filters {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-section-label {
            color: #60a5fa;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .match-slider {
            width: 200px;
        }
        
        .match-value {
            color: #fbbf24;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .opportunity-card {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(26, 26, 46, 0.6) 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .opportunity-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .opportunity-company {
            font-size: 0.9em;
            color: #9ca3af;
            margin-bottom: 5px;
        }
        
        .opportunity-title {
            font-size: 1.2em;
            color: #e0e0e0;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .match-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .match-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            font-weight: bold;
            position: relative;
        }
        
        .match-circle.high {
            background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 3px solid #10b981;
            color: #10b981;
        }
        
        .match-circle.medium {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 3px solid #f59e0b;
            color: #f59e0b;
        }
        
        .match-circle.low {
            background: radial-gradient(circle, rgba(107, 114, 128, 0.2) 0%, rgba(107, 114, 128, 0.05) 100%);
            border: 3px solid #6b7280;
            color: #6b7280;
        }
        
        .match-label {
            font-size: 0.75em;
            color: #9ca3af;
            text-transform: uppercase;
        }
        
        .opportunity-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .matched-skills {
            margin-bottom: 15px;
        }
        
        .matched-skills-title {
            font-size: 0.85em;
            color: #60a5fa;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .skill-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .skill-chip-match {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        
        .skill-chip-gap {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        
        .opportunity-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(96, 165, 250, 0.1);
        }
        
        .action-btn {
            flex: 1;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .action-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(96, 165, 250, 0.2);
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Job Cart styles */
        .jobs-subtabs {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }
        .jobs-subtab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .jobs-subtab:hover { color: var(--text-secondary); }
        .jobs-subtab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .job-cart-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .job-cart-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }
        .job-cart-match { display:flex; align-items:center; gap:8px; }
        .job-cart-match-bar {
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            flex: 1;
            overflow: hidden;
        }
        .job-cart-match-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        .jd-skill-chip {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin: 2px;
        }
        .jd-chip-matched {
            background: rgba(16,185,129,0.15);
            border: 1px solid rgba(16,185,129,0.3);
            color: #10b981;
        }
        .jd-chip-gap {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.25);
            color: #ef4444;
        }
        .jd-chip-surplus {
            background: rgba(107,114,128,0.1);
            border: 1px solid rgba(107,114,128,0.2);
            color: #6b7280;
        }
        
        /* Network match overlay */
        .match-mode-toggle {
            display: inline-flex;
            gap: 0;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            margin-left: 8px;
        }
        .match-mode-btn {
            padding: 5px 14px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.78em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border-right: 1px solid var(--border);
        }
        .match-mode-btn:last-child { border-right: none; }
        .match-mode-btn:hover { color: var(--text-secondary); }
        .match-mode-btn.active {
            background: var(--accent);
            color: #fff;
        }
        .match-legend {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
            padding: 8px 18px;
            border-radius: 20px;
            background: rgba(15,15,30,0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(96,165,250,0.15);
            z-index: 10;
            font-size: 0.75em;
        }
        [data-theme="light"] .match-legend {
            background: rgba(255,255,255,0.92);
            border-color: rgba(0,0,0,0.1);
        }
        .match-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-muted);
        }
        .match-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .match-active-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 6px;
            background: rgba(96,165,250,0.1);
            border: 1px solid rgba(96,165,250,0.25);
            font-size: 0.78em;
            color: var(--accent);
            margin-left: 8px;
        }
        .match-active-badge button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 2px;
            line-height: 1;
        }
        .match-active-badge button:hover { color: #ef4444; }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .domain-card {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(26, 26, 46, 0.6) 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .domain-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .domain-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        }
        
        .domain-icon {
            font-size: 24px;
        }
        
        .domain-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #60a5fa;
        }
        
        .skill-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid transparent;
            margin-bottom: 8px;
            flex-wrap: wrap;
            min-width: 0;
        }
        
        .skill-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .skill-name {
            flex: 1;
            font-size: 0.95em;
            min-width: 80px;
        }
        
        .skill-badge {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .skill-years {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .skill-impact-badge {
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* Mobile card view */
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            #cardView {
                padding: 12px;
            }
            
            .domain-card {
                padding: 14px;
            }
            
            .domain-title {
                font-size: 1.1em;
            }
            
            .skill-item {
                padding: 8px 10px;
                gap: 6px;
            }
            
            .skill-name {
                font-size: 0.9em;
                width: 100%;
                flex-basis: calc(100% - 22px);
            }
            
            /* On mobile, badges wrap below the skill name naturally */
            .skill-badge, .skill-years, .skill-impact-badge {
                font-size: 0.68em;
            }
        }
        
        /* Network styles */
        .node circle {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .node.dimmed circle {
            opacity: 0.2;
        }
        
        .node.highlighted circle {
            stroke-width: 4px;
            filter: brightness(1.3);
        }
        
        .node text {
            font-size: 11px;
            pointer-events: none;
            text-shadow: 0 0 4px #000, 0 0 4px #000, 0 0 4px #000;
            fill: #e0e0e0;
            display: block;
        }
        
        .node text.hidden {
            display: none;
        }
        
        .node.role text {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .node.center text {
            font-size: 16px;
            font-weight: bold;
            fill: #60a5fa;
            text-shadow: 0 0 6px #000, 0 0 6px #000;
        }
        
        .node.skill text {
            font-size: 10px;
        }
        
        .link {
            stroke: #4a5568;
            stroke-opacity: 0.3;
            stroke-width: 1.5px;
            fill: none;
        }
        
        .link.dimmed {
            opacity: 0.1;
        }
        
        .link.highlighted {
            stroke: #60a5fa;
            stroke-opacity: 0.8;
            stroke-width: 2.5px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(26, 26, 46, 0.98);
            border: 1px solid #60a5fa;
            border-radius: 8px;
            padding: 15px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 350px;
            font-size: 13px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .tooltip-title {
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .tooltip-level {
            color: #fbbf24;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .tooltip-roles {
            color: #d1d5db;
            line-height: 1.6;
        }
        
        .tooltip-role-tag {
            display: inline-block;
            background: rgba(96, 165, 250, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            margin: 2px;
            font-size: 11px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a2e;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            padding: 0;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            width: 90%;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 30px 30px 20px 30px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(26, 26, 46, 0.6) 100%);
        }
        
        .modal-header-left {
            flex: 1;
        }
        
        .modal-title {
            font-size: 1.8em;
            color: #60a5fa;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .modal-subtitle {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .modal-level-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .modal-level-badge.mastery {
            background: #ef4444;
            color: #fff;
        }
        
        .modal-level-badge.advanced {
            background: #f59e0b;
            color: #fff;
        }
        
        .modal-level-badge.proficient {
            background: #10b981;
            color: #fff;
        }
        
        .modal-years {
            color: #9ca3af;
            font-size: 0.9em;
        }
        
        .modal-core-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
        }
        
        .modal-category-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: 600;
            border: 1px solid currentColor;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-section {
            margin-bottom: 30px;
        }
        
        .modal-section:last-child {
            margin-bottom: 0;
        }
        
        .modal-section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-section-icon {
            font-size: 1.2em;
        }
        
        .evidence-list {
            list-style: none;
            padding: 0;
        }
        
        .evidence-item {
            background: rgba(96, 165, 250, 0.05);
            border-left: 3px solid #60a5fa;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            line-height: 1.6;
        }
        
        .evidence-item strong {
            color: #60a5fa;
        }
        
        .story-text {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            line-height: 1.7;
            color: #d1d5db;
        }
        
        .roles-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .role-tag {
            background: rgba(96, 165, 250, 0.2);
            border: 1px solid rgba(96, 165, 250, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .related-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .related-skill-chip {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .related-skill-chip:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-2px);
        }
        
        .placeholder-text {
            color: #6b7280;
            font-style: italic;
            font-size: 0.9em;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .export-option {
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-option:hover {
            background: rgba(96, 165, 250, 0.2);
            transform: translateY(-2px);
        }
        
        .export-option-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .export-option-desc {
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        /* ===== MOBILE RESPONSIVENESS ===== */
        @media (max-width: 768px) {
            .header {
                padding: 0 14px;
                height: 52px;
            }

            .header-center {
                display: none;
            }

            .header-left h1 {
                font-size: 0.9em;
            }

            /* Mobile: nav as bottom bar */
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--nav-bg);
                border-top: 1px solid var(--nav-border);
                backdrop-filter: blur(20px);
                padding: 8px 0 max(8px, env(safe-area-inset-bottom));
                z-index: 100;
                justify-content: space-around;
            }

            .mobile-nav-btn {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                padding: 4px 12px;
                border: none;
                background: transparent;
                color: var(--text-muted);
                font-family: 'Outfit', sans-serif;
                font-size: 0.58em;
                font-weight: 500;
                letter-spacing: 0.06em;
                text-transform: uppercase;
                cursor: pointer;
                transition: color 0.2s;
            }

            .mobile-nav-btn.active {
                color: var(--accent);
            }

            .mobile-nav-icon {
                font-size: 1.4em;
            }

            .main-content, .main-content.with-filters {
                height: calc(100vh - 52px - 60px);
            }

            .controls {
                flex-direction: column;
                padding: 10px 14px;
            }
            
            .filter-group {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .role-chip {
                font-size: 0.75em;
                padding: 6px 10px;
            }
            
            .opportunities-grid {
                grid-template-columns: 1fr;
            }
            
            .opportunity-card {
                padding: 15px;
            }
            
            .opportunity-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
            
            .values-grid {
                grid-template-columns: 1fr;
            }
            
            .welcome-steps-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            #welcomeView {
                padding-bottom: 80px;
            }
            
            .match-mode-toggle {
                margin-left: 0;
                margin-top: 4px;
            }
            .match-active-badge {
                margin-left: 0;
                margin-top: 4px;
                font-size: 0.7em;
            }
            .match-legend {
                gap: 8px;
                padding: 6px 12px;
                font-size: 0.68em;
                bottom: 70px; /* Above mobile nav */
            }
            
            .blueprint-section {
                padding: 20px;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .export-btn-large {
                width: 100%;
            }
            
            /* Network view adjustments for mobile */
            #networkView {
                touch-action: pan-x pan-y;
            }
            
            .network-controls {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .label-toggle {
                font-size: 0.75em;
            }
        }
        
        @media (max-width: 480px) {
            .header-left h1 {
                font-size: 0.85em;
            }

            .profile-name {
                display: none;
            }

            .filter-search {
                width: 140px;
            }

            .filter-label {
                font-size: 0.7em;
            }

            .role-chip {
                font-size: 0.72em;
                padding: 4px 8px;
            }
            
            .blueprint-title {
                font-size: 1.8em;
            }
            
            .blueprint-subtitle {
                font-size: 1em;
            }
            
            .modal-content {
                width: 95% !important;
                max-width: none !important;
                padding: 16px !important;
                margin: 8px;
                max-height: 92vh !important;
            }
            
            /* Make full-height modals (Manage Skills, O*NET) slide up from bottom on mobile */
            .modal-content[style*="900px"],
            .modal-content[style*="max-height: 90vh"] {
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 16px 16px 0 0 !important;
                margin: 0 !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                max-height: 88vh !important;
            }
            
            /* Skill banner at bottom — compact on mobile */
            .sample-profile-banner {
                padding: 10px 14px;
                font-size: 0.85em;
            }
            
            /* O*NET tab bar — scrollable on mobile */
            .onet-tab {
                font-size: 0.72em;
                padding: 6px 10px;
                white-space: nowrap;
            }
        }
        
        /* Overflow Menu Styles */
        .overflow-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-width: 220px;
            z-index: 300;
            padding: 8px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            animation: dropIn 0.15s ease;
        }

        .overflow-menu button {
            width: 100%;
            text-align: left;
            padding: 10px 14px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.88em;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overflow-menu button:hover {
            background: var(--chip-bg);
        }
        
        /* Skills View Tabs */
        .skills-view-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .skills-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .skills-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #d1d5db;
        }
        
        .skills-tab.active {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
        }
        
        /* Quick Action Bar */
        .quick-action-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .quick-action-bar .btn-primary {
            padding: 10px 16px;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .quick-action-bar .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
        }
        
        .quick-action-bar .btn-secondary {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action-bar .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .settings-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
        }
        
        .settings-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #d1d5db;
        }
        
        .settings-tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        /* Skill Management Styles */
        .onet-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
        }
        
        .onet-tab:hover {
            color: #d1d5db;
        }
        
        .onet-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }
        
        .onet-category {
            margin-bottom: 20px;
        }
        
        .onet-category-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .onet-category-title:hover {
            color: #93c5fd;
        }
        
        .onet-subcategory {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .onet-subcategory-title {
            font-size: 0.95em;
            font-weight: 500;
            color: #9ca3af;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .onet-skill-item {
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .onet-skill-item:hover:not(.disabled) {
            background: rgba(255,255,255,0.08);
            border-color: rgba(96, 165, 250, 0.3);
        }
        
        .onet-skill-item.selected {
            background: rgba(96, 165, 250, 0.15);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .onet-skill-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .onet-skill-checkbox {
            margin-top: 2px;
            cursor: pointer;
        }
        
        .onet-skill-checkbox:disabled {
            cursor: not-allowed;
        }
        
        .onet-skill-content {
            flex: 1;
        }
        
        .onet-skill-name {
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .onet-skill-definition {
            font-size: 0.9em;
            color: #9ca3af;
            line-height: 1.4;
        }
        
        .onet-skill-added {
            font-size: 0.8em;
            color: #10b981;
            font-weight: 600;
        }
        
        /* Skill Search Results (v2.3.0) */
        .skill-search-result {
            transition: all 0.2s ease;
        }
        
        .skill-search-result:not(.added):hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .skill-search-result.added {
            opacity: 0.6;
        }
        
        /* Unified Skill Management (v2.4.0) */
        .skill-mgmt-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .skill-mgmt-tab:hover {
            color: #e0e0e0;
            background: rgba(255,255,255,0.05);
        }
        
        .skill-mgmt-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .skill-mgmt-content {
            animation: fadeIn 0.2s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(16px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .your-skill-item {
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            border-left: 3px solid #60a5fa;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .your-skill-item:hover {
            background: rgba(255,255,255,0.06);
            transform: translateX(4px);
        }
        /* ===== AUTH MODAL ===== */
        .auth-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .auth-overlay.active { display: flex; }
        .auth-dialog {
            background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px;
            width: 100%; max-width: 420px; padding: 36px; position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        [data-theme="light"] .auth-dialog { background: #fff; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .auth-dialog h2 { color: var(--accent); font-size: 1.4em; margin-bottom: 6px; }
        .auth-dialog .auth-subtitle { color: var(--text-secondary); font-size: 0.9em; margin-bottom: 24px; }
        .auth-close { position: absolute; top: 14px; right: 18px; background: none; border: none;
            color: var(--text-muted); font-size: 1.4em; cursor: pointer; }
        .auth-input {
            width: 100%; padding: 12px 14px; background: var(--bg-base); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary); font-size: 0.95em; margin-bottom: 12px;
            outline: none; transition: border-color 0.2s;
        }
        .auth-input:focus { border-color: var(--accent); }
        [data-theme="light"] .auth-input { background: #f9fafb; }
        .auth-btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 0.95em;
            font-weight: 600; cursor: pointer; transition: opacity 0.2s;
        }
        .auth-btn:hover { opacity: 0.9; }
        .auth-btn-primary { background: var(--accent); color: #fff; }
        .auth-btn-google {
            background: #fff; color: #333; border: 1px solid #ddd;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .auth-btn-google:hover { background: #f5f5f5; }
        .auth-btn-magic { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
        .auth-divider {
            display: flex; align-items: center; margin: 18px 0; gap: 12px;
            color: var(--text-muted); font-size: 0.82em;
        }
        .auth-divider::before, .auth-divider::after {
            content: ''; flex: 1; height: 1px; background: var(--border);
        }
        .auth-toggle { color: var(--text-secondary); font-size: 0.88em; text-align: center; margin-top: 18px; }
        .auth-toggle a { color: var(--accent); cursor: pointer; text-decoration: underline; }
        .auth-error { color: #ef4444; font-size: 0.85em; margin-bottom: 12px; display: none; }
        .auth-success { color: #10b981; font-size: 0.85em; margin-bottom: 12px; display: none; }
        .auth-nav-btn {
            padding: 8px 16px; border-radius: 8px; font-size: 0.85em; font-weight: 600;
            cursor: pointer; border: 1px solid var(--accent); color: var(--accent); background: transparent;
            transition: all 0.2s;
        }
        .auth-nav-btn:hover { background: var(--accent); color: #fff; }
        .auth-nav-btn.signed-in { border-color: #10b981; color: #10b981; }
        .admin-badge {
            font-size: 0.65em; padding: 2px 6px; border-radius: 4px;
            background: rgba(251,191,36,0.15); color: #fbbf24; font-weight: 700;
            vertical-align: middle; margin-left: 6px; letter-spacing: 0.5px;
        }
        .sample-badge {
            font-size: 0.65em; padding: 2px 6px; border-radius: 4px;
            background: rgba(96,165,250,0.15); color: #60a5fa; font-weight: 700;
            vertical-align: middle; margin-left: 6px; letter-spacing: 0.5px;
        }
        .readonly-banner {
            background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.25);
            color: #fbbf24; padding: 10px 20px; text-align: center; font-size: 0.88em;
            font-weight: 600; position: sticky; top: 0; z-index: 50;
        }
        [data-theme="light"] .readonly-banner {
            background: rgba(217,119,6,0.08); border-color: rgba(217,119,6,0.2); color: #b45309;
        }
        .welcome-hero {
            max-width: 720px; margin: 60px auto; padding: 0 24px; text-align: center;
        }
        .welcome-hero h2 {
            font-size: 2.2em; font-weight: 700; color: var(--accent);
            margin-bottom: 16px; line-height: 1.2;
        }
        .welcome-hero .welcome-sub {
            font-size: 1.1em; color: var(--text-secondary); line-height: 1.7;
            margin-bottom: 40px;
        }
        .welcome-cards {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            margin-bottom: 48px; text-align: left;
        }
        @media (max-width: 600px) { .welcome-cards { grid-template-columns: 1fr; } }
        .welcome-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 14px; padding: 28px; cursor: pointer;
            transition: border-color 0.2s, transform 0.15s;
        }
        .welcome-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        [data-theme="light"] .welcome-card { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .welcome-card h3 { color: var(--text-primary); font-size: 1.15em; margin-bottom: 8px; }
        .welcome-card p { color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; margin: 0; }
        .welcome-features {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
            margin-bottom: 48px; text-align: left;
        }
        @media (max-width: 700px) { .welcome-features { grid-template-columns: 1fr; } }
        @media (max-width: 600px) {
            .welcome-hero h2 { font-size: 1.6em; }
        }
        .welcome-feature {
            padding: 20px; border-radius: 10px;
            background: var(--bg-card); border: 1px solid var(--border);
        }
        .welcome-feature .wf-icon { font-size: 1.6em; margin-bottom: 8px; }
        .welcome-feature h4 { color: var(--text-primary); font-size: 0.95em; margin-bottom: 4px; }
        .welcome-feature p { color: var(--text-muted); font-size: 0.82em; line-height: 1.4; margin: 0; }
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>
    
    <!-- Auth Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-dialog">
            <button class="auth-close" onclick="closeAuthModal()">&times;</button>
            <div id="authModalContent">
                <!-- Populated by showAuthModal() -->
            </div>
        </div>
    </div>
    <!-- ===== NAV BAR ===== -->
    <div class="header">
        <!-- Left: Logo + wordmark -->
        <div class="header-left" style="cursor:pointer;" onclick="switchView('welcome')">
            <div class="header-logo"><svg width="26" height="26" viewBox="0 0 52 52" fill="none">
                <circle cx="26" cy="26" r="24" stroke="#60a5fa" stroke-width="1.5" opacity="0.22"/>
                <line x1="26" y1="26" x2="12" y2="10" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="26" y1="26" x2="42" y2="12" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="26" y1="26" x2="40" y2="40" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="26" y1="26" x2="10" y2="40" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="12" y1="10" x2="42" y2="12" stroke="#60a5fa" stroke-width="0.8" opacity="0.12"/>
                <line x1="42" y1="12" x2="40" y2="40" stroke="#60a5fa" stroke-width="0.8" opacity="0.12"/>
                <line x1="10" y1="40" x2="40" y2="40" stroke="#60a5fa" stroke-width="0.8" opacity="0.12"/>
                <circle cx="26" cy="26" r="4.5" fill="#60a5fa"/>
                <circle cx="12" cy="10" r="3" fill="#93bbfc"/>
                <circle cx="42" cy="12" r="2.5" fill="#818cf8"/>
                <circle cx="40" cy="40" r="3" fill="#93bbfc"/>
                <circle cx="10" cy="40" r="2.5" fill="#818cf8"/>
            </svg></div>
            <h1>Blueprint<span style="font-size:0.55em; vertical-align:super; letter-spacing:0; opacity:0.6;">&trade;</span></h1>
        </div>

        <!-- Center: Primary navigation -->
        <div class="header-center" id="mainNav">
            <button class="nav-btn active" id="nav-skills"      onclick="switchView('skills', event)">🎯 Skills</button>
            <button class="nav-btn"         id="nav-jobs"        onclick="switchView('jobs', event)">💼 Jobs</button>
            <button class="nav-btn"         id="nav-applications" onclick="switchView('applications', event)">📋 Applications</button>
            <button class="nav-btn"         id="nav-blueprint"   onclick="switchView('blueprint', event)">📊 Blueprint</button>
        </div>

        <!-- Right: theme toggle + profile switcher + more -->
        <div class="header-right">
            <!-- Stats badge — visible on all tabs -->
            <span id="statsBar" style="font-size:0.78em; color: var(--text-muted); white-space:nowrap; display:none;"></span>

            <!-- Theme toggle -->
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggleBtn" title="Toggle light/dark mode">🌙</button>

            <!-- Auth button (shown when not logged in) -->
            <button class="auth-nav-btn" id="authNavBtn" onclick="showAuthModal('signin')" style="display:none;">Sign In</button>

            <!-- Profile switcher -->
            <div class="profile-chip" onclick="toggleProfileDropdown(event)" id="profileChip">
                <div class="profile-avatar" id="profileAvatar">...</div>
                <span class="profile-name" id="profileChipName">Loading</span>
                <span class="profile-caret">▾</span>
                <!-- Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-label">Switch Profile</div>
                    <div id="profileDropdownOptions">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Hidden select for backward-compat with switchProfile() -->
            <select id="profileSelector" onchange="switchProfile(this.value)" style="display:none;"></select>

            <!-- More menu -->
            <button class="more-btn" onclick="toggleOverflowMenu(event)" id="overflowMenuBtn" title="More options">···</button>
            <div id="overflowMenu" class="overflow-menu" style="display:none;">
                <button onclick="closeOverflowMenu(); switchView('welcome');" style="color: var(--accent); font-weight: 600;">🏠 Home</button>
                <button onclick="closeOverflowMenu(); showOnboardingWizard();" style="color: var(--accent); font-weight: 600;">Build My Blueprint</button>
                <button onclick="closeOverflowMenu(); viewSampleProfile();">📊 View Sample Profiles</button>
                <div style="height:1px; background:var(--border); margin:4px 0;"></div>
                <button onclick="switchView('settings', event); closeOverflowMenu();">⚙️ Settings</button>
                <button onclick="closeOverflowMenu(); switchView('blueprint'); setTimeout(function(){ switchBlueprintTab('export'); }, 100);">📄 Export Blueprint</button>
                <button onclick="switchView('consent'); closeOverflowMenu();">🔒 Consent Settings</button>
                <button onclick="showHelp(); closeOverflowMenu();">❓ Help</button>
                <button onclick="showAbout(); closeOverflowMenu();">ℹ️ About</button>
                <div style="height:1px; background:var(--border); margin:4px 0;"></div>
                <button id="overflowSignIn" onclick="showAuthModal('signin'); closeOverflowMenu();" style="color: var(--accent);">🔐 Sign In</button>
                <button id="overflowSignOut" onclick="authSignOut(); closeOverflowMenu();" style="color: #ef4444; display:none;">⏻ Sign Out</button>
            </div>
        </div>
    </div>

    <!-- ===== CONTEXTUAL FILTER BAR (Skills tab only) ===== -->
    <div class="controls" id="controlsBar" style="display:none;">
        <div class="controls-left">
            <!-- View pills -->
            <div class="view-pills" id="skillsViewToggle">
                <button class="view-pill active" data-view="network" onclick="toggleSkillsView('network')">Network</button>
                <button class="view-pill" data-view="card" onclick="toggleSkillsView('card')">Card</button>
            </div>

            <!-- Job match mode toggle (hidden until a job is activated) -->
            <div id="matchModeToggle" style="display:none;" class="match-mode-toggle">
                <button class="match-mode-btn active" data-mode="you" onclick="setNetworkMatchMode('you')">You</button>
                <button class="match-mode-btn" data-mode="job" onclick="setNetworkMatchMode('job')">Job</button>
                <button class="match-mode-btn" data-mode="match" onclick="setNetworkMatchMode('match')">Match</button>
            </div>
            
            <!-- Active job badge (hidden until a job is activated) -->
            <div id="matchActiveBadge" style="display:none;" class="match-active-badge">
                <span>🎯</span>
                <span id="matchActiveTitle">Loading...</span>
                <button onclick="clearJobOverlay()" title="Clear comparison">×</button>
            </div>

            <!-- Search -->
            <input type="text" id="skillSearch" class="filter-search" placeholder="🔍 Search skills..."
                   onkeyup="filterSkillsView(this.value)">

            <!-- Filter toggle -->
            <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleFilterPanel()">
                <span>⚙ Filter</span>
                <span id="filterActiveCount" style="display:none; background:var(--accent); color:#fff; border-radius:8px; padding:1px 6px; font-size:0.75em;"></span>
            </button>
        </div>

        <div class="controls-right" id="networkControls">
            <div class="label-toggle">
                <span class="toggle-label">Role Labels</span>
                <label class="toggle-switch">
                    <input type="checkbox" checked onchange="toggleLabels('role')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="label-toggle">
                <span class="toggle-label">Skill Labels</span>
                <label class="toggle-switch">
                    <input type="checkbox" checked onchange="toggleLabels('skill')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Collapsible filter panel -->
        <div class="filter-panel" id="filterPanel">
            <div class="filter-group" id="rolesFilterGroup">
                <span class="filter-label">Roles:</span>
                <div id="roleChipsContainer">
                    <div class="role-chip active" data-role="all" onclick="filterByRole('all')">All</div>
                </div>
            </div>
            <div class="filter-group">
                <span class="filter-label">Level:</span>
                <div class="level-filter" id="levelChipsContainer"></div>
            </div>
        </div>
        
        <!-- Network active filter indicator (floats when role is selected via node click) -->
        <div id="networkFilterPill" style="display:none; position:absolute; top:110px; left:50%; transform:translateX(-50%);
            z-index:50; background:var(--bg-elevated); border:1px solid var(--accent); border-radius:20px;
            padding:6px 14px 6px 12px; font-family:'Outfit',sans-serif; font-size:0.75em; font-weight:500;
            color:var(--accent); display:none; align-items:center; gap:8px; backdrop-filter:blur(12px);
            box-shadow:0 4px 16px rgba(0,0,0,0.2); cursor:default; letter-spacing:0.04em;">
            <span id="networkFilterPillDot" style="width:8px; height:8px; border-radius:50%; flex-shrink:0;"></span>
            <span id="networkFilterPillText"></span>
            <button onclick="filterByRole('all')" style="background:none; border:none; color:var(--text-muted);
                cursor:pointer; font-size:1.2em; padding:0 0 0 4px; line-height:1;"
                onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-muted)'">&times;</button>
        </div>
    </div>
    
    <div class="main-content">
        <div id="welcomeView" style="display:none;"></div>
        <svg id="networkView" style="display:none;"></svg>
        <div id="cardView" style="display:none;"></div>
        <div id="opportunitiesView" style="display:none;"></div>
        <div id="applicationsView" style="display:none;"></div>
        <div id="blueprintView" style="display:none;"></div>
        <div id="consentView" style="display:none;"></div>
        <div id="settingsView" style="display:none;"></div>
    </div>

    <!-- App Footer / Attribution -->
    <footer id="appFooter" style="text-align:center; padding:16px 20px; font-size:0.75em; opacity:0.5; line-height:1.8;">
        <div style="margin-bottom:4px;">&copy; <script>document.write(new Date().getFullYear())</script> Cliff Jurkiewicz. All rights reserved. Blueprint&trade; and its associated methodologies, ontology structures, and matching algorithms are the intellectual property of Cliff Jurkiewicz.</div>
        <div>Uses the <a href="https://esco.ec.europa.eu" target="_blank" rel="noopener" style="color:inherit; text-decoration:underline;">ESCO classification</a> of the European Commission and <a href="https://www.onetonline.org" target="_blank" rel="noopener" style="color:inherit; text-decoration:underline;">O*NET</a> occupational data. <a href="#" onclick="event.preventDefault(); showLegalNotice();" style="color:inherit; text-decoration:underline;">Legal &amp; IP Notice</a> &middot; <a href="#" onclick="event.preventDefault(); switchView('consent'); setTimeout(function(){ var el=document.getElementById('disclaimerSection'); if(el) el.scrollIntoView({behavior:'smooth'}); }, 300);" style="color:inherit; text-decoration:underline;">Disclaimer</a></div>
    </footer>
    
    <!-- Mobile bottom nav (hidden on desktop via CSS) -->
    <div class="mobile-nav" id="mobileNav" style="display:none;">
        <button class="mobile-nav-btn active" id="mob-skills" onclick="switchView('skills',event)">
            <span class="mobile-nav-icon">🎯</span>Skills
        </button>
        <button class="mobile-nav-btn" id="mob-jobs" onclick="switchView('jobs',event)">
            <span class="mobile-nav-icon">💼</span>Jobs
        </button>
        <button class="mobile-nav-btn" id="mob-applications" onclick="switchView('applications',event)">
            <span class="mobile-nav-icon">📋</span>Apps
        </button>
        <button class="mobile-nav-btn" id="mob-blueprint" onclick="switchView('blueprint',event)">
            <span class="mobile-nav-icon">📊</span>Blueprint
        </button>
        <button class="mobile-nav-btn" id="mob-more" onclick="toggleOverflowMenu(event)">
            <span class="mobile-nav-icon">···</span>More
        </button>
    </div>

    <div class="tooltip" id="tooltip"></div>
    
    <!-- Skill Detail Modal -->
    <div class="modal" id="skillModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title" id="skillDetailTitle"></h2>
                    <div class="modal-subtitle" id="skillDetailSubtitle"></div>
                </div>
                <button class="modal-close" onclick="closeSkillModal()">×</button>
            </div>
            <div class="modal-body" id="skillDetailBody"></div>
        </div>
    </div>
    
    <!-- Export Modal (used dynamically for outcome editing and value notes) -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Export Options</h2>
                </div>
                <button class="modal-close" onclick="closeExportModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="color: #9ca3af; margin-bottom: 20px;">All export options are available in the Blueprint tab.</p>
                <button onclick="closeExportModal(); switchView('blueprint'); setTimeout(function(){ switchBlueprintTab('export'); }, 100);" style="
                    background:var(--accent); color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em;
                ">Go to Export Options</button>
            </div>
        </div>
    </div>

    <!-- O*NET Skill Picker Modal -->
    <div class="modal" id="onetPickerModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Add Skills from O*NET Library</h2>
                </div>
                <button class="modal-close" onclick="closeONETPicker()">×</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; flex-shrink: 0; padding-bottom: 1px;"
                         class="onet-tab-bar">
                        <button id="onetTabSkills" class="onet-tab active" onclick="switchONETTab('skills')">
                            Skills (35)
                        </button>
                        <button id="onetTabAbilities" class="onet-tab" onclick="switchONETTab('abilities')">
                            Abilities (52)
                        </button>
                        <button id="onetTabWorkStyles" class="onet-tab" onclick="switchONETTab('workstyles')">
                            Work Styles (21)
                        </button>
                        <button id="onetTabKnowledge" class="onet-tab" onclick="switchONETTab('knowledge')">
                            Knowledge (33)
                        </button>
                        <button id="onetTabActivities" class="onet-tab" onclick="switchONETTab('activities')">
                            Work Activities (41)
                        </button>
                    </div>
                    <input type="text" id="onetSearchInput" placeholder="Search O*NET library..." 
                           class="settings-input" oninput="filterONETLibrary()" style="width: 100%; margin-bottom: 15px;">
                </div>
                <div id="onetLibraryContent" style="max-height: 400px; overflow-y: auto;">
                    <!-- Populated by JavaScript -->
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="onetSelectedCount" style="color: #9ca3af;"></span>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="closeONETPicker()" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="addSelectedONETSkills()" id="onetAddButton" 
                                    style="padding: 10px 20px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Add Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Skill Builder Modal -->
    <div class="modal" id="customSkillModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Create Custom Skill</h2>
                </div>
                <button class="modal-close" onclick="closeCustomSkillBuilder()">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Skill Name *</label>
                    <input type="text" id="customSkillName" class="settings-input" placeholder="e.g., Quantum Computing Strategy">
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Proficiency Level *</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Novice" style="margin-right: 5px;">
                            Novice
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Proficient" style="margin-right: 5px;">
                            Proficient
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Advanced" checked style="margin-right: 5px;">
                            Advanced
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Expert" style="margin-right: 5px;">
                            Expert
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Mastery" style="margin-right: 5px;">
                            Mastery
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Used in Roles *</label>
                    <div id="customSkillRoles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="settings-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="customSkillCore">
                        <span class="settings-label" style="margin: 0;">Mark as Core Differentiator</span>
                    </label>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <button onclick="closeCustomSkillBuilder()" 
                            style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="createCustomSkill()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Create Skill
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Skill Modal -->
    <div class="modal" id="editSkillModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Edit Skill</h2>
                </div>
                <button class="modal-close" onclick="closeEditSkillModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Skill Name</label>
                    <input type="text" id="editSkillName" class="settings-input" readonly style="background: rgba(255,255,255,0.05);">
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Proficiency Level *</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Novice" style="margin-right: 5px;">
                            Novice
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Proficient" style="margin-right: 5px;">
                            Proficient
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Advanced" style="margin-right: 5px;">
                            Advanced
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Expert" style="margin-right: 5px;">
                            Expert
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Mastery" style="margin-right: 5px;">
                            Mastery
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Used in Roles *</label>
                    <div id="editSkillRoles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="settings-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="editSkillCore">
                        <span class="settings-label" style="margin: 0;">Mark as Core Differentiator</span>
                    </label>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <button onclick="closeEditSkillModal()" 
                            style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveSkillEdit()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Assessment Modal (for unique skills) -->
    <div class="modal" id="assessSkillModal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Assess Skill Impact</h2>
                </div>
                <button class="modal-close" onclick="closeAssessSkillModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="coaching-tip" style="margin-bottom: 25px;">
                    <div class="coaching-tip-title">
                        💡 WHY ASSESS THIS SKILL?
                    </div>
                    <div class="coaching-tip-content">
                        This skill doesn't have a direct O*NET match. Answer a few questions so we can accurately rate its market impact.
                    </div>
                </div>
                
                <div id="assessSkillName" style="font-size: 1.2em; font-weight: 600; margin-bottom: 25px; color: #fbbf24;"></div>
                
                <div class="settings-group">
                    <label class="settings-label">How many years of experience do you have with this skill? *</label>
                    <input type="number" id="assessYears" class="settings-input" min="0" max="50" value="5" 
                           style="width: 120px;">
                    <div class="settings-help">More experience generally indicates higher impact</div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Impact on business outcomes: *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessImpact" value="minor">
                            <div>
                                <div style="font-weight: 600;">Minor Impact</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Supports work but doesn't directly drive major outcomes</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessImpact" value="significant" checked>
                            <div>
                                <div style="font-weight: 600;">Significant Impact</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Directly contributes to key business results</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessImpact" value="major">
                            <div>
                                <div style="font-weight: 600;">Major Impact</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Critical differentiator, drives strategic outcomes</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">How common is this skill in the market? *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessRarity" value="common">
                            <div>
                                <div style="font-weight: 600;">Common</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Many professionals have this skill</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessRarity" value="uncommon" checked>
                            <div>
                                <div style="font-weight: 600;">Uncommon</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Specialized, not widely held</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessRarity" value="rare">
                            <div>
                                <div style="font-weight: 600;">Rare</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Very few people have this expertise</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">This skill is typically used in roles paying: *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessSalary" value="<$150k">
                            <div>
                                <div style="font-weight: 600;">Under $150k</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Mid-level to senior roles</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessSalary" value="$150-250k" checked>
                            <div>
                                <div style="font-weight: 600;">$150k - $250k</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Director to VP level</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessSalary" value=">$250k">
                            <div>
                                <div style="font-weight: 600;">Over $250k</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">VP to C-Suite level</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div id="assessmentPreview" style="color: #9ca3af; font-size: 0.9em;"></div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="closeAssessSkillModal()" 
                                style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="saveSkillAssessment()" 
                                style="padding: 10px 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Save Assessment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Search Modal (v2.3.0) -->
    <!-- Unified Skill Management Modal (v2.4.0) -->
    <div class="modal" id="skillManagementModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Manage Skills</h2>
                    <p style="color: #9ca3af; margin-top: 5px; font-size: 0.9em;">
                        <span id="skillManagementCount">Loading...</span>
                    </p>
                </div>
                <button class="modal-close" onclick="closeSkillManagement()">×</button>
            </div>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 10px; padding: 0 20px; border-bottom: 2px solid rgba(255,255,255,0.1);">
                <button id="yourSkillsTab" class="skill-mgmt-tab active" onclick="switchSkillManagementTab('yours')">
                    📊 Your Skills (<span id="yourSkillsCount">0</span>)
                </button>
                <button id="addSkillsTab" class="skill-mgmt-tab" onclick="switchSkillManagementTab('add')">
                    ➕ Add Skills (<span id="availableSkillsCount">2,384+</span>)
                </button>
            </div>
            
            <div class="modal-body" style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 200px);">
                
                <!-- YOUR SKILLS TAB -->
                <div id="yourSkillsContent" class="skill-mgmt-content">
                    <div style="position: relative; margin-bottom: 20px;">
                        <input 
                            type="text" 
                            id="yourSkillsSearchInput" 
                            class="settings-input" 
                            placeholder="Search your skills..."
                            style="width: 100%; padding-right: 40px;"
                            oninput="filterYourSkills()">
                        <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 1.2em;">
                            🔍
                        </span>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="yourSkillsCategoryFilter" onchange="filterYourSkills()" style="padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            <option value="all">All Categories</option>
                            <!-- populated dynamically by populateCategoryFilter() -->
                        </select>
                        
                        <select id="yourSkillsLevelFilter" onchange="filterYourSkills()" style="padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            <option value="all">All Levels</option>
                            <option value="Mastery">Mastery</option>
                            <option value="Expert">Expert</option>
                            <option value="Advanced">Advanced</option>
                            <option value="Proficient">Proficient</option>
                            <option value="Novice">Novice</option>
                        </select>
                    </div>
                    
                    <div id="yourSkillsList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <!-- ADD SKILLS TAB -->
                <div id="addSkillsContent" class="skill-mgmt-content" style="display: none;">
                    <div style="position: relative; margin-bottom: 20px;">
                        <input 
                            type="text" 
                            id="addSkillsSearchInput" 
                            class="settings-input" 
                            placeholder="Search 13,960+ skills... (e.g., 'python', 'marketing', 'leadership')"
                            style="width: 100%; padding-right: 40px; font-size: 1.1em;"
                            oninput="handleAddSkillsSearch()"
                            autofocus>
                        <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 1.2em;">
                            🔍
                        </span>
                    </div>
                    
                    <div id="addSkillsResults" style="min-height: 200px;">
                        <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                            <div style="font-size: 3em; margin-bottom: 10px;">🔍</div>
                            <div style="font-size: 1.1em;">Start typing to search skills</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">Try: "python", "marketing", "leadership"</div>
                        </div>
                    </div>
                    
                    <div id="addSkillsCategories" style="margin-top: 25px;">
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px; font-weight: 600;">
                            BROWSE BY CATEGORY:
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button onclick="searchAddSkillsByCategory('Technology')" 
                                    style="padding: 8px 16px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #60a5fa; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                💻 Technology
                            </button>
                            <button onclick="searchAddSkillsByCategory('Business')" 
                                    style="padding: 8px 16px; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); color: #a78bfa; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                💼 Business
                            </button>
                            <button onclick="searchAddSkillsByCategory('Finance')" 
                                    style="padding: 8px 16px; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); color: #10b981; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                💰 Finance
                            </button>
                            <button onclick="searchAddSkillsByCategory('Marketing')" 
                                    style="padding: 8px 16px; background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); color: #fbbf24; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                📢 Marketing
                            </button>
                            <button onclick="searchAddSkillsByCategory('Creative')" 
                                    style="padding: 8px 16px; background: rgba(249, 115, 22, 0.2); border: 1px solid rgba(249, 115, 22, 0.4); color: #fb923c; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                🎨 Creative
                            </button>
                            <button onclick="searchAddSkillsByCategory('Leadership')" 
                                    style="padding: 8px 16px; background: rgba(100, 116, 139, 0.2); border: 1px solid rgba(100, 116, 139, 0.4); color: #94a3b8; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                ⭐ Leadership
                            </button>
                            <button onclick="searchAddSkillsByCategory('Trades')" 
                                    style="padding: 8px 16px; background: rgba(180, 83, 9, 0.2); border: 1px solid rgba(180, 83, 9, 0.4); color: #d97706; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                🔨 Trades
                            </button>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div style="padding: 15px 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: #9ca3af; font-size: 0.85em;">
                        <span id="skillManagementStatus"></span>
                    </div>
                    <button onclick="closeSkillManagement()" 
                            style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // WORK BLUEPRINT v4.0.0 - BUILD 20260219-0335
        // Samples default to Network view + scroll-to-top on all view switches
        // ============================================================
        console.log('%c==============================================', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c   WORK BLUEPRINT v4.0.0                    ', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c   Build: 20260219-0335                     ', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c   Everyone Has Premium Value!              ', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c==============================================', 'color: #60a5fa; font-weight: bold; font-size: 14px;');

        // ===== FIREBASE INITIALIZATION =====
        var firebaseConfig = {
            apiKey: "AIzaSyBO703p11FdLojH6ogB50XrxoFVy_7bHLE",
            authDomain: "work-blueprint.firebaseapp.com",
            projectId: "work-blueprint",
            storageBucket: "work-blueprint.firebasestorage.app",
            messagingSenderId: "338454233039",
            appId: "1:338454233039:web:76016289b81d8298269cba"
        };
        
        var fbApp = null;
        var fbAuth = null;
        var fbDb = null;
        var fbUser = null;       // Current Firebase auth user
        var fbIsAdmin = false;   // Admin role flag
        var fbReady = false;     // Firebase SDK loaded and initialized
        
        try {
            fbApp = firebase.initializeApp(firebaseConfig);
            fbAuth = firebase.auth();
            fbDb = firebase.firestore();
            fbReady = true;
            console.log('✓ Firebase initialized');
        } catch(e) {
            console.warn('⚠ Firebase not available, running in offline mode:', e.message);
        }

        // ===== AUTH STATE MANAGEMENT =====
        var authReadyResolve = null;
        var authReadyPromise = new Promise(function(resolve) { authReadyResolve = resolve; });
        
        if (fbAuth) {
            fbAuth.onAuthStateChanged(function(user) {
                fbUser = user;
                if (user) {
                    console.log('🔐 Signed in:', user.email);
                    checkAdminRole(user.uid).then(function(isAdmin) {
                        fbIsAdmin = isAdmin;
                        updateAuthUI();
                        authReadyResolve(user);
                    });
                } else {
                    console.log('🔓 Not signed in');
                    fbIsAdmin = false;
                    updateAuthUI();
                    authReadyResolve(null);
                }
            });
        } else {
            authReadyResolve(null);
        }

        // ===== AUTH UI =====
        function showAuthModal(mode) {
            if (!fbReady) {
                showToast('Authentication service unavailable. Try refreshing.', 'error');
                return;
            }
            var overlay = document.getElementById('authOverlay');
            var content = document.getElementById('authModalContent');
            if (!overlay || !content) return;
            
            mode = mode || 'signin';
            var isSignUp = mode === 'signup';
            
            content.innerHTML = '<h2>' + (isSignUp ? 'Create Account' : 'Sign In') + '</h2>'
                + '<div class="auth-subtitle">' + (isSignUp ? 'Build and save your Blueprint' : 'Welcome back') + '</div>'
                
                // Google Sign-In
                + '<button class="auth-btn auth-btn-google" onclick="authWithGoogle()" style="margin-bottom:10px;">'
                + '<svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>'
                + 'Continue with Google</button>'
                
                + '<div class="auth-divider">or</div>'
                
                // Error/success messages
                + '<div class="auth-error" id="authError"></div>'
                + '<div class="auth-success" id="authSuccess"></div>'
                
                // Email form
                + (isSignUp ? '<input class="auth-input" id="authName" type="text" placeholder="Full name" />' : '')
                + '<input class="auth-input" id="authEmail" type="email" placeholder="Email address" />'
                + '<input class="auth-input" id="authPassword" type="password" placeholder="Password" '
                + 'onkeydown="if(event.key===\'Enter\'){' + (isSignUp ? 'authEmailSignUp()' : 'authEmailSignIn()') + '}" />'
                
                + '<button class="auth-btn auth-btn-primary" onclick="' + (isSignUp ? 'authEmailSignUp()' : 'authEmailSignIn()') + '" style="margin-bottom:10px;">'
                + (isSignUp ? 'Create Account' : 'Sign In') + '</button>'
                
                // Magic link
                + '<button class="auth-btn auth-btn-magic" onclick="authSendMagicLink()">Send me a sign-in link instead</button>'
                
                // Toggle
                + '<div class="auth-toggle">'
                + (isSignUp
                    ? 'Already have an account? <a onclick="showAuthModal(\'signin\')">Sign in</a>'
                    : 'Don\'t have an account? <a onclick="showAuthModal(\'signup\')">Create one</a>')
                + '</div>';
            
            overlay.classList.add('active');
        }
        window.showAuthModal = showAuthModal;

        function closeAuthModal() {
            var overlay = document.getElementById('authOverlay');
            if (overlay) overlay.classList.remove('active');
        }
        window.closeAuthModal = closeAuthModal;

        function showAuthError(msg) {
            var el = document.getElementById('authError');
            if (el) { el.textContent = msg; el.style.display = 'block'; }
            var s = document.getElementById('authSuccess');
            if (s) s.style.display = 'none';
        }

        function showAuthSuccess(msg) {
            var el = document.getElementById('authSuccess');
            if (el) { el.textContent = msg; el.style.display = 'block'; }
            var e = document.getElementById('authError');
            if (e) e.style.display = 'none';
        }

        // ===== AUTH METHODS =====
        function authWithGoogle() {
            if (!fbAuth) return;
            var provider = new firebase.auth.GoogleAuthProvider();
            fbAuth.signInWithPopup(provider)
                .then(function(result) {
                    closeAuthModal();
                    handlePostSignIn(result.user, result.additionalUserInfo && result.additionalUserInfo.isNewUser);
                })
                .catch(function(err) {
                    if (err.code === 'auth/popup-closed-by-user') return;
                    showAuthError(friendlyAuthError(err.code));
                });
        }
        window.authWithGoogle = authWithGoogle;

        function authEmailSignIn() {
            if (!fbAuth) return;
            var email = (document.getElementById('authEmail') || {}).value || '';
            var password = (document.getElementById('authPassword') || {}).value || '';
            if (!email || !password) { showAuthError('Please enter email and password.'); return; }
            
            fbAuth.signInWithEmailAndPassword(email, password)
                .then(function(result) {
                    closeAuthModal();
                    handlePostSignIn(result.user, false);
                })
                .catch(function(err) {
                    showAuthError(friendlyAuthError(err.code));
                });
        }
        window.authEmailSignIn = authEmailSignIn;

        function authEmailSignUp() {
            if (!fbAuth) return;
            var name = (document.getElementById('authName') || {}).value || '';
            var email = (document.getElementById('authEmail') || {}).value || '';
            var password = (document.getElementById('authPassword') || {}).value || '';
            if (!email || !password) { showAuthError('Please enter email and password.'); return; }
            
            fbAuth.createUserWithEmailAndPassword(email, password)
                .then(function(result) {
                    // Set display name
                    if (name) {
                        result.user.updateProfile({ displayName: name });
                    }
                    closeAuthModal();
                    handlePostSignIn(result.user, true);
                })
                .catch(function(err) {
                    showAuthError(friendlyAuthError(err.code));
                });
        }
        window.authEmailSignUp = authEmailSignUp;

        function authSendMagicLink() {
            if (!fbAuth) return;
            var email = (document.getElementById('authEmail') || {}).value || '';
            if (!email) { showAuthError('Please enter your email address first.'); return; }
            
            var actionCodeSettings = {
                url: window.location.href,
                handleCodeInApp: true
            };
            
            fbAuth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(function() {
                    localStorage.setItem('wbMagicLinkEmail', email);
                    showAuthSuccess('Sign-in link sent to ' + email + '. Check your inbox.');
                })
                .catch(function(err) {
                    showAuthError(friendlyAuthError(err.code));
                });
        }
        window.authSendMagicLink = authSendMagicLink;

        function authSignOut() {
            if (!fbAuth) return;
            fbAuth.signOut().then(function() {
                fbUser = null;
                fbIsAdmin = false;
                showToast('Signed out.', 'info');
                updateAuthUI();
                rebuildProfileDropdown();
                switchView('welcome');
            });
        }
        window.authSignOut = authSignOut;

        // Handle magic link sign-in on page load
        function checkMagicLinkSignIn() {
            try {
                if (!fbAuth || !fbAuth.isSignInWithEmailLink(window.location.href)) return;
                var email = localStorage.getItem('wbMagicLinkEmail');
                if (!email) {
                    email = prompt('Please enter your email to confirm sign-in:');
                }
                if (email) {
                    fbAuth.signInWithEmailLink(email, window.location.href)
                        .then(function(result) {
                            localStorage.removeItem('wbMagicLinkEmail');
                            window.history.replaceState({}, document.title, window.location.pathname);
                            handlePostSignIn(result.user, result.additionalUserInfo && result.additionalUserInfo.isNewUser);
                        })
                        .catch(function(err) {
                            console.error('Magic link sign-in failed:', err);
                            showToast('Sign-in link expired or invalid. Please try again.', 'error');
                        });
                }
            } catch(e) {
                console.warn('Magic link check skipped:', e.message);
            }
        }

        function friendlyAuthError(code) {
            var map = {
                'auth/email-already-in-use': 'An account with this email already exists. Try signing in.',
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/weak-password': 'Password must be at least 6 characters.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/invalid-credential': 'Incorrect email or password.',
                'auth/too-many-requests': 'Too many attempts. Please wait a moment and try again.',
                'auth/network-request-failed': 'Network error. Check your connection.',
                'auth/popup-blocked': 'Pop-up blocked by browser. Allow pop-ups for this site.'
            };
            return map[code] || 'Authentication error. Please try again.';
        }

        // ===== POST SIGN-IN HANDLER =====
        function handlePostSignIn(user, isNewUser) {
            if (!user) return;
            
            // Ensure user document exists in Firestore
            if (fbDb) {
                var userRef = fbDb.collection('users').doc(user.uid);
                userRef.get().then(function(doc) {
                    if (!doc.exists) {
                        // First sign-in: create user document
                        userRef.set({
                            email: user.email,
                            displayName: user.displayName || '',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                            role: 'user'
                        });
                        console.log('✓ Created Firestore user document');
                        // Offer wizard for new users
                        setTimeout(function() { showOnboardingWizard(); }, 600);
                    } else {
                        // Returning user: update last login, load their data
                        userRef.update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
                        loadUserFromFirestore(user.uid);
                    }
                }).catch(function(err) {
                    console.error('Firestore user check failed:', err);
                });
            }
            
            showToast('Welcome, ' + (user.displayName || user.email) + '!', 'success');
        }

        // ===== ADMIN ROLE CHECK =====
        function checkAdminRole(uid) {
            if (!fbDb) return Promise.resolve(false);
            return fbDb.collection('users').doc(uid).get()
                .then(function(doc) {
                    if (doc.exists && doc.data().role === 'admin') {
                        console.log('👑 Admin role confirmed');
                        return true;
                    }
                    return false;
                })
                .catch(function() { return false; });
        }

        // ===== AUTH UI UPDATE =====
        function updateAuthUI() {
            var authBtn = document.getElementById('authNavBtn');
            var profileChip = document.getElementById('profileChip');
            var overflowSignIn = document.getElementById('overflowSignIn');
            var overflowSignOut = document.getElementById('overflowSignOut');
            
            if (fbUser) {
                // Signed in
                if (authBtn) authBtn.style.display = 'none';
                if (overflowSignIn) overflowSignIn.style.display = 'none';
                if (overflowSignOut) overflowSignOut.style.display = '';
                if (profileChip) {
                    profileChip.style.display = '';
                    var nameEl = document.getElementById('profileChipName');
                    var avatarEl = document.getElementById('profileAvatar');
                    var displayName = fbUser.displayName || fbUser.email.split('@')[0];
                    if (nameEl) nameEl.textContent = displayName + (fbIsAdmin ? '' : '');
                    if (avatarEl) avatarEl.textContent = getInitials(displayName);
                }
                // Add admin badge and sign-out to dropdown
                rebuildProfileDropdown();
            } else {
                // Not signed in
                if (authBtn) authBtn.style.display = '';
                if (overflowSignIn) overflowSignIn.style.display = '';
                if (overflowSignOut) overflowSignOut.style.display = 'none';
                // Profile chip still shows for sample browsing
                if (profileChip) profileChip.style.display = '';
            }
        }

        function rebuildProfileDropdown() {
            var container = document.getElementById('profileDropdownOptions');
            if (!container) return;
            
            var html = '';
            
            // Current user section
            if (fbUser) {
                html += '<div style="padding:8px 12px; font-size:0.82em; color:var(--text-muted); border-bottom:1px solid var(--border); margin-bottom:4px;">'
                    + (fbUser.displayName || fbUser.email)
                    + (fbIsAdmin ? ' <span class="admin-badge">ADMIN</span>' : '')
                    + '</div>';
            }
            
            // Sample profiles from manifest
            var manifest = window.profilesManifest;
            if (manifest && manifest.profiles) {
                manifest.profiles.filter(function(p) { return p.enabled; }).forEach(function(p) {
                    var isCurrent = (userData.templateId === p.id);
                    var initials = p.name.split(' ').map(function(w) { return w[0]; }).join('').slice(0, 2).toUpperCase();
                    html += '<div class="profile-option' + (isCurrent ? ' active-profile' : '') + '" '
                        + 'onclick="switchProfile(\'' + p.id + '\'); closeProfileDropdown();">'
                        + '<div class="profile-option-avatar">' + initials + '</div>'
                        + '<div class="profile-option-info">'
                        + '<div class="profile-option-name">' + p.name + ' <span style="font-size:0.7em; color:var(--text-muted); font-weight:400;">SAMPLE</span></div>'
                        + '<div class="profile-option-title">' + (p.title || '') + '</div>'
                        + '</div>'
                        + (isCurrent ? '<span class="profile-option-check">\u2713</span>' : '')
                        + '</div>';
                });
            }
            
            // Divider + auth actions
            if (fbUser) {
                html += '<div style="height:1px; background:var(--border); margin:6px 0;"></div>';
                if (fbIsAdmin) {
                    html += '<div class="profile-option" onclick="showAdminPanel(); closeProfileDropdown();">'
                        + '<div class="profile-option-avatar" style="background:rgba(251,191,36,0.2); color:#fbbf24;">\uD83D\uDC51</div>'
                        + '<div class="profile-option-info"><div class="profile-option-name">Admin Dashboard</div></div></div>';
                }
                html += '<div class="profile-option" onclick="authSignOut(); closeProfileDropdown();">'
                    + '<div class="profile-option-avatar" style="background:rgba(239,68,68,0.15); color:#ef4444;">\u23FB</div>'
                    + '<div class="profile-option-info"><div class="profile-option-name" style="color:#ef4444;">Sign Out</div></div></div>';
            } else {
                html += '<div style="height:1px; background:var(--border); margin:6px 0;"></div>';
                html += '<div class="profile-option" onclick="showAuthModal(\'signin\'); closeProfileDropdown();">'
                    + '<div class="profile-option-avatar" style="background:rgba(96,165,250,0.2); color:#60a5fa;">\uD83D\uDD10</div>'
                    + '<div class="profile-option-info"><div class="profile-option-name" style="color:var(--accent);">Sign In / Create Account</div></div></div>';
            }
            
            container.innerHTML = html;
        }

        function getInitials(name) {
            if (!name) return '?';
            var parts = name.trim().split(/\s+/);
            if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            return name.substring(0, 2).toUpperCase();
        }

        // ===== FIRESTORE PERSISTENCE =====
        function saveToFirestore() {
            if (!fbDb || !fbUser) return Promise.resolve(false);
            
            var uid = fbUser.uid;
            var data = {
                profile: userData.profile || {},
                skills: (skillsData && skillsData.skills) ? skillsData.skills.map(function(s) {
                    return { name: s.name, level: s.level, category: s.category, key: s.key, roles: s.roles || [], evidence: s.evidence || [] };
                }) : [],
                roles: (skillsData && skillsData.roles) || [],
                values: blueprintData.values || [],
                purpose: blueprintData.purpose || '',
                outcomes: blueprintData.outcomes || [],
                preferences: userData.preferences || {},
                applications: userData.applications || [],
                savedJobs: (userData.savedJobs || []).map(function(j) {
                    return { id: j.id, title: j.title, company: j.company, sourceUrl: j.sourceUrl, sourceNote: j.sourceNote,
                        rawText: j.rawText, parsedSkills: j.parsedSkills || [], parsedRoles: j.parsedRoles || [],
                        matchData: j.matchData || {}, addedAt: j.addedAt };
                }),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            return fbDb.collection('users').doc(uid).set(data, { merge: true })
                .then(function() {
                    console.log('☁ Saved to Firestore');
                    return true;
                })
                .catch(function(err) {
                    console.error('Firestore save error:', err);
                    return false;
                });
        }
        window.saveToFirestore = saveToFirestore;

        function loadUserFromFirestore(uid) {
            if (!fbDb) return Promise.resolve(false);
            
            return fbDb.collection('users').doc(uid).get()
                .then(function(doc) {
                    if (!doc.exists) return false;
                    var data = doc.data();
                    
                    // Only load if user has actual skill data
                    if (!data.skills || data.skills.length === 0) return false;
                    
                    console.log('☁ Loading profile from Firestore...');
                    
                    // Populate userData
                    userData.initialized = true;
                    userData.profile = data.profile || {};
                    userData.skills = data.skills || [];
                    userData.values = data.values || [];
                    userData.purpose = data.purpose || '';
                    userData.roles = data.roles || [];
                    userData.preferences = data.preferences || userData.preferences;
                    userData.applications = data.applications || [];
                    userData.savedJobs = data.savedJobs || [];
                    userData.templateId = 'firestore-' + uid;
                    
                    // Populate skillsData
                    if (typeof skillsData !== 'undefined') {
                        skillsData.skills = data.skills || [];
                        skillsData.roles = data.roles || [];
                    }
                    
                    // Re-render
                    if (typeof initializeMainApp === 'function') {
                        initializeMainApp();
                    }
                    if (userData.profile.name) {
                        updateProfileChip(userData.profile.name);
                    }
                    
                    console.log('✓ Loaded from Firestore:', data.skills.length, 'skills');
                    return true;
                })
                .catch(function(err) {
                    console.error('Firestore load error:', err);
                    return false;
                });
        }

        // ===== GDPR DATA FUNCTIONS =====
        function exportMyData() {
            if (!fbDb || !fbUser) {
                showToast('You must be signed in to export your data.', 'warning');
                return;
            }
            
            fbDb.collection('users').doc(fbUser.uid).get()
                .then(function(doc) {
                    if (!doc.exists) {
                        showToast('No data found for your account.', 'info');
                        return;
                    }
                    var data = doc.data();
                    data.exportedAt = new Date().toISOString();
                    data.exportedFor = fbUser.email;
                    
                    var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'blueprint-data-export-' + new Date().toISOString().slice(0, 10) + '.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    showToast('Your data has been exported.', 'success');
                });
        }
        window.exportMyData = exportMyData;

        function requestDataDeletion() {
            if (!fbDb || !fbUser) {
                showToast('You must be signed in to request deletion.', 'warning');
                return;
            }
            
            var confirmed = confirm('This will permanently delete all your Blueprint data and sign you out. This action cannot be undone.\n\nAre you sure?');
            if (!confirmed) return;
            
            var doubleConfirm = confirm('Final confirmation: All your skills, values, outcomes, and profile data will be permanently deleted. Proceed?');
            if (!doubleConfirm) return;
            
            var uid = fbUser.uid;
            fbDb.collection('users').doc(uid).delete()
                .then(function() {
                    return fbAuth.currentUser.delete();
                })
                .then(function() {
                    // Clear local storage
                    localStorage.removeItem('wbValues');
                    localStorage.removeItem('wbPurpose');
                    localStorage.removeItem('currentProfile');
                    
                    showToast('Your data has been permanently deleted.', 'info', 6000);
                    fbUser = null;
                    fbIsAdmin = false;
                    updateAuthUI();
                    
                    // Reload to clean state
                    setTimeout(function() { window.location.reload(); }, 2000);
                })
                .catch(function(err) {
                    if (err.code === 'auth/requires-recent-login') {
                        showToast('For security, please sign out and sign back in, then try again.', 'warning', 6000);
                    } else {
                        console.error('Deletion error:', err);
                        showToast('Error deleting data. Please try again or contact support.', 'error');
                    }
                });
        }
        window.requestDataDeletion = requestDataDeletion;

        function viewMyData() {
            if (!fbDb || !fbUser) {
                showToast('You must be signed in to view your stored data.', 'warning');
                return;
            }
            
            fbDb.collection('users').doc(fbUser.uid).get()
                .then(function(doc) {
                    if (!doc.exists) {
                        showToast('No data found for your account.', 'info');
                        return;
                    }
                    var data = doc.data();
                    
                    var modal = document.getElementById('exportModal');
                    var modalContent = modal.querySelector('.modal-content');
                    
                    var summary = 'Account: ' + (data.email || 'N/A')
                        + '\nCreated: ' + (data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'N/A')
                        + '\nLast Login: ' + (data.lastLogin ? new Date(data.lastLogin.seconds * 1000).toLocaleDateString() : 'N/A')
                        + '\nSkills stored: ' + (data.skills ? data.skills.length : 0)
                        + '\nValues stored: ' + (data.values ? data.values.length : 0)
                        + '\nOutcomes stored: ' + (data.outcomes ? data.outcomes.length : 0)
                        + '\nApplications stored: ' + (data.applications ? data.applications.length : 0);
                    
                    modalContent.innerHTML = '<div class="modal-header">'
                        + '<div class="modal-header-left"><h2 class="modal-title">Your Stored Data</h2></div>'
                        + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                        + '</div>'
                        + '<div class="modal-body" style="padding:24px;">'
                        + '<pre style="background:' + tv('rgba(0,0,0,0.3)','#f1f5f9') + '; padding:20px; border-radius:8px; '
                        + 'color:' + tv('#e0e0e0','#334155') + '; font-size:0.85em; line-height:1.6; white-space:pre-wrap; overflow:auto; max-height:400px;">'
                        + summary + '</pre>'
                        + '<div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">'
                        + '<button onclick="exportMyData()" style="background:' + tv('#1e40af','#2563eb') + '; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600;">Download Full Export (JSON)</button>'
                        + '<button onclick="closeExportModal(); requestDataDeletion();" style="background:transparent; color:#ef4444; border:1px solid #ef4444; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600;">Delete All My Data</button>'
                        + '</div></div>';
                    
                    history.pushState({ modal: true }, ''); modal.classList.add('active');
                });
        }
        window.viewMyData = viewMyData;

        // ===== ADMIN PANEL =====
        function showAdminPanel() {
            if (!fbIsAdmin || !fbDb) {
                showToast('Admin access required.', 'error');
                return;
            }
            
            var modal = document.getElementById('exportModal');
            var modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left"><h2 class="modal-title">\uD83D\uDC51 Admin Dashboard</h2></div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<div id="adminContent" style="color:' + tv('#d1d5db','#334155') + ';">Loading users...</div>'
                + '</div>';
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            
            // Fetch all users
            fbDb.collection('users').orderBy('lastLogin', 'desc').get()
                .then(function(snapshot) {
                    var html = '<div style="margin-bottom:16px; font-size:0.9em; color:' + tv('#9ca3af','#64748b') + ';">'
                        + snapshot.size + ' registered users</div>';
                    
                    html += '<div style="display:grid; gap:10px;">';
                    snapshot.forEach(function(doc) {
                        var d = doc.data();
                        var skillCount = d.skills ? d.skills.length : 0;
                        var lastLogin = d.lastLogin ? new Date(d.lastLogin.seconds * 1000).toLocaleDateString() : 'Never';
                        var isAdmin = d.role === 'admin';
                        
                        html += '<div style="padding:14px; background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; '
                            + 'border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + '; border-radius:8px;">'
                            + '<div style="display:flex; justify-content:space-between; align-items:center;">'
                            + '<div>'
                            + '<strong style="color:' + tv('#e0e0e0','#1e293b') + ';">' + (d.displayName || d.email || doc.id) + '</strong>'
                            + (isAdmin ? ' <span class="admin-badge">ADMIN</span>' : '')
                            + '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + ';">'
                            + (d.email || '') + '</div>'
                            + '</div>'
                            + '<div style="text-align:right; font-size:0.82em; color:' + tv('#9ca3af','#64748b') + ';">'
                            + skillCount + ' skills<br>Last: ' + lastLogin
                            + '</div>'
                            + '</div></div>';
                    });
                    html += '</div>';
                    
                    document.getElementById('adminContent').innerHTML = html;
                })
                .catch(function(err) {
                    document.getElementById('adminContent').innerHTML = '<div style="color:#ef4444;">Error loading users: ' + err.message + '</div>';
                });
        }
        window.showAdminPanel = showAdminPanel;

        // ===== ENHANCED SAVE (Firestore + localStorage) =====
        function saveAll() {
            saveValues(); // localStorage for values
            if (fbUser && fbDb) {
                saveToFirestore();
            }
        }
        window.saveAll = saveAll;

        // ===== READ-ONLY MODE =====
        var isReadOnlyProfile = false;  // True when viewing a sample profile as non-admin

        function checkReadOnly() {
            var templateId = userData.templateId || '';
            var isSample = templateId.indexOf('demo') !== -1 || templateId.indexOf('sample') !== -1;
            isReadOnlyProfile = isSample && !fbIsAdmin;
            
            // Show/hide readonly banner
            var banner = document.getElementById('readonlyBanner');
            if (isReadOnlyProfile) {
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = 'readonlyBanner';
                    banner.className = 'readonly-banner';
                    banner.innerHTML = '\uD83D\uDD12 You are viewing a sample profile (read-only). '
                        + '<a href="#" onclick="event.preventDefault(); showAuthModal(\'signup\');" style="color:inherit; text-decoration:underline;">Create your own</a> '
                        + 'or <a href="#" onclick="event.preventDefault(); showOnboardingWizard();" style="color:inherit; text-decoration:underline;">build your blueprint</a>.';
                    var header = document.querySelector('.header');
                    if (header) header.parentNode.insertBefore(banner, header.nextSibling);
                }
                banner.style.display = '';
            } else {
                if (banner) banner.style.display = 'none';
            }
        }
        window.checkReadOnly = checkReadOnly;

        // ===== WELCOME / LANDING PAGE =====
        function renderWelcomePage() {
            var el = document.getElementById('welcomeView');
            if (!el) return;
            var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            
            el.innerHTML = ''
                // Hero section: text left, nothing behind
                + '<div style="max-width:920px; margin:0 auto; padding:48px 24px 0;">'
                
                // Headline + subtitle + CTAs
                + '<div style="text-align:center; margin-bottom:32px;">'
                + '<h2 style="font-size:2.6em; font-weight:700; color:var(--accent); margin-bottom:14px; line-height:1.12;">'
                + 'Know Your Worth.<br>Own Your Narrative.</h2>'
                + '<p style="font-size:1.08em; color:var(--text-secondary); line-height:1.7; max-width:560px; margin:0 auto 28px;">'
                + 'Map your skills, quantify your market value, and build the professional story '
                + 'you need for your next opportunity.</p>'
                + '<div style="display:flex; gap:14px; justify-content:center; flex-wrap:wrap; margin-bottom:40px;">'
                + '<button onclick="viewSampleProfile()" style="'
                + 'padding:14px 28px; border-radius:10px; font-size:0.95em; font-weight:600; cursor:pointer; '
                + 'background:transparent; color:var(--accent); border:2px solid var(--accent); transition:all 0.2s;'
                + '">\uD83D\uDCCA View Sample Profiles</button>'
                + '<button onclick="showAuthModal(\x27signup\x27)" style="'
                + 'padding:14px 28px; border-radius:10px; font-size:0.95em; font-weight:600; cursor:pointer; '
                + 'background:var(--accent); color:#fff; border:2px solid var(--accent); transition:all 0.2s;'
                + '">\u25C8 Build Your Blueprint</button>'
                + '</div>'
                + '</div>'
                
                // Network showcase - frameless, breathes into the page
                + '<div style="position:relative; width:100%; height:360px; margin-bottom:4px;">'
                + '<canvas id="heroNetworkCanvas" style="width:100%; height:100%; display:block;"></canvas>'
                + '</div>'
                + '<div style="text-align:center; font-size:0.78em; color:var(--text-muted); margin-bottom:48px;">'
                + 'Interactive skills network \u2014 each node is a skill, grouped by professional role</div>'
                
                + '</div>'

                // How it works
                + '<div style="max-width:820px; margin:0 auto; padding:0 24px 48px;">'
                + '<div style="text-align:center; margin-bottom:32px;">'
                + '<div style="font-size:0.8em; text-transform:uppercase; letter-spacing:2px; color:var(--text-muted);">How It Works</div>'
                + '</div>'
                
                + '<div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:24px; margin-bottom:48px;" class="welcome-steps-grid">'
                
                + '<div style="text-align:center; padding:20px 16px;">'
                + '<div style="width:44px; height:44px; border-radius:50%; background:rgba(96,165,250,0.12); '
                + 'display:flex; align-items:center; justify-content:center; margin:0 auto 12px; font-size:1.2em; color:var(--accent); font-weight:700;">1</div>'
                + '<div style="font-weight:600; color:var(--text-primary); margin-bottom:5px; font-size:0.95em;">Upload Your Resume</div>'
                + '<div style="font-size:0.83em; color:var(--text-muted); line-height:1.5;">'
                + 'AI parses your experience and maps it to 13,960+ O*NET skills with proficiency levels.</div>'
                + '</div>'
                
                + '<div style="text-align:center; padding:20px 16px;">'
                + '<div style="width:44px; height:44px; border-radius:50%; background:rgba(16,185,129,0.12); '
                + 'display:flex; align-items:center; justify-content:center; margin:0 auto 12px; font-size:1.2em; color:#10b981; font-weight:700;">2</div>'
                + '<div style="font-weight:600; color:var(--text-primary); margin-bottom:5px; font-size:0.95em;">See Your Value</div>'
                + '<div style="font-size:0.83em; color:var(--text-muted); line-height:1.5;">'
                + 'Market valuation based on skill rarity, impact tier, and location with negotiation guidance.</div>'
                + '</div>'
                
                + '<div style="text-align:center; padding:20px 16px;">'
                + '<div style="width:44px; height:44px; border-radius:50%; background:rgba(251,191,36,0.12); '
                + 'display:flex; align-items:center; justify-content:center; margin:0 auto 12px; font-size:1.2em; color:#fbbf24; font-weight:700;">3</div>'
                + '<div style="font-weight:600; color:var(--text-primary); margin-bottom:5px; font-size:0.95em;">Own Your Story</div>'
                + '<div style="font-size:0.83em; color:var(--text-muted); line-height:1.5;">'
                + 'Export a professional blueprint with outcomes, values, and strategic positioning.</div>'
                + '</div>'
                
                + '</div>'

                // Sign in
                + '<div style="text-align:center; color:var(--text-muted); font-size:0.9em; margin-bottom:24px;">'
                + 'Already have an account? <a href="#" onclick="event.preventDefault(); showAuthModal(\x27signin\x27);" style="color:var(--accent); text-decoration:underline;">Sign in</a>'
                + '</div>'

                // Disclaimer
                + '<div style="text-align:center; padding:16px; background:' + tv('rgba(251,191,36,0.06)','rgba(251,191,36,0.04)') + '; '
                + 'border:1px solid ' + tv('rgba(251,191,36,0.2)','rgba(251,191,36,0.12)') + '; border-radius:8px; '
                + 'font-size:0.78em; color:' + tv('#9ca3af','#64748b') + '; line-height:1.5;">'
                + 'This is a demonstration project. Data and valuations are illustrative, not professional advice. '
                + '<a href="#" onclick="event.preventDefault(); switchView(\x27consent\x27);" style="color:inherit; text-decoration:underline;">Full disclaimer</a>.'
                + '</div>'
                + '</div>';
            
            setTimeout(function() { initHeroNetwork(); }, 50);
        }
        window.renderWelcomePage = renderWelcomePage;

        // ===== ANIMATED HERO NETWORK =====
        function initHeroNetwork() {
            var canvas = document.getElementById('heroNetworkCanvas');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            var dpr = window.devicePixelRatio || 1;
            var rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            var W = rect.width;
            var H = rect.height;
            var centerX = W / 2, centerY = H / 2;
            
            var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            var colors = ['#60a5fa', '#f472b6', '#34d399', '#fbbf24', '#a78bfa', '#fb923c', '#22d3ee', '#f87171'];
            var domainNames = ['Strategy', 'Leadership', 'Analytics', 'Innovation', 'Communication', 'Technology', 'Operations', 'Finance'];
            
            var nodes = [];
            var numNodes = 40;
            
            // Center - fixed sun
            nodes.push({ angle: 0, dist: 0, speed: 0, r: 20, color: '#60a5fa', alpha: 0.95, label: 'YOU', isCenter: true, isHub: false, domain: -1, x: centerX, y: centerY });
            
            // Domain hubs - planets in distinct orbital bands
            // Spread across 3 orbital bands so they have room
            // Inner band (~58-68), middle band (~78-90), outer band (~100-115)
            var hubConfigs = [
                { dist: 60,  speed: -0.085, band: 0 }, // Strategy
                { dist: 105, speed: -0.032, band: 2 }, // Leadership
                { dist: 80,  speed: -0.052, band: 1 }, // Analytics
                { dist: 68,  speed: -0.072, band: 0 }, // Innovation
                { dist: 92,  speed: -0.042, band: 1 }, // Communication
                { dist: 112, speed: -0.028, band: 2 }, // Technology
                { dist: 75,  speed: -0.058, band: 1 }, // Operations
                { dist: 100, speed: -0.035, band: 2 }, // Finance
            ];
            
            for (var d = 0; d < 8; d++) {
                var cfg = hubConfigs[d];
                // Spread starting angles more evenly with mild jitter
                var baseAngle = (d / 8) * Math.PI * 2 - Math.PI / 2;
                var jitter = (Math.random() - 0.5) * 0.3;
                nodes.push({
                    angle: baseAngle + jitter, dist: cfg.dist,
                    speed: cfg.speed, baseSpeed: cfg.speed,
                    r: 11 + Math.random() * 4, color: colors[d], alpha: 0.7,
                    label: domainNames[d], isCenter: false, isHub: true, domain: d,
                    x: 0, y: 0
                });
            }
            
            // Skill nodes - satellites
            for (var i = 9; i < numNodes; i++) {
                var dom = Math.floor(Math.random() * 8);
                var parentIdx = dom + 1;
                var parent = nodes[parentIdx];
                var spread = 18 + Math.random() * 45;
                var a = Math.random() * Math.PI * 2;
                var localX = Math.cos(parent.angle) * parent.dist + Math.cos(a) * spread;
                var localY = Math.sin(parent.angle) * parent.dist + Math.sin(a) * spread;
                var nodeDist = Math.sqrt(localX * localX + localY * localY);
                var nodeAngle = Math.atan2(localY, localX);
                var speedVar = 1 + (Math.random() - 0.5) * 0.25;
                nodes.push({
                    angle: nodeAngle, dist: nodeDist,
                    speed: parent.speed * speedVar, baseSpeed: parent.speed * speedVar,
                    r: 2.5 + Math.random() * 3.5, color: colors[dom],
                    alpha: 0.35 + Math.random() * 0.3, label: '',
                    isCenter: false, isHub: false, domain: dom, x: 0, y: 0
                });
            }
            
            // Links
            var links = [];
            for (var d = 1; d <= 8; d++) links.push({ source: 0, target: d, strength: 0.6 });
            for (var i = 9; i < numNodes; i++) {
                links.push({ source: nodes[i].domain + 1, target: i, strength: 0.3 });
                if (Math.random() < 0.12) {
                    var od = Math.floor(Math.random() * 8) + 1;
                    if (od !== nodes[i].domain + 1) links.push({ source: i, target: od, strength: 0.08 });
                }
            }
            
            // Minimum distance between hub centers (sum of radii + padding)
            var HUB_MIN_DIST = 38;
            var HUB_REPEL_RANGE = 65;
            
            // === CLICK-EMIT PARTICLES ===
            var particles = [];
            var clickedNode = -1;
            var clickGlow = 0;
            var clickTimer = 1.2;
            var emitDone = false;
            var clickable = [];
            for (var i = 1; i < numNodes; i++) clickable.push(i);
            
            function startClick() {
                clickedNode = clickable[Math.floor(Math.random() * clickable.length)];
                clickGlow = 0; emitDone = false; particles = [];
            }
            
            function emitParticles() {
                var n = nodes[clickedNode];
                var count = 3 + Math.floor(Math.random() * 2);
                for (var i = 0; i < count; i++) {
                    var angle = (i / count) * Math.PI * 2 + (Math.random() * 0.5 - 0.25);
                    var speed = 28 + Math.random() * 18;
                    particles.push({
                        ox: 0, oy: 0,
                        tx: Math.cos(angle) * speed, ty: Math.sin(angle) * speed,
                        r: 2 + Math.random() * 1.5, color: n.color,
                        phase: 0, progress: 0
                    });
                }
                emitDone = true;
            }
            
            var animId = null;
            var lastTime = performance.now();
            
            function draw(now) {
                var dt = Math.min((now - lastTime) / 1000, 0.05);
                lastTime = now;
                
                // Update hub angles
                for (var i = 1; i <= 8; i++) {
                    nodes[i].speed = nodes[i].baseSpeed; // reset to base each frame
                }
                
                // Hub-hub gravitational repulsion (angular nudge)
                for (var i = 1; i <= 8; i++) {
                    for (var j = i + 1; j <= 8; j++) {
                        var ni = nodes[i], nj = nodes[j];
                        // Compute current positions
                        var xi = centerX + Math.cos(ni.angle) * ni.dist;
                        var yi = centerY + Math.sin(ni.angle) * ni.dist;
                        var xj = centerX + Math.cos(nj.angle) * nj.dist;
                        var yj = centerY + Math.sin(nj.angle) * nj.dist;
                        var dx = xj - xi, dy = yj - yi;
                        var dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < HUB_REPEL_RANGE) {
                            // Repulsion strength: stronger as they get closer
                            var strength = (1 - dist / HUB_REPEL_RANGE);
                            strength = strength * strength * 0.15; // quadratic falloff
                            
                            // Determine which direction to nudge angularly
                            // Cross product of position vectors tells us relative angular order
                            var cross = Math.cos(ni.angle) * Math.sin(nj.angle) - Math.sin(ni.angle) * Math.cos(nj.angle);
                            
                            if (cross > 0) {
                                // j is ahead of i angularly - push i back, j forward
                                ni.speed -= strength;
                                nj.speed += strength;
                            } else {
                                ni.speed += strength;
                                nj.speed -= strength;
                            }
                            
                            // Also nudge orbital distance apart slightly
                            if (dist < HUB_MIN_DIST) {
                                var pushStr = (1 - dist / HUB_MIN_DIST) * 8;
                                if (ni.dist <= nj.dist) {
                                    ni.dist = Math.max(50, ni.dist - pushStr * dt);
                                    nj.dist = Math.min(120, nj.dist + pushStr * dt);
                                } else {
                                    nj.dist = Math.max(50, nj.dist - pushStr * dt);
                                    ni.dist = Math.min(120, ni.dist + pushStr * dt);
                                }
                            }
                        }
                    }
                }
                
                // Apply orbital motion
                for (var i = 1; i < nodes.length; i++) {
                    var n = nodes[i];
                    n.angle += n.speed * dt;
                    n.x = centerX + Math.cos(n.angle) * n.dist;
                    n.y = centerY + Math.sin(n.angle) * n.dist;
                }
                
                // Click state machine
                if (clickedNode === -1) {
                    clickTimer -= dt;
                    if (clickTimer <= 0) { startClick(); clickTimer = 1.2 + Math.random() * 0.8; }
                } else {
                    clickGlow = Math.min(clickGlow + dt * 4.5, 1);
                    if (!emitDone && clickGlow >= 0.45) emitParticles();
                    var allDone = emitDone;
                    for (var i = 0; i < particles.length; i++) {
                        var p = particles[i];
                        p.progress += dt * 1.3;
                        if (p.progress < 0.45) {
                            var t = p.progress / 0.45;
                            var ease = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
                            p.ox = p.tx * ease; p.oy = p.ty * ease; p.phase = 0; allDone = false;
                        } else if (p.progress < 0.55) {
                            p.ox = p.tx; p.oy = p.ty; p.phase = 1; allDone = false;
                        } else if (p.progress < 1.0) {
                            var t = (p.progress - 0.55) / 0.45;
                            var ease = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
                            p.ox = p.tx * (1 - ease); p.oy = p.ty * (1 - ease); p.phase = 2; allDone = false;
                        } else { p.ox = 0; p.oy = 0; p.phase = 3; }
                    }
                    if (allDone && emitDone) {
                        clickGlow = Math.max(clickGlow - dt * 3.5, 0);
                        if (clickGlow <= 0) { clickedNode = -1; particles = []; }
                    }
                }
                
                ctx.clearRect(0, 0, W, H);
                
                // Draw links
                for (var i = 0; i < links.length; i++) {
                    var l = links[i]; var s = nodes[l.source]; var e = nodes[l.target];
                    var dx = e.x - s.x; var dy = e.y - s.y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 180) continue;
                    var alpha = l.strength * (1 - dist / 180) * 0.6;
                    ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(e.x, e.y);
                    ctx.strokeStyle = isDark ? 'rgba(96,165,250,1)' : 'rgba(37,99,235,1)';
                    ctx.globalAlpha = alpha * 0.35; ctx.lineWidth = 1;
                    ctx.stroke(); ctx.globalAlpha = 1;
                }
                
                // Draw nodes
                for (var i = nodes.length - 1; i >= 0; i--) {
                    var n = nodes[i];
                    var r = n.r; var a = n.alpha;
                    var isClicked = (i === clickedNode && clickGlow > 0);
                    if (isClicked) { r = n.r * (1 + 0.25 * clickGlow); a = Math.min(n.alpha + 0.3 * clickGlow, 1); }
                    if (r > 5 || isClicked) {
                        ctx.beginPath(); ctx.arc(n.x, n.y, isClicked ? r * 3.5 : r * 2.5, 0, Math.PI * 2);
                        ctx.fillStyle = n.color; ctx.globalAlpha = isClicked ? a * 0.2 : a * 0.07;
                        ctx.fill(); ctx.globalAlpha = 1;
                    }
                    ctx.beginPath(); ctx.arc(n.x, n.y, r, 0, Math.PI * 2);
                    ctx.fillStyle = n.color; ctx.globalAlpha = a;
                    ctx.fill(); ctx.globalAlpha = 1;
                    if (n.label && (r > 6 || n.isCenter)) {
                        ctx.font = (n.isCenter ? 'bold 10px' : '8.5px') + ' "Outfit", -apple-system, system-ui, sans-serif';
                        ctx.fillStyle = isDark ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.6)';
                        ctx.textAlign = 'center';
                        ctx.fillText(n.label, n.x, n.y + r + 13);
                    }
                }
                
                // Draw particles
                if (clickedNode >= 0) {
                    var pn = nodes[clickedNode];
                    for (var i = 0; i < particles.length; i++) {
                        var p = particles[i];
                        if (p.phase >= 3) continue;
                        var fadeAlpha = p.phase === 2 ? Math.max(0, 1 - (p.progress - 0.55) / 0.45) : 1;
                        ctx.beginPath(); ctx.arc(pn.x + p.ox, pn.y + p.oy, p.r, 0, Math.PI * 2);
                        ctx.fillStyle = p.color; ctx.globalAlpha = 0.85 * fadeAlpha;
                        ctx.fill(); ctx.globalAlpha = 1;
                    }
                }
                
                animId = requestAnimationFrame(draw);
            }
            
            animId = requestAnimationFrame(draw);
            var observer = new IntersectionObserver(function(entries) {
                if (entries[0].isIntersecting) { if (!animId) { lastTime = performance.now(); animId = requestAnimationFrame(draw); } }
                else { if (animId) { cancelAnimationFrame(animId); animId = null; } }
            });
            observer.observe(canvas);
            window._heroNetworkCleanup = function() { if (animId) cancelAnimationFrame(animId); observer.disconnect(); };
        }

        function viewSampleProfile() {
            // Show sample profile picker
            var manifest = window.profilesManifest;
            var profiles = (manifest && manifest.profiles) ? manifest.profiles.filter(function(p) { return p.enabled; }) : [];
            
            if (profiles.length === 0) {
                // Fallback: just load cliff
                switchProfile('cliff-jones-demo');
                return;
            }
            
            if (profiles.length === 1) {
                // Only one sample, load it directly
                switchProfile(profiles[0].id);
                return;
            }
            
            // Multiple samples: show picker on welcome page
            var el = document.getElementById('welcomeView');
            if (!el) { switchProfile(profiles[0].id); return; }
            
            // Build picker content
            var html = '<div style="max-width:920px; margin:0 auto; padding:48px 24px 80px;">'
                + '<div style="text-align:center; margin-bottom:32px;">'
                + '<h2 style="font-size:2em; font-weight:700; color:var(--accent); margin-bottom:10px;">Sample Profiles</h2>'
                + '<p style="color:var(--text-secondary); font-size:1em; line-height:1.6;">'
                + 'Explore complete Blueprints to see how skills, outcomes, and market valuation come together.'
                + '</p></div>'
                + '<div class="welcome-cards">';
            
            profiles.forEach(function(p) {
                var initials = p.name.split(' ').map(function(w) { return w[0]; }).join('').slice(0, 2).toUpperCase();
                html += '<div class="welcome-card" onclick="switchProfile(\'' + p.id + '\')">'
                    + '<div style="display:flex; align-items:center; gap:14px; margin-bottom:12px;">'
                    + '<div style="width:48px; height:48px; border-radius:50%; background:var(--accent); color:#fff; '
                    + 'display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1.1em;">'
                    + initials + '</div>'
                    + '<div style="text-align:left;">'
                    + '<h3 style="margin:0;">' + p.name + '</h3>'
                    + '<div style="color:var(--text-muted); font-size:0.85em;">' + (p.title || '') + '</div>'
                    + '</div></div>'
                    + '<p>' + (p.description || 'View this complete Blueprint with skills, outcomes, and market valuation.') + '</p>'
                    + '</div>';
            });
            
            html += '</div>'
                + '<div style="text-align:center; margin-top:24px;">'
                + '<a href="#" onclick="event.preventDefault(); window._welcomePickerActive=false; switchView(\'welcome\');" '
                + 'style="color:var(--text-muted); font-size:0.9em; text-decoration:underline;">\u2190 Back to home</a>'
                + '</div></div>';
            
            el.innerHTML = html;
            window._welcomePickerActive = true;
            switchView('welcome');
        }
        window.viewSampleProfile = viewSampleProfile;

        function showWelcomeView() {
            switchView('welcome');
        }
        window.showWelcomeView = showWelcomeView;

        // ===== TOAST NOTIFICATION SYSTEM =====
        let toastCounter = 0;
        function showToast(message, type, duration) {
            type = type || 'info';
            duration = duration || 4000;
            const icons = { success: '\u2705', error: '\u274C', info: '\u2139\uFE0F', warning: '\u26A0\uFE0F' };
            const id = 'toast-' + (++toastCounter);
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const el = document.createElement('div');
            el.id = id;
            el.className = 'toast toast-' + type;
            el.innerHTML = '<span class="toast-icon">' + (icons[type] || icons.info) + '</span>'
                + '<div class="toast-body"><div class="toast-msg">' + message + '</div></div>'
                + '<button class="toast-close" onclick="dismissToast(\u0027' + id + '\u0027'
                + ')" aria-label="Close">\u00D7</button>';
            container.appendChild(el);
            requestAnimationFrame(function() {
                requestAnimationFrame(function() { el.classList.add('show'); });
            });
            var timer = setTimeout(function() { dismissToast(id); }, duration);
            el._timer = timer;
        }
        window.showToast = showToast;

        function dismissToast(id) {
            var el = document.getElementById(id);
            if (!el) return;
            clearTimeout(el._timer);
            el.classList.remove('show');
            el.classList.add('hide');
            setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 400);
        }
        window.dismissToast = dismissToast;
        
        // ===== USER DATA CONFIGURATION =====
        // This will eventually come from onboarding wizard
        
        // userData now defined in v2.0 architecture below (line ~2224)
        
        // ===== MARKET VALUATION CALCULATOR =====
        
        function calculateSkillValue(skill) {
            // Now returns IMPACT rating, not dollar value
            return getSkillImpact(skill);
        }
        
        function calculateTotalMarketValue() {
            if (!skillsData || !skillsData.skills) {
                return { 
                    total: 0, 
                    yourWorth: 0,
                    marketRate: 0,
                    conservativeOffer: 0,
                    standardOffer: 0,
                    competitiveOffer: 0,
                    breakdown: [], 
                    roleLevel: 'Entry',
                    top10Skills: [],
                    totalPoints: 0,
                    compaRatio: 100,
                    criticalSkills: [],
                    highSkills: [],
                    criticalBonus: 0,
                    highBonus: 0,
                    rarityBonus: 0,
                    premiumAmount: 0
                };
            }
            
            // REDESIGNED MODEL: Realistic premiums based on skill mix percentage
            
            // Step 1: Calculate base value from role tier (based on proficiency distribution)
            const masteryCount = skillsData.skills.filter(s => s.level === 'Mastery').length;
            const expertCount = skillsData.skills.filter(s => s.level === 'Expert').length;
            const advancedCount = skillsData.skills.filter(s => s.level === 'Advanced').length;
            const proficientCount = skillsData.skills.filter(s => s.level === 'Proficient').length;
            const totalSkills = skillsData.skills.length;
            
            // Updated point system:
            // Mastery (40+ yrs mastery): 4 points
            // Expert (20-40 yrs expertise): 3 points
            // Advanced (10-20 yrs strong): 2 points
            // Proficient (5-10 yrs competent): 1 point
            // Novice (0-5 yrs learning): 0 points
            const totalPoints = (masteryCount * 4) + (expertCount * 3) + (advancedCount * 2) + (proficientCount * 1);
            
            let baseMarketRate = 0;
            let roleLevel = '';
            let percentile = '50th'; // Default to median
            
            // Adjusted thresholds for 5-level system
            if (totalPoints >= 100) {
                baseMarketRate = 280000; // Executive/C-Suite (Cliff: 230 pts)
                roleLevel = 'VP/C-Suite';
                percentile = '75th';
            } else if (totalPoints >= 40) {
                baseMarketRate = 165000; // Senior Management (Mike: 49 pts)
                roleLevel = 'Senior Director';
            } else if (totalPoints >= 30) {
                baseMarketRate = 110000; // Director level (Sarah: 36 pts)
                roleLevel = 'Director';
            } else if (totalPoints >= 20) {
                baseMarketRate = 55000; // Mid-level professional (Jamie: 28 pts)
                roleLevel = 'Mid-Level Professional';
            } else if (totalPoints >= 10) {
                baseMarketRate = 38000; // Entry-level professional (Alex: 17 pts)
                roleLevel = 'Entry Professional';
            } else {
                baseMarketRate = 30000; // Entry level
                roleLevel = 'Entry Level';
            }
            
            // Step 2: Calculate comprehensive premium using 5-factor system
            
            // FACTOR 1: Work Styles & Soft Skills (20-30% max)
            const workStyleSkills = skillsData.skills.filter(s => 
                s.category === 'workstyle' && (s.level === 'Advanced' || s.level === 'Expert' || s.level === 'Mastery')
            );
            const workStylesPct = Math.min((workStyleSkills.length * 0.015), 0.30); // 1.5% per skill, max 30%
            
            // FACTOR 2: Evidence Quality (30-40% max)
            let evidenceScore = 0;
            skillsData.skills.forEach(skill => {
                if (skill.evidence && skill.evidence.length > 0) {
                    skill.evidence.forEach(ev => {
                        // Has quantified outcome (numbers, %, $)
                        if (ev.outcome && (ev.outcome.match(/\d+%|\$\d+|[0-9,]+/) || ev.outcome.includes('reduced') || ev.outcome.includes('increased'))) {
                            evidenceScore += 2; // High-quality evidence
                        } else if (ev.outcome) {
                            evidenceScore += 1; // Basic evidence
                        }
                    });
                }
            });
            const evidenceQualityPct = Math.min((evidenceScore * 0.005), 0.40); // 0.5% per quality point, max 40%
            
            // FACTOR 3: Skill Mix Rarity (15-25% max)
            let rarityPct = 0;
            const hasAI = skillsData.skills.some(s => s.name.toLowerCase().includes('ai') || s.name.toLowerCase().includes('machine learning'));
            const hasPilot = skillsData.skills.some(s => s.name.toLowerCase().includes('aviation') || s.name.toLowerCase().includes('ifr'));
            const hasStrategy = skillsData.skills.some(s => s.name.toLowerCase().includes('strategic'));
            const hasTechnical = skillsData.skills.some(s => s.category === 'skill' && s.name.toLowerCase().includes('programming'));
            const hasLeadership = skillsData.skills.some(s => s.name.toLowerCase().includes('leadership') || s.name.toLowerCase().includes('management'));
            const hasCreative = skillsData.skills.some(s => s.name.toLowerCase().includes('color') || s.name.toLowerCase().includes('styling') || s.name.toLowerCase().includes('creative'));
            const hasBehavioral = skillsData.skills.some(s => s.name.toLowerCase().includes('behavioral') || s.name.toLowerCase().includes('economics'));
            
            // Rare combinations add premium
            if (hasPilot && hasStrategy) rarityPct += 0.10; // Very rare: Aviation + Strategy
            if (hasAI && hasStrategy) rarityPct += 0.05; // Rare: AI + Strategy
            if (hasTechnical && hasLeadership) rarityPct += 0.05; // Valuable: Tech + Leadership
            if (hasCreative && hasTechnical) rarityPct += 0.08; // Uncommon: Creative + Technical
            if (hasBehavioral && hasStrategy) rarityPct += 0.05; // Rare: Behavioral Econ + Strategy
            rarityPct = Math.min(rarityPct, 0.25); // Max 25%
            
            // FACTOR 4: Critical Depth (10-15% max)
            const masteryInCriticalSkills = skillsData.skills.filter(s => {
                const impact = getSkillImpact(s);
                return (s.level === 'Mastery' || s.level === 'Expert') && (impact.level === 'critical' || impact.level === 'high');
            });
            const criticalDepthPct = Math.min((masteryInCriticalSkills.length * 0.02), 0.15); // 2% per critical mastery, max 15%
            
            // FACTOR 5: Learning & Growth (10-15% max)
            const noviceSkills = skillsData.skills.filter(s => s.level === 'Novice');
            const learningPct = Math.min((noviceSkills.length * 0.02), 0.15); // 2% per novice skill (shows growth), max 15%
            
            // Total premium percentage
            const totalPremiumPct = workStylesPct + evidenceQualityPct + rarityPct + criticalDepthPct + learningPct;
            
            // Calculate dollar amounts for breakdown
            const workStylesBonus = Math.round(baseMarketRate * workStylesPct);
            const evidenceBonus = Math.round(baseMarketRate * evidenceQualityPct);
            const rarityBonus = Math.round(baseMarketRate * rarityPct);
            const criticalDepthBonus = Math.round(baseMarketRate * criticalDepthPct);
            const learningBonus = Math.round(baseMarketRate * learningPct);
            const premiumAmount = workStylesBonus + evidenceBonus + rarityBonus + criticalDepthBonus + learningBonus;
            
            // Step 3: Location adjustment
            const locationMultiplier = skillValuations?.locationMultipliers?.[userData.profile.location] || 1.0;
            
            const totalValue = Math.round((baseMarketRate + premiumAmount) * locationMultiplier);
            
            // Calculate offer ranges
            const conservativeOffer = Math.round(totalValue * 0.75);
            const standardOffer = Math.round(totalValue * 0.85);
            const competitiveOffer = Math.round(totalValue * 0.95);
            
            // Build critical/high skills for compatibility
            const criticalSkills = skillsData.skills.filter(s => {
                const impact = getSkillImpact(s);
                return impact.level === 'critical';
            });
            
            const highSkills = skillsData.skills.filter(s => {
                const impact = getSkillImpact(s);
                return impact.level === 'high';
            });
            
            // Build top10Skills for compatibility
            const top10Skills = [
                ...criticalSkills.slice(0, 5).map(s => ({ skill: s.name, level: s.level, impact: 'Critical', impactLabel: 'Critical Impact' })),
                ...highSkills.slice(0, 5).map(s => ({ skill: s.name, level: s.level, impact: 'High', impactLabel: 'High Impact' }))
            ].slice(0, 10);
            
            // Calculate compa-ratio (your worth vs base market rate)
            const compaRatio = baseMarketRate > 0 ? Math.round((totalValue / baseMarketRate) * 100) : 100;
            
            return {
                // New structure
                total: totalValue,
                baseMarketRate: baseMarketRate,
                roleLevel: roleLevel,
                criticalSkills: criticalSkills.map(s => ({ name: s.name, level: s.level })),
                highSkills: highSkills.map(s => ({ name: s.name, level: s.level })),
                
                // NEW: Premium breakdown
                workStylesBonus: workStylesBonus,
                evidenceBonus: evidenceBonus,
                rarityBonus: rarityBonus,
                criticalDepthBonus: criticalDepthBonus,
                learningBonus: learningBonus,
                
                // Backward compatibility
                criticalBonus: criticalDepthBonus, // Map to new system
                highBonus: evidenceBonus, // Map to new system
                
                // Backward compatibility fields
                yourWorth: totalValue,
                marketRate: baseMarketRate,
                conservativeOffer: conservativeOffer,
                standardOffer: standardOffer,
                competitiveOffer: competitiveOffer,
                top10Skills: top10Skills,
                totalPoints: totalPoints,
                compaRatio: compaRatio,
                premiumAmount: premiumAmount,
                domainPremium: totalPremiumPct, // Now this is a proper percentage (0-0.60)
                percentile: percentile, // 50th or 75th based on role level
                
                breakdown: {
                    base: baseMarketRate,
                    critical: criticalDepthBonus,
                    high: evidenceBonus,
                    rarity: rarityBonus,
                    location: locationMultiplier
                }
            };
        }
        
        function getClosestRoleBenchmark(calculatedValue) {
            if (!skillValuations || !skillValuations.roleBenchmarks) {
                return null;
            }
            
            let closest = null;
            let minDiff = Infinity;
            
            Object.entries(skillValuations.roleBenchmarks).forEach(([role, data]) => {
                const diff = Math.abs(data.median - calculatedValue);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = { role, ...data };
                }
            });
            
            return closest;
        }
        
        // ===== SKILL VALUATIONS SYSTEM =====
        let skillValuations = {
            skillBaseValues: {},
            proficiencyMultipliers: { 
                "Novice": 0.7, 
                "Proficient": 1.0, 
                "Advanced": 1.5, 
                "Expert": 1.9, 
                "Mastery": 2.2 
            },
            locationMultipliers: {},
            demandFactors: {},
            rarityBonuses: {},
            roleBenchmarks: {}
        };
        
        // Load skill valuations from JSON
        fetch('skill_valuations.json')
            .then(response => response.json())
            .then(data => {
                skillValuations = data;
                console.log('✅ Skill valuations loaded');
                // Recalculate values if already rendered
                if (document.getElementById('totalMarketValue')) {
                    updateMarketValueDisplay();
                }
            })
            .catch(error => {
                console.warn('⚠️ Could not load skill valuations, using defaults:', error);
            });
        
        // Data structure
        const skillsData = {
            roles: [
                { id: "strategy", name: "VP Global Strategy", icon: "🎯", color: "#ef4444" },
                { id: "futurist", name: "Futurist & Evangelist", icon: "🔮", color: "#f59e0b" },
                { id: "pilot", name: "IFR Pilot", icon: "✈️", color: "#3b82f6" },
                { id: "musician", name: "Musician", icon: "🎵", color: "#8b5cf6" },
                { id: "advocate", name: "Recovery Advocate", icon: "💚", color: "#10b981" },
                { id: "tech", name: "Technology Strategist", icon: "⚙️", color: "#06b6d4" },
                { id: "creative", name: "Creative Director", icon: "🎨", color: "#ec4899" },
                { id: "operations", name: "Operations Leader", icon: "🍔", color: "#f97316" },
                { id: "entrepreneur", name: "Entrepreneur", icon: "🚀", color: "#a855f7" }
            ],
            
            skills: [
                // Strategic Core
                { name: "Enterprise AI Strategy", level: "Mastery", roles: ["strategy", "futurist", "tech"], key: false },
                { name: "Go-to-Market Strategy", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "Business Case Development", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "C-Suite Advisory & Influence", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Customer Advisory Board Leadership", level: "Mastery", roles: ["strategy"], key: false },
                { name: "Strategic Foresight & Market Prediction", level: "Mastery", roles: ["strategy", "futurist"], key: true },
                { name: "Organizational Transformation", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "Risk Assessment & Mitigation", level: "Mastery", roles: ["strategy", "pilot", "operations", "entrepreneur"], key: false },
                { name: "Revenue Pipeline Development", level: "Advanced", roles: ["strategy", "operations", "entrepreneur"], key: false },
                { name: "Financial Management & Budget Discipline", level: "Proficient", roles: ["strategy", "operations", "entrepreneur"], key: false },
                
                // Technology & Product
                { name: "AI/ML Product Strategy", level: "Mastery", roles: ["strategy", "tech", "futurist"], key: false },
                { name: "Talent Intelligence Platform Design", level: "Mastery", roles: ["strategy", "tech"], key: false },
                { name: "HR Technology Market Intelligence", level: "Mastery", roles: ["strategy", "futurist"], key: false },
                { name: "Technology Lifecycle & Disruption Analysis", level: "Mastery", roles: ["futurist", "tech"], key: false },
                { name: "Computational & Systems Thinking", level: "Advanced", roles: ["tech", "pilot"], key: false },
                { name: "Platform Integration Architecture", level: "Advanced", roles: ["tech", "entrepreneur"], key: false },
                { name: "Weak Signal Detection & Trend Recognition", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Spatial Reasoning & 3D Problem Solving", level: "Mastery", roles: ["pilot", "musician", "creative", "tech"], key: true },
                
                // Futurist & Innovation
                { name: "Technology Trend Forecasting", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Predictive Framework Development", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Disruptive Innovation Identification", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Scenario Planning & Strategic Alternatives", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Human-AI Collaboration Model Design", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                
                // Communication & Influence
                { name: "Executive Narrative & Storytelling", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Technical Concept Translation", level: "Mastery", roles: ["futurist", "tech", "strategy"], key: true },
                { name: "Public Speaking & Keynote Delivery", level: "Mastery", roles: ["futurist", "musician"], key: false },
                { name: "Thought Leadership Authorship", level: "Mastery", roles: ["futurist"], key: false },
                { name: "Rhetorical Strategy & Persuasion", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Media Relations & Spokesperson Work", level: "Mastery", roles: ["futurist"], key: false },
                { name: "Podcast Production & Hosting", level: "Advanced", roles: ["futurist", "musician"], key: false },
                { name: "Real-Time Improvisation", level: "Mastery", roles: ["musician", "futurist"], key: false },
                { name: "Industry Evangelism", level: "Mastery", roles: ["futurist"], key: false },
                { name: "Teaching & Knowledge Transfer", level: "Advanced", roles: ["futurist", "advocate"], key: false },
                
                // Domain Expertise
                { name: "Talent Acquisition Strategy", level: "Mastery", roles: ["strategy"], key: false },
                { name: "Candidate Experience Architecture", level: "Mastery", roles: ["strategy"], key: true },
                { name: "AI Ethics & Responsible Implementation", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Workforce Intelligence & Analytics", level: "Mastery", roles: ["strategy"], key: false },
                { name: "Talent Marketplace Dynamics", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Behavioral Economics in Talent", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Workforce Trends & Future of Work Analysis", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Generational Workforce Analysis", level: "Advanced", roles: ["futurist", "strategy"], key: false },
                { name: "AI Impact on Human Work", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                
                // Leadership & Interpersonal
                { name: "Enterprise Client Relationship Management", level: "Mastery", roles: ["strategy", "entrepreneur"], key: false },
                { name: "Strategic Team Building", level: "Advanced", roles: ["strategy", "operations", "tech", "entrepreneur"], key: false },
                { name: "Executive Mentorship", level: "Advanced", roles: ["strategy"], key: false },
                { name: "Multi-Stakeholder Alignment", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "Executive Presence & Authority", level: "Mastery", roles: ["strategy", "futurist"], key: false },
                { name: "Crisis Leadership & Decision Making", level: "Mastery", roles: ["pilot", "operations", "advocate", "strategy", "entrepreneur"], key: true },
                { name: "High-Pressure Performance", level: "Mastery", roles: ["pilot", "musician", "operations"], key: false },
                
                // Creative & Performance
                { name: "Creative Direction", level: "Mastery", roles: ["creative", "entrepreneur"], key: false },
                { name: "Live Musical Performance", level: "Mastery", roles: ["musician"], key: false },
                { name: "Music Composition & Arrangement", level: "Advanced", roles: ["musician"], key: false },
                { name: "Music Production & Artist Development", level: "Advanced", roles: ["musician"], key: false },
                { name: "Stage Command & Audience Connection", level: "Mastery", roles: ["musician", "futurist"], key: false },
                { name: "Performance Logistics", level: "Proficient", roles: ["musician"], key: false },
                
                // Aviation
                { name: "Single-Pilot IFR in Complex Airspace", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Single-Pilot Resource Management", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Weather Systems Analysis", level: "Advanced", roles: ["pilot"], key: false },
                { name: "ATC Communication & Coordination", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Emergency Airmanship", level: "Mastery", roles: ["pilot"], key: true },
                { name: "Aeronautical Decision Making Under Uncertainty", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Situational Awareness in Dynamic Environments", level: "Mastery", roles: ["pilot", "operations"], key: false },
                { name: "Multi-Channel Cognitive Load Management", level: "Mastery", roles: ["pilot", "operations"], key: false },
                
                // Analytical & Research
                { name: "Data-Driven Strategy Development", level: "Advanced", roles: ["strategy", "tech"], key: false },
                { name: "Market & Competitive Intelligence", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Research Synthesis & Pattern Recognition", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Critical Analysis & Evaluation", level: "Advanced", roles: ["strategy", "tech", "futurist"], key: false },
                
                // Advocacy
                { name: "Leadership Through Lived Experience", level: "Mastery", roles: ["advocate"], key: false },
                { name: "Mental Health & Addiction Advocacy", level: "Mastery", roles: ["advocate"], key: false },
                { name: "Nonprofit Founding & Operations", level: "Advanced", roles: ["advocate", "entrepreneur"], key: false },
                { name: "Authentic Leadership & Trust Building", level: "Mastery", roles: ["advocate", "futurist"], key: true },
                { name: "Culture Change & Inclusion Initiatives", level: "Advanced", roles: ["advocate"], key: false },
                { name: "Complex Problem Diagnosis & Resolution", level: "Advanced", roles: ["advocate"], key: false }
            ],
            
            skillDetails: {} // Will be loaded from skill_evidence.json
        };
        
        // ===== v2.0: USER DATA MANAGEMENT SYSTEM =====
        
        let userData = {
            initialized: false,
            profile: {
                name: "",
                email: "",
                location: "Remote"
            },
            skills: [],
            skillDetails: {},
            values: [],
            purpose: "",
            roles: [],
            preferences: {
                seniorityLevel: "Mid-Career",
                targetTitles: [],
                seniorityKeywords: ['vp', 'vice president', 'chief', 'head of', 'director', 'principal', 'senior director'],
                excludeRoles: ['engineer', 'developer', 'designer', 'analyst', 'coordinator', 'specialist', 
                              'junior', 'mid-level', 'associate', 'intern', 'entry', 'qa', 'frontend', 'backend',
                              'full stack', 'fullstack', 'software', 'devops', 'ui/ux', 'data scientist'],
                strategicKeywords: ['strategy', 'strategic', 'transformation', 'innovation', 'evangelist', 
                                   'thought leader', 'advisory', 'ai', 'ml', 'product', 'growth', 'business'],
                targetIndustries: [],
                minSalary: null,
                locationPreferences: ["US", "Remote"],
                minimumSkillMatches: 3,
                minimumMatchScore: 50
            },
            applications: [],
            savedJobs: []
        };
        
        let templates = {};
        let valuesLibrary = [];
        
        // Check if user has existing profile
        // Removed checkUserProfile - using template-based loading instead
        
        // Build profile selector dropdown from manifest
        function buildProfileSelector(profiles) {
            // Hidden select (kept for backward compatibility)
            const selector = document.getElementById('profileSelector');
            const currentId = localStorage.getItem('currentProfile') || profiles[0]?.id;

            if (selector) {
                selector.innerHTML = profiles.map(p =>
                    `<option value="${p.id}" ${p.id === currentId ? 'selected' : ''}>${p.name}</option>`
                ).join('');
            }

            // Rebuild auth-aware dropdown (includes sample profiles + auth controls)
            rebuildProfileDropdown();

            // Update the profile chip name/avatar (only if not signed in, otherwise auth controls it)
            if (!fbUser) {
                const current = profiles.find(p => p.id === currentId) || profiles[0];
                if (current) updateProfileChip(current.name);
            }

            console.log(`✓ Profile selector built with ${profiles.length} options`);
        }
        
        // Switch to a different profile (admin functionality)
        function switchProfile(templateId) {
            console.log('🔄 Switching profile to:', templateId);
            
            // Close dropdown immediately before rebuilding DOM
            closeProfileDropdown();
            
            if (!templates[templateId]) {
                console.error('Template not found:', templateId);
                showToast('Profile not found.', 'error');
                return;
            }
            
            // Load template inline (no page reload)
            loadTemplate(templateId);
            localStorage.setItem('currentProfile', templateId);
            
            // Re-initialize views with new data
            if (typeof skillsData !== 'undefined') {
                skillsData.skills = userData.skills;
                skillsData.roles = userData.roles;
            }
            
            // Update profile chip
            if (userData.profile && userData.profile.name) {
                updateProfileChip(userData.profile.name);
            }
            
            // Reset initialized flags so views re-render
            window.blueprintInitialized = false;
            window.opportunitiesInitialized = false;
            window.applicationsInitialized = false;
            window.consentInitialized = false;
            window.settingsInitialized = false;
            window.networkInitialized = false;
            window.cardViewInitialized = false;
            
            // Reset network state for new profile
            if (typeof activeRole !== 'undefined') activeRole = 'all';
            if (typeof activeJobForNetwork !== 'undefined') activeJobForNetwork = null;
            var searchInput = document.getElementById('skillSearch');
            if (searchInput) searchInput.value = '';
            
            // Check read-only status
            checkReadOnly();
            rebuildProfileDropdown();
            
            // Navigate to Skills view (network on desktop, card on mobile)
            if (window.innerWidth <= 768) {
                currentSkillsView = 'card';
            }
            switchView('network');
            // Ensure we're at the top after view switch
            setTimeout(function() { window.scrollTo(0, 0); }, 50);
        }
        
        // Save user data preference (which profile they're viewing)
        function saveUserData() {
            try {
                // Don't save userData to localStorage anymore
                // Only save which profile is active
                const currentProfileId = userData.templateId || 'cliff-jones-demo';
                localStorage.setItem('currentProfile', currentProfileId);
                console.log('✓ Profile preference saved:', currentProfileId);
                return true;
            } catch (e) {
                console.error('Error saving profile preference:', e);
                return false;
            }
        }
        
        // ===== SKILL LIBRARY SYSTEM (v2.3.0) =====
        let skillLibraryIndex = null;

        async function loadSkillLibraryIndex() {
            // Try v3 (current), gracefully degrade if missing — never block the app
            const cacheBuster = '?v=20260218-2100';
            const candidates = ['skills/index-v3.json', 'skills/index-v4.json'];
            
            for (const path of candidates) {
                try {
                    const response = await fetch(path + cacheBuster);
                    if (!response.ok) continue;
                    const data = await response.json();
                    skillLibraryIndex = data;
                    const count = data.totalSkills || data.index?.length || '?';
                    console.log(`✓ Skill library loaded: ${count} skills (${path})`);
                    // Update Add Skills count badge
                    const badge = document.getElementById('availableSkillsCount');
                    if (badge && count !== '?') badge.textContent = Number(count).toLocaleString();
                    return;
                } catch (e) {
                    // Try next candidate
                }
            }
            
            // All candidates failed — set empty index, app still works
            skillLibraryIndex = { totalSkills: 0, index: [] };
            console.warn('⚠ Skill search library (skills/index-v3.json) not found — Add Skills search will be empty. Other features unaffected.');
        }

        // Search skills by query - returns array always
        function searchSkills(query) {
            try {
                if (!skillLibraryIndex?.index || !query) return [];
                const q = query.toLowerCase().trim();
                if (q.length < 2) return [];
                
                return skillLibraryIndex.index
                    .filter(skill => {
                        const name = (skill.n || '').toLowerCase();
                        const category = (skill.c || '').toLowerCase();
                        const subcategory = (skill.sc || '').toLowerCase();
                        return name.includes(q) || category.includes(q) || subcategory.includes(q);
                    })
                    .sort((a, b) => {
                        const aName = (a.n || '').toLowerCase();
                        const bName = (b.n || '').toLowerCase();
                        if (aName === q) return -1;
                        if (bName === q) return 1;
                        if (aName.startsWith(q) && !bName.startsWith(q)) return -1;
                        if (!aName.startsWith(q) && bName.startsWith(q)) return 1;
                        return (b.p || 0) - (a.p || 0);
                    })
                    .slice(0, 20);
            } catch (error) {
                console.error('searchSkills error:', error);
                return [];
            }
        }

        function getCategoryColor(category) {
            const colors = {
                'Technology': '#3b82f6',
                'Business & Management': '#8b5cf6',
                'Finance & Accounting': '#10b981',
                'Marketing & Sales': '#f59e0b',
                'Human Resources': '#ec4899',
                'Healthcare & Medical': '#14b8a6',
                'Engineering & Manufacturing': '#6366f1',
                'Legal & Compliance': '#78716c',
                'Creative & Design': '#f97316',
                'General Professional': '#64748b'
            };
            return colors[category] || '#9ca3af';
        }

        function isSkillAlreadyAdded(skillName) {
            return userData.skills.some(s => 
                s.name.toLowerCase() === skillName.toLowerCase()
            );
        }

        // Load library on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSkillLibraryIndex();
        });
        
        // Load template into userData
        function loadTemplate(templateId) {
            const template = templates[templateId];
            if (!template) {
                console.error('Template not found:', templateId);
                return false;
            }
            
            console.log('📋 Loading template:', templateId);
            console.log('  → Template has', template.skills.length, 'skills');
            console.log('  → First skill:', template.skills[0].name);
            console.log('  → First skill has evidence:', template.skills[0].evidence ? `YES (${template.skills[0].evidence.length} items)` : 'NO');
            
            userData = {
                initialized: true,
                profile: {...template.profile},
                skills: [...template.skills],
                skillDetails: {},
                values: template.values ? [...template.values] : [],
                purpose: template.purpose || "",
                roles: [...template.roles],
                preferences: {
                    seniorityLevel: template.profile.roleLevel || "Mid-Career",
                    targetTitles: [],
                    seniorityKeywords: ['vp', 'vice president', 'chief', 'head of', 'director', 'principal', 'senior director'],
                    excludeRoles: ['engineer', 'developer', 'designer', 'analyst', 'coordinator', 'specialist', 
                                  'junior', 'mid-level', 'associate', 'intern', 'entry', 'qa', 'frontend', 'backend',
                                  'full stack', 'fullstack', 'software', 'devops', 'ui/ux', 'data scientist'],
                    strategicKeywords: ['strategy', 'strategic', 'transformation', 'innovation', 'evangelist', 
                                       'thought leader', 'advisory', 'ai', 'ml', 'product', 'growth', 'business'],
                    targetIndustries: [],
                    minSalary: null,
                    locationPreferences: ["US", "Remote"],
                    minimumSkillMatches: 3,
                    minimumMatchScore: 50
                },
                applications: [],
                templateId: templateId  // Store which template this is
            };
            
            console.log('  → userData.skills[0] has evidence:', userData.skills[0].evidence ? `YES (${userData.skills[0].evidence.length} items)` : 'NO');
            
            // Load skill evidence if it exists
            fetch('skill_evidence.json')
                .then(response => response.json())
                .then(data => {
                    userData.skillDetails = data;
                    console.log('✓ Loaded evidence for', Object.keys(data).length, 'skills');
                })
                .catch(error => console.log('No skill evidence file found'));
            
            saveUserData();
            console.log('✓ Template loaded:', template.templateName);
            return true;
        }
        
        // Initialize app - check for profile or show welcome
        async function initializeApp() {
            initTheme(); // Apply saved theme before anything renders
            // Load profile manifest and templates dynamically
            try {
                const cacheBust = `?v=${Date.now()}`;
                
                // STEP 1: Load profiles manifest
                console.log('📋 Loading profiles manifest...');
                const manifest = await fetch(`profiles-manifest.json${cacheBust}`).then(r => r.json());
                window.profilesManifest = manifest; // Store for profile selector
                
                // STEP 2: Load all enabled profiles from manifest
                const enabledProfiles = manifest.profiles.filter(p => p.enabled);
                console.log(`✓ Found ${enabledProfiles.length} enabled profiles in manifest`);
                
                for (const profileMeta of enabledProfiles) {
                    try {
                        const template = await fetch(`${profileMeta.path}${cacheBust}`).then(r => r.json());
                        templates[profileMeta.id] = template;
                        console.log(`  ✓ Loaded: ${profileMeta.name} (${profileMeta.title}) from ${profileMeta.path}`);
                    } catch (err) {
                        console.error(`  ✗ Failed to load ${profileMeta.path}:`, err);
                    }
                }
                
                // STEP 3: Load blank template
                const blankTemplate = await fetch(`profiles/templates/blank.json${cacheBust}`).then(r => r.json());
                templates['blank'] = blankTemplate;
                
                console.log(`✓ Profile loading complete: ${enabledProfiles.length} profiles ready`);
                
                // STEP 4: Build profile selector dropdown
                buildProfileSelector(enabledProfiles);
                
            } catch (e) {
                console.error('Error loading profiles:', e);
            }
            
            // Load O*NET skills library
            try {
                const onetLib = await fetch('onet-skills-library.json').then(r => r.json());
                window.onetSkillsLibrary = onetLib;
                console.log('✓ O*NET Skills Library loaded');
            } catch (e) {
                console.error('Error loading O*NET skills library:', e);
            }
            
            // Load O*NET abilities library  
            try {
                const abilitiesLib = await fetch('onet-abilities-library.json').then(r => r.json());
                window.onetAbilitiesLibrary = abilitiesLib;
                console.log('✓ O*NET Abilities Library loaded');
            } catch (e) {
                console.error('Error loading O*NET abilities library:', e);
            }
            
            // Load O*NET work styles library
            try {
                const workStylesLib = await fetch('onet-workstyles-library.json').then(r => r.json());
                window.onetWorkStylesLibrary = workStylesLib;
                const wsCount = workStylesLib.workStyles?.length || workStylesLib.count || '?';
                console.log(`✓ O*NET Work Styles Library loaded (${wsCount} work styles)`);
            } catch (e) {
                console.error('Error loading O*NET work styles library:', e);
            }
            
            // Load O*NET knowledge library
            try {
                const knowledgeLib = await fetch('onet-knowledge-library.json').then(r => r.json());
                window.onetKnowledgeLibrary = knowledgeLib;
                const kCount = knowledgeLib.knowledge?.length || knowledgeLib.count || '?';
                console.log(`✓ O*NET Knowledge Library loaded (${kCount} knowledge domains)`);
            } catch (e) {
                console.warn('O*NET Knowledge Library not yet deployed (onet-knowledge-library.json)');
            }
            
            // Load O*NET work activities library
            try {
                const activitiesLib = await fetch('onet-work-activities-library.json').then(r => r.json());
                window.onetWorkActivitiesLibrary = activitiesLib;
                const aCount = activitiesLib.activities?.length || activitiesLib.count || '?';
                console.log(`✓ O*NET Work Activities Library loaded (${aCount} work activities)`);
            } catch (e) {
                console.warn('O*NET Work Activities Library not yet deployed (onet-work-activities-library.json)');
            }
            
            // Load Trades & Creative skills library
            try {
                const tradesLib = await fetch('trades-creative-library.json').then(r => r.json());
                window.tradesCreativeLibrary = tradesLib;
                const tCount = tradesLib.count || 0;
                console.log(`✓ Trades & Creative Library loaded (${tCount} skills)`);
            } catch (e) {
                console.warn('Trades & Creative Library not yet deployed (trades-creative-library.json)');
            }
            
            // Load values library
            try {
                const lib = await fetch('values-library.json').then(r => r.json());
                valuesLibrary = lib.values || [];
                console.log('✓ Values library loaded:', valuesLibrary.length, 'values');
            } catch (e) {
                console.error('Error loading values library:', e);
            }
            
            // ===== PROFILE DECISION FLOW =====
            const currentProfile = localStorage.getItem('currentProfile');
            
            // Always load a scaffold template so nav/rendering works
            var scaffoldId = currentProfile || 'cliff-jones-demo';
            if (!templates[scaffoldId]) scaffoldId = 'cliff-jones-demo';
            if (templates[scaffoldId]) loadTemplate(scaffoldId);
            initializeMainApp();
            
            // Determine which view to show
            var targetView = 'welcome'; // Default: welcome page
            
            // CASE 1: Signed-in user with Firestore data
            if (fbUser && fbDb) {
                try {
                    var loaded = await loadUserFromFirestore(fbUser.uid);
                    if (loaded) {
                        console.log('☁ Firestore profile applied');
                        targetView = 'blueprint';
                    }
                } catch(e) {
                    console.warn('Firestore load failed:', e);
                }
                checkReadOnly();
                rebuildProfileDropdown();
            }
            // CASE 2: Not signed in → welcome page
            else {
                checkReadOnly();
            }
            
            // Always rebuild dropdown after manifest is available
            rebuildProfileDropdown();
            
            // Return target view so DOMContentLoaded can use it
            return targetView;
        }
        
        // Non-intrusive first-visit prompt to build own profile

        // Show welcome screen for new users
        
        // Start with selected template
        window.startWithTemplate = function(templateId) {
            console.log('🎯 Starting with template:', templateId);
            
            if (!templates[templateId]) {
                showToast('Template not found. Please refresh and try again.', 'error');
                return;
            }
            
            if (loadTemplate(templateId)) {
                console.log('✓ Template loaded successfully');
                
                // If blank, show onboarding wizard
                if (templateId === 'blank') {
                    showOnboardingWizard();
                } else {
                    // Force hard reload with cache bypass
                    console.log('🔄 Reloading page...');
                    window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
                }
            } else {
                showToast('Failed to load template. Please try again.', 'error');
            }
        };
        
        // Import profile from JSON file
        window.importProfile = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    userData = imported;
                    userData.initialized = true;
                    saveUserData();
                    location.reload();
                } catch (error) {
                    showToast('Import error: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        };
        
        // =====================================================================
        // ONBOARDING WIZARD v1.0
        // Multi-step guided profile builder with Claude AI resume parsing
        // =====================================================================

        let wizardState = {
            step: 1,
            totalSteps: 8,
            resumeText: '',
            parsedData: null,
            profile: {},
            skills: [],
            values: [],
            purpose: '',
            processing: false
        };

        function showOnboardingWizard() {
            // Remove any existing wizard
            const existing = document.getElementById('onboardingWizard');
            if (existing) existing.remove();

            wizardState = { step: 1, totalSteps: 8, resumeText: '', parsedData: null,
                            profile: {}, skills: [], values: [], purpose: '', processing: false };

            const overlay = document.createElement('div');
            overlay.id = 'onboardingWizard';
            overlay.style.cssText = `
                position: fixed; inset: 0; z-index: 50000;
                background: var(--bg-base);
                display: flex; flex-direction: column;
                overflow: hidden;
            `;
            document.body.appendChild(overlay);
            renderWizardStep();
        }

        function closeWizard() {
            const el = document.getElementById('onboardingWizard');
            if (el) el.remove();
        }

        function renderWizardStep() {
            const overlay = document.getElementById('onboardingWizard');
            if (!overlay) return;

            const steps = [
                { label: 'Start' },
                { label: 'Resume' },
                { label: 'Parsing' },
                { label: 'Profile' },
                { label: 'Skills' },
                { label: 'Values' },
                { label: 'Purpose' },
                { label: 'Complete' }
            ];

            const progressPct = ((wizardState.step - 1) / (wizardState.totalSteps - 1)) * 100;

            overlay.innerHTML = `
                <!-- Wizard Header -->
                <div style="display:flex; align-items:center; justify-content:space-between;
                            padding:0 28px; height:56px; border-bottom:1px solid var(--border);
                            background:var(--nav-bg); backdrop-filter:blur(20px); flex-shrink:0;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:28px; height:28px; display:flex; align-items:center; justify-content:center;">
                            <svg width="24" height="24" viewBox="0 0 52 52" fill="none"><circle cx="26" cy="26" r="24" stroke="#60a5fa" stroke-width="1.5" opacity="0.25"/><line x1="26" y1="26" x2="12" y2="10" stroke="#60a5fa" stroke-width="1.5" opacity="0.5"/><line x1="26" y1="26" x2="42" y2="12" stroke="#60a5fa" stroke-width="1.5" opacity="0.5"/><line x1="26" y1="26" x2="40" y2="40" stroke="#60a5fa" stroke-width="1.5" opacity="0.5"/><line x1="26" y1="26" x2="10" y2="40" stroke="#60a5fa" stroke-width="1.5" opacity="0.5"/><circle cx="26" cy="26" r="5" fill="#60a5fa"/><circle cx="12" cy="10" r="3.5" fill="#93bbfc"/><circle cx="42" cy="12" r="3" fill="#818cf8"/><circle cx="40" cy="40" r="3.5" fill="#93bbfc"/><circle cx="10" cy="40" r="3" fill="#818cf8"/></svg></div>
                        <span style="font-family:'Outfit',sans-serif; font-weight:500; color:var(--accent); font-size:0.82em; letter-spacing:0.22em; text-transform:uppercase;">
                            Blueprint
                        </span>
                        <span style="color:var(--text-muted); font-size:0.8em; margin-left:8px;">
                            Build Your Profile
                        </span>
                    </div>
                    <div style="display:flex; align-items:center; gap:16px;">
                        <span style="font-size:0.78em; color:var(--text-muted);">
                            Step ${wizardState.step} of ${wizardState.totalSteps}
                        </span>
                        <button onclick="confirmExitWizard()" style="
                            background:none; border:1px solid var(--border); border-radius:7px;
                            padding:5px 12px; color:var(--text-secondary); cursor:pointer; font-size:0.8em;">
                            Exit
                        </button>
                    </div>
                </div>

                <!-- Progress bar -->
                <div style="height:3px; background:var(--border); flex-shrink:0;">
                    <div style="height:100%; width:${progressPct}%;
                                background:linear-gradient(90deg,var(--accent),#818cf8);
                                transition:width 0.4s ease;"></div>
                </div>

                <!-- Step indicators -->
                <div style="display:flex; justify-content:center; gap:4px; padding:14px 28px 0;
                            flex-shrink:0; flex-wrap:wrap;">
                    ${steps.map((s, i) => {
                        const n = i + 1;
                        const active = n === wizardState.step;
                        const done = n < wizardState.step;
                        return `<div style="display:flex; align-items:center; gap:4px;">
                            <div style="width:22px; height:22px; border-radius:50%; display:flex;
                                        align-items:center; justify-content:center; font-size:0.7em;
                                        font-weight:700; transition:all 0.2s;
                                        background:${done ? 'var(--accent)' : active ? 'var(--accent)' : 'var(--input-bg)'};
                                        color:${done || active ? '#fff' : 'var(--text-muted)'};
                                        border:2px solid ${done || active ? 'var(--accent)' : 'var(--border)'};">
                                ${done ? '✓' : n}
                            </div>
                            <span style="font-size:0.72em; color:${active ? 'var(--accent)' : 'var(--text-muted)'};">
                                ${s.label}
                            </span>
                            ${i < steps.length - 1 ? '<div style="width:12px; height:1px; background:var(--border); margin:0 2px;"></div>' : ''}
                        </div>`;
                    }).join('')}
                </div>

                <!-- Step content -->
                <div id="wizardStepContent" style="flex:1; overflow-y:auto; padding:32px 28px;">
                    <div style="max-width:700px; margin:0 auto;" id="wizardInner">
                        <!-- Populated per step -->
                    </div>
                </div>
            `;

            // Render the current step content
            const inner = document.getElementById('wizardInner');
            switch(wizardState.step) {
                case 1: renderWizardStep1(inner); break;
                case 2: renderWizardStep2(inner); break;
                case 3: renderWizardStep3(inner); break;
                case 4: renderWizardStep4(inner); break;
                case 5: renderWizardStep5(inner); break;
                case 6: renderWizardStep6(inner); break;
                case 7: renderWizardStep7(inner); break;
                case 8: renderWizardStep8(inner); break;
            }
        }

        function wizardNext() {
            wizardState.step = Math.min(wizardState.step + 1, wizardState.totalSteps);
            renderWizardStep();
        }

        function wizardBack() {
            wizardState.step = Math.max(wizardState.step - 1, 1);
            renderWizardStep();
        }

        function confirmExitWizard() {
            if (wizardState.step > 2) {
                if (!confirm('Exit the wizard? Your progress will be lost.')) return;
            }
            closeWizard();
        }

        // ── Shared UI helpers ─────────────────────────────────────────────────

        function wizardCard(content) {
            return `<div style="background:var(--bg-elevated); border:1px solid var(--border);
                                border-radius:14px; padding:28px; margin-bottom:20px;">
                        ${content}
                    </div>`;
        }

        function wizardHeading(icon, title, subtitle) {
            return `<div style="text-align:center; margin-bottom:32px;">
                        <div style="font-size:2.8em; margin-bottom:12px;">${icon}</div>
                        <h2 style="color:var(--text-primary); font-size:1.6em; font-weight:700;
                                   margin-bottom:8px; letter-spacing:-0.02em;">${title}</h2>
                        <p style="color:var(--text-secondary); font-size:0.95em; line-height:1.6;
                                  max-width:500px; margin:0 auto;">${subtitle}</p>
                    </div>`;
        }

        function wizardBtn(label, onclick, style='primary') {
            const styles = {
                primary: `background:var(--accent); color:#fff; border:none;`,
                secondary: `background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border);`,
                ghost: `background:none; color:var(--text-secondary); border:1px solid var(--border);`
            };
            return `<button onclick="${onclick}" style="${styles[style]}
                        padding:11px 24px; border-radius:9px; cursor:pointer; font-size:0.9em;
                        font-weight:600; transition:all 0.18s; letter-spacing:0.01em;">
                        ${label}
                    </button>`;
        }

        // ── STEP 1: Entry point ───────────────────────────────────────────────

        function renderWizardStep1(el) {
            el.innerHTML = `
                ${wizardHeading('🔵', 'Build Your Blueprint',
                    'Most people undersell themselves when applying for work — not because they lack ability, but because they’ve never had the right tool to articulate it. This changes that.')}

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px;">
                    <div onclick="wizardChooseUpload()" id="card-upload"
                         style="background:var(--bg-elevated); border:2px solid var(--border);
                                border-radius:12px; padding:28px; cursor:pointer; transition:all 0.2s;
                                text-align:center;"
                         onmouseover="this.style.borderColor='var(--accent)'"
                         onmouseout="this.style.borderColor='var(--border)'">
                        <div style="font-size:2.2em; margin-bottom:12px;">📄</div>
                        <div style="font-weight:700; color:var(--text-primary); margin-bottom:6px;">Upload Resume</div>
                        <div style="font-size:0.85em; color:var(--text-secondary); line-height:1.5;">
                            PDF or paste text. Claude reads it and builds your profile automatically.
                        </div>
                        <div style="margin-top:14px; font-size:0.78em; color:var(--accent); font-weight:600;">
                            RECOMMENDED — Fastest setup
                        </div>
                    </div>

                    <div onclick="wizardChooseManual()" id="card-manual"
                         style="background:var(--bg-elevated); border:2px solid var(--border);
                                border-radius:12px; padding:28px; cursor:pointer; transition:all 0.2s;
                                text-align:center;"
                         onmouseover="this.style.borderColor='var(--accent)'"
                         onmouseout="this.style.borderColor='var(--border)'">
                        <div style="font-size:2.2em; margin-bottom:12px;">✍️</div>
                        <div style="font-weight:700; color:var(--text-primary); margin-bottom:6px;">Start Fresh</div>
                        <div style="font-size:0.85em; color:var(--text-secondary); line-height:1.5;">
                            Build your profile step by step. Good if you don't have a resume handy.
                        </div>
                    </div>
                </div>

                <div onclick="wizardChooseImport()"
                     style="background:var(--bg-elevated); border:2px dashed var(--border);
                            border-radius:12px; padding:18px 24px; cursor:pointer; transition:all 0.2s;
                            display:flex; align-items:center; gap:16px; margin-bottom:24px;"
                     onmouseover="this.style.borderColor='var(--accent)'"
                     onmouseout="this.style.borderColor='var(--border)'">
                    <div style="font-size:1.8em;">📂</div>
                    <div>
                        <div style="font-weight:600; color:var(--text-primary); font-size:0.9em;">
                            Import Saved Blueprint
                        </div>
                        <div style="font-size:0.82em; color:var(--text-secondary);">
                            Already have a profile JSON? Load it here.
                        </div>
                    </div>
                    <input type="file" id="wizardImportFile" accept=".json" style="display:none"
                           onchange="wizardImportProfile(event)">
                </div>

                <p style="text-align:center; font-size:0.8em; color:var(--text-muted); margin-top:8px;">
                    🔒 Your data is saved securely to your account. You own everything.
                </p>
            `;
        }

        function wizardChooseUpload() {
            wizardState.entryMode = 'upload';
            wizardNext();
        }

        function wizardChooseManual() {
            wizardState.entryMode = 'manual';
            // Skip parsing step - go straight to profile
            wizardState.step = 4;
            renderWizardStep();
        }

        function wizardChooseImport() {
            document.getElementById('wizardImportFile').click();
        }

        function wizardImportProfile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    userData = { ...imported, initialized: true };
                    saveUserData();
                    closeWizard();
                    location.reload();
                } catch(err) {
                    showToast('File read error: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // ── STEP 2: Resume input ──────────────────────────────────────────────

        function renderWizardStep2(el) {
            el.innerHTML = `
                ${wizardHeading('📄', 'Add Your Resume',
                    'Paste your resume text below, or upload a PDF. Claude will read it and extract your skills, experience, and outcomes automatically.')}

                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:24px; margin-bottom:20px;">
                    <div style="display:flex; gap:8px; margin-bottom:16px;">
                        <button onclick="wizardSetResumeTab('paste')" id="rtab-paste"
                                style="padding:7px 16px; border-radius:7px; border:none; cursor:pointer;
                                       background:var(--accent); color:#fff; font-size:0.85em; font-weight:600;">
                            Paste Text
                        </button>
                        <button onclick="wizardSetResumeTab('linkedin')" id="rtab-linkedin"
                                style="padding:7px 16px; border-radius:7px; border:1px solid var(--border);
                                       background:var(--input-bg); color:var(--text-secondary);
                                       cursor:pointer; font-size:0.85em;">
                            LinkedIn Text
                        </button>
                    </div>

                    <div id="rtab-paste-content">
                        <textarea id="wizardResumeText" placeholder="Paste your full resume here — the more detail, the better the profile Claude builds for you.

Include: job titles, companies, dates, responsibilities, achievements, metrics, skills, education, certifications..."
                                  style="width:100%; min-height:280px; background:var(--input-bg);
                                         border:1px solid var(--border); border-radius:8px; padding:14px;
                                         color:var(--text-primary); font-size:0.88em; line-height:1.7;
                                         font-family:inherit; resize:vertical; outline:none;
                                         transition:border-color 0.2s;"
                                  onfocus="this.style.borderColor='var(--accent)'"
                                  onblur="this.style.borderColor='var(--border)'"
                                  oninput="wizardCheckResumeReady()">${wizardState.resumeText}</textarea>
                    </div>

                    <div id="rtab-linkedin-content" style="display:none;">
                        <p style="color:var(--text-secondary); font-size:0.85em; line-height:1.6; margin-bottom:14px;">
                            Go to your LinkedIn profile → click <strong>More</strong> → <strong>Save to PDF</strong>,
                            then paste the text here. Or copy your About section and each job entry manually.
                        </p>
                        <textarea id="wizardLinkedInText" placeholder="Paste your LinkedIn profile text here..."
                                  style="width:100%; min-height:240px; background:var(--input-bg);
                                         border:1px solid var(--border); border-radius:8px; padding:14px;
                                         color:var(--text-primary); font-size:0.88em; line-height:1.7;
                                         font-family:inherit; resize:vertical; outline:none;"
                                  oninput="wizardCheckResumeReady()"></textarea>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    ${wizardBtn('← Back', 'wizardBack()', 'ghost')}
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button onclick="wizardSkipParsing()"
                                style="background:none; border:none; color:var(--text-muted);
                                       cursor:pointer; font-size:0.82em; text-decoration:underline;">
                            Skip — enter manually
                        </button>
                        <button id="wizardParseBtn" onclick="wizardStartParsing()" disabled
                                style="background:var(--accent); color:#fff; border:none;
                                       padding:11px 28px; border-radius:9px; cursor:pointer;
                                       font-size:0.9em; font-weight:600; opacity:0.5; transition:opacity 0.2s;">
                            Parse with Claude →
                        </button>
                    </div>
                </div>
            `;
        }

        function wizardSetResumeTab(tab) {
            const paste = document.getElementById('rtab-paste-content');
            const li = document.getElementById('rtab-linkedin-content');
            const btnPaste = document.getElementById('rtab-paste');
            const btnLi = document.getElementById('rtab-linkedin');

            if (tab === 'paste') {
                paste.style.display = 'block'; li.style.display = 'none';
                btnPaste.style.background = 'var(--accent)'; btnPaste.style.color = '#fff';
                btnPaste.style.border = 'none';
                btnLi.style.background = 'var(--input-bg)'; btnLi.style.color = 'var(--text-secondary)';
                btnLi.style.border = '1px solid var(--border)';
            } else {
                paste.style.display = 'none'; li.style.display = 'block';
                btnLi.style.background = 'var(--accent)'; btnLi.style.color = '#fff';
                btnLi.style.border = 'none';
                btnPaste.style.background = 'var(--input-bg)'; btnPaste.style.color = 'var(--text-secondary)';
                btnPaste.style.border = '1px solid var(--border)';
            }
        }

        function wizardCheckResumeReady() {
            const t1 = document.getElementById('wizardResumeText')?.value?.trim() || '';
            const t2 = document.getElementById('wizardLinkedInText')?.value?.trim() || '';
            const hasText = t1.length > 50 || t2.length > 50;
            const btn = document.getElementById('wizardParseBtn');
            if (btn) {
                btn.disabled = !hasText;
                btn.style.opacity = hasText ? '1' : '0.5';
                btn.style.cursor = hasText ? 'pointer' : 'default';
            }
        }

        function wizardSkipParsing() {
            wizardState.entryMode = 'manual';
            wizardState.step = 4;
            renderWizardStep();
        }

        async function wizardStartParsing() {
            const t1 = document.getElementById('wizardResumeText')?.value?.trim() || '';
            const t2 = document.getElementById('wizardLinkedInText')?.value?.trim() || '';
            wizardState.resumeText = t1 || t2;
            wizardNext(); // Go to step 3 (parsing/loading)
            await wizardRunParsing();
        }

        // ── STEP 3: AI Parsing ────────────────────────────────────────────────

        function renderWizardStep3(el) {
            el.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center;
                            justify-content:center; min-height:320px; text-align:center; gap:24px;">
                    <div id="wizardParsingIcon" style="font-size:3em; animation:spin 2s linear infinite;">⚙️</div>
                    <div>
                        <h2 style="color:var(--text-primary); font-size:1.4em; margin-bottom:10px;">
                            Claude is reading your resume
                        </h2>
                        <p id="wizardParsingStatus" style="color:var(--text-secondary); font-size:0.9em;">
                            Extracting skills, evidence, and outcomes...
                        </p>
                    </div>
                    <div style="width:280px; height:4px; background:var(--border); border-radius:4px; overflow:hidden;">
                        <div id="wizardParseProgress" style="height:100%; width:0%;
                                    background:linear-gradient(90deg,var(--accent),#818cf8);
                                    border-radius:4px; transition:width 0.5s ease;"></div>
                    </div>
                    <p style="color:var(--text-muted); font-size:0.8em;">Usually takes 10–20 seconds</p>
                </div>
            `;
        }

        async function wizardRunParsing() {
            const setStatus = (msg, pct) => {
                const s = document.getElementById('wizardParsingStatus');
                const p = document.getElementById('wizardParseProgress');
                if (s) s.textContent = msg;
                if (p) p.style.width = pct + '%';
            };

            try {
                setStatus('Sending to Claude...', 15);

                const systemPrompt = `You are a professional career analyst. Extract structured profile data from a resume or LinkedIn profile text.

Return ONLY valid JSON in this exact shape — no markdown, no explanation, just the JSON object:
{
  "profile": {
    "name": "Full Name",
    "currentTitle": "Current Job Title",
    "location": "City, State or Remote",
    "email": "",
    "phone": "",
    "yearsExperience": 10,
    "executiveSummary": "2-3 sentence professional summary in first person"
  },
  "roles": [
    { "id": "role1", "name": "Role Name", "years": "2019-Present", "company": "Company Name" }
  ],
  "skills": [
    {
      "name": "Skill Name",
      "level": "Mastery|Expert|Advanced|Proficient|Novice",
      "category": "skill|ability|workstyle|unique",
      "roles": ["role1"],
      "key": true,
      "evidence": [
        { "description": "What you did", "outcome": "Measurable result or impact" }
      ]
    }
  ],
  "values": [
    { "name": "Value Name", "description": "Brief personal description of this value", "selected": true }
  ],
  "purpose": "One paragraph purpose statement in first person — what you do, who you help, how you do it differently"
}

Rules:
- Extract 15-40 skills. Include technical skills, soft skills, leadership abilities, and unique differentiators.
- Level guide: Mastery=career-defining expertise (15+ yrs), Expert=deep proficiency (8-15 yrs), Advanced=strong competency (4-8 yrs), Proficient=solid (1-4 yrs), Novice=learning.
- For each skill, extract 1-3 evidence items from the resume. Outcomes must be specific — include numbers, percentages, dollar amounts wherever present in the text.
- Infer 4-6 values from the resume's tone, achievements, and career pattern. Make them personal, not generic.
- Write the purpose statement to be compelling and authentic to this person's actual experience.
- category="unique" for skills not in standard O*NET taxonomy (industry-specific, rare combinations).`;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        system: systemPrompt,
                        messages: [{ role: 'user', content: `Parse this resume:

${wizardState.resumeText}` }]
                    })
                });

                setStatus('Structuring your profile data...', 55);

                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                const rawText = data.content[0]?.text || '';

                setStatus('Extracting skills and evidence...', 75);

                // Strip markdown fences if present
                const clean = rawText.replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/```\s*$/i, '').trim();
                const parsed = JSON.parse(clean);

                setStatus('Building your Blueprint...', 95);

                wizardState.parsedData = parsed;
                wizardState.profile = parsed.profile || {};
                wizardState.skills = parsed.skills || [];
                wizardState.values = (parsed.values || []).map(v => ({ ...v, selected: v.selected !== false }));
                wizardState.purpose = parsed.purpose || '';

                await new Promise(r => setTimeout(r, 600));
                setStatus('Done! ✓', 100);
                await new Promise(r => setTimeout(r, 400));

                wizardState.step = 4;
                renderWizardStep();

            } catch (err) {
                console.error('Parsing error:', err);
                const el = document.getElementById('wizardParsingIcon');
                if (el) el.style.animation = 'none';
                const status = document.getElementById('wizardParsingStatus');
                if (status) status.innerHTML = `
                    <span style="color:var(--danger);">
                        Parsing failed: ${err.message}<br><br>
                    </span>
                    <button onclick="wizardState.step=2; renderWizardStep();"
                            style="background:var(--accent); color:#fff; border:none; padding:9px 20px;
                                   border-radius:7px; cursor:pointer; font-size:0.85em; margin-right:10px;">
                        ← Try Again
                    </button>
                    <button onclick="wizardSkipParsing()"
                            style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border);
                                   padding:9px 20px; border-radius:7px; cursor:pointer; font-size:0.85em;">
                        Enter Manually
                    </button>
                `;
            }
        }

        // ── STEP 4: Profile review ─────────────────────────────────────────────

        function renderWizardStep4(el) {
            const p = wizardState.profile;
            const isFromResume = !!wizardState.parsedData;

            el.innerHTML = `
                ${wizardHeading(isFromResume ? '✅' : '👤', 
                    isFromResume ? 'Review Your Profile' : 'Your Profile',
                    isFromResume ? 'Claude extracted this from your resume. Review and correct anything that’s off.' 
                                 : 'Fill in your basic information to get started.')}

                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:24px; margin-bottom:20px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        ${wizardField('Full Name', 'wizardName', p.name || '', 'e.g. Alex Johnson')}
                        ${wizardField('Current Title', 'wizardTitle', p.currentTitle || '', 'e.g. VP of Engineering')}
                        ${wizardField('Location', 'wizardLocation', p.location || '', 'e.g. Austin, TX / Remote')}
                        ${wizardField('Email', 'wizardEmail', p.email || '', 'your@email.com')}
                        ${wizardField('Years of Experience', 'wizardYears', p.yearsExperience || '', 'e.g. 15')}
                        ${wizardField('Phone (optional)', 'wizardPhone', p.phone || '', '')}
                    </div>
                    <div style="margin-top:16px;">
                        <label style="display:block; font-size:0.82em; font-weight:600;
                                      color:var(--text-secondary); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.04em;">
                            Professional Summary
                        </label>
                        <textarea id="wizardSummary" placeholder="A 2-3 sentence summary of who you are professionally..."
                                  style="width:100%; min-height:100px; background:var(--input-bg);
                                         border:1px solid var(--border); border-radius:8px; padding:12px;
                                         color:var(--text-primary); font-size:0.9em; line-height:1.6;
                                         font-family:inherit; resize:vertical; outline:none;"
                                  onfocus="this.style.borderColor='var(--accent)'"
                                  onblur="this.style.borderColor='var(--border)'">${p.executiveSummary || ''}</textarea>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between;">
                    ${wizardBtn('← Back', wizardState.entryMode === 'manual' ? 'wizardBack()' : 'wizardBack()', 'ghost')}
                    ${wizardBtn('Continue → Skills', 'wizardSaveProfile()', 'primary')}
                </div>
            `;
        }

        function wizardField(label, id, value, placeholder) {
            return `<div>
                <label style="display:block; font-size:0.82em; font-weight:600;
                              color:var(--text-secondary); margin-bottom:6px;
                              text-transform:uppercase; letter-spacing:0.04em;">
                    ${label}
                </label>
                <input id="${id}" type="text" value="${(value || '').replace(/"/g, '&quot;')}"
                       placeholder="${placeholder}"
                       style="width:100%; padding:10px 12px; background:var(--input-bg);
                              border:1px solid var(--border); border-radius:8px;
                              color:var(--text-primary); font-size:0.9em; outline:none;
                              transition:border-color 0.2s; font-family:inherit;"
                       onfocus="this.style.borderColor='var(--accent)'"
                       onblur="this.style.borderColor='var(--border)'">
            </div>`;
        }

        function wizardSaveProfile() {
            wizardState.profile = {
                name: document.getElementById('wizardName')?.value?.trim() || '',
                currentTitle: document.getElementById('wizardTitle')?.value?.trim() || '',
                location: document.getElementById('wizardLocation')?.value?.trim() || '',
                email: document.getElementById('wizardEmail')?.value?.trim() || '',
                phone: document.getElementById('wizardPhone')?.value?.trim() || '',
                yearsExperience: parseInt(document.getElementById('wizardYears')?.value) || 0,
                executiveSummary: document.getElementById('wizardSummary')?.value?.trim() || ''
            };

            if (!wizardState.profile.name) {
                showToast('Please enter your name to continue.', 'warning');
                document.getElementById('wizardName')?.focus();
                return;
            }
            wizardNext();
        }

        // ── STEP 5: Skills review ──────────────────────────────────────────────

        function renderWizardStep5(el) {
            const skills = wizardState.skills;
            const isFromResume = skills.length > 0;
            const levelColors = { Mastery:'#ef4444', Expert:'#f97316', Advanced:'#f59e0b', Proficient:'#10b981', Novice:'#6b7280' };

            el.innerHTML = `
                ${wizardHeading('🗺️',
                    isFromResume ? `${skills.length} Skills Extracted` : 'Your Skills',
                    isFromResume ? 'Claude identified these from your resume. Toggle any off you do not want to include. You can add more later.'
                                 : 'Add your key skills. You can build this out further after setup.')}

                ${isFromResume ? `
                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:20px; margin-bottom:20px; max-height:420px; overflow-y:auto;">
                    ${skills.map((s, i) => `
                        <div style="display:flex; align-items:center; gap:12px; padding:10px 0;
                                    border-bottom:1px solid var(--border);">
                            <input type="checkbox" id="skill-check-${i}" checked
                                   style="width:16px; height:16px; cursor:pointer; accent-color:var(--accent);">
                            <div style="width:10px; height:10px; border-radius:50%; flex-shrink:0;
                                        background:${levelColors[s.level] || '#6b7280'};"></div>
                            <div style="flex:1; min-width:0;">
                                <div style="font-weight:600; color:var(--text-primary); font-size:0.9em;">
                                    ${s.name}
                                </div>
                                <div style="font-size:0.78em; color:var(--text-muted);">
                                    ${s.level} · ${s.evidence?.length || 0} evidence items
                                </div>
                            </div>
                            <span style="font-size:0.75em; padding:3px 9px; border-radius:10px;
                                         background:var(--chip-bg); color:var(--text-secondary);">
                                ${s.level}
                            </span>
                        </div>
                    `).join('')}
                </div>
                <p style="font-size:0.82em; color:var(--text-muted); margin-bottom:20px;">
                    Uncheck skills you want to exclude. You can add, edit, and add evidence to all skills after setup.
                </p>
                ` : `
                <div style="background:var(--bg-elevated); border:2px dashed var(--border);
                            border-radius:14px; padding:32px; text-align:center; margin-bottom:20px;">
                    <p style="color:var(--text-secondary); margin-bottom:16px;">
                        Skills are best built from your resume. You can add them manually in the Skills tab after setup.
                    </p>
                    <p style="color:var(--text-muted); font-size:0.85em;">
                        The system includes 90+ O*NET standard skills you can browse and add.
                    </p>
                </div>
                `}

                <div style="display:flex; justify-content:space-between;">
                    ${wizardBtn('← Back', 'wizardBack()', 'ghost')}
                    ${wizardBtn('Continue → Values', 'wizardSaveSkills()', 'primary')}
                </div>
            `;
        }

        function wizardSaveSkills() {
            // Filter to only checked skills
            wizardState.skills = wizardState.skills.filter((s, i) => {
                const cb = document.getElementById(`skill-check-${i}`);
                return !cb || cb.checked;
            });
            wizardNext();
        }

        // ── STEP 6: Values ────────────────────────────────────────────────────

        function renderWizardStep6(el) {
            const vals = wizardState.values.length > 0 ? wizardState.values : [
                { name: 'Intellectual Integrity', description: 'Evidence-based decisions. Challenge assumptions before accepting conclusions.', selected: true },
                { name: 'Outcome-Focused', description: 'Judge by impact delivered, not activity performed.', selected: true },
                { name: 'Continuous Learning', description: 'Seek disconfirming evidence. Update beliefs when data changes.', selected: true },
                { name: 'Authentic Leadership', description: 'Lead with transparency and truth.', selected: false },
                { name: 'Customer-Centric', description: 'Solve real problems. Understand needs before building.', selected: false },
                { name: 'Innovation', description: 'Find better ways. Challenge the status quo with purpose.', selected: false }
            ];
            wizardState.values = vals;

            const isFromResume = !!wizardState.parsedData;

            el.innerHTML = `
                ${wizardHeading('💡',
                    'Your Professional Values',
                    isFromResume ? 'Claude inferred these from your career history. Select the ones that feel true. You can edit descriptions to make them personal.'
                                 : 'Select the values that define how you work. These appear in your Blueprint.')}

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:24px;">
                    ${vals.map((v, i) => `
                        <div onclick="wizardToggleValue(${i})" id="val-card-${i}"
                             style="background:var(--bg-elevated);
                                    border:2px solid ${v.selected ? 'var(--accent)' : 'var(--border)'};
                                    border-radius:10px; padding:14px; cursor:pointer; transition:all 0.18s;
                                    ${v.selected ? 'background:var(--accent-glow);' : ''}">
                            <div style="display:flex; align-items:start; gap:10px;">
                                <div style="width:18px; height:18px; border-radius:4px; flex-shrink:0; margin-top:2px;
                                            background:${v.selected ? 'var(--accent)' : 'var(--input-bg)'};
                                            border:2px solid ${v.selected ? 'var(--accent)' : 'var(--border)'};
                                            display:flex; align-items:center; justify-content:center;
                                            color:#fff; font-size:11px;">
                                    ${v.selected ? '✓' : ''}
                                </div>
                                <div style="flex:1;">
                                    <div style="font-weight:700; color:var(--text-primary); font-size:0.88em;
                                                margin-bottom:4px;">${v.name}</div>
                                    <div style="font-size:0.78em; color:var(--text-secondary);
                                                line-height:1.4;">${v.description || ''}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    ${wizardBtn('← Back', 'wizardBack()', 'ghost')}
                    <div>
                        <span style="font-size:0.82em; color:var(--text-muted); margin-right:16px;">
                            ${vals.filter(v=>v.selected).length} selected
                        </span>
                        ${wizardBtn('Continue → Purpose', 'wizardSaveValues()', 'primary')}
                    </div>
                </div>
            `;
        }

        function wizardToggleValue(i) {
            wizardState.values[i].selected = !wizardState.values[i].selected;
            // Re-render step without full wizard rebuild
            const card = document.getElementById(`val-card-${i}`);
            const v = wizardState.values[i];
            if (card) {
                card.style.borderColor = v.selected ? 'var(--accent)' : 'var(--border)';
                card.style.background = v.selected ? 'var(--accent-glow)' : 'var(--bg-elevated)';
                const check = card.querySelector('div > div > div:first-child');
                if (check) {
                    check.style.background = v.selected ? 'var(--accent)' : 'var(--input-bg)';
                    check.style.borderColor = v.selected ? 'var(--accent)' : 'var(--border)';
                    check.textContent = v.selected ? '✓' : '';
                }
            }
            // Update count
            const countEl = document.querySelector('[style*="0.82em"][style*="var(--text-muted)"][style*="margin-right"]');
            if (countEl) countEl.textContent = wizardState.values.filter(v=>v.selected).length + ' selected';
        }

        function wizardSaveValues() {
            wizardNext();
        }

        // ── STEP 7: Purpose ───────────────────────────────────────────────────

        function renderWizardStep7(el) {
            const purpose = wizardState.purpose;
            const isFromResume = !!wizardState.parsedData;

            el.innerHTML = `
                ${wizardHeading('✍️',
                    'Your Purpose Statement',
                    isFromResume ? 'Claude drafted this from your resume. Often the hardest thing to write about yourself — edit it until it sounds like you.'
                                 : 'Write a brief statement about what you do, who you help, and what makes your approach distinctive.')}

                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:24px; margin-bottom:20px;">
                    <textarea id="wizardPurpose"
                              placeholder="I help [who] achieve [what] through [how]. I bring [distinctive quality] that enables [specific outcome]..."
                              style="width:100%; min-height:160px; background:var(--input-bg);
                                     border:1px solid var(--border); border-radius:8px; padding:14px;
                                     color:var(--text-primary); font-size:0.95em; line-height:1.7;
                                     font-family:inherit; resize:vertical; outline:none;"
                              onfocus="this.style.borderColor='var(--accent)'"
                              onblur="this.style.borderColor='var(--border)'">${purpose}</textarea>

                    ${isFromResume ? `
                    <button onclick="wizardRegeneratePurpose()"
                            style="margin-top:12px; background:none; border:1px solid var(--border);
                                   border-radius:7px; padding:7px 14px; color:var(--text-secondary);
                                   cursor:pointer; font-size:0.82em; transition:all 0.18s;"
                            onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'"
                            onmouseout="this.style.borderColor='var(--border)'; this.style.color='var(--text-secondary)'">
                        ↺ Regenerate with Claude
                    </button>` : ''}
                </div>

                <div style="background:var(--accent-glow); border:1px solid var(--border);
                            border-radius:10px; padding:16px; margin-bottom:24px;">
                    <div style="font-size:0.82em; color:var(--text-secondary); line-height:1.6;">
                        <strong style="color:var(--accent);">💡 What makes a strong purpose statement:</strong><br>
                        Specific about who you help · Describes real outcomes, not activities · Reflects your actual approach · Sounds like a person, not a job description
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between;">
                    ${wizardBtn('← Back', 'wizardBack()', 'ghost')}
                    ${wizardBtn('Continue → Finish', 'wizardSavePurpose()', 'primary')}
                </div>
            `;
        }

        async function wizardRegeneratePurpose() {
            const btn = event.target.closest('button');
            if (btn) { btn.textContent = '⟳ Regenerating...'; btn.disabled = true; }

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 300,
                        messages: [{
                            role: 'user',
                            content: `Write a 2-3 sentence professional purpose statement for this person. Make it specific, human, and authentic — not generic corporate speak. Return only the statement, no preamble.

Name: ${wizardState.profile.name}
Title: ${wizardState.profile.currentTitle}
Top skills: ${wizardState.skills.slice(0,8).map(s=>s.name).join(', ')}
Values: ${wizardState.values.filter(v=>v.selected).map(v=>v.name).join(', ')}
Selected outcomes: ${wizardState.skills.flatMap(s=>s.evidence||[]).slice(0,5).map(e=>e.outcome).filter(Boolean).join(' | ')}`
                        }]
                    })
                });
                const data = await response.json();
                const newPurpose = data.content[0]?.text?.trim() || '';
                if (newPurpose) {
                    wizardState.purpose = newPurpose;
                    const ta = document.getElementById('wizardPurpose');
                    if (ta) ta.value = newPurpose;
                }
            } catch(err) {
                console.error('Regenerate error:', err);
            }

            if (btn) { btn.textContent = '↺ Regenerate with Claude'; btn.disabled = false; }
        }

        function wizardSavePurpose() {
            wizardState.purpose = document.getElementById('wizardPurpose')?.value?.trim() || '';
            wizardNext();
        }

        // ── STEP 8: Complete ──────────────────────────────────────────────────

        function renderWizardStep8(el) {
            const skillCount = wizardState.skills.length;
            const valueCount = wizardState.values.filter(v => v.selected).length;
            const evidenceCount = wizardState.skills.reduce((n, s) => n + (s.evidence?.length || 0), 0);

            el.innerHTML = `
                ${wizardHeading('🎉', 'Your Blueprint is Ready',
                    'Here is what we built together. Download your profile to save it, then explore your full dashboard.')}

                <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:24px;">
                    ${[
                        ['🗺️', skillCount, 'Skills'],
                        ['📋', evidenceCount, 'Evidence Items'],
                        ['💡', valueCount, 'Values']
                    ].map(([icon, n, label]) => `
                        <div style="background:var(--bg-elevated); border:1px solid var(--border);
                                    border-radius:12px; padding:20px; text-align:center;">
                            <div style="font-size:1.8em; margin-bottom:6px;">${icon}</div>
                            <div style="font-size:1.8em; font-weight:800; color:var(--accent); line-height:1;">${n}</div>
                            <div style="font-size:0.82em; color:var(--text-secondary); margin-top:4px;">${label}</div>
                        </div>
                    `).join('')}
                </div>

                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:22px; margin-bottom:20px;">
                    <div style="font-weight:700; color:var(--text-primary); margin-bottom:12px; font-size:0.95em;">
                        ${wizardState.profile.name || 'Your'} · ${wizardState.profile.currentTitle || ''}
                    </div>
                    ${wizardState.purpose ? `
                    <p style="color:var(--text-secondary); font-size:0.88em; line-height:1.7; margin-bottom:14px;
                               font-style:italic; border-left:3px solid var(--accent); padding-left:14px;">
                        "${wizardState.purpose}"
                    </p>` : ''}
                    <div style="display:flex; flex-wrap:wrap; gap:6px;">
                        ${wizardState.values.filter(v=>v.selected).slice(0,5).map(v =>
                            `<span style="background:var(--chip-bg); border:1px solid var(--border);
                                          padding:4px 10px; border-radius:10px; font-size:0.78em;
                                          color:var(--text-secondary);">${v.name}</span>`
                        ).join('')}
                    </div>
                </div>

                <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:24px;">
                    <button onclick="wizardDownloadAndLaunch()"
                            style="flex:1; background:var(--accent); color:#fff; border:none;
                                   padding:14px 24px; border-radius:10px; cursor:pointer;
                                   font-size:0.95em; font-weight:700; min-width:200px;">
                        💾 Save Profile & Go to Dashboard
                    </button>
                    <button onclick="wizardLaunchOnly()"
                            style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border);
                                   padding:14px 20px; border-radius:10px; cursor:pointer; font-size:0.88em;">
                        Explore Dashboard →
                    </button>
                </div>

                <p style="text-align:center; font-size:0.8em; color:var(--text-muted);">
                    Your profile is saved to your account automatically. Download the JSON file as a backup.
                </p>
            `;
        }

        function wizardBuildUserData() {
            return {
                initialized: true,
                templateId: 'wizard-built',
                profile: {
                    ...wizardState.profile,
                    headline: `${wizardState.profile.currentTitle || ''} · ${wizardState.profile.yearsExperience || ''}+ Years`
                },
                skills: wizardState.skills.map(s => ({
                    ...s,
                    roles: s.roles || [],
                    key: s.key || false,
                    onetId: s.onetId || null
                })),
                roles: (wizardState.parsedData?.roles || []).map((r, i) => ({
                    id: r.id || `role${i+1}`,
                    name: r.name || r.company || `Role ${i+1}`,
                    color: ['#ef4444','#f97316','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899'][i % 7]
                })),
                values: wizardState.values,
                purpose: wizardState.purpose,
                preferences: { seniorityLevel: 'Senior', minimumMatchScore: 60, minimumSkillMatches: 3 },
                applications: []
            };
        }

        function wizardDownloadAndLaunch() {
            const built = wizardBuildUserData();
            // Download JSON
            const blob = new Blob([JSON.stringify(built, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `blueprint-${(built.profile.name || 'profile').toLowerCase().replace(/\s+/g,'-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            // Apply and launch
            wizardApplyAndLaunch(built);
        }

        function wizardLaunchOnly() {
            wizardApplyAndLaunch(wizardBuildUserData());
        }

        function wizardApplyAndLaunch(built) {
            userData = built;
            userData.initialized = true;
            localStorage.setItem('currentProfile', 'wizard-built');

            // Store wizard profile in templates so it loads on reload
            templates['wizard-built'] = built;

            // Save to Firestore if signed in
            if (fbUser && fbDb) {
                saveToFirestore();
                showToast('Profile saved to your account.', 'success');
            } else {
                // Prompt to sign in so data persists
                showToast('Sign in to save your profile permanently.', 'info');
            }

            closeWizard();
            // Re-initialize the app with new data
            skillsData.skills = userData.skills || [];
            skillsData.roles = userData.roles || [];
            skillsData.skillDetails = {};
            renderFilterChips();
            updateProfileChip(userData.profile.name || 'My Profile');
            // Reset tab initialization flags so they re-render with new data
            window.blueprintInitialized = false;
            window.opportunitiesInitialized = false;
            window.applicationsInitialized = false;
            window.consentInitialized = false;
            window.networkInitialized = false;
            window.cardViewInitialized = false;
            // Network will re-init when user navigates to Skills tab (lazy init)
            switchView('network');
        }
        
        // Initialize main app with user data
        function initializeMainApp() {
            // Replace skillsData with userData
            skillsData.skills = userData.skills || [];
            skillsData.roles = userData.roles || skillsData.roles;
            skillsData.skillDetails = userData.skillDetails || {};

        // Expose wizard and nav functions to global scope for onclick handlers
        window.showOnboardingWizard = showOnboardingWizard;
        window.wizardChooseUpload = wizardChooseUpload;
        window.wizardChooseManual = wizardChooseManual;
        window.wizardChooseImport = wizardChooseImport;
        window.wizardImportProfile = wizardImportProfile;
        window.wizardBack = wizardBack;
        window.wizardNext = wizardNext;
        window.wizardSetResumeTab = wizardSetResumeTab;
        window.wizardSkipParsing = wizardSkipParsing;
        window.wizardStartParsing = wizardStartParsing;
        window.wizardSaveProfile = wizardSaveProfile;
        window.wizardSaveSkills = wizardSaveSkills;
        window.wizardToggleValue = wizardToggleValue;
        window.wizardSaveValues = wizardSaveValues;
        window.wizardSavePurpose = wizardSavePurpose;
        window.wizardRegeneratePurpose = wizardRegeneratePurpose;
        window.wizardDownloadAndLaunch = wizardDownloadAndLaunch;
        window.wizardLaunchOnly = wizardLaunchOnly;
        window.confirmExitWizard = confirmExitWizard;
        window.toggleFilterPanel = toggleFilterPanel;
        window.renderFilterChips = renderFilterChips;

            // Render dynamic filter chips from profile data
            renderFilterChips();

            // Show mobile nav on small screens
            if (window.innerWidth <= 768) {
                const mobileNav = document.getElementById('mobileNav');
                if (mobileNav) mobileNav.style.display = 'flex';
            }
            
            console.log('✓ Main app initialized with', userData.skills.length, 'skills');
        }
        
        // Export current profile
        
        // ===== END v2.0 USER DATA MANAGEMENT =====
        
        // Load skill evidence dynamically
        fetch('skill_evidence.json')
            .then(response => response.json())
            .then(data => {
                skillsData.skillDetails = data;
                console.log('✓ Loaded evidence for', Object.keys(data).length, 'skills');
            })
            .catch(error => console.error('Error loading skill evidence:', error));

        const levelColors = {
            "Mastery":    "#ef4444",
            "Expert":     "#f97316",
            "Advanced":   "#f59e0b",
            "Proficient": "#10b981",
            "Novice":     "#6b7280"
        };

        let currentView = 'network';
        let activeRole = 'all';
        let activeLevel = null;
        let simulation;
        
        // Job overlay state
        let networkMatchMode = 'you'; // 'you' | 'job' | 'match'
        let activeJobForNetwork = null; // saved job object when overlay is active

        function initNetwork() {
            const width = window.innerWidth;
            const height = window.innerHeight - 160;
            const isMobile = width <= 768;
            
            const svg = d3.select("#networkView")
                .attr("width", width)
                .attr("height", height);

            svg.selectAll("*").remove();

            // Create nodes
            const nodes = [
                { id: "center", name: userData.profile.name || "You", type: "center", x: width/2, y: height/2, fx: width/2, fy: height/2 }
            ];

            // Add role nodes
            skillsData.roles.forEach((role, i) => {
                const angle = (i / skillsData.roles.length) * 2 * Math.PI;
                const radius = isMobile ? 120 : 200;
                nodes.push({
                    id: role.id,
                    name: role.name,
                    type: "role",
                    color: role.color,
                    x: width/2 + Math.cos(angle) * radius,
                    y: height/2 + Math.sin(angle) * radius
                });
            });

            // Add skill nodes — on mobile, only key/top skills to reduce clutter
            var skillsToShow = skillsData.skills;
            if (isMobile) {
                var keySkills = skillsData.skills.filter(function(s) { return s.key; });
                var topLevelSkills = skillsData.skills.filter(function(s) { return s.level === 'Mastery' || s.level === 'Expert'; });
                // Merge key + top-level, deduplicate, cap at 25
                var seen = new Set();
                skillsToShow = [];
                keySkills.concat(topLevelSkills).forEach(function(s) {
                    if (!seen.has(s.name) && skillsToShow.length < 25) {
                        seen.add(s.name);
                        skillsToShow.push(s);
                    }
                });
                // If still too few, backfill with Advanced
                if (skillsToShow.length < 15) {
                    skillsData.skills.filter(function(s) { return s.level === 'Advanced' && !seen.has(s.name); })
                        .slice(0, 25 - skillsToShow.length)
                        .forEach(function(s) { skillsToShow.push(s); seen.add(s.name); });
                }
            }

            skillsToShow.forEach((skill, i) => {
                nodes.push({
                    id: `skill-${i}`,
                    name: skill.name,
                    type: "skill",
                    level: skill.level,
                    roles: skill.roles,
                    key: skill.key
                });
            });

            // Create links
            const links = [];
            
            // Center to roles
            skillsData.roles.forEach(role => {
                links.push({ source: "center", target: role.id, type: "role" });
            });

            // Roles to skills
            skillsToShow.forEach((skill, i) => {
                skill.roles.forEach(roleId => {
                    links.push({ 
                        source: roleId, 
                        target: `skill-${i}`,
                        type: "skill"
                    });
                });
            });

            // Create simulation with mobile-adjusted forces
            var linkDist = isMobile ? [90, 100] : [140, 160];
            var chargeStr = isMobile ? [-200, -120] : [-250, -180];
            var collisionR = isMobile ? [50, 45, 35] : [70, 65, 45];
            
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.type === "role") return linkDist[0];
                    return linkDist[1];
                }))
                .force("charge", d3.forceManyBody().strength(d => {
                    if (d.type === "center") return 0;
                    if (d.type === "role") return chargeStr[0];
                    return chargeStr[1];
                }))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(d => {
                    if (d.type === "center") return collisionR[0];
                    if (d.type === "role") return collisionR[1];
                    return collisionR[2];
                }))
                .force("x", d3.forceX(width / 2).strength(isMobile ? 0.12 : 0.08))
                .force("y", d3.forceY(height / 2).strength(isMobile ? 0.12 : 0.08))
                .force("radial", d3.forceRadial(d => {
                    if (d.type === "skill") return Math.min(width, height) * (isMobile ? 0.35 : 0.4);
                    return 0;
                }).strength(isMobile ? 0.15 : 0.1));

            // Draw links
            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link");

            // Draw nodes
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", d => `node ${d.type}`)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("r", d => {
                    if (d.type === "center") return isMobile ? 30 : 40;
                    if (d.type === "role") return isMobile ? 24 : 30;
                    return d.key ? (isMobile ? 14 : 12) : (isMobile ? 10 : 8);
                })
                .attr("fill", d => {
                    if (d.type === "center") return "#60a5fa";
                    if (d.type === "role") return d.color;
                    return levelColors[d.level];
                })
                .on("click", (event, d) => {
                    if (d.type === "center") {
                        // Center node click resets to show all
                        filterByRole('all');
                    } else if (d.type === "role") {
                        // Toggle: click active role again to reset
                        if (activeRole === d.id) {
                            filterByRole('all');
                        } else {
                            filterByRole(d.id);
                        }
                    } else if (d.type === "skill") {
                        event.stopPropagation();
                        // Look up full skill object from skillsData instead of using node data
                        const fullSkill = skillsData.skills.find(s => s.name === d.name);
                        if (fullSkill) {
                            openSkillModal(d.name, fullSkill);
                        } else {
                            console.error('Skill not found in skillsData:', d.name);
                        }
                    }
                })
                .style("cursor", d => (d.type === "center" || d.type === "role" || d.type === "skill") ? "pointer" : "default")
                .on("mouseover", (event, d) => showTooltip(event, d))
                .on("mouseout", hideTooltip);

            node.append("text")
                .each(function(d) {
                    if (d.type === 'skill') {
                        // Split long skill names into multiple lines
                        const words = d.name.split(' ');
                        const maxWidth = 15; // characters per line
                        let lines = [];
                        let currentLine = '';
                        
                        words.forEach(word => {
                            if ((currentLine + ' ' + word).length > maxWidth && currentLine.length > 0) {
                                lines.push(currentLine);
                                currentLine = word;
                            } else {
                                currentLine = currentLine ? currentLine + ' ' + word : word;
                            }
                        });
                        if (currentLine) lines.push(currentLine);
                        
                        // Create tspan for each line
                        const text = d3.select(this);
                        lines.forEach((line, i) => {
                            text.append('tspan')
                                .text(line)
                                .attr('x', 0)
                                .attr('dy', i === 0 ? -13 - (lines.length - 1) * 5 : 10)
                                .attr('text-anchor', 'middle');
                        });
                    } else {
                        // Single line for center and role nodes
                        d3.select(this)
                            .text(d.name)
                            .attr("x", 0)
                            .attr("y", d => {
                                if (d.type === "center") return -45;
                                if (d.type === "role") return -35;
                                return -13;
                            })
                            .attr("text-anchor", "middle");
                    }
                });

            simulation.on("tick", () => {
                // Constrain nodes to viewport with padding
                const padding = isMobile ? 60 : 100;
                nodes.forEach(d => {
                    if (d.type !== "center") {  // Don't constrain center node
                        d.x = Math.max(padding, Math.min(width - padding, d.x));
                        d.y = Math.max(padding, Math.min(height - padding, d.y));
                    }
                });
                
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });

            window.networkData = { nodes, links, svg, link, node };
            
            // On mobile: hide skill labels by default (too cluttered), show role labels
            if (isMobile) {
                node.selectAll('text').filter(d => d.type === 'skill').classed('hidden', true);
                // Uncheck the skill labels checkbox
                var skillLabelCb = document.querySelector('#networkControls input[onchange*="skill"]');
                if (skillLabelCb) skillLabelCb.checked = false;
                
                // Add info badge showing filtered count
                if (skillsToShow.length < skillsData.skills.length) {
                    var existing = document.getElementById('mobileNetworkBadge');
                    if (existing) existing.remove();
                    var badge = document.createElement('div');
                    badge.id = 'mobileNetworkBadge';
                    badge.style.cssText = 'position:absolute; bottom:12px; left:50%; transform:translateX(-50%); '
                        + 'background:rgba(30,64,175,0.8); color:#e0e0e0; font-size:0.72em; padding:5px 14px; '
                        + 'border-radius:20px; backdrop-filter:blur(8px); pointer-events:none; z-index:10;';
                    badge.textContent = 'Showing top ' + skillsToShow.length + ' of ' + skillsData.skills.length + ' skills';
                    var container = document.getElementById('networkView').parentElement;
                    if (container) { container.style.position = 'relative'; container.appendChild(badge); }
                }
            }
        }

        // ===== NETWORK OVERLAY ENGINE (Phase 2) =====
        
        function activateJobOverlay(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job) { showToast('Job not found.', 'error'); return; }
            
            activeJobForNetwork = job;
            networkMatchMode = 'match'; // Start on the overlay view
            
            // Switch to network view if not already there
            currentSkillsView = 'network';
            switchView('network');
            
            // Show the toggle and badge
            updateMatchOverlayUI();
            
            // Render the match network
            setNetworkMatchMode('match');
        }
        window.activateJobOverlay = activateJobOverlay;
        
        function clearJobOverlay() {
            activeJobForNetwork = null;
            networkMatchMode = 'you';
            
            // Hide toggle and badge
            var toggle = document.getElementById('matchModeToggle');
            var badge = document.getElementById('matchActiveBadge');
            if (toggle) toggle.style.display = 'none';
            if (badge) badge.style.display = 'none';
            
            // Remove legend
            var legend = document.getElementById('matchLegend');
            if (legend) legend.remove();
            
            // Re-render normal network
            window.networkInitialized = false;
            initNetwork();
            window.networkInitialized = true;
        }
        window.clearJobOverlay = clearJobOverlay;
        
        function updateMatchOverlayUI() {
            var toggle = document.getElementById('matchModeToggle');
            var badge = document.getElementById('matchActiveBadge');
            var titleEl = document.getElementById('matchActiveTitle');
            
            if (!activeJobForNetwork) {
                if (toggle) toggle.style.display = 'none';
                if (badge) badge.style.display = 'none';
                return;
            }
            
            if (toggle) toggle.style.display = 'inline-flex';
            if (badge) badge.style.display = 'inline-flex';
            if (titleEl) {
                var t = activeJobForNetwork.title || 'Job';
                titleEl.textContent = t.length > 25 ? t.substring(0, 24) + '\u2026' : t;
            }
            
            // Update active mode button
            document.querySelectorAll('.match-mode-btn').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.mode === networkMatchMode);
            });
        }
        
        function setNetworkMatchMode(mode) {
            networkMatchMode = mode;
            updateMatchOverlayUI();
            
            // Remove any existing legend
            var legend = document.getElementById('matchLegend');
            if (legend) legend.remove();
            
            if (mode === 'you') {
                // Standard network
                window.networkInitialized = false;
                initNetwork();
                window.networkInitialized = true;
            } else if (mode === 'job') {
                initJobNetwork(activeJobForNetwork);
            } else if (mode === 'match') {
                initMatchNetwork(activeJobForNetwork);
            }
        }
        window.setNetworkMatchMode = setNetworkMatchMode;
        
        // ===== JOB-ONLY NETWORK =====
        
        function initJobNetwork(job) {
            if (!job || !job.parsedSkills) return;
            
            var width = window.innerWidth;
            var height = window.innerHeight - 160;
            var isMobile = width <= 768;
            
            var svg = d3.select("#networkView")
                .attr("width", width)
                .attr("height", height);
            svg.selectAll("*").remove();
            if (simulation) simulation.stop();
            
            // Center node = the job title
            var nodes = [
                { id: "center", name: job.title || "Job", type: "center", x: width/2, y: height/2, fx: width/2, fy: height/2 }
            ];
            
            // Group job skills by category into roles
            var categoryMap = {};
            var roleColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#a855f7', '#ec4899', '#06b6d4', '#84cc16'];
            job.parsedSkills.forEach(function(s) {
                var cat = s.category || 'General';
                if (!categoryMap[cat]) categoryMap[cat] = [];
                categoryMap[cat].push(s);
            });
            
            var categories = Object.keys(categoryMap);
            categories.forEach(function(cat, i) {
                var angle = (i / categories.length) * 2 * Math.PI;
                var radius = isMobile ? 100 : 170;
                nodes.push({
                    id: 'role-' + cat,
                    name: cat,
                    type: 'role',
                    color: roleColors[i % roleColors.length],
                    x: width/2 + Math.cos(angle) * radius,
                    y: height/2 + Math.sin(angle) * radius
                });
            });
            
            // Skill nodes
            var allSkills = [];
            categories.forEach(function(cat) {
                categoryMap[cat].forEach(function(s) { allSkills.push({ skill: s, cat: cat }); });
            });
            
            // Cap for mobile
            var skillsToRender = isMobile ? allSkills.slice(0, 25) : allSkills;
            
            skillsToRender.forEach(function(entry, i) {
                var isRequired = entry.skill.level === 'Required';
                nodes.push({
                    id: 'jskill-' + i,
                    name: entry.skill.name,
                    type: 'skill',
                    level: entry.skill.level,
                    category: entry.cat,
                    required: isRequired
                });
            });
            
            // Links
            var links = [];
            categories.forEach(function(cat) { links.push({ source: 'center', target: 'role-' + cat, type: 'role' }); });
            skillsToRender.forEach(function(entry, i) { links.push({ source: 'role-' + entry.cat, target: 'jskill-' + i, type: 'skill' }); });
            
            // Simulation
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(function(d) { return d.id; }).distance(function(d) { return d.type === 'role' ? (isMobile ? 80 : 130) : (isMobile ? 90 : 140); }))
                .force("charge", d3.forceManyBody().strength(function(d) { return d.type === 'center' ? 0 : d.type === 'role' ? -200 : -100; }))
                .force("center", d3.forceCenter(width/2, height/2))
                .force("collision", d3.forceCollide().radius(function(d) { return d.type === 'center' ? 50 : d.type === 'role' ? 40 : 28; }))
                .force("x", d3.forceX(width/2).strength(0.1))
                .force("y", d3.forceY(height/2).strength(0.1));
            
            // Draw
            var link = svg.append("g").selectAll("line").data(links).join("line")
                .attr("class", "link").style("stroke-opacity", 0.2);
            
            var node = svg.append("g").selectAll("g").data(nodes).join("g")
                .attr("class", function(d) { return 'node ' + d.type; })
                .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));
            
            node.append("circle")
                .attr("r", function(d) {
                    if (d.type === 'center') return isMobile ? 28 : 36;
                    if (d.type === 'role') return isMobile ? 20 : 26;
                    return d.required ? 12 : 9;
                })
                .attr("fill", function(d) {
                    if (d.type === 'center') return '#f59e0b';
                    if (d.type === 'role') return d.color;
                    return d.required ? '#ef4444' : '#f97316';
                })
                .attr("stroke", function(d) { return d.required ? '#fff' : 'none'; })
                .attr("stroke-width", function(d) { return d.required ? 2 : 0; });
            
            node.append("text")
                .text(function(d) { return d.name; })
                .attr("x", 0)
                .attr("y", function(d) { return d.type === 'center' ? -42 : d.type === 'role' ? -30 : -14; })
                .attr("text-anchor", "middle")
                .style("font-size", function(d) { return d.type === 'center' ? '14px' : d.type === 'role' ? '11px' : '9px'; });
            
            if (isMobile) node.selectAll('text').filter(function(d) { return d.type === 'skill'; }).classed('hidden', true);
            
            simulation.on("tick", function() {
                var padding = isMobile ? 50 : 80;
                nodes.forEach(function(d) { if (d.type !== 'center') { d.x = Math.max(padding, Math.min(width - padding, d.x)); d.y = Math.max(padding, Math.min(height - padding, d.y)); } });
                link.attr("x1", function(d) { return d.source.x; }).attr("y1", function(d) { return d.source.y; }).attr("x2", function(d) { return d.target.x; }).attr("y2", function(d) { return d.target.y; });
                node.attr("transform", function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
            });
        }
        
        // ===== MATCH OVERLAY NETWORK =====
        
        function initMatchNetwork(job) {
            if (!job || !job.matchData) return;
            
            var width = window.innerWidth;
            var height = window.innerHeight - 160;
            var isMobile = width <= 768;
            var match = job.matchData;
            
            var svg = d3.select("#networkView")
                .attr("width", width)
                .attr("height", height);
            svg.selectAll("*").remove();
            if (simulation) simulation.stop();
            
            // Build lookup sets for classification
            var matchedUserSkills = new Set();
            var matchedJobSkills = new Set();
            (match.matched || []).forEach(function(m) {
                matchedUserSkills.add(m.userSkill.toLowerCase());
                matchedJobSkills.add(m.jobSkill.toLowerCase());
            });
            var gapSkills = new Set();
            (match.gaps || []).forEach(function(g) { gapSkills.add(g.name.toLowerCase()); });
            
            // Center node
            var nodes = [
                { id: "center", name: userData.profile.name || "You", type: "center", matchState: 'center', x: width/2, y: height/2, fx: width/2, fy: height/2 }
            ];
            
            // Use the user's actual roles
            skillsData.roles.forEach(function(role, i) {
                var angle = (i / skillsData.roles.length) * 2 * Math.PI;
                var radius = isMobile ? 110 : 180;
                nodes.push({
                    id: role.id, name: role.name, type: 'role', color: role.color, matchState: 'role',
                    x: width/2 + Math.cos(angle) * radius, y: height/2 + Math.sin(angle) * radius
                });
            });
            
            // Add a "job requirements" pseudo-role
            var jobRoleAngle = Math.PI; // Put it opposite
            var jobRoleRadius = isMobile ? 130 : 200;
            nodes.push({
                id: 'role-job-req', name: (job.title || 'Job') + ' Needs', type: 'role', color: '#ef4444', matchState: 'role',
                x: width/2 + Math.cos(jobRoleAngle) * jobRoleRadius,
                y: height/2 + Math.sin(jobRoleAngle) * jobRoleRadius
            });
            
            var links = [];
            var nodeIdx = 0;
            
            // Center → user roles
            skillsData.roles.forEach(function(role) { links.push({ source: 'center', target: role.id, type: 'role' }); });
            // Center → job req role
            links.push({ source: 'center', target: 'role-job-req', type: 'role' });
            
            // User skills with match state
            var userSkillsToShow = isMobile
                ? skillsData.skills.filter(function(s) { return s.key || matchedUserSkills.has(s.name.toLowerCase()) || s.level === 'Mastery' || s.level === 'Expert'; }).slice(0, 30)
                : skillsData.skills;
            
            userSkillsToShow.forEach(function(skill) {
                var isMatched = matchedUserSkills.has(skill.name.toLowerCase());
                var state = isMatched ? 'matched' : 'surplus';
                var id = 'u-' + nodeIdx++;
                nodes.push({
                    id: id, name: skill.name, type: 'skill', level: skill.level, key: skill.key,
                    matchState: state, roles: skill.roles, source: 'user'
                });
                // Link to user roles
                (skill.roles || []).forEach(function(roleId) {
                    links.push({ source: roleId, target: id, type: 'skill' });
                });
                // Matched skills also link to job req
                if (isMatched) {
                    links.push({ source: 'role-job-req', target: id, type: 'match' });
                }
            });
            
            // Gap skills (job needs, user doesn't have)
            (match.gaps || []).forEach(function(gap) {
                // Cap gaps on mobile
                if (isMobile && nodeIdx > 40) return;
                var id = 'g-' + nodeIdx++;
                nodes.push({
                    id: id, name: gap.name, type: 'skill', level: gap.level || 'Required',
                    matchState: 'gap', source: 'job'
                });
                links.push({ source: 'role-job-req', target: id, type: 'skill' });
            });
            
            // Color scheme
            var matchColors = {
                matched: '#10b981', // green
                gap: '#ef4444',     // red
                surplus: '#475569'  // slate grey (dimmed)
            };
            
            // Simulation
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(function(d) { return d.id; }).distance(function(d) {
                    if (d.type === 'role') return isMobile ? 90 : 150;
                    if (d.type === 'match') return isMobile ? 60 : 100; // matched skills pulled between both
                    return isMobile ? 80 : 130;
                }))
                .force("charge", d3.forceManyBody().strength(function(d) {
                    if (d.type === 'center') return 0;
                    if (d.type === 'role') return isMobile ? -180 : -250;
                    if (d.matchState === 'gap') return isMobile ? -80 : -120;
                    return isMobile ? -100 : -150;
                }))
                .force("center", d3.forceCenter(width/2, height/2))
                .force("collision", d3.forceCollide().radius(function(d) {
                    if (d.type === 'center') return isMobile ? 40 : 55;
                    if (d.type === 'role') return isMobile ? 35 : 50;
                    return isMobile ? 22 : 30;
                }))
                .force("x", d3.forceX(width/2).strength(0.08))
                .force("y", d3.forceY(height/2).strength(0.08));
            
            // Draw links
            var link = svg.append("g").selectAll("line").data(links).join("line")
                .attr("class", "link")
                .style("stroke", function(d) { return d.type === 'match' ? matchColors.matched : undefined; })
                .style("stroke-opacity", function(d) { return d.type === 'match' ? 0.5 : 0.2; })
                .style("stroke-width", function(d) { return d.type === 'match' ? 2 : 1.5; })
                .style("stroke-dasharray", function(d) { return d.type === 'match' ? '4,3' : 'none'; });
            
            // Draw nodes
            var node = svg.append("g").selectAll("g").data(nodes).join("g")
                .attr("class", function(d) { return 'node ' + d.type; })
                .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));
            
            node.append("circle")
                .attr("r", function(d) {
                    if (d.type === 'center') return isMobile ? 28 : 38;
                    if (d.type === 'role') return isMobile ? 22 : 28;
                    if (d.matchState === 'matched') return isMobile ? 12 : 14;
                    if (d.matchState === 'gap') return isMobile ? 10 : 12;
                    return isMobile ? 7 : 8; // surplus
                })
                .attr("fill", function(d) {
                    if (d.type === 'center') return '#60a5fa';
                    if (d.type === 'role') return d.color;
                    return matchColors[d.matchState] || '#6b7280';
                })
                .attr("opacity", function(d) {
                    if (d.matchState === 'surplus') return 0.35;
                    return 1;
                })
                .attr("stroke", function(d) {
                    if (d.matchState === 'matched') return '#fff';
                    if (d.matchState === 'gap') return '#fca5a5';
                    return 'none';
                })
                .attr("stroke-width", function(d) {
                    if (d.matchState === 'matched' || d.matchState === 'gap') return 2;
                    return 0;
                })
                .on("click", function(event, d) {
                    if (d.type === 'skill' && d.source === 'user') {
                        var fullSkill = skillsData.skills.find(function(s) { return s.name === d.name; });
                        if (fullSkill) openSkillModal(d.name, fullSkill);
                    }
                })
                .on("mouseover", function(event, d) { showTooltip(event, d); })
                .on("mouseout", hideTooltip);
            
            // Labels
            node.append("text")
                .text(function(d) { return d.name; })
                .attr("x", 0)
                .attr("y", function(d) { return d.type === 'center' ? -44 : d.type === 'role' ? -34 : -16; })
                .attr("text-anchor", "middle")
                .style("font-size", function(d) { return d.type === 'center' ? '14px' : d.type === 'role' ? '11px' : '9px'; })
                .style("fill", function(d) {
                    if (d.matchState === 'matched') return matchColors.matched;
                    if (d.matchState === 'gap') return matchColors.gap;
                    if (d.matchState === 'surplus') return '#64748b';
                    return undefined;
                })
                .style("opacity", function(d) { return d.matchState === 'surplus' ? 0.4 : 1; });
            
            // On mobile hide skill labels
            if (isMobile) node.selectAll('text').filter(function(d) { return d.type === 'skill'; }).classed('hidden', true);
            
            // Tick
            simulation.on("tick", function() {
                var padding = isMobile ? 50 : 80;
                nodes.forEach(function(d) { if (d.type !== 'center') { d.x = Math.max(padding, Math.min(width - padding, d.x)); d.y = Math.max(padding, Math.min(height - padding, d.y)); } });
                link.attr("x1", function(d) { return d.source.x; }).attr("y1", function(d) { return d.source.y; }).attr("x2", function(d) { return d.target.x; }).attr("y2", function(d) { return d.target.y; });
                node.attr("transform", function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
            });
            
            // Add legend
            addMatchLegend(match);
        }
        
        function addMatchLegend(match) {
            var existing = document.getElementById('matchLegend');
            if (existing) existing.remove();
            
            var matchCount = (match.matched || []).length;
            var gapCount = (match.gaps || []).length;
            var surplusCount = (match.surplus || []).length;
            
            var legend = document.createElement('div');
            legend.id = 'matchLegend';
            legend.className = 'match-legend';
            legend.innerHTML = '<div class="match-legend-item"><div class="match-legend-dot" style="background:#10b981;"></div> Matched (' + matchCount + ')</div>'
                + '<div class="match-legend-item"><div class="match-legend-dot" style="background:#ef4444;"></div> Gaps (' + gapCount + ')</div>'
                + '<div class="match-legend-item"><div class="match-legend-dot" style="background:#475569; opacity:0.5;"></div> Surplus (' + surplusCount + ')</div>'
                + '<div class="match-legend-item" style="font-weight:700; color:' + (match.score >= 70 ? '#10b981' : match.score >= 45 ? '#f59e0b' : '#6b7280') + ';">' + match.score + '%</div>';
            
            var container = document.getElementById('networkView').parentElement;
            if (container) { container.style.position = 'relative'; container.appendChild(legend); }
        }

        function initCardView() {
            const cardView = document.getElementById('cardView');

            // ── Dynamic domain grouping — works for ANY profile ──────────────
            // Strategy: group by role first (uses the profile's own role names),
            // then fall back to O*NET category, then "Other Skills" catch-all.

            const roleIconMap = {
                // Common role name patterns → icon
                'strategy': '🎯', 'vp': '🎯', 'director': '🎯', 'executive': '🎯', 'chief': '🎯',
                'technology': '⚙️', 'engineer': '⚙️', 'developer': '⚙️', 'tech': '⚙️', 'software': '⚙️',
                'product': '📦', 'manager': '📦',
                'data': '🔬', 'analyst': '🔬', 'research': '🔬', 'science': '🔬',
                'design': '🎨', 'creative': '🎨', 'ux': '🎨', 'artist': '🎨',
                'marketing': '📣', 'communication': '📣', 'sales': '📣', 'content': '📣',
                'hr': '👥', 'talent': '👥', 'people': '👥', 'recruiting': '👥',
                'finance': '💰', 'accounting': '💰', 'operations': '💰',
                'pilot': '✈️', 'aviation': '✈️', 'flight': '✈️',
                'music': '🎵', 'musician': '🎵', 'performer': '🎵', 'artist': '🎵',
                'advocate': '💚', 'nonprofit': '💚', 'community': '💚',
                'futurist': '🔮', 'innovation': '🔮', 'evangelist': '🔮',
                'entrepreneur': '🚀', 'founder': '🚀', 'startup': '🚀',
                'consultant': '💼', 'advisor': '💼',
            };

            const categoryMeta = {
                'skill':      { label: 'Skills',       icon: '🗺️' },
                'ability':    { label: 'Abilities',     icon: '⚡' },
                'workstyle':  { label: 'Work Style',    icon: '🧭' },
                'unique':     { label: 'Unique Strengths', icon: '⭐' },
            };

            function getRoleIcon(roleName) {
                const lower = (roleName || '').toLowerCase();
                for (const [keyword, icon] of Object.entries(roleIconMap)) {
                    if (lower.includes(keyword)) return icon;
                }
                return '💼';
            }

            const domains = {};

            // Build role-based domains from the profile's actual roles
            const profileRoles = skillsData.roles || userData.roles || [];
            profileRoles.forEach(role => {
                domains[role.id] = {
                    label: role.name,
                    icon: getRoleIcon(role.name),
                    color: role.color,
                    skills: []
                };
            });

            // Catch-all domains for skills without a role or for category fallback
            const uncategorized = { label: 'Other Skills', icon: '🗺️', skills: [] };

            // Level priority for sorting within domains
            const levelPriority = { Mastery: 5, Expert: 4, Advanced: 3, Proficient: 2, Novice: 1 };

            // Assign each skill to its primary role domain, or uncategorized
            skillsData.skills.forEach(skill => {
                const skillRoles = skill.roles || [];
                if (skillRoles.length > 0 && domains[skillRoles[0]]) {
                    domains[skillRoles[0]].skills.push(skill);
                } else if (skillRoles.length > 1) {
                    // Try second role
                    const secondRole = skillRoles.find(r => domains[r]);
                    if (secondRole) {
                        domains[secondRole].skills.push(skill);
                    } else {
                        uncategorized.skills.push(skill);
                    }
                } else {
                    uncategorized.skills.push(skill);
                }
            });

            // Decide grouping strategy
            const totalInRoles = Object.values(domains).reduce((n, d) => n + d.skills.length, 0);
            const totalSkills = skillsData.skills.length;
            const finalDomains = {};

            if (totalSkills === 0) {
                // No skills — nothing to show
            } else if (totalInRoles >= totalSkills * 0.5) {
                // Good role coverage (50%+) — use role-based grouping
                Object.entries(domains).forEach(([id, d]) => {
                    if (d.skills.length > 0) finalDomains[id] = d;
                });
                // Add any uncategorized skills under their category
                if (uncategorized.skills.length > 0) {
                    // Sub-bucket uncategorized by O*NET category rather than one big pile
                    uncategorized.skills.forEach(skill => {
                        const cat = skill.category || 'skill';
                        const meta = categoryMeta[cat] || categoryMeta['skill'];
                        const key = '__cat_' + cat;
                        if (!finalDomains[key]) {
                            finalDomains[key] = { label: meta.label, icon: meta.icon, skills: [] };
                        }
                        finalDomains[key].skills.push(skill);
                    });
                }
            } else {
                // Poor role coverage — group everything by O*NET category
                // This handles profiles where skills lack role assignments
                skillsData.skills.forEach(skill => {
                    const cat = skill.category || 'skill';
                    const meta = categoryMeta[cat] || categoryMeta['skill'];
                    if (!finalDomains[cat]) {
                        finalDomains[cat] = { label: meta.label, icon: meta.icon, skills: [] };
                    }
                    finalDomains[cat].skills.push(skill);
                });
            }
            
            // Sort skills within each domain: key/core first, then by level
            Object.values(finalDomains).forEach(d => {
                d.skills.sort((a, b) => {
                    if (a.key && !b.key) return -1;
                    if (!a.key && b.key) return 1;
                    return (levelPriority[b.level] || 0) - (levelPriority[a.level] || 0);
                });
            });

            let html = '<div class="cards-grid">';
            
            Object.entries(finalDomains).forEach(([domainKey, data]) => {
                if (data.skills.length === 0) return;
                const domainTitle = data.label || domainKey;
                
                html += `
                    <div class="domain-card">
                        <div class="domain-header">
                            <span class="domain-icon">${data.icon}</span>
                            <span class="domain-title">${domainTitle}</span>
                        </div>
                        <div class="skills-list">
                `;
                
                data.skills.forEach(skill => {
                    const levelClass = skill.level.toLowerCase();
                    const keyBadge = skill.key ? '<span class="skill-badge">CORE</span>' : '';
                    const rolesList = skill.roles.map(roleId => {
                        const role = skillsData.roles.find(r => r.id === roleId);
                        return role ? role.name : roleId;
                    }).join(', ');
                    
                    // Get years of experience from skillDetails
                    const details = skillsData.skillDetails && skillsData.skillDetails[skill.name];
                    const years = details && details.years ? details.years + ' yrs' : '';
                    const yearsBadge = years ? `<span class="skill-years">${years}</span>` : '';
                    
                    // Get market impact rating (instead of dollar value)
                    const skillImpact = calculateSkillValue(skill);
                    const impactColor = getImpactColor(skillImpact.level);
                    const impactBadge = `<span class="skill-impact-badge" style="background: rgba(${impactColor === '#ef4444' ? '239, 68, 68' : impactColor === '#f59e0b' ? '245, 158, 11' : impactColor === '#3b82f6' ? '59, 130, 246' : '107, 114, 128'}, 0.2); color: ${impactColor}; font-size: 0.7em; padding: 3px 8px; border-radius: 3px; font-weight: 600; white-space: nowrap;">${skillImpact.icon} ${skillImpact.label.toUpperCase()}</span>`;
                    
                    // Category badge for all O*NET types + Unique
                    let categoryBadge = '';
                    if (skill.category === 'skill') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">SKILL</span>';
                    } else if (skill.category === 'ability') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(139, 92, 246, 0.2); color: #a78bfa; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">ABILITY</span>';
                    } else if (skill.category === 'workstyle') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">WORK STYLE</span>';
                    } else if (skill.category === 'unique') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">UNIQUE</span>';
                    }
                    
                    html += `
                        <div class="skill-item ${levelClass}" title="${rolesList}" onclick='openSkillModalFromCard("${skill.name.replace(/'/g, "\\'")}")' style="cursor: pointer;">
                            <div class="skill-dot" style="background: ${levelColors[skill.level]}"></div>
                            <span class="skill-name">${skill.name}</span>
                            ${categoryBadge}
                            ${yearsBadge}
                            ${keyBadge}
                            ${impactBadge}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            cardView.innerHTML = html;
        }

        let currentSkillsView = 'network'; // Track whether showing network or card within Skills Ontology
        
        // Initialize user interface on load
        document.addEventListener('DOMContentLoaded', async () => {
            // v4.0: Check for magic link sign-in first
            checkMagicLinkSignIn();
            
            // Wait for auth state to resolve
            await authReadyPromise;
            
            // Initialize app and get target view
            var targetView = await initializeApp();
            
            // If user has profile, set up UI
            if (userData.initialized) {
                // Update profile chip with loaded user's name
                if (userData.profile.name) {
                    updateProfileChip(userData.profile.name);
                }
                
                // Pre-initialize card view data (doesn't display it)
                initCardView();
                
                // Auto-save every 60 seconds (Firestore + localStorage)
                setInterval(() => {
                    saveUserData();
                    if (fbUser && fbDb) saveToFirestore();
                }, 60000);
            }
            
            // Navigate to the target view
            if (targetView === 'welcome') {
                switchView('welcome');
            } else if (targetView === 'blueprint') {
                switchView('blueprint');
            } else {
                // Default: show skills (lazy-init handles network rendering)
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    currentSkillsView = 'card';
                }
                switchView('network');
            }
            
            // Final deferred dropdown rebuild - guarantees manifest + auth are both resolved
            setTimeout(function() { rebuildProfileDropdown(); }, 500);
        }); // Close DOMContentLoaded
        
        var _skipHistoryPush = false;
        function switchView(view, event) {
            // Map new view names to existing views
            if (view === 'skills') view = 'network';
            if (view === 'jobs') view = 'opportunities';
            
            currentView = view;
            window.scrollTo(0, 0);
            
            // Push browser history (skip if triggered by popstate)
            if (!_skipHistoryPush) {
                history.pushState({ view: view }, '', '#' + view);
            }
            // Update nav button active state
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const navMap = { network: 'nav-skills', skills: 'nav-skills', opportunities: 'nav-jobs', jobs: 'nav-jobs', applications: 'nav-applications', blueprint: 'nav-blueprint' };
            const navId = navMap[view] || navMap[currentView];
            if (navId) { const nb = document.getElementById(navId); if (nb) nb.classList.add('active'); }
            
            const networkControls = document.getElementById('networkControls');
            const skillsViewToggle = document.getElementById('skillsViewToggle');
            const controls = document.querySelector('.controls');
            
            // Hide controls bar — shown only for Skills tab
            document.getElementById('controlsBar').style.display = 'none';
            document.querySelector('.main-content')?.classList.remove('with-filters');
            
            // Hide match overlay UI when leaving network view
            if (view !== 'network') {
                var mt = document.getElementById('matchModeToggle');
                var mb = document.getElementById('matchActiveBadge');
                var ml = document.getElementById('matchLegend');
                if (mt) mt.style.display = 'none';
                if (mb) mb.style.display = 'none';
                if (ml) ml.remove();
            }

            // Update mobile nav
            document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
            const mobMap = { network: 'mob-skills', opportunities: 'mob-jobs', applications: 'mob-applications', blueprint: 'mob-blueprint' };
            const mobId = mobMap[view];
            if (mobId) { const mb = document.getElementById(mobId); if (mb) mb.classList.add('active'); }

            // Hide all views
            document.getElementById('welcomeView').style.display = 'none';
            document.getElementById('networkView').style.display = 'none';
            document.getElementById('cardView').style.display = 'none';
            document.getElementById('opportunitiesView').style.display = 'none';
            document.getElementById('applicationsView').style.display = 'none';
            document.getElementById('blueprintView').style.display = 'none';
            document.getElementById('consentView').style.display = 'none';
            document.getElementById('settingsView').style.display = 'none';
            networkControls.style.display = 'none';
            controls.style.display = 'none';
            
            // Hide readonly banner on non-profile views
            var roBanner = document.getElementById('readonlyBanner');
            if (roBanner && (view === 'welcome' || view === 'consent' || view === 'settings')) {
                roBanner.style.display = 'none';
            }
            
            // Hide app footer on welcome view (welcome has its own disclaimer)
            var appFooter = document.getElementById('appFooter');
            if (appFooter) {
                appFooter.style.display = (view === 'welcome') ? 'none' : 'block';
            }
            
            // Show selected view
            if (view === 'welcome') {
                var wv = document.getElementById('welcomeView');
                wv.style.display = 'block';
                // Render welcome unless picker already set custom content
                if (!window._welcomePickerActive) {
                    renderWelcomePage();
                }
                window._welcomePickerActive = false;
            } else if (view === 'network') {
                // Skills Ontology view
                controls.style.display = 'flex';
                // Sync toggle pills with current sub-view
                document.querySelectorAll('#skillsViewToggle .view-pill').forEach(function(chip) {
                    chip.classList.toggle('active', chip.dataset.view === currentSkillsView);
                });
                if (currentSkillsView === 'network') {
                    document.getElementById('networkView').style.display = 'block';
                    networkControls.style.display = 'flex';
                    // Hide filter button in network view (filtering via node clicks)
                    var fBtn = document.getElementById('filterToggleBtn');
                    var fPnl = document.getElementById('filterPanel');
                    if (fBtn) fBtn.style.display = 'none';
                    if (fPnl) fPnl.classList.remove('open');
                    // Show network filter pill if role active
                    var nfp = document.getElementById('networkFilterPill');
                    if (nfp) nfp.style.display = (activeRole && activeRole !== 'all') ? 'flex' : 'none';
                    // Lazy-init network SVG on first visit
                    if (!window.networkInitialized) {
                        initNetwork();
                        window.networkInitialized = true;
                    }
                    // Restore match overlay UI if a job is active
                    if (activeJobForNetwork) {
                        updateMatchOverlayUI();
                    }
                } else {
                    document.getElementById('cardView').style.display = 'block';
                    networkControls.style.display = 'none';
                    // Show filter button in card view
                    var fBtn2 = document.getElementById('filterToggleBtn');
                    if (fBtn2) fBtn2.style.display = '';
                    // Hide network filter pill
                    var nfp2 = document.getElementById('networkFilterPill');
                    if (nfp2) nfp2.style.display = 'none';
                    if (!window.cardViewInitialized) {
                        initCardView();
                        window.cardViewInitialized = true;
                    }
                }
                updateStatsBar();
            } else if (view === 'opportunities') {
                document.getElementById('opportunitiesView').style.display = 'block';
                if (!window.opportunitiesInitialized) {
                    initOpportunities();
                    window.opportunitiesInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'applications') {
                document.getElementById('applicationsView').style.display = 'block';
                if (!window.applicationsInitialized) {
                    initApplications();
                    window.applicationsInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'blueprint') {
                document.getElementById('blueprintView').style.display = 'block';
                if (!window.blueprintInitialized) {
                    initBlueprint();
                    window.blueprintInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'consent') {
                document.getElementById('consentView').style.display = 'block';
                if (!window.consentInitialized) {
                    initConsent();
                    window.consentInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'settings') {
                document.getElementById('settingsView').style.display = 'block';
                if (!window.settingsInitialized) {
                    initSettings();
                    window.settingsInitialized = true;
                }
                updateStatsBar();
            }
        }
        
        function toggleSkillsView(view) {
            currentSkillsView = view;
            document.querySelectorAll('#skillsViewToggle .view-pill').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.view === view);
            });
            
            const networkControls = document.getElementById('networkControls');
            var matchToggle = document.getElementById('matchModeToggle');
            var matchBadge = document.getElementById('matchActiveBadge');
            
            if (view === 'network') {
                document.getElementById('networkView').style.display = 'block';
                document.getElementById('cardView').style.display = 'none';
                networkControls.style.display = 'flex';
                // Lazy-init network if needed (e.g. after profile switch)
                if (!window.networkInitialized) {
                    initNetwork();
                    window.networkInitialized = true;
                }
                // Hide filter button/panel in network view (filtering via node clicks)
                var filterBtn = document.getElementById('filterToggleBtn');
                var filterPnl = document.getElementById('filterPanel');
                if (filterBtn) filterBtn.style.display = 'none';
                if (filterPnl) filterPnl.classList.remove('open');
                // Show network filter pill if a role is active
                var nfPill = document.getElementById('networkFilterPill');
                if (nfPill) nfPill.style.display = (activeRole && activeRole !== 'all') ? 'flex' : 'none';
                // Show match UI if a job is active
                if (activeJobForNetwork) {
                    if (matchToggle) matchToggle.style.display = 'inline-flex';
                    if (matchBadge) matchBadge.style.display = 'inline-flex';
                }
            } else {
                document.getElementById('networkView').style.display = 'none';
                document.getElementById('cardView').style.display = 'block';
                networkControls.style.display = 'none';
                // Lazy-init card view if needed (e.g. after profile switch)
                if (!window.cardViewInitialized) {
                    initCardView();
                    window.cardViewInitialized = true;
                }
                // Show filter button in card view
                var filterBtn2 = document.getElementById('filterToggleBtn');
                if (filterBtn2) filterBtn2.style.display = '';
                // Hide network filter pill in card view
                var nfPill2 = document.getElementById('networkFilterPill');
                if (nfPill2) nfPill2.style.display = 'none';
                // Hide match UI on card view
                if (matchToggle) matchToggle.style.display = 'none';
                if (matchBadge) matchBadge.style.display = 'none';
            }
        }
        
        function updateStatsBar() {
            const statsBar = document.getElementById('statsBar');
            if (currentView === 'network') {
                // Calculate total market value
                const totalValue = calculateTotalMarketValue();
                const valueFormatted = totalValue.total > 0 ? `$${(totalValue.total/1000).toFixed(0)}k` : '';
                const valueDisplay = valueFormatted ? ` • <span style="color: #10b981; font-weight: 700;">Market Value: ${valueFormatted}/year</span>` : '';
                
                // Dynamic counts by category
                const skillCount = userData.skills?.length || 0;
                const roleCount = userData.roles?.length || 0;
                const onetSkillsCount = userData.skills?.filter(s => s.category === 'skill').length || 0;
                const abilitiesCount = userData.skills?.filter(s => s.category === 'ability').length || 0;
                const workStylesCount = userData.skills?.filter(s => s.category === 'workstyle').length || 0;
                const uniqueCount = userData.skills?.filter(s => s.category === 'unique').length || 0;
                
                // Show detailed breakdown for v2.0.6 comprehensive model
                let skillBreakdown = '';
                if (skillCount >= 90) {
                    // Comprehensive 90-skill model
                    skillBreakdown = ` (${onetSkillsCount} Skills + ${abilitiesCount} Abilities + ${workStylesCount} Work Styles + ${uniqueCount} Unique)`;
                } else if (onetSkillsCount > 0 && uniqueCount > 0) {
                    // Hybrid model (v2.0.5)
                    skillBreakdown = ` (${onetSkillsCount} O*NET + ${uniqueCount} Unique)`;
                }
                
                statsBar.innerHTML = `${skillCount} Total Skills${skillBreakdown} • ${roleCount} Career Roles${valueDisplay}`;
            } else if (currentView === 'opportunities') {
                const matches = opportunitiesData.filter(j => j.matchScore >= currentMatchThreshold).length;
                statsBar.innerHTML = `${matches} Matching Opportunities • ${currentMatchThreshold}%+ Match Threshold`;
            } else if (currentView === 'applications') {
                const total = userData.applications?.length || 0;
                const active = userData.applications?.filter(a => a.status !== 'rejected').length || 0;
                statsBar.innerHTML = `${total} Applications Tracked • ${active} Active`;
            } else if (currentView === 'blueprint') {
                const sharedOutcomes = blueprintData.outcomes.filter(o => o.shared).length;
                const selectedValues = blueprintData.values.filter(v => v.selected).length;
                statsBar.innerHTML = `${sharedOutcomes} Outcomes • ${selectedValues} Values • Purpose Statement`;
            } else if (currentView === 'consent') {
                const totalShared = blueprintData.outcomes.filter(o => o.shared).length + 
                                   blueprintData.values.filter(v => v.selected).length;
                statsBar.innerHTML = `${totalShared} Items Shared • Data Privacy & Control`;
            } else if (currentView === 'settings') {
                statsBar.innerHTML = `Profile Settings • ${userData.preferences.seniorityLevel} Level • Customize Your Experience`;
            }
        }
        
        function toggleLabels(type) {
            if (!window.networkData) return;
            const { node } = window.networkData;
            
            node.selectAll('text')
                .filter(d => d.type === type)
                .classed('hidden', function() {
                    return !this.classList.contains('hidden');
                });
        }

        // Render dynamic role chips and level counts from current profile data
        function renderFilterChips() {
            // --- ROLES ---
            const rolesContainer = document.getElementById('roleChipsContainer');
            if (rolesContainer && userData.roles) {
                rolesContainer.innerHTML = `<div class="role-chip active" data-role="all" onclick="filterByRole('all')">All</div>` +
                    userData.roles.map(role => 
                        `<div class="role-chip" data-role="${role.id}" onclick="filterByRole('${role.id}')">${role.name}</div>`
                    ).join('');
            }
            
            // --- LEVELS ---
            const levelContainer = document.getElementById('levelChipsContainer');
            if (levelContainer && userData.skills) {
                const levelDefs = [
                    { key: 'Mastery',    cls: 'mastery' },
                    { key: 'Expert',     cls: 'expert' },
                    { key: 'Advanced',   cls: 'advanced' },
                    { key: 'Proficient', cls: 'proficient' },
                    { key: 'Novice',     cls: 'novice' }
                ];
                levelContainer.innerHTML = levelDefs
                    .map(({ key, cls }) => {
                        const count = userData.skills.filter(s => s.level === key).length;
                        if (count === 0) return '';
                        return `<div class="level-chip ${cls}" onclick="filterByLevel('${key.toLowerCase()}')">${key} (${count})</div>`;
                    })
                    .join('');
            }
        }

        function filterByRole(roleId) {
            activeRole = roleId;
            
            // Update filter panel chips
            document.querySelectorAll('.role-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.role === roleId);
            });
            
            // Update network filter pill indicator
            var nfPill = document.getElementById('networkFilterPill');
            var nfText = document.getElementById('networkFilterPillText');
            var nfDot = document.getElementById('networkFilterPillDot');
            if (nfPill && currentSkillsView === 'network') {
                if (roleId === 'all') {
                    nfPill.style.display = 'none';
                } else {
                    // Find the role name and color
                    var roleName = roleId;
                    var roleColor = 'var(--accent)';
                    if (window.networkData && window.networkData.nodes) {
                        var roleNode = window.networkData.nodes.find(function(n) { return n.id === roleId; });
                        if (roleNode) {
                            roleName = roleNode.name || roleId;
                            roleColor = roleNode.color || 'var(--accent)';
                        }
                    }
                    if (nfText) nfText.textContent = roleName;
                    if (nfDot) nfDot.style.background = roleColor;
                    nfPill.style.display = 'flex';
                }
            }

            if (!window.networkData) return;

            const { nodes, links, node, link } = window.networkData;

            if (roleId === 'all') {
                node.classed('dimmed', false).classed('highlighted', false);
                link.classed('dimmed', false).classed('highlighted', false);
                
                // Show all labels
                node.selectAll('text').classed('hidden', false);
                return;
            }

            // Find skills that belong to this role
            const relevantSkills = skillsData.skills
                .filter(s => s.roles.includes(roleId))
                .map((s, i) => `skill-${skillsData.skills.indexOf(s)}`);

            node.classed('dimmed', d => {
                if (d.type === 'center') return false;
                if (d.type === 'role') return d.id !== roleId;
                return !relevantSkills.includes(d.id);
            });

            node.classed('highlighted', d => {
                if (d.type === 'role') return d.id === roleId;
                return relevantSkills.includes(d.id);
            });

            link.classed('dimmed', d => {
                return d.source.id !== roleId && !relevantSkills.includes(d.target.id);
            });

            link.classed('highlighted', d => {
                return d.source.id === roleId && relevantSkills.includes(d.target.id);
            });
            
            // STORYTELLING MODE: Hide skill labels that aren't in this role
            node.selectAll('text').classed('hidden', function(d) {
                if (d.type === 'center') return false;
                if (d.type === 'role') return d.id !== roleId; // Hide non-active role labels
                return !relevantSkills.includes(d.id); // Hide non-relevant skill labels
            });
        }

        function filterByLevel(level) {
            activeLevel = activeLevel === level ? null : level;
            
            event.target.classList.toggle('active');

            if (!window.networkData) return;
            const { node } = window.networkData;

            if (!activeLevel) {
                node.classed('dimmed', false);
                return;
            }

            node.classed('dimmed', d => {
                if (d.type !== 'skill') return false;
                return d.level.toLowerCase() !== activeLevel;
            });
        }


        function showTooltip(event, d) {
            if (d.type === 'center') return;

            const tooltip = d3.select('#tooltip');
            let html = `<div class="tooltip-title">${d.name}</div>`;

            if (d.type === 'skill') {
                html += `<div class="tooltip-level">${d.level}${d.key ? ' • Core Differentiator' : ''}</div>`;
                html += `<div class="tooltip-roles">Used in: `;
                d.roles.forEach(roleId => {
                    const role = skillsData.roles.find(r => r.id === roleId);
                    html += `<span class="tooltip-role-tag">${role.name}</span>`;
                });
                html += `</div>`;
            } else if (d.type === 'role') {
                const skillCount = skillsData.skills.filter(s => s.roles.includes(d.id)).length;
                html += `<div class="tooltip-roles">${skillCount} skills in this role</div>`;
            }

            tooltip
                .html(html)
                .style('opacity', 1)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            d3.select('#tooltip').style('opacity', 0);
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            if (d.type !== 'center') {
                d.fx = null;
                d.fy = null;
            }
        }

        function openExportModal() {
            history.pushState({ modal: true }, ''); document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }
        
        // ===== WORK BLUEPRINT GENERATOR =====
        
        function generateWorkBlueprint() {
            console.log('Generating Blueprint...');
            
            try {
                const profileData = gatherBlueprintData();
                const html = createBlueprintHTML(profileData);
                downloadBlueprint(html, `blueprint-${profileData.name.replace(/\s+/g, '-').toLowerCase()}.html`);
                
                showToast('Blueprint downloaded! Open in any browser to view, print, or share.', 'success', 6000);
            } catch (error) {
                console.error('Error generating blueprint:', error);
                showToast('Error generating Blueprint. Check console for details.', 'error');
            }
        }
        
        function gatherBlueprintData() {
            const skills = skillsData.skills || userData.skills || [];
            const topSkills = skills.map(skill => ({ ...skill, impact: getSkillImpact(skill) })).sort((a, b) => (b.impact?.score || 0) - (a.impact?.score || 0)).slice(0, 10);
            const compensation = calculateTotalMarketValue();

            // Pull real strategic outcomes from skill evidence — prefer items with metrics
            const allEvidence = [];
            skills.forEach(skill => {
                (skill.evidence || []).forEach(ev => {
                    const text = (ev.outcome || '') + ' ' + (ev.description || '');
                    let score = 0;
                    if (/\$[\d,]+[MBK]?/i.test(text)) score += 5;
                    if (/\d+%/.test(text)) score += 4;
                    if (/million|billion/i.test(text)) score += 5;
                    if (/\d+x|\d+ times/i.test(text)) score += 3;
                    if (skill.level === 'Mastery' || skill.level === 'Expert') score += 2;
                    if (skill.key) score += 2;
                    allEvidence.push({ skill: skill.name, description: ev.description, outcome: ev.outcome, score });
                });
            });
            allEvidence.sort((a, b) => b.score - a.score);

            // Build strategicOutcomes from top 5 real evidence items
            const strategicOutcomes = allEvidence.slice(0, 5).map(item => ({
                title: item.skill,
                metric: extractMetric(item.outcome),
                description: item.description || '',
                outcome: item.outcome || ''
            }));

            // Use real values from profile
            const selectedValues = (userData.values || []).filter(v => v.selected !== false).map(v => v.name || v);

            return {
                name: userData.profile.name || 'Your Name',
                title: userData.profile.currentTitle || 'Your Title',
                company: userData.profile.currentCompany || '',
                location: userData.profile.location || '',
                headline: userData.profile.headline || `${userData.profile.currentTitle || 'Strategic Professional'} · ${userData.profile.yearsExperience || ''}+ Years`,
                generatedDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                executiveSummary: userData.profile.executiveSummary || userData.purpose || 'Accomplished professional with proven track record of delivering measurable business impact.',
                purpose: userData.purpose || '',
                coreCompetencies: topSkills,
                strategicOutcomes,
                leadershipPhilosophy: userData.purpose || 'Leadership is about creating conditions where great work becomes inevitable.',
                marketPositioning: selectedValues.length > 0
                    ? `Core principles: ${selectedValues.join(' · ')}.`
                    : 'Strategic professional with deep domain expertise and proven track record.',
                compensation: compensation,
                careerNarrative: userData.profile.executiveSummary || 'A career defined by building bridges between technical innovation and business strategy.',
                futureVision: userData.purpose || 'Focused on creating lasting impact through authentic leadership and evidence-based strategy.'
            };
        }

        // Extract the most compelling metric from an outcome string
        function extractMetric(text) {
            if (!text) return '';
            const dollarMatch = text.match(/\$[\d.,]+[MBK]?(?:\s*\w+)?/i);
            if (dollarMatch) return dollarMatch[0];
            const pctMatch = text.match(/\d+%(?:\s*\w+)?/);
            if (pctMatch) return pctMatch[0];
            const multMatch = text.match(/\d+x(?:\s*\w+)?/i);
            if (multMatch) return multMatch[0];
            // Fallback: first 40 chars
            return text.slice(0, 40) + (text.length > 40 ? '…' : '');
        }
        
        function createBlueprintHTML(data) {
            const htmlContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Blueprint - ' + data.name + '</title><link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}:root{--primary:#1e40af;--accent:#f59e0b;--text:#1f2937;--text-light:#6b7280;--border:#e5e7eb;--bg:#fff;--bg-alt:#f9fafb}body{font-family:Crimson Pro,Georgia,serif;color:var(--text);background:var(--bg);line-height:1.7;font-size:18px}.container{max-width:900px;margin:0 auto;padding:60px 40px}header{border-bottom:3px solid var(--primary);padding-bottom:40px;margin-bottom:60px}h1{font-size:48px;font-weight:700;color:var(--primary);margin-bottom:10px}h2{font-size:32px;font-weight:700;color:var(--primary);margin-bottom:20px;border-left:4px solid var(--accent);padding-left:20px}section{margin-bottom:60px}p{margin-bottom:16px}.subtitle{font-size:24px;color:var(--text-light);margin-bottom:20px}.headline{font-size:20px;color:var(--accent);font-weight:600}.meta{font-family:JetBrains Mono,monospace;font-size:14px;color:var(--text-light);margin-top:20px}.skills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:30px}.skill-card{background:var(--bg-alt);border:1px solid var(--border);border-left:4px solid #3b82f6;padding:20px}.skill-name{font-size:18px;font-weight:600;color:var(--primary);margin-bottom:8px}.skill-level{font-family:JetBrains Mono,monospace;font-size:12px;color:var(--accent);text-transform:uppercase}.outcome{background:linear-gradient(to right,var(--bg-alt),var(--bg));border-left:4px solid var(--accent);padding:24px;margin-bottom:20px}.outcome-title{font-size:20px;font-weight:600;color:var(--primary);margin-bottom:8px}.outcome-metric{font-family:JetBrains Mono,monospace;font-size:16px;color:var(--accent);margin-bottom:10px}.comp-framework{background:var(--bg-alt);border:2px solid var(--primary);padding:30px;margin-top:30px}.comp-row{display:flex;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border)}.comp-label{font-weight:600}.comp-value{font-family:JetBrains Mono,monospace;color:var(--primary);font-weight:600}.quote-block{background:linear-gradient(135deg,var(--primary),#3b82f6);color:#fff;padding:40px;margin:40px 0;font-size:22px;font-style:italic}@media print{body{font-size:11pt}.container{padding:20px}h1{font-size:28pt}h2{font-size:18pt}}</style></head><body><div class="container"><header><h1>' + data.name + '</h1><div class="subtitle">' + data.title + '</div><div class="headline">' + data.headline + '</div><div class="meta">Generated: ' + data.generatedDate + '</div></header><section><h2>Executive Summary</h2><p>' + data.executiveSummary + '</p></section><section><h2>Core Competencies</h2><p>Strategic capabilities driving measurable impact:</p><div class="skills-grid">' + data.coreCompetencies.map(s => '<div class="skill-card"><div class="skill-name">' + s.name + '</div><div class="skill-level">' + (s.proficiency || 'Expert') + '</div></div>').join('') + '</div></section><section><h2>Strategic Outcomes</h2>' + data.strategicOutcomes.map(o => '<div class="outcome"><div class="outcome-title">' + o.title + '</div><div class="outcome-metric">' + o.metric + '</div><p>' + o.description + '</p></div>').join('') + '</section><section><h2>Leadership Philosophy</h2><p>' + data.leadershipPhilosophy + '</p></section><div class="quote-block">"' + data.marketPositioning + '"</div><section><h2>Compensation Framework</h2><p>Market-informed positioning based on skill depth and impact:</p><div class="comp-framework"><div class="comp-row"><span class="comp-label">Base Market Rate</span><span class="comp-value">$' + Math.round(data.compensation.marketRate || 200000).toLocaleString() + '</span></div><div class="comp-row"><span class="comp-label">Conservative Range</span><span class="comp-value">$' + Math.round(data.compensation.conservativeOffer || 225000).toLocaleString() + '</span></div><div class="comp-row"><span class="comp-label">Competitive Range</span><span class="comp-value">$' + Math.round(data.compensation.competitiveOffer || 275000).toLocaleString() + '</span></div></div></section><section><h2>Career Narrative</h2><p>' + data.careerNarrative + '</p></section><section><h2>Future Vision</h2><p>' + data.futureVision + '</p></section><footer style="margin-top:80px;padding-top:40px;border-top:2px solid var(--border);color:var(--text-light);font-size:14px"><p>This Blueprint is a living document representing strategic capabilities and market positioning as of ' + data.generatedDate + '.</p><p style=\"margin-top:8px;\">&copy; ' + new Date().getFullYear() + ' Cliff Jurkiewicz. All rights reserved. Blueprint&trade; and its methodologies are the intellectual property of Cliff Jurkiewicz.</p></footer></div></body></html>';
            return htmlContent;
        }
        
        function downloadBlueprint(html, filename) {
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function openSkillModal(skillName, skillData) {
            const modal = document.getElementById('skillModal');
            const title = document.getElementById('skillDetailTitle');
            const subtitle = document.getElementById('skillDetailSubtitle');
            const body = document.getElementById('skillDetailBody');
            
            // Set title
            title.textContent = skillName;
            
            // Set subtitle (level, years, core badge, category badge)
            const levelClass = skillData.level.toLowerCase();
            const coreBadge = skillData.key ? '<span class="modal-core-badge">⭐ CORE DIFFERENTIATOR</span>' : '';
            const details = skillsData.skillDetails[skillName] || {};
            
            // DEBUG: Log evidence availability
            console.log('=== EVIDENCE DEBUG ===');
            console.log('Skill:', skillName);
            console.log('skillData.evidence:', skillData.evidence);
            console.log('details.evidence:', details.evidence);
            
            // Get evidence from skill object if not in skillDetails
            const evidence = details.evidence || (skillData.evidence ? skillData.evidence.map(e => `${e.description}<br><strong>Outcome:</strong> ${e.outcome}`) : null);
            console.log('Final evidence:', evidence);
            
            const years = details.years || skillData.yearsExperience || 'N/A';
            
            // Category badge for all O*NET types + Unique
            let categoryBadge = '';
            if (skillData.category === 'skill') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">🏛️ O*NET Skill</span>';
            } else if (skillData.category === 'ability') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(139, 92, 246, 0.2); color: #a78bfa;">🧠 O*NET Ability</span>';
            } else if (skillData.category === 'workstyle') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">💼 O*NET Work Style</span>';
            } else if (skillData.category === 'unique') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">⭐ Unique Differentiator</span>';
            }
            
            subtitle.innerHTML = `
                <span class="modal-level-badge ${levelClass}">${skillData.level}</span>
                <span class="modal-years">${years} years experience</span>
                ${categoryBadge}
                ${coreBadge}
            `;
            
            // Build body content
            let bodyHTML = '';
            
            // Roles section
            bodyHTML += `
                <div class="modal-section">
                    <div class="modal-section-title">
                        <span class="modal-section-icon">🎯</span>
                        Used in These Roles
                    </div>
                    <div class="roles-tags">
            `;
            skillData.roles.forEach(roleId => {
                const role = skillsData.roles.find(r => r.id === roleId);
                if (role) {
                    bodyHTML += `<div class="role-tag">${role.icon} ${role.name}</div>`;
                }
            });
            bodyHTML += `</div></div>`;
            
            // Evidence section
            if (evidence && evidence.length > 0) {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">✓</span>
                            Evidence & Defensibility
                        </div>
                        <ul class="evidence-list">
                `;
                evidence.forEach(item => {
                    bodyHTML += `<li class="evidence-item">${item}</li>`;
                });
                bodyHTML += `</ul></div>`;
            } else {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">✓</span>
                            Evidence & Defensibility
                        </div>
                        <p class="placeholder-text">Evidence for this skill will be added soon.</p>
                    </div>
                `;
            }
            
            // MARKET IMPACT SECTION
            const skillImpact = calculateSkillValue(skillData);
            const impactColor = getImpactColor(skillImpact.level);
            
            bodyHTML += `
                <div class="modal-section" style="background: rgba(${impactColor === '#ef4444' ? '239, 68, 68' : impactColor === '#f59e0b' ? '245, 158, 11' : impactColor === '#3b82f6' ? '59, 130, 246' : '107, 114, 128'}, 0.1); border-left: 3px solid ${impactColor}; padding: 20px; border-radius: 8px;">
                    <div class="modal-section-title">
                        <span class="modal-section-icon">📊</span>
                        Market Impact
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="font-size: 1.8em; font-weight: 700; color: ${impactColor}; margin-bottom: 10px;">
                            ${skillImpact.icon} ${skillImpact.label}
                        </div>
                        
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px; line-height: 1.5;">
                            ${skillImpact.rationale || 'This skill contributes to your overall market value based on proficiency level and market demand.'}
                        </div>
                        
                        ${skillData.category === 'unique' && skillImpact.needsAssessment ? `
                            <div style="background: rgba(251, 191, 36, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #fbbf24;">
                                <div style="color: #fbbf24; font-weight: 600; margin-bottom: 8px;">⚠️ Estimated Rating</div>
                                <div style="color: #d1d5db; font-size: 0.9em; line-height: 1.5; margin-bottom: 12px;">
                                    ${skillImpact.rationale}
                                </div>
                                <button onclick="closeSkillModal(); openAssessSkillModal('${skillData.name.replace(/'/g, "\\'")}');" 
                                        style="padding: 8px 16px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: #000;">
                                    📝 Assess This Skill
                                </button>
                            </div>
                        ` : ''}
                        
                        ${skillData.category === 'unique' && skillImpact.userAssessed ? `
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="color: #10b981; font-weight: 600; margin-bottom: 5px;">✓ User Assessed</div>
                                <div style="color: #d1d5db; font-size: 0.85em;">
                                    Based on your assessment of this skill's experience, impact, and market scarcity.
                                    <button onclick="closeSkillModal(); openAssessSkillModal('${skillData.name.replace(/'/g, "\\'")}');" 
                                            style="margin-left: 10px; padding: 4px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                        Edit Assessment
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 6px; margin-top: 15px;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">📊 Impact Scale</div>
                            <div style="color: #d1d5db; font-size: 0.9em; line-height: 1.6;">
                                • <strong style="color: #ef4444;">🔥 Critical:</strong> Top 5% differentiators, significant premium<br>
                                • <strong style="color: #f59e0b;">⭐ High:</strong> Top 20% skills, strong differentiator<br>
                                • <strong style="color: #3b82f6;">💎 Moderate:</strong> Expected for role level, valuable<br>
                                • <strong style="color: #6b7280;">✓ Standard:</strong> Baseline expectations<br>
                                • <strong style="color: #9ca3af;">○ Supplementary:</strong> Supporting capabilities
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 5px;">💡 How This Affects Your Strategic Value</div>
                            <div style="color: #d1d5db; font-size: 0.85em; line-height: 1.5;">
                                Your compensation positioning is driven by your <strong>Critical and High Impact skills combined</strong> with your experience level. Focus on developing and demonstrating these capabilities to command premium offers.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Story section
            if (details.story) {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">📖</span>
                            Context & Story
                        </div>
                        <div class="story-text">${details.story}</div>
                    </div>
                `;
            }
            
            // Related skills section
            if (details.relatedSkills && details.relatedSkills.length > 0) {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">🔗</span>
                            Related Skills
                        </div>
                        <div class="related-skills">
                `;
                details.relatedSkills.forEach(relatedSkill => {
                    bodyHTML += `<div class="related-skill-chip" onclick="openRelatedSkill('${relatedSkill}')">${relatedSkill}</div>`;
                });
                bodyHTML += `</div></div>`;
            }
            
            body.innerHTML = bodyHTML;
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function closeSkillModal() {
            document.getElementById('skillModal').classList.remove('active');
        }
        
        function openRelatedSkill(skillName) {
            const skill = skillsData.skills.find(s => s.name === skillName);
            if (skill) {
                openSkillModal(skillName, skill);
            }
        }
        
        function openSkillModalFromCard(skillName) {
            const skill = skillsData.skills.find(s => s.name === skillName);
            console.log('🔍 Opening modal for:', skillName);
            console.log('  → Found skill:', skill ? 'YES' : 'NO');
            if (skill) {
                console.log('  → Skill has evidence:', skill.evidence ? `YES (${skill.evidence.length} items)` : 'NO');
                openSkillModal(skillName, skill);
            } else {
                console.error('  → ERROR: Skill not found in skillsData.skills');
            }
        }

        // ===== PROFESSIONAL RESUME GENERATOR =====
        // Produces a clean, ATS-readable HTML resume styled for print-to-PDF.
        // Pulls real data: executiveSummary, skill evidence outcomes, values, purpose, market value.

        function generateResume() {
            try {
                const data = gatherResumeData();
                const html = buildResumeHTML(data);
                const filename = `resume-${(data.name || 'profile').replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.html`;
                downloadBlueprint(html, filename);
            } catch (err) {
                console.error('Resume generation error:', err);
                showToast('Error generating resume. See console for details.', 'error');
            }
        }

        function gatherResumeData() {
            const skills = skillsData.skills || userData.skills || [];
            const profile = userData.profile || {};
            const compensation = calculateTotalMarketValue();

            // --- Achievements: pull evidence items that have real outcomes ---
            // Score each evidence item: prefer items with metrics, dollar amounts, percentages
            const allEvidence = [];
            skills.forEach(skill => {
                (skill.evidence || []).forEach(ev => {
                    const text = (ev.outcome || '') + ' ' + (ev.description || '');
                    let score = 0;
                    if (/\$[\d,]+[MBK]?/i.test(text)) score += 5;
                    if (/\d+%/.test(text)) score += 4;
                    if (/\d+x|\d+ times/i.test(text)) score += 3;
                    if (/\d+ (months?|years?|days?)/i.test(text)) score += 2;
                    if (/million|billion/i.test(text)) score += 5;
                    if (/zero|perfect|first|award|recogni/i.test(text)) score += 2;
                    if (skill.level === 'Mastery') score += 3;
                    else if (skill.level === 'Expert') score += 2;
                    else if (skill.level === 'Advanced') score += 1;
                    if (skill.key) score += 2;
                    allEvidence.push({
                        skill: skill.name,
                        level: skill.level,
                        category: skill.category,
                        roles: skill.roles || [],
                        description: ev.description || '',
                        outcome: ev.outcome || '',
                        score
                    });
                });
            });
            allEvidence.sort((a, b) => b.score - a.score);
            const topAchievements = allEvidence.slice(0, 10);

            // --- Core competencies: key + mastery skills, deduplicated by category ---
            const keySkills = skills.filter(s => s.key || s.level === 'Mastery' || s.level === 'Expert');
            // Group into max 18 skills for the competencies grid — pick diverse ones
            const compSet = [];
            const seen = new Set();
            // Key skills first
            keySkills.forEach(s => { if (!seen.has(s.name) && compSet.length < 18) { compSet.push(s); seen.add(s.name); } });
            // Fill with advanced skills
            skills.filter(s => s.level === 'Advanced' && !seen.has(s.name))
                  .slice(0, 18 - compSet.length)
                  .forEach(s => { compSet.push(s); seen.add(s.name); });

            // --- Role groupings for skills section ---
            const roleGroups = {};
            (userData.roles || skillsData.roles || []).forEach(role => {
                const roleSkills = skills.filter(s => (s.roles || []).includes(role.id));
                if (roleSkills.length > 0) roleGroups[role.name] = roleSkills;
            });

            // --- Values (selected only) ---
            const selectedValues = (userData.values || [])
                .filter(v => v.selected !== false)
                .map(v => v.name || v);

            return {
                name: profile.name || 'Your Name',
                title: profile.currentTitle || 'Professional',
                company: profile.currentCompany || '',
                location: profile.location || '',
                yearsExperience: profile.yearsExperience || '',
                executiveSummary: profile.executiveSummary || userData.purpose || '',
                purpose: userData.purpose || '',
                topAchievements,
                competencies: compSet,
                roleGroups,
                values: selectedValues,
                compensation,
                generatedDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                totalSkills: skills.length,
                masteryCount: skills.filter(s => s.level === 'Mastery').length,
                expertCount: skills.filter(s => s.level === 'Expert').length
            };
        }

        function buildResumeHTML(d) {
            const name = d.name;
            const title = d.title;
            const location = d.location ? d.location.split(',').slice(-2).join(',').trim() : '';
            const comp = d.compensation;
            const salaryRange = comp && comp.standardOffer
                ? `$${Math.round(comp.conservativeOffer / 1000)}K – $${Math.round(comp.competitiveOffer / 1000)}K`
                : '';

            // Achievement bullets
            const achievementHTML = d.topAchievements.map(item => {
                // Format as a strong bullet: lead with outcome, add context
                const outcome = item.outcome.trim().replace(/\.$/, '');
                const desc = item.description.trim().replace(/\.$/, '');
                // Keep description concise — truncate at ~120 chars
                const shortDesc = desc.length > 120 ? desc.slice(0, 117) + '…' : desc;
                return `<li><span class="ach-outcome">${outcome}.</span> <span class="ach-context">${shortDesc}.</span></li>`;
            }).join('\n');

            // Competencies grid — just clean names
            const compHTML = d.competencies.map(s => {
                const levelDot = s.level === 'Mastery' ? '●●●' : s.level === 'Expert' ? '●●○' : s.level === 'Advanced' ? '●○○' : '○○○';
                return `<div class="comp-item"><span class="comp-name">${s.name}</span><span class="comp-dots">${levelDot}</span></div>`;
            }).join('\n');

            // Values
            const valuesHTML = d.values.length
                ? d.values.map(v => `<span class="value-tag">${v}</span>`).join('')
                : '';

            // Salary target line (only if data exists)
            const salaryLine = salaryRange
                ? `<div class="contact-item">Target Range: ${salaryRange}</div>`
                : '';

            return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resume — ${name}</title>
<style>
/* =====================================================
   WORK BLUEPRINT RESUME — Professional Print-Ready
   Designed for: ATS readability + human presentation
   Print: File → Print → Save as PDF
   ===================================================== */

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --ink:       #111827;
  --ink-2:     #374151;
  --ink-3:     #6b7280;
  --rule:      #d1d5db;
  --accent:    #1d4ed8;
  --accent-lt: #eff6ff;
  --pg-w:      8.5in;
  --pg-pad:    0.65in;
}

html { font-size: 11pt; }

body {
  font-family: 'Georgia', 'Times New Roman', serif;
  color: var(--ink);
  background: #f3f4f6;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}

.page {
  width: var(--pg-w);
  min-height: 11in;
  margin: 0.4in auto;
  padding: var(--pg-pad);
  background: #fff;
  box-shadow: 0 4px 24px rgba(0,0,0,0.12);
}

/* ---- HEADER ---- */
.resume-header {
  border-bottom: 2.5pt solid var(--accent);
  padding-bottom: 14pt;
  margin-bottom: 18pt;
}

.resume-name {
  font-family: 'Arial', 'Helvetica Neue', sans-serif;
  font-size: 26pt;
  font-weight: 700;
  color: var(--ink);
  letter-spacing: -0.5pt;
  line-height: 1;
  margin-bottom: 4pt;
}

.resume-title {
  font-family: 'Arial', sans-serif;
  font-size: 12pt;
  font-weight: 400;
  color: var(--accent);
  letter-spacing: 0.3pt;
  margin-bottom: 10pt;
}

.contact-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6pt 18pt;
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--ink-2);
}

.contact-item {
  display: flex;
  align-items: center;
  gap: 4pt;
}

.contact-sep {
  color: var(--rule);
}

/* ---- SECTION STRUCTURE ---- */
.section {
  margin-bottom: 18pt;
}

.section-label {
  font-family: 'Arial', sans-serif;
  font-size: 8.5pt;
  font-weight: 700;
  letter-spacing: 1.5pt;
  text-transform: uppercase;
  color: var(--accent);
  border-bottom: 1pt solid var(--rule);
  padding-bottom: 3pt;
  margin-bottom: 10pt;
}

/* ---- SUMMARY ---- */
.summary-text {
  font-size: 10.5pt;
  line-height: 1.65;
  color: var(--ink-2);
  max-width: 100%;
}

/* ---- ACHIEVEMENTS ---- */
.achievements-list {
  list-style: none;
  padding: 0;
}

.achievements-list li {
  font-size: 10pt;
  line-height: 1.6;
  padding: 5pt 0 5pt 14pt;
  border-bottom: 0.5pt solid #f0f0f0;
  position: relative;
}

.achievements-list li::before {
  content: '▸';
  position: absolute;
  left: 0;
  color: var(--accent);
  font-size: 9pt;
  top: 6pt;
}

.achievements-list li:last-child {
  border-bottom: none;
}

.ach-outcome {
  font-weight: 600;
  color: var(--ink);
}

.ach-context {
  color: var(--ink-2);
}

/* ---- COMPETENCIES GRID ---- */
.comp-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 5pt 16pt;
}

.comp-item {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  font-size: 9.5pt;
  padding: 3pt 0;
  border-bottom: 0.5pt solid #f5f5f5;
}

.comp-name {
  color: var(--ink-2);
}

.comp-dots {
  font-size: 7pt;
  color: var(--accent);
  letter-spacing: 2pt;
  flex-shrink: 0;
  margin-left: 6pt;
}

/* ---- EXPERIENCE BLOCK ---- */
.experience-block {
  margin-bottom: 12pt;
}

.exp-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 2pt;
}

.exp-title {
  font-family: 'Arial', sans-serif;
  font-size: 11pt;
  font-weight: 600;
  color: var(--ink);
}

.exp-dates {
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--ink-3);
}

.exp-company {
  font-family: 'Arial', sans-serif;
  font-size: 10pt;
  color: var(--ink-2);
  margin-bottom: 6pt;
}

/* ---- VALUES ---- */
.values-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6pt;
}

.value-tag {
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--accent);
  background: var(--accent-lt);
  padding: 2pt 8pt;
  border-radius: 2pt;
  border: 0.5pt solid #bfdbfe;
}

/* ---- FOOTER ---- */
.resume-footer {
  margin-top: 24pt;
  padding-top: 8pt;
  border-top: 0.5pt solid var(--rule);
  font-family: 'Arial', sans-serif;
  font-size: 8pt;
  color: var(--ink-3);
  display: flex;
  justify-content: space-between;
}

/* ---- LEGEND ---- */
.legend {
  font-family: 'Arial', sans-serif;
  font-size: 8pt;
  color: var(--ink-3);
  margin-top: 6pt;
}

/* ---- PRINT ---- */
@media print {
  body { background: white; }
  .page {
    width: 100%;
    margin: 0;
    padding: 0.55in 0.65in;
    box-shadow: none;
    min-height: auto;
  }
  .section { page-break-inside: avoid; }
  .no-print { display: none !important; }
}

/* ---- SCREEN PRINT BUTTON ---- */
.print-bar {
  width: var(--pg-w);
  margin: 0 auto 10pt;
  display: flex;
  justify-content: flex-end;
  gap: 10pt;
}

.btn-print {
  font-family: 'Arial', sans-serif;
  font-size: 10pt;
  font-weight: 600;
  color: #fff;
  background: var(--accent);
  border: none;
  padding: 8pt 20pt;
  border-radius: 4pt;
  cursor: pointer;
  letter-spacing: 0.3pt;
}

.btn-print:hover { background: #1e40af; }

@media print { .print-bar { display: none; } }

/* Toast Notification System */
#toastContainer {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 100000;
    display: flex;
    flex-direction: column-reverse;
    gap: 10px;
    pointer-events: none;
}
.toast {
    pointer-events: auto;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    min-width: 280px;
    max-width: 420px;
    padding: 14px 18px;
    border-radius: 10px;
    font-size: 0.92em;
    line-height: 1.45;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    transform: translateX(120%);
    opacity: 0;
    transition: transform 0.35s cubic-bezier(0.22,1,0.36,1), opacity 0.35s ease;
}
.toast.show { transform: translateX(0); opacity: 1; }
.toast.hide { transform: translateX(120%); opacity: 0; }
.toast-icon { font-size: 1.15em; flex-shrink: 0; margin-top: 1px; }
.toast-body { flex: 1; }
.toast-title { font-weight: 600; margin-bottom: 2px; }
.toast-msg { opacity: 0.88; }
.toast-close {
    background: none; border: none; cursor: pointer;
    font-size: 1.1em; opacity: 0.5; padding: 0 0 0 8px;
    color: inherit; flex-shrink: 0;
}
.toast-close:hover { opacity: 1; }
.toast-success { background: #065f46; color: #d1fae5; border-left: 4px solid #10b981; }
.toast-error   { background: #7f1d1d; color: #fecaca; border-left: 4px solid #ef4444; }
.toast-info    { background: #1e3a5f; color: #bfdbfe; border-left: 4px solid #60a5fa; }
.toast-warning { background: #78350f; color: #fef3c7; border-left: 4px solid #f59e0b; }
/* Light theme toast overrides */
body[data-theme="light"] .toast-success { background: #ecfdf5; color: #065f46; }
body[data-theme="light"] .toast-error   { background: #fef2f2; color: #7f1d1d; }
body[data-theme="light"] .toast-info    { background: #eff6ff; color: #1e3a5f; }
body[data-theme="light"] .toast-warning { background: #fffbeb; color: #78350f; }
@media (max-width: 600px) {
    #toastContainer { left: 12px; right: 12px; bottom: 16px; }
    .toast { min-width: unset; max-width: unset; }
}
</style>
</head>
<body>

<div class="print-bar no-print">
  <button class="btn-print" onclick="window.print()">⬇ Save as PDF</button>
</div>

<div class="page">

  <!-- HEADER -->
  <header class="resume-header">
    <div class="resume-name">${name}</div>
    <div class="resume-title">${title}</div>
    <div class="contact-row">
      ${d.company ? `<div class="contact-item">${d.company}</div><div class="contact-sep">·</div>` : ''}
      ${location ? `<div class="contact-item">${location}</div>` : ''}
      ${d.yearsExperience ? `<div class="contact-sep">·</div><div class="contact-item">${d.yearsExperience}+ Years Experience</div>` : ''}
      ${salaryLine}
    </div>
  </header>

  <!-- PROFESSIONAL SUMMARY -->
  ${d.executiveSummary ? `
  <section class="section">
    <div class="section-label">Professional Summary</div>
    <p class="summary-text">${d.executiveSummary}</p>
  </section>` : ''}

  <!-- CORE COMPETENCIES -->
  ${d.competencies.length > 0 ? `
  <section class="section">
    <div class="section-label">Core Competencies</div>
    <div class="comp-grid">
      ${compHTML}
    </div>
    <div class="legend" style="margin-top:8pt;">Proficiency: ●●● Mastery &nbsp;·&nbsp; ●●○ Expert &nbsp;·&nbsp; ●○○ Advanced</div>
  </section>` : ''}

  <!-- SELECTED ACHIEVEMENTS -->
  ${d.topAchievements.length > 0 ? `
  <section class="section">
    <div class="section-label">Selected Achievements</div>
    <ul class="achievements-list">
      ${achievementHTML}
    </ul>
  </section>` : ''}

  <!-- PROFESSIONAL EXPERIENCE -->
  <section class="section">
    <div class="section-label">Professional Experience</div>
    <div class="experience-block">
      <div class="exp-header">
        <div class="exp-title">${title}</div>
        <div class="exp-dates">Present${d.yearsExperience ? ` · ${d.yearsExperience}+ years` : ''}</div>
      </div>
      <div class="exp-company">${d.company}${location ? ` · ${location}` : ''}</div>
    </div>
    ${d.purpose ? `<p class="summary-text" style="font-size:9.5pt; color: #4b5563;">${d.purpose}</p>` : ''}
  </section>

  <!-- VALUES -->
  ${valuesHTML ? `
  <section class="section">
    <div class="section-label">Core Values &amp; Leadership Principles</div>
    <div class="values-row">${valuesHTML}</div>
  </section>` : ''}

  <!-- FOOTER -->
  <footer class="resume-footer">
    <span>Generated by Blueprint&trade; · ${d.generatedDate} · &copy; ${new Date().getFullYear()} Cliff Jurkiewicz</span>
    <span>${d.totalSkills} documented skills · ${d.masteryCount + d.expertCount} at Mastery/Expert level</span>
  </footer>

</div><!-- /page -->
</body>
</html>`;
        }
        // ===== END RESUME GENERATOR =====

        // Resize handler
        
        // ===== WORK BLUEPRINT SYSTEM =====
        
        let blueprintData = {
            outcomes: [],
            values: [],
            purpose: "",
            shareSettings: {}
        };
        
        function initBlueprint() {
            extractOutcomesFromEvidence();
            inferValues();
            renderBlueprint();
        }
        
        function extractOutcomesFromEvidence() {
            const outcomes = [];

            // Evidence now lives in userData.skills[].evidence as {description, outcome} objects.
            // We pull from there first, then fall back to the legacy skillDetails strings.
            const skills = userData.skills || skillsData.skills || [];

            skills.forEach(skill => {
                (skill.evidence || []).forEach(ev => {
                    // ev is {description, outcome} — use the outcome field for display
                    const outcomeText = (ev.outcome || '').trim();
                    const descText   = (ev.description || '').trim();
                    if (!outcomeText && !descText) return;

                    // Score the outcome — anything with a real metric qualifies
                    const combined = outcomeText + ' ' + descText;
                    const hasMetric = /\$[\d,]+[MBK]?|\d+%|\d+x|\d+ times|million|billion/i.test(combined);
                    const hasResult = /retained|increased|reduced|improved|delivered|generated|achieved|enabled|saved|prevented|launched|built|founded|established/i.test(combined);

                    if (hasMetric || hasResult) {
                        // Build a combined display text: outcome is the headline, description adds context
                        const displayText = outcomeText
                            ? (descText ? `${outcomeText} (${descText.slice(0, 100)}${descText.length > 100 ? '…' : ''})` : outcomeText)
                            : descText;

                        outcomes.push({
                            text: displayText,
                            outcome: outcomeText,
                            description: descText,
                            skill: skill.name,
                            level: skill.level,
                            category: categorizeOutcome(skill.name, combined),
                            shared: !isSensitiveContent(combined), // sensitive items default to unshared
                            sensitive: isSensitiveContent(combined),
                            coachingSuggestion: generateCoachingFor(outcomeText || descText)
                        });
                    }
                });
            });

            // Also check legacy skillDetails (skill_evidence.json strings) — only if no skill-based outcomes found
            if (outcomes.length === 0) {
                const quantifiedPattern = /\$[\d,]+[MBK]?|\d+%|\d+ years?/gi;
                Object.entries(skillsData.skillDetails || {}).forEach(([skillName, details]) => {
                    if (!details.evidence) return;
                    details.evidence.forEach(evidenceItem => {
                        if (typeof evidenceItem !== 'string') return;
                        const hasQuantity = quantifiedPattern.test(evidenceItem);
                        if (hasQuantity) {
                            outcomes.push({
                                text: evidenceItem,
                                skill: skillName,
                                category: categorizeOutcome(skillName, evidenceItem),
                                shared: true,
                                sensitive: isSensitiveContent(evidenceItem),
                                coachingSuggestion: generateCoachingFor(evidenceItem)
                            });
                        }
                    });
                });
            }

            // Sort: unshared (sensitive) last, then by metric strength
            outcomes.sort((a, b) => {
                if (a.sensitive && !b.sensitive) return 1;
                if (!a.sensitive && b.sensitive) return -1;
                const scoreA = /\$[\d,]+[MBK]?/i.test(a.outcome||a.text) ? 2 : /\d+%/i.test(a.outcome||a.text) ? 1 : 0;
                const scoreB = /\$[\d,]+[MBK]?/i.test(b.outcome||b.text) ? 2 : /\d+%/i.test(b.outcome||b.text) ? 1 : 0;
                return scoreB - scoreA;
            });

            blueprintData.outcomes = outcomes;
        }
        
        function categorizeOutcome(skillName, evidence) {
            if (evidence.includes('$') || evidence.includes('revenue') || evidence.includes('sales')) return 'Business Impact';
            if (evidence.includes('predict') || evidence.includes('accuracy') || evidence.includes('%')) return 'Strategic Foresight';
            if (evidence.includes('emergency') || evidence.includes('crisis') || evidence.includes('zero')) return 'Crisis Leadership';
            if (evidence.includes('founded') || evidence.includes('built') || evidence.includes('created')) return 'Entrepreneurial';
            if (evidence.includes('published') || evidence.includes('speaker') || evidence.includes('featured')) return 'Thought Leadership';
            if (evidence.includes('recovery') || evidence.includes('sobriety') || evidence.includes('advocacy')) return 'Advocacy Impact';
            return 'Professional Achievement';
        }
        
        function isSensitiveContent(text) {
            const sensitiveKeywords = ['recovery', 'sobriety', 'addiction', 'Kyle', 'son', 'death', 'overdose', 'mental health'];
            return sensitiveKeywords.some(keyword => text.toLowerCase().includes(keyword));
        }
        
        function generateCoachingFor(outcome) {
            if (!outcome.includes('$') && !outcome.includes('%')) {
                return "Consider adding quantification: What was the measurable impact?";
            }
            if (!outcome.includes('client') && !outcome.includes('company') && !outcome.includes('people')) {
                return "Strengthen by adding: Who benefited from this outcome?";
            }
            if (outcome.length < 50) {
                return "Add context: What decision did this enable or what changed as a result?";
            }
            return null;
        }
        
        // ===== VALUES SYSTEM =====
        var VALUES_CATALOG = [
            { group: 'How I Think', values: [
                { name: 'Intellectual Honesty', keywords: ['integrity', 'honest', 'evidence', 'data', 'analy', 'research', 'rigor'], description: 'Following evidence wherever it leads, even when it challenges your own position.' },
                { name: 'Strategic Thinking', keywords: ['strateg', 'vision', 'foresight', 'roadmap', 'long-term', 'planning', 'framework'], description: 'Connecting present decisions to long-term outcomes others have not yet considered.' },
                { name: 'Curiosity', keywords: ['learn', 'curiosit', 'explor', 'research', 'discover', 'question', 'experiment'], description: 'Pursuing understanding for its own sake, not just when the job requires it.' },
                { name: 'Evidence-Based Decision Making', keywords: ['evidence', 'data', 'measur', 'metric', 'analy', 'research', 'validated'], description: 'Letting data settle debates that opinions cannot.' },
                { name: 'Systems Thinking', keywords: ['system', 'architect', 'integrat', 'complex', 'interdepend', 'holistic', 'scale'], description: 'Seeing how components interact across an entire system, not just the part in front of you.' }
            ]},
            { group: 'How I Lead', values: [
                { name: 'Accountability', keywords: ['account', 'responsib', 'own', 'deliver', 'commit', 'reliable', 'dependab'], description: 'Owning outcomes, not just tasks. Especially the ones that went wrong.' },
                { name: 'Servant Leadership', keywords: ['servant', 'mentor', 'coach', 'develop', 'empower', 'support', 'grow'], description: 'Measuring your success by the growth and readiness of the people around you.' },
                { name: 'Empowerment', keywords: ['empower', 'delegat', 'trust', 'autonom', 'enable', 'develop', 'grow'], description: 'Giving people the authority and resources to act, then getting out of their way.' },
                { name: 'Transparency', keywords: ['transparen', 'open', 'honest', 'candid', 'communicat', 'visible', 'share'], description: 'Sharing context freely so others can make informed decisions without you.' },
                { name: 'Courage', keywords: ['courag', 'bold', 'risk', 'challeng', 'spoke', 'stand', 'confront', 'difficult'], description: 'Saying the hard thing in the room when staying silent would be easier.' }
            ]},
            { group: 'How I Work', values: [
                { name: 'Excellence', keywords: ['excel', 'quality', 'precision', 'standard', 'best', 'outperform', 'world-class'], description: 'Setting a standard that makes good enough feel insufficient.' },
                { name: 'Resourcefulness', keywords: ['resourceful', 'creative', 'scrappy', 'bootstrap', 'efficien', 'lean', 'solve'], description: 'Finding a path forward when the obvious one is blocked.' },
                { name: 'Bias Toward Action', keywords: ['action', 'launch', 'ship', 'built', 'execut', 'deliver', 'implement', 'deploy'], description: 'Shipping something real rather than perfecting something theoretical.' },
                { name: 'Continuous Improvement', keywords: ['improv', 'optimi', 'iterat', 'refine', 'evolv', 'better', 'enhance'], description: 'Treating every process as a draft that can be rewritten.' },
                { name: 'Craftsmanship', keywords: ['craft', 'precision', 'detail', 'quality', 'artis', 'master', 'skill', 'technique'], description: 'Caring about the quality of work even when nobody is watching.' }
            ]},
            { group: 'How I Connect', values: [
                { name: 'Empathy', keywords: ['empathy', 'empathetic', 'understand', 'compassion', 'listen', 'perspective', 'human'], description: 'Understanding what someone needs before they have to explain it twice.' },
                { name: 'Collaboration', keywords: ['collaborat', 'partner', 'cross-functional', 'stakeholder', 'team', 'together', 'align'], description: 'Building shared ownership across boundaries that usually divide teams.' },
                { name: 'Trust', keywords: ['trust', 'reliab', 'credib', 'consistent', 'depend', 'faith', 'relationship'], description: 'Being the person others confide in because your word has always held.' },
                { name: 'Candor', keywords: ['candor', 'candid', 'direct', 'honest', 'feedback', 'frank', 'straightforward'], description: 'Delivering honest feedback as a form of respect, not confrontation.' },
                { name: 'Inclusion', keywords: ['inclusi', 'divers', 'equit', 'belong', 'access', 'representation', 'voice'], description: 'Making sure the quietest voice in the room is heard, not just the loudest.' }
            ]},
            { group: 'What I Protect', values: [
                { name: 'Integrity', keywords: ['integrity', 'ethical', 'principle', 'moral', 'honest', 'right', 'trust'], description: 'Doing the right thing when there is a personal cost to doing so.' },
                { name: 'Resilience', keywords: ['resilien', 'crisis', 'recover', 'adapt', 'persever', 'overcome', 'surviv', 'endur'], description: 'Converting setbacks into capabilities that did not exist before.' },
                { name: 'Authenticity', keywords: ['authentic', 'genuine', 'vulnerab', 'self-aware', 'real', 'true', 'honest'], description: 'Presenting yourself as you are, not as the audience expects.' },
                { name: 'Work-Life Boundaries', keywords: ['balance', 'boundar', 'sustain', 'wellbeing', 'health', 'burnout', 'life'], description: 'Protecting the conditions that let you sustain high performance over years, not weeks.' },
                { name: 'Purpose Over Profit', keywords: ['purpose', 'mission', 'impact', 'meaning', 'community', 'service', 'cause', 'foundation'], description: 'Choosing work that matters to people, not just to a balance sheet.' }
            ]}
        ];

        function saveValues() {
            try {
                localStorage.setItem('wbValues', JSON.stringify(blueprintData.values));
                localStorage.setItem('wbPurpose', blueprintData.purpose || '');
            } catch (e) { /* quota exceeded or private mode */ }
        }

        function loadSavedValues() {
            try {
                var stored = localStorage.getItem('wbValues');
                if (stored) return JSON.parse(stored);
            } catch (e) { /* parse error */ }
            return null;
        }

        function getEvidenceForValue(valueName) {
            var keywords = getKeywordsForValue(valueName);
            if (!keywords || keywords.length === 0) return [];
            var matches = [];
            var skills = (skillsData && skillsData.skills) || [];
            skills.forEach(function(skill) {
                (skill.evidence || []).forEach(function(ev) {
                    var text = ((ev.outcome || '') + ' ' + (ev.description || '')).toLowerCase();
                    var matched = keywords.some(function(kw) { return text.indexOf(kw) !== -1; });
                    if (matched) {
                        matches.push({ skill: skill.name, text: ev.outcome || ev.description || '' });
                    }
                });
            });
            return matches.slice(0, 3);
        }

        function getKeywordsForValue(name) {
            var n = name.toLowerCase();
            for (var g = 0; g < VALUES_CATALOG.length; g++) {
                for (var v = 0; v < VALUES_CATALOG[g].values.length; v++) {
                    if (VALUES_CATALOG[g].values[v].name.toLowerCase() === n) {
                        return VALUES_CATALOG[g].values[v].keywords;
                    }
                }
            }
            // Custom value: split name into keyword stems
            var result = [];
            n.split(/[\s\-]+/).forEach(function(w) {
                if (w.length > 3) result.push(w.substring(0, 6));
            });
            return result;
        }

        function scoreValueByEvidence(valueDef) {
            var skills = (skillsData && skillsData.skills) || [];
            var score = 0;
            skills.forEach(function(skill) {
                (skill.evidence || []).forEach(function(ev) {
                    var text = ((ev.outcome || '') + ' ' + (ev.description || '')).toLowerCase();
                    valueDef.keywords.forEach(function(kw) {
                        if (text.indexOf(kw) !== -1) score++;
                    });
                });
            });
            return score;
        }
        
        function getCatalogDescription(name) {
            var n = name.toLowerCase();
            for (var g = 0; g < VALUES_CATALOG.length; g++) {
                for (var v = 0; v < VALUES_CATALOG[g].values.length; v++) {
                    if (VALUES_CATALOG[g].values[v].name.toLowerCase() === n) {
                        return VALUES_CATALOG[g].values[v].description || '';
                    }
                }
            }
            return '';
        }
        
        function editValueNote(idx) {
            var value = blueprintData.values[idx];
            var currentNote = value.note || '';
            var modal = document.getElementById('exportModal');
            var modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Personal Note: ' + value.name + '</h2>'
                + '<p style="color:' + tv('#9ca3af','#64748b') + '; margin-top:5px;">Why does this value matter to you?</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<textarea id="valueNoteInput" placeholder="e.g., This shaped how I lead after watching top-down decisions fail repeatedly..." style="'
                + 'width:100%; min-height:100px; padding:14px; background:' + tv('rgba(255,255,255,0.05)','#fff') + '; '
                + 'border:1px solid ' + tv('rgba(96,165,250,0.3)','#d1d5db') + '; border-radius:8px; '
                + 'color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.95em; line-height:1.6; font-family:inherit; resize:vertical;'
                + '">' + currentNote + '</textarea>'
                + '<div style="margin-top:8px; font-size:0.78em; color:' + tv('#6b7280','#9ca3af') + ';">'
                + 'This note appears on your value card and in exported blueprints. Keep it concise.</div>'
                + '<div style="display:flex; gap:12px; justify-content:flex-end; margin-top:18px;">'
                + '<button onclick="closeExportModal()" style="'
                + 'background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.15)','#d1d5db') + '; '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">Cancel</button>'
                + '<button onclick="saveValueNote(' + idx + ')" style="'
                + 'background:' + tv('#1e40af','#2563eb') + '; color:#fff; border:none; '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + '\uD83D\uDCBE Save Note</button>'
                + '</div></div>';
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            setTimeout(function() { document.getElementById('valueNoteInput').focus(); }, 100);
        }
        window.editValueNote = editValueNote;
        
        function saveValueNote(idx) {
            var noteEl = document.getElementById('valueNoteInput');
            if (!noteEl) return;
            blueprintData.values[idx].note = noteEl.value.trim();
            saveUserData();
            saveValues();
            closeExportModal();
            var contentEl = document.getElementById('blueprintTabContent');
            if (contentEl) contentEl.innerHTML = renderBlueprintTabContent();
        }
        window.saveValueNote = saveValueNote;

        function inferValues() {
            // STEP 1: Check localStorage for saved edits
            var saved = loadSavedValues();
            if (saved && saved.length > 0) {
                blueprintData.values = saved;
            } else {
                // STEP 2: Use profile values if they exist
                var profileValues = userData.values || [];
                if (profileValues.length > 0) {
                    blueprintData.values = profileValues.map(function(v) {
                        return {
                            name: v.name,
                            selected: v.selected !== undefined ? v.selected : true,
                            inferred: v.inferred || false,
                            custom: false
                        };
                    });
                } else {
                    // STEP 3: Auto-select top 5 by evidence score
                    var scored = [];
                    VALUES_CATALOG.forEach(function(group) {
                        group.values.forEach(function(val) {
                            scored.push({ name: val.name, score: scoreValueByEvidence(val) });
                        });
                    });
                    scored.sort(function(a, b) { return b.score - a.score; });
                    var topNames = scored.slice(0, 5).filter(function(s) { return s.score > 0; }).map(function(s) { return s.name; });
                    
                    // If no evidence at all, select sensible defaults
                    if (topNames.length === 0) {
                        topNames = ['Intellectual Honesty', 'Accountability', 'Excellence', 'Collaboration', 'Integrity'];
                    }
                    
                    blueprintData.values = topNames.map(function(n) {
                        return { name: n, selected: true, inferred: true, custom: false };
                    });
                }
            }
            
            // Purpose
            var savedPurpose = null;
            try { savedPurpose = localStorage.getItem('wbPurpose'); } catch(e) {}
            if (savedPurpose !== null && savedPurpose.trim().length > 0) {
                blueprintData.purpose = savedPurpose;
            } else if (userData.purpose && userData.purpose.trim().length > 0) {
                blueprintData.purpose = userData.purpose;
            } else {
                blueprintData.purpose = "";
            }
        }

        var showingValuesPicker = false;
        
        let blueprintTab = 'outcomes';
        
        function renderBlueprint() {
            const view = document.getElementById('blueprintView');
            const outcomesCount = blueprintData.outcomes.length;
            const valuesCount = blueprintData.values.filter(v => v.selected).length;
            
            view.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-header">
                        <h1 class="blueprint-title">Blueprint</h1>
                        
                    </div>
                    
                    ${renderMarketValuationSection()}
                    
                    <div class="blueprint-subnav" id="blueprintSubnav">
                        <button class="bp-tab ${blueprintTab === 'outcomes' ? 'active' : ''}" onclick="switchBlueprintTab('outcomes')">
                            <span class="bp-tab-icon">&#x1F4CA;</span>
                            <span class="bp-tab-label">Outcomes</span>
                            <span class="bp-tab-count">${outcomesCount}</span>
                        </button>
                        <button class="bp-tab ${blueprintTab === 'values' ? 'active' : ''}" onclick="switchBlueprintTab('values')">
                            <span class="bp-tab-icon">&#x2B50;</span>
                            <span class="bp-tab-label">Values</span>
                            <span class="bp-tab-count">${valuesCount}</span>
                        </button>
                        <button class="bp-tab ${blueprintTab === 'purpose' ? 'active' : ''}" onclick="switchBlueprintTab('purpose')">
                            <span class="bp-tab-icon">&#x1F3AF;</span>
                            <span class="bp-tab-label">Purpose</span>
                        </button>
                        <button class="bp-tab ${blueprintTab === 'export' ? 'active' : ''}" onclick="switchBlueprintTab('export')">
                            <span class="bp-tab-icon">&#x1F4E4;</span>
                            <span class="bp-tab-label">Export</span>
                        </button>
                    </div>
                    
                    <div id="blueprintTabContent">
                        ${renderBlueprintTabContent()}
                    </div>
                </div>
            `;
        }
        
        function switchBlueprintTab(tab) {
            blueprintTab = tab;
            document.querySelectorAll('.bp-tab').forEach(function(btn) {
                var onclickStr = btn.getAttribute('onclick') || '';
                btn.classList.toggle('active', onclickStr.indexOf("'" + tab + "'") !== -1);
            });
            var contentEl = document.getElementById('blueprintTabContent');
            if (contentEl) contentEl.innerHTML = renderBlueprintTabContent();
        }
        window.switchBlueprintTab = switchBlueprintTab;
        
        function renderBlueprintTabContent() {
            if (blueprintTab === 'outcomes') return renderOutcomesSection();
            if (blueprintTab === 'values')   return renderValuesSection();
            if (blueprintTab === 'purpose')  return renderPurposeSection();
            if (blueprintTab === 'export')   return renderExportSection();
            return renderOutcomesSection();
        }
        
        // Theme-aware color helper for inline styles
        function tv(darkVal, lightVal) {
            return document.documentElement.getAttribute('data-theme') === 'light' ? lightVal : darkVal;
        }
        // Theme-aware background helper
        function tb(darkBg, lightBg) {
            return document.documentElement.getAttribute('data-theme') === 'light' ? lightBg : darkBg;
        }

        function renderMarketValuationSection() {
            const totalValue = calculateTotalMarketValue();
            
            if (!totalValue || totalValue.total === 0 || !skillValuations || Object.keys(skillValuations.skillBaseValues || {}).length === 0) {
                return ''; // Don't show if data not loaded
            }
            
            const negotiationGap = totalValue.yourWorth - totalValue.standardOffer;
            
            return `
                <div class="blueprint-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(96, 165, 250, 0.1) 100%); border: 2px solid rgba(16, 185, 129, 0.3); margin-bottom: 30px;">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">💰</span>
                            <span>Your Market Valuation</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 30px 20px;">
                        <div style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">
                            Your Market Worth
                        </div>
                        <div style="font-size: 3em; font-weight: 700; color: #10b981; margin-bottom: 10px;">
                            $${totalValue.yourWorth.toLocaleString()}<span style="font-size: 0.4em; color: ${tv("#9ca3af","#64748b")};">/year</span>
                        </div>
                        <div style="color: ${tv("#d1d5db","#334155")}; font-size: 1em; margin-bottom: 8px;">
                            ${totalValue.roleLevel} Level • ${totalValue.compaRatio}% of Market Median
                        </div>
                        <div style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.9em; margin-bottom: 30px;">
                            Based on top 10 skills • ${userData.profile.location}
                        </div>
                        
                        <div style="background: ${tb("rgba(255,255,255,0.03)","rgba(0,0,0,0.03)")}; padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 15px; text-align: left;">📊 EXPECTED OFFER RANGES (Compa-Ratio Model)</div>
                            <div style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.85em; margin-bottom: 20px; text-align: left;">
                                Companies typically offer 75-95% of market value. You negotiate within this range.
                            </div>
                            
                            <div style="display: grid; gap: 12px;">
                                <div style="background: ${tb("rgba(107,114,128,0.2)","rgba(107,114,128,0.12)")}; padding: 15px; border-radius: 8px; border-left: 3px solid #9ca3af; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: ${tv("#9ca3af","#64748b")}; font-weight: 600; margin-bottom: 3px;">Conservative Offer (75%)</div>
                                            <div style="color: ${tv("#d1d5db","#334155")}; font-size: 0.85em;">Budget-constrained companies</div>
                                        </div>
                                        <div style="color: ${tv("#e0e0e0","#1e293b")}; font-size: 1.3em; font-weight: 700;">$${totalValue.conservativeOffer.toLocaleString()}</div>
                                    </div>
                                </div>
                                
                                <div style="background: ${tb("rgba(96,165,250,0.2)","rgba(37,99,235,0.12)")}; padding: 15px; border-radius: 8px; border-left: 3px solid #60a5fa; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 3px;">Standard Offer (85%)</div>
                                            <div style="color: ${tv("#d1d5db","#334155")}; font-size: 0.85em;">Most common initial offers</div>
                                        </div>
                                        <div style="color: ${tv("#e0e0e0","#1e293b")}; font-size: 1.3em; font-weight: 700;">$${totalValue.standardOffer.toLocaleString()}</div>
                                    </div>
                                </div>
                                
                                <div style="background: ${tb("rgba(16,185,129,0.2)","rgba(5,150,105,0.12)")}; padding: 15px; border-radius: 8px; border-left: 3px solid #10b981; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #10b981; font-weight: 600; margin-bottom: 3px;">Competitive Offer (95%)</div>
                                            <div style="color: ${tv("#d1d5db","#334155")}; font-size: 0.85em;">Top companies competing for talent</div>
                                        </div>
                                        <div style="color: ${tv("#e0e0e0","#1e293b")}; font-size: 1.3em; font-weight: 700;">$${totalValue.competitiveOffer.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: ${tb("rgba(251,191,36,0.2)","rgba(217,119,6,0.12)")}; border-radius: 8px; text-align: left;">
                                <div style="color: #fbbf24; font-weight: 600; margin-bottom: 5px;">💡 Your Negotiation Gap: $${negotiationGap.toLocaleString()}</div>
                                <div style="color: ${tv("#d1d5db","#334155")}; font-size: 0.9em;">
                                    Between standard offer ($${totalValue.standardOffer.toLocaleString()}) and your worth ($${totalValue.yourWorth.toLocaleString()}). This is your leverage.
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; max-width: 800px; margin: 0 auto 25px;">
                            <div style="background: ${tb("rgba(255,255,255,0.05)","rgba(0,0,0,0.04)")}; padding: 18px; border-radius: 10px;">
                                <div style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.85em; margin-bottom: 5px;">Market Rate (${totalValue.percentile} %ile)</div>
                                <div style="color: #60a5fa; font-size: 1.3em; font-weight: 700;">$${totalValue.marketRate.toLocaleString()}</div>
                            </div>
                            <div style="background: ${tb("rgba(255,255,255,0.05)","rgba(0,0,0,0.04)")}; padding: 18px; border-radius: 10px;">
                                <div style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.85em; margin-bottom: 5px;">Your Premium</div>
                                <div style="color: #10b981; font-size: 1.3em; font-weight: 700;">+$${totalValue.premiumAmount.toLocaleString()}</div>
                                <div style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.75em; margin-top: 3px;">+${Math.round(((totalValue.yourWorth - totalValue.marketRate) / totalValue.marketRate) * 100)}%</div>
                            </div>
                            <div style="background: ${tb("rgba(255,255,255,0.05)","rgba(0,0,0,0.04)")}; padding: 18px; border-radius: 10px;">
                                <div style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.85em; margin-bottom: 5px;">Compa-Ratio</div>
                                <div style="color: ${tv("#e0e0e0","#1e293b")}; font-size: 1.3em; font-weight: 700;">${totalValue.compaRatio}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: ${tb("rgba(96,165,250,0.1)","rgba(37,99,235,0.07)")}; padding: 20px; border-radius: 8px; margin: 20px;">
                        <div style="color: #60a5fa; font-weight: 600; margin-bottom: 10px;">🎯 How This Was Calculated</div>
                        <div style="color: ${tv("#d1d5db","#334155")}; font-size: 0.95em; line-height: 1.6;">
                            <strong>Method:</strong> Impact-based role tier + skill premiums
                            <br><br>
                            <strong>Base Market Rate:</strong> $${totalValue.marketRate.toLocaleString()} (${totalValue.roleLevel} level, ${totalValue.percentile} percentile)
                            <br><strong>Critical Impact Skills (${totalValue.criticalSkills.length}):</strong> +$${totalValue.criticalBonus.toLocaleString()}
                            <br><strong>High Impact Skills (${totalValue.highSkills.length}):</strong> +$${totalValue.highBonus.toLocaleString()}
                            <br><strong>Rare Skill Combinations:</strong> +$${totalValue.rarityBonus.toLocaleString()}
                            <br><strong>Location:</strong> ${userData.profile.location} (×${skillValuations.locationMultipliers[userData.profile.location] || 1.0})
                            <br><br>
                            <strong>Your Worth:</strong> $${totalValue.yourWorth.toLocaleString()} (${Math.round(((totalValue.yourWorth - totalValue.marketRate) / totalValue.marketRate) * 100)}% above market)
                        </div>
                    </div>
                    
                    <div style="margin: 20px;">
                        <div style="color: #60a5fa; font-weight: 600; margin-bottom: 15px;">🔥 Top 10 Skills Used in Calculation:</div>
                        <div style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.85em; margin-bottom: 12px;">
                            Roles typically require 10-15 core skills, not all ${skillsData.skills.length}. These are your highest impact:
                        </div>
                        <div style="display: grid; gap: 8px;">
                            ${totalValue.top10Skills.map((skill, idx) => {
                                const isCritical = skill.impact === 'Critical';
                                return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${isCritical ? 'rgba(239, 68, 68, 0.15)' : 'rgba(251, 191, 36, 0.15)'}; border-radius: 6px; border-left: 3px solid ${isCritical ? '#ef4444' : '#fbbf24'};">
                                    <div>
                                        <span style="color: ${tv("#9ca3af","#64748b")}; font-weight: 600; margin-right: 8px;">${idx + 1}.</span>
                                        <span style="color: ${tv("#e0e0e0","#1e293b")};">${skill.skill}</span>
                                        <span style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.85em; margin-left: 8px;">(${skill.level})</span>
                                    </div>
                                    <div style="color: ${isCritical ? '#ef4444' : '#fbbf24'}; font-weight: 600; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px;">
                                        ${isCritical ? '⭐' : '🔥'} ${skill.impactLabel}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        <div style="color: ${tv("#9ca3af","#64748b")}; font-size: 0.8em; margin-top: 12px; font-style: italic;">
                            Note: Impact ratings show relative strategic value. Compensation based on combined skill portfolio + role tier.
                        </div>
                    </div>
                    
                    <div style="margin: 20px; padding: 20px; background: ${tb("rgba(251,191,36,0.1)","rgba(217,119,6,0.08)")}; border-left: 3px solid #fbbf24; border-radius: 4px;">
                        <div style="color: #fbbf24; font-weight: 600; margin-bottom: 10px;">💼 USING THIS IN NEGOTIATIONS</div>
                        <div style="color: ${tv("#d1d5db","#334155")}; font-size: 0.9em; line-height: 1.8;">
                            <strong>The Strategy:</strong>
                            <br>• Companies typically offer 75-90% of target range
                            <br>• You negotiate to 90-110% based on your skill profile
                            <br>• Your ${totalValue.criticalSkills.length} Critical Impact skills justify premium positioning
                            <br>• Combined with ${totalValue.highSkills.length} High Impact skills, you're in top competitive tier
                            <br><br>
                            <strong>Reference Your Top 10 Skills:</strong> These demonstrate why you command premium compensation above standard offers for ${totalValue.roleLevel} roles
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin: 20px; flex-wrap: wrap;">
                        <button class="export-btn-large" onclick="showValuationBreakdown()" style="flex: 1; min-width: 200px;">
                            📊 View All ${skillsData.skills.length} Skills
                        </button>
                        <button class="export-btn-large" onclick="openSkillManagement()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; color: white;">
                            📊 Manage Skills
                        </button>
                        <button class="export-btn-large" onclick="openCustomSkillBuilder()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; color: white;">
                            ⭐ Create Custom Skill
                        </button>
                        </button>
                        <button class="export-btn-large" onclick="showNegotiationGuide()" style="flex: 1; min-width: 200px; background: ${tb("rgba(251,191,36,0.2)","rgba(217,119,6,0.12)")}; border-color: #fbbf24; color: #fbbf24;">
                            💼 Detailed Negotiation Guide
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderOutcomesSection() {
            const outcomes = blueprintData.outcomes;
            
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">📊</span>
                            <span>Outcomes I Drive</span>
                            <span class="section-count">${outcomes.length}</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            💡 COACHING TIP
                        </div>
                        <div class="coaching-tip-content">
                            Top performers quantify impact. Notice the pattern:
                            <ul>
                                <li><strong>Numbers:</strong> $200M, 85%, 5 years, zero injuries</li>
                                <li><strong>Comparisons:</strong> "5 years early", "before market consensus"</li>
                                <li><strong>Consequences:</strong> What changed because of this?</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="outcomesContainer">
                        ${outcomes.map((outcome, idx) => renderOutcomeItem(outcome, idx)).join('')}
                    </div>
                    
                    <button class="add-outcome-btn" onclick="addCustomOutcome()">
                        <span>➕</span>
                        <span>Add Custom Outcome</span>
                    </button>
                    
                    <div class="reflection-prompts">
                        <div class="reflection-title">💭 REFLECTION PROMPTS</div>
                        <ul>
                            <li>What problem did you solve that others couldn't?</li>
                            <li>What changed because of your work?</li>
                            <li>What would have happened without you?</li>
                            <li>How do you know this worked? (proof/evidence)</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function renderOutcomeItem(outcome, idx) {
            const shareChecked = outcome.shared ? 'checked' : '';
            const sensitiveWarning = outcome.sensitive ? 
                '<span class="meta-tag sensitive">⚠️ SENSITIVE: Consider context before sharing</span>' : '';
            const coachingNote = outcome.coachingSuggestion ? 
                `<div class="outcome-coaching">💡 ${outcome.coachingSuggestion}</div>` : '';
            
            return `
                <div class="outcome-item" data-idx="${idx}">
                    <div class="outcome-header">
                        <div class="outcome-text">${outcome.text}</div>
                        <div class="outcome-controls">
                            <label class="share-toggle">
                                <input type="checkbox" ${shareChecked} onchange="toggleOutcomeShare(${idx})">
                                <span class="share-toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="outcome-meta">
                        <span class="meta-tag category">📂 ${outcome.category}</span>
                        <span class="meta-tag evidence">✓ From: ${outcome.skill}</span>
                        ${sensitiveWarning}
                    </div>
                    
                    ${coachingNote}
                    
                    <div class="outcome-actions">
                        <button class="outcome-btn" onclick="editOutcome(${idx})">✎ Edit</button>
                        <button class="outcome-btn" onclick="viewOutcomeEvidence(${idx})">🔍 View Evidence</button>
                    </div>
                </div>
            `;
        }
        
        function renderValuesSection() {
            var values = blueprintData.values;
            var selectedCount = values.filter(function(v) { return v.selected; }).length;
            
            var html = '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">\u2B50</span>'
                + '<span>Values & Principles</span>'
                + '<span class="section-count">' + selectedCount + ' selected</span>'
                + '</div>'
                + '</div>';
            
            if (showingValuesPicker) {
                html += renderValuesPicker();
            } else {
                html += renderSelectedValues();
            }
            
            html += '</div>';
            return html;
        }
        
        function renderSelectedValues() {
            var values = blueprintData.values;
            var selectedCount = values.filter(function(v) { return v.selected; }).length;
            
            var html = '<div class="coaching-tip">'
                + '<div class="coaching-tip-title">\uD83D\uDCA1 YOUR CORE VALUES</div>'
                + '<div class="coaching-tip-content">'
                + (selectedCount === 0
                    ? 'You haven\u2019t selected any values yet. Use the picker below to choose 3-7 that represent how you operate.'
                    : 'These are the values you operate by. Add a personal note to explain why each matters to you.')
                + '</div>'
                + '</div>';
            
            // Selected values as compact cards
            if (values.length > 0) {
                html += '<div class="values-grid">';
                values.forEach(function(value, idx) {
                    var evidence = getEvidenceForValue(value.name);
                    var evCount = evidence.length;
                    var catalogDesc = getCatalogDescription(value.name);
                    
                    html += '<div class="value-card selected" style="position:relative;">';
                    
                    // Controls
                    html += '<div style="position:absolute; top:8px; right:8px; display:flex; gap:3px; opacity:0.45;" '
                        + 'onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.45">';
                    if (idx > 0) {
                        html += '<button onclick="event.stopPropagation(); moveValue(' + idx + ',-1)" title="Move up" style="'
                            + 'background:none; border:none; cursor:pointer; font-size:0.75em; color:' + tv('#9ca3af','#64748b') + '; padding:2px 4px;">\u25B2</button>';
                    }
                    if (idx < values.length - 1) {
                        html += '<button onclick="event.stopPropagation(); moveValue(' + idx + ',1)" title="Move down" style="'
                            + 'background:none; border:none; cursor:pointer; font-size:0.75em; color:' + tv('#9ca3af','#64748b') + '; padding:2px 4px;">\u25BC</button>';
                    }
                    html += '<button onclick="event.stopPropagation(); removeSelectedValue(' + idx + ')" title="Remove" style="'
                        + 'background:none; border:none; cursor:pointer; font-size:0.9em; color:' + tv('#9ca3af','#64748b') + '; padding:2px 4px;">\u00D7</button>';
                    html += '</div>';
                    
                    html += '<div class="value-title">' + value.name + '</div>';
                    
                    // Description from catalog
                    if (catalogDesc) {
                        html += '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + '; line-height:1.45; margin-top:4px;">'
                            + catalogDesc + '</div>';
                    }
                    
                    // Badges
                    html += '<div style="display:flex; gap:5px; flex-wrap:wrap; margin-top:6px;">';
                    if (value.inferred) {
                        html += '<span style="font-size:0.7em; padding:2px 7px; border-radius:10px; '
                            + 'background:' + tv('rgba(16,185,129,0.12)','rgba(16,185,129,0.08)') + '; '
                            + 'color:#10b981;">Evidence-matched</span>';
                    }
                    if (value.custom) {
                        html += '<span style="font-size:0.7em; padding:2px 7px; border-radius:10px; '
                            + 'background:' + tv('rgba(139,92,246,0.12)','rgba(139,92,246,0.08)') + '; '
                            + 'color:#a78bfa;">Custom</span>';
                    }
                    if (evCount > 0) {
                        html += '<span style="font-size:0.7em; padding:2px 7px; border-radius:10px; '
                            + 'background:' + tv('rgba(251,191,36,0.12)','rgba(251,191,36,0.08)') + '; '
                            + 'color:#f59e0b;">' + evCount + ' evidence</span>';
                    }
                    html += '</div>';
                    
                    // Personal note (editable)
                    if (value.note) {
                        html += '<div style="margin-top:8px; padding:8px 10px; border-radius:6px; '
                            + 'background:' + tv('rgba(96,165,250,0.06)','rgba(30,64,175,0.04)') + '; '
                            + 'border-left:2px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + ';">'
                            + '<div style="font-size:0.76em; color:' + tv('#d1d5db','#475569') + '; line-height:1.45; font-style:italic;">'
                            + '\u201C' + value.note + '\u201D</div>'
                            + '<button onclick="event.stopPropagation(); editValueNote(' + idx + ')" style="'
                            + 'background:none; border:none; font-size:0.7em; color:' + tv('#60a5fa','#2563eb') + '; cursor:pointer; margin-top:4px; padding:0;">Edit note</button>'
                            + '</div>';
                    } else {
                        html += '<button onclick="event.stopPropagation(); editValueNote(' + idx + ')" style="'
                            + 'background:none; border:1px dashed ' + tv('rgba(96,165,250,0.25)','rgba(30,64,175,0.15)') + '; '
                            + 'color:' + tv('#6b7280','#9ca3af') + '; font-size:0.73em; padding:5px 10px; border-radius:5px; '
                            + 'cursor:pointer; margin-top:8px; width:100%; text-align:left;">+ Add a personal note</button>';
                    }
                    
                    // Evidence preview
                    if (evCount > 0) {
                        html += '<div style="margin-top:8px; padding-top:7px; border-top:1px solid '
                            + tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.06)') + ';">'
                            + '<div style="font-size:0.76em; color:' + tv('#6b7280','#9ca3af') + '; font-style:italic; line-height:1.4;">'
                            + '\u201C' + evidence[0].text.substring(0, 90) + (evidence[0].text.length > 90 ? '\u2026' : '') + '\u201D'
                            + '<span style="color:' + tv('#60a5fa','#2563eb') + '; font-style:normal; margin-left:5px;">\u2014 ' + evidence[0].skill + '</span>'
                            + '</div></div>';
                    }
                    
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Action buttons
            html += '<div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:18px;">'
                + '<button onclick="toggleValuesPicker()" style="'
                + 'background:' + tv('rgba(96,165,250,0.12)','rgba(30,64,175,0.08)') + '; '
                + 'border:1px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + '; '
                + 'color:' + tv('#60a5fa','#1e40af') + '; '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em; font-weight:600;'
                + '">' + (values.length === 0 ? '\u2B50 Choose Your Values' : '+ Add / Change Values') + '</button>'
                + '<button onclick="showAddCustomValueForm()" style="'
                + 'background:transparent; '
                + 'border:1px dashed ' + tv('rgba(139,92,246,0.4)','rgba(139,92,246,0.3)') + '; '
                + 'color:' + tv('#a78bfa','#7c3aed') + '; '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;'
                + '">+ Custom Value</button>'
                + '</div>';
            
            // Inline custom value form (hidden)
            html += '<div id="addValueForm" style="display:none; margin-top:16px; padding:20px; '
                + 'background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; '
                + 'border:1px solid ' + tv('rgba(139,92,246,0.3)','rgba(139,92,246,0.2)') + '; border-radius:10px;">'
                + '<input id="newValueName" placeholder="Value name (e.g., Radical Transparency)" style="'
                + 'width:100%; padding:10px 14px; margin-bottom:12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid ' + tv('rgba(255,255,255,0.15)','#d1d5db') + '; border-radius:6px; '
                + 'color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.95em;" />'
                + '<div style="display:flex; gap:8px;">'
                + '<button onclick="addCustomValue()" style="'
                + 'background:' + tv('#7c3aed','#6d28d9') + '; color:#fff; border:none; padding:8px 18px; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.88em;">'
                + 'Add</button>'
                + '<button onclick="hideAddValueForm()" style="'
                + 'background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','#d1d5db') + '; '
                + 'padding:8px 18px; border-radius:6px; cursor:pointer; font-size:0.88em;">'
                + 'Cancel</button>'
                + '</div></div>';
            
            return html;
        }
        
        function renderValuesPicker() {
            var selectedNames = {};
            blueprintData.values.forEach(function(v) { selectedNames[v.name] = true; });
            
            var html = '<div class="coaching-tip">'
                + '<div class="coaching-tip-title">\uD83D\uDCA1 PICK 3-7 VALUES</div>'
                + '<div class="coaching-tip-content">'
                + 'Tap values that resonate with how you actually work. Values with evidence in your profile are highlighted.'
                + '</div>'
                + '</div>';
            
            VALUES_CATALOG.forEach(function(group) {
                html += '<div style="margin-bottom:20px;">'
                    + '<div style="font-size:0.82em; font-weight:700; text-transform:uppercase; letter-spacing:0.08em; '
                    + 'color:' + tv('#6b7280','#9ca3af') + '; margin-bottom:10px; padding-left:2px;">'
                    + group.group + '</div>'
                    + '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
                
                group.values.forEach(function(val) {
                    var isSelected = selectedNames[val.name] || false;
                    var evScore = scoreValueByEvidence(val);
                    var hasEvidence = evScore > 0;
                    
                    var bg, border, color;
                    if (isSelected) {
                        bg = tv('rgba(96,165,250,0.2)','rgba(30,64,175,0.12)');
                        border = tv('rgba(96,165,250,0.6)','rgba(30,64,175,0.4)');
                        color = tv('#93c5fd','#1e40af');
                    } else if (hasEvidence) {
                        bg = tv('rgba(16,185,129,0.08)','rgba(16,185,129,0.05)');
                        border = tv('rgba(16,185,129,0.25)','rgba(16,185,129,0.15)');
                        color = tv('#d1d5db','#334155');
                    } else {
                        bg = tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)');
                        border = tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)');
                        color = tv('#9ca3af','#64748b');
                    }
                    
                    html += '<button onclick="pickValue(\'' + val.name.replace(/'/g, "\\'") + '\')" title="' + (val.description || '').replace(/"/g, '&quot;') + '" style="'
                        + 'background:' + bg + '; border:1.5px solid ' + border + '; color:' + color + '; '
                        + 'padding:8px 16px; border-radius:20px; cursor:pointer; font-size:0.88em; '
                        + 'font-weight:' + (isSelected ? '700' : '500') + '; transition:all 0.15s ease;">'
                        + (isSelected ? '\u2713 ' : '')
                        + val.name
                        + (hasEvidence && !isSelected ? ' \u2022' : '')
                        + '</button>';
                });
                
                html += '</div></div>';
            });
            
            // Done button
            var count = blueprintData.values.filter(function(v) { return v.selected; }).length;
            html += '<div style="margin-top:16px; display:flex; gap:10px; align-items:center;">'
                + '<button onclick="toggleValuesPicker()" style="'
                + 'background:' + tv('#1e40af','#2563eb') + '; color:#fff; border:none; '
                + 'padding:10px 24px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.92em;">'
                + 'Done (' + count + ' selected)</button>'
                + '<span style="font-size:0.82em; color:' + tv('#6b7280','#9ca3af') + ';">'
                + '\u2022 = evidence in your profile'
                + '</span>'
                + '</div>';
            
            return html;
        }
        
        function renderPurposeSection() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">🎯</span>
                            <span>Purpose Statement</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            💡 YOUR "WHY"
                        </div>
                        <div class="coaching-tip-content">
                            This statement is inferred from your work and advocacy. Edit to make it yours.
                            Strong purpose statements connect what you do to why it matters.
                        </div>
                    </div>
                    
                    <textarea class="purpose-editor" onchange="updatePurpose(this.value)">${blueprintData.purpose}</textarea>
                </div>
            `;
        }
        
        function renderExportSection() {
            const sharedOutcomes = blueprintData.outcomes.filter(o => o.shared).length;
            const sharedValues = blueprintData.values.filter(v => v.selected).length;
            const skillCount = (skillsData.skills || []).length;
            
            return '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">\uD83D\uDCE4</span>'
                + '<span>Export Your Blueprint</span>'
                + '</div>'
                + '</div>'
                + '<div class="coaching-tip">'
                + '<div class="coaching-tip-title">\uD83D\uDCA1 CHOOSE YOUR FORMAT</div>'
                + '<div class="coaching-tip-content">'
                + 'Currently sharing <strong>' + sharedOutcomes + ' outcomes</strong>, '
                + '<strong>' + sharedValues + ' values</strong>, '
                + '<strong>' + skillCount + ' skills</strong>, '
                + 'and your purpose statement. Adjust selections in the Outcomes and Values tabs.'
                + '</div>'
                + '</div>'
                + '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:16px; margin-top:20px;">'
                // Executive Blueprint card (featured)
                + '<div style="grid-column:1/-1; background:linear-gradient(135deg, rgba(30,64,175,0.15), rgba(96,165,250,0.1)); border:2px solid ' + tv('rgba(96,165,250,0.4)','rgba(30,64,175,0.3)') + '; border-radius:12px; padding:24px; cursor:pointer;" onclick="generateWorkBlueprint()">'
                + '<div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">'
                + '<span style="font-size:1.8em;">\uD83C\uDFAF</span>'
                + '<div>'
                + '<div style="font-size:1.15em; font-weight:700; color:' + tv('#60a5fa','#1e40af') + ';">Executive Blueprint</div>'
                + '<div style="font-size:0.85em; color:' + tv('#9ca3af','#64748b') + ';">Recommended for recruiters and hiring managers</div>'
                + '</div>'
                + '</div>'
                + '<div style="color:' + tv('#d1d5db','#334155') + '; font-size:0.92em; line-height:1.55;">'
                + 'Standalone HTML document with editorial design. Includes executive summary, top competencies, strategic outcomes, values, compensation framework, and career narrative. Opens in any browser, prints beautifully.'
                + '</div>'
                + '<div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">'
                + '<span style="font-size:0.75em; padding:3px 10px; border-radius:20px; background:' + tv('rgba(16,185,129,0.15)','rgba(16,185,129,0.1)') + '; color:#10b981;">HTML</span>'
                + '<span style="font-size:0.75em; padding:3px 10px; border-radius:20px; background:' + tv('rgba(96,165,250,0.15)','rgba(96,165,250,0.1)') + '; color:#60a5fa;">Print to PDF</span>'
                + '<span style="font-size:0.75em; padding:3px 10px; border-radius:20px; background:' + tv('rgba(251,191,36,0.15)','rgba(251,191,36,0.1)') + '; color:#f59e0b;">Email Attachment</span>'
                + '</div>'
                + '</div>'
                // Resume card
                + '<div style="background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.1)') + '; border-radius:12px; padding:20px; cursor:pointer;" onclick="generateResume()">'
                + '<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">'
                + '<span style="font-size:1.4em;">\uD83D\uDCC4</span>'
                + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1f2937') + ';">Professional Resume</div>'
                + '</div>'
                + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.88em; line-height:1.5;">'
                + 'Traditional resume format with skills, experience, and achievements. HTML file, print to PDF.'
                + '</div>'
                + '</div>'
                // PDF Summary card
                + '<div style="background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.1)') + '; border-radius:12px; padding:20px; cursor:pointer;" onclick="exportBlueprint(\u0027pdf\u0027)">'
                + '<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">'
                + '<span style="font-size:1.4em;">\uD83D\uDCD1</span>'
                + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1f2937') + ';">PDF Summary</div>'
                + '</div>'
                + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.88em; line-height:1.5;">'
                + 'Compact one-to-two page PDF. Outcomes, values, purpose, skills summary, and market context.'
                + '</div>'
                + '</div>'
                // Copy to Clipboard card
                + '<div style="background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.1)') + '; border-radius:12px; padding:20px; cursor:pointer;" onclick="copyBlueprintText()">'
                + '<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">'
                + '<span style="font-size:1.4em;">\uD83D\uDCCB</span>'
                + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1f2937') + ';">Copy to Clipboard</div>'
                + '</div>'
                + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.88em; line-height:1.5;">'
                + 'Plain text summary for pasting into emails, messages, or cover letters.'
                + '</div>'
                + '</div>'
                // JSON card
                + '<div style="background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.1)') + '; border-radius:12px; padding:20px; cursor:pointer;" onclick="exportBlueprint(\u0027json\u0027)">'
                + '<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">'
                + '<span style="font-size:1.4em;">\uD83D\uDCBE</span>'
                + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1f2937') + ';">JSON Data</div>'
                + '</div>'
                + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.88em; line-height:1.5;">'
                + 'Structured data export. Use for backups, imports, or integration with other tools.'
                + '</div>'
                + '</div>'
                + '</div>'

                // === JOB-SPECIFIC TOOLS SECTION ===
                + (function() {
                    var jobs = userData.savedJobs || [];
                    if (jobs.length === 0) return '';
                    return '<div style="margin-top:32px; padding-top:24px; border-top:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.08)') + ';">'
                    + '<div style="font-size:0.8em; text-transform:uppercase; letter-spacing:1.5px; color:var(--text-muted); margin-bottom:16px;">Job-Specific Tools</div>'
                    + '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:16px;">'
                    // Cover Letter card
                    + '<div style="background:linear-gradient(135deg, rgba(16,185,129,0.12), rgba(16,185,129,0.04)); border:1px solid rgba(16,185,129,0.25); border-radius:12px; padding:20px; cursor:pointer;" onclick="generateCoverLetter()">'
                    + '<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">'
                    + '<span style="font-size:1.4em;">\u2709\uFE0F</span>'
                    + '<div style="font-weight:600; color:#10b981;">Cover Letter</div>'
                    + '</div>'
                    + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.88em; line-height:1.5;">'
                    + 'AI-generated cover letter tailored to a saved job. Uses your matched skills, outcomes, and values.'
                    + '</div>'
                    + '</div>'
                    // Interview Prep card
                    + '<div style="background:linear-gradient(135deg, rgba(251,191,36,0.12), rgba(251,191,36,0.04)); border:1px solid rgba(251,191,36,0.25); border-radius:12px; padding:20px; cursor:pointer;" onclick="generateInterviewPrep()">'
                    + '<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">'
                    + '<span style="font-size:1.4em;">\uD83C\uDFAF</span>'
                    + '<div style="font-weight:600; color:#fbbf24;">Interview Prep</div>'
                    + '</div>'
                    + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.88em; line-height:1.5;">'
                    + 'STAR stories for matched skills, bridging language for gaps, and talking points for your strengths.'
                    + '</div>'
                    + '</div>'
                    + '</div></div>';
                })()

                // === NETWORKING TOOLS SECTION ===
                + '<div style="margin-top:32px; padding-top:24px; border-top:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.08)') + ';">'
                + '<div style="font-size:0.8em; text-transform:uppercase; letter-spacing:1.5px; color:var(--text-muted); margin-bottom:16px;">Networking &amp; Profile</div>'
                + '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:16px;">'
                // LinkedIn Profile card
                + '<div style="background:linear-gradient(135deg, rgba(10,102,194,0.12), rgba(10,102,194,0.04)); border:1px solid rgba(10,102,194,0.25); border-radius:12px; padding:20px; cursor:pointer;" onclick="generateLinkedInProfile()">'
                + '<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">'
                + '<span style="font-size:1.4em;">\uD83D\uDD17</span>'
                + '<div style="font-weight:600; color:#0a66c2;">LinkedIn Profile</div>'
                + '</div>'
                + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.88em; line-height:1.5;">'
                + 'Optimized headline, About section, and skills list formatted for LinkedIn. Copy and paste directly.'
                + '</div>'
                + '</div>'
                + '</div></div>'

                + '</div>';
        }
        
        // Blueprint interaction functions
        function toggleOutcomeShare(idx) {
            blueprintData.outcomes[idx].shared = !blueprintData.outcomes[idx].shared;
            saveUserData();  // Auto-save
        }
        
        function editOutcome(idx) {
            const outcome = blueprintData.outcomes[idx];
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Edit Outcome</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Refine how you describe this achievement</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Outcome Text
                        </label>
                        <textarea id="editOutcomeText" style="
                            width: 100%;
                            min-height: 120px;
                            padding: 15px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                            line-height: 1.6;
                            font-family: inherit;
                            resize: vertical;
                        ">${outcome.text}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Category
                        </label>
                        <select id="editOutcomeCategory" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                        ">
                            <option value="Business Impact" ${outcome.category === 'Business Impact' ? 'selected' : ''}>Business Impact</option>
                            <option value="Strategic Foresight" ${outcome.category === 'Strategic Foresight' ? 'selected' : ''}>Strategic Foresight</option>
                            <option value="Crisis Leadership" ${outcome.category === 'Crisis Leadership' ? 'selected' : ''}>Crisis Leadership</option>
                            <option value="Entrepreneurial" ${outcome.category === 'Entrepreneurial' ? 'selected' : ''}>Entrepreneurial</option>
                            <option value="Thought Leadership" ${outcome.category === 'Thought Leadership' ? 'selected' : ''}>Thought Leadership</option>
                            <option value="Advocacy Impact" ${outcome.category === 'Advocacy Impact' ? 'selected' : ''}>Advocacy Impact</option>
                            <option value="Professional Achievement" ${outcome.category === 'Professional Achievement' ? 'selected' : ''}>Professional Achievement</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="editOutcomeSensitive" ${outcome.sensitive ? 'checked' : ''} style="
                                width: 20px;
                                height: 20px;
                                cursor: pointer;
                            ">
                            <span style="color: #ef4444; font-weight: 600;">Mark as Sensitive Content</span>
                        </label>
                        <p style="color: #9ca3af; font-size: 0.85em; margin-top: 5px; margin-left: 30px;">
                            Flag personal stories (recovery, loss, etc.) that require context before sharing
                        </p>
                    </div>
                    
                    <div style="background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <strong style="color: #fbbf24;">💡 COACHING TIP:</strong>
                        <p style="color: #d1d5db; margin-top: 8px; font-size: 0.9em;">
                            Strong outcomes include:
                            <br>• Quantification (numbers, percentages, time saved)
                            <br>• Who benefited (clients, company, team)
                            <br>• What changed as a result
                            <br>• Comparison or context (vs industry average, timeline)
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="action-btn" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Cancel
                        </button>
                        <button class="export-btn-large" onclick="saveOutcomeEdit(${idx})" style="padding: 10px 20px;">
                            💾 Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function saveOutcomeEdit(idx) {
            const newText = document.getElementById('editOutcomeText').value;
            const newCategory = document.getElementById('editOutcomeCategory').value;
            const newSensitive = document.getElementById('editOutcomeSensitive').checked;
            
            // Update outcome
            blueprintData.outcomes[idx].text = newText;
            blueprintData.outcomes[idx].category = newCategory;
            blueprintData.outcomes[idx].sensitive = newSensitive;
            
            // Regenerate coaching suggestion
            blueprintData.outcomes[idx].coachingSuggestion = generateCoachingFor(newText);
            
            // Save to localStorage
            saveUserData();
            
            // Close modal and refresh
            closeExportModal();
            renderBlueprint();
            
            showToast('Outcome updated.', 'success');
        }
        
        function viewOutcomeEvidence(idx) {
            const outcome = blueprintData.outcomes[idx];
            const skill = skillsData.skills.find(s => s.name === outcome.skill);
            if (skill) {
                openSkillModal(outcome.skill, skill);
            }
        }
        
        function addCustomOutcome() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Add Custom Outcome</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Describe an achievement or impact you've made</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Outcome Template
                        </label>
                        <select id="outcomeTemplate" onchange="fillOutcomeTemplate(this.value)" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                            margin-bottom: 15px;
                        ">
                            <option value="">-- Choose a template (optional) --</option>
                            <option value="revenue">Revenue/Financial Impact</option>
                            <option value="team">Team Building/Leadership</option>
                            <option value="innovation">Innovation/New Capability</option>
                            <option value="efficiency">Efficiency/Process Improvement</option>
                            <option value="crisis">Crisis Management</option>
                            <option value="strategic">Strategic Initiative</option>
                            <option value="thought">Thought Leadership</option>
                        </select>
                        
                        <textarea id="customOutcomeText" placeholder="Example: Led strategic initiative that increased revenue by 40% year-over-year through new market expansion" style="
                            width: 100%;
                            min-height: 120px;
                            padding: 15px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                            line-height: 1.6;
                            font-family: inherit;
                            resize: vertical;
                        "></textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Category
                        </label>
                        <select id="customOutcomeCategory" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                        ">
                            <option value="Business Impact">Business Impact</option>
                            <option value="Strategic Foresight">Strategic Foresight</option>
                            <option value="Crisis Leadership">Crisis Leadership</option>
                            <option value="Entrepreneurial">Entrepreneurial</option>
                            <option value="Thought Leadership">Thought Leadership</option>
                            <option value="Advocacy Impact">Advocacy Impact</option>
                            <option value="Professional Achievement">Professional Achievement</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Related Skill (Optional)
                        </label>
                        <select id="customOutcomeSkill" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                        ">
                            <option value="">-- None --</option>
                            ${skillsData.skills.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <strong style="color: #fbbf24;">💡 REFLECTION PROMPTS:</strong>
                        <ul style="color: #d1d5db; margin-top: 8px; font-size: 0.9em; margin-left: 20px;">
                            <li>What problem did you solve that others couldn't?</li>
                            <li>What measurable change resulted from your work?</li>
                            <li>Who benefited and how do you know?</li>
                            <li>What would have happened without your contribution?</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="action-btn" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Cancel
                        </button>
                        <button class="export-btn-large" onclick="saveCustomOutcome()" style="padding: 10px 20px;">
                            ➕ Add Outcome
                        </button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function fillOutcomeTemplate(type) {
            const textarea = document.getElementById('customOutcomeText');
            const templates = {
                revenue: 'Led [initiative] that increased revenue by [X%/amount] through [approach/method]. Resulted in [specific outcome/benefit].',
                team: 'Built and scaled [team/function] from [starting point] to [end state]. Team delivered [key achievements] within [timeframe].',
                innovation: 'Created [new capability/system] that enabled [organization/team] to [achieve what]. Adopted by [number/scope] with [measurable impact].',
                efficiency: 'Redesigned [process/system] reducing [time/cost/effort] by [X%]. Eliminated [waste/bottleneck] affecting [scope/scale].',
                crisis: 'Managed [crisis/incident] under [constraints]. Achieved [outcome] with [metric: zero injuries/minimal impact/rapid resolution].',
                strategic: 'Developed [strategy/framework] for [challenge/opportunity]. Predicted [outcome] [timeframe] ahead of market, enabling [advantage/benefit].',
                thought: 'Published [content type] reaching [audience size]. [Recognition/adoption]: [specific examples of influence/impact].'
            };
            
            if (templates[type]) {
                textarea.value = templates[type];
                textarea.focus();
            }
        }
        
        function saveCustomOutcome() {
            const text = document.getElementById('customOutcomeText').value.trim();
            if (!text) {
                showToast('Please enter an outcome description.', 'warning');
                return;
            }
            
            const category = document.getElementById('customOutcomeCategory').value;
            const skill = document.getElementById('customOutcomeSkill').value;
            
            // Create new outcome
            const newOutcome = {
                text: text,
                skill: skill || 'Custom',
                category: category,
                shared: true,
                sensitive: false,
                coachingSuggestion: generateCoachingFor(text)
            };
            
            // Add to beginning of outcomes array
            blueprintData.outcomes.unshift(newOutcome);
            
            // Save
            saveUserData();
            
            // Close and refresh
            closeExportModal();
            renderBlueprint();
            
            showToast('Custom outcome added.', 'success');
        }
        
        function toggleValue(idx) {
            blueprintData.values[idx].selected = !blueprintData.values[idx].selected;
            saveValues();
            refreshValuesUI();
        }
        
        function refreshValuesUI() {
            var contentEl = document.getElementById('blueprintTabContent');
            if (contentEl) contentEl.innerHTML = renderBlueprintTabContent();
            updateValuesBadge();
        }
        
        function updateValuesBadge() {
            var count = blueprintData.values.filter(function(v) { return v.selected; }).length;
            var tabs = document.querySelectorAll('.bp-tab');
            if (tabs.length > 1) {
                var badge = tabs[1].querySelector('.bp-tab-count');
                if (badge) badge.textContent = count;
            }
        }
        
        function toggleValuesPicker() {
            showingValuesPicker = !showingValuesPicker;
            refreshValuesUI();
        }
        window.toggleValuesPicker = toggleValuesPicker;
        
        function pickValue(name) {
            // Toggle: if already selected, remove; otherwise add
            var idx = -1;
            blueprintData.values.forEach(function(v, i) {
                if (v.name === name) idx = i;
            });
            
            if (idx >= 0) {
                // Remove it
                blueprintData.values.splice(idx, 1);
            } else {
                // Add it
                blueprintData.values.push({
                    name: name,
                    selected: true,
                    inferred: false,
                    custom: false
                });
            }
            saveValues();
            refreshValuesUI();
        }
        window.pickValue = pickValue;
        
        function removeSelectedValue(idx) {
            var value = blueprintData.values[idx];
            if (!value) return;
            blueprintData.values.splice(idx, 1);
            saveValues();
            refreshValuesUI();
            showToast('Removed "' + value.name + '".', 'info');
        }
        window.removeSelectedValue = removeSelectedValue;
        
        function showAddCustomValueForm() {
            // Re-render first to make sure form element exists
            showingValuesPicker = false;
            refreshValuesUI();
            setTimeout(function() {
                var form = document.getElementById('addValueForm');
                if (form) { form.style.display = 'block'; }
                var nameEl = document.getElementById('newValueName');
                if (nameEl) nameEl.focus();
            }, 50);
        }
        window.showAddCustomValueForm = showAddCustomValueForm;
        
        function showAddValueForm() { showAddCustomValueForm(); }
        window.showAddValueForm = showAddValueForm;
        
        function hideAddValueForm() {
            var form = document.getElementById('addValueForm');
            if (form) form.style.display = 'none';
            var nameEl = document.getElementById('newValueName');
            if (nameEl) nameEl.value = '';
        }
        window.hideAddValueForm = hideAddValueForm;
        
        function addCustomValue() {
            var nameEl = document.getElementById('newValueName');
            var name = (nameEl ? nameEl.value : '').trim();
            
            if (!name) {
                showToast('Please enter a value name.', 'warning');
                return;
            }
            
            var exists = blueprintData.values.some(function(v) {
                return v.name.toLowerCase() === name.toLowerCase();
            });
            if (exists) {
                showToast('That value is already in your list.', 'warning');
                return;
            }
            
            blueprintData.values.push({
                name: name,
                selected: true,
                inferred: false,
                custom: true
            });
            
            saveValues();
            hideAddValueForm();
            refreshValuesUI();
            showToast('Added "' + name + '".', 'success');
        }
        window.addCustomValue = addCustomValue;
        
        function moveValue(idx, direction) {
            var newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= blueprintData.values.length) return;
            var temp = blueprintData.values[idx];
            blueprintData.values[idx] = blueprintData.values[newIdx];
            blueprintData.values[newIdx] = temp;
            saveValues();
            refreshValuesUI();
        }
        window.moveValue = moveValue;
        window.toggleValue = toggleValue;
        window.updatePurpose = updatePurpose;
        
        function updatePurpose(newPurpose) {
            blueprintData.purpose = newPurpose;
            saveValues();
        }
        
        function exportBlueprint(format) {
            var sharedData = {
                profile: userData.profile || {},
                outcomes: blueprintData.outcomes.filter(function(o) { return o.shared; }),
                values: blueprintData.values.filter(function(v) { return v.selected; }),
                purpose: blueprintData.purpose,
                skills: (skillsData.skills || []).map(function(s) {
                    return { name: s.name, level: s.level, category: s.category, key: s.key, roles: s.roles };
                }),
                roles: skillsData.roles || [],
                exportedAt: new Date().toISOString()
            };
            
            if (format === 'json') {
                var dataStr = JSON.stringify(sharedData, null, 2);
                var dataBlob = new Blob([dataStr], {type: 'application/json'});
                var url = URL.createObjectURL(dataBlob);
                var link = document.createElement('a');
                link.href = url;
                var safeName = ((userData.profile && userData.profile.name) || 'profile').replace(/\s+/g, '-').toLowerCase();
                link.download = 'blueprint-' + safeName + '.json';
                link.click();
                URL.revokeObjectURL(url);
                showToast('JSON exported. Use this for backups or data portability.', 'success');
            } else if (format === 'pdf') {
                generatePDF(sharedData);
            }
        }
        
        function generatePDF(data) {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            
            var yPos = 20;
            var pageWidth = doc.internal.pageSize.getWidth();
            var pageHeight = doc.internal.pageSize.getHeight();
            var margin = 20;
            var maxWidth = pageWidth - (margin * 2);
            var name = (userData.profile && userData.profile.name) || 'Blueprint';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            
            function checkPage(needed) {
                if (yPos + needed > pageHeight - 25) {
                    addFooter();
                    doc.addPage();
                    yPos = 20;
                }
            }
            
            function addFooter() {
                doc.setFontSize(7);
                doc.setTextColor(156, 163, 175);
                doc.text('Blueprint\u2122 \u2022 ' + name + ' \u2022 ' + new Date().toLocaleDateString(), margin, pageHeight - 10);
                doc.text('\u00A9 ' + new Date().getFullYear() + ' Cliff Jurkiewicz. All rights reserved.', margin, pageHeight - 6);
                doc.text('Page ' + doc.internal.getNumberOfPages(), pageWidth - margin - 15, pageHeight - 10);
            }
            
            function sectionHeading(text) {
                checkPage(20);
                yPos += 4;
                doc.setDrawColor(30, 64, 175);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, margin + maxWidth, yPos);
                yPos += 8;
                doc.setFontSize(13);
                doc.setTextColor(30, 64, 175);
                doc.setFont(undefined, 'bold');
                doc.text(text, margin, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 8;
            }
            
            // === HEADER ===
            doc.setFontSize(22);
            doc.setTextColor(30, 64, 175);
            doc.setFont(undefined, 'bold');
            doc.text(name, margin, yPos);
            yPos += 8;
            
            if (title) {
                doc.setFontSize(12);
                doc.setTextColor(107, 114, 128);
                doc.setFont(undefined, 'normal');
                doc.text(title, margin, yPos);
                yPos += 6;
            }
            
            var dateLine = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            doc.setFontSize(9);
            doc.setTextColor(156, 163, 175);
            doc.text(dateLine, margin, yPos);
            yPos += 4;
            
            // Blue accent bar
            doc.setDrawColor(96, 165, 250);
            doc.setLineWidth(2);
            doc.line(margin, yPos, margin + 60, yPos);
            yPos += 10;
            
            // === PURPOSE ===
            if (data.purpose && data.purpose.trim()) {
                doc.setFontSize(10);
                doc.setTextColor(55, 65, 81);
                doc.setFont(undefined, 'italic');
                var purposeLines = doc.splitTextToSize(data.purpose.trim(), maxWidth);
                doc.text(purposeLines, margin, yPos);
                yPos += (purposeLines.length * 5) + 6;
                doc.setFont(undefined, 'normal');
            }
            
            // === OUTCOMES ===
            if (data.outcomes.length > 0) {
                sectionHeading('Outcomes');
                doc.setFontSize(9.5);
                doc.setTextColor(55, 65, 81);
                
                data.outcomes.forEach(function(outcome) {
                    checkPage(18);
                    var outcomeLines = doc.splitTextToSize('\u2022 ' + outcome.text, maxWidth - 6);
                    doc.text(outcomeLines, margin + 3, yPos);
                    yPos += (outcomeLines.length * 4.5) + 2;
                    
                    doc.setFontSize(7.5);
                    doc.setTextColor(96, 165, 250);
                    doc.text(outcome.category || '', margin + 6, yPos);
                    yPos += 5;
                    doc.setFontSize(9.5);
                    doc.setTextColor(55, 65, 81);
                });
            }
            
            // === VALUES ===
            if (data.values.length > 0) {
                sectionHeading('Core Values');
                doc.setFontSize(9.5);
                doc.setTextColor(55, 65, 81);
                
                data.values.forEach(function(value) {
                    checkPage(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('\u2022 ' + value.name, margin + 3, yPos);
                    var nameWidth = doc.getTextWidth('\u2022 ' + value.name + '  ');
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(107, 114, 128);
                    
                    var valueDesc = value.description || getCatalogDescription(value.name) || '';
                    if (valueDesc) {
                        var descLines = doc.splitTextToSize(valueDesc, maxWidth - 6);
                        doc.text(descLines, margin + 3, yPos + 4.5);
                        yPos += 4.5 + (descLines.length * 4.5);
                    }
                    if (value.note) {
                        doc.setFont(undefined, 'italic');
                        doc.setTextColor(96, 165, 250);
                        var noteLines = doc.splitTextToSize('\u201C' + value.note + '\u201D', maxWidth - 10);
                        checkPage(noteLines.length * 4.5 + 4);
                        doc.text(noteLines, margin + 6, yPos + 4);
                        yPos += (noteLines.length * 4.5) + 2;
                        doc.setFont(undefined, 'normal');
                    }
                    yPos += 4;
                    doc.setTextColor(55, 65, 81);
                });
            }
            
            // === TOP SKILLS ===
            var skills = skillsData.skills || [];
            var topSkills = skills.filter(function(s) { return s.key; }).slice(0, 15);
            if (topSkills.length === 0) topSkills = skills.slice(0, 15);
            
            if (topSkills.length > 0) {
                sectionHeading('Core Competencies (' + skills.length + ' total)');
                checkPage(25);
                doc.setFontSize(9);
                doc.setTextColor(55, 65, 81);
                
                // Compact 2-column layout
                var col1X = margin + 3;
                var col2X = margin + (maxWidth / 2) + 3;
                var startY = yPos;
                
                topSkills.forEach(function(skill, idx) {
                    var xPos = idx % 2 === 0 ? col1X : col2X;
                    var rowY = startY + Math.floor(idx / 2) * 5.5;
                    
                    checkPage(8);
                    doc.setFont(undefined, 'normal');
                    doc.text('\u2022 ' + skill.name, xPos, rowY);
                    
                    doc.setFontSize(7);
                    doc.setTextColor(96, 165, 250);
                    var levelText = skill.level || '';
                    doc.text(levelText, xPos + doc.getTextWidth('\u2022 ' + skill.name + ' '), rowY);
                    doc.setFontSize(9);
                    doc.setTextColor(55, 65, 81);
                });
                
                yPos = startY + Math.ceil(topSkills.length / 2) * 5.5 + 4;
            }
            
            // === MARKET CONTEXT ===
            var comp = calculateTotalMarketValue();
            if (comp && comp.marketRate) {
                sectionHeading('Market Positioning');
                checkPage(25);
                doc.setFontSize(9.5);
                doc.setTextColor(55, 65, 81);
                
                var marketLines = [
                    ['Base Market Rate', '$' + Math.round(comp.marketRate).toLocaleString()],
                    ['Conservative Range', '$' + Math.round(comp.conservativeOffer || comp.marketRate * 1.1).toLocaleString()],
                    ['Competitive Range', '$' + Math.round(comp.competitiveOffer || comp.marketRate * 1.3).toLocaleString()]
                ];
                
                marketLines.forEach(function(line) {
                    doc.setFont(undefined, 'normal');
                    doc.text(line[0] + ':', margin + 3, yPos);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(30, 64, 175);
                    doc.text(line[1], margin + 55, yPos);
                    doc.setTextColor(55, 65, 81);
                    yPos += 6;
                });
                doc.setFont(undefined, 'normal');
            }
            
            // === PROFESSIONAL CONTEXT ===
            sectionHeading('Professional Context');
            doc.setFontSize(9);
            doc.setTextColor(55, 65, 81);
            
            var contextItems = [];
            if (userData.profile && userData.profile.location) contextItems.push('Location: ' + userData.profile.location);
            if (userData.preferences && userData.preferences.seniorityLevel) contextItems.push('Level: ' + userData.preferences.seniorityLevel);
            contextItems.push('Skills: ' + skills.length + ' professional competencies across ' + ((skillsData.roles || []).length) + ' roles');
            
            contextItems.forEach(function(item) {
                checkPage(8);
                doc.text(item, margin + 3, yPos);
                yPos += 5;
            });
            
            // Final footer
            addFooter();
            
            // Save
            var fileName = ('blueprint-' + name + '.pdf').replace(/\s+/g, '-').toLowerCase();
            doc.save(fileName);
            showToast('PDF downloaded.', 'success');
        }
        
        function copyBlueprintText() {
            var name = (userData.profile && userData.profile.name) || 'Professional';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            var location = (userData.profile && userData.profile.location) || '';
            
            var lines = [];
            lines.push(name.toUpperCase());
            if (title) lines.push(title);
            if (location) lines.push(location);
            lines.push('');
            
            // Purpose
            if (blueprintData.purpose && blueprintData.purpose.trim()) {
                lines.push('PURPOSE');
                lines.push(blueprintData.purpose.trim());
                lines.push('');
            }
            
            // Outcomes
            var sharedOutcomes = blueprintData.outcomes.filter(function(o) { return o.shared; });
            if (sharedOutcomes.length > 0) {
                lines.push('KEY OUTCOMES');
                sharedOutcomes.forEach(function(o) {
                    lines.push('\u2022 ' + o.text);
                });
                lines.push('');
            }
            
            // Values
            var selectedValues = blueprintData.values.filter(function(v) { return v.selected; });
            if (selectedValues.length > 0) {
                lines.push('CORE VALUES');
                selectedValues.forEach(function(v) {
                    var desc = getCatalogDescription(v.name);
                    lines.push('\u2022 ' + v.name + (desc ? ' \u2014 ' + desc : ''));
                    if (v.note) lines.push('  ' + v.note);
                });
                lines.push('');
            }
            
            // Top skills summary
            var skills = skillsData.skills || [];
            var topSkills = skills.filter(function(s) { return s.key; }).slice(0, 10);
            if (topSkills.length > 0) {
                lines.push('CORE COMPETENCIES');
                lines.push(topSkills.map(function(s) { return s.name; }).join(', '));
                lines.push('');
            }
            
            // Market context
            var comp = calculateTotalMarketValue();
            if (comp && comp.marketRate) {
                lines.push('MARKET POSITIONING');
                lines.push('Market Rate: $' + Math.round(comp.marketRate).toLocaleString());
                if (comp.competitiveOffer) {
                    lines.push('Competitive Range: $' + Math.round(comp.competitiveOffer).toLocaleString());
                }
                lines.push('');
            }
            
            lines.push('Generated by Blueprint\u2122 \u2022 ' + new Date().toLocaleDateString() + ' \u2022 \u00A9 2026 Cliff Jurkiewicz');
            
            var text = lines.join('\n');
            navigator.clipboard.writeText(text).then(function() {
                showToast('Blueprint copied to clipboard. Ready to paste.', 'success');
            }).catch(function() {
                // Fallback: select from textarea
                var ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('Blueprint copied to clipboard.', 'success');
            });
        }
        window.copyBlueprintText = copyBlueprintText;
        window.generateWorkBlueprint = generateWorkBlueprint;
        window.generateResume = generateResume;
        window.exportBlueprint = exportBlueprint;

        // ===== COVER LETTER GENERATOR =====

        function generateCoverLetter() {
            var jobs = userData.savedJobs || [];
            if (jobs.length === 0) {
                showToast('Add a job in the Jobs tab first, then generate a cover letter.', 'info');
                return;
            }
            // Show job picker modal
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Generate Cover Letter</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">Select a job to tailor your letter</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + jobs.map(function(j, i) {
                    var score = j.matchData ? Math.round(j.matchData.score) : 0;
                    var scoreColor = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                    return '<div onclick="buildCoverLetter(' + i + ')" style="display:flex; align-items:center; gap:14px; '
                        + 'padding:16px; border:1px solid var(--border); border-radius:10px; cursor:pointer; '
                        + 'margin-bottom:10px; transition:all 0.15s;" '
                        + 'onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">'
                        + '<div style="width:44px; height:44px; border-radius:10px; background:rgba(96,165,250,0.1); '
                        + 'display:flex; align-items:center; justify-content:center; font-weight:700; color:' + scoreColor + '; font-size:0.85em;">'
                        + score + '%</div>'
                        + '<div style="flex:1; min-width:0;">'
                        + '<div style="font-weight:600; color:var(--text-primary); font-size:0.92em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">'
                        + (j.title || 'Untitled') + '</div>'
                        + '<div style="font-size:0.82em; color:var(--text-muted);">' + (j.company || 'Unknown company') + '</div>'
                        + '</div>'
                        + '<div style="color:var(--text-muted); font-size:1.2em;">\u2192</div>'
                        + '</div>';
                }).join('')
                + '</div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.generateCoverLetter = generateCoverLetter;

        function buildCoverLetter(jobIdx) {
            var job = (userData.savedJobs || [])[jobIdx];
            if (!job || !job.matchData) { showToast('No match data for this job.', 'error'); return; }
            closeExportModal();

            var name = (userData.profile && userData.profile.name) || 'Professional';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            var purpose = userData.purpose || blueprintData.purpose || '';
            var matched = job.matchData.matched || [];
            var gaps = job.matchData.gaps || [];
            var sharedOutcomes = (blueprintData.outcomes || []).filter(function(o) { return o.shared; });
            var selectedValues = (blueprintData.values || []).filter(function(v) { return v.selected; });

            var apiKey = localStorage.getItem('wbAnthropicKey');

            if (apiKey) {
                showToast('Generating cover letter with AI...', 'info');
                var prompt = 'Write a professional cover letter for ' + name
                    + (title ? ', currently ' + title : '')
                    + ', applying for ' + (job.title || 'a role') + ' at ' + (job.company || 'the company') + '.\n\n'
                    + 'MATCHED SKILLS (strengths to emphasize): ' + matched.map(function(m) { return m.name || m; }).join(', ') + '\n\n'
                    + 'SKILL GAPS (acknowledge indirectly or show transferable experience): ' + gaps.map(function(g) { return g.name || g; }).join(', ') + '\n\n'
                    + 'KEY OUTCOMES: ' + sharedOutcomes.slice(0, 5).map(function(o) { return o.text; }).join('; ') + '\n\n'
                    + 'CORE VALUES: ' + selectedValues.slice(0, 5).map(function(v) { return v.name; }).join(', ') + '\n\n'
                    + (purpose ? 'PURPOSE STATEMENT: ' + purpose + '\n\n' : '')
                    + 'INSTRUCTIONS: Write 3-4 paragraphs. Opening: show specific knowledge of the company and role. '
                    + 'Middle: connect 2-3 matched skills to outcomes with concrete evidence. '
                    + 'Address gaps by showing adjacent experience. '
                    + 'Close: express genuine interest, reference values alignment. '
                    + 'Tone: confident but not arrogant, specific not generic. No cliches. '
                    + 'Do NOT include placeholder brackets like [Company] or [Name]. Use the actual names provided.';

                fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{ role: 'user', content: prompt }]
                    })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var text = (data.content || []).map(function(c) { return c.text || ''; }).join('\n');
                    if (!text) throw new Error('Empty response');
                    showCoverLetterResult(text, job);
                })
                .catch(function(err) {
                    console.error('Cover letter API error:', err);
                    showToast('AI generation failed, using template.', 'warning');
                    showCoverLetterResult(buildTemplateCoverLetter(job, name, title, matched, sharedOutcomes, purpose), job);
                });
            } else {
                showCoverLetterResult(buildTemplateCoverLetter(job, name, title, matched, sharedOutcomes, purpose), job);
            }
        }
        window.buildCoverLetter = buildCoverLetter;

        function buildTemplateCoverLetter(job, name, title, matched, outcomes, purpose) {
            var matchedNames = matched.slice(0, 5).map(function(m) { return m.name || m; });
            var outcomeTexts = outcomes.slice(0, 3).map(function(o) { return o.text; });
            var lines = [];
            lines.push('Dear Hiring Manager,');
            lines.push('');
            lines.push('I am writing to express my interest in the ' + (job.title || 'open position')
                + ' at ' + (job.company || 'your organization') + '.'
                + (title ? ' As a ' + title + ',' : '') + ' I bring a combination of '
                + (matchedNames.length > 2 ? matchedNames.slice(0, 2).join(', ') + ', and ' + matchedNames[2] : matchedNames.join(' and '))
                + ' that aligns directly with what you are looking for.');
            lines.push('');
            if (outcomeTexts.length > 0) {
                lines.push('In my current and recent roles, I have delivered measurable results: '
                    + outcomeTexts.join('. ') + '.'
                    + ' These outcomes reflect the same capabilities your team needs to succeed.');
            }
            lines.push('');
            if (purpose) {
                lines.push(purpose + ' This philosophy drives my approach to every challenge and every team I join.');
            }
            lines.push('');
            lines.push('I would welcome the opportunity to discuss how my experience and approach can contribute to '
                + (job.company || 'your team') + '\'s continued success.');
            lines.push('');
            lines.push('Sincerely,');
            lines.push(name);
            return lines.join('\n');
        }

        function showCoverLetterResult(text, job) {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Cover Letter</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">'
                + (job.title || '') + ' at ' + (job.company || '') + '</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<textarea id="coverLetterOutput" style="width:100%; min-height:350px; padding:18px; '
                + 'background:var(--input-bg); border:1px solid var(--border); border-radius:10px; '
                + 'color:var(--text-primary); font-size:0.95em; line-height:1.7; font-family:inherit; resize:vertical;">'
                + text.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                + '</textarea>'
                + '<div style="display:flex; gap:10px; margin-top:16px;">'
                + '<button onclick="copyCoverLetter()" style="flex:1; background:var(--accent); color:#fff; border:none; '
                + 'padding:12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + '\uD83D\uDCCB Copy to Clipboard</button>'
                + '<button onclick="downloadCoverLetter(\'' + (job.company || 'company').replace(/'/g, '') + '\')" '
                + 'style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border); '
                + 'padding:12px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">'
                + '\uD83D\uDCE5 Download</button>'
                + '</div></div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }

        function copyCoverLetter() {
            var ta = document.getElementById('coverLetterOutput');
            if (ta) {
                navigator.clipboard.writeText(ta.value).then(function() {
                    showToast('Cover letter copied to clipboard.', 'success');
                });
            }
        }
        window.copyCoverLetter = copyCoverLetter;

        function downloadCoverLetter(company) {
            var ta = document.getElementById('coverLetterOutput');
            if (!ta) return;
            var blob = new Blob([ta.value], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'cover-letter-' + company.toLowerCase().replace(/\s+/g, '-') + '.txt';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Cover letter downloaded.', 'success');
        }
        window.downloadCoverLetter = downloadCoverLetter;

        // ===== INTERVIEW PREP GENERATOR =====

        function generateInterviewPrep() {
            var jobs = userData.savedJobs || [];
            if (jobs.length === 0) {
                showToast('Add a job in the Jobs tab first, then generate interview prep.', 'info');
                return;
            }
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Interview Prep</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">Select a job for tailored STAR stories and talking points</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + jobs.map(function(j, i) {
                    var score = j.matchData ? Math.round(j.matchData.score) : 0;
                    var scoreColor = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                    return '<div onclick="buildInterviewPrep(' + i + ')" style="display:flex; align-items:center; gap:14px; '
                        + 'padding:16px; border:1px solid var(--border); border-radius:10px; cursor:pointer; '
                        + 'margin-bottom:10px; transition:all 0.15s;" '
                        + 'onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">'
                        + '<div style="width:44px; height:44px; border-radius:10px; background:rgba(96,165,250,0.1); '
                        + 'display:flex; align-items:center; justify-content:center; font-weight:700; color:' + scoreColor + '; font-size:0.85em;">'
                        + score + '%</div>'
                        + '<div style="flex:1; min-width:0;">'
                        + '<div style="font-weight:600; color:var(--text-primary); font-size:0.92em;">' + (j.title || 'Untitled') + '</div>'
                        + '<div style="font-size:0.82em; color:var(--text-muted);">' + (j.company || 'Unknown') + '</div>'
                        + '</div>'
                        + '<div style="color:var(--text-muted); font-size:1.2em;">\u2192</div>'
                        + '</div>';
                }).join('')
                + '</div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.generateInterviewPrep = generateInterviewPrep;

        function buildInterviewPrep(jobIdx) {
            var job = (userData.savedJobs || [])[jobIdx];
            if (!job || !job.matchData) { showToast('No match data.', 'error'); return; }
            closeExportModal();

            var name = (userData.profile && userData.profile.name) || 'Professional';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            var matched = job.matchData.matched || [];
            var gaps = job.matchData.gaps || [];
            var surplus = job.matchData.surplus || [];
            var sharedOutcomes = (blueprintData.outcomes || []).filter(function(o) { return o.shared; });
            var skills = skillsData.skills || [];

            var apiKey = localStorage.getItem('wbAnthropicKey');

            if (apiKey) {
                showToast('Generating interview prep with AI...', 'info');

                // Build skill-evidence map
                var skillEvidence = {};
                skills.forEach(function(s) {
                    if (s.evidence && s.evidence.length > 0) {
                        skillEvidence[s.name] = s.evidence.slice(0, 2).map(function(e) { return typeof e === 'string' ? e : e.text || ''; });
                    }
                });

                var prompt = 'Create an interview preparation guide for ' + name
                    + (title ? ' (' + title + ')' : '')
                    + ' interviewing for ' + (job.title || 'a role') + ' at ' + (job.company || 'the company') + '.\n\n'
                    + 'MATCHED SKILLS WITH EVIDENCE:\n'
                    + matched.slice(0, 10).map(function(m) {
                        var n = m.name || m;
                        var ev = skillEvidence[n];
                        return '- ' + n + (ev ? ': ' + ev.join('; ') : '');
                    }).join('\n') + '\n\n'
                    + 'SKILL GAPS (job requires, candidate lacks): ' + gaps.slice(0, 8).map(function(g) { return (g.name || g) + (g.required ? ' [REQUIRED]' : ''); }).join(', ') + '\n\n'
                    + 'SURPLUS STRENGTHS: ' + surplus.slice(0, 5).map(function(s) { return s.name || s; }).join(', ') + '\n\n'
                    + 'KEY OUTCOMES: ' + sharedOutcomes.slice(0, 5).map(function(o) { return o.text; }).join('; ') + '\n\n'
                    + 'INSTRUCTIONS:\n'
                    + '1. For the top 5 matched skills, write a STAR story framework: Situation (one sentence setup), Task, Action, Result. Use the evidence provided.\n'
                    + '2. For each gap, write bridging language that connects adjacent experience. Frame: "While I haven\'t done X specifically, my experience with Y translates because..."\n'
                    + '3. Write 3 surplus strengths as "unexpected value" talking points. These differentiate the candidate.\n'
                    + '4. Write 3 smart questions to ask the interviewer that demonstrate strategic thinking.\n'
                    + 'Format with clear section headers. Be specific, not generic.';

                fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2500,
                        messages: [{ role: 'user', content: prompt }]
                    })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var text = (data.content || []).map(function(c) { return c.text || ''; }).join('\n');
                    if (!text) throw new Error('Empty response');
                    showInterviewPrepResult(text, job);
                })
                .catch(function(err) {
                    console.error('Interview prep API error:', err);
                    showToast('AI generation failed, using template.', 'warning');
                    showInterviewPrepResult(buildTemplateInterviewPrep(job, matched, gaps, surplus, skills, sharedOutcomes), job);
                });
            } else {
                showInterviewPrepResult(buildTemplateInterviewPrep(job, matched, gaps, surplus, skills, sharedOutcomes), job);
            }
        }
        window.buildInterviewPrep = buildInterviewPrep;

        function buildTemplateInterviewPrep(job, matched, gaps, surplus, skills, outcomes) {
            var lines = [];
            lines.push('INTERVIEW PREP: ' + (job.title || 'Role') + ' at ' + (job.company || 'Company'));
            lines.push('Match Score: ' + Math.round(job.matchData.score) + '%');
            lines.push('');

            lines.push('=== YOUR STRONGEST TALKING POINTS ===');
            lines.push('');
            matched.slice(0, 6).forEach(function(m) {
                var n = m.name || m;
                var skill = skills.find(function(s) { return s.name === n; });
                var evidence = (skill && skill.evidence) ? skill.evidence.slice(0, 2) : [];
                lines.push('\u2705 ' + n + (m.level ? ' (' + m.level + ')' : ''));
                if (evidence.length > 0) {
                    evidence.forEach(function(e) {
                        var txt = typeof e === 'string' ? e : e.text || '';
                        if (txt) lines.push('   Evidence: ' + txt);
                    });
                }
                lines.push('   STAR Framework: [Situation] Describe when you used this skill. [Task] What was the challenge? [Action] What specifically did you do? [Result] What was the measurable outcome?');
                lines.push('');
            });

            if (gaps.length > 0) {
                lines.push('=== BRIDGING LANGUAGE FOR GAPS ===');
                lines.push('');
                gaps.slice(0, 5).forEach(function(g) {
                    var n = g.name || g;
                    lines.push('\u26A0\uFE0F ' + n + (g.required ? ' [REQUIRED]' : ''));
                    lines.push('   "While I haven\'t worked with ' + n + ' specifically, my experience with [related skill] translates directly because..."');
                    lines.push('');
                });
            }

            if (surplus.length > 0) {
                lines.push('=== UNEXPECTED VALUE (YOUR DIFFERENTIATORS) ===');
                lines.push('');
                surplus.slice(0, 4).forEach(function(s) {
                    lines.push('\uD83D\uDCA1 ' + (s.name || s));
                    lines.push('   This skill isn\'t in the job description but adds value because...');
                    lines.push('');
                });
            }

            lines.push('=== QUESTIONS TO ASK ===');
            lines.push('');
            lines.push('1. What does success look like in this role at the 6-month mark?');
            lines.push('2. How does the team approach [a key matched skill area] today, and where do you want it to go?');
            lines.push('3. What\'s the biggest challenge the person in this role will face in the first quarter?');
            lines.push('');
            lines.push('Generated by Blueprint\u2122 \u2022 ' + new Date().toLocaleDateString());
            return lines.join('\n');
        }

        function showInterviewPrepResult(text, job) {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Interview Prep</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">'
                + (job.title || '') + ' at ' + (job.company || '') + '</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<textarea id="interviewPrepOutput" style="width:100%; min-height:400px; padding:18px; '
                + 'background:var(--input-bg); border:1px solid var(--border); border-radius:10px; '
                + 'color:var(--text-primary); font-size:0.92em; line-height:1.7; font-family:inherit; resize:vertical;">'
                + text.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                + '</textarea>'
                + '<div style="display:flex; gap:10px; margin-top:16px;">'
                + '<button onclick="copyInterviewPrep()" style="flex:1; background:var(--accent); color:#fff; border:none; '
                + 'padding:12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + '\uD83D\uDCCB Copy to Clipboard</button>'
                + '<button onclick="downloadInterviewPrep(\'' + (job.company || 'company').replace(/'/g, '') + '\')" '
                + 'style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border); '
                + 'padding:12px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">'
                + '\uD83D\uDCE5 Download</button>'
                + '</div></div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }

        function copyInterviewPrep() {
            var ta = document.getElementById('interviewPrepOutput');
            if (ta) {
                navigator.clipboard.writeText(ta.value).then(function() {
                    showToast('Interview prep copied to clipboard.', 'success');
                });
            }
        }
        window.copyInterviewPrep = copyInterviewPrep;

        function downloadInterviewPrep(company) {
            var ta = document.getElementById('interviewPrepOutput');
            if (!ta) return;
            var blob = new Blob([ta.value], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'interview-prep-' + company.toLowerCase().replace(/\s+/g, '-') + '.txt';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Interview prep downloaded.', 'success');
        }
        window.downloadInterviewPrep = downloadInterviewPrep;

        // ===== LINKEDIN PROFILE GENERATOR =====

        function generateLinkedInProfile() {
            var name = (userData.profile && userData.profile.name) || 'Professional';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            var purpose = userData.purpose || blueprintData.purpose || '';
            var sharedOutcomes = (blueprintData.outcomes || []).filter(function(o) { return o.shared; });
            var selectedValues = (blueprintData.values || []).filter(function(v) { return v.selected; });
            var skills = skillsData.skills || [];
            var topSkills = skills.filter(function(s) { return s.key; }).slice(0, 15);
            var allSkills = skills.slice(0, 50);

            var apiKey = localStorage.getItem('wbAnthropicKey');

            if (apiKey) {
                showToast('Generating LinkedIn profile with AI...', 'info');
                var prompt = 'Generate an optimized LinkedIn profile for ' + name
                    + (title ? ', ' + title : '') + '.\n\n'
                    + 'PURPOSE: ' + (purpose || 'Not provided') + '\n\n'
                    + 'KEY OUTCOMES:\n' + sharedOutcomes.slice(0, 6).map(function(o) { return '- ' + o.text; }).join('\n') + '\n\n'
                    + 'CORE VALUES: ' + selectedValues.slice(0, 5).map(function(v) { return v.name; }).join(', ') + '\n\n'
                    + 'TOP SKILLS: ' + topSkills.map(function(s) { return s.name; }).join(', ') + '\n\n'
                    + 'INSTRUCTIONS:\n'
                    + '1. HEADLINE (max 220 chars): Title | Value proposition | 2-3 key differentiators. No buzzwords.\n'
                    + '2. ABOUT SECTION (2000 chars max, ~3 paragraphs): First paragraph hooks with a specific outcome. Second connects purpose to capabilities. Third is forward-looking, what you are building toward. End with a brief "Specialties:" line. Write in first person. No generic openers like "Passionate professional" or "Results-driven leader".\n'
                    + '3. SKILLS LIST: The top 15 skills ordered by impact, one per line.\n'
                    + 'Separate each section with a clear header.';

                fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{ role: 'user', content: prompt }]
                    })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var text = (data.content || []).map(function(c) { return c.text || ''; }).join('\n');
                    if (!text) throw new Error('Empty response');
                    showLinkedInResult(text);
                })
                .catch(function(err) {
                    console.error('LinkedIn API error:', err);
                    showToast('AI generation failed, using template.', 'warning');
                    showLinkedInResult(buildTemplateLinkedIn(name, title, purpose, sharedOutcomes, selectedValues, topSkills));
                });
            } else {
                showLinkedInResult(buildTemplateLinkedIn(name, title, purpose, sharedOutcomes, selectedValues, topSkills));
            }
        }
        window.generateLinkedInProfile = generateLinkedInProfile;

        function buildTemplateLinkedIn(name, title, purpose, outcomes, values, topSkills) {
            var lines = [];
            lines.push('=== HEADLINE ===');
            lines.push(title + (values.length > 0 ? ' | ' + values.slice(0, 3).map(function(v) { return v.name; }).join(' \u00B7 ') : '')
                + (topSkills.length > 0 ? ' | ' + topSkills.slice(0, 3).map(function(s) { return s.name; }).join(', ') : ''));
            lines.push('');
            lines.push('=== ABOUT ===');
            if (outcomes.length > 0) {
                lines.push(outcomes[0].text + '\n');
            }
            if (purpose) {
                lines.push(purpose + '\n');
            }
            if (outcomes.length > 1) {
                lines.push('Key results I have delivered:');
                outcomes.slice(1, 5).forEach(function(o) {
                    lines.push('\u2022 ' + o.text);
                });
                lines.push('');
            }
            if (topSkills.length > 0) {
                lines.push('Specialties: ' + topSkills.map(function(s) { return s.name; }).join(' \u00B7 '));
            }
            lines.push('');
            lines.push('=== SKILLS (Top 15) ===');
            topSkills.forEach(function(s, i) {
                lines.push((i + 1) + '. ' + s.name);
            });
            lines.push('');
            lines.push('Generated by Blueprint\u2122');
            return lines.join('\n');
        }

        function showLinkedInResult(text) {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">LinkedIn Profile</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">Copy each section directly to LinkedIn</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<textarea id="linkedinOutput" style="width:100%; min-height:380px; padding:18px; '
                + 'background:var(--input-bg); border:1px solid var(--border); border-radius:10px; '
                + 'color:var(--text-primary); font-size:0.92em; line-height:1.7; font-family:inherit; resize:vertical;">'
                + text.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                + '</textarea>'
                + '<div style="display:flex; gap:10px; margin-top:16px;">'
                + '<button onclick="copyLinkedIn()" style="flex:1; background:#0a66c2; color:#fff; border:none; '
                + 'padding:12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + '\uD83D\uDD17 Copy to Clipboard</button>'
                + '</div></div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }

        function copyLinkedIn() {
            var ta = document.getElementById('linkedinOutput');
            if (ta) {
                navigator.clipboard.writeText(ta.value).then(function() {
                    showToast('LinkedIn profile copied. Open LinkedIn to paste.', 'success');
                });
            }
        }
        window.copyLinkedIn = copyLinkedIn;
        
        // ===== OPPORTUNITIES SYSTEM =====

        let currentMatchThreshold = 60;
        let opportunitiesData = [];
        
        let jobsSubTab = 'your-jobs';
        let activeJobId = null; // Currently selected job for network overlay
        
        function initOpportunities() {
            const view = document.getElementById('opportunitiesView');
            var savedCount = (userData.savedJobs || []).length;
            
            view.innerHTML = '<div style="max-width:1200px; margin:0 auto; padding:24px;">'
                + '<div class="jobs-subtabs">'
                + '<button class="jobs-subtab ' + (jobsSubTab === 'your-jobs' ? 'active' : '') + '" onclick="switchJobsSubTab(\'your-jobs\')">🎯 Your Jobs' + (savedCount > 0 ? ' (' + savedCount + ')' : '') + '</button>'
                + '<button class="jobs-subtab ' + (jobsSubTab === 'find-jobs' ? 'active' : '') + '" onclick="switchJobsSubTab(\'find-jobs\')">🔍 Find Jobs</button>'
                + '</div>'
                + '<div id="jobsSubTabContent"></div>'
                + '</div>';
            
            renderJobsSubTab();
        }
        
        function switchJobsSubTab(tab) {
            jobsSubTab = tab;
            document.querySelectorAll('.jobs-subtab').forEach(function(b) { b.classList.remove('active'); });
            document.querySelectorAll('.jobs-subtab').forEach(function(b) {
                if (b.textContent.toLowerCase().indexOf(tab === 'your-jobs' ? 'your' : 'find') !== -1) b.classList.add('active');
            });
            renderJobsSubTab();
        }
        window.switchJobsSubTab = switchJobsSubTab;
        
        function renderJobsSubTab() {
            var el = document.getElementById('jobsSubTabContent');
            if (!el) return;
            if (jobsSubTab === 'your-jobs') {
                el.innerHTML = renderSavedJobs();
            } else {
                el.innerHTML = renderFindJobs();
                searchOpportunities();
            }
        }
        
        function renderSavedJobs() {
            var jobs = userData.savedJobs || [];
            var html = '';
            
            // Add Job button
            html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">'
                + '<div>'
                + '<h2 style="font-size:1.3em; font-weight:700; color:var(--text-primary); margin:0;">Job Pipeline</h2>'
                + '<p style="font-size:0.85em; color:var(--text-muted); margin-top:4px;">Paste a job description to analyze your fit</p>'
                + '</div>'
                + '<button onclick="showAddJobModal()" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:10px 20px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.9em;">+ Add a Job</button>'
                + '</div>';
            
            if (jobs.length === 0) {
                html += '<div style="text-align:center; padding:60px 20px;">'
                    + '<div style="font-size:2.5em; margin-bottom:12px;">🎯</div>'
                    + '<div style="font-size:1.1em; font-weight:600; color:var(--text-primary); margin-bottom:8px;">No jobs yet</div>'
                    + '<div style="color:var(--text-muted); max-width:400px; margin:0 auto 24px; line-height:1.5;">'
                    + 'Paste a job description and see exactly how your skills map to what they need. Not a percentage. A network.</div>'
                    + '<button onclick="showAddJobModal()" style="'
                    + 'background:var(--accent); color:#fff; border:none; padding:12px 28px; border-radius:8px; '
                    + 'cursor:pointer; font-weight:600; font-size:0.95em;">+ Add Your First Job</button>'
                    + '</div>';
                return html;
            }
            
            // Render job cards
            jobs.forEach(function(job, idx) {
                var match = job.matchData || {};
                var matchPct = match.score || 0;
                var matchColor = matchPct >= 70 ? '#10b981' : matchPct >= 45 ? '#f59e0b' : '#6b7280';
                var matchedCount = (match.matched || []).length;
                var gapCount = (match.gaps || []).length;
                var surplusCount = (match.surplus || []).length;
                var dateStr = job.addedAt ? new Date(job.addedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                
                html += '<div class="job-cart-card" onclick="showJobDetail(' + idx + ')">'
                    + '<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">'
                    + '<div style="flex:1; min-width:0;">'
                    + '<div style="font-size:1.1em; font-weight:600; color:var(--text-primary); margin-bottom:3px;">' + (job.title || 'Untitled Position') + '</div>'
                    + '<div style="font-size:0.88em; color:var(--text-muted);">'
                    + (job.company || '')
                    + (job.company && dateStr ? ' \u00B7 ' : '') + dateStr
                    + (job.sourceUrl ? ' \u00B7 <a href="' + job.sourceUrl + '" target="_blank" onclick="event.stopPropagation();" style="color:var(--accent); text-decoration:none;">Source \u2192</a>' : '')
                    + (job.sourceNote ? ' \u00B7 ' + job.sourceNote : '')
                    + '</div></div>'
                    + '<div style="text-align:right; min-width:70px;">'
                    + '<div style="font-size:1.5em; font-weight:700; color:' + matchColor + ';">' + matchPct + '%</div>'
                    + '<div style="font-size:0.7em; color:var(--text-muted);">match</div>'
                    + '</div></div>';
                
                // Match bar
                html += '<div class="job-cart-match" style="margin-top:12px;">'
                    + '<div class="job-cart-match-bar">'
                    + '<div class="job-cart-match-fill" style="width:' + matchPct + '%; background:' + matchColor + ';"></div>'
                    + '</div></div>';
                
                // Skill summary chips
                html += '<div style="margin-top:10px; display:flex; gap:12px; font-size:0.78em; color:var(--text-muted);">'
                    + '<span style="color:#10b981;">\u2713 ' + matchedCount + ' matched</span>'
                    + '<span style="color:#ef4444;">\u25CB ' + gapCount + ' gaps</span>'
                    + '<span style="color:#6b7280;">\u25CF ' + surplusCount + ' surplus</span>'
                    + '</div>';
                
                // Delete button
                html += '<div style="margin-top:8px; display:flex; justify-content:flex-end; gap:8px;">'
                    + '<button onclick="event.stopPropagation(); editJobInfo(' + idx + ')" style="'
                    + 'background:none; border:1px solid var(--border); color:var(--text-muted); font-size:0.75em; '
                    + 'cursor:pointer; padding:4px 10px; border-radius:5px;" '
                    + 'onmouseover="this.style.color=\'var(--accent)\'" onmouseout="this.style.color=\'var(--text-muted)\'">\u270E Edit</button>'
                    + '<button onclick="event.stopPropagation(); removeJob(' + idx + ')" style="'
                    + 'background:none; border:1px solid rgba(239,68,68,0.2); color:var(--text-muted); font-size:0.75em; '
                    + 'cursor:pointer; padding:4px 10px; border-radius:5px;" '
                    + 'onmouseover="this.style.color=\'#ef4444\';this.style.borderColor=\'rgba(239,68,68,0.5)\'" '
                    + 'onmouseout="this.style.color=\'var(--text-muted)\';this.style.borderColor=\'rgba(239,68,68,0.2)\'">\u2715 Remove</button>'
                    + '</div>';
                
                html += '</div>';
            });
            
            return html;
        }
        
        function renderFindJobs() {
            return '<div class="opportunities-header">'
                + '<h2 class="opportunities-title">Find Jobs</h2>'
                + '<p class="opportunities-subtitle">Matching your skills to open positions across the US</p>'
                + '<div class="opportunities-filters">'
                + '<div class="filter-section">'
                + '<label class="filter-section-label">Minimum Match Score</label>'
                + '<div style="display:flex; align-items:center; gap:15px;">'
                + '<input type="range" min="0" max="100" value="60" class="match-slider" oninput="updateMatchThreshold(this.value)">'
                + '<span class="match-value" id="matchValue">60%+</span>'
                + '</div></div>'
                + '<div class="filter-section">'
                + '<label class="filter-section-label">Search Roles</label>'
                + '<button class="action-btn" onclick="searchOpportunities()" style="width:auto;">'
                + '\uD83D\uDD0D Find Matching Jobs</button>'
                + '</div></div></div>'
                + '<div id="opportunitiesResults"></div>';
        }
        
        // ===== ADD JOB MODAL =====
        
        function showAddJobModal() {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            var savedKey = localStorage.getItem('wbAnthropicKey') || '';
            
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Add a Job</h2>'
                + '<p style="color:var(--text-muted); margin-top:5px;">Paste a job description to analyze your fit</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                
                // JD paste area
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px;">Job Description *</label>'
                + '<textarea id="jdTextInput" placeholder="Paste the full job description here..." style="'
                + 'width:100%; min-height:180px; padding:14px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:8px; color:var(--text-primary); '
                + 'font-size:0.92em; line-height:1.6; font-family:inherit; resize:vertical;"></textarea>'
                
                // Source URL
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:14px;">'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Source URL</label>'
                + '<input id="jdSourceUrl" placeholder="https://..." style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div>'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Source Note</label>'
                + '<input id="jdSourceNote" placeholder="e.g., Recruiter email, LinkedIn" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div></div>'
                
                // API key (collapsible)
                + '<details style="margin-top:16px;">'
                + '<summary style="cursor:pointer; font-size:0.82em; color:var(--text-muted);">'
                + '\u26A1 AI-powered analysis (optional, requires API key)</summary>'
                + '<div style="margin-top:8px; padding:12px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; '
                + 'border:1px solid var(--border); border-radius:8px;">'
                + '<input id="jdApiKey" type="password" placeholder="sk-ant-..." value="' + savedKey + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.88em; font-family:monospace;" />'
                + '<div style="font-size:0.75em; color:var(--text-muted); margin-top:6px; line-height:1.5;">'
                + 'Stored locally, never sent to our servers. Get a key at <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent);">console.anthropic.com</a>. '
                + 'Without a key, analysis uses local skill matching (still good, but less nuanced).'
                + '</div></div></details>'
                
                + '<div id="jdParsingStatus" style="display:none; margin-top:16px; padding:16px; border-radius:8px; text-align:center;"></div>'
                
                // Actions
                + '<div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">'
                + '<button onclick="closeExportModal()" style="'
                + 'background:transparent; color:var(--text-muted); border:1px solid var(--border); '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">Cancel</button>'
                + '<button id="analyzeJobBtn" onclick="analyzeJob()" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:10px 24px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.9em;">\uD83D\uDD0D Analyze Fit</button>'
                + '</div></div>';
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            setTimeout(function() { document.getElementById('jdTextInput').focus(); }, 100);
        }
        window.showAddJobModal = showAddJobModal;
        
        // ===== JOB ANALYSIS ENGINE =====
        
        async function analyzeJob() {
            var jdText = (document.getElementById('jdTextInput').value || '').trim();
            if (!jdText || jdText.length < 50) {
                showToast('Paste a job description (at least a few sentences).', 'warning');
                return;
            }
            
            var sourceUrl = (document.getElementById('jdSourceUrl').value || '').trim();
            var sourceNote = (document.getElementById('jdSourceNote').value || '').trim();
            var apiKey = (document.getElementById('jdApiKey').value || '').trim();
            
            // Save API key for reuse
            if (apiKey) localStorage.setItem('wbAnthropicKey', apiKey);
            
            // Show progress
            var statusEl = document.getElementById('jdParsingStatus');
            var btn = document.getElementById('analyzeJobBtn');
            statusEl.style.display = 'block';
            statusEl.style.background = tv('rgba(96,165,250,0.08)','rgba(30,64,175,0.06)');
            statusEl.innerHTML = '<div class="loading-spinner" style="width:24px; height:24px; border-width:2px; margin:0 auto 8px;"></div>'
                + '<div style="color:var(--text-secondary); font-size:0.88em;">'
                + (apiKey ? 'Analyzing with AI...' : 'Matching against skill library...') + '</div>';
            btn.disabled = true;
            btn.style.opacity = '0.5';
            
            try {
                var parsed;
                if (apiKey) {
                    parsed = await parseJobWithAPI(jdText, apiKey);
                } else {
                    parsed = parseJobLocally(jdText);
                }
                
                // Calculate match against user's skills
                var matchData = matchJobToProfile(parsed);
                
                // Build the job object
                var job = {
                    id: 'job-' + Date.now(),
                    title: parsed.title || 'Untitled Position',
                    company: parsed.company || '',
                    sourceUrl: sourceUrl,
                    sourceNote: sourceNote,
                    rawText: jdText.substring(0, 5000), // Cap storage
                    parsedSkills: parsed.skills || [],
                    parsedRoles: parsed.roles || [],
                    seniority: parsed.seniority || '',
                    matchData: matchData,
                    addedAt: new Date().toISOString()
                };
                
                // Save
                if (!userData.savedJobs) userData.savedJobs = [];
                if (userData.savedJobs.length >= 10) {
                    showToast('Job pipeline is full (10 max). Remove one first.', 'warning');
                    return;
                }
                userData.savedJobs.unshift(job);
                saveUserData();
                if (fbUser) saveToFirestore();
                
                closeExportModal();
                
                // Refresh the jobs view
                window.opportunitiesInitialized = false;
                switchView('opportunities');
                
                showToast('Job analyzed: ' + matchData.score + '% match with ' + (matchData.matched || []).length + ' skills aligned.', 'success', 5000);
                
            } catch (err) {
                console.error('Job analysis error:', err);
                statusEl.style.background = tv('rgba(239,68,68,0.08)','rgba(239,68,68,0.05)');
                statusEl.innerHTML = '<div style="color:#ef4444; font-size:0.88em;">\u26A0 ' + (err.message || 'Analysis failed.') + '</div>';
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }
        window.analyzeJob = analyzeJob;
        
        // ===== CLAUDE API PARSING =====
        
        async function parseJobWithAPI(jdText, apiKey) {
            var userSkillNames = (skillsData.skills || []).map(function(s) { return s.name; });
            
            var systemPrompt = 'You extract structured data from job descriptions. Respond ONLY with valid JSON, no markdown fences, no preamble.';
            var userPrompt = 'Extract from this job description:\n\n' + jdText.substring(0, 4000) + '\n\n'
                + 'Return JSON with this exact structure:\n'
                + '{\n'
                + '  "title": "Job title",\n'
                + '  "company": "Company name or empty string",\n'
                + '  "seniority": "Entry|Mid|Senior|Executive",\n'
                + '  "roles": ["functional area 1", "functional area 2"],\n'
                + '  "skills": [\n'
                + '    {"name": "Skill Name", "level": "Required|Preferred|Nice-to-have", "category": "Technical|Leadership|Business|Communication|Domain"}\n'
                + '  ]\n'
                + '}\n\n'
                + 'Rules:\n'
                + '- Extract 10-30 distinct skills from explicit requirements AND implied competencies\n'
                + '- Use professional skill names (e.g., "Strategic Planning" not "plan stuff")\n'
                + '- Where possible, use names from this list to maximize matching: ' + userSkillNames.slice(0, 50).join(', ') + '\n'
                + '- Include both hard and soft skills\n'
                + '- Infer skills from responsibilities even if not explicitly listed\n'
                + '- Set level: Required for must-haves, Preferred for should-haves, Nice-to-have for bonus skills';
            
            var response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 2000,
                    system: systemPrompt,
                    messages: [{ role: 'user', content: userPrompt }]
                })
            });
            
            if (!response.ok) {
                var errBody = await response.text().catch(function() { return ''; });
                if (response.status === 401) throw new Error('Invalid API key. Check your key at console.anthropic.com.');
                if (response.status === 429) throw new Error('Rate limited. Wait a moment and try again.');
                throw new Error('API error (' + response.status + '): ' + (errBody.substring(0, 100) || 'Unknown'));
            }
            
            var data = await response.json();
            var text = data.content.map(function(c) { return c.text || ''; }).join('');
            
            // Parse JSON, strip any fences
            text = text.replace(/```json|```/g, '').trim();
            var parsed = JSON.parse(text);
            return parsed;
        }
        
        // ===== LOCAL FALLBACK PARSING =====
        
        function parseJobLocally(jdText) {
            var text = jdText.toLowerCase();
            var lines = jdText.split('\n');
            
            // ===== TITLE EXTRACTION =====
            // Skip meta lines, find first line that looks like a job title
            var title = '';
            var company = '';
            var skipPatterns = /^(about|we are|our |the |at |join|summary|generated|posted|apply|location|date|salary|benefits|equal|eeo|disclaimer|copyright|\d+\s*(day|hour|week|ago))/i;
            var titlePatterns = /\b(manager|director|lead|head|chief|vp|vice|president|senior|junior|engineer|designer|developer|analyst|recruiter|coordinator|specialist|consultant|architect|strategist|officer|partner|associate|advisor|scientist)\b/i;
            
            for (var i = 0; i < Math.min(lines.length, 15); i++) {
                var line = lines[i].trim();
                if (line.length < 5 || line.length > 150) continue;
                if (skipPatterns.test(line)) continue;
                
                // Prefer lines that contain a role keyword
                if (!title && titlePatterns.test(line)) {
                    title = line.replace(/^(job title|position|role|opening|title)[\s:\-]+/i, '').trim();
                    continue;
                }
                // Otherwise take the first substantial non-meta line
                if (!title && line.length > 8 && line.length < 120) {
                    title = line;
                }
            }
            
            // Try to extract company from common patterns
            var companyMatch = jdText.match(/(?:company|employer|organization|at)\s*[:|\-]?\s*([A-Z][A-Za-z0-9\s&.,]+)/);
            if (companyMatch) company = companyMatch[1].trim().substring(0, 60);
            if (!company) {
                // Try "About [Company]" pattern
                var aboutMatch = jdText.match(/about\s+([A-Z][A-Za-z0-9\s&]+?)(?:\n|\.|\,)/);
                if (aboutMatch && aboutMatch[1].length < 50) company = aboutMatch[1].trim();
            }
            
            // ===== SKILL EXTRACTION =====
            var skillMatches = [];
            var seen = new Set();
            var allSkills = skillsData.skills || [];
            
            // First pass: match user's own skill names in JD text
            allSkills.forEach(function(skill) {
                var skillLower = skill.name.toLowerCase();
                if (skillLower.length > 3 && text.indexOf(skillLower) !== -1 && !seen.has(skillLower)) {
                    seen.add(skillLower);
                    skillMatches.push({
                        name: skill.name,
                        level: classifyRequirementLevel(text, skillLower),
                        category: skill.category || 'General'
                    });
                }
            });
            
            // Second pass: check the full O*NET library if loaded
            if (skillLibraryIndex && skillLibraryIndex.skills) {
                skillLibraryIndex.skills.forEach(function(libSkill) {
                    var n = (libSkill.name || libSkill.n || '').toLowerCase();
                    if (n.length > 3 && text.indexOf(n) !== -1 && !seen.has(n)) {
                        seen.add(n);
                        skillMatches.push({
                            name: libSkill.name || libSkill.n,
                            level: classifyRequirementLevel(text, n),
                            category: libSkill.category || libSkill.c || 'General'
                        });
                    }
                });
            }
            
            // Third pass: comprehensive skill keyword dictionary
            var skillDictionary = [
                // Recruiting & Talent
                'Talent Acquisition', 'Full-Cycle Recruiting', 'Sourcing', 'Boolean Search', 'Candidate Experience',
                'Employer Branding', 'Applicant Tracking System', 'ATS', 'Onboarding', 'Workforce Planning',
                'Diversity Recruiting', 'Campus Recruiting', 'Executive Search', 'Headhunting', 'Interviewing',
                'Offer Negotiation', 'Recruitment Marketing', 'Talent Pipeline', 'Screening', 'Reference Checking',
                // HR
                'Human Resources', 'Employee Relations', 'Performance Management', 'Compensation', 'Benefits Administration',
                'HRIS', 'Succession Planning', 'Organizational Development', 'Compliance', 'Labor Relations',
                'Employee Engagement', 'Retention', 'Training and Development', 'Learning and Development',
                // Project & Program Management
                'Project Management', 'Program Management', 'Strategic Planning', 'Roadmap', 'Risk Management',
                'Agile', 'Scrum', 'Kanban', 'Waterfall', 'Sprint Planning', 'JIRA', 'Confluence',
                'Stakeholder Management', 'Change Management', 'Process Improvement', 'Continuous Improvement',
                // Leadership
                'Team Leadership', 'People Management', 'Cross-Functional Collaboration', 'Mentoring',
                'Coaching', 'Executive Presence', 'Decision Making', 'Conflict Resolution', 'Delegation',
                // Communication
                'Communication', 'Presentation', 'Public Speaking', 'Technical Writing', 'Copywriting',
                'Storytelling', 'Negotiation', 'Persuasion', 'Active Listening', 'Relationship Building',
                // Technical
                'Python', 'JavaScript', 'TypeScript', 'React', 'Node.js', 'SQL', 'NoSQL',
                'AWS', 'Azure', 'GCP', 'Cloud Computing', 'DevOps', 'CI/CD', 'Docker', 'Kubernetes',
                'Machine Learning', 'Artificial Intelligence', 'Data Science', 'Data Engineering',
                'API Design', 'Microservices', 'System Design', 'Architecture',
                // Data & Analytics
                'Data Analysis', 'Business Intelligence', 'Tableau', 'Power BI', 'Excel',
                'SQL', 'Reporting', 'Dashboards', 'KPI', 'Metrics', 'Forecasting', 'Modeling',
                // Business
                'Business Development', 'Sales Strategy', 'Account Management', 'Pipeline Management',
                'Revenue Growth', 'Client Relations', 'Customer Success', 'Market Research',
                'Product Management', 'UX Design', 'User Research', 'A/B Testing', 'Go-to-Market',
                'Budgeting', 'Financial Analysis', 'P&L Management', 'Vendor Management',
                // Strategy
                'Strategy', 'Innovation', 'Transformation', 'Digital Transformation', 'Thought Leadership',
                'Competitive Analysis', 'Market Analysis', 'Business Strategy', 'GTM Strategy',
                // Marketing
                'Content Marketing', 'SEO', 'SEM', 'Social Media', 'Email Marketing', 'Brand Strategy',
                'Demand Generation', 'Lead Generation', 'Marketing Automation', 'CRM',
                // Soft Skills
                'Problem Solving', 'Critical Thinking', 'Analytical Thinking', 'Attention to Detail',
                'Time Management', 'Adaptability', 'Creativity', 'Emotional Intelligence',
                'Collaboration', 'Teamwork', 'Self-Motivation', 'Results-Oriented'
            ];
            
            skillDictionary.forEach(function(skill) {
                var lower = skill.toLowerCase();
                if (text.indexOf(lower) !== -1 && !seen.has(lower)) {
                    seen.add(lower);
                    skillMatches.push({ name: skill, level: classifyRequirementLevel(text, lower), category: 'General' });
                }
            });
            
            // Fourth pass: extract phrase-level skills from requirement lines
            // Look for bullet-pointed or numbered requirements
            var reqLines = jdText.split('\n').filter(function(line) {
                return /^\s*[\u2022\u2023\u25E6\u2043\-\*\u2713\u2714]\s|^\s*\d+[\.\)]\s|^\s*[a-z][\.\)]\s/i.test(line);
            });
            
            // Common skill-indicator phrases in requirements
            var phrasePatterns = [
                /(\d+)\+?\s*years?\s+(?:of\s+)?(?:experience\s+(?:in|with)\s+)?(.+?)(?:\.|,|;|$)/gi,
                /(?:proficien|experienc|knowledge|expertise|skill|familiar)\w*\s+(?:in|with|of)\s+(.+?)(?:\.|,|;|$)/gi,
                /(?:strong|excellent|proven|demonstrated)\s+(.+?)(?:\s+(?:skills?|abilities?|experience))(?:\.|,|;|$)/gi
            ];
            
            reqLines.forEach(function(line) {
                phrasePatterns.forEach(function(pat) {
                    var m;
                    pat.lastIndex = 0;
                    while ((m = pat.exec(line)) !== null) {
                        var extracted = (m[2] || m[1] || '').trim();
                        // Clean up and split on conjunctions
                        extracted.split(/\s*(?:and|or|,)\s*/).forEach(function(phrase) {
                            phrase = phrase.replace(/^\s*(?:a|an|the)\s+/i, '').trim();
                            if (phrase.length > 2 && phrase.length < 50 && !seen.has(phrase.toLowerCase())) {
                                seen.add(phrase.toLowerCase());
                                // Capitalize first letter of each word
                                var clean = phrase.replace(/\b\w/g, function(c) { return c.toUpperCase(); });
                                skillMatches.push({ name: clean, level: classifyRequirementLevel(text, phrase.toLowerCase()), category: 'Extracted' });
                            }
                        });
                    }
                });
            });
            
            // Determine seniority
            var seniority = 'Mid';
            if (/\b(vp|vice president|chief|c-suite|head of|svp|evp)\b/i.test(jdText)) seniority = 'Executive';
            else if (/\b(senior director|director|principal|senior manager)\b/i.test(jdText)) seniority = 'Senior';
            else if (/\b(junior|entry|associate|intern|coordinator)\b/i.test(jdText)) seniority = 'Entry';
            
            // Extract roles/departments
            var roles = [];
            var rolePatterns = { 'Engineering': /engineer|develop|software|technical/i, 'Product': /product|ux|design/i,
                'Marketing': /marketing|brand|content|growth/i, 'Sales': /sales|revenue|account|business development/i,
                'Data': /data|analy|science|ml|ai/i, 'Operations': /operations|supply|logistics/i,
                'Finance': /finance|accounting|budget|treasury/i, 'HR': /human resources|talent|recruiting|people/i,
                'Strategy': /strategy|strateg|transformation|innovation/i, 'Leadership': /leader|executive|management/i
            };
            Object.keys(rolePatterns).forEach(function(role) { if (rolePatterns[role].test(jdText)) roles.push(role); });
            if (roles.length === 0) roles.push('General');
            
            return {
                title: title || 'Untitled Position',
                company: company,
                seniority: seniority,
                roles: roles,
                skills: skillMatches.slice(0, 30)
            };
        }
        
        function classifyRequirementLevel(text, skillLower) {
            // Look for context around the skill mention
            var idx = text.indexOf(skillLower);
            if (idx === -1) return 'Required';
            var context = text.substring(Math.max(0, idx - 100), Math.min(text.length, idx + 100));
            if (/nice.to.have|bonus|plus|preferred|ideal/i.test(context)) return 'Nice-to-have';
            if (/prefer|desired|strongly prefer/i.test(context)) return 'Preferred';
            return 'Required';
        }
        
        // ===== MATCH CALCULATION =====
        
        function matchJobToProfile(parsed) {
            var jobSkills = parsed.skills || [];
            var userSkills = skillsData.skills || [];
            
            // Build lookup of user's skills (lowercase → skill object)
            var userMap = {};
            userSkills.forEach(function(s) {
                userMap[s.name.toLowerCase()] = s;
                // Also add key word variants
                var words = s.name.toLowerCase().split(/\s+/);
                if (words.length > 1) {
                    words.forEach(function(w) { if (w.length > 4 && !userMap[w]) userMap[w] = s; });
                }
            });
            
            var matched = [];
            var gaps = [];
            var matchedUserSkills = new Set();
            var totalWeight = 0;
            var earnedWeight = 0;
            
            jobSkills.forEach(function(jobSkill) {
                var weight = jobSkill.level === 'Required' ? 3 : jobSkill.level === 'Preferred' ? 2 : 1;
                totalWeight += weight;
                
                var jLower = jobSkill.name.toLowerCase();
                var jWords = jLower.split(/[\s\-\/]+/).filter(function(w) { return w.length > 2; });
                var found = null;
                var matchQuality = 0; // 0-1
                
                // Exact match
                if (userMap[jLower]) {
                    found = userMap[jLower];
                    matchQuality = 1.0;
                }
                
                // Fuzzy: substring containment
                if (!found) {
                    for (var key in userMap) {
                        if (key.length > 3 && (jLower.indexOf(key) !== -1 || key.indexOf(jLower) !== -1)) {
                            found = userMap[key];
                            matchQuality = 0.8;
                            break;
                        }
                    }
                }
                
                // Word overlap: if 50%+ of job skill words appear in a user skill name
                if (!found && jWords.length > 0) {
                    var bestOverlap = 0;
                    var bestSkill = null;
                    userSkills.forEach(function(s) {
                        var uWords = s.name.toLowerCase().split(/[\s\-\/]+/).filter(function(w) { return w.length > 2; });
                        var overlap = 0;
                        jWords.forEach(function(jw) {
                            if (uWords.some(function(uw) { return uw.indexOf(jw) !== -1 || jw.indexOf(uw) !== -1; })) overlap++;
                        });
                        var score = overlap / Math.max(jWords.length, 1);
                        if (score > bestOverlap && score >= 0.5) {
                            bestOverlap = score;
                            bestSkill = s;
                        }
                    });
                    if (bestSkill) {
                        found = bestSkill;
                        matchQuality = bestOverlap * 0.7;
                    }
                }
                
                if (found) {
                    // Proficiency bonus
                    var profBonus = found.level === 'Mastery' ? 1.0 : found.level === 'Expert' ? 0.9 :
                        found.level === 'Advanced' ? 0.75 : found.level === 'Proficient' ? 0.6 : 0.4;
                    earnedWeight += weight * profBonus * matchQuality;
                    matched.push({ jobSkill: jobSkill.name, userSkill: found.name, level: found.level, 
                        requirement: jobSkill.level, category: jobSkill.category });
                    matchedUserSkills.add(found.name.toLowerCase());
                } else {
                    gaps.push({ name: jobSkill.name, level: jobSkill.level, category: jobSkill.category });
                }
            });
            
            // Surplus: user skills not needed by job
            var surplus = [];
            userSkills.forEach(function(s) {
                if (!matchedUserSkills.has(s.name.toLowerCase())) {
                    surplus.push({ name: s.name, level: s.level, category: s.category });
                }
            });
            
            var score = totalWeight > 0 ? Math.round((earnedWeight / totalWeight) * 100) : 0;
            
            return {
                score: Math.min(score, 100),
                matched: matched,
                gaps: gaps,
                surplus: surplus,
                totalJobSkills: jobSkills.length,
                totalUserSkills: userSkills.length
            };
        }
        
        // ===== JOB DETAIL VIEW =====
        
        function showJobDetail(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job) return;
            
            var match = job.matchData || {};
            var matchPct = match.score || 0;
            var matchColor = matchPct >= 70 ? '#10b981' : matchPct >= 45 ? '#f59e0b' : '#6b7280';
            var matched = match.matched || [];
            var gaps = match.gaps || [];
            var surplus = match.surplus || [];
            
            var el = document.getElementById('jobsSubTabContent');
            if (!el) return;
            
            var html = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">'
                + '<button onclick="renderJobsSubTab()" style="background:none; border:none; color:var(--accent); '
                + 'cursor:pointer; font-size:0.88em; padding:0;">\u2190 Back to Pipeline</button>'
                + '<div style="display:flex; gap:8px;">'
                + '<button onclick="editJobInfo(' + idx + ')" style="background:none; border:1px solid var(--border); '
                + 'color:var(--text-muted); padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.78em;">\u270E Edit Info</button>'
                + '<button onclick="reanalyzeJob(' + idx + ')" style="background:none; border:1px solid var(--border); '
                + 'color:var(--text-muted); padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.78em;">\u21BB Re-analyze</button>'
                + '<button onclick="removeJob(' + idx + ')" style="background:none; border:1px solid rgba(239,68,68,0.3); '
                + 'color:#ef4444; padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.78em;">\u2715 Delete</button>'
                + '</div></div>';
            
            // Header
            html += '<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:24px; flex-wrap:wrap; gap:16px;">'
                + '<div>'
                + '<h2 style="font-size:1.5em; font-weight:700; color:var(--text-primary); margin:0;">' + (job.title || 'Untitled') + '</h2>'
                + '<div style="color:var(--text-muted); margin-top:4px;">' + (job.company || '') 
                + (job.sourceUrl ? ' \u00B7 <a href="' + job.sourceUrl + '" target="_blank" style="color:var(--accent);">View original</a>' : '') + '</div>'
                + '</div>'
                + '<div style="text-align:center; padding:12px 24px; border-radius:12px; '
                + 'background:' + matchColor + '15; border:2px solid ' + matchColor + '40;">'
                + '<div style="font-size:2em; font-weight:700; color:' + matchColor + ';">' + matchPct + '%</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Overall Match</div>'
                + '</div></div>';
            
            // Summary stats
            html += '<div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-bottom:24px;">'
                + '<div style="text-align:center; padding:16px; border-radius:10px; background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2);">'
                + '<div style="font-size:1.6em; font-weight:700; color:#10b981;">' + matched.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Skills Matched</div></div>'
                + '<div style="text-align:center; padding:16px; border-radius:10px; background:rgba(239,68,68,0.06); border:1px solid rgba(239,68,68,0.2);">'
                + '<div style="font-size:1.6em; font-weight:700; color:#ef4444;">' + gaps.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Gaps to Close</div></div>'
                + '<div style="text-align:center; padding:16px; border-radius:10px; background:rgba(107,114,128,0.06); border:1px solid rgba(107,114,128,0.15);">'
                + '<div style="font-size:1.6em; font-weight:700; color:#6b7280;">' + surplus.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Your Surplus</div></div>'
                + '</div>';
            
            // Matched skills
            if (matched.length > 0) {
                html += '<div style="margin-bottom:20px;">'
                    + '<h3 style="font-size:0.95em; font-weight:700; color:#10b981; margin-bottom:10px;">\u2713 Matched Skills</h3>'
                    + '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
                matched.forEach(function(m) {
                    var levelBadge = m.level ? ' \u00B7 ' + m.level : '';
                    var reqBadge = m.requirement === 'Required' ? ' \u2605' : '';
                    html += '<span class="jd-skill-chip jd-chip-matched">' + m.userSkill + levelBadge + reqBadge + '</span>';
                });
                html += '</div></div>';
            }
            
            // Gaps
            if (gaps.length > 0) {
                html += '<div style="margin-bottom:20px;">'
                    + '<h3 style="font-size:0.95em; font-weight:700; color:#ef4444; margin-bottom:10px;">\u25CB Gaps (Job Needs, You Don\u2019t Have)</h3>'
                    + '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
                gaps.forEach(function(g) {
                    var reqBadge = g.level === 'Required' ? ' \u2605' : '';
                    html += '<span class="jd-skill-chip jd-chip-gap">' + g.name + reqBadge + '</span>';
                });
                html += '</div>'
                    + '<div style="margin-top:8px; font-size:0.75em; color:var(--text-muted);">\u2605 = Required by employer</div>'
                    + '</div>';
            }
            
            // Top surplus (capped at 15 to avoid wall of chips)
            if (surplus.length > 0) {
                var showSurplus = surplus.filter(function(s) { return s.level === 'Mastery' || s.level === 'Expert' || s.level === 'Advanced'; }).slice(0, 15);
                if (showSurplus.length === 0) showSurplus = surplus.slice(0, 10);
                html += '<div style="margin-bottom:20px;">'
                    + '<h3 style="font-size:0.95em; font-weight:700; color:#6b7280; margin-bottom:10px;">\u25CF Your Surplus (Not Listed in JD)</h3>'
                    + '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
                showSurplus.forEach(function(s) {
                    html += '<span class="jd-skill-chip jd-chip-surplus">' + s.name + '</span>';
                });
                if (surplus.length > showSurplus.length) {
                    html += '<span style="font-size:0.75em; color:var(--text-muted); padding:4px 8px;">+' + (surplus.length - showSurplus.length) + ' more</span>';
                }
                html += '</div></div>';
            }
            
            // Action: view in network overlay
            html += '<div style="padding:20px; border-radius:10px; margin-top:16px; '
                + 'background:linear-gradient(135deg, rgba(30,64,175,0.1), rgba(96,165,250,0.05)); '
                + 'border:1px solid rgba(96,165,250,0.2);">'
                + '<div style="display:flex; align-items:center; gap:12px;">'
                + '<button onclick="activateJobOverlay(' + idx + ')" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:12px 24px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.95em; display:flex; align-items:center; gap:8px;">'
                + '\uD83D\uDD2E View Network Overlay</button>'
                + '<div style="font-size:0.85em; color:var(--text-muted);">See matched, gap, and surplus skills as connected nodes. Toggle between your network, job requirements, and the overlay.</div>'
                + '</div></div>';
            
            el.innerHTML = html;
        }
        window.showJobDetail = showJobDetail;
        
        function removeJob(idx) {
            if (!confirm('Remove this job from your pipeline?')) return;
            userData.savedJobs.splice(idx, 1);
            saveUserData();
            if (fbUser) saveToFirestore();
            // Clear overlay if this was the active job
            if (activeJobForNetwork && activeJobForNetwork.id === (userData.savedJobs[idx] || {}).id) {
                clearJobOverlay();
            }
            window.opportunitiesInitialized = false;
            switchView('opportunities');
        }
        window.removeJob = removeJob;
        
        function editJobInfo(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job) return;
            
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Edit Job Info</h2>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Job Title</label>'
                + '<input id="editJobTitle" value="' + (job.title || '').replace(/"/g, '&quot;') + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div>'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Company</label>'
                + '<input id="editJobCompany" value="' + (job.company || '').replace(/"/g, '&quot;') + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div></div>'
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Source URL</label>'
                + '<input id="editJobUrl" value="' + (job.sourceUrl || '').replace(/"/g, '&quot;') + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div>'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Source Note</label>'
                + '<input id="editJobNote" value="' + (job.sourceNote || '').replace(/"/g, '&quot;') + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div></div>'
                + '<div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">'
                + '<button onclick="closeExportModal()" style="'
                + 'background:transparent; color:var(--text-muted); border:1px solid var(--border); '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">Cancel</button>'
                + '<button onclick="saveJobEdit(' + idx + ')" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:10px 24px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.9em;">Save Changes</button>'
                + '</div></div>';
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.editJobInfo = editJobInfo;
        
        function saveJobEdit(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job) return;
            
            job.title = (document.getElementById('editJobTitle').value || '').trim() || job.title;
            job.company = (document.getElementById('editJobCompany').value || '').trim();
            job.sourceUrl = (document.getElementById('editJobUrl').value || '').trim();
            job.sourceNote = (document.getElementById('editJobNote').value || '').trim();
            
            saveUserData();
            if (fbUser) saveToFirestore();
            closeExportModal();
            showJobDetail(idx);
            showToast('Job info updated.', 'success');
        }
        window.saveJobEdit = saveJobEdit;
        
        function reanalyzeJob(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job || !job.rawText) {
                showToast('No raw JD text saved for this job.', 'warning');
                return;
            }
            
            var apiKey = localStorage.getItem('wbAnthropicKey') || '';
            
            // Re-parse
            var statusEl = document.getElementById('jobsSubTabContent');
            var origHtml = statusEl.innerHTML;
            statusEl.innerHTML = '<div style="text-align:center; padding:60px 20px;">'
                + '<div class="loading-spinner" style="width:30px; height:30px; border-width:2px; margin:0 auto 12px;"></div>'
                + '<div style="color:var(--text-muted);">Re-analyzing job description...</div></div>';
            
            (async function() {
                try {
                    var parsed;
                    if (apiKey) {
                        parsed = await parseJobWithAPI(job.rawText, apiKey);
                    } else {
                        parsed = parseJobLocally(job.rawText);
                    }
                    
                    var matchData = matchJobToProfile(parsed);
                    
                    // Update job
                    job.parsedSkills = parsed.skills || [];
                    job.parsedRoles = parsed.roles || [];
                    job.matchData = matchData;
                    if (parsed.title && parsed.title !== 'Untitled Position') job.title = parsed.title;
                    if (parsed.company) job.company = parsed.company;
                    
                    saveUserData();
                    if (fbUser) saveToFirestore();
                    
                    showJobDetail(idx);
                    showToast('Re-analyzed: ' + matchData.score + '% match with ' + (matchData.matched || []).length + ' skills.', 'success', 5000);
                } catch (err) {
                    statusEl.innerHTML = origHtml;
                    showToast('Re-analysis failed: ' + (err.message || 'Unknown error'), 'error');
                }
            })();
        }
        window.reanalyzeJob = reanalyzeJob;
        
        function updateMatchThreshold(value) {
            currentMatchThreshold = parseInt(value);
            document.getElementById('matchValue').textContent = value + '%+';
            filterOpportunities();
        }
        
        function calculateMatchScore(jobSkills, requiredSkills) {
            let totalPoints = 0;
            let earnedPoints = 0;
            let matchedSkills = [];
            let gapSkills = [];
            
            // Build lookup of your skills
            const yourSkillsMap = {};
            skillsData.skills.forEach(skill => {
                yourSkillsMap[skill.name.toLowerCase()] = skill;
                // Also add simplified versions
                const simplified = skill.name.toLowerCase()
                    .replace(/\s*&\s*/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                yourSkillsMap[simplified] = skill;
            });
            
            // Score each required skill
            requiredSkills.forEach(reqSkill => {
                const reqLower = reqSkill.toLowerCase();
                let matched = false;
                let matchPoints = 5; // base points for any match
                
                // Try exact match first
                if (yourSkillsMap[reqLower]) {
                    const yourSkill = yourSkillsMap[reqLower];
                    matched = true;
                    
                    // Weight by proficiency
                    if (yourSkill.level === 'Mastery') {
                        matchPoints = 10;
                    } else if (yourSkill.level === 'Advanced') {
                        matchPoints = 7;
                    } else if (yourSkill.level === 'Proficient') {
                        matchPoints = 5;
                    }
                    
                    // Bonus for core differentiators
                    if (yourSkill.key) {
                        matchPoints += 5;
                    }
                    
                    matchedSkills.push(yourSkill.name);
                } else {
                    // Try fuzzy matching for related skills
                    for (const [skillName, skillData] of Object.entries(yourSkillsMap)) {
                        if (reqLower.includes(skillName) || skillName.includes(reqLower)) {
                            matched = true;
                            matchPoints = 3; // partial match points
                            matchedSkills.push(skillData.name);
                            break;
                        }
                    }
                }
                
                totalPoints += 10; // Each required skill worth 10 points max
                if (matched) {
                    earnedPoints += matchPoints;
                } else {
                    gapSkills.push(reqSkill);
                }
            });
            
            const matchPercent = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
            
            return {
                score: matchPercent,
                matched: [...new Set(matchedSkills)], // Remove duplicates
                gaps: gapSkills
            };
        }
        
        
        async function fetchRemoteOKJobs() {
            try {
                // RemoteOK provides a public JSON API
                const response = await fetch('https://remoteok.com/api');
                const data = await response.json();
                
                // First item is metadata, skip it
                const jobs = data.slice(1);
                
                // STEP 1: Filter by ROLE LEVEL using user preferences
                const seniorityKeywords = userData.preferences.seniorityKeywords;
                const excludeKeywords = userData.preferences.excludeRoles;
                
                const executiveJobs = jobs.filter(job => {
                    const titleLower = job.position.toLowerCase();
                    
                    // If user sets threshold VERY low (0-20%), bypass ALL seniority filtering
                    // This shows them everything including jobs they're overqualified for
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true; // Show everything
                    }
                    
                    // EXCLUDE: Roles user doesn't want
                    if (excludeKeywords.some(keyword => titleLower.includes(keyword))) {
                        return false;
                    }
                    
                    // INCLUDE: Must match user's seniority level
                    const hasSeniority = seniorityKeywords.some(keyword => titleLower.includes(keyword));
                    if (!hasSeniority) return false;
                    
                    // STEP 2: Filter by ROLE TYPE using user's strategic keywords
                    const strategicKeywords = userData.preferences.strategicKeywords;
                    const hasStrategicRole = strategicKeywords.some(keyword => titleLower.includes(keyword));
                    
                    return hasStrategicRole;
                });
                
                console.log(`RemoteOK: Filtered to ${executiveJobs.length} matching roles from ${jobs.length} total`);
                
                // STEP 3: Enhanced skill extraction and matching
                const qualifiedJobs = executiveJobs.map(job => {
                    const extractedSkills = extractSkillsFromJobEnhanced(job);
                    const match = calculateMatchScore(extractedSkills, extractedSkills);
                    
                    return {
                        id: job.id || Math.random().toString(36),
                        title: job.position,
                        company: job.company,
                        location: job.location || 'Remote',
                        type: 'Full-time',
                        url: job.url || `https://remoteok.com/remote-jobs/${job.slug}`,
                        salary: job.salary_max ? `$${Math.round(job.salary_min/1000) || 0}k-${Math.round(job.salary_max/1000)}k` : 'Not specified',
                        description: job.description,
                        tags: job.tags || [],
                        requiredSkills: extractedSkills,
                        matchScore: match.score,
                        matchedSkills: match.matched,
                        gapSkills: match.gaps,
                        source: 'RemoteOK'
                    };
                }).filter(job => {
                    // STEP 4: Apply flexible quality thresholds
                    // If threshold is VERY low (0-20%), show ALL jobs (user wants to see everything)
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true; // Bypass all quality filters
                    }
                    
                    // Otherwise use normal filters
                    const meetsSkillMinimum = job.matchedSkills.length >= userData.preferences.minimumSkillMatches;
                    const meetsScoreMinimum = job.matchScore >= userData.preferences.minimumMatchScore;
                    const meetsSalary = !userData.preferences.minSalary || 
                                       (job.salary && parseInt(job.salary.split('-')[1]) >= userData.preferences.minSalary/1000);
                    
                    return meetsSkillMinimum && meetsScoreMinimum && meetsSalary;
                });
                
                console.log(`RemoteOK: ${qualifiedJobs.length} qualified jobs`);
                return qualifiedJobs;
                
            } catch (error) {
                console.error('Error fetching RemoteOK jobs:', error);
                return [];
            }
        }
        
        function extractSkillsFromJobEnhanced(job) {
            const searchText = `${job.position} ${job.description || ''} ${(job.tags || []).join(' ')}`.toLowerCase();
            const extractedSkills = [];
            
            // ENHANCED: Expanded skill mapping with synonyms and variations
            const skillMapping = {
                // Strategic Core
                'Enterprise AI Strategy': ['ai strategy', 'artificial intelligence strategy', 'enterprise ai', 'ai transformation', 'ai roadmap', 'ai leadership'],
                'Strategic Foresight & Market Prediction': ['market prediction', 'strategic foresight', 'forecasting', 'trend analysis', 'future of work', 'market intelligence', 'competitive intelligence'],
                'Go-to-Market Strategy': ['go-to-market', 'gtm strategy', 'market strategy', 'launch strategy', 'product launch', 'market entry'],
                'Business Case Development': ['business case', 'roi analysis', 'business development', 'financial modeling', 'investment analysis'],
                'C-Suite Advisory & Influence': ['c-suite', 'executive advisory', 'board advisory', 'executive coaching', 'executive stakeholder', 'ceo advisor'],
                'Organizational Transformation': ['transformation', 'change management', 'organizational change', 'digital transformation', 'org transformation', 'restructuring'],
                
                // Technology & Innovation
                'AI/ML Product Strategy': ['ai product', 'ml product', 'machine learning strategy', 'ai/ml', 'ai product management', 'ml roadmap'],
                'Technology Trend Forecasting': ['technology trends', 'tech forecasting', 'innovation trends', 'emerging tech', 'technology radar'],
                'Disruptive Innovation Identification': ['disruptive innovation', 'innovation strategy', 'breakthrough innovation', 'radical innovation'],
                'Human-AI Collaboration Model Design': ['human-ai', 'ai collaboration', 'human-centered ai', 'ai interaction', 'human augmentation'],
                'Technology Lifecycle & Disruption Analysis': ['technology lifecycle', 'disruption analysis', 'tech adoption', 'innovation curve'],
                'Platform Integration Architecture': ['platform integration', 'system architecture', 'enterprise architecture', 'integration strategy'],
                
                // Communication & Leadership
                'Industry Evangelism': ['evangelist', 'developer relations', 'community building', 'developer advocacy', 'technical evangelism'],
                'Thought Leadership Authorship': ['thought leadership', 'content strategy', 'industry speaking', 'executive writing', 'industry expert'],
                'Technical Concept Translation': ['technical communication', 'executive communication', 'technical writing', 'concept translation'],
                'Public Speaking & Keynote Delivery': ['public speaking', 'keynote', 'conference speaking', 'presentations', 'speaker'],
                'Media Relations & Spokesperson Work': ['media relations', 'spokesperson', 'press relations', 'public relations', 'media spokesperson'],
                
                // Domain Expertise - Talent/HR Tech
                'Talent Intelligence Platform Design': ['talent platform', 'hr tech', 'talent technology', 'talent systems', 'hris', 'applicant tracking'],
                'Workforce Intelligence & Analytics': ['workforce analytics', 'people analytics', 'talent analytics', 'hr analytics', 'workforce planning'],
                'HR Technology Market Intelligence': ['hr technology', 'hrtech', 'talent tech', 'hr software', 'talent management'],
                'Talent Acquisition Strategy': ['talent acquisition', 'recruitment strategy', 'hiring strategy', 'sourcing strategy', 'recruiting'],
                'Candidate Experience Architecture': ['candidate experience', 'recruitment experience', 'hiring experience', 'candidate journey'],
                
                // Leadership & Management
                'Executive Presence & Authority': ['executive presence', 'executive leadership', 'leadership presence', 'executive impact'],
                'Crisis Leadership & Decision Making': ['crisis management', 'crisis leadership', 'emergency response', 'incident management'],
                'Strategic Team Building': ['team building', 'organizational design', 'team strategy', 'talent development', 'team leadership'],
                'Multi-Stakeholder Alignment': ['stakeholder management', 'stakeholder alignment', 'cross-functional', 'stakeholder engagement'],
                'Revenue Pipeline Development': ['pipeline development', 'revenue strategy', 'sales pipeline', 'pipeline management'],
                
                // Data & Analysis
                'Data-Driven Strategy Development': ['data-driven', 'data strategy', 'analytics strategy', 'data-informed', 'evidence-based'],
                'Predictive Framework Development': ['predictive framework', 'predictive modeling', 'forecasting models', 'prediction systems'],
                'Research Synthesis & Forecasting': ['research synthesis', 'market research', 'competitive analysis', 'industry research'],
                'Critical Analysis & Evaluation': ['critical analysis', 'evaluation', 'assessment', 'analytical thinking'],
                
                // Product & Strategy
                'Scenario Planning & Strategic Alternatives': ['scenario planning', 'strategic planning', 'contingency planning', 'alternative strategies'],
                'Rhetorical Strategy & Persuasion': ['persuasion', 'influence', 'negotiation', 'storytelling'],
                'Customer Advisory Board Leadership': ['advisory board', 'customer advisory', 'cab leadership', 'advisory council'],
                'Enterprise Client Relationship Management': ['enterprise sales', 'account management', 'client relationship', 'enterprise accounts']
            };
            
            // Weight skills by importance in job posting
            const skillMatches = {};
            
            Object.entries(skillMapping).forEach(([skill, keywords]) => {
                let matchCount = 0;
                let matchWeight = 0;
                
                keywords.forEach((keyword) => {
                    const regex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                    const matches = searchText.match(regex);
                    if (matches) {
                        matchCount += matches.length;
                        
                        // Weight based on where keyword appears
                        if (job.position.toLowerCase().includes(keyword)) {
                            matchWeight += 3;  // Title match is most important
                        } else if (searchText.indexOf(keyword) < 200) {
                            matchWeight += 2;  // Early mention is important
                        } else {
                            matchWeight += 1;  // Later mention
                        }
                    }
                });
                
                if (matchCount > 0) {
                    skillMatches[skill] = matchWeight;
                }
            });
            
            // Sort by weight and extract top matches
            const sortedSkills = Object.entries(skillMatches)
                .sort((a, b) => b[1] - a[1])
                .map(([skill]) => skill);
            
            return sortedSkills;
        }
        
        function loadSampleData() {
            const sampleJobs = [
                {
                    id: 1,
                    title: "VP of AI Strategy",
                    company: "TechCorp",
                    location: "San Francisco, CA / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$200k-$300k",
                    requiredSkills: ["Enterprise AI Strategy", "Strategic Foresight & Market Prediction", "C-Suite Advisory & Influence", "Technology Trend Forecasting", "Business Case Development", "Go-to-Market Strategy"]
                },
                {
                    id: 2,
                    title: "Chief Strategy Officer",
                    company: "GrowthCo",
                    location: "New York, NY / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$250k-$350k",
                    requiredSkills: ["Go-to-Market Strategy", "Business Case Development", "Strategic Foresight & Market Prediction", "Multi-Stakeholder Alignment", "Revenue Pipeline Development", "Financial Management & Budget Discipline"]
                },
                {
                    id: 3,
                    title: "Director of Technology Strategy",
                    company: "Innovation Labs",
                    location: "Austin, TX / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$180k-$240k",
                    requiredSkills: ["Technology Lifecycle & Disruption Analysis", "Platform Integration Architecture", "Computational & Systems Thinking", "Data-Driven Strategy Development", "Market & Competitive Intelligence"]
                },
                {
                    id: 4,
                    title: "Head of Talent Intelligence",
                    company: "WorkTech Inc",
                    location: "Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$160k-$220k",
                    requiredSkills: ["Talent Intelligence Platform Design", "Workforce Intelligence & Analytics", "AI/ML Product Strategy", "Candidate Experience Architecture", "Talent Acquisition Strategy", "HR Technology Market Intelligence"]
                },
                {
                    id: 5,
                    title: "Chief Evangelist",
                    company: "AI Startup",
                    location: "Boston, MA / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$150k-$200k + equity",
                    requiredSkills: ["Industry Evangelism", "Technical Concept Translation", "Thought Leadership Authorship", "Public Speaking & Keynote Delivery", "Media Relations & Spokesperson Work"]
                },
                {
                    id: 6,
                    title: "VP of Product Strategy",
                    company: "SaaS Platform",
                    location: "Seattle, WA / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$190k-$260k",
                    requiredSkills: ["AI/ML Product Strategy", "Human-AI Collaboration Model Design", "Predictive Framework Development", "Scenario Planning & Strategic Alternatives", "Disruptive Innovation Identification"]
                }
            ];
            
            opportunitiesData = sampleJobs.map(job => {
                const match = calculateMatchScore(job.requiredSkills, job.requiredSkills);
                return {
                    ...job,
                    matchScore: match.score,
                    matchedSkills: match.matched,
                    gapSkills: match.gaps
                };
            });
            
            opportunitiesData.sort((a, b) => b.matchScore - a.matchScore);
            renderOpportunities();
        }
        
        function extractSkillsFromJob(job) {
            // Extract skills from job description and tags
            const searchText = `${job.position} ${job.description || ''} ${(job.tags || []).join(' ')}`.toLowerCase();
            const extractedSkills = [];
            
            // Map common job keywords to Cliff's skills
            const skillKeywords = {
                'ai strategy': 'Enterprise AI Strategy',
                'artificial intelligence': 'AI/ML Product Strategy',
                'machine learning': 'AI/ML Product Strategy',
                'strategic planning': 'Strategic Foresight & Market Prediction',
                'business strategy': 'Go-to-Market Strategy',
                'product strategy': 'AI/ML Product Strategy',
                'thought leadership': 'Thought Leadership Authorship',
                'public speaking': 'Public Speaking & Keynote Delivery',
                'evangelist': 'Industry Evangelism',
                'technology strategy': 'Technology Lifecycle & Disruption Analysis',
                'data analytics': 'Data-Driven Strategy Development',
                'talent': 'Talent Acquisition Strategy',
                'hr tech': 'HR Technology Market Intelligence',
                'workforce': 'Workforce Intelligence & Analytics',
                'crisis management': 'Crisis Leadership & Decision Making',
                'team building': 'Strategic Team Building',
                'c-suite': 'C-Suite Advisory & Influence',
                'executive': 'Executive Presence & Authority',
                'innovation': 'Disruptive Innovation Identification',
                'transformation': 'Organizational Transformation',
                'advisory': 'C-Suite Advisory & Influence'
            };
            
            // Check which skills are mentioned
            Object.entries(skillKeywords).forEach(([keyword, skill]) => {
                if (searchText.includes(keyword) && !extractedSkills.includes(skill)) {
                    extractedSkills.push(skill);
                }
            });
            
            // If no specific skills found, add some generic strategic ones
            if (extractedSkills.length === 0) {
                extractedSkills.push('Strategic Foresight & Market Prediction', 'Go-to-Market Strategy', 'Business Case Development');
            }
            
            return extractedSkills;
        }
        
        function filterOpportunities() {
            renderOpportunities();
        }
        
        function renderOpportunities() {
            const filtered = opportunitiesData.filter(job => job.matchScore >= currentMatchThreshold);
            const resultsDiv = document.getElementById('opportunitiesResults');
            
            if (filtered.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="loading-state">
                        <p style="font-size: 1.2em;">No opportunities match your current filters</p>
                        <p style="margin-top: 10px;">Try lowering the match threshold or searching for new jobs</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="opportunities-grid">';
            
            filtered.forEach(job => {
                const matchClass = job.matchScore >= 80 ? 'high' : job.matchScore >= 60 ? 'medium' : 'low';
                const jobUrl = job.url || '#';
                const salary = job.salary || 'Salary not specified';
                
                html += `
                    <div class="opportunity-card">
                        <div class="opportunity-header">
                            <div>
                                <div class="opportunity-company">${job.company}</div>
                                <div class="opportunity-title">
                                    <a href="${jobUrl}" target="_blank" style="color: inherit; text-decoration: none;">
                                        ${job.title}
                                    </a>
                                </div>
                            </div>
                            <div class="match-score">
                                <div class="match-circle ${matchClass}">
                                    ${job.matchScore}%
                                </div>
                                <div class="match-label">Match</div>
                            </div>
                        </div>
                        
                        <div class="opportunity-meta">
                            <div class="meta-item">📍 ${job.location}</div>
                            <div class="meta-item">💼 ${job.type}</div>
                            <div class="meta-item">💰 ${salary}</div>
                            ${job.source ? `<div class="meta-item" style="color: #10b981;">🌐 ${job.source}</div>` : ''}
                        </div>
                        
                        <div class="matched-skills">
                            <div class="matched-skills-title">Your Matching Skills (${job.matchedSkills.length})</div>
                            <div class="skill-chips">
                                ${job.matchedSkills.slice(0, 5).map(skill => 
                                    `<span class="skill-chip-match">${skill}</span>`
                                ).join('')}
                                ${job.matchedSkills.length > 5 ? 
                                    `<span class="skill-chip-match">+${job.matchedSkills.length - 5} more</span>` : ''}
                            </div>
                        </div>
                        
                        ${job.gapSkills.length > 0 ? `
                            <div class="matched-skills">
                                <div class="matched-skills-title">Skills to Highlight (${job.gapSkills.length})</div>
                                <div class="skill-chips">
                                    ${job.gapSkills.slice(0, 3).map(skill => 
                                        `<span class="skill-chip-gap">${skill}</span>`
                                    ).join('')}
                                    ${job.gapSkills.length > 3 ? 
                                        `<span class="skill-chip-gap">+${job.gapSkills.length - 3} more</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="opportunity-actions">
                            <button class="action-btn" onclick="event.stopPropagation(); window.open('${jobUrl}', '_blank')">
                                🔗 View Job
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); generatePitch(${job.id})">
                                ✍️ Generate Pitch
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); viewOnNetwork(${job.id})">
                                🗺️ View on Network
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        function searchOpportunities() {
            const resultsDiv = document.getElementById('opportunitiesResults');
            resultsDiv.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p style="font-size: 1.2em;">Searching 4 job boards...</p>
                    <p style="margin-top: 10px; color: #6b7280;">RemoteOK, Remotive, Arbeitnow, WeWorkRemotely</p>
                </div>
            `;
            
            // Fetch from multiple sources simultaneously
            Promise.all([
                fetchRemoteOKJobs().catch(e => { console.error('RemoteOK failed:', e); return []; }),
                fetchRemotiveJobs().catch(e => { console.error('Remotive failed:', e); return []; }),
                fetchArbeitnowJobs().catch(e => { console.error('Arbeitnow failed:', e); return []; }),
                fetchWeWorkRemotelyJobs().catch(e => { console.error('WeWorkRemotely failed:', e); return []; })
            ]).then(results => {
                // Combine and deduplicate
                const allJobs = results.flat();
                
                // Deduplicate by title + company
                const seen = new Set();
                opportunitiesData = allJobs.filter(job => {
                    const key = `${job.title}-${job.company}`.toLowerCase();
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
                
                // Sort by match score
                opportunitiesData.sort((a, b) => b.matchScore - a.matchScore);
                
                console.log(`Total jobs after deduplication: ${opportunitiesData.length}`);
                
                if (opportunitiesData.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="loading-state">
                            <p style="font-size: 1.2em;">No jobs match your criteria</p>
                            <p style="margin-top: 10px; color: #9ca3af;">
                                Current settings:
                                <br>• Seniority: ${userData.preferences.seniorityLevel}
                                <br>• Min Match Score: ${userData.preferences.minimumMatchScore}%
                                <br>• Min Skills: ${userData.preferences.minimumSkillMatches}
                                <br><br>
                                <strong style="color: #60a5fa;">💡 TIP:</strong> Lower the match threshold above to <strong>0-20%</strong> to see ALL jobs (including ones you're overqualified for).
                                <br><br>
                                Or try:
                                <br>• Adjusting preferences in Settings tab
                                <br>• Checking back later
                            </p>
                            <button class="action-btn" onclick="loadSampleData()" style="margin-top: 20px;">
                                View Sample Jobs Instead
                            </button>
                        </div>
                    `;
                    return;
                }
                
                renderOpportunities();
            });
        }
        
        async function fetchWeWorkRemotelyJobs() {
            try {
                // WeWorkRemotely doesn't have a public API, but we can try to fetch their RSS feed
                // This is a fallback approach - in production you'd want server-side scraping
                console.log('Attempting to fetch WeWorkRemotely jobs...');
                
                // For now, return sample data that looks like WeWorkRemotely results
                // In production, this would be replaced with actual scraping
                const wwrSampleJobs = [
                    {
                        title: "Director of Product Strategy",
                        company: "Remote Tech Co",
                        location: "Remote (Worldwide)",
                        type: "Full-time",
                        url: "https://weworkremotely.com/",
                        salary: "$160k-$220k",
                        description: "Lead product strategy for B2B SaaS platform. Work with executive team on roadmap and vision.",
                        requiredSkills: ["AI/ML Product Strategy", "Go-to-Market Strategy", "Strategic Foresight & Market Prediction"]
                    },
                    {
                        title: "VP of Customer Success",
                        company: "SaaS Growth Inc",
                        location: "Remote (US)",
                        type: "Full-time",
                        url: "https://weworkremotely.com/",
                        salary: "$180k-$240k",
                        description: "Build and scale customer success organization. Report to CEO.",
                        requiredSkills: ["Customer Advisory Board Leadership", "Enterprise Client Relationship Management", "Strategic Team Building"]
                    }
                ];
                
                return wwrSampleJobs.map(job => {
                    const match = calculateMatchScore(job.requiredSkills, job.requiredSkills);
                    return {
                        id: Math.random().toString(36).substr(2, 9),
                        ...job,
                        matchScore: match.score,
                        matchedSkills: match.matched,
                        gapSkills: match.gaps,
                        source: 'WeWorkRemotely'
                    };
                }).filter(job => {
                    const meetsSkillMinimum = job.matchedSkills.length >= userData.preferences.minimumSkillMatches;
                    const meetsScoreMinimum = job.matchScore >= userData.preferences.minimumMatchScore;
                    return meetsSkillMinimum && meetsScoreMinimum;
                });
                
            } catch (error) {
                console.error('WeWorkRemotely fetch error:', error);
                return [];
            }
        }
        
        async function fetchRemotiveJobs() {
            try {
                console.log('Fetching from Remotive.io API...');
                
                // Remotive has a free public API
                const response = await fetch('https://remotive.com/api/remote-jobs');
                const data = await response.json();
                
                if (!data.jobs || data.jobs.length === 0) {
                    console.log('Remotive: No jobs returned');
                    return [];
                }
                
                // Filter and map Remotive jobs
                const jobs = data.jobs.slice(0, 100); // Limit to first 100 for performance
                
                // Apply same filtering logic
                const seniorityKeywords = userData.preferences.seniorityKeywords;
                const excludeKeywords = userData.preferences.excludeRoles;
                const strategicKeywords = userData.preferences.strategicKeywords;
                
                const filteredJobs = jobs.filter(job => {
                    const titleLower = job.title.toLowerCase();
                    
                    // Bypass filters if threshold is very low
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true;
                    }
                    
                    // EXCLUDE
                    if (excludeKeywords.some(keyword => titleLower.includes(keyword))) {
                        return false;
                    }
                    
                    // INCLUDE seniority
                    const hasSeniority = seniorityKeywords.some(keyword => titleLower.includes(keyword));
                    if (!hasSeniority) return false;
                    
                    // Strategic keywords
                    const hasStrategicRole = strategicKeywords.some(keyword => titleLower.includes(keyword));
                    return hasStrategicRole;
                });
                
                const processedJobs = filteredJobs.map(job => {
                    const extractedSkills = extractSkillsFromJobEnhanced({
                        position: job.title,
                        description: job.description,
                        tags: job.tags || []
                    });
                    const match = calculateMatchScore(extractedSkills, extractedSkills);
                    
                    return {
                        id: `remotive-${job.id}`,
                        title: job.title,
                        company: job.company_name,
                        location: job.candidate_required_location || 'Remote',
                        type: job.job_type || 'Full-time',
                        url: job.url,
                        salary: job.salary || 'Not specified',
                        description: job.description,
                        tags: job.tags || [],
                        requiredSkills: extractedSkills,
                        matchScore: match.score,
                        matchedSkills: match.matched,
                        gapSkills: match.gaps,
                        source: 'Remotive'
                    };
                }).filter(job => {
                    // Apply quality thresholds
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true;
                    }
                    
                    const meetsSkillMinimum = job.matchedSkills.length >= userData.preferences.minimumSkillMatches;
                    const meetsScoreMinimum = job.matchScore >= userData.preferences.minimumMatchScore;
                    return meetsSkillMinimum && meetsScoreMinimum;
                });
                
                console.log(`Remotive: ${processedJobs.length} qualified jobs`);
                return processedJobs;
                
            } catch (error) {
                console.error('Remotive fetch error:', error);
                return [];
            }
        }
        
        async function fetchArbeitnowJobs() {
            try {
                console.log('Fetching from Arbeitnow API...');
                
                // Arbeitnow is a free job board API
                const response = await fetch('https://www.arbeitnow.com/api/job-board-api');
                const data = await response.json();
                
                if (!data.data || data.data.length === 0) {
                    console.log('Arbeitnow: No jobs returned');
                    return [];
                }
                
                const jobs = data.data.slice(0, 100);
                
                // Apply filtering
                const seniorityKeywords = userData.preferences.seniorityKeywords;
                const excludeKeywords = userData.preferences.excludeRoles;
                const strategicKeywords = userData.preferences.strategicKeywords;
                
                const filteredJobs = jobs.filter(job => {
                    const titleLower = job.title.toLowerCase();
                    
                    // Bypass if threshold very low
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true;
                    }
                    
                    // EXCLUDE
                    if (excludeKeywords.some(keyword => titleLower.includes(keyword))) {
                        return false;
                    }
                    
                    // INCLUDE seniority
                    const hasSeniority = seniorityKeywords.some(keyword => titleLower.includes(keyword));
                    if (!hasSeniority) return false;
                    
                    // Strategic
                    const hasStrategicRole = strategicKeywords.some(keyword => titleLower.includes(keyword));
                    return hasStrategicRole;
                });
                
                const processedJobs = filteredJobs.map(job => {
                    const extractedSkills = extractSkillsFromJobEnhanced({
                        position: job.title,
                        description: job.description,
                        tags: job.tags || []
                    });
                    const match = calculateMatchScore(extractedSkills, extractedSkills);
                    
                    return {
                        id: `arbeitnow-${job.slug}`,
                        title: job.title,
                        company: job.company_name,
                        location: job.location || 'Remote',
                        type: job.job_types?.[0] || 'Full-time',
                        url: job.url,
                        salary: 'Not specified',
                        description: job.description,
                        tags: job.tags || [],
                        requiredSkills: extractedSkills,
                        matchScore: match.score,
                        matchedSkills: match.matched,
                        gapSkills: match.gaps,
                        source: 'Arbeitnow'
                    };
                }).filter(job => {
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true;
                    }
                    
                    const meetsSkillMinimum = job.matchedSkills.length >= userData.preferences.minimumSkillMatches;
                    const meetsScoreMinimum = job.matchScore >= userData.preferences.minimumMatchScore;
                    return meetsSkillMinimum && meetsScoreMinimum;
                });
                
                console.log(`Arbeitnow: ${processedJobs.length} qualified jobs`);
                return processedJobs;
                
            } catch (error) {
                console.error('Arbeitnow fetch error:', error);
                return [];
            }
        }
        
        function viewOpportunityDetail(jobId) {
            const job = opportunitiesData.find(j => j.id === jobId);
            showToast(`${job.title} at ${job.company}: ${job.matchScore}% match, ${job.matchedSkills.length} skills matched. Detail view coming soon.`, 'info', 5000);
        }
        
        function generatePitch(jobId) {
            const job = opportunitiesData.find(j => j.id === jobId);
            if (!job) return;
            
            // Get shared outcomes from blueprint
            const sharedOutcomes = blueprintData.outcomes.filter(o => o.shared);
            const selectedValues = blueprintData.values.filter(v => v.selected);
            
            // Build pitch using matched skills
            let pitch = `Dear Hiring Manager,\n\n`;
            pitch += `I'm writing to express my interest in the ${job.title} position at ${job.company}. `;
            pitch += `My background aligns strongly with your requirements, with a ${job.matchScore}% match to the role's key competencies.\n\n`;
            
            // Outcomes section
            if (sharedOutcomes.length > 0) {
                pitch += `**Key Outcomes I've Driven:**\n\n`;
                // Prioritize outcomes related to matched skills
                const relevantOutcomes = sharedOutcomes.filter(outcome => 
                    job.matchedSkills.some(skill => outcome.skill.includes(skill) || outcome.text.toLowerCase().includes(skill.toLowerCase()))
                ).slice(0, 3);
                
                if (relevantOutcomes.length > 0) {
                    relevantOutcomes.forEach(outcome => {
                        pitch += `• ${outcome.text}\n`;
                    });
                } else {
                    sharedOutcomes.slice(0, 3).forEach(outcome => {
                        pitch += `• ${outcome.text}\n`;
                    });
                }
                pitch += `\n`;
            }
            
            // Skills match section
            pitch += `**Your Requirements - My Experience:**\n\n`;
            job.matchedSkills.slice(0, 5).forEach(skill => {
                const skillData = skillsData.skills.find(s => s.name === skill);
                const evidence = skillsData.skillDetails[skill];
                if (evidence && evidence.evidence && evidence.evidence.length > 0) {
                    pitch += `• **${skill}**: ${evidence.evidence[0]}\n`;
                } else {
                    pitch += `• **${skill}**: ${skillData ? skillData.level + ' level proficiency' : 'Demonstrated expertise'}\n`;
                }
            });
            pitch += `\n`;
            
            // Values alignment
            if (selectedValues.length > 0) {
                pitch += `**My Approach:**\n\n`;
                pitch += `I bring ${selectedValues.map(v => v.name.toLowerCase()).slice(0, 3).join(', ')} to this role. `;
                if (blueprintData.purpose) {
                    pitch += blueprintData.purpose;
                }
                pitch += `\n\n`;
            }
            
            pitch += `I'd welcome the opportunity to discuss how my experience can contribute to ${job.company}'s success.\n\n`;
            pitch += `Best regards,\n${userData.profile.name || 'Your Name'}`;
            
            // Show pitch in modal
            showPitchModal(job, pitch);
        }
        
        function showPitchModal(job, pitch) {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Generated Pitch</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">${job.title} at ${job.company}</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <textarea id="pitchText" style="width: 100%; min-height: 400px; background: transparent; border: none; color: #e0e0e0; font-family: inherit; font-size: 0.95em; line-height: 1.7; resize: vertical;">${pitch}</textarea>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="action-btn" onclick="copyPitch()" style="padding: 10px 20px;">
                            📋 Copy to Clipboard
                        </button>
                        <button class="action-btn" onclick="downloadPitch('${job.title}', '${job.company}')" style="padding: 10px 20px;">
                            💾 Download as Text
                        </button>
                        <button class="action-btn" onclick="trackFromPitch('${job.id}')" style="padding: 10px 20px; background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981;">
                            ➕ Track Application
                        </button>
                        <button class="export-btn-large" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Done
                        </button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function copyPitch() {
            const pitchText = document.getElementById('pitchText');
            pitchText.select();
            document.execCommand('copy');
            showToast('Pitch copied to clipboard.', 'success');
        }
        
        function downloadPitch(jobTitle, company) {
            const pitchText = document.getElementById('pitchText').value;
            const blob = new Blob([pitchText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pitch-${jobTitle.replace(/\s+/g, '-')}-${company.replace(/\s+/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function trackFromPitch(jobId) {
            const job = opportunitiesData.find(j => j.id == jobId);
            if (!job) return;
            
            closeExportModal();
            addApplicationModal(job);
        }
        
        function viewOnNetwork(jobId) {
            const job = opportunitiesData.find(j => j.id === jobId);
            if (!job) return;
            
            // Store job for network highlighting
            window.currentHighlightJob = job;
            
            // Switch to Skills Ontology view (network mode)
            currentView = 'network';
            currentSkillsView = 'network';
            
            // Update navigation
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes('Skills Ontology')) {
                    btn.classList.add('active');
                }
            });
            
            // Show network view
            document.getElementById('networkView').style.display = 'block';
            document.getElementById('cardView').style.display = 'none';
            document.getElementById('opportunitiesView').style.display = 'none';
            document.getElementById('blueprintView').style.display = 'none';
            document.getElementById('consentView').style.display = 'none';
            document.getElementById('settingsView').style.display = 'none';
            document.getElementById('networkControls').style.display = 'flex';
            document.querySelector('.controls').style.display = 'flex';
            
            // Update toggle button state
            document.querySelectorAll('#skillsViewToggle .view-pill').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.view === 'network');
            });
            
            // Reinitialize network with highlighting
            initNetworkWithHighlight(job);
            
            // Update stats bar
            updateStatsBar();
        }
        
        function initNetworkWithHighlight(job) {
            const svg = d3.select("#networkView");
            svg.selectAll("*").remove();
            
            const width = svg.node().getBoundingClientRect().width;
            const height = svg.node().getBoundingClientRect().height;
            
            // Prepare data
            const centerNode = { id: "center", name: userData.profile.name || "You", type: "center" };
            const roleNodes = skillsData.roles.map(role => ({
                id: role.id,
                name: role.name,
                type: "role",
                skills: role.skills
            }));
            
            const skillNodes = skillsData.skills.map(skill => ({
                id: skill.name,
                name: skill.name,
                type: "skill",
                level: skill.level,
                years: skill.years,
                roles: skill.roles,
                isMatch: job.matchedSkills.includes(skill.name)  // NEW: Track if matches job
            }));
            
            const nodes = [centerNode, ...roleNodes, ...skillNodes];
            
            // Create links
            const links = [];
            roleNodes.forEach(role => {
                links.push({ source: "center", target: role.id, type: "role" });
                role.skills.forEach(skillName => {
                    links.push({ source: role.id, target: skillName, type: "skill" });
                });
            });
            
            // Create simulation (same physics as before)
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.type === "role") return 140;
                    return 160;
                }))
                .force("charge", d3.forceManyBody().strength(d => {
                    if (d.type === "center") return 0;
                    if (d.type === "role") return -250;
                    return -180;
                }))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(d => {
                    if (d.type === "center") return 70;
                    if (d.type === "role") return 65;
                    return 45;
                }))
                .force("x", d3.forceX(width / 2).strength(0.08))
                .force("y", d3.forceY(height / 2).strength(0.08))
                .force("radial", d3.forceRadial(d => {
                    if (d.type === "skill") return Math.min(width, height) * 0.4;
                    return 0;
                }).strength(0.1));
            
            // Draw links with highlighting
            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link")
                .style("opacity", d => {
                    // Dim links that don't connect to matching skills
                    if (d.type === "skill") {
                        const targetNode = nodes.find(n => n.id === d.target);
                        return targetNode && targetNode.isMatch ? 0.6 : 0.1;
                    }
                    return 0.3;
                });
            
            // Draw nodes with highlighting
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", "node")
                .style("opacity", d => {
                    // Highlight matching skills, dim others
                    if (d.type === "skill") {
                        return d.isMatch ? 1 : 0.2;
                    }
                    return 1;  // Keep center and roles fully visible
                })
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
            
            // Add circles
            node.append("circle")
                .attr("r", d => {
                    if (d.type === "center") return 60;
                    if (d.type === "role") return 50;
                    return d.isMatch ? 25 : 15;  // Matching skills are larger
                })
                .attr("class", d => {
                    if (d.type === "center") return "node-center";
                    if (d.type === "role") return `node-role role-${d.id}`;
                    return `node-skill level-${d.level.toLowerCase().replace(/\s/g, '-')}`;
                })
                .style("stroke", d => {
                    // Green border for matching skills
                    return d.isMatch ? "#10b981" : null;
                })
                .style("stroke-width", d => d.isMatch ? 3 : null);
            
            // Add labels (only show matching skills and roles)
            node.filter(d => d.type === "center" || d.type === "role" || d.isMatch)
                .append("text")
                .text(d => d.name)
                .attr("class", "node-label")
                .style("font-weight", d => d.isMatch ? "bold" : "normal")
                .style("fill", d => d.isMatch ? "#10b981" : "#e0e0e0");
            
            // Update positions on tick
            simulation.on("tick", () => {
                const padding = 100;
                nodes.forEach(d => {
                    if (d.type !== "center") {
                        d.x = Math.max(padding, Math.min(width - padding, d.x));
                        d.y = Math.max(padding, Math.min(height - padding, d.y));
                    }
                });
                
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });
            
            // Add "Return to Opportunities" button overlay
            const buttonContainer = svg.append("foreignObject")
                .attr("x", 20)
                .attr("y", 20)
                .attr("width", 200)
                .attr("height", 50);
            
            buttonContainer.append("xhtml:div")
                .html(`
                    <button onclick="returnToOpportunities()" style="
                        padding: 10px 20px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                    ">
                        ← Back to Jobs
                    </button>
                `);
        }
        
        function returnToOpportunities() {
            window.currentHighlightJob = null;
            switchView('opportunities');
        }
        
        // ===== SETTINGS SYSTEM =====
        
        function initSettings() {
            const view = document.getElementById('settingsView');
            
            // Initialize current tab if not set
            if (!window.currentSettingsTab) {
                window.currentSettingsTab = 'profile';
            }
            
            view.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-header">
                        <h1 class="blueprint-title">Settings</h1>
                        <p class="blueprint-subtitle">Configure Your Profile and Preferences</p>
                    </div>
                    
                    <div class="settings-tabs">
                        <button class="settings-tab ${window.currentSettingsTab === 'profile' ? 'active' : ''}" 
                                onclick="switchSettingsTab('profile')">
                            👤 Profile
                        </button>
                        <button class="settings-tab ${window.currentSettingsTab === 'preferences' ? 'active' : ''}" 
                                onclick="switchSettingsTab('preferences')">
                            🎯 Preferences
                        </button>
                        <button class="settings-tab ${window.currentSettingsTab === 'data' ? 'active' : ''}" 
                                onclick="switchSettingsTab('data')">
                            💾 Data & Export
                        </button>
                    </div>
                    
                    <div id="settingsTabContent">
                        ${renderSettingsTabContent()}
                    </div>
                </div>
            `;
        }
        
        function switchSettingsTab(tab) {
            window.currentSettingsTab = tab;
            document.getElementById('settingsTabContent').innerHTML = renderSettingsTabContent();
            
            // Update tab styling
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function renderSettingsTabContent() {
            switch(window.currentSettingsTab) {
                case 'profile':
                    return renderProfileSettings();
                case 'preferences':
                    return renderJobPreferences();
                case 'data':
                    return renderDataExport();
                default:
                    return renderProfileSettings();
            }
        }
        
        function renderProfileSettings() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">👤</span>
                            <span>Profile Information</span>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Your Name</label>
                        <input type="text" class="settings-input" id="settingName" 
                               value="${userData.profile.name}" 
                               placeholder="Enter your name">
                        <div class="settings-help">This appears in the header and exports</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Email (Optional)</label>
                        <input type="email" class="settings-input" id="settingEmail" 
                               value="${userData.profile.email}" 
                               placeholder="your.email@example.com">
                        <div class="settings-help">For export contact information</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Location (for market valuation)</label>
                        <select class="settings-select" id="settingLocation">
                            <option value="Philadelphia, PA" ${userData.profile.location === 'Philadelphia, PA' ? 'selected' : ''}>Philadelphia, PA</option>
                            <option value="San Francisco Bay Area, CA">San Francisco Bay Area, CA</option>
                            <option value="New York City, NY">New York City, NY</option>
                            <option value="Seattle, WA">Seattle, WA</option>
                            <option value="Boston, MA">Boston, MA</option>
                            <option value="Washington DC">Washington DC</option>
                            <option value="Los Angeles, CA">Los Angeles, CA</option>
                            <option value="San Diego, CA">San Diego, CA</option>
                            <option value="Denver, CO">Denver, CO</option>
                            <option value="Austin, TX">Austin, TX</option>
                            <option value="Chicago, IL">Chicago, IL</option>
                            <option value="Atlanta, GA">Atlanta, GA</option>
                            <option value="Remote">Remote</option>
                            <option value="Phoenix, AZ">Phoenix, AZ</option>
                            <option value="Dallas, TX">Dallas, TX</option>
                            <option value="Houston, TX">Houston, TX</option>
                            <option value="Miami, FL">Miami, FL</option>
                            <option value="Portland, OR">Portland, OR</option>
                            <option value="Charlotte, NC">Charlotte, NC</option>
                            <option value="Nashville, TN">Nashville, TN</option>
                            <option value="Indianapolis, IN">Indianapolis, IN</option>
                            <option value="Columbus, OH">Columbus, OH</option>
                            <option value="Kansas City, MO">Kansas City, MO</option>
                            <option value="Omaha, NE">Omaha, NE</option>
                            <option value="Lincoln, NE">Lincoln, NE</option>
                            <option value="Other US Metro">Other US Metro</option>
                            <option value="Rural US">Rural US</option>
                        </select>
                        <div class="settings-help">Your location affects skill market valuations (cost of living adjustment)</div>
                    </div>
                </div>
            `;
        }
        
        function renderJobPreferences() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">🎯</span>
                            <span>Job Matching Preferences</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            💡 HOW JOB MATCHING WORKS
                        </div>
                        <div class="coaching-tip-content">
                            These settings control which jobs appear in your Opportunities feed. 
                            Set your seniority level to filter out irrelevant positions.
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Seniority Level</label>
                        <select class="settings-select" id="settingSeniority">
                            <option value="Entry" ${userData.preferences.seniorityLevel === 'Entry' ? 'selected' : ''}>Entry Level</option>
                            <option value="Mid" ${userData.preferences.seniorityLevel === 'Mid' ? 'selected' : ''}>Mid Level</option>
                            <option value="Senior" ${userData.preferences.seniorityLevel === 'Senior' ? 'selected' : ''}>Senior Level</option>
                            <option value="Executive" ${userData.preferences.seniorityLevel === 'Executive' ? 'selected' : ''}>Executive Level</option>
                        </select>
                        <div class="settings-help">
                            <strong>Entry:</strong> Includes junior, associate roles<br>
                            <strong>Mid:</strong> Includes senior, lead, manager roles<br>
                            <strong>Senior:</strong> Includes senior manager, director roles<br>
                            <strong>Executive:</strong> VP, Chief, Head of roles only
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Minimum Match Score</label>
                        <input type="range" min="0" max="100" value="${userData.preferences.minimumMatchScore}" 
                               class="match-slider" style="width: 100%;"
                               oninput="document.getElementById('matchScoreValue').textContent = this.value + '%'">
                        <div style="text-align: center; color: #fbbf24; font-weight: 600; font-size: 1.2em; margin-top: 10px;">
                            <span id="matchScoreValue">${userData.preferences.minimumMatchScore}%</span>
                        </div>
                        <div class="settings-help">Only show jobs with at least this match percentage</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Minimum Skill Matches</label>
                        <input type="number" min="1" max="10" class="settings-input" id="settingMinSkills"
                               value="${userData.preferences.minimumSkillMatches}">
                        <div class="settings-help">Jobs must match at least this many of your skills</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Minimum Salary (Optional)</label>
                        <input type="number" class="settings-input" id="settingMinSalary" 
                               value="${userData.preferences.minSalary || ''}"
                               placeholder="e.g., 150000">
                        <div class="settings-help">Leave blank for no minimum. Enter annual salary (USD).</div>
                    </div>
                    
                    <button class="save-settings-btn" onclick="saveSettings()">
                        💾 Save Settings
                    </button>
                </div>
            `;
        }
        
        function renderDataExport() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">💾</span>
                            <span>Backup & Restore</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            💡 DATA PORTABILITY
                        </div>
                        <div class="coaching-tip-content">
                            Export your complete Blueprint as JSON to back up all your data. 
                            Import from a previous export to restore or transfer to another device.
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 20px;">
                            <h3 style="color: #60a5fa; margin-bottom: 10px;">📤 Export Profile</h3>
                            <p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">
                                Download complete backup including skills, outcomes, values, and all settings
                            </p>
                            <button class="export-btn-large" onclick="exportFullProfile()" style="width: 100%;">
                                Download Backup
                            </button>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 20px;">
                            <h3 style="color: #10b981; margin-bottom: 10px;">📥 Import Profile</h3>
                            <p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">
                                Restore from a previous backup or transfer from another device
                            </p>
                            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importFullProfile(this)">
                            <button class="export-btn-large" onclick="document.getElementById('importFileInput').click()" 
                                    style="width: 100%; background: #10b981;">
                                Select Backup File
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px;">
                        <strong style="color: #ef4444;">⚠️ Warning:</strong>
                        <span style="color: #d1d5db; font-size: 0.9em;">
                            Importing will replace all current data. Make sure to export first if you want to keep your current profile!
                        </span>
                    </div>
                </div>
            `;
        }
        
        function renderSkillManagement() {
            const skillCount = userData.skills?.length || 0;
            const onetSkillsCount = userData.skills?.filter(s => s.category === 'skill').length || 0;
            const abilitiesCount = userData.skills?.filter(s => s.category === 'ability').length || 0;
            const workStylesCount = userData.skills?.filter(s => s.category === 'workstyle').length || 0;
            const uniqueCount = userData.skills?.filter(s => s.category === 'unique').length || 0;
            
            return `
                <div class="blueprint-section" style="margin-top: 30px;">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">🛠️</span>
                            <span>Manage Skills (${skillCount})</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            💡 BUILD YOUR SKILLS PROFILE
                        </div>
                        <div class="coaching-tip-content">
                            Add skills from the official O*NET library (validated by U.S. Department of Labor) or create custom skills unique to your experience. Your skills appear in the network graph and drive job matching.
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="export-btn-large" onclick="openSkillManagement()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                            📊 Manage Skills
                        </button>
                        <button class="export-btn-large" onclick="openCustomSkillBuilder()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
                            ⭐ Create Custom
                        </button>
                    </div>
                    
                    <div class="skill-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #60a5fa;">${onetSkillsCount}</div>
                            <div style="font-size: 0.8em; color: #9ca3af;">Skills</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #a78bfa;">${abilitiesCount}</div>
                            <div style="font-size: 0.8em; color: #9ca3af;">Abilities</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #10b981;">${workStylesCount}</div>
                            <div style="font-size: 0.8em; color: #9ca3af;">Work Styles</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #fbbf24;">${uniqueCount}</div>
                            <div style="font-size: 0.8em; color: #9ca3af;">Unique</div>
                        </div>
                    </div>
                    
                    <div class="skill-filter-controls" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="skillCategoryFilter" onchange="filterSkillsList()" class="settings-select" style="max-width: 200px;">
                            <option value="all">All Categories</option>
                            <option value="skill">O*NET Skills (${onetSkillsCount})</option>
                            <option value="ability">O*NET Abilities (${abilitiesCount})</option>
                            <option value="workstyle">Work Styles (${workStylesCount})</option>
                            <option value="unique">Unique (${uniqueCount})</option>
                        </select>
                        <input type="text" id="skillSearchInput" placeholder="Search skills..." class="settings-input" 
                               style="max-width: 300px;" oninput="filterSkillsList()">
                    </div>
                    
                    <div id="skillsList" style="max-height: 600px; overflow-y: auto;">
                        ${renderSkillsList()}
                    </div>
                </div>
            `;
        }
        
        function renderSkillsList() {
            const categoryFilter = document.getElementById('skillCategoryFilter')?.value || 'all';
            const searchQuery = document.getElementById('skillSearchInput')?.value.toLowerCase() || '';
            
            let skills = userData.skills || [];
            
            // Apply filters
            if (categoryFilter !== 'all') {
                skills = skills.filter(s => s.category === categoryFilter);
            }
            if (searchQuery) {
                skills = skills.filter(s => s.name.toLowerCase().includes(searchQuery));
            }
            
            if (skills.length === 0) {
                return `<div style="text-align: center; padding: 40px; color: #9ca3af;">
                    No skills found. ${searchQuery ? 'Try a different search.' : 'Add some skills to get started!'}
                </div>`;
            }
            
            // Group by category
            const grouped = {
                skill: skills.filter(s => s.category === 'skill'),
                ability: skills.filter(s => s.category === 'ability'),
                workstyle: skills.filter(s => s.category === 'workstyle'),
                unique: skills.filter(s => s.category === 'unique')
            };
            
            const categoryLabels = {
                skill: { name: 'O*NET Skills', color: '#60a5fa', badge: 'SKILL' },
                ability: { name: 'O*NET Abilities', color: '#a78bfa', badge: 'ABILITY' },
                workstyle: { name: 'O*NET Work Styles', color: '#10b981', badge: 'WORK STYLE' },
                unique: { name: 'Unique Skills', color: '#fbbf24', badge: 'UNIQUE' }
            };
            
            let html = '';
            
            Object.entries(grouped).forEach(([category, categorySkills]) => {
                if (categorySkills.length === 0) return;
                
                const label = categoryLabels[category];
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: ${label.color}; font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>${label.name}</span>
                            <span style="font-size: 0.8em; opacity: 0.7;">(${categorySkills.length})</span>
                        </h3>
                        <div style="display: grid; gap: 10px;">
                `;
                
                categorySkills.forEach(skill => {
                    const roleNames = skill.roles.map(roleId => {
                        const role = userData.roles.find(r => r.id === roleId);
                        return role ? role.name : roleId;
                    }).join(', ');
                    
                    const levelColors = {
                        'Mastery':    '#ef4444',
                        'Expert':     '#f97316',
                        'Advanced':   '#f59e0b',
                        'Proficient': '#10b981',
                        'Novice':     '#6b7280'
                    };
                    
                    html += `
                        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                        <span style="font-weight: 600; font-size: 1.05em;">${skill.name}</span>
                                        <span style="background: rgba(${category === 'skill' ? '59, 130, 246' : category === 'ability' ? '139, 92, 246' : category === 'workstyle' ? '16, 185, 129' : '251, 191, 36'}, 0.2); 
                                                     color: ${label.color}; 
                                                     font-size: 0.7em; 
                                                     padding: 2px 6px; 
                                                     border-radius: 3px;">
                                            ${label.badge}
                                        </span>
                                        ${skill.key ? '<span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; font-size: 0.7em; padding: 2px 6px; border-radius: 3px;">CORE</span>' : ''}
                                    </div>
                                    <div style="color: #9ca3af; font-size: 0.9em;">
                                        <span style="color: ${levelColors[skill.level]}; font-weight: 600;">${skill.level}</span>
                                        ${roleNames ? ` • ${roleNames}` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                    <button onclick="openEditSkillModal('${skill.name.replace(/'/g, "\\'")}', '${category}')" 
                                            style="padding: 6px 12px; background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
                                        ✏️ Edit
                                    </button>
                                    <button onclick="confirmDeleteSkill('${skill.name.replace(/'/g, "\\'")}', '${category}')" 
                                            style="padding: 6px 12px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 4px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
                                        🗑️
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function filterSkillsList() {
            const container = document.getElementById('skillsList');
            if (container) {
                container.innerHTML = renderSkillsList();
            }
        }
        
        // saveUserData and loadUserData: single source of truth is the profile JSON.
        // localStorage only stores which profile is currently active (handled in first saveUserData definition).
        // This comment replaces duplicate/conflicting definitions that were removed in v3.5.2.
        
        function exportFullProfile() {
            const fullData = {
                userData: userData,
                blueprintData: blueprintData,
                skillsData: {
                    skills: skillsData.skills,
                    roles: skillsData.roles,
                    skillDetails: skillsData.skillDetails
                },
                version: '1.0',
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(fullData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `blueprint-full-${userData.profile.name || 'profile'}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function importFullProfile(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace your current Blueprint data. Continue?')) {
                        // Restore all data
                        if (imported.userData) Object.assign(userData, imported.userData);
                        if (imported.blueprintData) Object.assign(blueprintData, imported.blueprintData);
                        if (imported.skillsData) {
                            if (imported.skillsData.skills) skillsData.skills = imported.skillsData.skills;
                            if (imported.skillsData.roles) skillsData.roles = imported.skillsData.roles;
                            if (imported.skillsData.skillDetails) skillsData.skillDetails = imported.skillsData.skillDetails;
                        }
                        
                        // Save to localStorage
                        saveUserData();
                        
                        showToast('Profile imported. Refreshing page...', 'success');
                        location.reload();
                    }
                } catch (err) {
                    showToast('Import error: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // ===== APPLICATIONS TRACKER SYSTEM =====
        
        function initApplications() {
            const view = document.getElementById('applicationsView');
            
            view.innerHTML = `
                <div class="applications-header">
                    <h2 style="font-size: 2em; color: #60a5fa; margin-bottom: 10px;">Application Tracker</h2>
                    <p style="color: #9ca3af; margin-bottom: 20px;">Track your job applications and follow-ups</p>
                    <button class="export-btn-large" onclick="addApplicationModal()" style="display: inline-flex; align-items: center; gap: 8px;">
                        ➕ Add Application
                    </button>
                </div>
                
                <div id="applicationsContainer"></div>
            `;
            
            renderApplications();
        }
        
        function renderApplications() {
            const container = document.getElementById('applicationsContainer');
            
            if (!userData.applications || userData.applications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📋</div>
                        <h3 style="color: #d1d5db; margin-bottom: 10px;">No applications tracked yet</h3>
                        <p>Click "Add Application" above to start tracking your job search</p>
                        <div style="margin-top: 30px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                            <strong style="color: #60a5fa;">Track from Opportunities:</strong>
                            <p style="font-size: 0.9em; margin-top: 8px;">When you generate a pitch for a job, you'll have the option to automatically add it to your application tracker.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Group by status
            const grouped = {
                applied: userData.applications.filter(a => a.status === 'applied'),
                interviewing: userData.applications.filter(a => a.status === 'interviewing'),
                offer: userData.applications.filter(a => a.status === 'offer'),
                rejected: userData.applications.filter(a => a.status === 'rejected')
            };
            
            container.innerHTML = `
                <div style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="application-status status-applied">${grouped.applied.length} Applied</div>
                    <div class="application-status status-interviewing">${grouped.interviewing.length} Interviewing</div>
                    <div class="application-status status-offer">${grouped.offer.length} Offers</div>
                    <div class="application-status status-rejected">${grouped.rejected.length} Closed</div>
                </div>
                
                <div class="applications-grid">
                    ${userData.applications.map((app, idx) => renderApplicationCard(app, idx)).join('')}
                </div>
            `;
        }
        
        function renderApplicationCard(app, idx) {
            const statusLabels = {
                applied: 'Applied',
                interviewing: 'Interviewing',
                offer: 'Offer Received',
                rejected: 'Closed'
            };
            
            return `
                <div class="application-card">
                    <div class="application-status status-${app.status}">
                        ${statusLabels[app.status]}
                    </div>
                    
                    <div class="application-title">${app.title}</div>
                    <div class="application-company">${app.company}</div>
                    
                    <div class="application-meta-grid">
                        <div class="application-meta-item">
                            <div class="application-meta-label">Applied</div>
                            <div class="application-meta-value">${new Date(app.appliedDate).toLocaleDateString()}</div>
                        </div>
                        <div class="application-meta-item">
                            <div class="application-meta-label">Match</div>
                            <div class="application-meta-value">${app.matchScore || 'N/A'}%</div>
                        </div>
                        ${app.salary ? `
                            <div class="application-meta-item">
                                <div class="application-meta-label">Salary</div>
                                <div class="application-meta-value">${app.salary}</div>
                            </div>
                        ` : ''}
                        ${app.nextFollowUp ? `
                            <div class="application-meta-item">
                                <div class="application-meta-label">Follow Up</div>
                                <div class="application-meta-value">${new Date(app.nextFollowUp).toLocaleDateString()}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${app.notes ? `
                        <div class="application-notes">
                            📝 ${app.notes}
                        </div>
                    ` : ''}
                    
                    <div class="application-actions">
                        <button class="application-btn" onclick="updateApplicationStatus(${idx})">
                            🔄 Update Status
                        </button>
                        <button class="application-btn" onclick="editApplication(${idx})">
                            ✏️ Edit
                        </button>
                        ${app.url ? `
                            <button class="application-btn" onclick="window.open('${app.url}', '_blank')">
                                🔗 View Job
                            </button>
                        ` : ''}
                        <button class="application-btn delete" onclick="deleteApplication(${idx})">
                            🗑️ Remove
                        </button>
                    </div>
                </div>
            `;
        }
        
        function addApplicationModal(jobData = null) {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Add Application</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Track a job you've applied to</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Job Title *</label>
                            <input type="text" id="appTitle" value="${jobData?.title || ''}" class="settings-input" required>
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Company *</label>
                            <input type="text" id="appCompany" value="${jobData?.company || ''}" class="settings-input" required>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Applied Date *</label>
                                <input type="date" id="appDate" value="${new Date().toISOString().split('T')[0]}" class="settings-input" required>
                            </div>
                            <div>
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Status</label>
                                <select id="appStatus" class="settings-select">
                                    <option value="applied">Applied</option>
                                    <option value="interviewing">Interviewing</option>
                                    <option value="offer">Offer Received</option>
                                    <option value="rejected">Closed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Salary Range</label>
                                <input type="text" id="appSalary" value="${jobData?.salary || ''}" placeholder="e.g., $150k-$200k" class="settings-input">
                            </div>
                            <div>
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Match Score</label>
                                <input type="number" id="appMatch" value="${jobData?.matchScore || ''}" min="0" max="100" class="settings-input">
                            </div>
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Job URL</label>
                            <input type="url" id="appUrl" value="${jobData?.url || ''}" placeholder="https://" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Follow-Up Date</label>
                            <input type="date" id="appFollowUp" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Notes</label>
                            <textarea id="appNotes" class="purpose-editor" style="min-height: 80px;" placeholder="Contact names, interview details, etc."></textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                        <button class="action-btn" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Cancel
                        </button>
                        <button class="export-btn-large" onclick="saveApplication()" style="padding: 10px 20px;">
                            ➕ Add Application
                        </button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function saveApplication() {
            const title = document.getElementById('appTitle').value.trim();
            const company = document.getElementById('appCompany').value.trim();
            
            if (!title || !company) {
                showToast('Please enter job title and company.', 'warning');
                return;
            }
            
            const newApp = {
                id: Date.now(),
                title: title,
                company: company,
                appliedDate: document.getElementById('appDate').value,
                status: document.getElementById('appStatus').value,
                salary: document.getElementById('appSalary').value.trim(),
                matchScore: document.getElementById('appMatch').value ? parseInt(document.getElementById('appMatch').value) : null,
                url: document.getElementById('appUrl').value.trim(),
                nextFollowUp: document.getElementById('appFollowUp').value || null,
                notes: document.getElementById('appNotes').value.trim()
            };
            
            if (!userData.applications) userData.applications = [];
            userData.applications.unshift(newApp);
            
            saveUserData();
            closeExportModal();
            renderApplications();
            
            showToast('Application added.', 'success');
        }
        
        function updateApplicationStatus(idx) {
            const app = userData.applications[idx];
            const newStatus = prompt(`Update status for "${app.title}":\n\n1 = Applied\n2 = Interviewing\n3 = Offer\n4 = Closed\n\nEnter number:`, 
                                     app.status === 'applied' ? '1' : app.status === 'interviewing' ? '2' : app.status === 'offer' ? '3' : '4');
            
            if (newStatus) {
                const statusMap = {'1': 'applied', '2': 'interviewing', '3': 'offer', '4': 'rejected'};
                userData.applications[idx].status = statusMap[newStatus] || app.status;
                saveUserData();
                renderApplications();
            }
        }
        
        function editApplication(idx) {
            const app = userData.applications[idx];
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Edit Application</h2>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Job Title</label>
                            <input type="text" id="editAppTitle" value="${app.title}" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Company</label>
                            <input type="text" id="editAppCompany" value="${app.company}" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Status</label>
                            <select id="editAppStatus" class="settings-select">
                                <option value="applied" ${app.status === 'applied' ? 'selected' : ''}>Applied</option>
                                <option value="interviewing" ${app.status === 'interviewing' ? 'selected' : ''}>Interviewing</option>
                                <option value="offer" ${app.status === 'offer' ? 'selected' : ''}>Offer Received</option>
                                <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Closed</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Follow-Up Date</label>
                            <input type="date" id="editAppFollowUp" value="${app.nextFollowUp || ''}" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Notes</label>
                            <textarea id="editAppNotes" class="purpose-editor" style="min-height: 80px;">${app.notes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                        <button class="action-btn" onclick="closeExportModal()">Cancel</button>
                        <button class="export-btn-large" onclick="saveApplicationEdit(${idx})">💾 Save Changes</button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function saveApplicationEdit(idx) {
            userData.applications[idx].title = document.getElementById('editAppTitle').value;
            userData.applications[idx].company = document.getElementById('editAppCompany').value;
            userData.applications[idx].status = document.getElementById('editAppStatus').value;
            userData.applications[idx].nextFollowUp = document.getElementById('editAppFollowUp').value || null;
            userData.applications[idx].notes = document.getElementById('editAppNotes').value.trim();
            
            saveUserData();
            closeExportModal();
            renderApplications();
        }
        
        function deleteApplication(idx) {
            const app = userData.applications[idx];
            if (confirm(`Remove "${app.title}" at ${app.company} from tracker?`)) {
                userData.applications.splice(idx, 1);
                saveUserData();
                renderApplications();
            }
        }
        
        // ===== CONSENT & SHARING SYSTEM =====
        
        let sharePresets = {
            'full': { name: 'Full Transparency', skills: 'all', outcomes: 'all', values: 'all', purpose: true },
            'executive': { name: 'Executive Brief', skills: 'top20', outcomes: 'all', values: 'all', purpose: true },
            'advisory': { name: 'Advisory Pitch', skills: 'strategic', outcomes: 'strategic', values: 'all', purpose: true },
            'board': { name: 'Board Candidate', skills: 'leadership', outcomes: 'business', values: 'selected', purpose: true },
            'custom': { name: 'Custom', skills: 'selected', outcomes: 'selected', values: 'selected', purpose: true }
        };
        
        let currentPreset = 'custom';
        
        function initConsent() {
            const view = document.getElementById('consentView');
            
            view.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-header">
                        <h1 class="blueprint-title">Consent & Sharing</h1>
                        <p class="blueprint-subtitle">Your Data, Your Control</p>
                        <p class="blueprint-tagline">Choose exactly what you share and with whom</p>
                    </div>
                    
                    ${renderSharePresets()}
                    ${renderSharingStatus()}
                    ${renderLegalSection()}
                </div>
            `;
        }
        
        function renderSharePresets() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">🎚️</span>
                            <span>Share Profile Presets</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            💡 CHOOSE YOUR SHARING LEVEL
                        </div>
                        <div class="coaching-tip-content">
                            Select a preset that matches your audience, or use Custom to choose exactly what to share.
                            All presets respect your individual item toggles from the Blueprint.
                        </div>
                    </div>
                    
                    <div class="values-grid">
                        ${Object.entries(sharePresets).map(([key, preset]) => renderPresetCard(key, preset)).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderPresetCard(key, preset) {
            const selectedClass = currentPreset === key ? 'selected' : '';
            var skillCount = (skillsData.skills || []).length;
            var keyCount = skillsData.skills.filter(function(s) { return s.key; }).length;
            const descriptions = {
                'full': 'Share everything: all ' + skillCount + ' skills, outcomes, values, and purpose',
                'executive': 'Top ' + Math.min(20, skillCount) + ' skills + all outcomes and values, ideal for executive search',
                'advisory': keyCount + ' strategic skills + relevant outcomes, for advisory and consulting',
                'board': 'Leadership and business outcomes + governance experience, for board positions',
                'custom': 'You choose exactly which skills, outcomes, and values to share'
            };
            
            return `
                <div class="value-card ${selectedClass}" onclick="selectPreset('${key}')">
                    <div class="value-title">${preset.name}</div>
                    <div class="value-description">${descriptions[key]}</div>
                </div>
            `;
        }
        
        function renderSharingStatus() {
            var skillCount = (skillsData.skills || []).length;
            var sharedSkills = currentPreset === 'full' ? skillCount : 
                                currentPreset === 'executive' ? Math.min(20, skillCount) :
                                currentPreset === 'advisory' ? skillsData.skills.filter(function(s) { return s.key; }).length :
                                currentPreset === 'board' ? skillsData.skills.filter(function(s) { return s.key || s.level === 'Mastery'; }).length :
                                skillCount;
            var sharedOutcomes = blueprintData.outcomes.filter(o => o.shared).length;
            var sharedValues = blueprintData.values.filter(v => v.selected).length;
            
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">📊</span>
                            <span>What You're Sharing</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #60a5fa; font-weight: bold;">${sharedSkills}</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Skills</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #10b981; font-weight: bold;">${sharedOutcomes}</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Outcomes</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #fbbf24; font-weight: bold;">${sharedValues}</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Values</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #a78bfa; font-weight: bold;">✓</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Purpose</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
                        <strong style="color: #fbbf24;">Note:</strong> 
                        <span style="color: #d1d5db;">Sensitive content (recovery, personal loss) is flagged in Blueprint. Review before sharing.</span>
                    </div>
                </div>
            `;
        }
        
        function renderLegalSection() {
            var tc = tv('#d1d5db','#334155');
            var hc = tv('#60a5fa','#1e40af');
            var sc = tv('#9ca3af','#64748b');
            var bgCard = tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)');
            var borderWarn = tv('rgba(251,191,36,0.3)','rgba(217,119,6,0.2)');
            
            return '<div id="disclaimerSection" class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">\u26A0\uFE0F</span>'
                + '<span>Disclaimer & Terms of Use</span>'
                + '</div>'
                + '</div>'
                
                // Prominent disclaimer banner
                + '<div style="padding:20px; background:' + tv('rgba(251,191,36,0.08)','rgba(251,191,36,0.06)') + '; '
                + 'border:1px solid ' + borderWarn + '; border-radius:10px; margin-bottom:24px;">'
                + '<p style="color:' + tc + '; line-height:1.7; margin:0; font-size:0.95em;">'
                + '<strong style="color:' + tv('#fbbf24','#d97706') + ';">Blueprint is a personal demonstration project provided as-is for educational and illustrative purposes only.</strong> '
                + 'It is not a commercial product and carries no warranty of any kind, express or implied.'
                + '</p>'
                + '</div>'
                
                + '<div style="color:' + tc + '; line-height:1.7; font-size:0.93em;">'

                // Data accuracy
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Data Accuracy</h4>'
                + '<p style="margin:0;">Skill taxonomies, market valuations, compensation estimates, and any generated content may contain errors, omissions, or outdated information. '
                + 'ESCO, O*NET, and other referenced datasets are used under their respective licenses and may not reflect current labor market conditions. '
                + 'No figure produced by this tool should be treated as a verified market rate or guaranteed outcome.</p>'
                + '</div>'

                // Not professional advice
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Not Professional Advice</h4>'
                + '<p style="margin:0;">Nothing in this application constitutes legal, financial, career, compensation, or employment advice. '
                + 'Users should consult qualified professionals before making decisions based on any information presented here.</p>'
                + '</div>'

                // No liability
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">No Liability</h4>'
                + '<p style="margin:0;">The creator of this tool accepts no responsibility for decisions made, opportunities pursued or declined, '
                + 'salary negotiations conducted, or any other action taken based on information generated by this application.</p>'
                + '</div>'

                // Local data only
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Local Data Only</h4>'
                + '<p style="margin:0;">All user data is stored in your browser\u2019s local storage. No data is transmitted to or stored on any server. '
                + 'Clearing your browser data will permanently delete your profile. The creator has no access to your data.</p>'
                + '</div>'

                // Third-party AI
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Third-Party AI</h4>'
                + '<p style="margin:0;">The onboarding wizard uses the Anthropic API to parse resumes and infer skills. '
                + 'Resume text submitted during onboarding is sent to Anthropic\u2019s servers and is subject to '
                + '<a href="https://www.anthropic.com/policies" target="_blank" rel="noopener" style="color:' + hc + '; text-decoration:underline;">Anthropic\u2019s usage policies</a>. '
                + 'No resume data is stored by this application after processing.</p>'
                + '</div>'

                // Demo profiles
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Demonstration Profiles</h4>'
                + '<p style="margin:0;">Pre-loaded demo profiles represent real professional histories and are included with the profile owner\u2019s consent. '
                + 'Do not redistribute demo profile data.</p>'
                + '</div>'

                // Use at your own risk
                + '<div style="padding:16px; background:' + tv('rgba(239,68,68,0.06)','rgba(239,68,68,0.04)') + '; '
                + 'border:1px solid ' + tv('rgba(239,68,68,0.2)','rgba(239,68,68,0.15)') + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + tv('#f87171','#dc2626') + '; margin:0 0 8px 0;">Use at Your Own Risk</h4>'
                + '<p style="margin:0;">By using this tool, you acknowledge these limitations and accept full responsibility for how you apply its outputs.</p>'
                + '</div>'

                + '</div>'
                + '</div>'

                // Existing privacy section below disclaimer
                + '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">\u2696\uFE0F</span>'
                + '<span>Privacy & Data Rights</span>'
                + '</div>'
                + '</div>'
                + '<div style="color:' + tc + '; line-height:1.7;">'
                + '<p style="margin-bottom:20px;">When signed in, your Blueprint data is stored securely in Firebase (Google Cloud). When not signed in, data persists locally in your browser. You have complete control over what you share, '
                + 'when you share it, and with whom.</p>'

                + '<h4 style="color:' + hc + '; margin-bottom:10px;">Relevant Privacy Laws:</h4>'
                + '<div style="padding:10px; background:' + bgCard + '; margin-bottom:8px; border-radius:6px;">'
                + '<strong>\uD83C\uDDFA\uD83C\uDDF8 CCPA (California Consumer Privacy Act)</strong><br>'
                + '<span style="font-size:0.9em; color:' + sc + ';">Right to know what data is collected, right to delete, right to opt-out of sale</span><br>'
                + '<a href="https://oag.ca.gov/privacy/ccpa" target="_blank" style="color:' + hc + '; text-decoration:none; font-size:0.85em;">Learn more \u2192</a>'
                + '</div>'
                + '<div style="padding:10px; background:' + bgCard + '; margin-bottom:8px; border-radius:6px;">'
                + '<strong>\uD83C\uDDEA\uD83C\uDDFA GDPR (General Data Protection Regulation)</strong><br>'
                + '<span style="font-size:0.9em; color:' + sc + ';">Right to access, rectify, erase, and port your personal data</span><br>'
                + '<a href="https://gdpr.eu/" target="_blank" style="color:' + hc + '; text-decoration:none; font-size:0.85em;">Learn more \u2192</a>'
                + '</div>'
                + '<div style="padding:10px; background:' + bgCard + '; margin-bottom:8px; border-radius:6px;">'
                + '<strong>\uD83D\uDCCB Employment Data Rights (US)</strong><br>'
                + '<span style="font-size:0.9em; color:' + sc + ';">Employers must handle your data fairly and cannot discriminate based on protected characteristics</span><br>'
                + '<a href="https://www.eeoc.gov/" target="_blank" style="color:' + hc + '; text-decoration:none; font-size:0.85em;">EEOC Guidelines \u2192</a>'
                + '</div>'

                + '<h4 style="color:' + hc + '; margin:25px 0 10px 0;">Best Practices:</h4>'
                + '<div style="color:' + tc + '; line-height:2;">'
                + '\u2022 Never share sensitive personal information (SSN, financial details)<br>'
                + '\u2022 Review what you are sharing before exporting<br>'
                + '\u2022 Keep Blueprint data up to date but do not embellish<br>'
                + '\u2022 Consider context before sharing recovery or advocacy work'
                + '</div>'
                + '</div>'
                + '</div>'

                // GDPR Data Rights section
                + '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">\uD83D\uDD12</span>'
                + '<span>Your Data Rights</span>'
                + '</div>'
                + '</div>'
                + '<div style="color:' + tv('#d1d5db','#334155') + '; line-height:1.7; font-size:0.93em;">'
                + '<p style="margin-bottom:16px;">Under GDPR and similar privacy regulations, you have the right to access, export, and delete your personal data at any time. '
                + 'Use the controls below to exercise these rights.</p>'
                + '<div style="display:flex; gap:12px; flex-wrap:wrap;">'
                + '<button onclick="viewMyData()" style="'
                + 'background:' + tv('rgba(96,165,250,0.12)','rgba(30,64,175,0.08)') + '; '
                + 'border:1px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + '; '
                + 'color:' + tv('#60a5fa','#1e40af') + '; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;'
                + '">\uD83D\uDCC4 View My Stored Data</button>'
                + '<button onclick="exportMyData()" style="'
                + 'background:' + tv('rgba(16,185,129,0.12)','rgba(5,150,105,0.08)') + '; '
                + 'border:1px solid ' + tv('rgba(16,185,129,0.3)','rgba(5,150,105,0.2)') + '; '
                + 'color:' + tv('#10b981','#059669') + '; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;'
                + '">\uD83D\uDCE5 Export My Data (JSON)</button>'
                + '<button onclick="requestDataDeletion()" style="'
                + 'background:' + tv('rgba(239,68,68,0.08)','rgba(220,38,38,0.05)') + '; '
                + 'border:1px solid ' + tv('rgba(239,68,68,0.3)','rgba(220,38,38,0.2)') + '; '
                + 'color:' + tv('#ef4444','#dc2626') + '; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;'
                + '">\uD83D\uDDD1 Delete All My Data</button>'
                + '</div>'
                + '<div style="margin-top:12px; font-size:0.82em; color:' + tv('#6b7280','#9ca3af') + ';">'
                + 'You must be signed in to use these features. Data deletion is permanent and cannot be undone.'
                + '</div>'
                + '</div></div>';
        }
        
        function saveSettings() {
            // Get values from form
            userData.profile.name = document.getElementById('settingName').value;
            userData.profile.email = document.getElementById('settingEmail').value;
            userData.profile.location = document.getElementById('settingLocation').value;
            
            const newSeniority = document.getElementById('settingSeniority').value;
            userData.preferences.seniorityLevel = newSeniority;
            userData.preferences.minimumMatchScore = parseInt(document.querySelector('#settingsView .match-slider').value);
            userData.preferences.minimumSkillMatches = parseInt(document.getElementById('settingMinSkills').value);
            const minSalaryInput = document.getElementById('settingMinSalary').value;
            userData.preferences.minSalary = minSalaryInput ? parseInt(minSalaryInput) : null;
            
            // Update seniority keywords based on level
            if (newSeniority === 'Entry') {
                userData.preferences.seniorityKeywords = ['junior', 'associate', 'entry', 'coordinator'];
                userData.preferences.excludeRoles = ['senior', 'lead', 'manager', 'director', 'vp', 'chief', 'principal'];
            } else if (newSeniority === 'Mid') {
                userData.preferences.seniorityKeywords = ['senior', 'lead', 'manager', 'specialist'];
                userData.preferences.excludeRoles = ['junior', 'entry', 'associate', 'intern'];
            } else if (newSeniority === 'Senior') {
                userData.preferences.seniorityKeywords = ['senior manager', 'director', 'senior director', 'principal'];
                userData.preferences.excludeRoles = ['junior', 'entry', 'mid-level', 'associate'];
            } else { // Executive
                userData.preferences.seniorityKeywords = ['vp', 'vice president', 'chief', 'head of', 'director', 'principal', 'senior director'];
                userData.preferences.excludeRoles = ['engineer', 'developer', 'designer', 'analyst', 'coordinator', 'specialist', 
                                                    'junior', 'mid-level', 'associate', 'intern', 'entry'];
            }
            
            // Update profile chip with new name
            if (userData.profile.name) {
                updateProfileChip(userData.profile.name);
            }
            
            // Save to localStorage
            saveUserData();
            
            showToast('Settings saved. Go to Opportunities and click Find Matching Jobs to see updated results.', 'success', 5000);
        }
        
        function selectPreset(key) {
            currentPreset = key;
            
            // Apply preset logic to outcomes and values sharing flags
            if (key === 'full') {
                blueprintData.outcomes.forEach(function(o) { o.shared = true; });
                blueprintData.values.forEach(function(v) { v.selected = true; });
            } else if (key === 'executive') {
                blueprintData.outcomes.forEach(function(o) { o.shared = true; });
                blueprintData.values.forEach(function(v) { v.selected = true; });
            } else if (key === 'advisory') {
                blueprintData.outcomes.forEach(function(o) {
                    o.shared = (o.category === 'Strategic Foresight' || o.category === 'Thought Leadership' || o.category === 'Business Impact');
                });
                blueprintData.values.forEach(function(v) { v.selected = true; });
            } else if (key === 'board') {
                blueprintData.outcomes.forEach(function(o) {
                    o.shared = (o.category === 'Business Impact' || o.category === 'Crisis Leadership' || o.category === 'Entrepreneurial');
                });
                blueprintData.values.forEach(function(v) { v.selected = true; });
            }
            // 'custom' leaves everything as-is
            
            saveUserData();
            initConsent(); // Re-render to show selection
        }
        
        function filterSkillsView(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            
            if (currentSkillsView === 'network') {
                // Filter network nodes
                const svg = d3.select("#networkView");
                const nodes = svg.selectAll(".node");
                
                nodes.style("opacity", function(d) {
                    if (d.type !== "skill") return 1;  // Keep center and roles visible
                    if (!term) return 1;  // No search, show all
                    return d.name.toLowerCase().includes(term) ? 1 : 0.1;
                });
                
                // Also filter text labels
                const labels = svg.selectAll(".node-label");
                labels.style("opacity", function(d) {
                    if (d.type !== "skill") return 1;
                    if (!term) return 1;
                    return d.name.toLowerCase().includes(term) ? 1 : 0.1;
                });
                
            } else {
                // Filter card view - skill items within domain cards
                var domainCards = document.querySelectorAll('.domain-card');
                domainCards.forEach(function(card) {
                    var items = card.querySelectorAll('.skill-item');
                    var anyVisible = false;
                    items.forEach(function(item) {
                        var nameEl = item.querySelector('.skill-name');
                        var name = nameEl ? nameEl.textContent.toLowerCase() : '';
                        if (!term || name.includes(term)) {
                            item.style.display = '';
                            anyVisible = true;
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    // Hide entire domain card if no skills match
                    card.style.display = anyVisible || !term ? '' : 'none';
                });
            }
        }
        
        function showValuationBreakdown() {
            const totalValue = calculateTotalMarketValue();
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Get all skills with their impact ratings
            const allSkillsWithImpact = skillsData.skills.map(skill => {
                const impact = getSkillImpact(skill);
                return {
                    name: skill.name,
                    level: skill.level,
                    category: skill.category,
                    impact: impact,
                    impactLevel: impact.level
                };
            });
            
            // Sort by impact level then alphabetically
            const impactOrder = { 'critical': 1, 'high': 2, 'moderate': 3, 'standard': 4, 'supplementary': 5 };
            allSkillsWithImpact.sort((a, b) => {
                const orderDiff = impactOrder[a.impactLevel] - impactOrder[b.impactLevel];
                if (orderDiff !== 0) return orderDiff;
                return a.name.localeCompare(b.name);
            });
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">All ${skillsData.skills.length} Skills</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Complete list with impact ratings</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                            <div>
                                <div style="color: #ef4444; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'critical').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">🔥 Critical</div>
                            </div>
                            <div>
                                <div style="color: #f59e0b; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'high').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">⭐ High</div>
                            </div>
                            <div>
                                <div style="color: #3b82f6; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'moderate').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">💎 Moderate</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'standard').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">✓ Standard</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">All Skills (Sorted by Impact)</h3>
                        <div style="display: grid; gap: 8px; max-height: 500px; overflow-y: auto; padding-right: 10px;">
                            ${allSkillsWithImpact.map((skill, idx) => {
                                const impactColor = getImpactColor(skill.impactLevel);
                                const categoryBadge = skill.category === 'skill' ? 'SKILL' : 
                                                     skill.category === 'ability' ? 'ABILITY' : 
                                                     skill.category === 'workstyle' ? 'WORK STYLE' : 'UNIQUE';
                                return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 6px; border-left: 3px solid ${impactColor};">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="color: #e0e0e0; font-weight: 500;">${skill.name}</span>
                                            <span style="color: #6b7280; font-size: 0.75em; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">${categoryBadge}</span>
                                        </div>
                                        <div style="color: #9ca3af; font-size: 0.85em;">
                                            ${skill.level} • ${skill.impact.label}
                                        </div>
                                    </div>
                                    <div style="color: ${impactColor}; font-weight: 600; font-size: 1.2em; min-width: 40px; text-align: right;">
                                        ${skill.impact.icon}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Your Market Value</h3>
                        <div style="color: #d1d5db; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>Base Market Rate (${totalValue.percentile} percentile):</span>
                                <strong>$${totalValue.marketRate.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>Critical Skills Premium (${totalValue.criticalSkills.length} skills):</span>
                                <strong style="color: #10b981;">+$${totalValue.criticalBonus.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>High Impact Skills (${totalValue.highSkills.length} skills):</span>
                                <strong style="color: #10b981;">+$${totalValue.highBonus.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>Rare Combinations:</span>
                                <strong style="color: #10b981;">+$${totalValue.rarityBonus.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 1.2em; margin-top: 10px;">
                                <strong>Total Market Value:</strong>
                                <strong style="color: #10b981;">$${totalValue.total.toLocaleString()}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <button class="export-btn-large" onclick="closeExportModal()" style="width: 100%; background: rgba(96, 165, 250, 0.2); border-color: #60a5fa; color: #60a5fa;">
                        Close
                    </button>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function showNegotiationGuide() {
            const totalValue = calculateTotalMarketValue();
            const negotiationGap = totalValue.yourWorth - totalValue.standardOffer;
            
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">💼 Salary Negotiation Strategy</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Compa-ratio based negotiation guidance</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <div style="color: #10b981; font-weight: 600; margin-bottom: 10px;">Your Market Worth</div>
                        <div style="font-size: 2em; font-weight: 700; color: #e0e0e0;">
                            $${totalValue.yourWorth.toLocaleString()}/year
                        </div>
                        <div style="color: #9ca3af; margin-top: 8px;">
                            ${totalValue.roleLevel} • ${totalValue.compaRatio}% compa-ratio • ${userData.profile.location}
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">📊 Understanding Compa-Ratios</h3>
                        <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.7;">
                            <strong>Compa-ratio</strong> = Your salary ÷ Market median × 100%
                            <br><br>
                            <strong>How Companies Use This:</strong>
                            <br>• <strong>80-120%</strong> = Acceptable range
                            <br>• <strong>100%</strong> = Exactly at market median
                            <br>• <strong>&lt;80%</strong> = Underpaid (flight risk)
                            <br>• <strong>&gt;120%</strong> = Overpaid for role
                            <br><br>
                            <strong>Market Rate (50th percentile):</strong> $${totalValue.marketRate.toLocaleString()}
                            <br><strong>Your Worth (with premiums):</strong> $${totalValue.yourWorth.toLocaleString()} (${totalValue.compaRatio}%)
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #fbbf24; margin-bottom: 15px;">💰 Expected Offer Ranges</h3>
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">
                            Companies typically offer <strong>75-95%</strong> of your market worth. Here's what to expect:
                        </div>
                        
                        <div style="background: rgba(107, 114, 128, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #9ca3af;">
                            <div style="color: #9ca3af; font-weight: 600; margin-bottom: 5px;">Conservative Offer (75%)</div>
                            <div style="font-size: 1.3em; color: #e0e0e0; font-weight: 600;">
                                $${totalValue.conservativeOffer.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                                Budget-constrained companies • Startups • Non-profits
                            </div>
                        </div>
                        
                        <div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #60a5fa;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Standard Offer (85%) ← Most Common</div>
                            <div style="font-size: 1.3em; color: #e0e0e0; font-weight: 600;">
                                $${totalValue.standardOffer.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                                Typical initial offers • Room to negotiate up
                            </div>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #10b981;">
                            <div style="color: #10b981; font-weight: 600; margin-bottom: 5px;">Competitive Offer (95%)</div>
                            <div style="font-size: 1.3em; color: #e0e0e0; font-weight: 600;">
                                $${totalValue.competitiveOffer.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                                High-demand roles • Top-tier companies • Multiple offers
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: rgba(251, 191, 36, 0.2); border-radius: 8px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 5px;">💡 Your Negotiation Gap</div>
                            <div style="color: #d1d5db; font-size: 0.95em;">
                                <strong>$${negotiationGap.toLocaleString()}</strong> between standard offer and your worth
                                <br>This is your leverage. Start at your worth ($${totalValue.yourWorth.toLocaleString()}) and negotiate down to competitive range ($${totalValue.competitiveOffer.toLocaleString()}+).
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(251, 191, 36, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid #fbbf24; margin-bottom: 25px;">
                        <h3 style="color: #fbbf24; margin-bottom: 15px;">🎯 Your Talking Points</h3>
                        <div style="color: #d1d5db; line-height: 1.8;">
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">1. Lead with Your Worth:</strong><br>
                                "Based on my skill profile and market analysis, my value is in the $${Math.round(totalValue.yourWorth * 0.95 / 1000) * 1000}-$${Math.round(totalValue.yourWorth * 1.05 / 1000) * 1000} range for ${totalValue.roleLevel} roles in ${userData.profile.location}."
                            </p>
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">2. Reference Your Top 10 Skills:</strong><br>
                                "I bring ${totalValue.top10Skills.filter(s => s.level === 'Mastery').length} mastery-level skills including ${totalValue.top10Skills.slice(0, 3).map(s => s.skill).join(', ')}. These command premiums in the current market."
                            </p>
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">3. Show the Data:</strong><br>
                                "The market rate for ${totalValue.roleLevel} is $${totalValue.marketRate.toLocaleString()}. My critical and high-impact skills justify a ${Math.round(((totalValue.yourWorth - totalValue.marketRate) / totalValue.marketRate) * 100)}% premium."
                            </p>
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">4. Use Your Outcomes:</strong><br>
                                "I've consistently delivered [cite 2-3 quantified outcomes from your Blueprint]. This track record supports my valuation."
                            </p>
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">📋 Negotiation Script</h3>
                        <div style="color: #d1d5db; line-height: 1.8; font-size: 0.95em;">
                            <strong>When they ask for salary expectations:</strong>
                            <br><br>
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px; margin: 10px 0; font-style: italic;">
                            "I appreciate you asking. Based on my research and skill profile, I'm looking at the $${Math.round(totalValue.competitiveOffer / 1000) * 1000}-$${Math.round(totalValue.yourWorth / 1000) * 1000} range. But I'm flexible depending on the total compensation package, including equity and benefits. What range were you considering?"
                            </div>
                            <br>
                            <strong>When they give a low offer ($${totalValue.conservativeOffer.toLocaleString()}):</strong>
                            <br><br>
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px; margin: 10px 0; font-style: italic;">
                            "I appreciate the offer. Based on market data for ${totalValue.roleLevel} roles with my skill set—particularly my ${totalValue.top10Skills[0].skill} expertise—the range is typically closer to $${totalValue.standardOffer.toLocaleString()}-$${totalValue.competitiveOffer.toLocaleString()}. Can we explore options in that range?"
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">✓ Best Practices</h3>
                        <div style="color: #d1d5db; line-height: 1.8;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #10b981;">DO:</strong>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    <li>Start at your worth ($${totalValue.yourWorth.toLocaleString()})</li>
                                    <li>Reference the $${negotiationGap.toLocaleString()} gap as your leverage</li>
                                    <li>Cite your top 10 skills as justification</li>
                                    <li>Ask about total comp (equity, bonus, benefits)</li>
                                    <li>Get offers in writing before negotiating</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: #ef4444;">DON'T:</strong>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    <li>Accept the first offer—they expect negotiation</li>
                                    <li>Give a range first—make them lead</li>
                                    <li>Focus only on base salary</li>
                                    <li>Negotiate without data</li>
                                    <li>Accept below $${totalValue.conservativeOffer.toLocaleString()} (75%)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <button class="export-btn-large" onclick="closeExportModal()" style="width: 100%; margin-top: 25px;">
                        Close Guide
                    </button>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        // ===== IMPACT RATING ENGINE =====
        
        let impactRatings = null;
        
        async function loadImpactRatings() {
            try {
                const response = await fetch('onet-impact-ratings.json');
                impactRatings = await response.json();
                console.log('✓ Impact ratings loaded');
            } catch (e) {
                console.error('Error loading impact ratings:', e);
            }
        }
        
        // Load impact ratings on startup
        loadImpactRatings();
        
        function getSkillImpact(skill) {
            if (!impactRatings) {
                return { level: 'moderate', label: 'Moderate Impact', icon: '💎', rationale: 'Loading ratings...' };
            }
            
            // Handle unique skills (no O*NET match)
            if (skill.category === 'unique') {
                return getUniqueSkillImpact(skill);
            }
            
            // Get O*NET rating
            const category = skill.category; // 'skill', 'ability', 'workstyle'
            const categoryData = impactRatings[category + 's']; // 'skills', 'abilities', 'workstyles'
            
            if (!categoryData || !skill.onetId) {
                return { level: 'moderate', label: 'Moderate Impact', icon: '💎', rationale: 'No rating data available' };
            }
            
            const skillRating = categoryData[skill.onetId];
            if (!skillRating) {
                return { level: 'moderate', label: 'Moderate Impact', icon: '💎', rationale: 'Skill not found in ratings' };
            }
            
            // Apply proficiency multiplier
            const impactLevel = skillRating.proficiencyMultiplier[skill.level] || skillRating.baseImpact;
            
            return {
                level: impactLevel,
                label: getImpactLabel(impactLevel),
                icon: getImpactIcon(impactLevel),
                rationale: skillRating.rationale,
                executiveImportance: skillRating.executiveImportance,
                marketScarcity: skillRating.marketScarcity
            };
        }
        
        function getUniqueSkillImpact(skill) {
            // Check if user has assessed this skill
            if (skill.userAssessment) {
                return calculateUniqueSkillImpact(skill.userAssessment);
            }
            
            // Try to find comparable O*NET skill
            const comparable = findComparableSkill(skill.name);
            if (comparable) {
                return {
                    ...comparable,
                    rationale: `Estimated based on similar skills. Consider providing custom assessment for more accuracy.`,
                    needsAssessment: true
                };
            }
            
            // Default for unique skills without assessment
            return {
                level: 'high',
                label: 'High Impact',
                icon: '⭐',
                rationale: 'Unique differentiator. Provide assessment for accurate rating.',
                needsAssessment: true
            };
        }
        
        function findComparableSkill(skillName) {
            if (!impactRatings) return null;
            
            const name = skillName.toLowerCase();
            
            // Simple keyword matching to find comparable
            if (name.includes('ai') || name.includes('artificial intelligence')) {
                return getSkillImpact({ category: 'skill', onetId: 'systems-analysis', level: 'Mastery' });
            }
            if (name.includes('strategy')) {
                return getSkillImpact({ category: 'skill', onetId: 'complex-problem-solving', level: 'Mastery' });
            }
            if (name.includes('leadership')) {
                return getSkillImpact({ category: 'workstyle', onetId: 'leadership', level: 'Mastery' });
            }
            
            return null;
        }
        
        function calculateUniqueSkillImpact(assessment) {
            let score = 0;
            
            // Years experience (mastery indicator)
            if (assessment.years >= 10) score += 3;
            else if (assessment.years >= 5) score += 2;
            else score += 1;
            
            // Business impact
            if (assessment.impact === 'major') score += 3;
            else if (assessment.impact === 'significant') score += 2;
            else score += 1;
            
            // Scarcity
            if (assessment.rarity === 'rare') score += 3;
            else if (assessment.rarity === 'uncommon') score += 2;
            else score += 1;
            
            // Salary band
            if (assessment.salaryBand === '>$250k') score += 3;
            else if (assessment.salaryBand === '$150-250k') score += 2;
            else score += 1;
            
            // Total: 4-12
            let impactLevel;
            if (score >= 10) impactLevel = 'critical';
            else if (score >= 8) impactLevel = 'high';
            else if (score >= 6) impactLevel = 'moderate';
            else impactLevel = 'standard';
            
            return {
                level: impactLevel,
                label: getImpactLabel(impactLevel),
                icon: getImpactIcon(impactLevel),
                rationale: 'Based on your assessment',
                userAssessed: true
            };
        }
        
        function getImpactLabel(level) {
            const labels = {
                'critical': 'Critical Impact',
                'high': 'High Impact',
                'moderate': 'Moderate Impact',
                'standard': 'Standard',
                'supplementary': 'Supplementary'
            };
            return labels[level] || 'Moderate Impact';
        }
        
        function getImpactIcon(level) {
            const icons = {
                'critical': '🔥',
                'high': '⭐',
                'moderate': '💎',
                'standard': '✓',
                'supplementary': '○'
            };
            return icons[level] || '💎';
        }
        
        function getImpactColor(level) {
            const colors = {
                'critical': '#ef4444',
                'high': '#f59e0b',
                'moderate': '#3b82f6',
                'standard': '#6b7280',
                'supplementary': '#9ca3af'
            };
            return colors[level] || '#3b82f6';
        }
        
        // ===== SKILL MANAGEMENT FUNCTIONS =====
        
        let onetSelectedSkills = [];
        let currentONETTab = 'skills';
        let currentEditingSkill = null;
        
        function openONETPicker() {
            const modal = document.getElementById('onetPickerModal');
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            switchONETTab('skills');
            updateONETSelectedCount(); // Initialize count display
        }
        
        function closeONETPicker() {
            const modal = document.getElementById('onetPickerModal');
            modal.classList.remove('active');
            onetSelectedSkills = [];
        }
        
        window.switchONETTab = function switchONETTab(tab) {
            currentONETTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.onet-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('onetTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            // Load content
            renderONETLibrary();
        }
        
        function renderONETLibrary() {
            const container = document.getElementById('onetLibraryContent');
            const searchQuery = document.getElementById('onetSearchInput').value.toLowerCase();
            
            let html = '';
            let library, categoryKey;
            
            if (currentONETTab === 'skills') {
                library = window.onetSkillsLibrary;
                categoryKey = 'skill';
            } else if (currentONETTab === 'abilities') {
                library = window.onetAbilitiesLibrary;
                categoryKey = 'ability';
            } else if (currentONETTab === 'knowledge') {
                library = window.onetKnowledgeLibrary;
                categoryKey = 'knowledge';
            } else if (currentONETTab === 'activities') {
                library = window.onetWorkActivitiesLibrary;
                categoryKey = 'workactivity';
            } else {
                library = window.onetWorkStylesLibrary;
                categoryKey = 'workstyle';
            }
            
            if (!library) {
                container.innerHTML = `<div style="text-align:center;padding:40px;color:#9ca3af;">
                    Library not loaded.<br><small style="opacity:0.6">Make sure the JSON file is deployed to GitHub.</small>
                </div>`;
                return;
            }
            
            // Get user's existing skills of this category
            const existingSkillNames = userData.skills
                .filter(s => s.category === categoryKey)
                .map(s => s.name);
            
            // Knowledge and Work Activities: flat arrays grouped by onetGroup
            if (currentONETTab === 'knowledge' || currentONETTab === 'activities') {
                const items = currentONETTab === 'knowledge' ? library.knowledge : library.activities;
                const grouped = {};
                items.forEach(item => {
                    const grp = item.group || 'Other';
                    if (!grouped[grp]) grouped[grp] = [];
                    grouped[grp].push(item);
                });
                Object.entries(grouped).forEach(([groupName, groupItems]) => {
                    let groupHtml = '';
                    let hasResults = false;
                    groupItems.forEach(item => {
                        const isAdded = existingSkillNames.includes(item.name);
                        const isSelected = onetSelectedSkills.some(s => s.id === item.onetCode);
                        const matchesSearch = !searchQuery ||
                            item.name.toLowerCase().includes(searchQuery) ||
                            (item.description || '').toLowerCase().includes(searchQuery);
                        if (!matchesSearch) return;
                        hasResults = true;
                        // Normalize to expected shape
                        const normalized = {
                            id: item.onetCode,
                            name: item.name,
                            definition: item.description || '',
                            category: categoryKey
                        };
                        groupHtml += renderONETSkillItem(normalized, categoryKey, isAdded, isSelected);
                    });
                    if (hasResults) {
                        html += `<div class="onet-category">
                            <div class="onet-category-title">▼ ${groupName}</div>
                            ${groupHtml}
                        </div>`;
                    }
                });
            } else if (currentONETTab === 'workstyles') {
                // Work styles are a flat array
                const wsItems = library.workStyles || [];
                // Group by onetGroup if available
                const grouped = {};
                wsItems.forEach(item => {
                    const grp = item.group || item.onetGroup || 'Work Styles';
                    if (!grouped[grp]) grouped[grp] = [];
                    grouped[grp].push(item);
                });
                const isGrouped = Object.keys(grouped).length > 1;
                wsItems.forEach(item => {
                    const isAdded = existingSkillNames.includes(item.name);
                    const isSelected = onetSelectedSkills.some(s => s.id === (item.id || item.onetCode));
                    const matchesSearch = !searchQuery || 
                        item.name.toLowerCase().includes(searchQuery) ||
                        (item.definition || item.description || '').toLowerCase().includes(searchQuery);
                    
                    if (!matchesSearch) return;
                    
                    // Normalize
                    const normalized = {
                        id: item.id || item.onetCode,
                        name: item.name,
                        definition: item.definition || item.description || '',
                        category: categoryKey
                    };
                    html += renderONETSkillItem(normalized, categoryKey, isAdded, isSelected);
                });
            } else {
                // Skills and abilities have category/subcategory structure
                const categories = currentONETTab === 'skills' ? library.categories : library.categories;
                
                Object.entries(categories).forEach(([catId, category]) => {
                    let categoryHtml = '';
                    let categoryHasResults = false;
                    
                    if (category.subcategories) {
                        Object.entries(category.subcategories).forEach(([subId, subcategory]) => {
                            let subcategoryHtml = '';
                            let subcategoryHasResults = false;
                            
                            const items = currentONETTab === 'skills' ? subcategory.skills : subcategory.abilities;
                            if (!items) return;
                            
                            items.forEach(item => {
                                const isAdded = existingSkillNames.includes(item.name);
                                const isSelected = onetSelectedSkills.some(s => s.id === item.id);
                                const matchesSearch = !searchQuery || 
                                    item.name.toLowerCase().includes(searchQuery) ||
                                    item.definition.toLowerCase().includes(searchQuery);
                                
                                if (!matchesSearch) return;
                                
                                subcategoryHtml += renderONETSkillItem(item, categoryKey, isAdded, isSelected);
                                subcategoryHasResults = true;
                                categoryHasResults = true;
                            });
                            
                            if (subcategoryHasResults) {
                                categoryHtml += `
                                    <div class="onet-subcategory">
                                        <div class="onet-subcategory-title">${subcategory.name}</div>
                                        ${subcategoryHtml}
                                    </div>
                                `;
                            }
                        });
                    }
                    
                    if (categoryHasResults) {
                        html += `
                            <div class="onet-category">
                                <div class="onet-category-title">▼ ${category.name}</div>
                                ${categoryHtml}
                            </div>
                        `;
                    }
                });
            }
            
            if (!html) {
                html = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No results found</div>';
            }
            
            container.innerHTML = html;
            updateONETSelectedCount();
        }
        
        function renderONETSkillItem(item, category, isAdded, isSelected) {
            const disabled = isAdded ? 'disabled' : '';
            const selectedClass = isSelected ? 'selected' : '';
            
            return `
                <div class="onet-skill-item ${disabled} ${selectedClass}" 
                     onclick="${isAdded ? '' : `toggleONETSkillSelection('${item.id}', '${item.name}', '${category}')`}">
                    <input type="checkbox" 
                           class="onet-skill-checkbox" 
                           ${isSelected ? 'checked' : ''}
                           ${isAdded ? 'disabled' : ''}
                           onclick="event.stopPropagation();">
                    <div class="onet-skill-content">
                        <div class="onet-skill-name">
                            ${item.name}
                            ${isAdded ? '<span class="onet-skill-added">✓ Added</span>' : ''}
                        </div>
                        <div class="onet-skill-definition">${item.definition}</div>
                    </div>
                </div>
            `;
        }
        
        function toggleONETSkillSelection(id, name, category) {
            const index = onetSelectedSkills.findIndex(s => s.id === id);
            
            if (index === -1) {
                onetSelectedSkills.push({ id, name, category });
            } else {
                onetSelectedSkills.splice(index, 1);
            }
            
            renderONETLibrary();
            updateONETSelectedCount(); // FIX: Update count display
        }
        
        function updateONETSelectedCount() {
            const count = onetSelectedSkills.length;
            const countEl = document.getElementById('onetSelectedCount');
            const buttonEl = document.getElementById('onetAddButton');
            
            if (count === 0) {
                countEl.textContent = 'Select skills to add';
                buttonEl.disabled = true;
                buttonEl.style.opacity = '0.5';
            } else {
                countEl.textContent = `${count} skill${count > 1 ? 's' : ''} selected`;
                buttonEl.disabled = false;
                buttonEl.style.opacity = '1';
            }
        }
        
        function filterONETLibrary() {
            renderONETLibrary();
        }
        
        function addSelectedONETSkills() {
            if (onetSelectedSkills.length === 0) return;
            
            onetSelectedSkills.forEach(selectedSkill => {
                // Create skill object
                const newSkill = {
                    name: selectedSkill.name,
                    category: selectedSkill.category,
                    onetId: selectedSkill.id,
                    level: 'Advanced', // Default
                    roles: [userData.roles[0].id], // Default to first role
                    key: false
                };
                
                // Add to userData
                userData.skills.push(newSkill);
                skillsData.skills.push(newSkill);
            });
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            closeONETPicker();
            
            // Show success message
            showToast(`Added ${onetSelectedSkills.length} skill${onetSelectedSkills.length > 1 ? 's' : ''}.`, 'success');
        }
        
        function openCustomSkillBuilder() {
            const modal = document.getElementById('customSkillModal');
            
            // Populate roles checkboxes
            const rolesContainer = document.getElementById('customSkillRoles');
            rolesContainer.innerHTML = userData.roles.map(role => `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" value="${role.id}" class="custom-skill-role-checkbox">
                    <span>${role.name}</span>
                </label>
            `).join('');
            
            // Reset form
            document.getElementById('customSkillName').value = '';
            document.getElementById('customSkillCore').checked = false;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function closeCustomSkillBuilder() {
            const modal = document.getElementById('customSkillModal');
            modal.classList.remove('active');
        }
        
        function createCustomSkill() {
            const name = document.getElementById('customSkillName').value.trim();
            const level = document.querySelector('input[name="customSkillLevel"]:checked').value;
            const core = document.getElementById('customSkillCore').checked;
            const roles = Array.from(document.querySelectorAll('.custom-skill-role-checkbox:checked')).map(cb => cb.value);
            
            // Validate
            if (!name) {
                showToast('Please enter a skill name.', 'warning');
                return;
            }
            
            if (roles.length === 0) {
                showToast('Please select at least one role.', 'warning');
                return;
            }
            
            // Check for duplicates
            if (userData.skills.some(s => s.name === name)) {
                showToast('A skill with this name already exists.', 'warning');
                return;
            }
            
            // Create skill
            const newSkill = {
                name: name,
                category: 'unique',
                level: level,
                roles: roles,
                key: core
            };
            
            // Add to userData
            userData.skills.push(newSkill);
            skillsData.skills.push(newSkill);
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            closeCustomSkillBuilder();
            
            showToast(`Created "${name}".`, 'success');
        }
        
        function openEditSkillModal(skillName, category) {
            const skill = userData.skills.find(s => s.name === skillName);
            if (!skill) return;
            
            currentEditingSkill = skillName;
            const modal = document.getElementById('editSkillModal');
            
            // Populate form
            document.getElementById('editSkillName').value = skill.name;
            document.querySelector(`input[name="editSkillLevel"][value="${skill.level}"]`).checked = true;
            document.getElementById('editSkillCore').checked = skill.key || false;
            
            // Populate roles
            const rolesContainer = document.getElementById('editSkillRoles');
            rolesContainer.innerHTML = userData.roles.map(role => `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" value="${role.id}" class="edit-skill-role-checkbox" ${skill.roles.includes(role.id) ? 'checked' : ''}>
                    <span>${role.name}</span>
                </label>
            `).join('');
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function closeEditSkillModal() {
            const modal = document.getElementById('editSkillModal');
            modal.classList.remove('active');
            currentEditingSkill = null;
        }
        
        function saveSkillEdit() {
            if (!currentEditingSkill) return;
            
            const skill = userData.skills.find(s => s.name === currentEditingSkill);
            if (!skill) return;
            
            const level = document.querySelector('input[name="editSkillLevel"]:checked').value;
            const core = document.getElementById('editSkillCore').checked;
            const roles = Array.from(document.querySelectorAll('.edit-skill-role-checkbox:checked')).map(cb => cb.value);
            
            // Validate
            if (roles.length === 0) {
                showToast('Please select at least one role.', 'warning');
                return;
            }
            
            // Update skill
            skill.level = level;
            skill.key = core;
            skill.roles = roles;
            
            // Update skillsData too
            const skillDataIndex = skillsData.skills.findIndex(s => s.name === currentEditingSkill);
            if (skillDataIndex !== -1) {
                skillsData.skills[skillDataIndex] = {...skill};
            }
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            closeEditSkillModal();
            
            showToast(`Updated "${currentEditingSkill}".`, 'success');
        }
        
        function confirmDeleteSkill(skillName, category) {
            if (!confirm(`Delete "${skillName}"?\n\nThis cannot be undone.`)) {
                return;
            }
            
            deleteSkill(skillName);
        }
        
        function deleteSkill(skillName) {
            // Remove from userData
            const userIndex = userData.skills.findIndex(s => s.name === skillName);
            if (userIndex !== -1) {
                userData.skills.splice(userIndex, 1);
            }
            
            // Remove from skillsData
            const skillsIndex = skillsData.skills.findIndex(s => s.name === skillName);
            if (skillsIndex !== -1) {
                skillsData.skills.splice(skillsIndex, 1);
            }
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            console.log(`Deleted skill: ${skillName}`);
        }
        
        // ===== SKILL ASSESSMENT FUNCTIONS =====
        
        let currentAssessingSkill = null;
        
        function openAssessSkillModal(skillName) {
            const skill = userData.skills.find(s => s.name === skillName);
            if (!skill) return;
            
            currentAssessingSkill = skillName;
            const modal = document.getElementById('assessSkillModal');
            
            // Set skill name
            document.getElementById('assessSkillName').textContent = skill.name;
            
            // Pre-fill with existing assessment if available
            if (skill.userAssessment) {
                document.getElementById('assessYears').value = skill.userAssessment.years || 5;
                document.querySelector(`input[name="assessImpact"][value="${skill.userAssessment.impact}"]`).checked = true;
                document.querySelector(`input[name="assessRarity"][value="${skill.userAssessment.rarity}"]`).checked = true;
                document.querySelector(`input[name="assessSalary"][value="${skill.userAssessment.salaryBand}"]`).checked = true;
            } else {
                // Defaults
                document.getElementById('assessYears').value = 5;
                document.querySelector('input[name="assessImpact"][value="significant"]').checked = true;
                document.querySelector('input[name="assessRarity"][value="uncommon"]').checked = true;
                document.querySelector('input[name="assessSalary"][value="$150-250k"]').checked = true;
            }
            
            updateAssessmentPreview();
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            
            // Add listeners for live preview
            document.getElementById('assessYears').addEventListener('input', updateAssessmentPreview);
            document.querySelectorAll('input[name="assessImpact"]').forEach(r => 
                r.addEventListener('change', updateAssessmentPreview));
            document.querySelectorAll('input[name="assessRarity"]').forEach(r => 
                r.addEventListener('change', updateAssessmentPreview));
            document.querySelectorAll('input[name="assessSalary"]').forEach(r => 
                r.addEventListener('change', updateAssessmentPreview));
        }
        
        function closeAssessSkillModal() {
            const modal = document.getElementById('assessSkillModal');
            modal.classList.remove('active');
            currentAssessingSkill = null;
        }
        
        function updateAssessmentPreview() {
            const years = parseInt(document.getElementById('assessYears').value) || 0;
            const impact = document.querySelector('input[name="assessImpact"]:checked')?.value || 'significant';
            const rarity = document.querySelector('input[name="assessRarity"]:checked')?.value || 'uncommon';
            const salaryBand = document.querySelector('input[name="assessSalary"]:checked')?.value || '$150-250k';
            
            const assessment = { years, impact, rarity, salaryBand };
            const result = calculateUniqueSkillImpact(assessment);
            
            const preview = document.getElementById('assessmentPreview');
            const icon = getImpactIcon(result.level);
            const label = getImpactLabel(result.level);
            const color = getImpactColor(result.level);
            
            preview.innerHTML = `Predicted rating: <span style="color: ${color}; font-weight: 600;">${icon} ${label}</span>`;
        }
        
        function saveSkillAssessment() {
            if (!currentAssessingSkill) return;
            
            const skill = userData.skills.find(s => s.name === currentAssessingSkill);
            if (!skill) return;
            
            // Gather assessment data
            const years = parseInt(document.getElementById('assessYears').value) || 0;
            const impact = document.querySelector('input[name="assessImpact"]:checked')?.value || 'significant';
            const rarity = document.querySelector('input[name="assessRarity"]:checked')?.value || 'uncommon';
            const salaryBand = document.querySelector('input[name="assessSalary"]:checked')?.value || '$150-250k';
            
            // Save to skill object
            skill.userAssessment = {
                years: years,
                impact: impact,
                rarity: rarity,
                salaryBand: salaryBand,
                assessedDate: new Date().toISOString()
            };
            
            // Update skillsData too
            const skillDataIndex = skillsData.skills.findIndex(s => s.name === currentAssessingSkill);
            if (skillDataIndex !== -1) {
                skillsData.skills[skillDataIndex].userAssessment = skill.userAssessment;
            }
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            closeAssessSkillModal();
            
            const result = calculateUniqueSkillImpact(skill.userAssessment);
            showToast(`Assessment saved. "${currentAssessingSkill}" rated as ${result.label}.`, 'success');
        }
        
        function refreshAllViews() {
            // Refresh settings skill list
            const skillsList = document.getElementById('skillsList');
            if (skillsList) {
                skillsList.innerHTML = renderSkillsList();
            }
            
            // Refresh network graph
            if (currentView === 'network') {
                initNetwork();
            }
            
            // Refresh card view
            if (currentView === 'network' && currentSkillsView === 'cards') {
                renderCardView();
            }
            
            // Update stats bar
            updateStatsBar();
            
            // Re-render settings (to update counts)
            if (currentView === 'settings') {
                initSettings();
            }
        }
        
        // ===== SKILL SEARCH MODAL FUNCTIONS (v2.3.0) =====
        
        // ===== UNIFIED SKILL MANAGEMENT SYSTEM (v2.4.0) =====
        
        let currentSkillManagementTab = 'yours';

        function openSkillManagement() {
            const modal = document.getElementById('skillManagementModal');
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            
            if (!skillLibraryIndex || !skillLibraryIndex.index) {
                loadSkillLibraryIndex();
            }
            
            populateCategoryFilter();
            updateSkillManagementCounts();
            switchSkillManagementTab('yours');
        }

        // Build category dropdown from actual skills in this profile — only show categories that exist
        window.populateCategoryFilter = function populateCategoryFilter() {
            const select = document.getElementById('yourSkillsCategoryFilter');
            if (!select) return;
            const currentVal = select.value;
            
            const categoryMeta = {
                'skill':         { label: 'Skills',           icon: '🗺️' },
                'ability':       { label: 'Abilities',        icon: '⚡' },
                'workstyle':     { label: 'Work Styles',      icon: '🧭' },
                'knowledge':     { label: 'Knowledge',        icon: '📚' },
                'workactivity':  { label: 'Work Activities',  icon: '⚙️' },
                'trades':        { label: 'Trade Skills',     icon: '🔨' },
                'unique':        { label: 'Custom Skills',    icon: '⭐' },
            };
            
            // Count skills by category
            const counts = {};
            userData.skills.forEach(s => {
                const cat = s.category || 'skill';
                counts[cat] = (counts[cat] || 0) + 1;
            });
            
            // Build options — only include categories that have skills
            let html = `<option value="all">All Categories (${userData.skills.length})</option>`;
            // Use preferred order
            const order = ['skill','ability','workstyle','knowledge','workactivity','trades','unique'];
            order.forEach(cat => {
                const count = counts[cat];
                if (!count) return; // skip empty categories
                const meta = categoryMeta[cat] || { label: cat, icon: '•' };
                html += `<option value="${cat}">${meta.icon} ${meta.label} (${count})</option>`;
            });
            // Catch any unexpected categories in the data
            Object.keys(counts).forEach(cat => {
                if (!order.includes(cat)) {
                    html += `<option value="${cat}">${cat} (${counts[cat]})</option>`;
                }
            });
            
            select.innerHTML = html;
            // Restore previous selection if still valid
            if (currentVal && select.querySelector(`option[value="${currentVal}"]`)) {
                select.value = currentVal;
            }
        }

        function closeSkillManagement() {
            const modal = document.getElementById('skillManagementModal');
            modal.classList.remove('active');
        }

        function switchSkillManagementTab(tab) {
            currentSkillManagementTab = tab;
            
            document.getElementById('yourSkillsTab').classList.toggle('active', tab === 'yours');
            document.getElementById('addSkillsTab').classList.toggle('active', tab === 'add');
            
            document.getElementById('yourSkillsContent').style.display = tab === 'yours' ? 'block' : 'none';
            document.getElementById('addSkillsContent').style.display = tab === 'add' ? 'block' : 'none';
            
            if (tab === 'yours') {
                renderYourSkills();
            } else {
                showAddSkillsEmpty();
            }
        }

        // Central count function — always call this after loading any library or adding skills
        function getTotalAvailableSkillCount() {
            let total = 0;
            // ESCO searchable library
            if (skillLibraryIndex?.totalSkills) total += skillLibraryIndex.totalSkills;
            else if (skillLibraryIndex?.index?.length) total += skillLibraryIndex.index.length;
            // O*NET libraries
            if (window.onetSkillsLibrary) total += 35; // nested categories structure
            if (window.onetAbilitiesLibrary?.abilities) total += window.onetAbilitiesLibrary.abilities.length;
            if (window.onetWorkStylesLibrary?.workStyles) total += window.onetWorkStylesLibrary.workStyles.length;
            if (window.onetKnowledgeLibrary?.knowledge) total += window.onetKnowledgeLibrary.knowledge.length;
            if (window.onetWorkActivitiesLibrary?.activities) total += window.onetWorkActivitiesLibrary.activities.length;
            // Trades & Creative
            if (window.tradesCreativeLibrary?.count) total += window.tradesCreativeLibrary.count;
            // Future: Lightcast, ESCO full, etc. add here
            return total > 0 ? total : 2384; // fallback if libraries not yet loaded
        }
        
        function updateSkillManagementCounts() {
            const yourCount = userData.skills.length;
            const availableCount = getTotalAvailableSkillCount();
            
            document.getElementById('yourSkillsCount').textContent = yourCount;
            document.getElementById('availableSkillsCount').textContent = availableCount.toLocaleString();
            document.getElementById('skillManagementCount').textContent = 
                `${yourCount} selected • ${availableCount.toLocaleString()} available`;
        }

        function renderYourSkills() {
            const container = document.getElementById('yourSkillsList');
            const searchQuery = document.getElementById('yourSkillsSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('yourSkillsCategoryFilter').value;
            const levelFilter = document.getElementById('yourSkillsLevelFilter').value;
            
            let skills = userData.skills.filter(skill => {
                const matchesSearch = !searchQuery || skill.name.toLowerCase().includes(searchQuery);
                const matchesCategory = categoryFilter === 'all' || skill.category === categoryFilter;
                const matchesLevel = levelFilter === 'all' || skill.level === levelFilter;
                return matchesSearch && matchesCategory && matchesLevel;
            });
            
            if (skills.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 3em; margin-bottom: 10px;">📋</div>
                        <div style="font-size: 1.1em;">No skills found</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">Try adjusting your filters</div>
                    </div>
                `;
                return;
            }
            
            const grouped = {};
            skills.forEach(skill => {
                const cat = skill.category || 'unique';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(skill);
            });
            
            const categoryNames = {
                'skill': 'Technology',
                'ability': 'General Professional',
                'workstyle': 'Work Styles',
                'unique': 'Custom Skills'
            };
            
            container.innerHTML = Object.entries(grouped).map(([cat, catSkills]) => `
                <div style="margin-bottom: 25px;">
                    <div style="color: #9ca3af; font-size: 0.85em; font-weight: 600; margin-bottom: 12px; text-transform: uppercase;">
                        ${categoryNames[cat] || cat} (${catSkills.length})
                    </div>
                    ${catSkills.map(skill => `
                        <div class="your-skill-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="color: #e0e0e0; font-weight: 600; margin-bottom: 6px; font-size: 1.05em;">
                                        ${skill.name}
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <span style="color: #60a5fa; font-size: 0.8em; padding: 2px 8px; background: rgba(96, 165, 250, 0.2); border-radius: 3px;">
                                            ${skill.level}
                                        </span>
                                        ${skill.key ? '<span style="color: #fbbf24; font-size: 0.8em;">⭐ Core</span>' : ''}
                                        ${skill.roles ? `<span style="color: #9ca3af; font-size: 0.8em;">${skill.roles.length} role${skill.roles.length > 1 ? 's' : ''}</span>` : ''}
                                    </div>
                                </div>
                                <button onclick="removeSkillFromProfile('${skill.name.replace(/'/g, "\\'")}', '${cat}')" 
                                        style="padding: 8px 16px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap; font-weight: 600; transition: all 0.2s;"
                                        onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                                        onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function filterYourSkills() {
            renderYourSkills();
        }

        function removeSkillFromProfile(skillName, category) {
            if (!confirm(`Remove "${skillName}" from your profile?`)) return;
            
            const skillIndex = userData.skills.findIndex(s => s.name === skillName && s.category === category);
            if (skillIndex !== -1) {
                userData.skills.splice(skillIndex, 1);
            }
            
            const dataIndex = skillsData.skills.findIndex(s => s.name === skillName && s.category === category);
            if (dataIndex !== -1) {
                skillsData.skills.splice(dataIndex, 1);
            }
            
            saveUserData();
            updateSkillManagementCounts();
            renderYourSkills();
            refreshAllViews();
        }

        function showAddSkillsEmpty() {
            const container = document.getElementById('addSkillsResults');
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                    <div style="font-size: 3em; margin-bottom: 10px;">🔍</div>
                    <div style="font-size: 1.1em;">Start typing to search skills</div>
                    <div style="font-size: 0.9em; margin-top: 10px;">Try: "python", "marketing", "leadership"</div>
                </div>
            `;
            document.getElementById('skillManagementStatus').textContent = '';
            document.getElementById('addSkillsCategories').style.display = 'block';
        }

        let addSkillsSearchTimeout;
        function handleAddSkillsSearch() {
            clearTimeout(addSkillsSearchTimeout);
            
            addSkillsSearchTimeout = setTimeout(() => {
                const query = document.getElementById('addSkillsSearchInput').value;
                console.log('Search triggered for:', query);
                
                if (!skillLibraryIndex || !skillLibraryIndex.index) {
                    console.error('Skill library not loaded!');
                    const container = document.getElementById('addSkillsResults');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #f59e0b;">
                            <div style="font-size: 3em; margin-bottom: 10px;">⏳</div>
                            <div style="font-size: 1.1em;">Loading skill library...</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">Please wait</div>
                        </div>
                    `;
                    // Force reload
                    loadSkillLibraryIndex().then(() => {
                        console.log('Library loaded, retrying search');
                        handleAddSkillsSearch();
                    });
                    return;
                }
                
                console.log('Library loaded with', skillLibraryIndex.totalSkills, 'skills');
                
                if (!query || query.trim().length < 2) {
                    console.log('Query too short, showing empty state');
                    showAddSkillsEmpty();
                    return;
                }
                
                console.log('Performing search for:', query);
                performAddSkillsSearch(query);
            }, 300);
        }

        // Search across ALL loaded libraries and return normalized results
        function searchAllLibraries(query) {
            const q = query.toLowerCase().trim();
            if (q.length < 2) return [];
            const results = [];
            const seen = new Set();
            
            // 1. ESCO searchable index
            const escoResults = searchSkills(query);
            escoResults.forEach(s => {
                const key = (s.n || '').toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    results.push({ id: s.id, n: s.n, c: s.c, sc: s.sc || '', definition: '', source: 'esco', category: null, _raw: s });
                }
            });
            
            // 2. Trades & Creative library
            if (window.tradesCreativeLibrary && window.tradesCreativeLibrary.categories) {
                Object.entries(window.tradesCreativeLibrary.categories).forEach(function([catKey, cat]) {
                    (cat.skills || []).forEach(function(skill) {
                        const nameMatch = skill.name.toLowerCase().includes(q);
                        const defMatch = (skill.definition || '').toLowerCase().includes(q);
                        const adjMatch = (skill.adjacencies || []).some(function(a) { return a.toLowerCase().includes(q); });
                        if (nameMatch || defMatch || adjMatch) {
                            const key = skill.name.toLowerCase();
                            if (!seen.has(key)) {
                                seen.add(key);
                                results.push({ id: skill.id, n: skill.name, c: cat.name, sc: 'Trades & Creative', definition: skill.definition || '', source: 'trades', category: 'trades', _raw: skill });
                            }
                        }
                    });
                });
            }
            
            // 3. O*NET Knowledge
            if (window.onetKnowledgeLibrary && window.onetKnowledgeLibrary.knowledge) {
                window.onetKnowledgeLibrary.knowledge.forEach(function(skill) {
                    if (skill.name.toLowerCase().includes(q) || (skill.description || '').toLowerCase().includes(q)) {
                        const key = skill.name.toLowerCase();
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ id: skill.onetCode, n: skill.name, c: 'Knowledge', sc: skill.group || '', definition: skill.description || '', source: 'onet-knowledge', category: 'knowledge', _raw: skill });
                        }
                    }
                });
            }
            
            // 4. O*NET Work Activities
            if (window.onetWorkActivitiesLibrary && window.onetWorkActivitiesLibrary.activities) {
                window.onetWorkActivitiesLibrary.activities.forEach(function(skill) {
                    if (skill.name.toLowerCase().includes(q) || (skill.description || '').toLowerCase().includes(q)) {
                        const key = skill.name.toLowerCase();
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ id: skill.onetCode, n: skill.name, c: 'Work Activities', sc: skill.group || '', definition: skill.description || '', source: 'onet-activities', category: 'workactivity', _raw: skill });
                        }
                    }
                });
            }
            
            // 5. O*NET Abilities
            if (window.onetAbilitiesLibrary && window.onetAbilitiesLibrary.abilities) {
                window.onetAbilitiesLibrary.abilities.forEach(function(skill) {
                    const def = skill.definition || skill.description || '';
                    if (skill.name.toLowerCase().includes(q) || def.toLowerCase().includes(q)) {
                        const key = skill.name.toLowerCase();
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ id: skill.id || skill.onetCode, n: skill.name, c: 'Abilities', sc: skill.group || '', definition: def, source: 'onet-abilities', category: 'ability', _raw: skill });
                        }
                    }
                });
            }
            
            // 6. O*NET Work Styles
            if (window.onetWorkStylesLibrary && window.onetWorkStylesLibrary.workStyles) {
                window.onetWorkStylesLibrary.workStyles.forEach(function(skill) {
                    const def = skill.definition || skill.description || '';
                    if (skill.name.toLowerCase().includes(q) || def.toLowerCase().includes(q)) {
                        const key = skill.name.toLowerCase();
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ id: skill.id || skill.onetCode, n: skill.name, c: 'Work Styles', sc: skill.group || '', definition: def, source: 'onet-workstyles', category: 'workstyle', _raw: skill });
                        }
                    }
                });
            }
            
            return results.slice(0, 30);
        }
        
        function performAddSkillsSearch(query) {
            try {
                const safeResults = searchAllLibraries(query);
                
                const container = document.getElementById('addSkillsResults');
                if (!container) {
                    console.error('ERROR: addSkillsResults container not found!');
                    return;
                }
                
                const categoriesDiv = document.getElementById('addSkillsCategories');
                if (categoriesDiv) {
                    categoriesDiv.style.display = 'none';
                }
                
                if (safeResults.length === 0) {
                    console.log('No results found, showing empty state');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                            <div style="font-size: 3em; margin-bottom: 10px;">❌</div>
                            <div style="font-size: 1.1em;">No skills found for "${query}"</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">Try a different search term</div>
                        </div>
                    `;
                    const statusEl = document.getElementById('skillManagementStatus');
                    if (statusEl) statusEl.textContent = 'No results';
                    return;
                }
                
                console.log('Rendering', safeResults.length, 'results');
                container.innerHTML = safeResults.map(skill => {
                    try {
                        const isAdded = isSkillAlreadyAdded(skill.n);
                        const categoryColor = getCategoryColor(skill.c);
                        
                        return `
                            <div class="skill-search-result ${isAdded ? 'added' : ''}" 
                                 style="padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid ${categoryColor}; cursor: ${isAdded ? 'default' : 'pointer'}; transition: all 0.2s;"
                                 ${isAdded ? '' : `onclick="addSkillFromLibrary('${skill.id}')"`}
                                 onmouseover="if (!this.classList.contains('added')) this.style.background='rgba(255,255,255,0.06)'"
                                 onmouseout="if (!this.classList.contains('added')) this.style.background='rgba(255,255,255,0.03)'">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="color: #e0e0e0; font-weight: 600; margin-bottom: 4px;">
                                            ${skill.n}
                                            ${isAdded ? '<span style="color: #10b981; font-size: 0.85em; margin-left: 8px;">✓ Already have</span>' : ''}
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <span style="color: ${categoryColor}; font-size: 0.75em; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                                ${skill.c}
                                            </span>
                                            ${skill.sc ? `
                                                <span style="color: #9ca3af; font-size: 0.75em;">
                                                    ${skill.sc}
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${!isAdded ? `
                                        <button style="padding: 6px 12px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; border-radius: 6px; color: white; font-size: 0.85em; font-weight: 600; cursor: pointer;"
                                                onclick="event.stopPropagation(); addSkillFromLibrary('${skill.id}')">
                                            + Add
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    } catch (skillError) {
                        console.error('Error rendering skill:', skill, skillError);
                        return '';
                    }
                }).filter(Boolean).join('');
                
                const statusEl = document.getElementById('skillManagementStatus');
                if (statusEl) {
                    statusEl.textContent = `Found ${safeResults.length} skill${safeResults.length > 1 ? 's' : ''}`;
                }
                
                
            } catch (error) {
                console.error('=== CRITICAL ERROR in performAddSkillsSearch ===');
                console.error('Error:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                const container = document.getElementById('addSkillsResults');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #ef4444;">
                            <div style="font-size: 3em; margin-bottom: 10px;">⚠️</div>
                            <div style="font-size: 1.1em; font-weight: bold;">Search Error</div>
                            <div style="font-size: 0.9em; margin-top: 10px; font-family: monospace;">
                                ${error.message}
                            </div>
                            <div style="font-size: 0.85em; margin-top: 10px; color: #9ca3af;">
                                Check browser console (F12) for details
                            </div>
                        </div>
                    `;
                }
                
                showToast('Search error: ' + error.message, 'error');
            }
        }

        function searchAddSkillsByCategory(category) {
            if (category === 'Trades') {
                var categoriesDiv = document.getElementById('addSkillsCategories');
                if (categoriesDiv) categoriesDiv.style.display = 'none';
                var container = document.getElementById('addSkillsResults');
                if (!container) return;
                var tradeResults = [];
                if (window.tradesCreativeLibrary && window.tradesCreativeLibrary.categories) {
                    Object.values(window.tradesCreativeLibrary.categories).forEach(function(cat) {
                        (cat.skills || []).forEach(function(skill) {
                            tradeResults.push({ id: skill.id, n: skill.name, c: cat.name, sc: 'Trades & Creative', definition: skill.definition || '', source: 'trades', category: 'trades' });
                        });
                    });
                }
                if (tradeResults.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:30px;color:#9ca3af;">Trades library not loaded yet.</div>';
                    return;
                }
                var catColors = {'Woodworking & Construction':'#d97706','Electrical/Plumbing/Mechanical':'#0891b2','Painting & Finishing':'#7c3aed','Culinary Arts':'#dc2626','Visual Arts':'#db2777','Fiber & Textile':'#059669','Performing Arts':'#ea580c','Outdoor & Agriculture':'#16a34a','Technology & Making':'#2563eb'};
                container.innerHTML = tradeResults.map(function(skill) {
                    var isAdded = isSkillAlreadyAdded(skill.n);
                    var color = catColors[skill.c] || '#d97706';
                    return '<div style="padding:12px;margin-bottom:8px;background:rgba(255,255,255,0.03);border-radius:8px;border-left:3px solid '+color+';cursor:'+(isAdded?'default':'pointer')+';" '+(isAdded?'':'onclick="addSkillFromLibrary(\'' + skill.id + '\')"')+'>'
                        +'<div style="display:flex;justify-content:space-between;align-items:start;">'
                        +'<div style="flex:1;"><div style="color:#e0e0e0;font-weight:600;margin-bottom:4px;">'+skill.n+(isAdded?' <span style="color:#10b981;font-size:0.85em;">✓ Added</span>':'')+'</div>'
                        +'<span style="color:'+color+';font-size:0.75em;padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:3px;">'+skill.c+'</span></div>'
                        +(!isAdded?'<button style="padding:6px 12px;background:linear-gradient(135deg,#60a5fa,#3b82f6);border:none;border-radius:6px;color:white;font-size:0.85em;font-weight:600;cursor:pointer;" onclick="event.stopPropagation();addSkillFromLibrary(\'' + skill.id + '\')">+ Add</button>':'')
                        +'</div></div>';
                }).join('');
                var statusEl = document.getElementById('skillManagementStatus');
                if (statusEl) statusEl.textContent = 'Showing ' + tradeResults.length + ' Trade Skills';
                return;
            }
            document.getElementById('addSkillsSearchInput').value = category;
            handleAddSkillsSearch();
        }

        function addSkillFromLibrary(skillId) {
            // Find the skill across all libraries
            let skillName = null, category = 'skill', definition = '';
            
            // Check ESCO index
            if (skillLibraryIndex && skillLibraryIndex.index) {
                const found = skillLibraryIndex.index.find(s => s.id === skillId);
                if (found) {
                    skillName = found.n;
                    const sc = (found.sc || '').toLowerCase();
                    const cat = (found.c || '').toLowerCase();
                    if (cat === 'work styles' || sc.includes('work style')) category = 'workstyle';
                    else if (['transversal skills','language skills','cognitive abilities','sensory abilities','physical abilities','psychomotor abilities'].includes(cat)) category = 'ability';
                    else category = 'skill';
                }
            }
            
            // Check trades library
            if (!skillName && window.tradesCreativeLibrary && window.tradesCreativeLibrary.categories) {
                outer: for (const cat of Object.values(window.tradesCreativeLibrary.categories)) {
                    for (const skill of (cat.skills || [])) {
                        if (skill.id === skillId) {
                            skillName = skill.name;
                            category = 'trades';
                            definition = skill.definition || '';
                            break outer;
                        }
                    }
                }
            }
            
            // Check O*NET libraries by code
            if (!skillName) {
                const onetSources = [
                    { lib: window.onetKnowledgeLibrary?.knowledge, cat: 'knowledge', nameField: 'name', idField: 'onetCode' },
                    { lib: window.onetWorkActivitiesLibrary?.activities, cat: 'workactivity', nameField: 'name', idField: 'onetCode' },
                    { lib: window.onetAbilitiesLibrary?.abilities, cat: 'ability', nameField: 'name', idField: 'id' },
                    { lib: window.onetWorkStylesLibrary?.workStyles, cat: 'workstyle', nameField: 'name', idField: 'id' },
                ];
                for (const src of onetSources) {
                    if (!src.lib) continue;
                    const found = src.lib.find(s => (s[src.idField] || s.id || s.onetCode) === skillId);
                    if (found) {
                        skillName = found.name;
                        category = src.cat;
                        definition = found.definition || found.description || '';
                        break;
                    }
                }
            }
            
            if (!skillName) { console.warn('Skill not found for id:', skillId); return; }
            if (isSkillAlreadyAdded(skillName)) return;
            
            const newSkill = {
                name: skillName,
                category: category,
                level: 'Advanced',
                roles: [userData.roles[0]?.id || 'default'],
                key: false,
                evidence: [],
                source: 'library',
                libraryId: skillId
            };
            
            userData.skills.push(newSkill);
            skillsData.skills.push(newSkill);
            
            saveUserData();
            populateCategoryFilter();
            updateSkillManagementCounts();
            refreshAllViews();
            
            const query = document.getElementById('addSkillsSearchInput').value;
            if (query) performAddSkillsSearch(query);
        }
        
        // ===== OVERFLOW MENU FUNCTIONS =====
        
        // ===== THEME TOGGLE =====
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') !== 'light';
            html.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeToggleBtn').textContent = isDark ? '☀️' : '🌙';
            localStorage.setItem('wbTheme', isDark ? 'light' : 'dark');
            
            // Re-render current view so tv()/tb() inline styles pick up new theme
            if (typeof currentView !== 'undefined' && currentView) {
                if (currentView === 'network' || currentView === 'skills') {
                    if (typeof initCardView === 'function' && currentSkillsView === 'card') {
                        initCardView();
                    }
                    // Network SVG uses CSS variables, no re-render needed
                } else if (currentView === 'blueprint' && typeof renderBlueprint === 'function') {
                    renderBlueprint();
                } else if (currentView === 'consent' && typeof initConsent === 'function') {
                    initConsent();
                } else if (currentView === 'settings' && typeof initSettings === 'function') {
                    initSettings();
                } else if (currentView === 'jobs' && typeof initOpportunities === 'function') {
                    initOpportunities();
                } else if (currentView === 'applications' && typeof initApplications === 'function') {
                    initApplications();
                }
            }
        }
        window.toggleTheme = toggleTheme;

        function initTheme() {
            const saved = localStorage.getItem('wbTheme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            const btn = document.getElementById('themeToggleBtn');
            if (btn) btn.textContent = saved === 'light' ? '☀️' : '🌙';
        }
        window.initTheme = initTheme;

        // ===== PROFILE DROPDOWN =====
        var _profileDropdownClosing = false;
        function toggleProfileDropdown(event) {
            event.stopPropagation();
            if (_profileDropdownClosing) return;
            var dropdown = document.getElementById('profileDropdown');
            var options = document.getElementById('profileDropdownOptions');
            // If click came from inside the dropdown options, don't toggle (let the option's own onclick handle it)
            if (options && options.contains(event.target)) return;
            dropdown.classList.toggle('open');
        }
        window.toggleProfileDropdown = toggleProfileDropdown;

        function closeProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) dropdown.classList.remove('open');
            // Brief flag to prevent the bubbling click from re-opening
            _profileDropdownClosing = true;
            setTimeout(function() { _profileDropdownClosing = false; }, 100);
        }
        window.closeProfileDropdown = closeProfileDropdown;

        function buildProfileDropdown(profiles, currentId) {
            const container = document.getElementById('profileDropdownOptions');
            if (!container) return;
            container.innerHTML = profiles.map(p => {
                const initials = p.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
                const isActive = p.id === currentId;
                return `<div class="profile-option ${isActive ? 'active-profile' : ''}" onclick="switchProfile('${p.id}'); closeProfileDropdown();">
                    <div class="profile-option-avatar">${initials}</div>
                    <div class="profile-option-info">
                        <div class="profile-option-name">${p.name}</div>
                        <div class="profile-option-title">${p.title || ''}</div>
                    </div>
                    ${isActive ? '<span class="profile-option-check">✓</span>' : ''}
                </div>`;
            }).join('');
        }

        function updateProfileChip(name) {
            const initials = name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
            const avatar = document.getElementById('profileAvatar');
            const chipName = document.getElementById('profileChipName');
            if (avatar) avatar.textContent = initials;
            if (chipName) chipName.textContent = name;
            document.title = name + ' \u2014 Blueprint\u2122';
        }

        // ===== FILTER PANEL TOGGLE =====
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const btn = document.getElementById('filterToggleBtn');
            const isOpen = panel.classList.toggle('open');
            btn.classList.toggle('active', isOpen);
        }

        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            // Close overflow menu
            const menu = document.getElementById('overflowMenu');
            const moreBtn = document.getElementById('overflowMenuBtn');
            if (menu && moreBtn && menu.style.display === 'block') {
                if (!menu.contains(e.target) && !moreBtn.contains(e.target)) closeOverflowMenu();
            }
            // Close profile dropdown
            const chip = document.getElementById('profileChip');
            if (chip && !chip.contains(e.target)) closeProfileDropdown();
        });

        function toggleOverflowMenu(event) {
            if (event) {
                event.stopPropagation();
            }
            
            const menu = document.getElementById('overflowMenu');
            const btn = document.getElementById('overflowMenuBtn');
            const isVisible = menu.style.display === 'block';
            
            if (isVisible) {
                menu.style.display = 'none';
                btn.classList.remove('active');
            } else {
                menu.style.display = 'block';
                btn.classList.add('active');
            }
        }
        
        function closeOverflowMenu() {
            const menu = document.getElementById('overflowMenu');
            const btn = document.getElementById('overflowMenuBtn');
            if (menu) menu.style.display = 'none';
            if (btn) btn.classList.remove('active');
        }
        
        function showHelp() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">How to Use Blueprint</h2>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">🗺️</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Skills Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">View your full skill network as an interactive graph or card view. Click any skill to see your evidence and outcomes. Use the role and level filters to explore different facets of your profile.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">💼</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Jobs Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">Find opportunities matched to your actual skill profile. Skills you have are highlighted green; gaps shown in red. Generate a personalized outreach message for any role.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">📋</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Applications Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">Track every role you've applied to. Log status, salary targets, contacts and notes. Keep your job search organized in one place.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">📊</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Blueprint Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">See your market valuation, manage your outcomes, choose your values, and write your purpose statement. This is your source of truth. Export as a resume or personalized page to share with recruiters.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">⚙️</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Settings (More menu)</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">Update your profile info, preferences, and manage your skills. Export your full profile as JSON to save your work or move it to another device.</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function showAbout() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Blueprint</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">v4.6.0 · Your career, fully represented</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <p style="color: #d1d5db; line-height: 1.8; margin-bottom: 20px;">
                        Most people underrepresent themselves when applying for work — not because they lack ability, 
                        but because they lack the tools to articulate it. Blueprint changes that.
                    </p>
                    <p style="color: #d1d5db; line-height: 1.8; margin-bottom: 20px;">
                        This tool guides you through fully discovering and documenting your skills, evidence, outcomes, 
                        values and purpose — then shows you what that profile is worth in the market. Export it as a 
                        traditional resume for ATS systems, or as a personalized interactive page for the humans 
                        making the actual hiring decision.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                        <div style="background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">🗺️ Skills Ontology</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">Map your full skill landscape — O*NET standard skills, abilities, work styles, and unique differentiators.</div>
                        </div>
                        <div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #10b981; font-weight: 600; margin-bottom: 8px;">💰 Market Valuation</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">See what your specific skill portfolio is worth — with negotiation ranges, not just a single number.</div>
                        </div>
                        <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 8px;">📊 Blueprint</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">Build your complete professional narrative — outcomes, values, purpose — with full control over what you share.</div>
                        </div>
                        <div style="background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #a78bfa; font-weight: 600; margin-bottom: 8px;">🔗 Personalized Outreach</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">Generate a company-specific page and recruiter email — one link that tells your story their way.</div>
                        </div>
                    </div>
                    <p style="color: #6b7280; font-size: 0.85em; text-align: center;">Free to explore · Sign in to save your profile · Your data stays yours</p>
                </div>
            `;
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function showLegalNotice() {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Legal &amp; Intellectual Property Notice</h2>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">&times;</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:28px; color:var(--text-secondary); line-height:1.8; font-size:0.9em;">'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">Trademark</h3>'
                + '<p style="margin-bottom:20px;">Blueprint&trade; is a trademark of Cliff Jurkiewicz. '
                + 'The Blueprint name, logo, network mark, and associated visual identity are the property of Cliff Jurkiewicz. '
                + 'Unauthorized use of the Blueprint name or mark is prohibited.</p>'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">Copyright</h3>'
                + '<p style="margin-bottom:20px;">&copy; ' + new Date().getFullYear() + ' Cliff Jurkiewicz. All rights reserved. '
                + 'The Blueprint software, including its source code, user interface design, visual assets, and documentation, '
                + 'is the copyrighted work of Cliff Jurkiewicz. No portion of this software may be reproduced, distributed, '
                + 'or transmitted in any form without prior written permission.</p>'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">Intellectual Property</h3>'
                + '<p style="margin-bottom:20px;">The following are original methodologies and intellectual property of Cliff Jurkiewicz:</p>'
                + '<div style="margin-bottom:20px; padding:16px; background:' + tv('rgba(96,165,250,0.06)','rgba(96,165,250,0.08)') + '; border:1px solid ' + tv('rgba(96,165,250,0.15)','rgba(96,165,250,0.2)') + '; border-radius:8px;">'
                + '<div style="margin-bottom:8px;"><strong style="color:var(--text-primary);">Blueprint Ontology System</strong> &mdash; The professional skill ontology architecture, role-cluster mapping methodology, and 90-skill framework integrating O*NET occupational data with individualized career modeling.</div>'
                + '<div style="margin-bottom:8px;"><strong style="color:var(--text-primary);">Match Algorithm</strong> &mdash; The weighted skill-matching engine including fuzzy word-overlap scoring, requirement-level classification, and proficiency-weighted gap analysis.</div>'
                + '<div style="margin-bottom:8px;"><strong style="color:var(--text-primary);">Network Visualization</strong> &mdash; The force-directed ontology visualization system including the match overlay methodology for displaying skill alignment between professional profiles and job requirements.</div>'
                + '<div><strong style="color:var(--text-primary);">Proprietary Frameworks</strong> &mdash; Including but not limited to: human-in-the-lead (vs. human-in-the-loop), candidate experience architecture, and AI fluency models.</div>'
                + '</div>'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">Third-Party Data</h3>'
                + '<p style="margin-bottom:20px;">Blueprint incorporates data from the O*NET program (U.S. Department of Labor) and the ESCO classification (European Commission). '
                + 'These datasets are used under their respective open-access terms. Their inclusion does not imply endorsement by these organizations.</p>'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">User Data</h3>'
                + '<p>Users retain ownership of their personal data entered into Blueprint. Blueprint does not sell, share, or monetize user data. '
                + 'Profile data is stored locally in the browser and, when authenticated, encrypted in cloud storage accessible only to the account holder.</p>'
                + '</div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.showLegalNotice = showLegalNotice;
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('overflowMenu');
            const btn = document.getElementById('overflowMenuBtn');
            if (menu && btn && menu.style.display === 'block') {
                if (!menu.contains(event.target) && !btn.contains(event.target)) {
                    closeOverflowMenu();
                }
            }
        });
        
        // ===== BULK OPERATIONS =====
        
        let bulkSelectionMode = false;
        let selectedSkills = [];
        
        
        
        function selectAllSkills() {
            selectedSkills = userData.skills.map(s => s.name);
            refreshSkillsList();
        }
        
        
        function updateBulkModeBar() {
            const bar = document.getElementById('bulkModeBar');
            if (bar) {
                const count = selectedSkills.length;
                bar.querySelector('.selected-count').textContent = `${count} selected`;
            }
        }
        
        
        
        
        
        // ===== SKILL TEMPLATES =====
        
        
        
        
        // ===== SORTING =====
        
        let currentSort = 'category'; // category, proficiency, alphabetical, role, core, recent
        
        
        
        // Resize handler
        var _resizeTimer = null;
        window.addEventListener('resize', function() {
            clearTimeout(_resizeTimer);
            _resizeTimer = setTimeout(function() {
                if (currentView === 'network' && currentSkillsView === 'network') {
                    window.networkInitialized = false;
                    initNetwork();
                    window.networkInitialized = true;
                }
            }, 250);
        });

        // C2: Browser back button navigation
        window.addEventListener('popstate', function(e) {
            // Close any open modals first
            var openModal = document.querySelector('.modal.active');
            if (openModal) {
                openModal.classList.remove('active');
                return;
            }
            var view = (e.state && e.state.view) ? e.state.view : 'welcome';
            _skipHistoryPush = true;
            switchView(view);
            _skipHistoryPush = false;
        });
    </script>
</body>
</html>