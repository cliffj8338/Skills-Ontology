<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueprint™</title>
    <!-- v4.22.0 | 20260220 | SVG icon system completion, Outfit font + uppercase titles, mobile network fixes, role info card fix -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ===== THEME VARIABLES ===== */
        :root {
            /* Dark theme (default) */
            --bg-base:        #0f0f1e;
            --bg-surface:     #1a1a2e;
            --bg-elevated:    rgba(26,26,46,0.8);
            --bg-card:        rgba(26,26,46,0.6);
            --border:         rgba(96,165,250,0.2);
            --border-strong:  rgba(96,165,250,0.4);
            --text-primary:   #e0e0e0;
            --text-secondary: #9ca3af;
            --text-muted:     #6b7280;
            --accent:         #60a5fa;
            --accent-glow:    rgba(96,165,250,0.15);
            --nav-bg:         rgba(15,15,30,0.95);
            --nav-border:     rgba(96,165,250,0.15);
            --filter-bg:      rgba(15,15,30,0.92);
            --filter-border:  rgba(96,165,250,0.12);
            --chip-bg:        rgba(96,165,250,0.1);
            --chip-hover:     rgba(96,165,250,0.2);
            --input-bg:       rgba(255,255,255,0.05);
            --shadow:         0 8px 32px rgba(0,0,0,0.4);
            --success:        #10b981;
            --warning:        #f59e0b;
            --danger:         #ef4444;
        }

        [data-theme="light"] {
            --bg-base:        #f0f4f8;
            --bg-surface:     #ffffff;
            --bg-elevated:    rgba(255,255,255,0.95);
            --bg-card:        rgba(255,255,255,0.85);
            --border:         rgba(59,130,246,0.2);
            --border-strong:  rgba(59,130,246,0.4);
            --text-primary:   #1e293b;
            --text-secondary: #475569;
            --text-muted:     #94a3b8;
            --accent:         #2563eb;
            --accent-glow:    rgba(37,99,235,0.1);
            --nav-bg:         rgba(255,255,255,0.97);
            --nav-border:     rgba(59,130,246,0.15);
            --filter-bg:      rgba(248,250,252,0.97);
            --filter-border:  rgba(59,130,246,0.1);
            --chip-bg:        rgba(37,99,235,0.08);
            --chip-hover:     rgba(37,99,235,0.15);
            --input-bg:       rgba(0,0,0,0.04);
            --shadow:         0 8px 32px rgba(0,0,0,0.12);
            --success:        #059669;
            --warning:        #d97706;
            --danger:         #dc2626;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        [data-theme="light"] body,
        [data-theme="light"] {
            background: linear-gradient(135deg, #e8f0fe 0%, #f0f4f8 100%);
        }

        /* ===== LIGHT THEME COMPONENT OVERRIDES ===== */

        /* Cards & surfaces */
        [data-theme="light"] .domain-card {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        [data-theme="light"] .domain-card:hover {
            border-color: rgba(37,99,235,0.35);
            box-shadow: 0 4px 16px rgba(37,99,235,0.1);
        }
        [data-theme="light"] .domain-title { color: #2563eb; }
        [data-theme="light"] .skill-item {
            background: rgba(0,0,0,0.02);
        }
        [data-theme="light"] .skill-item:hover { background: rgba(37,99,235,0.04); }
        [data-theme="light"] .skill-name { color: #1e293b; }

        /* Opportunity cards */
        [data-theme="light"] .opportunity-card {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        [data-theme="light"] .opportunity-card:hover {
            border-color: rgba(37,99,235,0.4);
            box-shadow: 0 4px 16px rgba(37,99,235,0.1);
        }
        [data-theme="light"] .opportunity-title { color: #1e293b; }
        [data-theme="light"] .opportunity-company { color: #64748b; }

        /* Application cards */
        [data-theme="light"] .application-card {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        [data-theme="light"] .application-meta-value { color: #1e293b; }
        [data-theme="light"] .application-notes {
            background: rgba(37,99,235,0.04);
            color: #475569;
        }
        [data-theme="light"] .application-btn {
            background: rgba(37,99,235,0.08);
            border-color: rgba(37,99,235,0.25);
            color: #2563eb;
        }

        /* Blueprint sections */
        [data-theme="light"] .blueprint-section {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        [data-theme="light"] .outcome-item {
            background: rgba(0,0,0,0.02);
            border-color: rgba(59,130,246,0.15);
        }
        [data-theme="light"] .outcome-item:hover {
            background: rgba(37,99,235,0.04);
            border-color: rgba(37,99,235,0.3);
        }
        [data-theme="light"] .outcome-text { color: #1e293b; }
        [data-theme="light"] .value-card {
            background: #ffffff;
            border-color: rgba(59,130,246,0.2);
        }
        [data-theme="light"] .value-title { color: #1e293b; }
        [data-theme="light"] .value-description { color: #64748b; }
        [data-theme="light"] .coaching-tip {
            background: linear-gradient(135deg, rgba(245,158,11,0.08) 0%, rgba(251,191,36,0.06) 100%);
        }
        [data-theme="light"] .coaching-tip-content { color: #475569; }
        [data-theme="light"] .purpose-editor {
            background: rgba(0,0,0,0.03);
            border-color: rgba(59,130,246,0.25);
            color: #1e293b;
        }
        [data-theme="light"] .purpose-editor:focus {
            background: rgba(37,99,235,0.04);
        }
        [data-theme="light"] .reflection-prompts {
            background: rgba(139,92,246,0.06);
            border-color: rgba(139,92,246,0.2);
        }
        [data-theme="light"] .reflection-prompts li { color: #475569; }

        /* Modal */
        [data-theme="light"] .modal-content {
            background: #ffffff;
            border-color: rgba(59,130,246,0.2);
        }
        [data-theme="light"] .modal-header {
            background: rgba(248,250,252,0.98);
            border-bottom-color: rgba(59,130,246,0.12);
        }
        [data-theme="light"] .modal-title { color: #2563eb; }
        [data-theme="light"] .modal-years { color: #64748b; }
        [data-theme="light"] .evidence-item {
            background: rgba(37,99,235,0.04);
            border-left-color: #2563eb;
            color: #1e293b;
        }
        [data-theme="light"] .story-text {
            background: rgba(0,0,0,0.03);
            color: #334155;
        }

        /* Tooltip */
        [data-theme="light"] .tooltip {
            background: rgba(255,255,255,0.98);
            border-color: rgba(37,99,235,0.3);
            color: #1e293b;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        [data-theme="light"] .tooltip-title { color: #2563eb; }
        [data-theme="light"] .tooltip-roles { color: #475569; }
        [data-theme="light"] .tooltip-role-tag { background: rgba(37,99,235,0.1); }

        /* Settings & forms */
        [data-theme="light"] .settings-input,
        [data-theme="light"] .settings-select {
            background: rgba(0,0,0,0.04);
            border-color: rgba(59,130,246,0.25);
            color: #1e293b;
        }
        [data-theme="light"] .settings-input:focus,
        [data-theme="light"] .settings-select:focus {
            border-color: #2563eb;
            background: rgba(37,99,235,0.04);
        }
        [data-theme="light"] .your-skill-item {
            background: rgba(0,0,0,0.02);
            border-left-color: #2563eb;
        }
        [data-theme="light"] .your-skill-item:hover { background: rgba(37,99,235,0.05); }
        [data-theme="light"] .onet-skill-item {
            background: rgba(0,0,0,0.02);
            border-color: rgba(59,130,246,0.15);
        }
        [data-theme="light"] .onet-skill-item:hover:not(.disabled) {
            background: rgba(37,99,235,0.05);
            border-color: rgba(37,99,235,0.3);
        }
        [data-theme="light"] .onet-skill-name { color: #1e293b; }
        [data-theme="light"] .onet-skill-definition { color: #64748b; }

        /* Action buttons */
        [data-theme="light"] .action-btn {
            background: rgba(37,99,235,0.07);
            border-color: rgba(37,99,235,0.25);
            color: #2563eb;
        }
        [data-theme="light"] .action-btn:hover {
            background: rgba(37,99,235,0.14);
            border-color: rgba(37,99,235,0.4);
        }

        /* Opportunities filter bar */
        [data-theme="light"] .opportunities-filters {
            background: #ffffff;
            border-color: rgba(59,130,246,0.15);
        }

        /* Network SVG background */
        [data-theme="light"] #networkView {
            background: linear-gradient(135deg, #e8f0fe 0%, #f0f4f8 100%);
        }

        /* General text in content areas */
        [data-theme="light"] .blueprint-tagline { color: #475569; }
        [data-theme="light"] .blueprint-subtitle { color: #64748b; }
        [data-theme="light"] .section-count {
            background: rgba(37,99,235,0.1);
            color: #2563eb;
        }
        [data-theme="light"] .meta-tag.category {
            background: rgba(37,99,235,0.1);
            color: #2563eb;
        }
        [data-theme="light"] .meta-tag.evidence {
            background: rgba(5,150,105,0.1);
            color: #059669;
        }
        [data-theme="light"] .skill-badge {
            background: rgba(217,119,6,0.12);
            color: #b45309;
        }
        /* General content text colors in light mode */
        [data-theme="light"] .matched-skills-title { color: #2563eb; }
        [data-theme="light"] .filter-section-label { color: #2563eb; }
        [data-theme="light"] .opportunities-title { color: #2563eb; }
        [data-theme="light"] .opportunities-subtitle { color: #64748b; }
        [data-theme="light"] .match-label { color: #94a3b8; }
        [data-theme="light"] .meta-item { color: #64748b; }
        [data-theme="light"] .applications-header h1 { color: #1e293b; }
        [data-theme="light"] .modal-section-title { color: #2563eb; }
        [data-theme="light"] .roles-tags .role-tag {
            background: rgba(37,99,235,0.08);
            border-color: rgba(37,99,235,0.2);
            color: #1e293b;
        }
        [data-theme="light"] .related-skill-chip {
            background: rgba(220,38,38,0.06);
            border-color: rgba(220,38,38,0.2);
            color: #dc2626;
        }
        [data-theme="light"] .outcome-coaching {
            background: rgba(245,158,11,0.08);
            color: #b45309;
        }
        [data-theme="light"] .outcome-btn {
            background: rgba(37,99,235,0.07);
            border-color: rgba(37,99,235,0.25);
            color: #2563eb;
        }
        [data-theme="light"] .add-outcome-btn {
            background: rgba(37,99,235,0.04);
            border-color: rgba(37,99,235,0.25);
            color: #2563eb;
        }
        [data-theme="light"] .export-section {
            background: linear-gradient(135deg, rgba(220,38,38,0.06) 0%, rgba(185,28,28,0.06) 100%);
            border-color: rgba(220,38,38,0.2);
        }

        /* Network node labels readable on light background */
        [data-theme="light"] .node text {
            fill: #1e293b;
            text-shadow: 0 0 5px #e8f0fe, 0 0 5px #e8f0fe, 0 0 5px #e8f0fe;
        }
        [data-theme="light"] .node.role text {
            fill: #1e293b;
            text-shadow: 0 0 5px #e8f0fe, 0 0 5px #e8f0fe;
        }
        [data-theme="light"] .node.center text {
            fill: #2563eb;
            text-shadow: 0 0 6px #e8f0fe, 0 0 6px #e8f0fe;
        }
        [data-theme="light"] .node.skill text { fill: #334155; }
        [data-theme="light"] .link { stroke: #94a3b8; }

        /* Settings view panels */
        [data-theme="light"] .settings-tabs,
        [data-theme="light"] .skills-view-tabs,
        [data-theme="light"] .skill-mgmt-content { 
            background: rgba(0,0,0,0.03);
        }
        [data-theme="light"] .settings-tab,
        [data-theme="light"] .skills-tab,
        [data-theme="light"] .skill-mgmt-tab { color: #64748b; }
        [data-theme="light"] .settings-tab:hover,
        [data-theme="light"] .skills-tab:hover { background: rgba(37,99,235,0.06); color: #1e293b; }
        [data-theme="light"] .quick-action-bar .btn-secondary {
            background: rgba(0,0,0,0.05);
            border-color: rgba(0,0,0,0.12);
            color: #475569;
        }
        
        /* ===== NAV BAR ===== */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--nav-bg);
            border-bottom: 1px solid var(--nav-border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .header-logo {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .header-left h1 {
            color: var(--accent);
            font-family: 'Outfit', sans-serif;
            font-size: 0.82em;
            font-weight: 500;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            margin: 0;
            white-space: nowrap;
        }

        .header-left h1 span {
            color: var(--accent);
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 2px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 7px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-size: 0.72em;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            transition: all 0.18s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover {
            background: var(--chip-bg);
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 2px 8px rgba(96,165,250,0.3);
        }

        [data-theme="light"] .nav-btn.active {
            box-shadow: 0 2px 8px rgba(37,99,235,0.25);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        /* Theme toggle */
        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        /* Profile switcher */
        .profile-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px 6px 6px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .profile-chip:hover {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .profile-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #818cf8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }

        .profile-name {
            font-size: 0.82em;
            font-weight: 600;
            color: var(--text-primary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .profile-caret {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Profile dropdown */
        .profile-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 220px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 8px;
            display: none;
            z-index: 200;
            backdrop-filter: blur(20px);
        }

        .profile-dropdown.open {
            display: block;
            animation: dropIn 0.15s ease;
        }

        @keyframes dropIn {
            from { opacity: 0; transform: translateY(-6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .profile-dropdown-label {
            font-size: 0.72em;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            padding: 4px 8px 8px;
        }

        .profile-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .profile-option:hover {
            background: var(--chip-bg);
        }

        .profile-option.active-profile {
            background: var(--accent-glow);
        }

        .profile-option-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, #818cf8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
        }

        .profile-option-info { flex: 1; overflow: hidden; }
        .profile-option-name {
            font-size: 0.88em;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .profile-option-title {
            font-size: 0.75em;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-option-check {
            color: var(--accent);
            font-size: 12px;
        }

        /* More menu button */
        .more-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.2s;
            letter-spacing: -1px;
        }

        .more-btn:hover, .more-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }
        
        #statsBar {
            display: inline-flex;
            gap: 15px;
            align-items: center;
        }
        
        .stat-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        #consentView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #settingsView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #applicationsView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        .applications-header {
            margin-bottom: 30px;
        }
        
        .applications-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .application-card {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .application-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .application-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .status-applied {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .status-interviewing {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .status-offer {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-rejected {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }
        
        .application-title {
            font-size: 1.2em;
            color: #e0e0e0;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .application-company {
            color: #9ca3af;
            margin-bottom: 15px;
        }
        
        .application-meta-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
        }
        
        .application-meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .application-meta-label {
            font-size: 0.75em;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .application-meta-value {
            color: #e0e0e0;
            font-size: 0.95em;
        }
        
        .application-notes {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid rgba(96, 165, 250, 0.5);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #d1d5db;
            line-height: 1.5;
        }
        
        .application-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .application-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .application-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .application-btn.delete {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .application-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        .settings-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: inherit;
        }
        
        .settings-input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .settings-select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: inherit;
        }
        
        .settings-group {
            margin-bottom: 25px;
        }
        
        .settings-label {
            display: block;
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .settings-help {
            color: #9ca3af;
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            min-height: 45px;
        }
        
        .tag-chip {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tag-remove {
            cursor: pointer;
            color: #ef4444;
            font-weight: bold;
        }
        
        .save-settings-btn {
            width: 100%;
            padding: 15px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .save-settings-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        /* ===== CONTEXTUAL FILTER BAR ===== */
        .controls {
            background: var(--filter-bg);
            border-bottom: 1px solid var(--filter-border);
            padding: 8px 24px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: space-between;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            min-height: 48px;
        }

        .controls-left {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .filter-label {
            color: var(--text-muted);
            font-size: 0.75em;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* Collapsible filter panel */
        .filter-panel {
            display: none;
            width: 100%;
            padding: 10px 0 4px;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            animation: fadeIn 0.15s ease;
        }

        .filter-panel.open {
            display: flex;
        }

        .filter-toggle-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--chip-bg);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
            transition: all 0.18s;
        }

        .filter-toggle-btn:hover, .filter-toggle-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-glow);
        }

        /* Search input */
        .filter-search {
            padding: 5px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 0.85em;
            width: 200px;
            transition: all 0.2s;
            outline: none;
        }

        .filter-search:focus {
            border-color: var(--accent);
            background: var(--accent-glow);
            width: 240px;
        }

        .filter-search::placeholder {
            color: var(--text-muted);
        }

        /* View toggle pills */
        .view-pills {
            display: flex;
            gap: 2px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 3px;
        }

        .view-pill {
            padding: 4px 12px;
            border-radius: 5px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .view-pill.active {
            background: var(--accent);
            color: #fff;
        }

        /* Export button */
        .export-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239,68,68,0.3);
        }
        
        .role-chip {
            background: var(--chip-bg);
            border: 1px solid var(--border);
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.18s;
            font-size: 0.8em;
            color: var(--text-secondary);
        }

        .role-chip:hover {
            background: var(--chip-hover);
            border-color: var(--border-strong);
            color: var(--text-primary);
        }

        .role-chip.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }
        
        .level-filter {
            display: flex;
            gap: 8px;
        }
        
        .level-chip {
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            border: 1px solid transparent;
        }
        
        .level-chip.mastery {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .level-chip.mastery.active {
            background: #ef4444;
            color: #fff;
        }
        
        .level-chip.advanced {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .level-chip.advanced.active {
            background: #f59e0b;
            color: #fff;
        }
        
        .level-chip.proficient {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .level-chip.proficient.active {
            background: #10b981;
            color: #fff;
        }
        
        .level-chip.expert {
            background: rgba(249, 115, 22, 0.2);
            border-color: rgba(249, 115, 22, 0.3);
        }
        
        .level-chip.expert.active {
            background: #f97316;
            color: #fff;
        }
        
        .level-chip.novice {
            background: rgba(107, 114, 128, 0.2);
            border-color: rgba(107, 114, 128, 0.3);
        }
        
        .level-chip.novice.active {
            background: #6b7280;
            color: #fff;
        }
        
        .label-toggle {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(96, 165, 250, 0.3);
            transition: .3s;
            border-radius: 20px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #60a5fa;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .toggle-label {
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        .main-content {
            position: relative;
            height: calc(100vh - 56px);
        }

        /* When filter bar is visible (Skills tab), reduce height */
        .main-content.with-filters {
            height: calc(100vh - 56px - 48px);
        }
        
        #networkView {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #cardView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        #opportunitiesView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #blueprintView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
            background: var(--bg-base);
        }
        
        .blueprint-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .blueprint-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.3);
        }
        
        .blueprint-title {
            font-family: 'Outfit', sans-serif;
            font-size: 2.5em;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 10px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }
        
        .blueprint-subtitle {
            font-size: 1.2em;
            color: #9ca3af;
            margin-bottom: 20px;
        }
        
        .blueprint-tagline {
            font-size: 1em;
            color: #d1d5db;
            font-style: italic;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Blueprint Sub-Navigation */
        .blueprint-subnav {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.15);
            padding-bottom: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .bp-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 14px 12px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-muted);
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            margin-bottom: -2px;
        }
        
        .bp-tab:hover { color: var(--text-primary); }
        
        .bp-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }
        
        .bp-tab-icon { font-size: 1.1em; }
        
        .bp-tab-count {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            font-size: 0.75em;
            padding: 1px 6px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .bp-tab.active .bp-tab-count {
            background: rgba(96, 165, 250, 0.3);
        }
        
        [data-theme="light"] .bp-tab-count {
            background: rgba(37, 99, 235, 0.12);
            color: #2563eb;
        }

        .blueprint-section {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .blueprint-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        }
        
        .blueprint-section-title {
            font-size: 1.5em;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-icon {
            font-size: 1.3em;
        }
        
        .section-count {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
        }
        
        .coaching-tip {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            border-left: 4px solid #fbbf24;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        
        .coaching-tip-title {
            color: #fbbf24;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .coaching-tip-content {
            color: #d1d5db;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .coaching-tip-content ul {
            margin: 10px 0 0 20px;
        }
        
        .coaching-tip-content li {
            margin: 5px 0;
        }
        
        .outcome-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .outcome-item:hover {
            border-color: rgba(96, 165, 250, 0.4);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .outcome-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .outcome-text {
            flex: 1;
            font-size: 1.05em;
            color: #e0e0e0;
            line-height: 1.5;
        }
        
        .outcome-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .share-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .share-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .share-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(107, 114, 128, 0.3);
            transition: .3s;
            border-radius: 26px;
        }
        
        .share-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        .share-toggle input:checked + .share-toggle-slider {
            background-color: #10b981;
        }
        
        .share-toggle input:checked + .share-toggle-slider:before {
            transform: translateX(24px);
        }
        
        .outcome-meta {
            display: flex;
            gap: 15px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(96, 165, 250, 0.1);
            flex-wrap: wrap;
        }
        
        .meta-tag {
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .meta-tag.category {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .meta-tag.evidence {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .meta-tag.sensitive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .outcome-coaching {
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid #fbbf24;
            padding: 10px 15px;
            margin-top: 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #fbbf24;
        }
        
        .outcome-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .outcome-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .outcome-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .add-outcome-btn {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.05);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .add-outcome-btn:hover {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .reflection-prompts {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .reflection-title {
            color: #a78bfa;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 0.95em;
        }
        
        .reflection-prompts ul {
            list-style: none;
            padding: 0;
        }
        
        .reflection-prompts li {
            color: #d1d5db;
            padding: 8px 0;
            padding-left: 20px;
            position: relative;
            font-size: 0.9em;
        }
        
        .reflection-prompts li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: #a78bfa;
        }
        
        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .value-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(96, 165, 250, 0.2);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .value-card.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .value-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .value-title {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 5px;
        }
        
        .value-description {
            font-size: 0.85em;
            color: #9ca3af;
            line-height: 1.4;
        }
        
        .purpose-editor {
            width: 100%;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: #e0e0e0;
            font-size: 1em;
            line-height: 1.6;
            font-family: inherit;
            resize: vertical;
        }
        
        .purpose-editor:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .export-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        
        .export-title {
            color: #ef4444;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .export-btn-large {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: #ef4444;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn-large:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .opportunities-header {
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        
        .opportunities-title {
            font-family: 'Outfit', sans-serif;
            font-size: 2em;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 10px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }
        
        .opportunities-subtitle {
            color: #9ca3af;
            font-size: 1.1em;
            margin-bottom: 30px;
        }
        
        .opportunities-filters {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-section-label {
            color: #60a5fa;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .match-slider {
            width: 200px;
        }
        
        .match-value {
            color: #fbbf24;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .opportunity-card {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(26, 26, 46, 0.6) 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .opportunity-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .opportunity-company {
            font-size: 0.9em;
            color: #9ca3af;
            margin-bottom: 5px;
        }
        
        .opportunity-title {
            font-size: 1.2em;
            color: #e0e0e0;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .match-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .match-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            font-weight: bold;
            position: relative;
        }
        
        .match-circle.high {
            background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 3px solid #10b981;
            color: #10b981;
        }
        
        .match-circle.medium {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 3px solid #f59e0b;
            color: #f59e0b;
        }
        
        .match-circle.low {
            background: radial-gradient(circle, rgba(107, 114, 128, 0.2) 0%, rgba(107, 114, 128, 0.05) 100%);
            border: 3px solid #6b7280;
            color: #6b7280;
        }
        
        .match-label {
            font-size: 0.75em;
            color: #9ca3af;
            text-transform: uppercase;
        }
        
        .opportunity-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .matched-skills {
            margin-bottom: 15px;
        }
        
        .matched-skills-title {
            font-size: 0.85em;
            color: #60a5fa;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .skill-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .skill-chip-match {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        
        .skill-chip-gap {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        
        .opportunity-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(96, 165, 250, 0.1);
        }
        
        .action-btn {
            flex: 1;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .action-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(96, 165, 250, 0.2);
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Job Cart styles */
        .jobs-subtabs {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }
        .jobs-subtab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .jobs-subtab:hover { color: var(--text-secondary); }
        .jobs-subtab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .job-cart-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .job-cart-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }
        .job-cart-match { display:flex; align-items:center; gap:8px; }
        .job-cart-match-bar {
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            flex: 1;
            overflow: hidden;
        }
        .job-cart-match-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        .jd-skill-chip {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin: 2px;
        }
        .jd-chip-matched {
            background: rgba(16,185,129,0.15);
            border: 1px solid rgba(16,185,129,0.3);
            color: #10b981;
        }
        .jd-chip-gap {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.25);
            color: #ef4444;
        }
        .jd-chip-surplus {
            background: rgba(107,114,128,0.1);
            border: 1px solid rgba(107,114,128,0.2);
            color: #6b7280;
        }
        
        /* Network match overlay */
        .match-mode-toggle {
            display: inline-flex;
            gap: 0;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            margin-left: 8px;
        }
        .match-mode-btn {
            padding: 5px 14px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.78em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border-right: 1px solid var(--border);
        }
        .match-mode-btn:last-child { border-right: none; }
        .match-mode-btn:hover { color: var(--text-secondary); }
        .match-mode-btn.active {
            background: var(--accent);
            color: #fff;
        }
        .match-legend {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0;
            border-radius: 12px;
            background: rgba(15,15,30,0.92);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(96,165,250,0.2);
            z-index: 10;
            font-size: 0.82em;
            min-width: 260px;
            max-width: 320px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .job-info-tile {
            position: absolute;
            top: 16px;
            left: 16px;
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 14px 18px;
            border-radius: 12px;
            background: rgba(15,15,30,0.92);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(96,165,250,0.15);
            z-index: 10;
            font-size: 0.82em;
            min-width: 200px;
            max-width: 280px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        [data-theme="light"] .job-info-tile {
            background: rgba(255,255,255,0.95);
            border-color: rgba(0,0,0,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .jit-title {
            font-weight: 700;
            font-size: 1em;
            color: var(--text-primary);
            line-height: 1.3;
        }
        .jit-company {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .jit-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px 12px;
            margin-top: 10px;
            font-size: 0.88em;
            color: var(--text-secondary);
        }
        .jit-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .jit-salary {
            margin-top: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            background: rgba(167,139,250,0.08);
            border: 1px solid rgba(167,139,250,0.15);
        }
        [data-theme="light"] .jit-salary {
            background: rgba(167,139,250,0.06);
            border-color: rgba(167,139,250,0.12);
        }
        .jit-salary-range {
            font-weight: 700;
            font-size: 1.05em;
            color: #a78bfa;
        }
        .jit-salary-label {
            font-size: 0.78em;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .jit-source {
            margin-top: 8px;
            font-size: 0.78em;
        }
        .jit-source a {
            color: var(--accent);
            text-decoration: none;
        }
        .jit-source a:hover { text-decoration: underline; }
        [data-theme="light"] .match-legend {
            background: rgba(255,255,255,0.95);
            border-color: rgba(0,0,0,0.12);
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }
        .ml-header {
            padding: 14px 16px 10px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        [data-theme="light"] .ml-header {
            border-bottom-color: rgba(0,0,0,0.06);
        }
        .ml-title {
            font-weight: 700;
            font-size: 1.05em;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .ml-company {
            font-size: 0.88em;
            color: var(--text-muted);
        }
        .ml-score-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: rgba(96,165,250,0.06);
        }
        .ml-score-num {
            font-size: 1.8em;
            font-weight: 800;
            line-height: 1;
        }
        .ml-score-bar {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.08);
            overflow: hidden;
        }
        [data-theme="light"] .ml-score-bar { background: rgba(0,0,0,0.06); }
        .ml-score-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .ml-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0;
        }
        .ml-stat {
            text-align: center;
            padding: 10px 6px;
            border-right: 1px solid rgba(255,255,255,0.04);
        }
        [data-theme="light"] .ml-stat { border-right-color: rgba(0,0,0,0.04); }
        .ml-stat:last-child { border-right: none; }
        .ml-stat-num {
            font-size: 1.3em;
            font-weight: 700;
            line-height: 1.2;
        }
        .ml-stat-label {
            font-size: 0.72em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .ml-legend-row {
            display: flex;
            gap: 12px;
            padding: 8px 16px;
            flex-wrap: wrap;
        }
        .match-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-muted);
            font-size: 0.88em;
        }
        .match-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .ml-actions {
            display: flex;
            gap: 6px;
            padding: 8px 12px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        [data-theme="light"] .ml-actions { border-top-color: rgba(0,0,0,0.06); }
        .ml-action-btn {
            flex: 1;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.82em;
            text-align: center;
            transition: background 0.15s;
        }
        .ml-action-btn:hover { background: rgba(255,255,255,0.06); }
        [data-theme="light"] .ml-action-btn { border-color: rgba(0,0,0,0.1); }
        [data-theme="light"] .ml-action-btn:hover { background: rgba(0,0,0,0.04); }
        .match-active-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 6px;
            background: rgba(96,165,250,0.1);
            border: 1px solid rgba(96,165,250,0.25);
            font-size: 0.78em;
            color: var(--accent);
            margin-left: 8px;
        }
        .match-active-badge button {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 2px;
            line-height: 1;
        }
        .match-active-badge button:hover { color: #ef4444; }
        
        .cards-grid {
            column-count: 3;
            column-gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .domain-card {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(26, 26, 46, 0.6) 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            break-inside: avoid;
            margin-bottom: 20px;
        }
        
        .domain-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .domain-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        }
        
        .domain-icon {
            display: inline-flex;
            align-items: center;
            color: #60a5fa;
            opacity: 0.8;
        }
        
        .domain-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #60a5fa;
        }
        
        .skill-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid transparent;
            margin-bottom: 8px;
            flex-wrap: wrap;
            min-width: 0;
        }
        
        .skill-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .skill-name {
            flex: 1;
            font-size: 0.95em;
            min-width: 80px;
        }
        
        .skill-badge {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .skill-years {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .skill-impact-badge {
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* Mobile card view */
        @media (max-width: 768px) {
            .cards-grid {
                column-count: 1;
            }
            
            #cardView {
                padding: 12px;
            }
            
            .domain-card {
                padding: 14px;
            }
            
            .domain-title {
                font-size: 1.1em;
            }
            
            .skill-item {
                padding: 8px 10px;
                gap: 6px;
            }
            
            .skill-name {
                font-size: 0.9em;
                width: 100%;
                flex-basis: calc(100% - 22px);
            }
            
            /* On mobile, badges wrap below the skill name naturally */
            .skill-badge, .skill-years, .skill-impact-badge {
                font-size: 0.68em;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1200px) {
            .cards-grid {
                column-count: 2;
            }
        }
        
        /* Network styles */
        .node circle {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .node.dimmed circle {
            opacity: 0.2;
        }
        
        .node.highlighted circle {
            stroke-width: 4px;
            filter: brightness(1.3);
        }
        
        .node text {
            font-size: 11px;
            pointer-events: none;
            text-shadow: 0 0 4px #000, 0 0 4px #000, 0 0 4px #000;
            fill: #e0e0e0;
            display: block;
        }
        
        .node text.hidden {
            display: none;
        }
        
        .node.role text {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 768px) {
            .node.role text {
                font-size: 9px;
                letter-spacing: 0.3px;
            }
            .node.skill text {
                font-size: 8px;
            }
            .node text {
                text-shadow: 0 0 5px #000, 0 0 5px #000, 0 0 5px #000, 0 0 5px #000;
            }
        }
        
        .node.center text {
            font-size: 16px;
            font-weight: bold;
            fill: #60a5fa;
            text-shadow: 0 0 6px #000, 0 0 6px #000;
        }
        
        .node.skill text {
            font-size: 10px;
        }
        
        .link {
            stroke: #4a5568;
            stroke-opacity: 0.3;
            stroke-width: 1.5px;
            fill: none;
        }
        
        .link.dimmed {
            opacity: 0.1;
        }
        
        .link.highlighted {
            stroke: #60a5fa;
            stroke-opacity: 0.8;
            stroke-width: 2.5px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(26, 26, 46, 0.98);
            border: 1px solid #60a5fa;
            border-radius: 8px;
            padding: 15px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 350px;
            font-size: 13px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .tooltip-title {
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .tooltip-level {
            color: #fbbf24;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .tooltip-roles {
            color: #d1d5db;
            line-height: 1.6;
        }
        
        .tooltip-role-tag {
            display: inline-block;
            background: rgba(96, 165, 250, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            margin: 2px;
            font-size: 11px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a2e;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            padding: 0;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            width: 90%;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 30px 30px 20px 30px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(26, 26, 46, 0.6) 100%);
        }
        
        .modal-header-left {
            flex: 1;
        }
        
        .modal-title {
            font-size: 1.8em;
            color: #60a5fa;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .modal-subtitle {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .modal-level-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .modal-level-badge.mastery {
            background: #ef4444;
            color: #fff;
        }
        
        .modal-level-badge.advanced {
            background: #f59e0b;
            color: #fff;
        }
        
        .modal-level-badge.proficient {
            background: #10b981;
            color: #fff;
        }
        
        .modal-years {
            color: #9ca3af;
            font-size: 0.9em;
        }
        
        .modal-core-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
        }
        
        .modal-category-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: 600;
            border: 1px solid currentColor;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-section {
            margin-bottom: 30px;
        }
        
        .modal-section:last-child {
            margin-bottom: 0;
        }
        
        .modal-section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-section-icon {
            font-size: 1.2em;
        }
        
        .evidence-list {
            list-style: none;
            padding: 0;
        }
        
        .evidence-item {
            background: rgba(96, 165, 250, 0.05);
            border-left: 3px solid #60a5fa;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            line-height: 1.6;
        }
        
        .evidence-item strong {
            color: #60a5fa;
        }
        
        .story-text {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            line-height: 1.7;
            color: #d1d5db;
        }
        
        .roles-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .role-tag {
            background: rgba(96, 165, 250, 0.2);
            border: 1px solid rgba(96, 165, 250, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .related-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .related-skill-chip {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .related-skill-chip:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-2px);
        }
        
        .placeholder-text {
            color: #6b7280;
            font-style: italic;
            font-size: 0.9em;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .export-option {
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-option:hover {
            background: rgba(96, 165, 250, 0.2);
            transform: translateY(-2px);
        }
        
        .export-option-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .export-option-desc {
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        /* ===== MOBILE RESPONSIVENESS ===== */
        @media (max-width: 768px) {
            .header {
                padding: 0 14px;
                height: 52px;
            }

            .header-center {
                display: none;
            }

            .header-left h1 {
                font-size: 0.9em;
            }

            /* Mobile: nav as bottom bar */
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--nav-bg);
                border-top: 1px solid var(--nav-border);
                backdrop-filter: blur(20px);
                padding: 8px 0 max(8px, env(safe-area-inset-bottom));
                z-index: 100;
                justify-content: space-around;
            }

            .mobile-nav-btn {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 3px;
                padding: 4px 12px;
                border: none;
                background: transparent;
                color: var(--text-muted);
                font-family: 'Outfit', sans-serif;
                font-size: 0.58em;
                font-weight: 500;
                letter-spacing: 0.06em;
                text-transform: uppercase;
                cursor: pointer;
                transition: color 0.2s;
            }

            .mobile-nav-btn.active {
                color: var(--accent);
            }

            .mobile-nav-icon {
                font-size: 1.4em;
            }

            .main-content, .main-content.with-filters {
                height: calc(100vh - 52px - 60px);
            }

            .controls {
                flex-direction: column;
                padding: 10px 14px;
            }
            
            .filter-group {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .role-chip {
                font-size: 0.75em;
                padding: 6px 10px;
            }
            
            .opportunities-grid {
                grid-template-columns: 1fr;
            }
            
            .opportunity-card {
                padding: 15px;
            }
            
            .opportunity-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
            
            .values-grid {
                grid-template-columns: 1fr;
            }
            
            .welcome-steps-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            #welcomeView {
                padding-bottom: 80px;
            }
            
            .match-mode-toggle {
                margin-left: 0;
                margin-top: 4px;
            }
            .match-active-badge {
                margin-left: 0;
                margin-top: 4px;
                font-size: 0.7em;
            }
            .match-legend {
                top: auto;
                right: 8px;
                left: 8px;
                bottom: 70px;
                min-width: unset;
                max-width: unset;
                font-size: 0.75em;
            }
            .job-info-tile {
                top: 8px;
                left: 8px;
                right: 8px;
                min-width: unset;
                max-width: unset;
                font-size: 0.75em;
            }
            
            .blueprint-section {
                padding: 20px;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .export-btn-large {
                width: 100%;
            }
            
            /* Network view adjustments for mobile */
            #networkView {
                touch-action: pan-x pan-y;
            }
            
            .network-controls {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .label-toggle {
                font-size: 0.75em;
            }
        }
        
        @media (max-width: 480px) {
            .header-left h1 {
                font-size: 0.85em;
            }

            .profile-name {
                display: none;
            }

            .filter-search {
                width: 140px;
            }

            .filter-label {
                font-size: 0.7em;
            }

            .role-chip {
                font-size: 0.72em;
                padding: 4px 8px;
            }
            
            .blueprint-title {
                font-size: 1.8em;
            }
            
            .blueprint-subtitle {
                font-size: 1em;
            }
            
            .settings-tabs {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .settings-tabs::-webkit-scrollbar { display: none; }
            .settings-tab {
                padding: 10px 12px;
                font-size: 0.82em;
            }
            
            .modal-content {
                width: 95% !important;
                max-width: none !important;
                padding: 16px !important;
                margin: 8px;
                max-height: 92vh !important;
            }
            
            /* Make full-height modals (Manage Skills, O*NET) slide up from bottom on mobile */
            .modal-content[style*="900px"],
            .modal-content[style*="max-height: 90vh"] {
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 16px 16px 0 0 !important;
                margin: 0 !important;
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                max-height: 88vh !important;
            }
            
            /* Skill banner at bottom — compact on mobile */
            .sample-profile-banner {
                padding: 10px 14px;
                font-size: 0.85em;
            }
            
            /* O*NET tab bar — scrollable on mobile */
            .onet-tab {
                font-size: 0.72em;
                padding: 6px 10px;
                white-space: nowrap;
            }
        }
        
        /* Overflow Menu Styles */
        .overflow-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-width: 220px;
            z-index: 300;
            padding: 8px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            animation: dropIn 0.15s ease;
        }

        .overflow-menu button {
            width: 100%;
            text-align: left;
            padding: 10px 14px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.88em;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overflow-menu button:hover {
            background: var(--chip-bg);
        }
        
        /* Skills View Tabs */
        .skills-view-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .skills-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .skills-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #d1d5db;
        }
        
        .skills-tab.active {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
        }
        
        /* Quick Action Bar */
        .quick-action-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .quick-action-bar .btn-primary {
            padding: 10px 16px;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .quick-action-bar .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
        }
        
        .quick-action-bar .btn-secondary {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action-bar .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 25px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .settings-tab {
            flex: 1 0 auto;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .settings-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #d1d5db;
        }
        
        .settings-tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        /* Skill Management Styles */
        .onet-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
        }
        
        .onet-tab:hover {
            color: #d1d5db;
        }
        
        .onet-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }
        
        .onet-category {
            margin-bottom: 20px;
        }
        
        .onet-category-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .onet-category-title:hover {
            color: #93c5fd;
        }
        
        .onet-subcategory {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .onet-subcategory-title {
            font-size: 0.95em;
            font-weight: 500;
            color: #9ca3af;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .onet-skill-item {
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .onet-skill-item:hover:not(.disabled) {
            background: rgba(255,255,255,0.08);
            border-color: rgba(96, 165, 250, 0.3);
        }
        
        .onet-skill-item.selected {
            background: rgba(96, 165, 250, 0.15);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .onet-skill-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .onet-skill-checkbox {
            margin-top: 2px;
            cursor: pointer;
        }
        
        .onet-skill-checkbox:disabled {
            cursor: not-allowed;
        }
        
        .onet-skill-content {
            flex: 1;
        }
        
        .onet-skill-name {
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .onet-skill-definition {
            font-size: 0.9em;
            color: #9ca3af;
            line-height: 1.4;
        }
        
        .onet-skill-added {
            font-size: 0.8em;
            color: #10b981;
            font-weight: 600;
        }
        
        /* Skill Search Results (v2.3.0) */
        .skill-search-result {
            transition: all 0.2s ease;
        }
        
        .skill-search-result:not(.added):hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .skill-search-result.added {
            opacity: 0.6;
        }
        
        /* Unified Skill Management (v2.4.0) */
        .skill-mgmt-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .skill-mgmt-tab:hover {
            color: #e0e0e0;
            background: rgba(255,255,255,0.05);
        }
        
        .skill-mgmt-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .skill-mgmt-content {
            animation: fadeIn 0.2s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(16px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .your-skill-item {
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            border-left: 3px solid #60a5fa;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .your-skill-item:hover {
            background: rgba(255,255,255,0.06);
            transform: translateX(4px);
        }

        /* === Blueprint Icon System (v4.20.0) === */
        .nav-icon {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin-right: 4px;
            opacity: 0.85;
        }
        .nav-icon svg, .mobile-nav-icon svg, .overflow-icon svg,
        .bp-tab-icon svg, .settings-tab svg, .section-icon svg {
            display: inline-block;
            vertical-align: middle;
        }
        .nav-btn { display: inline-flex; align-items: center; gap: 5px; }
        .mobile-nav-icon { display: flex; align-items: center; justify-content: center; margin-bottom: 2px; }
        .overflow-icon-btn { display: flex; align-items: center; gap: 8px; }
        .overflow-icon { display: inline-flex; align-items: center; flex-shrink: 0; opacity: 0.7; }
        .section-icon { display: inline-flex; align-items: center; }
        .section-icon svg { opacity: 0.8; }
        .settings-tab svg { opacity: 0.75; flex-shrink: 0; }
        .bp-tab-icon { display: inline-flex; align-items: center; }
        .bp-tab-icon svg { opacity: 0.8; }

        /* ===== AUTH MODAL ===== */
        .auth-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;
            backdrop-filter: blur(4px);
        }
        .auth-overlay.active { display: flex; }
        .auth-dialog {
            background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px;
            width: 100%; max-width: 420px; padding: 36px; position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        [data-theme="light"] .auth-dialog { background: #fff; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .auth-dialog h2 { color: var(--accent); font-size: 1.4em; margin-bottom: 6px; }
        .auth-dialog .auth-subtitle { color: var(--text-secondary); font-size: 0.9em; margin-bottom: 24px; }
        .auth-close { position: absolute; top: 14px; right: 18px; background: none; border: none;
            color: var(--text-muted); font-size: 1.4em; cursor: pointer; }
        .auth-input {
            width: 100%; padding: 12px 14px; background: var(--bg-base); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text-primary); font-size: 0.95em; margin-bottom: 12px;
            outline: none; transition: border-color 0.2s;
        }
        .auth-input:focus { border-color: var(--accent); }
        [data-theme="light"] .auth-input { background: #f9fafb; }
        .auth-btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 0.95em;
            font-weight: 600; cursor: pointer; transition: opacity 0.2s;
        }
        .auth-btn:hover { opacity: 0.9; }
        .auth-btn-primary { background: var(--accent); color: #fff; }
        .auth-btn-google {
            background: #fff; color: #333; border: 1px solid #ddd;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .auth-btn-google:hover { background: #f5f5f5; }
        .auth-btn-magic { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
        .auth-divider {
            display: flex; align-items: center; margin: 18px 0; gap: 12px;
            color: var(--text-muted); font-size: 0.82em;
        }
        .auth-divider::before, .auth-divider::after {
            content: ''; flex: 1; height: 1px; background: var(--border);
        }
        .auth-toggle { color: var(--text-secondary); font-size: 0.88em; text-align: center; margin-top: 18px; }
        .auth-toggle a { color: var(--accent); cursor: pointer; text-decoration: underline; }
        .auth-error { color: #ef4444; font-size: 0.85em; margin-bottom: 12px; display: none; }
        .auth-success { color: #10b981; font-size: 0.85em; margin-bottom: 12px; display: none; }
        .auth-nav-btn {
            padding: 8px 16px; border-radius: 8px; font-size: 0.85em; font-weight: 600;
            cursor: pointer; border: 1px solid var(--accent); color: var(--accent); background: transparent;
            transition: all 0.2s;
        }
        .auth-nav-btn:hover { background: var(--accent); color: #fff; }
        .auth-nav-btn.signed-in { border-color: #10b981; color: #10b981; }
        .admin-badge {
            font-size: 0.65em; padding: 2px 6px; border-radius: 4px;
            background: rgba(251,191,36,0.15); color: #fbbf24; font-weight: 700;
            vertical-align: middle; margin-left: 6px; letter-spacing: 0.5px;
        }
        .sample-badge {
            font-size: 0.65em; padding: 2px 6px; border-radius: 4px;
            background: rgba(96,165,250,0.15); color: #60a5fa; font-weight: 700;
            vertical-align: middle; margin-left: 6px; letter-spacing: 0.5px;
        }
        .readonly-banner {
            background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.25);
            color: #fbbf24; padding: 10px 20px; text-align: center; font-size: 0.88em;
            font-weight: 600; position: sticky; top: 0; z-index: 50;
        }
        [data-theme="light"] .readonly-banner {
            background: rgba(217,119,6,0.08); border-color: rgba(217,119,6,0.2); color: #b45309;
        }
        /* Read-only mode: hide mutation controls on sample profiles */
        .readonly-mode .skill-item[onclick*="openSkillModal"] { cursor: default; }
        .readonly-mode .edit-skill-btn,
        .readonly-mode .assess-skill-btn,
        .readonly-mode [onclick*="openSkillManagement"],
        .readonly-mode [onclick*="openCustomSkillBuilder"],
        .readonly-mode [onclick*="openONETPicker"],
        .readonly-mode [onclick*="addApplicationModal"],
        .readonly-mode [onclick*="showOnboardingWizard"],
        .readonly-mode [onclick*="saveSettings"],
        .readonly-mode [onclick*="editValue"],
        .readonly-mode [onclick*="removeSelected"],
        .readonly-mode [onclick*="addCustomValue"],
        .readonly-mode [onclick*="saveAll"] { opacity: 0.35; pointer-events: none; }
        
        /* Demo mode lock icons on nav */
        .nav-lock-icon { font-size: 0.65em; margin-left: 3px; opacity: 0.6; vertical-align: super; }
        
        /* Waitlist modal */
        .waitlist-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
            z-index: 10000; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.25s; pointer-events: none;
        }
        .waitlist-overlay.active { opacity: 1; pointer-events: auto; }
        .waitlist-modal {
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px;
            width: 92%; max-width: 440px; padding: 36px 32px; position: relative;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4);
        }
        .waitlist-modal h3 { font-size: 1.35em; font-weight: 700; color: var(--accent); margin-bottom: 6px; }
        .waitlist-modal .wl-subtitle { font-size: 0.88em; color: var(--text-secondary); margin-bottom: 22px; line-height: 1.55; }
        .waitlist-modal input, .waitlist-modal select {
            width: 100%; padding: 12px 14px; border-radius: 8px; font-size: 0.92em;
            background: var(--bg); border: 1px solid var(--border); color: var(--text-primary);
            margin-bottom: 12px; outline: none; transition: border-color 0.2s;
        }
        .waitlist-modal input:focus, .waitlist-modal select:focus { border-color: var(--accent); }
        .waitlist-modal label { font-size: 0.82em; font-weight: 600; color: var(--text-secondary); margin-bottom: 5px; display: block; }
        .wl-submit-btn {
            width: 100%; padding: 14px; border: none; border-radius: 10px; cursor: pointer;
            font-size: 0.95em; font-weight: 700; color: #fff; margin-top: 8px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8); transition: transform 0.15s, box-shadow 0.15s;
        }
        .wl-submit-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(59,130,246,0.35); }
        .wl-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .wl-close { position: absolute; top: 14px; right: 18px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.4em; }
        .wl-skill-question { font-size: 0.82em; color: var(--text-muted); margin-top: 8px; text-align: center; }
        
        /* Gated feature prompt */
        .gated-prompt {
            background: linear-gradient(135deg, rgba(96,165,250,0.08), rgba(129,140,248,0.06));
            border: 1px dashed rgba(96,165,250,0.3); border-radius: 12px;
            padding: 24px; text-align: center; margin: 12px 0;
        }
        .gated-prompt .gp-icon { font-size: 1.8em; margin-bottom: 8px; }
        .gated-prompt .gp-title { font-weight: 700; color: var(--accent); font-size: 1em; margin-bottom: 6px; }
        .gated-prompt .gp-text { font-size: 0.85em; color: var(--text-secondary); line-height: 1.5; margin-bottom: 14px; }
        .gated-prompt .gp-btn {
            display: inline-block; padding: 10px 24px; border-radius: 8px; font-weight: 600; font-size: 0.88em;
            background: var(--accent); color: #fff; border: none; cursor: pointer; transition: transform 0.15s;
        }
        .gated-prompt .gp-btn:hover { transform: translateY(-1px); }
        
        /* Waitlist position badge */
        @keyframes nudgeIn {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .wl-position-badge {
            display: inline-flex; align-items: center; gap: 6px; padding: 5px 14px;
            background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.2);
            border-radius: 20px; font-size: 0.78em; font-weight: 600; color: #60a5fa;
        }
        .welcome-hero {
            max-width: 720px; margin: 60px auto; padding: 0 24px; text-align: center;
        }
        .welcome-hero h2 {
            font-size: 2.2em; font-weight: 700; color: var(--accent);
            margin-bottom: 16px; line-height: 1.2;
        }
        .welcome-hero .welcome-sub {
            font-size: 1.1em; color: var(--text-secondary); line-height: 1.7;
            margin-bottom: 40px;
        }
        .welcome-cards {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            margin-bottom: 48px; text-align: left;
        }
        @media (max-width: 600px) { .welcome-cards { grid-template-columns: 1fr; } }
        .welcome-card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 14px; padding: 28px; cursor: pointer;
            transition: border-color 0.2s, transform 0.15s;
        }
        .welcome-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        [data-theme="light"] .welcome-card { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .welcome-card h3 { color: var(--text-primary); font-size: 1.15em; margin-bottom: 8px; }
        .welcome-card p { color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; margin: 0; }
        .welcome-features {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
            margin-bottom: 48px; text-align: left;
        }
        @media (max-width: 700px) { .welcome-features { grid-template-columns: 1fr; } }
        @media (max-width: 600px) {
            .welcome-hero h2 { font-size: 1.6em; }
        }
        .welcome-feature {
            padding: 20px; border-radius: 10px;
            background: var(--bg-card); border: 1px solid var(--border);
        }
        .welcome-feature .wf-icon { font-size: 1.6em; margin-bottom: 8px; }
        .welcome-feature h4 { color: var(--text-primary); font-size: 0.95em; margin-bottom: 4px; }
        .welcome-feature p { color: var(--text-muted); font-size: 0.82em; line-height: 1.4; margin: 0; }
        
        /* Toast Notification System */
        #toastContainer {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 100000;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            min-width: 280px;
            max-width: 420px;
            padding: 14px 18px;
            border-radius: 10px;
            font-size: 0.92em;
            line-height: 1.45;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            transform: translateX(120%);
            opacity: 0;
            transition: transform 0.35s cubic-bezier(0.22,1,0.36,1), opacity 0.35s ease;
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.hide { transform: translateX(120%); opacity: 0; }
        .toast-icon { font-size: 1.15em; flex-shrink: 0; margin-top: 1px; }
        .toast-body { flex: 1; }
        .toast-title { font-weight: 600; margin-bottom: 2px; }
        .toast-msg { opacity: 0.88; }
        .toast-close {
            background: none; border: none; cursor: pointer;
            font-size: 1.1em; opacity: 0.5; padding: 0 0 0 8px;
            color: inherit; flex-shrink: 0;
        }
        .toast-close:hover { opacity: 1; }
        .toast-success { background: #065f46; color: #d1fae5; border-left: 4px solid #10b981; }
        .toast-error   { background: #7f1d1d; color: #fecaca; border-left: 4px solid #ef4444; }
        .toast-info    { background: #1e3a5f; color: #bfdbfe; border-left: 4px solid #60a5fa; }
        .toast-warning { background: #78350f; color: #fef3c7; border-left: 4px solid #f59e0b; }
        [data-theme="light"] .toast-success { background: #ecfdf5; color: #065f46; }
        [data-theme="light"] .toast-error   { background: #fef2f2; color: #7f1d1d; }
        [data-theme="light"] .toast-info    { background: #eff6ff; color: #1e3a5f; }
        [data-theme="light"] .toast-warning { background: #fffbeb; color: #78350f; }
        @media (max-width: 600px) {
            #toastContainer { left: 12px; right: 12px; bottom: 16px; }
            .toast { min-width: unset; max-width: unset; }
        }
    </style>
</head>
<body>
    <!-- Loading Splash -->
    <div id="appSplash" style="position:fixed; inset:0; z-index:999999; background:var(--bg, #0a0a1a); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:20px; transition:opacity 0.4s ease;">
        <div style="display:flex; align-items:center; gap:14px;">
            <svg width="48" height="48" viewBox="0 0 52 52" fill="none" style="filter: drop-shadow(0 0 20px rgba(96,165,250,0.3));">
                <circle cx="26" cy="26" r="24" stroke="#60a5fa" stroke-width="1.5" opacity="0.22"/>
                <line x1="26" y1="26" x2="12" y2="10" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="26" y1="26" x2="42" y2="12" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="26" y1="26" x2="40" y2="40" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="26" y1="26" x2="10" y2="40" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="12" y1="10" x2="42" y2="12" stroke="#60a5fa" stroke-width="0.8" opacity="0.12"/>
                <line x1="42" y1="12" x2="40" y2="40" stroke="#60a5fa" stroke-width="0.8" opacity="0.12"/>
                <line x1="10" y1="40" x2="40" y2="40" stroke="#60a5fa" stroke-width="0.8" opacity="0.12"/>
                <circle cx="26" cy="26" r="4.5" fill="#60a5fa"/>
                <circle cx="12" cy="10" r="3" fill="#93bbfc"/>
                <circle cx="42" cy="12" r="2.5" fill="#818cf8"/>
                <circle cx="40" cy="40" r="3" fill="#93bbfc"/>
                <circle cx="10" cy="40" r="2.5" fill="#818cf8"/>
            </svg>
            <span style="font-family:'Outfit',sans-serif; font-size:1.6em; font-weight:700; color:var(--accent, #60a5fa); letter-spacing:0.12em; text-transform:uppercase;">Blueprint<span style="font-size:0.55em; vertical-align:super; letter-spacing:0; opacity:0.6;">&trade;</span></span>
        </div>
        <div style="width:120px; height:2px; background:rgba(96,165,250,0.15); border-radius:2px; overflow:hidden;">
            <div id="splashProgress" style="width:0%; height:100%; background:linear-gradient(90deg,#60a5fa,#3b82f6); border-radius:2px; transition:width 0.3s ease;"></div>
        </div>
        <script>setTimeout(function(){var s=document.getElementById('appSplash');if(s){s.style.opacity='0';setTimeout(function(){s.remove()},400)}},8000);</script>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>
    
    <!-- Auth Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-dialog">
            <button class="auth-close" onclick="closeAuthModal()">&times;</button>
            <div id="authModalContent">
                <!-- Populated by showAuthModal() -->
            </div>
        </div>
    </div>
    <!-- ===== NAV BAR ===== -->
    <div class="header">
        <!-- Left: Logo + wordmark -->
        <div class="header-left" style="cursor:pointer;" onclick="switchView('welcome')">
            <div class="header-logo"><svg width="26" height="26" viewBox="0 0 52 52" fill="none">
                <circle cx="26" cy="26" r="24" stroke="#60a5fa" stroke-width="1.5" opacity="0.22"/>
                <line x1="26" y1="26" x2="12" y2="10" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="26" y1="26" x2="42" y2="12" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="26" y1="26" x2="40" y2="40" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="26" y1="26" x2="10" y2="40" stroke="#60a5fa" stroke-width="1.2" opacity="0.4"/>
                <line x1="12" y1="10" x2="42" y2="12" stroke="#60a5fa" stroke-width="0.8" opacity="0.12"/>
                <line x1="42" y1="12" x2="40" y2="40" stroke="#60a5fa" stroke-width="0.8" opacity="0.12"/>
                <line x1="10" y1="40" x2="40" y2="40" stroke="#60a5fa" stroke-width="0.8" opacity="0.12"/>
                <circle cx="26" cy="26" r="4.5" fill="#60a5fa"/>
                <circle cx="12" cy="10" r="3" fill="#93bbfc"/>
                <circle cx="42" cy="12" r="2.5" fill="#818cf8"/>
                <circle cx="40" cy="40" r="3" fill="#93bbfc"/>
                <circle cx="10" cy="40" r="2.5" fill="#818cf8"/>
            </svg></div>
            <h1>Blueprint<span style="font-size:0.55em; vertical-align:super; letter-spacing:0; opacity:0.6;">&trade;</span></h1>
        </div>

        <!-- Center: Primary navigation -->
        <div class="header-center" id="mainNav">
            <button class="nav-btn active" id="nav-skills" onclick="switchView('skills', event)">
                <span class="nav-icon" data-icon="skills"></span> Skills</button>
            <button class="nav-btn" id="nav-jobs" onclick="switchView('jobs', event)">
                <span class="nav-icon" data-icon="jobs"></span> Jobs</button>
            <button class="nav-btn" id="nav-blueprint" onclick="switchView('blueprint', event)">
                <span class="nav-icon" data-icon="blueprint"></span> Blueprint</button>
            <button class="nav-btn" id="nav-settings" onclick="switchView('settings', event)">
                <span class="nav-icon" data-icon="settings"></span> Settings</button>
        </div>

        <!-- Right: theme toggle + profile switcher + more -->
        <div class="header-right">
            <!-- Stats badge — visible on all tabs -->
            <span id="statsBar" style="font-size:0.78em; color: var(--text-muted); white-space:nowrap; display:none;"></span>

            <!-- Theme toggle -->
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggleBtn" title="Toggle light/dark mode">🌙</button>

            <!-- Auth button (shown when not logged in) -->
            <button class="auth-nav-btn" id="authNavBtn" onclick="showAuthModal('signin')" style="display:none;">Sign In</button>

            <!-- Profile switcher -->
            <div class="profile-chip" onclick="toggleProfileDropdown(event)" id="profileChip">
                <div class="profile-avatar" id="profileAvatar">...</div>
                <span class="profile-name" id="profileChipName">Loading</span>
                <span class="profile-caret">▾</span>
                <!-- Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-label" id="profileDropdownLabel">Account</div>
                    <div id="profileDropdownOptions">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Hidden select for backward-compat with switchProfile() -->
            <select id="profileSelector" onchange="switchProfile(this.value)" style="display:none;"></select>

            <!-- Save indicator -->
            <span id="saveIndicator" style="font-size:0.72em; color:var(--text-muted); opacity:0; transition:opacity 0.3s; white-space:nowrap; margin-right:4px;"></span>

            <!-- More menu -->
            <button class="more-btn" onclick="toggleOverflowMenu(event)" id="overflowMenuBtn" title="More options"><span data-icon="more" style="display:inline-flex;"></span></button>
            <div id="overflowMenu" class="overflow-menu" style="display:none;">
                <button onclick="closeOverflowMenu(); switchView('welcome');" style="color: var(--accent); font-weight: 600;" class="overflow-icon-btn"><span class="overflow-icon" data-icon="home"></span> Home</button>
                <button onclick="closeOverflowMenu(); showOnboardingWizard();" style="color: var(--accent); font-weight: 600;" class="overflow-icon-btn"><span class="overflow-icon" data-icon="wand"></span> Build My Blueprint</button>
                <button onclick="closeOverflowMenu(); viewSampleProfile();" class="overflow-icon-btn"><span class="overflow-icon" data-icon="users"></span> View Sample Profiles</button>
                <div style="height:1px; background:var(--border); margin:4px 0;"></div>
                <button onclick="closeOverflowMenu(); switchView('blueprint'); setTimeout(function(){ switchBlueprintTab('export'); }, 100);" class="overflow-icon-btn"><span class="overflow-icon" data-icon="export"></span> Export Blueprint</button>
                <button onclick="showHelp(); closeOverflowMenu();" class="overflow-icon-btn"><span class="overflow-icon" data-icon="help"></span> Help</button>
                <button onclick="showAbout(); closeOverflowMenu();" class="overflow-icon-btn"><span class="overflow-icon" data-icon="about"></span> About</button>
                <div style="height:1px; background:var(--border); margin:4px 0;"></div>
                <button id="overflowSignIn" onclick="showAuthModal('signin'); closeOverflowMenu();" style="color: var(--accent);" class="overflow-icon-btn"><span class="overflow-icon" data-icon="sign-in"></span> Sign In</button>
                <button id="overflowSignOut" onclick="authSignOut(); closeOverflowMenu();" style="color: #ef4444; display:none;" class="overflow-icon-btn"><span class="overflow-icon" data-icon="power"></span> Sign Out</button>
            </div>
        </div>
    </div>

    <!-- ===== CONTEXTUAL FILTER BAR (Skills tab only) ===== -->
    <div class="controls" id="controlsBar" style="display:none;">
        <div class="controls-left">
            <!-- View pills -->
            <div class="view-pills" id="skillsViewToggle">
                <button class="view-pill active" data-view="network" onclick="toggleSkillsView('network')">Network</button>
                <button class="view-pill" data-view="card" onclick="toggleSkillsView('card')">Card</button>
            </div>

            <!-- Job match mode toggle (hidden until a job is activated) -->
            <div id="matchModeToggle" style="display:none;" class="match-mode-toggle">
                <button class="match-mode-btn active" data-mode="you" onclick="setNetworkMatchMode('you')">You</button>
                <button class="match-mode-btn" data-mode="job" onclick="setNetworkMatchMode('job')">Job</button>
                <button class="match-mode-btn" data-mode="match" onclick="setNetworkMatchMode('match')">Match</button>
            </div>
            
            <!-- Active job badge (hidden until a job is activated) -->
            <div id="matchActiveBadge" style="display:none;" class="match-active-badge">
                <span data-icon="target" class="nav-icon"></span>
                <span id="matchActiveTitle">Loading...</span>
                <button onclick="clearJobOverlay()" title="Clear comparison">×</button>
            </div>

            <!-- Search -->
            <input type="text" id="skillSearch" class="filter-search" placeholder="Search skills..."
                   onkeyup="filterSkillsView(this.value)">

            <!-- Filter toggle -->
            <button class="filter-toggle-btn" id="filterToggleBtn" onclick="toggleFilterPanel()">
                <span><span data-icon="settings" class="nav-icon"></span> Filter</span>
                <span id="filterActiveCount" style="display:none; background:var(--accent); color:#fff; border-radius:8px; padding:1px 6px; font-size:0.75em;"></span>
            </button>
        </div>

        <div class="controls-right" id="networkControls">
            <div class="label-toggle">
                <span class="toggle-label">Role Labels</span>
                <label class="toggle-switch">
                    <input type="checkbox" checked onchange="toggleLabels('role')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="label-toggle">
                <span class="toggle-label">Skill Labels</span>
                <label class="toggle-switch">
                    <input type="checkbox" checked onchange="toggleLabels('skill')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- Collapsible filter panel -->
        <div class="filter-panel" id="filterPanel">
            <div class="filter-group" id="rolesFilterGroup">
                <span class="filter-label">Roles:</span>
                <div id="roleChipsContainer">
                    <div class="role-chip active" data-role="all" onclick="filterByRole('all')">All</div>
                </div>
            </div>
            <div class="filter-group">
                <span class="filter-label">Level:</span>
                <div class="level-filter" id="levelChipsContainer"></div>
            </div>
        </div>
        
        <!-- Role Info Card (appears when role node clicked in network) -->
        <div id="roleInfoCard" style="display:none; position:absolute; top:108px; left:16px;
            z-index:150; background:var(--bg-elevated); border:1px solid var(--border); border-radius:12px;
            padding:16px 18px; font-family:'Outfit',sans-serif; min-width:220px; max-width:280px;
            backdrop-filter:blur(16px); box-shadow:0 8px 32px rgba(0,0,0,0.3); cursor:default;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="roleInfoDot" style="width:10px; height:10px; border-radius:50%; flex-shrink:0;"></span>
                    <span id="roleInfoName" style="font-weight:700; font-size:0.95em; color:var(--text-primary);"></span>
                </div>
                <button onclick="document.getElementById('roleInfoCard').style.display='none'; filterByRole('all');" style="background:none; border:none; color:var(--text-muted);
                    cursor:pointer; font-size:1.2em; padding:8px; margin:-8px -8px -8px 0; line-height:1;"
                    onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-muted)'">&times;</button>
            </div>
            <div id="roleInfoStats" style="font-size:0.82em; color:var(--text-secondary); line-height:1.6;"></div>
        </div>
        <!-- Legacy pill reference kept for compat -->
        <div id="networkFilterPill" style="display:none;"><span id="networkFilterPillDot"></span><span id="networkFilterPillText"></span></div>
    </div>
    
    <div class="main-content">
        <div id="welcomeView" style="display:none;"></div>
        <svg id="networkView" style="display:none;"></svg>
        <div id="cardView" style="display:none;"></div>
        <div id="opportunitiesView" style="display:none;"></div>
        <div id="applicationsView" style="display:none;"></div>
        <div id="blueprintView" style="display:none;"></div>
        <div id="consentView" style="display:none;"></div>
        <div id="settingsView" style="display:none;"></div>
    </div>

    <!-- App Footer / Attribution -->
    <footer id="appFooter" style="text-align:center; padding:16px 20px; font-size:0.75em; opacity:0.5; line-height:1.8;">
        <div style="margin-bottom:4px;">&copy; <script>document.write(new Date().getFullYear())</script> Cliff Jurkiewicz. All rights reserved. Blueprint&trade; and its associated methodologies, ontology structures, and matching algorithms are the intellectual property of Cliff Jurkiewicz.</div>
        <div>Uses the <a href="https://esco.ec.europa.eu" target="_blank" rel="noopener" style="color:inherit; text-decoration:underline;">ESCO classification</a> of the European Commission and <a href="https://www.onetonline.org" target="_blank" rel="noopener" style="color:inherit; text-decoration:underline;">O*NET</a> occupational data. <a href="#" onclick="event.preventDefault(); showLegalNotice();" style="color:inherit; text-decoration:underline;">Legal &amp; IP Notice</a> &middot; <a href="#" onclick="event.preventDefault(); switchView('settings'); setTimeout(function(){ window.currentSettingsTab='privacy'; initSettings(); window.settingsInitialized=true; }, 100);" style="color:inherit; text-decoration:underline;">Privacy & Terms</a></div>
    </footer>
    
    <!-- Mobile bottom nav (hidden on desktop via CSS) -->
    <div class="mobile-nav" id="mobileNav" style="display:none;">
        <button class="mobile-nav-btn active" id="mob-skills" onclick="switchView('skills',event)">
            <span class="mobile-nav-icon" data-icon="skills"></span>Skills
        </button>
        <button class="mobile-nav-btn" id="mob-jobs" onclick="switchView('jobs',event)">
            <span class="mobile-nav-icon" data-icon="jobs"></span>Jobs
        </button>
        <button class="mobile-nav-btn" id="mob-blueprint" onclick="switchView('blueprint',event)">
            <span class="mobile-nav-icon" data-icon="blueprint"></span>Blueprint
        </button>
        <button class="mobile-nav-btn" id="mob-settings" onclick="switchView('settings',event)">
            <span class="mobile-nav-icon" data-icon="settings"></span>Settings
        </button>
        <button class="mobile-nav-btn" id="mob-more" onclick="toggleOverflowMenu(event)">
            <span class="mobile-nav-icon" data-icon="more"></span>More
        </button>
    </div>

    <div class="tooltip" id="tooltip"></div>
    
    <!-- Skill Detail Modal -->
    <div class="modal" id="skillModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title" id="skillDetailTitle"></h2>
                    <div class="modal-subtitle" id="skillDetailSubtitle"></div>
                </div>
                <button class="modal-close" onclick="closeSkillModal()">×</button>
            </div>
            <div class="modal-body" id="skillDetailBody"></div>
        </div>
    </div>
    
    <!-- Export Modal (used dynamically for outcome editing and value notes) -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Export Options</h2>
                </div>
                <button class="modal-close" onclick="closeExportModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="color: #9ca3af; margin-bottom: 20px;">All export options are available in the Blueprint tab.</p>
                <button onclick="closeExportModal(); switchView('blueprint'); setTimeout(function(){ switchBlueprintTab('export'); }, 100);" style="
                    background:var(--accent); color:#fff; border:none; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.95em;
                ">Go to Export Options</button>
            </div>
        </div>
    </div>

    <!-- O*NET Skill Picker Modal -->
    <div class="modal" id="onetPickerModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Add Skills from O*NET Library</h2>
                </div>
                <button class="modal-close" onclick="closeONETPicker()">×</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1); overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; flex-shrink: 0; padding-bottom: 1px;"
                         class="onet-tab-bar">
                        <button id="onetTabSkills" class="onet-tab active" onclick="switchONETTab('skills')">
                            Skills (35)
                        </button>
                        <button id="onetTabAbilities" class="onet-tab" onclick="switchONETTab('abilities')">
                            Abilities (52)
                        </button>
                        <button id="onetTabWorkStyles" class="onet-tab" onclick="switchONETTab('workstyles')">
                            Work Styles (21)
                        </button>
                        <button id="onetTabKnowledge" class="onet-tab" onclick="switchONETTab('knowledge')">
                            Knowledge (33)
                        </button>
                        <button id="onetTabActivities" class="onet-tab" onclick="switchONETTab('activities')">
                            Work Activities (41)
                        </button>
                    </div>
                    <input type="text" id="onetSearchInput" placeholder="Search O*NET library..." 
                           class="settings-input" oninput="filterONETLibrary()" style="width: 100%; margin-bottom: 15px;">
                </div>
                <div id="onetLibraryContent" style="max-height: 400px; overflow-y: auto;">
                    <!-- Populated by JavaScript -->
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="onetSelectedCount" style="color: #9ca3af;"></span>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="closeONETPicker()" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="addSelectedONETSkills()" id="onetAddButton" 
                                    style="padding: 10px 20px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Add Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Skill Builder Modal -->
    <div class="modal" id="customSkillModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Create Custom Skill</h2>
                </div>
                <button class="modal-close" onclick="closeCustomSkillBuilder()">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Skill Name *</label>
                    <input type="text" id="customSkillName" class="settings-input" placeholder="e.g., Quantum Computing Strategy">
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Proficiency Level *</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Novice" style="margin-right: 5px;">
                            Novice
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Competent" style="margin-right: 5px;">
                            Competent
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Proficient" checked style="margin-right: 5px;">
                            Proficient
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Advanced" style="margin-right: 5px;">
                            Advanced
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Expert" style="margin-right: 5px;">
                            Expert
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Mastery" style="margin-right: 5px;">
                            Mastery
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Used in Roles <span style="font-weight:400; color:var(--text-muted); font-size:0.85em;">(optional, defaults to all)</span></label>
                    <div id="customSkillRoles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="settings-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="customSkillCore">
                        <span class="settings-label" style="margin: 0;">Mark as Core Differentiator</span>
                    </label>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <button onclick="closeCustomSkillBuilder()" 
                            style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="createCustomSkill()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Create Skill
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Skill Import Modal -->
    <div class="modal" id="bulkImportModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Bulk Import Skills</h2>
                </div>
                <button class="modal-close" onclick="closeBulkImport()">×</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <div id="bulkImportStep1">
                    <div style="display:flex; gap:12px; margin-bottom:16px;">
                        <button id="bulkTabText" class="onet-tab active" onclick="switchBulkTab('text')" style="flex:1;">
                            <span data-icon="clipboard" class="nav-icon"></span> Paste List
                        </button>
                        <button id="bulkTabCsv" class="onet-tab" onclick="switchBulkTab('csv')" style="flex:1;">
                            <span data-icon="upload" class="nav-icon"></span> Upload CSV
                        </button>
                    </div>
                    
                    <div id="bulkTextInput" style="margin-bottom:16px;">
                        <label class="settings-label">Paste skills (one per line, or comma-separated)</label>
                        <textarea id="bulkSkillsText" class="settings-input" rows="10" 
                            placeholder="Strategic Planning, Expert&#10;Data Analysis, Proficient&#10;Stakeholder Management&#10;Python&#10;&#10;Format: Skill Name, Level (optional)&#10;Levels: Novice, Competent, Proficient, Advanced, Expert, Mastery&#10;If no level given, defaults to Proficient"
                            style="width:100%; font-family:monospace; font-size:0.88em; resize:vertical;"></textarea>
                    </div>
                    
                    <div id="bulkCsvInput" style="display:none; margin-bottom:16px;">
                        <label class="settings-label">Upload CSV file</label>
                        <p style="font-size:0.8em; color:var(--text-muted); margin-bottom:10px;">
                            Expected columns: <code style="background:var(--bg-card); padding:2px 6px; border-radius:3px;">name</code> (required), 
                            <code style="background:var(--bg-card); padding:2px 6px; border-radius:3px;">level</code>, 
                            <code style="background:var(--bg-card); padding:2px 6px; border-radius:3px;">category</code>, 
                            <code style="background:var(--bg-card); padding:2px 6px; border-radius:3px;">core</code>.
                            Column order flexible. First row treated as header.
                        </p>
                        <input type="file" id="bulkCsvFile" accept=".csv,.tsv,.txt" 
                            onchange="handleBulkCsvFile(this)"
                            style="font-size:0.9em;">
                        <div id="bulkCsvPreview" style="margin-top:12px; font-size:0.82em; color:var(--text-muted);"></div>
                    </div>
                    
                    <div style="margin-bottom:16px; padding:14px; border-radius:8px; background:rgba(139,92,246,0.06); border:1px solid rgba(139,92,246,0.15);">
                        <label class="settings-label" style="margin-bottom:8px;">Destination</label>
                        <div style="display:flex; gap:12px; flex-wrap:wrap;">
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:8px 14px; border-radius:6px; border:1px solid var(--border); background:var(--bg-card);">
                                <input type="radio" name="bulkDestination" value="library" onchange="toggleBulkProfileOptions()">
                                <span style="font-size:0.9em; display:inline-flex; align-items:center; gap:5px;"><span data-icon="book" class="nav-icon"></span> Skill Library only</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:8px 14px; border-radius:6px; border:1px solid var(--border); background:var(--bg-card);">
                                <input type="radio" name="bulkDestination" value="profile" checked onchange="toggleBulkProfileOptions()">
                                <span style="font-size:0.9em; display:inline-flex; align-items:center; gap:5px;"><span data-icon="profile" class="nav-icon"></span> Library + Current Profile</span>
                            </label>
                        </div>
                        <div style="font-size:0.78em; color:var(--text-muted); margin-top:6px;">Library-only adds skills to the searchable index for job matching without adding them to your profile.</div>
                    </div>
                    
                    <div id="bulkProfileOptions">
                        <div style="display:flex; gap:20px; margin-bottom:16px; flex-wrap:wrap;">
                            <div>
                                <label class="settings-label">Default proficiency</label>
                                <select id="bulkDefaultLevel" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;">
                                    <option value="Novice">Novice</option>
                                    <option value="Competent">Competent</option>
                                    <option value="Proficient" selected>Proficient</option>
                                    <option value="Advanced">Advanced</option>
                                    <option value="Expert">Expert</option>
                                    <option value="Mastery">Mastery</option>
                                </select>
                            </div>
                            <div>
                                <label class="settings-label">On duplicate</label>
                                <select id="bulkMergeStrategy" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;">
                                    <option value="skip">Skip (keep existing)</option>
                                    <option value="higher">Keep higher proficiency</option>
                                    <option value="overwrite">Overwrite with import</option>
                                </select>
                            </div>
                        </div>
                    
                        <div style="margin-bottom:16px;">
                            <label class="settings-label">Assign to roles <span style="font-weight:400; color:var(--text-muted); font-size:0.85em;">(optional, defaults to all)</span></label>
                            <div id="bulkImportRoles" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:8px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button onclick="closeBulkImport()" style="padding:10px 20px; background:transparent; border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text-primary);">Cancel</button>
                        <button onclick="parseBulkSkills()" style="padding:10px 24px; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;">
                            Parse &amp; Review →
                        </button>
                    </div>
                </div>
                
                <div id="bulkImportStep2" style="display:none;">
                    <div id="bulkReviewSummary" style="margin-bottom:16px;"></div>
                    <div id="bulkReviewList" style="max-height:400px; overflow-y:auto; margin-bottom:16px;"></div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;">
                        <button onclick="bulkImportBack()" style="padding:10px 20px; background:transparent; border:1px solid var(--border); border-radius:8px; cursor:pointer; color:var(--text-primary);">← Back</button>
                        <button id="bulkImportConfirmBtn" onclick="executeBulkImport()" style="padding:10px 24px; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;">
                            Import Skills
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Skill Manager Modal -->
    <div class="modal" id="bulkSkillManagerModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Manage Profile Skills</h2>
                </div>
                <button class="modal-close" onclick="closeBulkManager()">×</button>
            </div>
            <div class="modal-body" style="overflow-y: auto; padding: 20px;">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:14px; flex-wrap:wrap;">
                    <input type="text" id="bulkManagerSearch" placeholder="Filter skills..." oninput="filterBulkManager()"
                        class="settings-input" style="flex:1; min-width:180px; padding:8px 12px;">
                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:0.85em; color:var(--text-muted); white-space:nowrap;">
                        <input type="checkbox" id="bulkManagerSelectAll" onchange="toggleBulkManagerAll(this.checked)">
                        Select all
                    </label>
                    <span id="bulkManagerCount" style="font-size:0.82em; color:var(--text-muted); white-space:nowrap;"></span>
                </div>
                
                <div id="bulkManagerActions" style="display:none; padding:12px 16px; margin-bottom:14px; border-radius:8px; background:rgba(96,165,250,0.08); border:1px solid rgba(96,165,250,0.2); flex-wrap:wrap; gap:10px; align-items:center;">
                    <span id="bulkManagerSelected" style="font-size:0.88em; font-weight:600; color:var(--accent); margin-right:8px;"></span>
                    <button onclick="bulkManagerSetLevel()" style="padding:6px 14px; background:rgba(139,92,246,0.15); color:#a78bfa; border:1px solid rgba(139,92,246,0.3); border-radius:6px; cursor:pointer; font-size:0.85em;">
                        Set Level
                    </button>
                    <button onclick="bulkManagerRemove()" style="padding:6px 14px; background:rgba(239,68,68,0.1); color:#ef4444; border:1px solid rgba(239,68,68,0.3); border-radius:6px; cursor:pointer; font-size:0.85em;">
                        Remove Selected
                    </button>
                </div>
                
                <div id="bulkManagerList" style="max-height:450px; overflow-y:auto;">
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Skill Modal -->
    <div class="modal" id="editSkillModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Edit Skill</h2>
                </div>
                <button class="modal-close" onclick="closeEditSkillModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Skill Name</label>
                    <input type="text" id="editSkillName" class="settings-input" readonly style="background: rgba(255,255,255,0.05);">
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Proficiency Level *</label>
                    <div id="editSkillEvidenceStatus" style="margin-bottom:10px;"></div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Novice" style="margin-right: 5px;" onchange="updateEditSkillGapWarning()">
                            Novice
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Competent" style="margin-right: 5px;" onchange="updateEditSkillGapWarning()">
                            Competent
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Proficient" style="margin-right: 5px;" onchange="updateEditSkillGapWarning()">
                            Proficient
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Advanced" style="margin-right: 5px;" onchange="updateEditSkillGapWarning()">
                            Advanced
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Expert" style="margin-right: 5px;" onchange="updateEditSkillGapWarning()">
                            Expert
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Mastery" style="margin-right: 5px;" onchange="updateEditSkillGapWarning()">
                            Mastery
                        </label>
                    </div>
                    <div id="editSkillGapWarning" style="margin-top:8px;"></div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Used in Roles <span style="font-weight:400; color:var(--text-muted); font-size:0.85em;">(optional, defaults to all)</span></label>
                    <div id="editSkillRoles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="settings-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="editSkillCore">
                        <span class="settings-label" style="margin: 0;">Mark as Core Differentiator</span>
                    </label>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <button onclick="closeEditSkillModal()" 
                            style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveSkillEdit()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Assessment Modal (for unique skills) -->
    <div class="modal" id="assessSkillModal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Assess Skill Impact</h2>
                </div>
                <button class="modal-close" onclick="closeAssessSkillModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="coaching-tip" style="margin-bottom: 25px;">
                    <div class="coaching-tip-title">
                        ${bpIcon('lightbulb',14)} WHY ASSESS THIS SKILL?
                    </div>
                    <div class="coaching-tip-content">
                        This skill doesn't have a direct O*NET match. Answer a few questions so we can accurately rate its market impact.
                    </div>
                </div>
                
                <div id="assessSkillName" style="font-size: 1.2em; font-weight: 600; margin-bottom: 25px; color: #fbbf24;"></div>
                
                <div class="settings-group">
                    <label class="settings-label">How many years of experience do you have with this skill? *</label>
                    <input type="number" id="assessYears" class="settings-input" min="0" max="50" value="5" 
                           style="width: 120px;">
                    <div class="settings-help">More experience generally indicates higher impact</div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Impact on business outcomes: *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessImpact" value="minor">
                            <div>
                                <div style="font-weight: 600;">Minor Impact</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Supports work but doesn't directly drive major outcomes</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessImpact" value="significant" checked>
                            <div>
                                <div style="font-weight: 600;">Significant Impact</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Directly contributes to key business results</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessImpact" value="major">
                            <div>
                                <div style="font-weight: 600;">Major Impact</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Critical differentiator, drives strategic outcomes</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">How common is this skill in the market? *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessRarity" value="common">
                            <div>
                                <div style="font-weight: 600;">Common</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Many professionals have this skill</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessRarity" value="uncommon" checked>
                            <div>
                                <div style="font-weight: 600;">Uncommon</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Specialized, not widely held</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessRarity" value="rare">
                            <div>
                                <div style="font-weight: 600;">Rare</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Very few people have this expertise</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">This skill is typically used in roles paying: *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessSalary" value="<$150k">
                            <div>
                                <div style="font-weight: 600;">Under $150k</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Mid-level to senior roles</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessSalary" value="$150-250k" checked>
                            <div>
                                <div style="font-weight: 600;">$150k - $250k</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Director to VP level</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessSalary" value=">$250k">
                            <div>
                                <div style="font-weight: 600;">Over $250k</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">VP to C-Suite level</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div id="assessmentPreview" style="color: #9ca3af; font-size: 0.9em;"></div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="closeAssessSkillModal()" 
                                style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="saveSkillAssessment()" 
                                style="padding: 10px 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Save Assessment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Search Modal (v2.3.0) -->
    <!-- Unified Skill Management Modal (v2.4.0) -->
    <div class="modal" id="skillManagementModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Manage Skills</h2>
                    <p style="color: #9ca3af; margin-top: 5px; font-size: 0.9em;">
                        <span id="skillManagementCount">Loading...</span>
                    </p>
                </div>
                <button class="modal-close" onclick="closeSkillManagement()">×</button>
            </div>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 10px; padding: 0 20px; border-bottom: 2px solid rgba(255,255,255,0.1);">
                <button id="yourSkillsTab" class="skill-mgmt-tab active" onclick="switchSkillManagementTab('yours')">
                    <span style="display:inline-flex; align-items:center; gap:4px;" data-icon="bar-chart" class="nav-icon"></span> Your Skills (<span id="yourSkillsCount">0</span>)
                </button>
                <button id="addSkillsTab" class="skill-mgmt-tab" onclick="switchSkillManagementTab('add')">
                    <span data-icon="plus" class="nav-icon"></span> Add Skills (<span id="availableSkillsCount">2,384+</span>)
                </button>
            </div>
            
            <div class="modal-body" style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 200px);">
                
                <!-- YOUR SKILLS TAB -->
                <div id="yourSkillsContent" class="skill-mgmt-content">
                    <div style="position: relative; margin-bottom: 20px;">
                        <input 
                            type="text" 
                            id="yourSkillsSearchInput" 
                            class="settings-input" 
                            placeholder="Search your skills..."
                            style="width: 100%; padding-right: 40px;"
                            oninput="filterYourSkills()">
                        <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 1.2em;">
                            ${bpIcon("search",14)}
                        </span>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="yourSkillsCategoryFilter" onchange="filterYourSkills()" style="padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            <option value="all">All Categories</option>
                            <!-- populated dynamically by populateCategoryFilter() -->
                        </select>
                        
                        <select id="yourSkillsLevelFilter" onchange="filterYourSkills()" style="padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            <option value="all">All Levels</option>
                            <option value="Mastery">Mastery</option>
                            <option value="Expert">Expert</option>
                            <option value="Advanced">Advanced</option>
                            <option value="Proficient">Proficient</option>
                            <option value="Novice">Novice</option>
                        </select>
                    </div>
                    
                    <div id="yourSkillsList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <!-- ADD SKILLS TAB -->
                <div id="addSkillsContent" class="skill-mgmt-content" style="display: none;">
                    <div style="position: relative; margin-bottom: 20px;">
                        <input 
                            type="text" 
                            id="addSkillsSearchInput" 
                            class="settings-input" 
                            placeholder="Search 13,960+ skills... (e.g., 'python', 'marketing', 'leadership')"
                            style="width: 100%; padding-right: 40px; font-size: 1.1em;"
                            oninput="handleAddSkillsSearch()"
                            autofocus>
                        <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 1.2em;">
                            ${bpIcon("search",14)}
                        </span>
                    </div>
                    
                    <div id="addSkillsResults" style="min-height: 200px;">
                        <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                            <div style="margin-bottom: 10px;">' + bpIcon('search',48) + '</div>
                            <div style="font-size: 1.1em;">Start typing to search skills</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">Try: "python", "marketing", "leadership"</div>
                        </div>
                    </div>
                    
                    <div id="addSkillsCategories" style="margin-top: 25px;">
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px; font-weight: 600;">
                            BROWSE BY CATEGORY:
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button onclick="searchAddSkillsByCategory('Technology')" 
                                    style="padding: 8px 16px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #60a5fa; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                <span data-icon="tool" class="nav-icon"></span> Technology
                            </button>
                            <button onclick="searchAddSkillsByCategory('Business')" 
                                    style="padding: 8px 16px; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); color: #a78bfa; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                <span data-icon="briefcase" class="nav-icon"></span> Business
                            </button>
                            <button onclick="searchAddSkillsByCategory('Finance')" 
                                    style="padding: 8px 16px; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); color: #10b981; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                <span data-icon="money" class="nav-icon"></span> Finance
                            </button>
                            <button onclick="searchAddSkillsByCategory('Marketing')" 
                                    style="padding: 8px 16px; background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); color: #fbbf24; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                <span data-icon="send" class="nav-icon"></span> Marketing
                            </button>
                            <button onclick="searchAddSkillsByCategory('Creative')" 
                                    style="padding: 8px 16px; background: rgba(249, 115, 22, 0.2); border: 1px solid rgba(249, 115, 22, 0.4); color: #fb923c; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                <span data-icon="compass" class="nav-icon"></span> Creative
                            </button>
                            <button onclick="searchAddSkillsByCategory('Leadership')" 
                                    style="padding: 8px 16px; background: rgba(100, 116, 139, 0.2); border: 1px solid rgba(100, 116, 139, 0.4); color: #94a3b8; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                <span data-icon="star" class="nav-icon"></span> Leadership
                            </button>
                            <button onclick="searchAddSkillsByCategory('Trades')" 
                                    style="padding: 8px 16px; background: rgba(180, 83, 9, 0.2); border: 1px solid rgba(180, 83, 9, 0.4); color: #d97706; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                <span data-icon="tool" class="nav-icon"></span> Trades
                            </button>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div style="padding: 15px 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: #9ca3af; font-size: 0.85em;">
                        <span id="skillManagementStatus"></span>
                    </div>
                    <button onclick="closeSkillManagement()" 
                            style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // BLUEPRINT v4.22.0 - BUILD 20260220-audit

        // Safe localStorage wrapper (handles private browsing, quota exceeded)
        function safeGet(key, fallback) {
            try { return localStorage.getItem(key); } catch(e) { return fallback || null; }
        }
        function safeSet(key, val) {
            try { localStorage.setItem(key, val); return true; } catch(e) { return false; }
        }
        function safeRemove(key) {
            try { localStorage.removeItem(key); } catch(e) {}
        }
        // Samples default to Network view + scroll-to-top on all view switches
        // ============================================================
        console.log('%c==============================================', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c   BLUEPRINT v4.22.0                    ', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c   Build: 20260220-find-jobs                     ', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c   Everyone Has Premium Value!              ', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c==============================================', 'color: #60a5fa; font-weight: bold; font-size: 14px;');


        // ===== BLUEPRINT ICON SYSTEM (v4.20.0) =====
        // Stroke-based SVG icons using currentColor for theme-awareness
        function bpIcon(name, size) {
            size = size || 18;
            var s = 'xmlns="http://www.w3.org/2000/svg" width="' + size + '" height="' + size + '" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
            var icons = {
                // -- Navigation --
                'skills':       '<svg ' + s + '><circle cx="12" cy="12" r="3"/><circle cx="4" cy="8" r="2"/><circle cx="20" cy="8" r="2"/><circle cx="4" cy="18" r="2"/><circle cx="20" cy="18" r="2"/><line x1="6" y1="8" x2="9.5" y2="10.5"/><line x1="18" y1="8" x2="14.5" y2="10.5"/><line x1="6" y1="18" x2="9.5" y2="13.5"/><line x1="18" y1="18" x2="14.5" y2="13.5"/></svg>',
                'jobs':         '<svg ' + s + '><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/><line x1="12" y1="12" x2="12" y2="12.01"/></svg>',
                'blueprint':    '<svg ' + s + '><path d="M2 6l10-3 10 3"/><path d="M2 6v12l10 3 10-3V6"/><path d="M12 3v18"/><path d="M2 12l10 3 10-3"/></svg>',
                'settings':     '<svg ' + s + '><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>',
                'more':         '<svg ' + s + '><circle cx="5" cy="12" r="1" fill="currentColor"/><circle cx="12" cy="12" r="1" fill="currentColor"/><circle cx="19" cy="12" r="1" fill="currentColor"/></svg>',

                // -- Overflow menu --
                'home':         '<svg ' + s + '><path d="M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
                'wand':         '<svg ' + s + '><path d="M15 4V2M15 16v-2M8 9h2M20 9h2M17.8 11.8l1.4 1.4M17.8 6.2l1.4-1.4M12.2 11.8l-1.4 1.4M12.2 6.2l-1.4-1.4"/><line x1="2" y1="22" x2="15" y2="9"/></svg>',
                'users':        '<svg ' + s + '><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
                'help':         '<svg ' + s + '><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                'about':        '<svg ' + s + '><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
                'sign-in':      '<svg ' + s + '><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>',
                'sign-out':     '<svg ' + s + '><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>',
                'export':       '<svg ' + s + '><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',

                // -- Blueprint tabs --
                'outcomes':     '<svg ' + s + '><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
                'values':       '<svg ' + s + '><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
                'purpose':      '<svg ' + s + '><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',

                // -- Settings tabs --
                'profile':      '<svg ' + s + '><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
                'experience':   '<svg ' + s + '><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>',
                'preferences':  '<svg ' + s + '><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>',
                'privacy':      '<svg ' + s + '><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',

                // -- Section icons --
                'lightbulb':    '<svg ' + s + '><line x1="9" y1="18" x2="15" y2="18"/><line x1="10" y1="22" x2="14" y2="22"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>',
                'graduation':   '<svg ' + s + '><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c0 1 4 3 6 3s6-2 6-3v-5"/></svg>',
                'award':        '<svg ' + s + '><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>',
                'search':       '<svg ' + s + '><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
                'filter':       '<svg ' + s + '><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
                'plus':         '<svg ' + s + '><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
                'edit':         '<svg ' + s + '><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>',
                'trash':        '<svg ' + s + '><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
                'warning':      '<svg ' + s + '><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                'lock':         '<svg ' + s + '><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
                'scale':        '<svg ' + s + '><path d="M12 3v19M5 8l7-5 7 5"/><path d="M5 8l-3 9h6L5 8z"/><path d="M19 8l-3 9h6l-3-9z"/></svg>',
                'database':     '<svg ' + s + '><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
                'camera':       '<svg ' + s + '><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>',
                'map-pin':      '<svg ' + s + '><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',
                'mail':         '<svg ' + s + '><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22 6 12 13 2 6"/></svg>',
                'phone':        '<svg ' + s + '><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
                'linkedin':     '<svg ' + s + '><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>',
                'save':         '<svg ' + s + '><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',
                'clock':        '<svg ' + s + '><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
                'star':         '<svg ' + s + '><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
                'check':        '<svg ' + s + '><polyline points="20 6 9 17 4 12"/></svg>',
                'target':       '<svg ' + s + '><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
                'share':        '<svg ' + s + '><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>',
                'clipboard':    '<svg ' + s + '><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',
                'file-text':    '<svg ' + s + '><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
                'download':     '<svg ' + s + '><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
                'upload':       '<svg ' + s + '><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
                'layers':       '<svg ' + s + '><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>',
                'network':      '<svg ' + s + '><circle cx="12" cy="12" r="3"/><circle cx="4" cy="8" r="2"/><circle cx="20" cy="8" r="2"/><circle cx="4" cy="18" r="2"/><circle cx="20" cy="18" r="2"/><line x1="6" y1="8" x2="9.5" y2="10.5"/><line x1="18" y1="8" x2="14.5" y2="10.5"/><line x1="6" y1="18" x2="9.5" y2="13.5"/><line x1="18" y1="18" x2="14.5" y2="13.5"/></svg>',
                'grid':         '<svg ' + s + '><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
                'bar-chart':    '<svg ' + s + '><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>',
                'dollar':       '<svg ' + s + '><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
                'trending-up':  '<svg ' + s + '><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
                'briefcase':    '<svg ' + s + '><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>',
                'tool':         '<svg ' + s + '><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
                'compass':      '<svg ' + s + '><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>',
                'send':         '<svg ' + s + '><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',
                'message':      '<svg ' + s + '><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
                'external':     '<svg ' + s + '><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>',
                'chevron-right':'<svg ' + s + '><polyline points="9 18 15 12 9 6"/></svg>',
                'x':            '<svg ' + s + '><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
                'power':        '<svg ' + s + '><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>',
                'pie-chart':    '<svg ' + s + '><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>',
                'share-preset': '<svg ' + s + '><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>',
                'eye':          '<svg ' + s + '><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
                'zap':          '<svg ' + s + '><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
                'flag':         '<svg ' + s + '><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>',
                'heart':        '<svg ' + s + '><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
                'book':         '<svg ' + s + '><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
                'copy':         '<svg ' + s + '><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
                'interview':    '<svg ' + s + '><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
                'salary':       '<svg ' + s + '><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
                'document':     '<svg ' + s + '><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
                'json':         '<svg ' + s + '><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>',
                'pdf':          '<svg ' + s + '><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M9 13h6"/><path d="M9 17h6"/></svg>',
                'pipeline':     '<svg ' + s + '><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',
                'tracker':      '<svg ' + s + '><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 14l2 2 4-4"/></svg>',
                'magic':        '<svg ' + s + '><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 21 12 17.77 5.82 21 7 14.14l-5-4.87 6.91-1.01L12 2z"/></svg>',
                'flame':        '<svg ' + s + '><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>',
                'diamond':      '<svg ' + s + '><path d="M6 3h12l4 6-10 12L2 9z"/><path d="M2 9h20"/><path d="M10 3l-2 6 4 12 4-12-2-6"/></svg>',
                'money':        '<svg ' + s + '><rect x="1" y="4" width="22" height="16" rx="2"/><circle cx="12" cy="12" r="4"/><path d="M1 8h2M21 8h2M1 16h2M21 16h2"/></svg>',
            };
            return icons[name] || '<svg ' + s + '><circle cx="12" cy="12" r="1"/></svg>';
        }
        window.bpIcon = bpIcon;

        // Global role-name-to-SVG icon resolver
        function getRoleIconSvg(roleName, size) {
            size = size || 16;
            var lower = (roleName || '').toLowerCase();
            var map = {
                'strategy': 'target', 'vp': 'target', 'director': 'target', 'executive': 'target', 'chief': 'target',
                'technology': 'tool', 'engineer': 'tool', 'developer': 'tool', 'tech': 'tool', 'software': 'tool',
                'product': 'layers', 'manager': 'layers',
                'data': 'database', 'analyst': 'database', 'research': 'database', 'science': 'database',
                'design': 'compass', 'creative': 'compass', 'ux': 'compass',
                'marketing': 'send', 'communication': 'send', 'sales': 'send',
                'hr': 'users', 'talent': 'users', 'people': 'users', 'recruiting': 'users', 'recruiter': 'users',
                'finance': 'dollar', 'accounting': 'dollar', 'operations': 'dollar',
                'pilot': 'compass', 'aviation': 'compass', 'flight': 'compass',
                'music': 'heart', 'musician': 'heart',
                'advocate': 'heart', 'nonprofit': 'heart', 'community': 'heart',
                'futurist': 'zap', 'innovation': 'zap', 'evangelist': 'zap',
                'entrepreneur': 'trending-up', 'founder': 'trending-up',
                'consultant': 'briefcase', 'advisor': 'briefcase', 'partner': 'briefcase', 'stakeholder': 'users',
            };
            for (var keyword in map) {
                if (lower.indexOf(keyword) !== -1) return bpIcon(map[keyword], size);
            }
            return bpIcon('briefcase', size);
        }
        window.getRoleIconSvg = getRoleIconSvg;

        // ===== FIREBASE INITIALIZATION =====
        var firebaseConfig = {
            apiKey: "AIzaSyBO703p11FdLojH6ogB50XrxoFVy_7bHLE",
            authDomain: "work-blueprint.firebaseapp.com",
            projectId: "work-blueprint",
            storageBucket: "work-blueprint.firebasestorage.app",
            messagingSenderId: "338454233039",
            appId: "1:338454233039:web:76016289b81d8298269cba"
        };
        
        var fbApp = null;
        var fbAuth = null;
        var fbDb = null;
        var fbUser = null;       // Current Firebase auth user
        var fbIsAdmin = false;   // Admin role flag
        var fbReady = false;     // Firebase SDK loaded and initialized
        
        try {
            fbApp = firebase.initializeApp(firebaseConfig);
            fbAuth = firebase.auth();
            fbDb = firebase.firestore();
            fbReady = true;
            console.log('✓ Firebase initialized');
        } catch(e) {
            console.warn('⚠ Firebase not available, running in offline mode:', e.message);
        }

        // ===== AUTH STATE MANAGEMENT =====
        var authReadyResolve = null;
        var authReadyPromise = new Promise(function(resolve) { authReadyResolve = resolve; });
        
        if (fbAuth) {
            fbAuth.onAuthStateChanged(function(user) {
                fbUser = user;
                if (user) {
                    console.log('🔐 Signed in:', user.email);
                    checkAdminRole(user.uid).then(function(isAdmin) {
                        fbIsAdmin = isAdmin;
                        detectAppMode();
                        updateAuthUI();
                        rebuildProfileDropdown();
                        authReadyResolve(user);
                    });
                } else {
                    console.log('🔓 Not signed in');
                    fbIsAdmin = false;
                    updateAuthUI();
                    authReadyResolve(null);
                }
            });
            
            // Handle Google redirect return
            fbAuth.getRedirectResult().then(function(result) {
                if (result && result.user) {
                    closeAuthModal();
                    var isNew = result.additionalUserInfo && result.additionalUserInfo.isNewUser;
                    handlePostSignIn(result.user, isNew);
                }
            }).catch(function(err) {
                if (err.code !== 'auth/redirect-cancelled-by-user') {
                    console.warn('Redirect auth error:', err.code);
                }
            });
        } else {
            authReadyResolve(null);
        }

        // ===== AUTH UI =====
        function showAuthModal(mode) {
            if (!fbReady) {
                showToast('Authentication service unavailable. Try refreshing.', 'error');
                return;
            }
            var overlay = document.getElementById('authOverlay');
            var content = document.getElementById('authModalContent');
            if (!overlay || !content) return;
            
            mode = mode || 'signin';
            var isSignUp = mode === 'signup';
            
            content.innerHTML = '<h2>' + (isSignUp ? 'Create Account' : 'Sign In') + '</h2>'
                + '<div class="auth-subtitle">' + (isSignUp ? 'Build and save your Blueprint' : 'Welcome back') + '</div>'
                
                // Google Sign-In
                + '<button class="auth-btn auth-btn-google" onclick="authWithGoogle()" style="margin-bottom:10px;">'
                + '<svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>'
                + 'Continue with Google</button>'
                
                + '<div class="auth-divider">or</div>'
                
                // Error/success messages
                + '<div class="auth-error" id="authError"></div>'
                + '<div class="auth-success" id="authSuccess"></div>'
                
                // Email form
                + (isSignUp ? '<input class="auth-input" id="authName" type="text" placeholder="Full name" />' : '')
                + '<input class="auth-input" id="authEmail" type="email" placeholder="Email address" />'
                + '<input class="auth-input" id="authPassword" type="password" placeholder="Password" '
                + 'onkeydown="if(event.key===\'Enter\'){' + (isSignUp ? 'authEmailSignUp()' : 'authEmailSignIn()') + '}" />'
                
                + '<button class="auth-btn auth-btn-primary" onclick="' + (isSignUp ? 'authEmailSignUp()' : 'authEmailSignIn()') + '" style="margin-bottom:10px;">'
                + (isSignUp ? 'Create Account' : 'Sign In') + '</button>'
                
                // Magic link
                + '<button class="auth-btn auth-btn-magic" onclick="authSendMagicLink()">Send me a sign-in link instead</button>'
                
                // Toggle
                + '<div class="auth-toggle">'
                + (isSignUp
                    ? 'Already have an account? <a onclick="showAuthModal(\'signin\')">Sign in</a>'
                    : 'Don\'t have an account? <a onclick="showAuthModal(\'signup\')">Create one</a>')
                + '</div>';
            
            overlay.classList.add('active');
        }
        window.showAuthModal = showAuthModal;

        function closeAuthModal() {
            var overlay = document.getElementById('authOverlay');
            if (overlay) overlay.classList.remove('active');
        }
        window.closeAuthModal = closeAuthModal;

        function showAuthError(msg) {
            var el = document.getElementById('authError');
            if (el) { el.textContent = msg; el.style.display = 'block'; }
            var s = document.getElementById('authSuccess');
            if (s) s.style.display = 'none';
        }

        function showAuthSuccess(msg) {
            var el = document.getElementById('authSuccess');
            if (el) { el.textContent = msg; el.style.display = 'block'; }
            var e = document.getElementById('authError');
            if (e) e.style.display = 'none';
        }

        // ===== AUTH METHODS =====
        function authWithGoogle() {
            if (!fbAuth) return;
            var provider = new firebase.auth.GoogleAuthProvider();
            fbAuth.signInWithRedirect(provider);
        }
        window.authWithGoogle = authWithGoogle;

        function authEmailSignIn() {
            if (!fbAuth) return;
            var email = (document.getElementById('authEmail') || {}).value || '';
            var password = (document.getElementById('authPassword') || {}).value || '';
            if (!email || !password) { showAuthError('Please enter email and password.'); return; }
            
            fbAuth.signInWithEmailAndPassword(email, password)
                .then(function(result) {
                    closeAuthModal();
                    handlePostSignIn(result.user, false);
                })
                .catch(function(err) {
                    showAuthError(friendlyAuthError(err.code));
                });
        }
        window.authEmailSignIn = authEmailSignIn;

        function authEmailSignUp() {
            if (!fbAuth) return;
            var name = (document.getElementById('authName') || {}).value || '';
            var email = (document.getElementById('authEmail') || {}).value || '';
            var password = (document.getElementById('authPassword') || {}).value || '';
            if (!email || !password) { showAuthError('Please enter email and password.'); return; }
            
            fbAuth.createUserWithEmailAndPassword(email, password)
                .then(function(result) {
                    // Set display name
                    if (name) {
                        result.user.updateProfile({ displayName: name });
                    }
                    closeAuthModal();
                    handlePostSignIn(result.user, true);
                })
                .catch(function(err) {
                    showAuthError(friendlyAuthError(err.code));
                });
        }
        window.authEmailSignUp = authEmailSignUp;

        function authSendMagicLink() {
            if (!fbAuth) return;
            var email = (document.getElementById('authEmail') || {}).value || '';
            if (!email) { showAuthError('Please enter your email address first.'); return; }
            
            var actionCodeSettings = {
                url: window.location.href,
                handleCodeInApp: true
            };
            
            fbAuth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(function() {
                    localStorage.setItem('wbMagicLinkEmail', email);
                    showAuthSuccess('Sign-in link sent to ' + email + '. Check your inbox.');
                })
                .catch(function(err) {
                    showAuthError(friendlyAuthError(err.code));
                });
        }
        window.authSendMagicLink = authSendMagicLink;

        function authSignOut() {
            if (!fbAuth) return;
            fbAuth.signOut().then(function() {
                fbUser = null;
                fbIsAdmin = false;
                showToast('Signed out.', 'info');
                updateAuthUI();
                rebuildProfileDropdown();
                switchView('welcome');
            });
        }
        window.authSignOut = authSignOut;

        // Handle magic link sign-in on page load
        function checkMagicLinkSignIn() {
            try {
                if (!fbAuth || !fbAuth.isSignInWithEmailLink(window.location.href)) return;
                var email = localStorage.getItem('wbMagicLinkEmail');
                if (!email) {
                    email = prompt('Please enter your email to confirm sign-in:');
                }
                if (email) {
                    fbAuth.signInWithEmailLink(email, window.location.href)
                        .then(function(result) {
                            localStorage.removeItem('wbMagicLinkEmail');
                            window.history.replaceState({}, document.title, window.location.pathname);
                            handlePostSignIn(result.user, result.additionalUserInfo && result.additionalUserInfo.isNewUser);
                        })
                        .catch(function(err) {
                            console.error('Magic link sign-in failed:', err);
                            showToast('Sign-in link expired or invalid. Please try again.', 'error');
                        });
                }
            } catch(e) {
                console.warn('Magic link check skipped:', e.message);
            }
        }

        function friendlyAuthError(code) {
            var map = {
                'auth/email-already-in-use': 'An account with this email already exists. Try signing in.',
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/weak-password': 'Password must be at least 6 characters.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/invalid-credential': 'Incorrect email or password.',
                'auth/too-many-requests': 'Too many attempts. Please wait a moment and try again.',
                'auth/network-request-failed': 'Network error. Check your connection.',
                'auth/popup-blocked': 'Pop-up blocked by browser. Allow pop-ups for this site.'
            };
            return map[code] || 'Authentication error. Please try again.';
        }

        // ===== POST SIGN-IN HANDLER =====
        function handlePostSignIn(user, isNewUser) {
            if (!user) return;
            
            // Ensure user document exists in Firestore
            if (fbDb) {
                var userRef = fbDb.collection('users').doc(user.uid);
                userRef.get().then(function(doc) {
                    if (!doc.exists) {
                        // First sign-in: create user document
                        userRef.set({
                            email: user.email,
                            displayName: user.displayName || '',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                            role: 'user'
                        });
                        console.log('✓ Created Firestore user document');
                        // Offer wizard for new users
                        setTimeout(function() { showOnboardingWizard(); }, 600);
                    } else {
                        // Returning user: update last login, load their data
                        userRef.update({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() });
                        loadUserFromFirestore(user.uid);
                    }
                }).catch(function(err) {
                    console.error('Firestore user check failed:', err);
                });
            }
            
            showToast('Welcome, ' + (user.displayName || user.email) + '!', 'success');
        }

        // ===== ADMIN ROLE CHECK =====
        function checkAdminRole(uid) {
            if (!fbDb) return Promise.resolve(false);
            return fbDb.collection('users').doc(uid).get()
                .then(function(doc) {
                    if (doc.exists && doc.data().role === 'admin') {
                        console.log('👑 Admin role confirmed for', uid);
                        return true;
                    }
                    console.log('ℹ️ User role:', doc.exists ? (doc.data().role || 'user') : 'no document');
                    return false;
                })
                .catch(function(err) {
                    console.error('⚠️ Admin check failed:', err.code || err.message || err);
                    return false;
                });
        }

        // ===== AUTH UI UPDATE =====
        function updateAuthUI() {
            var authBtn = document.getElementById('authNavBtn');
            var profileChip = document.getElementById('profileChip');
            var overflowSignIn = document.getElementById('overflowSignIn');
            var overflowSignOut = document.getElementById('overflowSignOut');
            
            if (fbUser) {
                // Signed in
                if (authBtn) authBtn.style.display = 'none';
                if (overflowSignIn) overflowSignIn.style.display = 'none';
                if (overflowSignOut) overflowSignOut.style.display = '';
                if (profileChip) {
                    profileChip.style.display = '';
                    var nameEl = document.getElementById('profileChipName');
                    var avatarEl = document.getElementById('profileAvatar');
                    var displayName = fbUser.displayName || fbUser.email.split('@')[0];
                    if (nameEl) nameEl.textContent = displayName + (fbIsAdmin ? '' : '');
                    if (avatarEl) avatarEl.textContent = getInitials(displayName);
                }
                // Add admin badge and sign-out to dropdown
                rebuildProfileDropdown();
            } else {
                // Not signed in
                if (authBtn) authBtn.style.display = '';
                if (overflowSignIn) overflowSignIn.style.display = '';
                if (overflowSignOut) overflowSignOut.style.display = 'none';
                // Profile chip still shows for sample browsing
                if (profileChip) profileChip.style.display = '';
            }
        }

        function rebuildProfileDropdown() {
            var container = document.getElementById('profileDropdownOptions');
            if (!container) return;
            
            // Update dropdown header label
            var ddLabel = document.getElementById('profileDropdownLabel');
            if (ddLabel) ddLabel.textContent = fbIsAdmin ? 'Admin \u00B7 Switch Profile' : 'Account';
            
            var html = '';
            
            // Current user section
            if (fbUser) {
                html += '<div style="padding:8px 12px; font-size:0.82em; color:var(--text-muted); border-bottom:1px solid var(--border); margin-bottom:4px;">'
                    + (fbUser.displayName || fbUser.email)
                    + (fbIsAdmin ? ' <span class="admin-badge">ADMIN</span>' : '')
                    + '</div>';
            }
            
            // Sample profiles from manifest — admins and non-signed-in (demo) users only
            var manifest = window.profilesManifest;
            if ((fbIsAdmin || !fbUser) && manifest && manifest.profiles) {
                if (fbIsAdmin) {
                    html += '<div style="padding:6px 12px; font-size:0.7em; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.08em;">Sample Profiles</div>';
                }
                manifest.profiles.filter(function(p) { return p.enabled; }).forEach(function(p) {
                    var isCurrent = (userData.templateId === p.id);
                    var initials = p.name.split(' ').map(function(w) { return w[0]; }).join('').slice(0, 2).toUpperCase();
                    html += '<div class="profile-option' + (isCurrent ? ' active-profile' : '') + '" '
                        + 'onclick="switchProfile(\'' + p.id + '\'); closeProfileDropdown();">'
                        + '<div class="profile-option-avatar">' + initials + '</div>'
                        + '<div class="profile-option-info">'
                        + '<div class="profile-option-name">' + p.name + ' <span style="font-size:0.7em; color:var(--text-muted); font-weight:400;">SAMPLE</span></div>'
                        + '<div class="profile-option-title">' + (p.title || '') + '</div>'
                        + '</div>'
                        + (isCurrent ? '<span class="profile-option-check">\u2713</span>' : '')
                        + '</div>';
                });
            }
            
            // Divider + auth actions
            if (fbUser) {
                html += '<div style="height:1px; background:var(--border); margin:6px 0;"></div>';
                if (fbIsAdmin) {
                    html += '<div class="profile-option" onclick="showAdminPanel(); closeProfileDropdown();">'
                        + '<div class="profile-option-avatar" style="background:rgba(251,191,36,0.2); color:#fbbf24;">\uD83D\uDC51</div>'
                        + '<div class="profile-option-info"><div class="profile-option-name">Admin Dashboard</div></div></div>';
                }
                html += '<div class="profile-option" onclick="authSignOut(); closeProfileDropdown();">'
                    + '<div class="profile-option-avatar" style="background:rgba(239,68,68,0.15); color:#ef4444;">\u23FB</div>'
                    + '<div class="profile-option-info"><div class="profile-option-name" style="color:#ef4444;">Sign Out</div></div></div>';
            } else {
                html += '<div style="height:1px; background:var(--border); margin:6px 0;"></div>';
                html += '<div class="profile-option" onclick="showAuthModal(\'signin\'); closeProfileDropdown();">'
                    + '<div class="profile-option-avatar" style="background:rgba(96,165,250,0.2); color:#60a5fa;">\uD83D\uDD10</div>'
                    + '<div class="profile-option-info"><div class="profile-option-name" style="color:var(--accent);">Sign In / Create Account</div></div></div>';
            }
            
            container.innerHTML = html;
        }

        function getInitials(name) {
            if (!name) return '?';
            var parts = name.trim().split(/\s+/);
            if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            return name.substring(0, 2).toUpperCase();
        }

        // ===== FIRESTORE PERSISTENCE =====
        function saveToFirestore() {
            if (!fbDb || !fbUser) return Promise.resolve(false);
            var si = document.getElementById('saveIndicator');
            if (si) { si.textContent = bpIcon('upload',12) + ' Saving...'; si.style.opacity = '0.6'; si.style.color = 'var(--text-muted)'; }
            
            var uid = fbUser.uid;
            var data = {
                profile: userData.profile || {},
                skills: (skillsData && skillsData.skills) ? skillsData.skills.map(function(s) {
                    return { name: s.name, level: s.level, category: s.category, key: s.key, roles: s.roles || [], evidence: s.evidence || [] };
                }) : [],
                roles: (skillsData && skillsData.roles) || [],
                values: blueprintData.values || [],
                purpose: blueprintData.purpose || '',
                outcomes: blueprintData.outcomes || [],
                preferences: userData.preferences || {},
                applications: userData.applications || [],
                workHistory: userData.workHistory || [],
                education: userData.education || [],
                certifications: userData.certifications || [],
                verifications: userData.verifications || [],
                savedJobs: (userData.savedJobs || []).map(function(j) {
                    return { id: j.id || '', title: j.title || '', company: j.company || '', sourceUrl: j.sourceUrl || '', sourceNote: j.sourceNote || '',
                        rawText: j.rawText || '', parsedSkills: j.parsedSkills || [], parsedRoles: j.parsedRoles || [],
                        seniority: j.seniority || '', matchData: j.matchData || {}, addedAt: j.addedAt || new Date().toISOString(),
                        sample: j.sample || false };
                }),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            return fbDb.collection('users').doc(uid).set(data, { merge: true })
                .then(function() {
                    console.log('☁ Saved to Firestore');
                    var si = document.getElementById('saveIndicator');
                    if (si) { si.textContent = bpIcon('check',12) + ' Saved'; si.style.opacity = '1'; si.style.color = '#10b981'; setTimeout(function() { si.style.opacity = '0'; }, 2500); }
                    return true;
                })
                .catch(function(err) {
                    console.error('Firestore save error:', err);
                    var si = document.getElementById('saveIndicator');
                    if (si) { si.textContent = bpIcon('warning',12) + ' Save failed'; si.style.opacity = '1'; si.style.color = '#ef4444'; setTimeout(function() { si.style.opacity = '0'; }, 4000); }
                    return false;
                });
        }
        window.saveToFirestore = saveToFirestore;

        function loadUserFromFirestore(uid) {
            if (!fbDb) return Promise.resolve(false);
            
            return fbDb.collection('users').doc(uid).get()
                .then(function(doc) {
                    if (!doc.exists) return false;
                    var data = doc.data();
                    
                    // Only load if user has actual skill data
                    if (!data.skills || data.skills.length === 0) return false;
                    
                    console.log('☁ Loading profile from Firestore...');
                    
                    // Populate userData
                    userData.initialized = true;
                    userData.profile = data.profile || {};
                    userData.skills = data.skills || [];
                    userData.values = data.values || [];
                    userData.purpose = data.purpose || '';
                    userData.roles = data.roles || [];
                    userData.preferences = data.preferences || userData.preferences;
                    userData.applications = data.applications || [];
                    // Preserve sample jobs from demo profiles — Firestore won't have them
                    var existingSampleJobs = (userData.savedJobs || []).filter(function(j) { return j && j.sample; });
                    var firestoreJobs = data.savedJobs || [];
                    userData.savedJobs = firestoreJobs.length > 0 ? firestoreJobs : existingSampleJobs;
                    userData.workHistory = data.workHistory || [];
                    userData.education = data.education || [];
                    userData.certifications = data.certifications || [];
                    userData.verifications = data.verifications || [];
                    userData.templateId = 'firestore-' + uid;
                    
                    // Populate skillsData
                    if (typeof skillsData !== 'undefined') {
                        skillsData.skills = data.skills || [];
                        skillsData.roles = data.roles || [];
                    }
                    
                    // Re-render
                    if (typeof initializeMainApp === 'function') {
                        initializeMainApp();
                    }
                    if (userData.profile.name) {
                        updateProfileChip(userData.profile.name);
                    }
                    
                    // Refresh app mode and UI state after data load
                    if (typeof detectAppMode === 'function') detectAppMode();
                    if (typeof checkReadOnly === 'function') checkReadOnly();
                    if (typeof rebuildProfileDropdown === 'function') rebuildProfileDropdown();
                    
                    console.log('✓ Loaded from Firestore:', data.skills.length, 'skills | admin:', fbIsAdmin, '| mode:', appMode);
                    return true;
                })
                .catch(function(err) {
                    console.error('Firestore load error:', err);
                    return false;
                });
        }

        // ===== GDPR DATA FUNCTIONS =====
        function exportMyData() {
            if (!fbDb || !fbUser) {
                showToast('You must be signed in to export your data.', 'warning');
                return;
            }
            
            fbDb.collection('users').doc(fbUser.uid).get()
                .then(function(doc) {
                    if (!doc.exists) {
                        showToast('No data found for your account.', 'info');
                        return;
                    }
                    var data = doc.data();
                    data.exportedAt = new Date().toISOString();
                    data.exportedFor = fbUser.email;
                    
                    var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'blueprint-data-export-' + new Date().toISOString().slice(0, 10) + '.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    showToast('Your data has been exported.', 'success');
                });
        }
        window.exportMyData = exportMyData;

        function requestDataDeletion() {
            if (!fbDb || !fbUser) {
                showToast('You must be signed in to request deletion.', 'warning');
                return;
            }
            
            var confirmed = confirm('This will permanently delete all your Blueprint data and sign you out. This action cannot be undone.\n\nAre you sure?');
            if (!confirmed) return;
            
            var doubleConfirm = confirm('Final confirmation: All your skills, values, outcomes, and profile data will be permanently deleted. Proceed?');
            if (!doubleConfirm) return;
            
            var uid = fbUser.uid;
            fbDb.collection('users').doc(uid).delete()
                .then(function() {
                    return fbAuth.currentUser.delete();
                })
                .then(function() {
                    // Clear local storage
                    safeRemove('wbValues');
                    safeRemove('wbPurpose');
                    safeRemove('currentProfile');
                    
                    showToast('Your data has been permanently deleted.', 'info', 6000);
                    fbUser = null;
                    fbIsAdmin = false;
                    updateAuthUI();
                    
                    // Reload to clean state
                    setTimeout(function() { window.location.reload(); }, 2000);
                })
                .catch(function(err) {
                    if (err.code === 'auth/requires-recent-login') {
                        showToast('For security, please sign out and sign back in, then try again.', 'warning', 6000);
                    } else {
                        console.error('Deletion error:', err);
                        showToast('Error deleting data. Please try again or contact support.', 'error');
                    }
                });
        }
        window.requestDataDeletion = requestDataDeletion;

        function viewMyData() {
            if (!fbDb || !fbUser) {
                showToast('You must be signed in to view your stored data.', 'warning');
                return;
            }
            
            fbDb.collection('users').doc(fbUser.uid).get()
                .then(function(doc) {
                    if (!doc.exists) {
                        showToast('No data found for your account.', 'info');
                        return;
                    }
                    var data = doc.data();
                    
                    var modal = document.getElementById('exportModal');
                    var modalContent = modal.querySelector('.modal-content');
                    
                    var summary = 'Account: ' + (data.email || 'N/A')
                        + '\nCreated: ' + (data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'N/A')
                        + '\nLast Login: ' + (data.lastLogin ? new Date(data.lastLogin.seconds * 1000).toLocaleDateString() : 'N/A')
                        + '\nSkills stored: ' + (data.skills ? data.skills.length : 0)
                        + '\nValues stored: ' + (data.values ? data.values.length : 0)
                        + '\nOutcomes stored: ' + (data.outcomes ? data.outcomes.length : 0)
                        + '\nApplications stored: ' + (data.applications ? data.applications.length : 0);
                    
                    modalContent.innerHTML = '<div class="modal-header">'
                        + '<div class="modal-header-left"><h2 class="modal-title">Your Stored Data</h2></div>'
                        + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                        + '</div>'
                        + '<div class="modal-body" style="padding:24px;">'
                        + '<pre style="background:' + tv('rgba(0,0,0,0.3)','#f1f5f9') + '; padding:20px; border-radius:8px; '
                        + 'color:' + tv('#e0e0e0','#334155') + '; font-size:0.85em; line-height:1.6; white-space:pre-wrap; overflow:auto; max-height:400px;">'
                        + summary + '</pre>'
                        + '<div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap;">'
                        + '<button onclick="exportMyData()" style="background:' + tv('#1e40af','#2563eb') + '; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600;">Download Full Export (JSON)</button>'
                        + '<button onclick="closeExportModal(); requestDataDeletion();" style="background:transparent; color:#ef4444; border:1px solid #ef4444; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600;">Delete All My Data</button>'
                        + '</div></div>';
                    
                    history.pushState({ modal: true }, ''); modal.classList.add('active');
                });
        }
        window.viewMyData = viewMyData;

        // ===== ADMIN PANEL =====
        function showAdminPanel() {
            if (!fbIsAdmin || !fbDb) {
                showToast('Admin access required.', 'error');
                return;
            }
            
            var modal = document.getElementById('exportModal');
            var modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left"><h2 class="modal-title">\uD83D\uDC51 Admin Dashboard</h2></div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">'
                + '<button onclick="closeExportModal(); openBulkImport();" style="padding:10px 20px; background:linear-gradient(135deg,#8b5cf6,#7c3aed); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + bpIcon('upload',14) + ' Bulk Import Skills</button>'
                + '<button onclick="closeExportModal(); openBulkManager();" style="padding:10px 20px; background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + bpIcon('edit',14) + ' Bulk Edit / Remove</button>'
                + '</div>'
                
                // Evidence Threshold Configuration
                + '<div style="margin-bottom:24px; padding:20px; background:' + tv('rgba(16,185,129,0.06)','rgba(16,185,129,0.04)') + '; border:1px solid ' + tv('rgba(16,185,129,0.2)','rgba(16,185,129,0.12)') + '; border-radius:10px;">'
                + '<div style="font-weight:700; color:' + tv('#10b981','#059669') + '; margin-bottom:12px; font-size:0.95em;">\uD83C\uDFAF Evidence Threshold Configuration</div>'
                + '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + '; margin-bottom:16px;">Points required for each effective level. Quality outcomes earn 1-5 points each. Adjust these to change how evidence maps to levels.</div>'
                + '<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">'
                + ['Competent','Proficient','Advanced','Expert','Mastery'].map(function(level) {
                    return '<div style="display:flex; flex-direction:column; gap:4px;">'
                        + '<label style="font-size:0.78em; color:' + tv('#d1d5db','#334155') + '; font-weight:600;">' + level + '</label>'
                        + '<input type="number" id="threshold_' + level + '" value="' + evidenceConfig.thresholds[level] + '" min="1" max="50" '
                        + 'style="width:100%; padding:6px 10px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; border:1px solid ' + tv('rgba(255,255,255,0.15)','#d1d5db') + '; border-radius:6px; color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.9em; text-align:center;">'
                        + '</div>';
                }).join('')
                + '</div>'
                + '<div style="display:flex; gap:10px; margin-top:14px; align-items:center;">'
                + '<div style="flex:1;">'
                + '<label style="font-size:0.78em; color:' + tv('#d1d5db','#334155') + '; font-weight:600;">Cert Floor</label>'
                + '<select id="threshold_certFloor" style="width:100%; padding:6px 10px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; border:1px solid ' + tv('rgba(255,255,255,0.15)','#d1d5db') + '; border-radius:6px; color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.88em;">'
                + ['Novice','Competent','Proficient','Advanced'].map(function(l) { return '<option value="' + l + '"' + (evidenceConfig.certFloor === l ? ' selected' : '') + '>' + l + '</option>'; }).join('')
                + '</select></div>'
                + '<div style="flex:1;">'
                + '<label style="font-size:0.78em; color:' + tv('#d1d5db','#334155') + '; font-weight:600;">Verification Multiplier</label>'
                + '<input type="number" id="threshold_verifyMult" value="' + evidenceConfig.verificationMultiplier + '" min="1" max="3" step="0.1" '
                + 'style="width:100%; padding:6px 10px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; border:1px solid ' + tv('rgba(255,255,255,0.15)','#d1d5db') + '; border-radius:6px; color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.9em; text-align:center;">'
                + '</div>'
                + '</div>'
                + '<div style="display:flex; gap:10px; margin-top:14px;">'
                + '<button onclick="saveAdminThresholds()" style="padding:8px 18px; background:#10b981; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.85em;">Save Thresholds</button>'
                + '<button onclick="resetAdminThresholds()" style="padding:8px 18px; background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','#d1d5db') + '; border-radius:6px; cursor:pointer; font-size:0.85em;">Reset Defaults</button>'
                + '</div>'
                + '</div>'
                
                + '<div style="display:flex; gap:2px; margin-bottom:16px; background:' + tv('rgba(255,255,255,0.05)','rgba(0,0,0,0.04)') + '; border-radius:8px; padding:3px;">'
                + '<button onclick="document.getElementById(\'adminContent\').style.display=\'block\'; document.getElementById(\'adminWaitlistContent\').style.display=\'none\'; this.style.background=\'var(--accent)\'; this.style.color=\'#fff\'; this.nextElementSibling.style.background=\'transparent\'; this.nextElementSibling.style.color=\'var(--text-secondary)\';" style="flex:1; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.85em; background:var(--accent); color:#fff;">Users</button>'
                + '<button onclick="document.getElementById(\'adminWaitlistContent\').style.display=\'block\'; document.getElementById(\'adminContent\').style.display=\'none\'; this.style.background=\'var(--accent)\'; this.style.color=\'#fff\'; this.previousElementSibling.style.background=\'transparent\'; this.previousElementSibling.style.color=\'var(--text-secondary)\'; loadAdminWaitlist();" style="flex:1; padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.85em; background:transparent; color:var(--text-secondary);">Waitlist</button>'
                + '</div>'
                + '<div id="adminContent" style="color:' + tv('#d1d5db','#334155') + ';">Loading users...</div>'
                + '<div id="adminWaitlistContent" style="color:' + tv('#d1d5db','#334155') + '; display:none;">Loading waitlist...</div>'
                + '</div>';
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            
            // Fetch all users
            fbDb.collection('users').orderBy('lastLogin', 'desc').get()
                .then(function(snapshot) {
                    var html = '<div style="margin-bottom:16px; font-size:0.9em; color:' + tv('#9ca3af','#64748b') + ';">'
                        + snapshot.size + ' registered users</div>';
                    
                    html += '<div style="display:grid; gap:10px;">';
                    snapshot.forEach(function(doc) {
                        var d = doc.data();
                        var skillCount = d.skills ? d.skills.length : 0;
                        var lastLogin = d.lastLogin ? new Date(d.lastLogin.seconds * 1000).toLocaleDateString() : 'Never';
                        var isAdmin = d.role === 'admin';
                        
                        html += '<div style="padding:14px; background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; '
                            + 'border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + '; border-radius:8px;">'
                            + '<div style="display:flex; justify-content:space-between; align-items:center;">'
                            + '<div>'
                            + '<strong style="color:' + tv('#e0e0e0','#1e293b') + ';">' + (d.displayName || d.email || doc.id) + '</strong>'
                            + (isAdmin ? ' <span class="admin-badge">ADMIN</span>' : '')
                            + '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + ';">'
                            + (d.email || '') + '</div>'
                            + '</div>'
                            + '<div style="text-align:right; font-size:0.82em; color:' + tv('#9ca3af','#64748b') + ';">'
                            + skillCount + ' skills<br>Last: ' + lastLogin
                            + '</div>'
                            + '</div></div>';
                    });
                    html += '</div>';
                    
                    document.getElementById('adminContent').innerHTML = html;
                })
                .catch(function(err) {
                    document.getElementById('adminContent').innerHTML = '<div style="color:#ef4444;">Error loading users: ' + err.message + '</div>';
                });
        }
        window.showAdminPanel = showAdminPanel;
        
        function saveAdminThresholds() {
            ['Competent','Proficient','Advanced','Expert','Mastery'].forEach(function(level) {
                var el = document.getElementById('threshold_' + level);
                if (el) evidenceConfig.thresholds[level] = parseInt(el.value) || evidenceConfig.thresholds[level];
            });
            var certFloorEl = document.getElementById('threshold_certFloor');
            if (certFloorEl) {
                evidenceConfig.certFloor = certFloorEl.value;
                evidenceConfig.certFloorPoints = evidenceConfig.thresholds[certFloorEl.value] || 5;
            }
            var verifyMultEl = document.getElementById('threshold_verifyMult');
            if (verifyMultEl) evidenceConfig.verificationMultiplier = parseFloat(verifyMultEl.value) || 1.5;
            
            saveEvidenceConfig();
            showToast('Evidence thresholds updated. Valuations will recalculate.', 'success');
        }
        window.saveAdminThresholds = saveAdminThresholds;
        
        function resetAdminThresholds() {
            evidenceConfig.thresholds = { 'Competent': 2, 'Proficient': 5, 'Advanced': 10, 'Expert': 18, 'Mastery': 28 };
            evidenceConfig.certFloor = 'Proficient';
            evidenceConfig.certFloorPoints = 5;
            evidenceConfig.verificationMultiplier = 1.5;
            saveEvidenceConfig();
            // Update UI
            ['Competent','Proficient','Advanced','Expert','Mastery'].forEach(function(level) {
                var el = document.getElementById('threshold_' + level);
                if (el) el.value = evidenceConfig.thresholds[level];
            });
            var certFloorEl = document.getElementById('threshold_certFloor');
            if (certFloorEl) certFloorEl.value = 'Proficient';
            var verifyMultEl = document.getElementById('threshold_verifyMult');
            if (verifyMultEl) verifyMultEl.value = '1.5';
            showToast('Thresholds reset to defaults.', 'info');
        }
        window.resetAdminThresholds = resetAdminThresholds;
        
        // ===== ADMIN WAITLIST MANAGEMENT =====
        function loadAdminWaitlist() {
            if (!fbIsAdmin || !fbDb) return;
            var container = document.getElementById('adminWaitlistContent');
            if (!container) return;
            
            container.innerHTML = '<div style="text-align:center; padding:20px; color:' + tv('#9ca3af','#64748b') + ';">Loading waitlist...</div>';
            
            fbDb.collection('waitlist').orderBy('createdAt', 'desc').get().then(function(snapshot) {
                var waiting = [];
                var invited = [];
                
                snapshot.forEach(function(doc) {
                    var d = doc.data();
                    d._id = doc.id;
                    if (d.status === 'invited') invited.push(d);
                    else waiting.push(d);
                });
                
                var html = '<div style="display:flex; gap:16px; margin-bottom:20px; flex-wrap:wrap;">'
                    + '<div style="flex:1; min-width:120px; padding:14px; background:' + tv('rgba(96,165,250,0.1)','rgba(59,130,246,0.08)') + '; border-radius:10px; text-align:center;">'
                    + '<div style="font-size:1.6em; font-weight:700; color:#60a5fa;">' + (waiting.length + invited.length) + '</div>'
                    + '<div style="font-size:0.78em; color:' + tv('#9ca3af','#64748b') + ';">Total</div></div>'
                    + '<div style="flex:1; min-width:120px; padding:14px; background:' + tv('rgba(251,191,36,0.1)','rgba(245,158,11,0.08)') + '; border-radius:10px; text-align:center;">'
                    + '<div style="font-size:1.6em; font-weight:700; color:#fbbf24;">' + waiting.length + '</div>'
                    + '<div style="font-size:0.78em; color:' + tv('#9ca3af','#64748b') + ';">Waiting</div></div>'
                    + '<div style="flex:1; min-width:120px; padding:14px; background:' + tv('rgba(16,185,129,0.1)','rgba(16,185,129,0.08)') + '; border-radius:10px; text-align:center;">'
                    + '<div style="font-size:1.6em; font-weight:700; color:#10b981;">' + invited.length + '</div>'
                    + '<div style="font-size:0.78em; color:' + tv('#9ca3af','#64748b') + ';">Invited</div></div>'
                    + '</div>';
                
                if (waiting.length > 0) {
                    html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">'
                        + '<div style="font-weight:700; color:' + tv('#e0e0e0','#1e293b') + ';">Waiting (' + waiting.length + ')</div>'
                        + '<button onclick="bulkInviteWaitlist()" style="padding:6px 16px; background:#10b981; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.82em;">Invite All</button>'
                        + '</div>';
                    
                    html += '<div style="display:grid; gap:8px; margin-bottom:20px;">';
                    waiting.forEach(function(user) {
                        var created = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : '?';
                        html += '<div style="padding:12px 16px; background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; '
                            + 'border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + '; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">'
                            + '<div>'
                            + '<strong style="color:' + tv('#e0e0e0','#1e293b') + ';">' + (user.name || 'Anonymous') + '</strong>'
                            + '<span style="font-size:0.75em; padding:2px 8px; margin-left:8px; border-radius:10px; background:' + tv('rgba(251,191,36,0.15)','rgba(245,158,11,0.1)') + '; color:#fbbf24;">' + (user.type || 'individual') + '</span>'
                            + '<div style="font-size:0.8em; color:' + tv('#9ca3af','#64748b') + ';">' + (user.email || '') + ' \u00B7 #' + (user.position || '?') + ' \u00B7 ' + created + '</div>'
                            + '</div>'
                            + '<button onclick="inviteWaitlistUser(\'' + user._id + '\', \'' + (user.name || '').replace(/'/g,"\\'") + '\')" '
                            + 'style="padding:6px 14px; background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.8em; white-space:nowrap;">Invite</button>'
                            + '</div>';
                    });
                    html += '</div>';
                }
                
                if (invited.length > 0) {
                    html += '<div style="font-weight:700; color:' + tv('#e0e0e0','#1e293b') + '; margin-bottom:10px;">Invited (' + invited.length + ')</div>';
                    html += '<div style="display:grid; gap:6px;">';
                    invited.forEach(function(user) {
                        html += '<div style="padding:10px 14px; background:' + tv('rgba(16,185,129,0.06)','rgba(16,185,129,0.04)') + '; '
                            + 'border:1px solid ' + tv('rgba(16,185,129,0.15)','rgba(16,185,129,0.1)') + '; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">'
                            + '<div>'
                            + '<strong style="color:' + tv('#e0e0e0','#1e293b') + ';">' + (user.name || 'Anonymous') + '</strong>'
                            + ' <span style="font-size:0.75em; color:#10b981;">\u2714 Invited</span>'
                            + '<div style="font-size:0.8em; color:' + tv('#9ca3af','#64748b') + ';">' + (user.email || '') + '</div>'
                            + '</div></div>';
                    });
                    html += '</div>';
                }
                
                if (waiting.length === 0 && invited.length === 0) {
                    html += '<div style="text-align:center; padding:20px; color:' + tv('#9ca3af','#64748b') + ';">No waitlist entries yet.</div>';
                }
                
                container.innerHTML = html;
            }).catch(function(err) {
                container.innerHTML = '<div style="color:#ef4444;">Error: ' + err.message + '</div>';
            });
        }
        window.loadAdminWaitlist = loadAdminWaitlist;
        
        function inviteWaitlistUser(docId, name) {
            if (!fbDb) return;
            fbDb.collection('waitlist').doc(docId).update({ status: 'invited' }).then(function() {
                showToast('Invited ' + (name || docId) + '!', 'success');
                loadAdminWaitlist(); // Refresh
            }).catch(function(err) {
                showToast('Invite failed: ' + err.message, 'error');
            });
        }
        window.inviteWaitlistUser = inviteWaitlistUser;
        
        function bulkInviteWaitlist() {
            if (!fbDb) return;
            if (!confirm('Invite ALL waiting users? This cannot be undone.')) return;
            
            fbDb.collection('waitlist').where('status', '==', 'waiting').get().then(function(snapshot) {
                var batch = fbDb.batch();
                snapshot.forEach(function(doc) {
                    batch.update(doc.ref, { status: 'invited' });
                });
                return batch.commit().then(function() { return snapshot.size; });
            }).then(function(count) {
                showToast('Invited ' + count + ' users!', 'success');
                loadAdminWaitlist();
            }).catch(function(err) {
                showToast('Bulk invite failed: ' + err.message, 'error');
            });
        }
        window.bulkInviteWaitlist = bulkInviteWaitlist;

        // ===== ENHANCED SAVE (Firestore + localStorage) =====
        function saveAll() {
            if (readOnlyGuard()) return;
            saveUserData(); // localStorage for userData
            saveValues(); // localStorage for values
            if (fbUser && fbDb) {
                saveToFirestore();
            }
        }
        window.saveAll = saveAll;

        // ===== READ-ONLY MODE =====
        var isReadOnlyProfile = false;  // True when viewing a sample profile as non-admin

        function checkReadOnly() {
            var templateId = userData.templateId || '';
            var isSample = templateId.indexOf('demo') !== -1 || templateId.indexOf('sample') !== -1;
            if (!isSample && window.profilesManifest && window.profilesManifest.profiles) {
                isSample = window.profilesManifest.profiles.some(function(p) { return p.id === templateId; });
            }
            isReadOnlyProfile = isSample && !fbIsAdmin;
            
            // Toggle body class for CSS-based enforcement
            document.body.classList.toggle('readonly-mode', isReadOnlyProfile);
            
            // Show/hide readonly banner
            var banner = document.getElementById('readonlyBanner');
            if (isReadOnlyProfile) {
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = 'readonlyBanner';
                    banner.className = 'readonly-banner';
                    var bannerCTA = appMode === 'waitlisted'
                        ? '\uD83D\uDD12 You\u2019re #<span id="bannerPosition">' + (waitlistPosition || '...') + '</span> on the waitlist. Explore sample profiles while you wait.'
                        : '\uD83D\uDD12 You\u2019re viewing a sample profile. '
                          + '<a href="#" onclick="event.preventDefault(); showWaitlist();" style="color:inherit; text-decoration:underline; font-weight:700;">Join the waitlist</a> for early access '
                          + 'or <a href="#" onclick="event.preventDefault(); showAuthModal(\'signup\');" style="color:inherit; text-decoration:underline;">sign in</a>.';
                    banner.innerHTML = bannerCTA;
                    var header = document.querySelector('.header');
                    if (header) header.parentNode.insertBefore(banner, header.nextSibling);
                }
                banner.style.display = '';
            } else {
                if (banner) banner.style.display = 'none';
            }
        }
        window.checkReadOnly = checkReadOnly;
        function readOnlyGuard() {
            if (isReadOnlyProfile) {
                demoGate('edit this profile');
                return true;
            }
            return false;
        }
        
        // ===== DEMO MODE & WAITLIST SYSTEM =====
        // Modes: 'demo' (no account), 'waitlisted' (signed up), 'invited' (admin unlocked), 'active' (full user)
        var appMode = 'demo';
        var waitlistPosition = null;
        var waitlistEmail = null;
        
        function detectAppMode() {
            // Admins always get full access
            if (fbUser && fbIsAdmin) {
                appMode = 'active';
                return;
            }
            // Active Firestore user with data = active
            if (fbUser && userData.templateId && userData.templateId.indexOf('firestore') !== -1) {
                appMode = 'active';
                return;
            }
            // Check localStorage for waitlist status
            var wlData = safeGet('blueprint_waitlist');
            if (wlData) {
                try {
                    var parsed = JSON.parse(wlData);
                    if (parsed.status === 'invited') { appMode = 'invited'; return; }
                    if (parsed.status === 'waiting') {
                        appMode = 'waitlisted';
                        waitlistPosition = parsed.position || null;
                        waitlistEmail = parsed.email || null;
                        return;
                    }
                } catch(e) {}
            }
            // Logged-in user viewing samples
            if (fbUser) { appMode = 'invited'; return; }
            // Default
            appMode = 'demo';
        }
        
        function demoGate(featureName) {
            if (appMode === 'active' || appMode === 'invited') return false;
            
            var msg = appMode === 'waitlisted'
                ? 'You\u2019re #' + (waitlistPosition || '?') + ' on the waitlist! We\u2019ll unlock <strong>' + featureName + '</strong> when it\u2019s your turn.'
                : 'Join the waitlist to unlock <strong>' + featureName + '</strong> and build your own Blueprint.';
            var btnText = appMode === 'waitlisted' ? 'Check Your Position' : 'Join the Waitlist';
            var btnAction = appMode === 'waitlisted' ? "closeExportModal(); showToast('You are #" + (waitlistPosition || '?') + " on the waitlist. We will be in touch!', 'info');" : 'closeExportModal(); showWaitlist();';
            
            // Show as a modal overlay
            var modal = document.getElementById('exportModal');
            var modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left"><h2 class="modal-title">\uD83D\uDD12 Early Access Feature</h2></div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:40px 32px; text-align:center;">'
                + '<div style="font-size:2.8em; margin-bottom:16px; opacity:0.8;">\u25C8</div>'
                + '<div style="font-size:1.1em; color:var(--text-primary); margin-bottom:8px; font-weight:600;">This feature is available to invited members</div>'
                + '<div style="font-size:0.9em; color:var(--text-secondary); margin-bottom:24px; line-height:1.6;">' + msg + '</div>'
                + '<button onclick="' + btnAction + '" style="padding:12px 32px; border-radius:10px; border:none; background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; font-weight:700; font-size:0.95em; cursor:pointer;">' + btnText + '</button>'
                + '<div style="margin-top:16px; font-size:0.78em; color:var(--text-muted);">Explore sample profiles in the meantime \u2014 they\u2019re fully interactive.</div>'
                + '</div>';
            
            history.pushState({ modal: true }, '');
            modal.classList.add('active');
            return true;
        }
        window.demoGate = demoGate;
        
        // Gated feature helper — returns a gated-prompt HTML block for inline use
        function gatedPromptHTML(featureName, description) {
            if (appMode === 'active' || appMode === 'invited') return '';
            var btnAction = appMode === 'waitlisted' ? "showToast('You are on the waitlist! We will unlock this soon.', 'info')" : 'showWaitlist()';
            var btnText = appMode === 'waitlisted' ? 'You\u2019re on the list \u2714' : 'Join Waitlist for Access';
            return '<div class="gated-prompt">'
                + '<div class="gp-icon">\uD83D\uDD12</div>'
                + '<div class="gp-title">' + featureName + '</div>'
                + '<div class="gp-text">' + description + '</div>'
                + '<button class="gp-btn" onclick="' + btnAction + '">' + btnText + '</button>'
                + '</div>';
        }
        window.gatedPromptHTML = gatedPromptHTML;
        
        // ===== WAITLIST MODAL =====
        function showWaitlist(source) {
            var overlay = document.getElementById('waitlistOverlay');
            if (!overlay) return;
            
            // If already waitlisted, show confirmation view
            if (appMode === 'waitlisted') {
                document.getElementById('waitlistFormView').style.display = 'none';
                document.getElementById('waitlistConfirmView').style.display = 'block';
                document.getElementById('wlPositionMsg').textContent = 'You\u2019re #' + (waitlistPosition || '?') + ' on the waitlist.';
                document.getElementById('wlPositionBadge').innerHTML = '\u25C8 Position #' + (waitlistPosition || '?');
            } else {
                document.getElementById('waitlistFormView').style.display = 'block';
                document.getElementById('waitlistConfirmView').style.display = 'none';
            }
            
            overlay.classList.add('active');
            var nameInput = document.getElementById('wlName');
            if (nameInput && !nameInput.value) setTimeout(function() { nameInput.focus(); }, 200);
        }
        window.showWaitlist = showWaitlist;
        
        function closeWaitlist() {
            var overlay = document.getElementById('waitlistOverlay');
            if (overlay) overlay.classList.remove('active');
        }
        window.closeWaitlist = closeWaitlist;
        
        function submitWaitlist() {
            var name = (document.getElementById('wlName').value || '').trim();
            var email = (document.getElementById('wlEmail').value || '').trim();
            var type = document.getElementById('wlType').value;
            
            if (!name || !email) {
                showToast('Please enter your name and email.', 'warning');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('Please enter a valid email address.', 'warning');
                return;
            }
            
            var btn = document.getElementById('wlSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'Joining...';
            
            // Try Firestore first, fallback to localStorage
            if (fbDb) {
                // Get current count for position
                fbDb.collection('waitlist').get().then(function(snapshot) {
                    var position = snapshot.size + 1;
                    
                    return fbDb.collection('waitlist').doc(email.toLowerCase().replace(/[^a-z0-9]/g, '_')).set({
                        name: name,
                        email: email.toLowerCase(),
                        type: type || 'individual',
                        status: 'waiting',
                        position: position,
                        source: 'app',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(function() {
                        return position;
                    });
                }).then(function(position) {
                    onWaitlistSuccess(name, email, position);
                }).catch(function(err) {
                    console.warn('Firestore waitlist error, using localStorage:', err);
                    onWaitlistSuccess(name, email, Math.floor(Math.random() * 50) + 10);
                });
            } else {
                // Offline fallback
                var position = Math.floor(Math.random() * 50) + 10;
                onWaitlistSuccess(name, email, position);
            }
        }
        window.submitWaitlist = submitWaitlist;
        
        function onWaitlistSuccess(name, email, position) {
            waitlistPosition = position;
            waitlistEmail = email;
            appMode = 'waitlisted';
            
            // Persist
            safeSet('blueprint_waitlist', JSON.stringify({
                name: name,
                email: email,
                status: 'waiting',
                position: position,
                joinedAt: new Date().toISOString()
            }));
            
            // Update UI
            document.getElementById('waitlistFormView').style.display = 'none';
            document.getElementById('waitlistConfirmView').style.display = 'block';
            document.getElementById('wlPositionMsg').textContent = 'You\u2019re #' + position + ' on the waitlist. We\u2019ll notify you when it\u2019s your turn.';
            document.getElementById('wlPositionBadge').innerHTML = '\u25C8 Position #' + position;
            
            var btn = document.getElementById('wlSubmitBtn');
            btn.disabled = false;
            btn.textContent = 'Join the Waitlist';
            
            // Update readonly banner
            var banner = document.getElementById('readonlyBanner');
            if (banner) {
                banner.innerHTML = '\uD83D\uDD12 You\u2019re #' + position + ' on the waitlist. Explore sample profiles while you wait.';
            }
            
            showToast('Welcome, ' + name + '! You\u2019re #' + position + ' on the waitlist.', 'success');
        }
        
        // Check if waitlisted user has been invited (on app load)
        function checkWaitlistInviteStatus() {
            if (appMode !== 'waitlisted' || !waitlistEmail || !fbDb) return;
            
            var docId = waitlistEmail.toLowerCase().replace(/[^a-z0-9]/g, '_');
            fbDb.collection('waitlist').doc(docId).get().then(function(doc) {
                if (doc.exists) {
                    var data = doc.data();
                    if (data.status === 'invited') {
                        appMode = 'invited';
                        safeSet('blueprint_waitlist', JSON.stringify({
                            name: data.name,
                            email: data.email,
                            status: 'invited',
                            position: data.position
                        }));
                        
                        // Show welcome modal
                        showToast('\uD83C\uDF89 You\u2019ve been invited! Full access is now unlocked.', 'success');
                        var banner = document.getElementById('readonlyBanner');
                        if (banner) banner.style.display = 'none';
                    }
                }
            }).catch(function(e) { console.warn('Waitlist status check failed:', e); });
        }
        
        // FOMO counter — show today's signups
        function updateWaitlistCounter() {
            if (!fbDb) return;
            var today = new Date();
            today.setHours(0,0,0,0);
            
            fbDb.collection('waitlist')
                .where('createdAt', '>=', today)
                .get().then(function(snapshot) {
                    var count = snapshot.size;
                    if (count > 0) {
                        var hint = document.getElementById('wlSkillHint');
                        if (hint) hint.innerHTML = '\uD83D\uDD25 <strong>' + count + ' professional' + (count > 1 ? 's' : '') + '</strong> joined today. How many skills do you think you have?';
                    }
                }).catch(function() {});
        }

        // ===== WELCOME / LANDING PAGE =====
        function renderWelcomePage() {
            var el = document.getElementById('welcomeView');
            if (!el) return;
            var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            
            el.innerHTML = ''
                // Hero section: text left, nothing behind
                + '<div style="max-width:920px; margin:0 auto; padding:48px 24px 0;">'
                
                // Headline + subtitle + CTAs
                + '<div style="text-align:center; margin-bottom:32px;">'
                + '<h2 style="font-size:2.6em; font-weight:700; color:var(--accent); margin-bottom:14px; line-height:1.12;">'
                + 'Know Your Worth.<br>Own Your Narrative.</h2>'
                + '<p style="font-size:1.08em; color:var(--text-secondary); line-height:1.7; max-width:560px; margin:0 auto 28px;">'
                + 'Map your skills, quantify your market value, and build the professional story '
                + 'you need for your next opportunity.</p>'
                + '<div style="display:flex; gap:14px; justify-content:center; flex-wrap:wrap; margin-bottom:40px;">'
                + '<button onclick="viewSampleProfile()" style="'
                + 'padding:14px 28px; border-radius:10px; font-size:0.95em; font-weight:600; cursor:pointer; '
                + 'background:transparent; color:var(--accent); border:2px solid var(--accent); transition:all 0.2s;'
                + '">' + bpIcon('users',16) + ' View Sample Profiles</button>'
                + '<button onclick="' + (appMode === 'active' || appMode === 'invited' ? 'showOnboardingWizard()' : 'showWaitlist()') + '" style="'
                + 'padding:14px 28px; border-radius:10px; font-size:0.95em; font-weight:600; cursor:pointer; '
                + 'background:var(--accent); color:#fff; border:2px solid var(--accent); transition:all 0.2s;'
                + '">\u25C8 ' + (appMode === 'waitlisted' ? 'You\u2019re on the List!' : 'Get Early Access') + '</button>'
                + '</div>'
                + '</div>'
                
                // Network showcase - frameless, breathes into the page
                + '<div style="position:relative; width:100%; height:360px; margin-bottom:4px;">'
                + '<canvas id="heroNetworkCanvas" style="width:100%; height:100%; display:block;"></canvas>'
                + '</div>'
                + '<div style="text-align:center; font-size:0.78em; color:var(--text-muted); margin-bottom:48px;">'
                + 'Interactive skills network \u2014 each node is a skill, grouped by professional role</div>'
                
                + '</div>'

                // How it works
                + '<div style="max-width:820px; margin:0 auto; padding:0 24px 48px;">'
                + '<div style="text-align:center; margin-bottom:32px;">'
                + '<div style="font-size:0.8em; text-transform:uppercase; letter-spacing:2px; color:var(--text-muted);">How It Works</div>'
                + '</div>'
                
                + '<div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:24px; margin-bottom:48px;" class="welcome-steps-grid">'
                
                + '<div style="text-align:center; padding:20px 16px;">'
                + '<div style="width:44px; height:44px; border-radius:50%; background:rgba(96,165,250,0.12); '
                + 'display:flex; align-items:center; justify-content:center; margin:0 auto 12px; font-size:1.2em; color:var(--accent); font-weight:700;">1</div>'
                + '<div style="font-weight:600; color:var(--text-primary); margin-bottom:5px; font-size:0.95em;">Upload Your Resume</div>'
                + '<div style="font-size:0.83em; color:var(--text-muted); line-height:1.5;">'
                + 'AI parses your experience and maps it to 13,960+ O*NET skills with proficiency levels.</div>'
                + '</div>'
                
                + '<div style="text-align:center; padding:20px 16px;">'
                + '<div style="width:44px; height:44px; border-radius:50%; background:rgba(16,185,129,0.12); '
                + 'display:flex; align-items:center; justify-content:center; margin:0 auto 12px; font-size:1.2em; color:#10b981; font-weight:700;">2</div>'
                + '<div style="font-weight:600; color:var(--text-primary); margin-bottom:5px; font-size:0.95em;">See Your Value</div>'
                + '<div style="font-size:0.83em; color:var(--text-muted); line-height:1.5;">'
                + 'Market valuation based on skill rarity, impact tier, and location with negotiation guidance.</div>'
                + '</div>'
                
                + '<div style="text-align:center; padding:20px 16px;">'
                + '<div style="width:44px; height:44px; border-radius:50%; background:rgba(251,191,36,0.12); '
                + 'display:flex; align-items:center; justify-content:center; margin:0 auto 12px; font-size:1.2em; color:#fbbf24; font-weight:700;">3</div>'
                + '<div style="font-weight:600; color:var(--text-primary); margin-bottom:5px; font-size:0.95em;">Own Your Story</div>'
                + '<div style="font-size:0.83em; color:var(--text-muted); line-height:1.5;">'
                + 'Export a professional blueprint with outcomes, values, and strategic positioning.</div>'
                + '</div>'
                
                + '</div>'

                // Sign in
                + '<div style="text-align:center; color:var(--text-muted); font-size:0.9em; margin-bottom:24px;">'
                + 'Already have an account? <a href="#" onclick="event.preventDefault(); showAuthModal(\x27signin\x27);" style="color:var(--accent); text-decoration:underline;">Sign in</a>'
                + '</div>'

                // Disclaimer
                + '<div style="text-align:center; padding:16px; background:' + tv('rgba(251,191,36,0.06)','rgba(251,191,36,0.04)') + '; '
                + 'border:1px solid ' + tv('rgba(251,191,36,0.2)','rgba(251,191,36,0.12)') + '; border-radius:8px; '
                + 'font-size:0.78em; color:' + tv('#9ca3af','#64748b') + '; line-height:1.5;">'
                + 'This is a demonstration project. Data and valuations are illustrative, not professional advice. '
                + '<a href="#" onclick="event.preventDefault(); switchView(\x27consent\x27);" style="color:inherit; text-decoration:underline;">Full disclaimer</a>.'
                + '</div>'
                + '</div>';
            
            setTimeout(function() { initHeroNetwork(); }, 50);
        }
        window.renderWelcomePage = renderWelcomePage;

        // ===== ANIMATED HERO NETWORK =====
        function initHeroNetwork() {
            var canvas = document.getElementById('heroNetworkCanvas');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            var dpr = window.devicePixelRatio || 1;
            var rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            var W = rect.width;
            var H = rect.height;
            var centerX = W / 2, centerY = H / 2;
            
            var isDark = document.documentElement.getAttribute('data-theme') !== 'light';
            var colors = ['#60a5fa', '#f472b6', '#34d399', '#fbbf24', '#a78bfa', '#fb923c', '#22d3ee', '#f87171'];
            var domainNames = ['Strategy', 'Leadership', 'Analytics', 'Innovation', 'Communication', 'Technology', 'Operations', 'Finance'];
            
            var nodes = [];
            var numNodes = 40;
            
            // Center - fixed sun
            nodes.push({ angle: 0, dist: 0, speed: 0, r: 20, color: '#60a5fa', alpha: 0.95, label: 'YOU', isCenter: true, isHub: false, domain: -1, x: centerX, y: centerY });
            
            // Domain hubs - planets in distinct orbital bands
            // Spread across 3 orbital bands so they have room
            // Inner band (~58-68), middle band (~78-90), outer band (~100-115)
            var hubConfigs = [
                { dist: 60,  speed: -0.085, band: 0 }, // Strategy
                { dist: 105, speed: -0.032, band: 2 }, // Leadership
                { dist: 80,  speed: -0.052, band: 1 }, // Analytics
                { dist: 68,  speed: -0.072, band: 0 }, // Innovation
                { dist: 92,  speed: -0.042, band: 1 }, // Communication
                { dist: 112, speed: -0.028, band: 2 }, // Technology
                { dist: 75,  speed: -0.058, band: 1 }, // Operations
                { dist: 100, speed: -0.035, band: 2 }, // Finance
            ];
            
            for (var d = 0; d < 8; d++) {
                var cfg = hubConfigs[d];
                // Spread starting angles more evenly with mild jitter
                var baseAngle = (d / 8) * Math.PI * 2 - Math.PI / 2;
                var jitter = (Math.random() - 0.5) * 0.3;
                nodes.push({
                    angle: baseAngle + jitter, dist: cfg.dist,
                    speed: cfg.speed, baseSpeed: cfg.speed,
                    r: 11 + Math.random() * 4, color: colors[d], alpha: 0.7,
                    label: domainNames[d], isCenter: false, isHub: true, domain: d,
                    x: 0, y: 0
                });
            }
            
            // Skill nodes - satellites
            for (var i = 9; i < numNodes; i++) {
                var dom = Math.floor(Math.random() * 8);
                var parentIdx = dom + 1;
                var parent = nodes[parentIdx];
                var spread = 18 + Math.random() * 45;
                var a = Math.random() * Math.PI * 2;
                var localX = Math.cos(parent.angle) * parent.dist + Math.cos(a) * spread;
                var localY = Math.sin(parent.angle) * parent.dist + Math.sin(a) * spread;
                var nodeDist = Math.sqrt(localX * localX + localY * localY);
                var nodeAngle = Math.atan2(localY, localX);
                var speedVar = 1 + (Math.random() - 0.5) * 0.25;
                nodes.push({
                    angle: nodeAngle, dist: nodeDist,
                    speed: parent.speed * speedVar, baseSpeed: parent.speed * speedVar,
                    r: 2.5 + Math.random() * 3.5, color: colors[dom],
                    alpha: 0.35 + Math.random() * 0.3, label: '',
                    isCenter: false, isHub: false, domain: dom, x: 0, y: 0
                });
            }
            
            // Links
            var links = [];
            for (var d = 1; d <= 8; d++) links.push({ source: 0, target: d, strength: 0.6 });
            for (var i = 9; i < numNodes; i++) {
                links.push({ source: nodes[i].domain + 1, target: i, strength: 0.3 });
                if (Math.random() < 0.12) {
                    var od = Math.floor(Math.random() * 8) + 1;
                    if (od !== nodes[i].domain + 1) links.push({ source: i, target: od, strength: 0.08 });
                }
            }
            
            // Minimum distance between hub centers (sum of radii + padding)
            var HUB_MIN_DIST = 38;
            var HUB_REPEL_RANGE = 65;
            
            // === CLICK-EMIT PARTICLES ===
            var particles = [];
            var clickedNode = -1;
            var clickGlow = 0;
            var clickTimer = 1.2;
            var emitDone = false;
            var clickable = [];
            for (var i = 1; i < numNodes; i++) clickable.push(i);
            
            function startClick() {
                clickedNode = clickable[Math.floor(Math.random() * clickable.length)];
                clickGlow = 0; emitDone = false; particles = [];
            }
            
            function emitParticles() {
                var n = nodes[clickedNode];
                var count = 3 + Math.floor(Math.random() * 2);
                for (var i = 0; i < count; i++) {
                    var angle = (i / count) * Math.PI * 2 + (Math.random() * 0.5 - 0.25);
                    var speed = 28 + Math.random() * 18;
                    particles.push({
                        ox: 0, oy: 0,
                        tx: Math.cos(angle) * speed, ty: Math.sin(angle) * speed,
                        r: 2 + Math.random() * 1.5, color: n.color,
                        phase: 0, progress: 0
                    });
                }
                emitDone = true;
            }
            
            var animId = null;
            var lastTime = performance.now();
            
            function draw(now) {
                var dt = Math.min((now - lastTime) / 1000, 0.05);
                lastTime = now;
                
                // Update hub angles
                for (var i = 1; i <= 8; i++) {
                    nodes[i].speed = nodes[i].baseSpeed; // reset to base each frame
                }
                
                // Hub-hub gravitational repulsion (angular nudge)
                for (var i = 1; i <= 8; i++) {
                    for (var j = i + 1; j <= 8; j++) {
                        var ni = nodes[i], nj = nodes[j];
                        // Compute current positions
                        var xi = centerX + Math.cos(ni.angle) * ni.dist;
                        var yi = centerY + Math.sin(ni.angle) * ni.dist;
                        var xj = centerX + Math.cos(nj.angle) * nj.dist;
                        var yj = centerY + Math.sin(nj.angle) * nj.dist;
                        var dx = xj - xi, dy = yj - yi;
                        var dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < HUB_REPEL_RANGE) {
                            // Repulsion strength: stronger as they get closer
                            var strength = (1 - dist / HUB_REPEL_RANGE);
                            strength = strength * strength * 0.15; // quadratic falloff
                            
                            // Determine which direction to nudge angularly
                            // Cross product of position vectors tells us relative angular order
                            var cross = Math.cos(ni.angle) * Math.sin(nj.angle) - Math.sin(ni.angle) * Math.cos(nj.angle);
                            
                            if (cross > 0) {
                                // j is ahead of i angularly - push i back, j forward
                                ni.speed -= strength;
                                nj.speed += strength;
                            } else {
                                ni.speed += strength;
                                nj.speed -= strength;
                            }
                            
                            // Also nudge orbital distance apart slightly
                            if (dist < HUB_MIN_DIST) {
                                var pushStr = (1 - dist / HUB_MIN_DIST) * 8;
                                if (ni.dist <= nj.dist) {
                                    ni.dist = Math.max(50, ni.dist - pushStr * dt);
                                    nj.dist = Math.min(120, nj.dist + pushStr * dt);
                                } else {
                                    nj.dist = Math.max(50, nj.dist - pushStr * dt);
                                    ni.dist = Math.min(120, ni.dist + pushStr * dt);
                                }
                            }
                        }
                    }
                }
                
                // Apply orbital motion
                for (var i = 1; i < nodes.length; i++) {
                    var n = nodes[i];
                    n.angle += n.speed * dt;
                    n.x = centerX + Math.cos(n.angle) * n.dist;
                    n.y = centerY + Math.sin(n.angle) * n.dist;
                }
                
                // Click state machine
                if (clickedNode === -1) {
                    clickTimer -= dt;
                    if (clickTimer <= 0) { startClick(); clickTimer = 1.2 + Math.random() * 0.8; }
                } else {
                    clickGlow = Math.min(clickGlow + dt * 4.5, 1);
                    if (!emitDone && clickGlow >= 0.45) emitParticles();
                    var allDone = emitDone;
                    for (var i = 0; i < particles.length; i++) {
                        var p = particles[i];
                        p.progress += dt * 1.3;
                        if (p.progress < 0.45) {
                            var t = p.progress / 0.45;
                            var ease = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
                            p.ox = p.tx * ease; p.oy = p.ty * ease; p.phase = 0; allDone = false;
                        } else if (p.progress < 0.55) {
                            p.ox = p.tx; p.oy = p.ty; p.phase = 1; allDone = false;
                        } else if (p.progress < 1.0) {
                            var t = (p.progress - 0.55) / 0.45;
                            var ease = t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
                            p.ox = p.tx * (1 - ease); p.oy = p.ty * (1 - ease); p.phase = 2; allDone = false;
                        } else { p.ox = 0; p.oy = 0; p.phase = 3; }
                    }
                    if (allDone && emitDone) {
                        clickGlow = Math.max(clickGlow - dt * 3.5, 0);
                        if (clickGlow <= 0) { clickedNode = -1; particles = []; }
                    }
                }
                
                ctx.clearRect(0, 0, W, H);
                
                // Draw links
                for (var i = 0; i < links.length; i++) {
                    var l = links[i]; var s = nodes[l.source]; var e = nodes[l.target];
                    var dx = e.x - s.x; var dy = e.y - s.y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist > 180) continue;
                    var alpha = l.strength * (1 - dist / 180) * 0.6;
                    ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(e.x, e.y);
                    ctx.strokeStyle = isDark ? 'rgba(96,165,250,1)' : 'rgba(37,99,235,1)';
                    ctx.globalAlpha = alpha * 0.35; ctx.lineWidth = 1;
                    ctx.stroke(); ctx.globalAlpha = 1;
                }
                
                // Draw nodes
                for (var i = nodes.length - 1; i >= 0; i--) {
                    var n = nodes[i];
                    var r = n.r; var a = n.alpha;
                    var isClicked = (i === clickedNode && clickGlow > 0);
                    if (isClicked) { r = n.r * (1 + 0.25 * clickGlow); a = Math.min(n.alpha + 0.3 * clickGlow, 1); }
                    if (r > 5 || isClicked) {
                        ctx.beginPath(); ctx.arc(n.x, n.y, isClicked ? r * 3.5 : r * 2.5, 0, Math.PI * 2);
                        ctx.fillStyle = n.color; ctx.globalAlpha = isClicked ? a * 0.2 : a * 0.07;
                        ctx.fill(); ctx.globalAlpha = 1;
                    }
                    ctx.beginPath(); ctx.arc(n.x, n.y, r, 0, Math.PI * 2);
                    ctx.fillStyle = n.color; ctx.globalAlpha = a;
                    ctx.fill(); ctx.globalAlpha = 1;
                    if (n.label && (r > 6 || n.isCenter)) {
                        ctx.font = (n.isCenter ? 'bold 10px' : '8.5px') + ' "Outfit", -apple-system, system-ui, sans-serif';
                        ctx.fillStyle = isDark ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.6)';
                        ctx.textAlign = 'center';
                        ctx.fillText(n.label, n.x, n.y + r + 13);
                    }
                }
                
                // Draw particles
                if (clickedNode >= 0) {
                    var pn = nodes[clickedNode];
                    for (var i = 0; i < particles.length; i++) {
                        var p = particles[i];
                        if (p.phase >= 3) continue;
                        var fadeAlpha = p.phase === 2 ? Math.max(0, 1 - (p.progress - 0.55) / 0.45) : 1;
                        ctx.beginPath(); ctx.arc(pn.x + p.ox, pn.y + p.oy, p.r, 0, Math.PI * 2);
                        ctx.fillStyle = p.color; ctx.globalAlpha = 0.85 * fadeAlpha;
                        ctx.fill(); ctx.globalAlpha = 1;
                    }
                }
                
                animId = requestAnimationFrame(draw);
            }
            
            animId = requestAnimationFrame(draw);
            var observer = new IntersectionObserver(function(entries) {
                if (entries[0].isIntersecting) { if (!animId) { lastTime = performance.now(); animId = requestAnimationFrame(draw); } }
                else { if (animId) { cancelAnimationFrame(animId); animId = null; } }
            });
            observer.observe(canvas);
            window._heroNetworkCleanup = function() { if (animId) cancelAnimationFrame(animId); observer.disconnect(); };
        }

        function viewSampleProfile() {
            // Show sample profile picker
            var manifest = window.profilesManifest;
            var profiles = (manifest && manifest.profiles) ? manifest.profiles.filter(function(p) { return p.enabled; }) : [];
            
            if (profiles.length === 0) {
                // Fallback: just load cliff
                switchProfile('cliff-jones-demo');
                return;
            }
            
            if (profiles.length === 1) {
                // Only one sample, load it directly
                switchProfile(profiles[0].id);
                return;
            }
            
            // Multiple samples: show picker on welcome page
            var el = document.getElementById('welcomeView');
            if (!el) { switchProfile(profiles[0].id); return; }
            
            // Build picker content
            var html = '<div style="max-width:920px; margin:0 auto; padding:48px 24px 80px;">'
                + '<div style="text-align:center; margin-bottom:32px;">'
                + '<h2 style="font-size:2em; font-weight:700; color:var(--accent); margin-bottom:10px;">Sample Profiles</h2>'
                + '<p style="color:var(--text-secondary); font-size:1em; line-height:1.6;">'
                + 'Explore complete Blueprints to see how skills, outcomes, and market valuation come together.'
                + '</p></div>'
                + '<div class="welcome-cards">';
            
            profiles.forEach(function(p) {
                var initials = p.name.split(' ').map(function(w) { return w[0]; }).join('').slice(0, 2).toUpperCase();
                html += '<div class="welcome-card" onclick="switchProfile(\'' + p.id + '\')">'
                    + '<div style="display:flex; align-items:center; gap:14px; margin-bottom:12px;">'
                    + '<div style="width:48px; height:48px; border-radius:50%; background:var(--accent); color:#fff; '
                    + 'display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1.1em;">'
                    + initials + '</div>'
                    + '<div style="text-align:left;">'
                    + '<h3 style="margin:0;">' + p.name + '</h3>'
                    + '<div style="color:var(--text-muted); font-size:0.85em;">' + (p.title || '') + '</div>'
                    + '</div></div>'
                    + '<p>' + (p.description || 'View this complete Blueprint with skills, outcomes, and market valuation.') + '</p>'
                    + '</div>';
            });
            
            html += '</div>'
                + '<div style="text-align:center; margin-top:24px;">'
                + '<a href="#" onclick="event.preventDefault(); window._welcomePickerActive=false; switchView(\'welcome\');" '
                + 'style="color:var(--text-muted); font-size:0.9em; text-decoration:underline;">\u2190 Back to home</a>'
                + '</div></div>';
            
            el.innerHTML = html;
            window._welcomePickerActive = true;
            switchView('welcome');
        }
        window.viewSampleProfile = viewSampleProfile;

        function showWelcomeView() {
            switchView('welcome');
        }
        window.showWelcomeView = showWelcomeView;

        // ===== TOAST NOTIFICATION SYSTEM =====
        let toastCounter = 0;
        function showToast(message, type, duration) {
            type = type || 'info';
            duration = duration || 4000;
            const icons = { success: '\u2705', error: '\u274C', info: '\u2139\uFE0F', warning: '\u26A0\uFE0F' };
            const id = 'toast-' + (++toastCounter);
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            // Limit to 3 visible toasts - dismiss oldest
            var existing = container.querySelectorAll('.toast');
            if (existing.length >= 3) {
                dismissToast(existing[0].id);
            }
            
            const el = document.createElement('div');
            el.id = id;
            el.className = 'toast toast-' + type;
            el.innerHTML = '<span class="toast-icon">' + (icons[type] || icons.info) + '</span>'
                + '<div class="toast-body"><div class="toast-msg">' + message + '</div></div>'
                + '<button class="toast-close" onclick="dismissToast(\u0027' + id + '\u0027'
                + ')" aria-label="Close">\u00D7</button>';
            container.appendChild(el);
            requestAnimationFrame(function() {
                requestAnimationFrame(function() { el.classList.add('show'); });
            });
            var timer = setTimeout(function() { dismissToast(id); }, duration);
            el._timer = timer;
        }
        window.showToast = showToast;

        function dismissToast(id) {
            var el = document.getElementById(id);
            if (!el) return;
            clearTimeout(el._timer);
            el.classList.remove('show');
            el.classList.add('hide');
            setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 400);
        }
        window.dismissToast = dismissToast;
        
        // ===== USER DATA CONFIGURATION =====
        // This will eventually come from onboarding wizard
        
        // userData now defined in v2.0 architecture below (line ~2224)
        
        // ===== MARKET VALUATION CALCULATOR =====
        
        function calculateSkillValue(skill) {
            // Now returns IMPACT rating, not dollar value
            return getSkillImpact(skill);
        }
        
        // Valuation mode: 'evidence' (default, uses effective levels) or 'potential' (uses claimed levels)
        var valuationMode = 'evidence';
        
        function calculateTotalMarketValue(mode) {
            var useMode = mode || valuationMode || 'evidence';
            
            if (!skillsData || !skillsData.skills) {
                return { 
                    total: 0, 
                    yourWorth: 0,
                    marketRate: 0,
                    conservativeOffer: 0,
                    standardOffer: 0,
                    competitiveOffer: 0,
                    breakdown: [], 
                    roleLevel: 'Entry',
                    top10Skills: [],
                    totalPoints: 0,
                    compaRatio: 100,
                    criticalSkills: [],
                    highSkills: [],
                    criticalBonus: 0,
                    highBonus: 0,
                    rarityBonus: 0,
                    premiumAmount: 0,
                    mode: useMode,
                    roleFloor: 0,
                    roleFloorApplied: false,
                    salaryCap: 0,
                    salaryCapApplied: false
                };
            }
            
            // REDESIGNED MODEL: Function-based salary anchors + evidence premiums
            
            // Helper: get the level to use based on mode
            function getLevelForMode(skill) {
                if (useMode === 'potential') return skill.level; // Trust claimed level
                return getValuationLevel(skill); // Evidence-backed
            }
            
            // ---- STEP 1: Detect functional area from title, roles, and skills ----
            var titleStr = ((userData.profile || {}).currentTitle || '').toLowerCase();
            var rolesStr = ((userData.roles || []).map(function(r) { return r.name || ''; }).join(' ')).toLowerCase();
            var skillNames = (skillsData.skills || []).map(function(s) { return (s.name || '').toLowerCase(); }).join(' ');
            var allSignals = titleStr + ' ' + rolesStr + ' ' + skillNames;
            
            // BLS OEWS May 2024 — National cross-industry wage data
            // Base = entry:25th pct, mid:median, senior:75th, director:75th(mgr), vp:90th(mgr)
            var SALARY_TABLE = {
                education: [29120, 62340, 83010, 132550, 165820],
                engineering: [53230, 102320, 130290, 152670, 238291],
                finance: [41390, 81680, 132050, 214210, 246341],
                general: [27780, 43630, 82340, 164130, 206000],
                healthcare: [30370, 62340, 107960, 162420, 219080],
                hr: [42360, 72910, 91550, 189960, 218453],
                legal: [48190, 61010, 215420, 247732, 284891],
                marketing: [56220, 76950, 95940, 211080, 242741],
                operations: [53190, 101190, 133140, 164130, 188749],
                recruiting: [42360, 72910, 97270, 189960, 218453],
                retail: [27780, 34580, 60510, 201490, 231713],
                sales: [29140, 66260, 97570, 201490, 231713],
                strategy: [76770, 101190, 133140, 164130, 230000],
                technology: [76360, 133080, 169000, 216220, 248652],
                trades: [29060, 62350, 81730, 100200, 176990]
            };
            
            // Caps = entry:median, mid:75th, senior:90th, director:90th(mgr), vp:90th(mgr)
            var SALARY_CAP = {
                education: [35240, 79410, 104670, 165820, 198984],
                engineering: [64790, 130290, 161240, 183510, 290094],
                finance: [49210, 106450, 180550, 299894, 359872],
                general: [31190, 52560, 102980, 229781, 290000],
                healthcare: [34900, 73160, 135320, 219080, 262896],
                hr: [49440, 97270, 120190, 265944, 319132],
                legal: [61010, 78280, 93936, 301588, 361905],
                marketing: [76950, 104870, 129480, 295512, 354614],
                operations: [66140, 133140, 174140, 229781, 275737],
                recruiting: [49440, 97270, 126540, 265944, 319132],
                retail: [31190, 37850, 76560, 282086, 338503],
                sales: [34580, 98780, 134470, 282086, 338503],
                strategy: [101190, 133140, 174140, 229781, 330000],
                technology: [108970, 169000, 211450, 302708, 363249],
                trades: [35250, 81730, 99000, 126690, 176990]
            };
            
            var functionPatterns = [
                { fn: 'strategy', patterns: /\b(strategy|strategic|futurist|evangelist|thought leader|advisory|consulting|consultant)\b/ },
                { fn: 'technology', patterns: /\b(software|developer|devops|cloud|aws|azure|kubernetes|programming|frontend|backend|full.?stack|data scientist|machine learning|ai engineer|cybersecurity|infosec|cissp)\b/ },
                { fn: 'recruiting', patterns: /\b(recruit|talent acqui|sourcing|hiring|ats|applicant|staffing|headhunt)\b/ },
                { fn: 'hr', patterns: /\b(human resource|hr |shrm|people ops|workforce|talent manage|employee relation|compensation|benefits|hris|organizational develop|learning.+develop)\b/ },
                { fn: 'marketing', patterns: /\b(marketing|brand|content|seo|digital market|growth|demand gen|product market|communications|pr |public relation)\b/ },
                { fn: 'finance', patterns: /\b(finance|financial|accounting|cpa|cfa|controller|treasury|audit|tax|revenue|fp&a|investment)\b/ },
                { fn: 'sales', patterns: /\b(sales|account exec|business develop|quota|pipeline|customer success|client relation)\b/ },
                { fn: 'operations', patterns: /\b(operations|supply chain|logistics|procurement|manufacturing|quality|lean|six sigma|process improve)\b/ },
                { fn: 'healthcare', patterns: /\b(nurse|clinical|patient|medical|pharma|health|hospital|physician|therapy|diagnostic)\b/ },
                { fn: 'education', patterns: /\b(teaching|teacher|professor|instructor|curriculum|education|academic|school|training)\b/ },
                { fn: 'legal', patterns: /\b(legal|attorney|lawyer|litigation|compliance|regulatory|paralegal|contract law|bar exam)\b/ },
                { fn: 'engineering', patterns: /\b(mechanical|electrical|civil|structural|pe |professional engineer|cad|construction|architect)\b/ },
                { fn: 'trades', patterns: /\b(hair|stylist|cosmetolog|barber|plumb|electri|weld|hvac|carpenter|mechanic|technician|maintenance|repair|install)\b/ },
                { fn: 'retail', patterns: /\b(cashier|retail|store|merchandise|stock|inventory clerk|customer service rep|point of sale|pos )\b/ }
            ];
            
            // Detect function: title+roles first (strongest signal), then skills as fallback
            var detectedFunction = 'general';
            var titleAndRoles = titleStr + ' ' + rolesStr;
            for (var fi = 0; fi < functionPatterns.length; fi++) {
                if (functionPatterns[fi].patterns.test(titleAndRoles)) {
                    detectedFunction = functionPatterns[fi].fn;
                    break;
                }
            }
            // If title didn't match, try skills
            if (detectedFunction === 'general') {
                for (var fi2 = 0; fi2 < functionPatterns.length; fi2++) {
                    if (functionPatterns[fi2].patterns.test(skillNames)) {
                        detectedFunction = functionPatterns[fi2].fn;
                        break;
                    }
                }
            }
            
            // ---- STEP 2: Detect seniority from title keywords + experience ----
            var seniorityLevel = 0; // 0=entry, 1=mid, 2=senior, 3=director, 4=vp
            
            // Title-based seniority (strongest signal)
            if (/\b(ceo|cto|cfo|coo|cmo|cio|ciso|chief|c-suite|president|evp|svp)\b/.test(titleStr)) {
                seniorityLevel = 4;
            } else if (/\b(vp|vice president)\b/.test(titleStr)) {
                seniorityLevel = 4;
            } else if (/\b(senior director|sr\.? director)\b/.test(titleStr)) {
                seniorityLevel = 3;
            } else if (/\b(director|head of)\b/.test(titleStr)) {
                seniorityLevel = 3;
            } else if (/\b(senior manager|sr\.? manager|principal|lead)\b/.test(titleStr)) {
                seniorityLevel = 2;
            } else if (/\b(senior|sr\.?|manager)\b/.test(titleStr)) {
                seniorityLevel = 2;
            } else if (/\b(associate|specialist|coordinator|analyst)\b/.test(titleStr)) {
                seniorityLevel = 1;
            }
            
            // Experience-based boost (if title doesn't already set high)
            var yearsExp = parseInt(((userData.profile || {}).yearsExperience || '0').toString()) || 0;
            if (yearsExp >= 20 && seniorityLevel < 4) seniorityLevel = Math.max(seniorityLevel, 3);
            else if (yearsExp >= 12 && seniorityLevel < 3) seniorityLevel = Math.max(seniorityLevel, 2);
            else if (yearsExp >= 5 && seniorityLevel < 2) seniorityLevel = Math.max(seniorityLevel, 1);
            
            // Skill depth can also boost seniority (secondary signal)
            const masteryCount = skillsData.skills.filter(s => getLevelForMode(s) === 'Mastery').length;
            const expertCount = skillsData.skills.filter(s => getLevelForMode(s) === 'Expert').length;
            const advancedCount = skillsData.skills.filter(s => getLevelForMode(s) === 'Advanced').length;
            const proficientCount = skillsData.skills.filter(s => getLevelForMode(s) === 'Proficient').length;
            const totalSkills = skillsData.skills.length;
            const totalPoints = (masteryCount * 4) + (expertCount * 3) + (advancedCount * 2) + (proficientCount * 1);
            
            if (totalPoints >= 80 && seniorityLevel < 4) seniorityLevel = Math.max(seniorityLevel, 3);
            else if (totalPoints >= 40 && seniorityLevel < 3) seniorityLevel = Math.max(seniorityLevel, 2);
            else if (totalPoints >= 20 && seniorityLevel < 2) seniorityLevel = Math.max(seniorityLevel, 1);
            
            // ---- STEP 3: Look up base salary ----
            var salaryBand = SALARY_TABLE[detectedFunction] || SALARY_TABLE.general;
            var baseMarketRate = salaryBand[seniorityLevel];
            
            var roleLevelNames = ['Entry', 'Mid-Level', 'Senior', 'Director', 'VP/C-Suite'];
            var roleLevel = roleLevelNames[seniorityLevel];
            var percentile = seniorityLevel >= 4 ? '75th' : '50th';
            
            // Step 2: Calculate premium factors (total capped at 35% of base)
            
            // FACTOR 1: Work Styles & Soft Skills (max 8%)
            const workStyleSkills = skillsData.skills.filter(s => 
                s.category === 'workstyle' && (getLevelForMode(s) === 'Advanced' || getLevelForMode(s) === 'Expert' || getLevelForMode(s) === 'Mastery')
            );
            const workStylesPct = Math.min((workStyleSkills.length * 0.01), 0.08);
            
            // FACTOR 2: Evidence Quality (max 12%)
            let evidenceScore = 0;
            skillsData.skills.forEach(skill => {
                if (skill.evidence && skill.evidence.length > 0) {
                    skill.evidence.forEach(ev => {
                        if (ev.outcome && (ev.outcome.match(/\d+%|\$\d+|[0-9,]+/) || ev.outcome.includes('reduced') || ev.outcome.includes('increased'))) {
                            evidenceScore += 2;
                        } else if (ev.outcome) {
                            evidenceScore += 1;
                        }
                    });
                }
            });
            const evidenceQualityPct = Math.min((evidenceScore * 0.003), 0.12);
            
            // FACTOR 3: Skill Mix Rarity (max 8%)
            let rarityPct = 0;
            const hasAI = skillsData.skills.some(s => s.name.toLowerCase().includes('ai') || s.name.toLowerCase().includes('machine learning'));
            const hasPilot = skillsData.skills.some(s => s.name.toLowerCase().includes('aviation') || s.name.toLowerCase().includes('ifr'));
            const hasStrategy = skillsData.skills.some(s => s.name.toLowerCase().includes('strategic'));
            const hasTechnical = skillsData.skills.some(s => s.category === 'skill' && s.name.toLowerCase().includes('programming'));
            const hasLeadership = skillsData.skills.some(s => s.name.toLowerCase().includes('leadership') || s.name.toLowerCase().includes('management'));
            const hasCreative = skillsData.skills.some(s => s.name.toLowerCase().includes('color') || s.name.toLowerCase().includes('styling') || s.name.toLowerCase().includes('creative'));
            const hasBehavioral = skillsData.skills.some(s => s.name.toLowerCase().includes('behavioral') || s.name.toLowerCase().includes('economics'));
            
            if (hasPilot && hasStrategy) rarityPct += 0.04;
            if (hasAI && hasStrategy) rarityPct += 0.03;
            if (hasTechnical && hasLeadership) rarityPct += 0.03;
            if (hasCreative && hasTechnical) rarityPct += 0.03;
            if (hasBehavioral && hasStrategy) rarityPct += 0.02;
            rarityPct = Math.min(rarityPct, 0.08);
            
            // FACTOR 4: Critical Depth (max 5%)
            const masteryInCriticalSkills = skillsData.skills.filter(s => {
                const impact = getSkillImpact(s);
                return (getLevelForMode(s) === 'Mastery' || getLevelForMode(s) === 'Expert') && (impact.level === 'critical' || impact.level === 'high');
            });
            const criticalDepthPct = Math.min((masteryInCriticalSkills.length * 0.01), 0.05);
            
            // FACTOR 5: Learning & Growth (max 2%)
            const noviceSkills = skillsData.skills.filter(s => s.level === 'Novice');
            const learningPct = Math.min((noviceSkills.length * 0.005), 0.02);
            
            // Total premium: hard cap at 35%
            const totalPremiumPct = Math.min(workStylesPct + evidenceQualityPct + rarityPct + criticalDepthPct + learningPct, 0.35);
            
            // Calculate dollar amounts for breakdown
            const workStylesBonus = Math.round(baseMarketRate * workStylesPct);
            const evidenceBonus = Math.round(baseMarketRate * evidenceQualityPct);
            const rarityBonus = Math.round(baseMarketRate * rarityPct);
            const criticalDepthBonus = Math.round(baseMarketRate * criticalDepthPct);
            const learningBonus = Math.round(baseMarketRate * learningPct);
            const premiumAmount = workStylesBonus + evidenceBonus + rarityBonus + criticalDepthBonus + learningBonus;
            
            // Step 3: Location adjustment
            const locationMultiplier = skillValuations?.locationMultipliers?.[userData.profile.location] || 1.0;
            
            const totalValue = Math.round((baseMarketRate + premiumAmount) * locationMultiplier);
            
            // Step 4: Role-based minimum floor from user's title/roles
            var roleFloor = 0;
            // Use titleAndRoles (title + roles combined) from Step 1
            
            if (/\b(ceo|cto|cfo|coo|cmo|cio|ciso|chief|c-suite|president)\b/.test(titleAndRoles)) {
                roleFloor = 200000;
            } else if (/\b(svp|evp|senior vice president|executive vice president)\b/.test(titleAndRoles)) {
                roleFloor = 180000;
            } else if (/\b(vp|vice president)\b/.test(titleAndRoles)) {
                roleFloor = 150000;
            } else if (/\b(senior director|sr\. director|sr director)\b/.test(titleAndRoles)) {
                roleFloor = 130000;
            } else if (/\b(director)\b/.test(titleAndRoles)) {
                roleFloor = 110000;
            } else if (/\b(senior manager|sr\. manager|sr manager|principal)\b/.test(titleAndRoles)) {
                roleFloor = 95000;
            } else if (/\b(manager|lead|head of)\b/.test(titleAndRoles)) {
                roleFloor = 75000;
            } else if (/\b(senior|sr\.)\b/.test(titleAndRoles)) {
                roleFloor = 65000;
            }
            
            // Apply location multiplier to floor too
            roleFloor = Math.round(roleFloor * locationMultiplier);
            
            var finalValue = Math.max(totalValue, roleFloor);
            var roleFloorApplied = finalValue > totalValue;
            
            // Apply salary cap (90th percentile ceiling for function/seniority)
            var capBand = SALARY_CAP[detectedFunction] || SALARY_CAP.general;
            var salaryCap = Math.round((capBand[seniorityLevel] || capBand[4]) * locationMultiplier);
            var salaryCapApplied = finalValue > salaryCap;
            if (salaryCapApplied) finalValue = salaryCap;
            
            // Calculate offer ranges
            const conservativeOffer = Math.round(finalValue * 0.75);
            const standardOffer = Math.round(finalValue * 0.85);
            const competitiveOffer = Math.round(finalValue * 0.95);
            
            // Build critical/high skills for compatibility
            const criticalSkills = skillsData.skills.filter(s => {
                const impact = getSkillImpact(s);
                return impact.level === 'critical';
            });
            
            const highSkills = skillsData.skills.filter(s => {
                const impact = getSkillImpact(s);
                return impact.level === 'high';
            });
            
            // Build top10Skills for compatibility
            const top10Skills = [
                ...criticalSkills.slice(0, 5).map(s => ({ skill: s.name, level: s.level, impact: 'Critical', impactLabel: 'Critical Impact' })),
                ...highSkills.slice(0, 5).map(s => ({ skill: s.name, level: s.level, impact: 'High', impactLabel: 'High Impact' }))
            ].slice(0, 10);
            
            // Calculate compa-ratio (your worth vs base market rate)
            const compaRatio = baseMarketRate > 0 ? Math.round((finalValue / baseMarketRate) * 100) : 100;
            
            return {
                // New structure
                total: finalValue,
                baseMarketRate: baseMarketRate,
                roleLevel: roleLevel,
                criticalSkills: criticalSkills.map(s => ({ name: s.name, level: s.level })),
                highSkills: highSkills.map(s => ({ name: s.name, level: s.level })),
                
                // NEW: Premium breakdown
                workStylesBonus: workStylesBonus,
                evidenceBonus: evidenceBonus,
                rarityBonus: rarityBonus,
                criticalDepthBonus: criticalDepthBonus,
                learningBonus: learningBonus,
                
                // Backward compatibility
                criticalBonus: criticalDepthBonus,
                highBonus: evidenceBonus,
                
                // Backward compatibility fields
                yourWorth: finalValue,
                marketRate: baseMarketRate,
                conservativeOffer: conservativeOffer,
                standardOffer: standardOffer,
                competitiveOffer: competitiveOffer,
                top10Skills: top10Skills,
                totalPoints: totalPoints,
                compaRatio: compaRatio,
                premiumAmount: premiumAmount,
                domainPremium: totalPremiumPct,
                percentile: percentile,
                
                // Mode and floor info
                mode: useMode,
                roleFloor: roleFloor,
                roleFloorApplied: roleFloorApplied,
                salaryCap: salaryCap,
                salaryCapApplied: salaryCapApplied,
                rawCalculatedValue: totalValue,
                detectedFunction: detectedFunction,
                seniorityIndex: seniorityLevel,
                
                breakdown: {
                    base: baseMarketRate,
                    critical: criticalDepthBonus,
                    high: evidenceBonus,
                    rarity: rarityBonus,
                    location: locationMultiplier
                }
            };
        }
        
        function setValuationMode(mode) {
            valuationMode = mode;
            // Re-render the Blueprint content directly
            if (typeof renderBlueprint === 'function') {
                renderBlueprint();
            }
        }
        window.setValuationMode = setValuationMode;
        // [removed] getClosestRoleBenchmark — dead code cleanup v4.22.0
        
        // ===== SKILL VALUATIONS SYSTEM =====
        
        // ===== EVIDENCE QUALITY ENGINE (v4.16.0) =====
        // Outcome quality scoring: each outcome earns 1-5 evidence points based on impact
        // Effective level is derived from evidence points, not self-reported claims
        
        var evidenceConfig = {
            // Points required per effective level (admin-configurable)
            thresholds: {
                'Competent': 2,
                'Proficient': 5,
                'Advanced': 10,
                'Expert': 18,
                'Mastery': 28
            },
            // Certification floor: certs bump effective level to at least this
            certFloor: 'Proficient',
            certFloorPoints: 5,
            // Verification bonus: verified outcomes get a multiplier
            verificationMultiplier: 1.5
        };
        
        // Load/save admin-configured thresholds
        function loadEvidenceConfig() {
            try {
                var stored = safeGet('wbEvidenceConfig');
                if (stored) {
                    var parsed = JSON.parse(stored);
                    if (parsed.thresholds) evidenceConfig.thresholds = parsed.thresholds;
                    if (parsed.certFloor) evidenceConfig.certFloor = parsed.certFloor;
                    if (parsed.certFloorPoints) evidenceConfig.certFloorPoints = parsed.certFloorPoints;
                    if (parsed.verificationMultiplier) evidenceConfig.verificationMultiplier = parsed.verificationMultiplier;
                }
            } catch (e) { /* parse error */ }
        }
        loadEvidenceConfig();
        
        function saveEvidenceConfig() {
            try {
                safeSet('wbEvidenceConfig', JSON.stringify(evidenceConfig));
            } catch (e) { /* quota */ }
        }
        
        // Score a single outcome text: returns 1-5 based on impact signals
        function scoreOutcome(text) {
            if (!text || typeof text !== 'string') return 1;
            var score = 1; // Base: any outcome is worth 1 point
            var t = text.toLowerCase();
            
            // Financial impact (major)
            if (/\$[\d,.]+\s*(m|million|b|billion)/i.test(text)) score += 2;
            else if (/\$[\d,.]+/i.test(text)) score += 1;
            
            // Percentage impact
            if (/\d{2,}%/.test(text)) score += 1; // 10%+ = meaningful
            else if (/\d+%/.test(text)) score += 0.5;
            
            // Multiplier/scale language
            if (/\d+x|\d+ times/i.test(text)) score += 1;
            if (/million|billion|thousands|global|enterprise|company-wide|organization-wide|industry/i.test(text)) score += 0.5;
            
            // Scope/leadership signals
            if (/founded|created from scratch|built|designed|architected|pioneered|invented/i.test(text)) score += 0.5;
            
            // Recognition signals
            if (/award|published|patent|speaker|keynote|featured|recognized|first ever|world/i.test(text)) score += 1;
            
            // Crisis/extreme context
            if (/zero (injuries|incidents|downtime)|perfect (record|score)|saved|prevented|emergency/i.test(text)) score += 0.5;
            
            return Math.min(Math.round(score * 2) / 2, 5); // Cap at 5, allow 0.5 increments
        }
        
        // Calculate total evidence points for a skill
        function calculateEvidencePoints(skill) {
            if (!skill) return 0;
            var points = 0;
            var evidence = skill.evidence || [];
            
            evidence.forEach(function(ev) {
                var text = ((ev.outcome || '') + ' ' + (ev.description || '')).trim();
                if (!text) return;
                var outcomeScore = scoreOutcome(text);
                
                // Verification bonus: verified outcomes count more
                var verifications = getSkillVerifications(skill.name);
                var isVerified = verifications.some(function(v) { return v.status === 'confirmed'; });
                if (isVerified) {
                    outcomeScore = Math.min(outcomeScore * evidenceConfig.verificationMultiplier, 5);
                }
                
                points += outcomeScore;
            });
            
            // Certification floor check — tier-aware (highest cert wins)
            if (hasLinkedCertification(skill.name)) {
                var tier = getHighestCertTier(skill.name);
                var floorLevel = tier >= 2 ? 'Advanced' : 'Proficient';
                var floorPts = evidenceConfig.thresholds[floorLevel] || evidenceConfig.certFloorPoints;
                points = Math.max(points, floorPts);
            }
            
            return Math.round(points * 10) / 10; // one decimal
        }
        
        // Map evidence points to effective level
        function getEffectiveLevel(skill) {
            var points = calculateEvidencePoints(skill);
            return getEffectiveLevelFromPoints(points);
        }
        
        function getEffectiveLevelFromPoints(points) {
            var t = evidenceConfig.thresholds;
            if (points >= t['Mastery']) return 'Mastery';
            if (points >= t['Expert']) return 'Expert';
            if (points >= t['Advanced']) return 'Advanced';
            if (points >= t['Proficient']) return 'Proficient';
            if (points >= t['Competent']) return 'Competent';
            return 'Novice';
        }
        
        // Check if a skill has a linked certification (manual links OR library maps)
        function hasLinkedCertification(skillName) {
            var certs = userData.certifications || [];
            var sn = skillName.toLowerCase();
            return certs.some(function(c) {
                // Check manual links first
                var linkedSkills = c.linkedSkills || [];
                if (linkedSkills.some(function(ls) { return ls.toLowerCase() === sn; })) return true;
                // Check library skill maps
                var libCert = findCertInLibrary(c.name) || findCertInLibrary(c.abbr);
                if (libCert && libCert.skills) {
                    return libCert.skills.some(function(ls) { return ls.toLowerCase() === sn; });
                }
                return false;
            });
        }
        
        // Get the highest cert tier that links to this skill
        function getHighestCertTier(skillName) {
            var certs = userData.certifications || [];
            var sn = skillName.toLowerCase();
            var highestTier = 0;
            certs.forEach(function(c) {
                var isLinked = false;
                var linkedSkills = c.linkedSkills || [];
                if (linkedSkills.some(function(ls) { return ls.toLowerCase() === sn; })) isLinked = true;
                if (!isLinked) {
                    var libCert = findCertInLibrary(c.name) || findCertInLibrary(c.abbr);
                    if (libCert && libCert.skills && libCert.skills.some(function(ls) { return ls.toLowerCase() === sn; })) {
                        isLinked = true;
                        if (libCert.tier > highestTier) highestTier = libCert.tier;
                    }
                }
                if (isLinked && highestTier < 2) {
                    // Check tier from library
                    var lib = findCertInLibrary(c.name) || findCertInLibrary(c.abbr);
                    var tier = lib ? lib.tier : 1;
                    if (tier > highestTier) highestTier = tier;
                }
            });
            return highestTier;
        }
        
        // Get verifications for a skill (from verifications array on userData)
        function getSkillVerifications(skillName) {
            var all = userData.verifications || [];
            return all.filter(function(v) { return v.skillName === skillName; });
        }
        
        // Get the level used for valuation: min(claimed, effective) or effective if higher
        // The valuation engine uses the evidence-backed level, not the claim
        function getValuationLevel(skill) {
            var claimed = skill.level || 'Novice';
            var effective = getEffectiveLevel(skill);
            var claimedVal = proficiencyValue(claimed);
            var effectiveVal = proficiencyValue(effective);
            // Valuation uses whichever is LOWER — you can't claim above your evidence
            // But evidence CAN push you higher than you claimed (cert floor, etc.)
            return effectiveVal < claimedVal ? effective : claimed;
        }
        
        // Summary stats for a skill's evidence status
        function getEvidenceSummary(skill) {
            var points = calculateEvidencePoints(skill);
            var effectiveLevel = getEffectiveLevelFromPoints(points);
            var claimed = skill.level || 'Novice';
            var evidenceCount = (skill.evidence || []).length;
            var hasCert = hasLinkedCertification(skill.name);
            var verifications = getSkillVerifications(skill.name);
            var verifiedCount = verifications.filter(function(v) { return v.status === 'confirmed'; }).length;
            var pendingCount = verifications.filter(function(v) { return v.status === 'pending'; }).length;
            
            // Find next level threshold
            var nextLevel = null;
            var pointsNeeded = 0;
            var levels = ['Competent', 'Proficient', 'Advanced', 'Expert', 'Mastery'];
            for (var i = 0; i < levels.length; i++) {
                if (evidenceConfig.thresholds[levels[i]] > points) {
                    nextLevel = levels[i];
                    pointsNeeded = Math.round((evidenceConfig.thresholds[levels[i]] - points) * 10) / 10;
                    break;
                }
            }
            
            var gap = proficiencyValue(claimed) > proficiencyValue(effectiveLevel);
            
            return {
                points: points,
                effectiveLevel: effectiveLevel,
                claimedLevel: claimed,
                evidenceCount: evidenceCount,
                hasGap: gap,
                hasCert: hasCert,
                verifiedCount: verifiedCount,
                pendingCount: pendingCount,
                nextLevel: nextLevel,
                pointsNeeded: pointsNeeded
            };
        }
        
        // Expose to global scope
        window.scoreOutcome = scoreOutcome;
        window.calculateEvidencePoints = calculateEvidencePoints;
        window.getEffectiveLevel = getEffectiveLevel;
        window.getEvidenceSummary = getEvidenceSummary;
        window.getValuationLevel = getValuationLevel;
        
        // ===== VERIFICATION SYSTEM (v4.16.0) =====
        // Note: userData.verifications initialized in userData declaration and template loading
        
        function requestVerification(skillNames) {
            if (readOnlyGuard()) return;
            if (!Array.isArray(skillNames)) skillNames = [skillNames];
            
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            
            var skillListHTML = skillNames.map(function(sn) {
                var skill = (skillsData.skills || []).find(function(s) { return s.name === sn; });
                var summary = skill ? getEvidenceSummary(skill) : { points:0, effectiveLevel:'Novice', evidenceCount:0 };
                var evPreview = (skill && skill.evidence) ? skill.evidence.slice(0,3).map(function(e) {
                    var t = (e.outcome || e.description || '').substring(0, 80);
                    return '<div style="font-size:0.8em; color:' + tv('#9ca3af','#64748b') + '; padding:2px 0;">• ' + t + (t.length >= 80 ? '\u2026' : '') + '</div>';
                }).join('') : '<div style="font-size:0.8em; color:' + tv('#6b7280','#9ca3af') + '; font-style:italic;">No evidence yet</div>';
                
                return '<div style="padding:10px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border-radius:8px; margin-bottom:8px;">'
                    + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1f2937') + ';">' + sn + '</div>'
                    + '<div style="font-size:0.82em; color:' + tv('#60a5fa','#2563eb') + '; margin-top:2px;">Claimed: ' + (skill ? skill.level : '?') + ' · Evidence: ' + summary.points + ' pts → ' + summary.effectiveLevel + '</div>'
                    + evPreview + '</div>';
            }).join('');
            
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">\u2705 Request Verification</h2>'
                + '<p style="color:' + tv('#9ca3af','#64748b') + '; margin-top:5px;">Ask a colleague or manager to verify your evidence</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px; max-height:70vh; overflow-y:auto;">'
                + '<div style="margin-bottom:16px;">' + skillListHTML + '</div>'
                + '<div style="display:grid; gap:14px;">'
                + '<div class="settings-group"><label class="settings-label">Verifier Name *</label>'
                + '<input type="text" class="settings-input" id="verifyName" placeholder="Jane Smith"></div>'
                + '<div class="settings-group"><label class="settings-label">Verifier Email *</label>'
                + '<input type="email" class="settings-input" id="verifyEmail" placeholder="jane@company.com"></div>'
                + '<div class="settings-group"><label class="settings-label">Relationship</label>'
                + '<select class="settings-select" id="verifyRelationship">'
                + '<option value="Manager">Manager / Supervisor</option>'
                + '<option value="Colleague">Colleague / Peer</option>'
                + '<option value="Direct Report">Direct Report</option>'
                + '<option value="Client">Client / Customer</option>'
                + '<option value="Executive">Executive Sponsor</option>'
                + '<option value="Other">Other</option>'
                + '</select></div>'
                + '<div class="settings-group"><label class="settings-label">Personal Note (Optional)</label>'
                + '<textarea class="settings-input" id="verifyNote" rows="2" style="resize:vertical; font-size:0.88em;" '
                + 'placeholder="Hi Jane, could you confirm my expertise in these areas?"></textarea></div>'
                + '</div>'
                + '<div style="display:flex; gap:10px; margin-top:20px;">'
                + '<button onclick="sendVerificationRequest(\'' + skillNames.map(function(s) { return s.replace(/'/g,"\\'"); }).join("','") + '\')" '
                + 'style="background:var(--accent); color:#fff; border:none; padding:10px 24px; border-radius:8px; cursor:pointer; font-weight:600;">'
                + 'Generate Verification Email</button>'
                + '<button onclick="closeExportModal()" style="background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','#d1d5db') + '; padding:10px 20px; border-radius:8px; cursor:pointer;">Cancel</button>'
                + '</div></div>';
            
            modal.style.display = 'flex';
        }
        
        function sendVerificationRequest() {
            var skillNames = Array.from(arguments);
            var verifierName = document.getElementById('verifyName').value.trim();
            var verifierEmail = document.getElementById('verifyEmail').value.trim();
            var relationship = document.getElementById('verifyRelationship').value;
            var personalNote = document.getElementById('verifyNote').value.trim();
            
            if (!verifierName || !verifierEmail) {
                showToast('Name and email are required.', 'warning');
                return;
            }
            
            var token = 'vrf-' + Date.now() + '-' + Math.random().toString(36).substring(2, 8);
            var profileName = userData.profile.name || 'A professional';
            
            // Create verification records
            var records = skillNames.map(function(sn) {
                var skill = (skillsData.skills || []).find(function(s) { return s.name === sn; });
                var evidence = skill ? (skill.evidence || []).map(function(e) { return (e.outcome || '') + ' ' + (e.description || ''); }).join('; ') : '';
                
                var record = {
                    id: token + '-' + sn.replace(/\s+/g, '-').toLowerCase().substring(0, 20),
                    skillName: sn,
                    claimedLevel: skill ? skill.level : 'Unknown',
                    evidenceSummary: evidence.substring(0, 500),
                    verifierName: verifierName,
                    verifierEmail: verifierEmail,
                    relationship: relationship,
                    token: token,
                    status: 'pending',
                    confirmedLevel: null,
                    verifierNote: '',
                    requestedAt: new Date().toISOString(),
                    respondedAt: null
                };
                
                // Store locally
                if (!userData.verifications) userData.verifications = [];
                userData.verifications.push(record);
                
                return record;
            });
            
            // Save to Firestore if available
            if (fbUser && fbDb) {
                records.forEach(function(rec) {
                    fbDb.collection('users').doc(fbUser.uid).collection('verifications').doc(rec.id).set(rec)
                        .catch(function(err) { console.error('Verification save error:', err); });
                });
                saveToFirestore();
            }
            saveAll();
            
            // Build verification URL
            var baseUrl = window.location.origin + window.location.pathname;
            var verifyUrl = baseUrl + '?verify=' + token + (fbUser ? '&uid=' + fbUser.uid : '');
            
            // Build email
            var skillsSummary = records.map(function(r) {
                return '  • ' + r.skillName + ' (claimed: ' + r.claimedLevel + ')\n    Evidence: ' + (r.evidenceSummary || 'None provided').substring(0, 200);
            }).join('\n\n');
            
            var subject = encodeURIComponent('Skill Verification Request from ' + profileName);
            var body = encodeURIComponent(
                'Hi ' + verifierName + ',\n\n'
                + (personalNote ? personalNote + '\n\n' : '')
                + profileName + ' is requesting your verification of the following professional skills:\n\n'
                + skillsSummary + '\n\n'
                + 'To verify, please visit:\n' + verifyUrl + '\n\n'
                + 'You can confirm, suggest a different level, or decline. Your response helps validate professional expertise through Blueprint.\n\n'
                + 'Thank you for your time.\n\n'
                + '---\nGenerated by Blueprint\u2122 · ' + new Date().toLocaleDateString() + ' · myblueprint.work'
            );
            
            // Open mailto
            window.open('mailto:' + verifierEmail + '?subject=' + subject + '&body=' + body);
            
            closeExportModal();
            showToast('Verification request created for ' + records.length + ' skill(s). Email client opened.', 'success');
        }
        
        // Mark a verification as confirmed (manual, for now — verifier landing page is Phase 2)
        function confirmVerification(verificationId) {
            var vIdx = (userData.verifications || []).findIndex(function(v) { return v.id === verificationId; });
            if (vIdx >= 0) {
                userData.verifications[vIdx].status = 'confirmed';
                userData.verifications[vIdx].respondedAt = new Date().toISOString();
                saveAll();
                showToast('Verification confirmed.', 'success');
            }
        }
        
        function declineVerification(verificationId) {
            var vIdx = (userData.verifications || []).findIndex(function(v) { return v.id === verificationId; });
            if (vIdx >= 0) {
                userData.verifications[vIdx].status = 'declined';
                userData.verifications[vIdx].respondedAt = new Date().toISOString();
                saveAll();
                showToast('Verification declined.', 'info');
            }
        }
        
        // Profile-level verification stats
        function getVerificationStats() {
            var skills = skillsData.skills || [];
            var total = skills.length;
            var verifications = userData.verifications || [];
            var confirmedSkillNames = {};
            verifications.forEach(function(v) {
                if (v.status === 'confirmed') confirmedSkillNames[v.skillName] = true;
            });
            var verifiedCount = skills.filter(function(s) { return confirmedSkillNames[s.name]; }).length;
            var pendingCount = verifications.filter(function(v) { return v.status === 'pending'; }).length;
            
            return {
                total: total,
                verified: verifiedCount,
                pending: pendingCount,
                unverified: total - verifiedCount
            };
        }
        
        // Expose verification functions
        window.requestVerification = requestVerification;
        window.sendVerificationRequest = sendVerificationRequest;
        window.confirmVerification = confirmVerification;
        window.declineVerification = declineVerification;
        window.getVerificationStats = getVerificationStats;
        
        // ===== EVIDENCE CRUD (v4.16.1) =====
        
        function addOutcomeToSkill(skillName) {
            if (readOnlyGuard()) return;
            showOutcomeForm(skillName, -1);
        }
        
        function editSkillOutcome(skillName, idx) {
            if (readOnlyGuard()) return;
            showOutcomeForm(skillName, idx);
        }
        
        function removeOutcome(skillName, idx) {
            if (readOnlyGuard()) return;
            var skill = (skillsData.skills || []).find(function(s) { return s.name === skillName; });
            var userSkill = (userData.skills || []).find(function(s) { return s.name === skillName; });
            if (!skill || !skill.evidence || idx < 0 || idx >= skill.evidence.length) return;
            
            skill.evidence.splice(idx, 1);
            if (userSkill && userSkill.evidence) userSkill.evidence.splice(idx, 1);
            
            saveAll();
            // Re-open skill modal to refresh
            closeSkillModal();
            setTimeout(function() { openSkillModal(skillName, skill); }, 100);
            showToast('Outcome removed.', 'info');
        }
        
        function showOutcomeForm(skillName, idx) {
            var skill = (skillsData.skills || []).find(function(s) { return s.name === skillName; });
            if (!skill) return;
            if (!skill.evidence) skill.evidence = [];
            
            var existing = idx >= 0 ? skill.evidence[idx] : { description: '', outcome: '' };
            var isEdit = idx >= 0;
            var escapedName = skillName.replace(/'/g, "\\'");
            
            // Inject form into the evidence list area of the open modal
            var container = document.getElementById('skillEvidenceList');
            if (!container) {
                // Fallback: use export modal
                var modal = document.getElementById('exportModal');
                var mc = modal.querySelector('.modal-content');
                container = mc;
            }
            
            // Calculate live score preview
            var previewText = ((existing.outcome || '') + ' ' + (existing.description || '')).trim();
            var previewScore = previewText ? scoreOutcome(previewText) : 0;
            
            var formHTML = '<div id="outcomeFormContainer" style="padding:16px; margin:8px 0; background:' + tv('rgba(16,185,129,0.06)','rgba(16,185,129,0.03)') + '; '
                + 'border:1px solid ' + tv('rgba(16,185,129,0.2)','rgba(16,185,129,0.12)') + '; border-radius:10px;">'
                + '<div style="font-weight:700; font-size:0.88em; color:' + tv('#10b981','#059669') + '; margin-bottom:12px;">'
                + (isEdit ? '\u270E Edit Outcome' : '+ New Outcome') + '</div>'
                
                + '<div class="settings-group" style="margin-bottom:10px;">'
                + '<label class="settings-label" style="font-size:0.82em;">What was the measurable result? *</label>'
                + '<input type="text" class="settings-input" id="outcomeResult" '
                + 'value="' + (existing.outcome || '').replace(/"/g, '&quot;') + '" '
                + 'placeholder="e.g., Increased pipeline velocity 40% saving $2.3M annually" '
                + 'oninput="updateOutcomeScorePreview()" '
                + 'style="font-size:0.88em;">'
                + '<div class="settings-help">Include numbers, dollars, percentages, or scale for maximum evidence points</div>'
                + '</div>'
                
                + '<div class="settings-group" style="margin-bottom:10px;">'
                + '<label class="settings-label" style="font-size:0.82em;">Context: what did you do?</label>'
                + '<textarea class="settings-input" id="outcomeDescription" rows="2" '
                + 'placeholder="e.g., Redesigned the lead qualification process across 3 sales teams" '
                + 'oninput="updateOutcomeScorePreview()" '
                + 'style="font-size:0.88em; resize:vertical;">' + (existing.description || '') + '</textarea>'
                + '</div>'
                
                + '<div style="display:flex; justify-content:space-between; align-items:center;">'
                + '<div id="outcomeScorePreview" style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + ';">'
                + 'Score: <strong>' + previewScore + '</strong> pts</div>'
                + '<div style="display:flex; gap:8px;">'
                + '<button onclick="saveOutcomeForm(\'' + escapedName + '\',' + idx + ')" '
                + 'style="padding:7px 18px; background:#10b981; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.85em;">'
                + (isEdit ? 'Save' : 'Add Outcome') + '</button>'
                + '<button onclick="cancelOutcomeForm(\'' + escapedName + '\')" '
                + 'style="padding:7px 14px; background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','#d1d5db') + '; border-radius:6px; cursor:pointer; font-size:0.85em;">'
                + 'Cancel</button>'
                + '</div></div>'
                + '</div>';
            
            // Insert at top of evidence list
            var existingForm = document.getElementById('outcomeFormContainer');
            if (existingForm) existingForm.remove();
            container.insertAdjacentHTML('afterbegin', formHTML);
            
            // Focus the result field
            var resultField = document.getElementById('outcomeResult');
            if (resultField) resultField.focus();
        }
        
        function updateOutcomeScorePreview() {
            var result = (document.getElementById('outcomeResult') || {}).value || '';
            var desc = (document.getElementById('outcomeDescription') || {}).value || '';
            var text = (result + ' ' + desc).trim();
            var score = text ? scoreOutcome(text) : 0;
            var preview = document.getElementById('outcomeScorePreview');
            if (preview) {
                var color = score >= 4 ? '#10b981' : score >= 2.5 ? '#60a5fa' : tv('#9ca3af','#64748b');
                preview.innerHTML = 'Score: <strong style="color:' + color + ';">' + score + '</strong> pts'
                    + (score >= 4 ? ' \uD83D\uDD25 High impact' : score >= 2.5 ? ' \u2714 Solid' : score > 0 ? ' \u2197 Add metrics for more' : '');
            }
        }
        
        function saveOutcomeForm(skillName, idx) {
            var result = (document.getElementById('outcomeResult') || {}).value.trim();
            var desc = (document.getElementById('outcomeDescription') || {}).value.trim();
            
            if (!result) { showToast('Outcome result is required.', 'warning'); return; }
            
            var skill = (skillsData.skills || []).find(function(s) { return s.name === skillName; });
            var userSkill = (userData.skills || []).find(function(s) { return s.name === skillName; });
            if (!skill) return;
            if (!skill.evidence) skill.evidence = [];
            if (userSkill && !userSkill.evidence) userSkill.evidence = [];
            
            var entry = { description: desc, outcome: result };
            
            if (idx >= 0 && idx < skill.evidence.length) {
                skill.evidence[idx] = entry;
                if (userSkill && userSkill.evidence) userSkill.evidence[idx] = entry;
            } else {
                skill.evidence.push(entry);
                if (userSkill && userSkill.evidence) userSkill.evidence.push(entry);
            }
            
            saveAll();
            
            // Refresh skill modal
            closeSkillModal();
            setTimeout(function() { openSkillModal(skillName, skill); }, 100);
            showToast(idx >= 0 ? 'Outcome updated.' : 'Outcome added. Evidence points recalculated.', 'success');
        }
        
        function cancelOutcomeForm(skillName) {
            var form = document.getElementById('outcomeFormContainer');
            if (form) form.remove();
        }
        
        window.addOutcomeToSkill = addOutcomeToSkill;
        window.editSkillOutcome = editSkillOutcome;
        window.removeOutcome = removeOutcome;
        window.showOutcomeForm = showOutcomeForm;
        window.updateOutcomeScorePreview = updateOutcomeScorePreview;
        window.saveOutcomeForm = saveOutcomeForm;
        window.cancelOutcomeForm = cancelOutcomeForm;
        
        // ===== END EVIDENCE & VERIFICATION ENGINE =====
        
        let skillValuations = {
            skillBaseValues: {},
            proficiencyMultipliers: { 
                "Novice": 0.7, 
                "Proficient": 1.0, 
                "Advanced": 1.5, 
                "Expert": 1.9, 
                "Mastery": 2.2 
            },
            locationMultipliers: {},
            demandFactors: {},
            rarityBonuses: {},
            roleBenchmarks: {}
        };
        
        // Load skill valuations from JSON
        var certLibrary = { credentials: [], tiers: {} };
        
        fetch('certification_library.json')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                certLibrary = data;
                console.log('\u2705 Certification library loaded: ' + data.totalCredentials + ' credentials');
            })
            .catch(function(e) { console.warn('\u26A0\uFE0F Could not load certification library:', e); });
        
        // Search certification library by name, abbreviation, or description
        function searchCertLibrary(query) {
            if (!query || query.length < 2) return [];
            var q = query.toLowerCase();
            return (certLibrary.credentials || []).filter(function(c) {
                return c.name.toLowerCase().includes(q) 
                    || c.abbr.toLowerCase().includes(q)
                    || c.description.toLowerCase().includes(q)
                    || c.category.toLowerCase().includes(q);
            }).slice(0, 15);
        }
        
        // Find a specific cert by abbreviation or exact name
        function findCertInLibrary(nameOrAbbr) {
            if (!nameOrAbbr) return null;
            var q = nameOrAbbr.toLowerCase().trim();
            return (certLibrary.credentials || []).find(function(c) {
                return c.abbr.toLowerCase() === q || c.name.toLowerCase() === q;
            }) || null;
        }
        
        // Get skill associations for a cert (curated first, fallback to category matching)
        function getCertSkillAssociations(cert) {
            if (!cert) return [];
            // Curated maps take priority
            if (cert.skills && cert.skills.length > 0) return cert.skills.slice();
            // Fallback: match cert category keywords to profile skill names
            return getFallbackSkillMatches(cert);
        }
        
        // Fallback: keyword matching between cert description/category and profile skills
        function getFallbackSkillMatches(cert) {
            if (!cert) return [];
            var keywords = (cert.description + ' ' + cert.category + ' ' + cert.name)
                .toLowerCase().split(/[\s,.\-\/]+/).filter(function(w) { return w.length > 3; });
            // Remove common stop words
            var stops = ['and','the','for','with','from','that','this','level','based','state','national','professional','certified','certification','license','advanced'];
            keywords = keywords.filter(function(w) { return stops.indexOf(w) < 0; });
            
            var matches = [];
            (skillsData.skills || []).forEach(function(skill) {
                var sn = skill.name.toLowerCase();
                var matchCount = keywords.filter(function(kw) { return sn.includes(kw); }).length;
                if (matchCount > 0) matches.push({ name: skill.name, score: matchCount });
            });
            matches.sort(function(a, b) { return b.score - a.score; });
            return matches.slice(0, 6).map(function(m) { return m.name; });
        }
        
        // Get cert floor level based on tier
        function getCertFloorLevel(cert) {
            if (!cert) return evidenceConfig.certFloor;
            return cert.tier === 2 ? 'Advanced' : 'Proficient';
        }
        
        // Get cert floor POINTS based on tier
        // [removed] getCertFloorPoints — dead code cleanup v4.22.0
        
        // Expose
        window.searchCertLibrary = searchCertLibrary;
        window.findCertInLibrary = findCertInLibrary;
        window.getCertSkillAssociations = getCertSkillAssociations;
        window.getCertFloorLevel = getCertFloorLevel;
        
        fetch('skill_valuations.json')
            .then(response => response.json())
            .then(data => {
                skillValuations = data;
                console.log('✅ Skill valuations loaded');
                // Recalculate values if already rendered
                if (document.getElementById('totalMarketValue')) {
                    updateMarketValueDisplay();
                }
            })
            .catch(error => {
                console.warn('⚠️ Could not load skill valuations, using defaults:', error);
            });
        
        // Data structure
        const skillsData = {
            roles: [
                { id: "strategy", name: "VP Global Strategy", icon: "target", color: "#ef4444" },
                { id: "futurist", name: "Futurist & Evangelist", icon: "zap", color: "#f59e0b" },
                { id: "pilot", name: "IFR Pilot", icon: "compass", color: "#3b82f6" },
                { id: "musician", name: "Musician", icon: "heart", color: "#8b5cf6" },
                { id: "advocate", name: "Recovery Advocate", icon: "heart", color: "#10b981" },
                { id: "tech", name: "Technology Strategist", icon: "settings", color: "#06b6d4" },
                { id: "creative", name: "Creative Director", icon: "creative", color: "#ec4899" },
                { id: "operations", name: "Operations Leader", icon: "layers", color: "#f97316" },
                { id: "entrepreneur", name: "Entrepreneur", icon: "trending-up", color: "#a855f7" }
            ],
            
            skills: [
                // Strategic Core
                { name: "Enterprise AI Strategy", level: "Mastery", roles: ["strategy", "futurist", "tech"], key: false },
                { name: "Go-to-Market Strategy", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "Business Case Development", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "C-Suite Advisory & Influence", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Customer Advisory Board Leadership", level: "Mastery", roles: ["strategy"], key: false },
                { name: "Strategic Foresight & Market Prediction", level: "Mastery", roles: ["strategy", "futurist"], key: true },
                { name: "Organizational Transformation", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "Risk Assessment & Mitigation", level: "Mastery", roles: ["strategy", "pilot", "operations", "entrepreneur"], key: false },
                { name: "Revenue Pipeline Development", level: "Advanced", roles: ["strategy", "operations", "entrepreneur"], key: false },
                { name: "Financial Management & Budget Discipline", level: "Proficient", roles: ["strategy", "operations", "entrepreneur"], key: false },
                
                // Technology & Product
                { name: "AI/ML Product Strategy", level: "Mastery", roles: ["strategy", "tech", "futurist"], key: false },
                { name: "Talent Intelligence Platform Design", level: "Mastery", roles: ["strategy", "tech"], key: false },
                { name: "HR Technology Market Intelligence", level: "Mastery", roles: ["strategy", "futurist"], key: false },
                { name: "Technology Lifecycle & Disruption Analysis", level: "Mastery", roles: ["futurist", "tech"], key: false },
                { name: "Computational & Systems Thinking", level: "Advanced", roles: ["tech", "pilot"], key: false },
                { name: "Platform Integration Architecture", level: "Advanced", roles: ["tech", "entrepreneur"], key: false },
                { name: "Weak Signal Detection & Trend Recognition", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Spatial Reasoning & 3D Problem Solving", level: "Mastery", roles: ["pilot", "musician", "creative", "tech"], key: true },
                
                // Futurist & Innovation
                { name: "Technology Trend Forecasting", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Predictive Framework Development", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Disruptive Innovation Identification", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Scenario Planning & Strategic Alternatives", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Human-AI Collaboration Model Design", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                
                // Communication & Influence
                { name: "Executive Narrative & Storytelling", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Technical Concept Translation", level: "Mastery", roles: ["futurist", "tech", "strategy"], key: true },
                { name: "Public Speaking & Keynote Delivery", level: "Mastery", roles: ["futurist", "musician"], key: false },
                { name: "Thought Leadership Authorship", level: "Mastery", roles: ["futurist"], key: false },
                { name: "Rhetorical Strategy & Persuasion", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Media Relations & Spokesperson Work", level: "Mastery", roles: ["futurist"], key: false },
                { name: "Podcast Production & Hosting", level: "Advanced", roles: ["futurist", "musician"], key: false },
                { name: "Real-Time Improvisation", level: "Mastery", roles: ["musician", "futurist"], key: false },
                { name: "Industry Evangelism", level: "Mastery", roles: ["futurist"], key: false },
                { name: "Teaching & Knowledge Transfer", level: "Advanced", roles: ["futurist", "advocate"], key: false },
                
                // Domain Expertise
                { name: "Talent Acquisition Strategy", level: "Mastery", roles: ["strategy"], key: false },
                { name: "Candidate Experience Architecture", level: "Mastery", roles: ["strategy"], key: true },
                { name: "AI Ethics & Responsible Implementation", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Workforce Intelligence & Analytics", level: "Mastery", roles: ["strategy"], key: false },
                { name: "Talent Marketplace Dynamics", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Behavioral Economics in Talent", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Workforce Trends & Future of Work Analysis", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Generational Workforce Analysis", level: "Advanced", roles: ["futurist", "strategy"], key: false },
                { name: "AI Impact on Human Work", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                
                // Leadership & Interpersonal
                { name: "Enterprise Client Relationship Management", level: "Mastery", roles: ["strategy", "entrepreneur"], key: false },
                { name: "Strategic Team Building", level: "Advanced", roles: ["strategy", "operations", "tech", "entrepreneur"], key: false },
                { name: "Executive Mentorship", level: "Advanced", roles: ["strategy"], key: false },
                { name: "Multi-Stakeholder Alignment", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "Executive Presence & Authority", level: "Mastery", roles: ["strategy", "futurist"], key: false },
                { name: "Crisis Leadership & Decision Making", level: "Mastery", roles: ["pilot", "operations", "advocate", "strategy", "entrepreneur"], key: true },
                { name: "High-Pressure Performance", level: "Mastery", roles: ["pilot", "musician", "operations"], key: false },
                
                // Creative & Performance
                { name: "Creative Direction", level: "Mastery", roles: ["creative", "entrepreneur"], key: false },
                { name: "Live Musical Performance", level: "Mastery", roles: ["musician"], key: false },
                { name: "Music Composition & Arrangement", level: "Advanced", roles: ["musician"], key: false },
                { name: "Music Production & Artist Development", level: "Advanced", roles: ["musician"], key: false },
                { name: "Stage Command & Audience Connection", level: "Mastery", roles: ["musician", "futurist"], key: false },
                { name: "Performance Logistics", level: "Proficient", roles: ["musician"], key: false },
                
                // Aviation
                { name: "Single-Pilot IFR in Complex Airspace", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Single-Pilot Resource Management", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Weather Systems Analysis", level: "Advanced", roles: ["pilot"], key: false },
                { name: "ATC Communication & Coordination", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Emergency Airmanship", level: "Mastery", roles: ["pilot"], key: true },
                { name: "Aeronautical Decision Making Under Uncertainty", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Situational Awareness in Dynamic Environments", level: "Mastery", roles: ["pilot", "operations"], key: false },
                { name: "Multi-Channel Cognitive Load Management", level: "Mastery", roles: ["pilot", "operations"], key: false },
                
                // Analytical & Research
                { name: "Data-Driven Strategy Development", level: "Advanced", roles: ["strategy", "tech"], key: false },
                { name: "Market & Competitive Intelligence", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Research Synthesis & Pattern Recognition", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Critical Analysis & Evaluation", level: "Advanced", roles: ["strategy", "tech", "futurist"], key: false },
                
                // Advocacy
                { name: "Leadership Through Lived Experience", level: "Mastery", roles: ["advocate"], key: false },
                { name: "Mental Health & Addiction Advocacy", level: "Mastery", roles: ["advocate"], key: false },
                { name: "Nonprofit Founding & Operations", level: "Advanced", roles: ["advocate", "entrepreneur"], key: false },
                { name: "Authentic Leadership & Trust Building", level: "Mastery", roles: ["advocate", "futurist"], key: true },
                { name: "Culture Change & Inclusion Initiatives", level: "Advanced", roles: ["advocate"], key: false },
                { name: "Complex Problem Diagnosis & Resolution", level: "Advanced", roles: ["advocate"], key: false }
            ],
            
            skillDetails: {} // Will be loaded from skill_evidence.json
        };
        
        // ===== v2.0: USER DATA MANAGEMENT SYSTEM =====
        
        let userData = {
            initialized: false,
            profile: {
                name: "",
                email: "",
                phone: "",
                linkedinUrl: "",
                location: "Remote"
            },
            skills: [],
            skillDetails: {},
            values: [],
            purpose: "",
            roles: [],
            workHistory: [],
            education: [],
            certifications: [],
            verifications: [],
            preferences: {
                seniorityLevel: "Mid-Career",
                targetTitles: [],
                seniorityKeywords: ['vp', 'vice president', 'chief', 'head of', 'director', 'principal', 'senior director'],
                excludeRoles: ['engineer', 'developer', 'designer', 'analyst', 'coordinator', 'specialist', 
                              'junior', 'mid-level', 'associate', 'intern', 'entry', 'qa', 'frontend', 'backend',
                              'full stack', 'fullstack', 'software', 'devops', 'ui/ux', 'data scientist'],
                strategicKeywords: ['strategy', 'strategic', 'transformation', 'innovation', 'evangelist', 
                                   'thought leader', 'advisory', 'ai', 'ml', 'product', 'growth', 'business'],
                targetIndustries: [],
                minSalary: null,
                locationPreferences: ["US", "Remote"],
                minimumSkillMatches: 3,
                minimumMatchScore: 50
            },
            applications: [],
            savedJobs: []
        };
        
        let templates = {};
        let valuesLibrary = [];
        
        // Check if user has existing profile
        // Removed checkUserProfile - using template-based loading instead
        
        // Build profile selector dropdown from manifest
        function buildProfileSelector(profiles) {
            // Hidden select (kept for backward compatibility)
            const selector = document.getElementById('profileSelector');
            const currentId = safeGet('currentProfile') || profiles[0]?.id;

            if (selector) {
                selector.innerHTML = profiles.map(p =>
                    `<option value="${p.id}" ${p.id === currentId ? 'selected' : ''}>${p.name}</option>`
                ).join('');
            }

            // Rebuild auth-aware dropdown (includes sample profiles + auth controls)
            rebuildProfileDropdown();

            // Update the profile chip name/avatar (only if not signed in, otherwise auth controls it)
            if (!fbUser) {
                const current = profiles.find(p => p.id === currentId) || profiles[0];
                if (current) updateProfileChip(current.name);
            }

            console.log(`✓ Profile selector built with ${profiles.length} options`);
        }
        
        // Switch to a different profile (admin functionality)
        function switchProfile(templateId) {
            console.log('🔄 Switching profile to:', templateId);
            
            // Close dropdown immediately before rebuilding DOM
            closeProfileDropdown();
            
            if (!templates[templateId]) {
                console.error('Template not found:', templateId);
                showToast('Profile not found.', 'error');
                return;
            }
            
            // Load template inline (no page reload)
            loadTemplate(templateId);
            safeSet('currentProfile', templateId);
            
            // Re-initialize views with new data
            if (typeof skillsData !== 'undefined') {
                skillsData.skills = userData.skills;
                skillsData.roles = userData.roles;
            }
            
            // Update profile chip
            if (userData.profile && userData.profile.name) {
                updateProfileChip(userData.profile.name);
            }
            
            // Reset initialized flags so views re-render
            window.blueprintInitialized = false;
            window.opportunitiesInitialized = false;
            window.applicationsInitialized = false;
            window.consentInitialized = false;
            window.settingsInitialized = false;
            window.networkInitialized = false;
            window.cardViewInitialized = false;
            
            // Reset network state for new profile
            if (typeof activeRole !== 'undefined') activeRole = 'all';
            if (typeof activeJobForNetwork !== 'undefined') activeJobForNetwork = null;
            if (typeof networkMatchMode !== 'undefined') networkMatchMode = 'you';
            var searchInput = document.getElementById('skillSearch');
            if (searchInput) searchInput.value = '';
            
            // Clean up any network overlay DOM elements
            var legend = document.getElementById('matchLegend');
            if (legend) legend.remove();
            var jobTile = document.getElementById('jobInfoTile');
            if (jobTile) jobTile.remove();
            var toggle = document.getElementById('matchModeToggle');
            if (toggle) toggle.style.display = 'none';
            var badge = document.getElementById('matchActiveBadge');
            if (badge) badge.style.display = 'none';
            
            // Check read-only status
            checkReadOnly();
            rebuildProfileDropdown();
            
            // Navigate to Skills view (network on desktop, card on mobile)
            if (window.innerWidth <= 768) {
                currentSkillsView = 'card';
            }
            switchView('network');
            // Ensure we're at the top after view switch
            setTimeout(function() { window.scrollTo(0, 0); }, 50);
        }
        
        // Save user data preference (which profile they're viewing)
        function saveUserData() {
            try {
                // Don't save userData to localStorage anymore
                // Only save which profile is active
                const currentProfileId = userData.templateId || 'cliff-jones-demo';
                safeSet('currentProfile', currentProfileId);
                console.log('✓ Profile preference saved:', currentProfileId);
                return true;
            } catch (e) {
                console.error('Error saving profile preference:', e);
                return false;
            }
        }
        
        // ===== SKILL LIBRARY SYSTEM (v2.3.0) =====
        let skillLibraryIndex = null;

        async function loadSkillLibraryIndex() {
            // Try v3 (current), gracefully degrade if missing — never block the app
            const cacheBuster = '?v=20260218-2100';
            const candidates = ['skills/index-v3.json', 'skills/index-v4.json'];
            
            for (const path of candidates) {
                try {
                    const response = await fetch(path + cacheBuster);
                    if (!response.ok) continue;
                    const data = await response.json();
                    skillLibraryIndex = data;
                    const count = data.totalSkills || data.index?.length || '?';
                    console.log(`✓ Skill library loaded: ${count} skills (${path})`);
                    // Update Add Skills count badge
                    const badge = document.getElementById('availableSkillsCount');
                    if (badge && count !== '?') badge.textContent = Number(count).toLocaleString();
                    return;
                } catch (e) {
                    // Try next candidate
                }
            }
            
            // All candidates failed — set empty index, app still works
            skillLibraryIndex = { totalSkills: 0, index: [] };
            console.warn('⚠ Skill search library (skills/index-v3.json) not found — Add Skills search will be empty. Other features unaffected.');
        }

        // Search skills by query - returns array always
        function searchSkills(query) {
            try {
                if (!skillLibraryIndex?.index || !query) return [];
                const q = query.toLowerCase().trim();
                if (q.length < 2) return [];
                
                return skillLibraryIndex.index
                    .filter(skill => {
                        const name = (skill.n || '').toLowerCase();
                        const category = (skill.c || '').toLowerCase();
                        const subcategory = (skill.sc || '').toLowerCase();
                        return name.includes(q) || category.includes(q) || subcategory.includes(q);
                    })
                    .sort((a, b) => {
                        const aName = (a.n || '').toLowerCase();
                        const bName = (b.n || '').toLowerCase();
                        if (aName === q) return -1;
                        if (bName === q) return 1;
                        if (aName.startsWith(q) && !bName.startsWith(q)) return -1;
                        if (!aName.startsWith(q) && bName.startsWith(q)) return 1;
                        return (b.p || 0) - (a.p || 0);
                    })
                    .slice(0, 20);
            } catch (error) {
                console.error('searchSkills error:', error);
                return [];
            }
        }

        function getCategoryColor(category) {
            const colors = {
                'Technology': '#3b82f6',
                'Business & Management': '#8b5cf6',
                'Finance & Accounting': '#10b981',
                'Marketing & Sales': '#f59e0b',
                'Human Resources': '#ec4899',
                'Healthcare & Medical': '#14b8a6',
                'Engineering & Manufacturing': '#6366f1',
                'Legal & Compliance': '#78716c',
                'Creative & Design': '#f97316',
                'General Professional': '#64748b'
            };
            return colors[category] || '#9ca3af';
        }

        function isSkillAlreadyAdded(skillName) {
            return userData.skills.some(s => 
                s.name.toLowerCase() === skillName.toLowerCase()
            );
        }

        // Load library on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSkillLibraryIndex();
        });
        
        // Load template into userData
        // ===== SAMPLE JOBS FOR DEMO PROFILES =====
        function getSampleJobsForProfile(templateId, template) {
            var allRoles = (template.roles || []).map(function(r) { return r.name.toLowerCase(); }).join(' ');
            var titleStr = ((template.profile || {}).currentTitle || '').toLowerCase();
            var profileName = (template.profile && template.profile.name) || '';
            var skills = template.skills || [];
            var allSkillNames = skills.map(function(s) { return s.name.toLowerCase(); }).join(' ');
            
            // Detect profile type — roles and title are primary signals, skills only for retail/trades
            var roleSignals = titleStr + ' ' + allRoles;
            
            var isRecruiter = /recruit|talent acqui|sourcing|staffing/.test(roleSignals);
            var isProduct = /product manager|product lead|product director|product owner/.test(roleSignals);
            var isStrategy = /strateg|advisory|futurist|evangelist|transformation|chief|vp |vice president|executive/.test(roleSignals);
            var isTech = /\b(engineer|developer|architect|software|devops|frontend|backend|full.?stack|sre|infrastructure)\b/.test(roleSignals);
            // Retail and trades check skills too since role names may be generic
            var isRetail = /cashier|retail|store|merchandise|customer service|point of sale|barista/.test(roleSignals + ' ' + allSkillNames);
            var isTrades = /hair|stylist|cosmetolog|barber|electrician|plumb|hvac|carpenter|mechanic|weld/.test(roleSignals + ' ' + allSkillNames);
            
            var jobMeta;
            if (isRecruiter) {
                jobMeta = [
                    { id: 'sample-high', title: 'Senior Technical Recruiter', company: 'Datadog',
                      rawText: 'Datadog is hiring a Senior Technical Recruiter to drive full-lifecycle hiring across our engineering organization. You will own sourcing strategy, candidate experience, and stakeholder partnerships for technical hiring across multiple product teams. This is a high-impact role for someone who thrives in fast-paced SaaS environments and can balance volume hiring with quality bar management.',
                      parsedRoles: ['Recruiting', 'HR'], seniority: 'Senior', tier: 'high' },
                    { id: 'sample-mid', title: 'Talent Acquisition Manager', company: 'Figma',
                      rawText: 'Figma seeks a Talent Acquisition Manager to build and lead a recruiting team supporting go-to-market and G&A functions. You will design scalable hiring processes, develop workforce plans, partner with finance on headcount modeling, and implement recruiting analytics. Experience with employer brand strategy, executive search, and international hiring required.',
                      parsedRoles: ['Talent Acquisition', 'Management'], seniority: 'Senior', tier: 'mid' },
                    { id: 'sample-low', title: 'Director, People Analytics & Workforce Strategy', company: 'McKinsey',
                      rawText: 'McKinsey is seeking a Director of People Analytics & Workforce Strategy to lead advanced analytics capabilities across our global people function. This role requires deep expertise in statistical modeling, predictive workforce analytics, organizational design, compensation benchmarking, and HRIS architecture. You will build machine learning models for attrition prediction, design org network analysis frameworks, and advise partners on talent deployment optimization.',
                      parsedRoles: ['People Analytics', 'HR Strategy'], seniority: 'Executive', tier: 'low' }
                ];
            } else if (isProduct) {
                jobMeta = [
                    { id: 'sample-high', title: 'Senior Product Manager, Collaboration', company: 'Notion',
                      rawText: 'Notion is hiring a Senior Product Manager to own our collaboration and real-time editing features. You will drive product strategy, run experiments, analyze user data, manage the roadmap, and work cross-functionally with engineering and design. Strong product sense, analytical skills, and experience shipping consumer products required.',
                      parsedRoles: ['Product', 'Technology'], seniority: 'Senior', tier: 'high' },
                    { id: 'sample-mid', title: 'Director of Product, Platform', company: 'Stripe',
                      rawText: 'Stripe is looking for a Director of Product to lead our platform and developer experience team. You will set multi-year strategy, manage a team of PMs, own P&L for platform products, drive executive alignment, and build partnerships with key ecosystem players. Requires experience with API products, developer tooling, and enterprise sales motion.',
                      parsedRoles: ['Product', 'Leadership'], seniority: 'Executive', tier: 'mid' },
                    { id: 'sample-low', title: 'VP Engineering, Machine Learning Infrastructure', company: 'Scale AI',
                      rawText: 'Scale AI seeks a VP of Engineering to lead our ML Infrastructure division. This role requires hands-on expertise in distributed systems architecture, GPU cluster management, model training pipelines, MLOps automation, Kubernetes orchestration, and C++ performance optimization. You will manage 60+ engineers, own a $40M infrastructure budget, and drive our technical roadmap for foundation model training.',
                      parsedRoles: ['Engineering', 'ML Infrastructure'], seniority: 'Executive', tier: 'low' }
                ];
            } else if (isRetail) {
                jobMeta = [
                    { id: 'sample-high', title: 'Customer Service Associate', company: 'Target',
                      rawText: 'Target is hiring a Customer Service Associate for our guest services team. You will handle transactions, assist customers with returns and exchanges, maintain store standards, and support team goals. Strong communication skills, cash handling experience, and a friendly attitude required. Flexible scheduling including weekends and holidays.',
                      parsedRoles: ['Customer Service', 'Retail'], seniority: 'Entry', tier: 'high' },
                    { id: 'sample-mid', title: 'Shift Supervisor', company: 'Starbucks',
                      rawText: 'Starbucks is looking for a Shift Supervisor to lead store operations during assigned shifts. You will manage team workflow, handle customer escalations, oversee cash management and inventory counts, train new partners, and ensure food safety compliance. Prior retail supervisory experience, barista skills, and ability to work in fast-paced environments required.',
                      parsedRoles: ['Retail Management', 'Food Service'], seniority: 'Entry', tier: 'mid' },
                    { id: 'sample-low', title: 'Assistant Store Manager', company: 'Nordstrom',
                      rawText: 'Nordstrom seeks an Assistant Store Manager to oversee daily store operations, manage a team of 20+ associates, drive sales performance, handle P&L responsibilities, lead visual merchandising strategy, and manage vendor relationships. Requires 3+ years retail management experience, strong analytical skills, inventory management expertise, and ability to develop and coach teams.',
                      parsedRoles: ['Store Management', 'Retail Operations'], seniority: 'Mid', tier: 'low' }
                ];
            } else if (isTrades) {
                jobMeta = [
                    { id: 'sample-high', title: 'Stylist', company: 'Great Clips',
                      rawText: 'Great Clips is hiring a licensed Stylist to join our team. You will provide haircuts, styling services, color applications, and consultations. Strong customer service, time management, and technical hair skills required. Must hold valid cosmetology license. Competitive base pay plus tips and product commission.',
                      parsedRoles: ['Stylist', 'Customer Service'], seniority: 'Entry', tier: 'high' },
                    { id: 'sample-mid', title: 'Senior Stylist & Colorist', company: 'Aveda Salon',
                      rawText: 'Aveda Salon seeks a Senior Stylist & Colorist with advanced color correction experience. You will manage a full book of clients, mentor junior stylists, drive retail product sales, and maintain expertise in current trends and techniques. Requires 3+ years behind the chair, balayage and vivid color certification preferred, and strong client retention track record.',
                      parsedRoles: ['Senior Stylist', 'Colorist'], seniority: 'Senior', tier: 'mid' },
                    { id: 'sample-low', title: 'Salon Manager', company: 'Ulta Beauty',
                      rawText: 'Ulta Beauty is looking for a Salon Manager to lead a team of 10+ stylists, manage scheduling and payroll, drive salon revenue targets, handle inventory and vendor ordering, maintain health and safety compliance, and build client loyalty programs. Requires cosmetology license, 3+ years management experience, P&L knowledge, and retail operations expertise.',
                      parsedRoles: ['Salon Management', 'Retail Operations'], seniority: 'Mid', tier: 'low' }
                ];
            } else if (isStrategy || (!isTech && !isRecruiter)) {
                // Strategy/Advisory/Executive — Cliff Jones and any unmatched exec profiles
                jobMeta = [
                    { id: 'sample-high', title: 'VP of Strategy & Transformation', company: 'ServiceNow',
                      rawText: 'ServiceNow is hiring a VP of Strategy & Transformation to lead enterprise-wide strategic initiatives. You will drive digital transformation programs, develop competitive positioning, lead cross-functional teams, present to C-suite stakeholders, and shape thought leadership content. This role requires deep experience in strategic planning, change management, and executive communication.',
                      parsedRoles: ['Strategy', 'Executive'], seniority: 'Executive', tier: 'high' },
                    { id: 'sample-mid', title: 'Director of AI Strategy & Advisory', company: 'Deloitte',
                      rawText: 'Deloitte seeks a Director to lead AI Strategy engagements for Fortune 500 clients. You will assess organizational AI readiness, build transformation roadmaps, advise on responsible AI governance, develop client relationships, and publish thought leadership. Requires blend of strategic thinking, AI literacy, consulting skills, and ability to influence C-level executives on technology adoption.',
                      parsedRoles: ['Strategy', 'Consulting'], seniority: 'Senior', tier: 'mid' },
                    { id: 'sample-low', title: 'Chief Data Officer', company: 'Palantir',
                      rawText: 'Palantir is seeking a Chief Data Officer to build our enterprise data governance function from the ground up. This role requires deep expertise in data architecture, SQL and Python programming, statistical modeling, regulatory compliance (GDPR, CCPA, SOX), data mesh architecture, ETL pipeline design, and cloud infrastructure management. You will own a $25M data platform budget, build a 40-person data engineering team, and implement real-time analytics infrastructure.',
                      parsedRoles: ['Data', 'Executive'], seniority: 'Executive', tier: 'low' }
                ];
            } else {
                // Technology/Engineering — Mike Rodriguez
                jobMeta = [
                    { id: 'sample-high', title: 'Senior Software Engineer, Platform', company: 'Cloudflare',
                      rawText: 'Cloudflare is hiring a Senior Software Engineer for our core platform team. You will design and build distributed systems that handle millions of requests per second, improve observability and reliability, mentor junior engineers, and contribute to architecture decisions. Strong experience with systems programming, networking, and performance optimization required. Experience with Go, Rust, or C++ preferred.',
                      parsedRoles: ['Engineering', 'Platform'], seniority: 'Senior', tier: 'high' },
                    { id: 'sample-mid', title: 'Staff Engineer, Infrastructure', company: 'Datadog',
                      rawText: 'Datadog seeks a Staff Engineer to lead technical direction for our cloud infrastructure platform. You will design large-scale distributed systems, drive cross-team technical initiatives, evaluate build vs buy decisions, and own system reliability targets. Requires deep expertise in cloud architecture, container orchestration, database internals, and capacity planning. Must have shipped production systems at significant scale.',
                      parsedRoles: ['Engineering', 'Infrastructure'], seniority: 'Staff', tier: 'mid' },
                    { id: 'sample-low', title: 'Director of Engineering, AI/ML', company: 'Anthropic',
                      rawText: 'Anthropic seeks a Director of Engineering to lead our AI/ML training infrastructure team. This role requires deep expertise in distributed training systems, GPU cluster management, model optimization, research engineering management, and scientific computing. You will manage a team of 25+ research engineers, own training compute budget and efficiency, and drive technical strategy for next-generation model development.',
                      parsedRoles: ['Engineering Management', 'AI/ML'], seniority: 'Director', tier: 'low' }
                ];
            }
            
            // Helpers
            function pickRandom(arr, n) {
                var shuffled = arr.slice().sort(function() { return 0.5 - Math.random(); });
                return shuffled.slice(0, Math.min(n, shuffled.length));
            }
            function matchingProf(level) {
                var levels = ['Novice', 'Competent', 'Proficient', 'Advanced', 'Expert', 'Mastery'];
                var idx = levels.indexOf(level);
                return levels[Math.max(0, idx === -1 ? 2 : idx)];
            }
            function stretchProf(level) {
                var levels = ['Novice', 'Competent', 'Proficient', 'Advanced', 'Expert', 'Mastery'];
                var idx = levels.indexOf(level);
                return levels[Math.min((idx === -1 ? 2 : idx) + 1, 5)];
            }
            
            // Gap skill pools — skills unlikely to be in recruiter/product/strategy profiles
            var gapPools = {
                technical: [
                    { name: 'Kubernetes Administration', cat: 'Technical' },
                    { name: 'SQL Database Design', cat: 'Technical' },
                    { name: 'Python Programming', cat: 'Technical' },
                    { name: 'Cloud Architecture (AWS)', cat: 'Technical' },
                    { name: 'Machine Learning Engineering', cat: 'Technical' },
                    { name: 'CI/CD Pipeline Management', cat: 'Technical' },
                    { name: 'API Design & Governance', cat: 'Technical' },
                    { name: 'Statistical Modeling', cat: 'Technical' },
                    { name: 'Data Pipeline Architecture', cat: 'Technical' },
                    { name: 'Cybersecurity Compliance', cat: 'Technical' }
                ],
                finance: [
                    { name: 'Financial Modeling', cat: 'Business' },
                    { name: 'Revenue Forecasting', cat: 'Business' },
                    { name: 'Capital Allocation Strategy', cat: 'Business' },
                    { name: 'Regulatory Compliance (SOX)', cat: 'Business' },
                    { name: 'Actuarial Analysis', cat: 'Business' },
                    { name: 'Tax Strategy', cat: 'Business' },
                    { name: 'Treasury Management', cat: 'Business' },
                    { name: 'Mergers & Acquisitions Due Diligence', cat: 'Business' }
                ],
                operations: [
                    { name: 'Supply Chain Optimization', cat: 'Operations' },
                    { name: 'Lean Six Sigma', cat: 'Operations' },
                    { name: 'Facilities Management', cat: 'Operations' },
                    { name: 'Logistics Planning', cat: 'Operations' },
                    { name: 'Procurement Strategy', cat: 'Operations' },
                    { name: 'Quality Assurance Frameworks', cat: 'Operations' },
                    { name: 'Vendor Risk Assessment', cat: 'Operations' },
                    { name: 'Capacity Planning', cat: 'Operations' }
                ],
                data: [
                    { name: 'Predictive Analytics', cat: 'Technical' },
                    { name: 'Data Governance Frameworks', cat: 'Technical' },
                    { name: 'ETL Pipeline Design', cat: 'Technical' },
                    { name: 'Real-Time Analytics Infrastructure', cat: 'Technical' },
                    { name: 'Data Mesh Architecture', cat: 'Technical' },
                    { name: 'Natural Language Processing', cat: 'Technical' },
                    { name: 'Computer Vision Systems', cat: 'Technical' },
                    { name: 'GPU Cluster Management', cat: 'Technical' }
                ],
                management: [
                    { name: 'P&L Management', cat: 'Business' },
                    { name: 'Team Scheduling', cat: 'Operations' },
                    { name: 'Payroll Administration', cat: 'Business' },
                    { name: 'Visual Merchandising', cat: 'Retail' },
                    { name: 'Loss Prevention', cat: 'Operations' },
                    { name: 'Vendor Negotiation', cat: 'Business' },
                    { name: 'Health & Safety Compliance', cat: 'Operations' },
                    { name: 'Employee Training Programs', cat: 'Management' }
                ],
                creative: [
                    { name: 'Color Correction (Advanced)', cat: 'Technical' },
                    { name: 'Chemical Processing Knowledge', cat: 'Technical' },
                    { name: 'Retail Product Sales', cat: 'Business' },
                    { name: 'Social Media Marketing', cat: 'Marketing' },
                    { name: 'Client Consultation Techniques', cat: 'Domain' },
                    { name: 'Salon Software Proficiency', cat: 'Technical' },
                    { name: 'Continuing Education Credits', cat: 'Professional' },
                    { name: 'Portfolio Development', cat: 'Professional' }
                ]
            };
            
            var profileSkillNames = new Set();
            skills.forEach(function(s) { profileSkillNames.add(s.name.toLowerCase()); });
            function cleanGaps(pool) { return pool.filter(function(g) { return !profileSkillNames.has(g.name.toLowerCase()); }); }
            
            var keySkills = skills.filter(function(s) { return s.key; });
            var otherSkills = skills.filter(function(s) { return !s.key; });
            
            var jobs = jobMeta.map(function(meta) {
                var parsedSkills = [];
                
                if (meta.tier === 'high') {
                    // TARGET: 80-90% — heavy overlap, achievable proficiency levels, minimal gaps
                    var fromKey = pickRandom(keySkills, Math.min(keySkills.length, 6));
                    var fromOther = pickRandom(otherSkills, Math.min(6, otherSkills.length));
                    var profilePicks = fromKey.concat(fromOther).slice(0, 10);
                    profilePicks.forEach(function(s) {
                        parsedSkills.push({
                            name: s.name,
                            requirement: s.key ? 'Required' : 'Preferred',
                            proficiency: matchingProf(s.level),
                            category: s.category || 'Domain'
                        });
                    });
                    // 1-2 soft gaps from a relevant-but-stretch pool
                    var softPool = isRetail || isTrades ? gapPools.management : gapPools.operations;
                    cleanGaps(softPool).slice(0, 2).forEach(function(g) {
                        parsedSkills.push({ name: g.name, requirement: 'Preferred', proficiency: 'Competent', category: g.cat });
                    });
                    
                } else if (meta.tier === 'mid') {
                    // TARGET: 50-65% — moderate overlap, some stretch levels, meaningful gaps
                    var fromKey = pickRandom(keySkills, Math.min(keySkills.length, 4));
                    var fromOther = pickRandom(otherSkills, Math.min(3, otherSkills.length));
                    var profilePicks = fromKey.concat(fromOther).slice(0, 6);
                    profilePicks.forEach(function(s, i) {
                        parsedSkills.push({
                            name: s.name,
                            requirement: 'Required',
                            proficiency: i < 2 ? stretchProf(s.level) : matchingProf(s.level),
                            category: s.category || 'Domain'
                        });
                    });
                    // 5-6 Required gaps — profile-appropriate
                    var pool1, pool2;
                    if (isRetail) { pool1 = cleanGaps(gapPools.management).slice(0, 3); pool2 = cleanGaps(gapPools.operations).slice(0, 3); }
                    else if (isTrades) { pool1 = cleanGaps(gapPools.creative).slice(0, 3); pool2 = cleanGaps(gapPools.management).slice(0, 3); }
                    else if (isTech) { pool1 = cleanGaps(gapPools.data).slice(0, 3); pool2 = cleanGaps(gapPools.operations).slice(0, 3); }
                    else { pool1 = cleanGaps(gapPools.finance).slice(0, 3); pool2 = cleanGaps(gapPools.technical).slice(0, 3); }
                    pool1.concat(pool2).forEach(function(g) {
                        parsedSkills.push({ name: g.name, requirement: 'Required', proficiency: 'Proficient', category: g.cat });
                    });
                    
                } else {
                    // TARGET: <50% — minimal overlap, heavy alien-domain gaps
                    var fromKey = pickRandom(keySkills, Math.min(2, keySkills.length));
                    var fromOther = pickRandom(otherSkills, Math.min(1, otherSkills.length));
                    var profilePicks = fromKey.concat(fromOther).slice(0, 3);
                    profilePicks.forEach(function(s) {
                        parsedSkills.push({
                            name: s.name,
                            requirement: 'Preferred',
                            proficiency: stretchProf(s.level),
                            category: s.category || 'Domain'
                        });
                    });
                    // 9-10 Required gaps at Expert from alien domains
                    var pool1, pool2, pool3;
                    if (isRetail) { pool1 = cleanGaps(gapPools.management).slice(0, 4); pool2 = cleanGaps(gapPools.finance).slice(0, 3); pool3 = cleanGaps(gapPools.operations).slice(0, 3); }
                    else if (isTrades) { pool1 = cleanGaps(gapPools.management).slice(0, 4); pool2 = cleanGaps(gapPools.finance).slice(0, 3); pool3 = cleanGaps(gapPools.creative).slice(0, 3); }
                    else if (isTech) { pool1 = cleanGaps(gapPools.finance).slice(0, 4); pool2 = cleanGaps(gapPools.operations).slice(0, 3); pool3 = cleanGaps(gapPools.data).slice(0, 3); }
                    else { pool1 = cleanGaps(gapPools.technical).slice(0, 4); pool2 = cleanGaps(gapPools.data).slice(0, 3); pool3 = cleanGaps(gapPools.finance).slice(0, 3); }
                    pool1.concat(pool2).concat(pool3).forEach(function(g) {
                        parsedSkills.push({ name: g.name, requirement: 'Required', proficiency: 'Expert', category: g.cat });
                    });
                }
                
                return {
                    id: meta.id, title: meta.title, company: meta.company,
                    sourceUrl: '', sourceNote: 'Sample job for demo',
                    rawText: meta.rawText, parsedSkills: parsedSkills,
                    parsedRoles: meta.parsedRoles, seniority: meta.seniority,
                    addedAt: new Date().toISOString(),
                    sample: true  // LOCKED — non-admin cannot edit or delete
                };
            });
            
            // Score each job against the profile and match to BLS
            jobs.forEach(function(job) {
                job.matchData = matchJobToProfile({ skills: job.parsedSkills, roles: job.parsedRoles });
                job.blsSalary = matchJobToBLS(job.title, job.rawText);
            });
            
            // Sort: high match first
            jobs.sort(function(a, b) { return (b.matchData.score || 0) - (a.matchData.score || 0); });
            
            var detectedType = isRecruiter ? 'recruiter' : isProduct ? 'product' : isRetail ? 'retail' : isTrades ? 'trades' : (isStrategy || !isTech) ? 'strategy' : 'technology';
            console.log('📋 Injected ' + jobs.length + ' calibrated sample jobs for ' + profileName + ' (type: ' + detectedType + ')');
            
            return jobs;
        }
        
        function loadTemplate(templateId) {
            const template = templates[templateId];
            if (!template) {
                console.error('Template not found:', templateId);
                return false;
            }
            
            console.log('📋 Loading template:', templateId);
            console.log('  → Template has', template.skills.length, 'skills');
            console.log('  → First skill:', template.skills[0].name);
            console.log('  → First skill has evidence:', template.skills[0].evidence ? `YES (${template.skills[0].evidence.length} items)` : 'NO');
            
            userData = {
                initialized: true,
                profile: {...template.profile},
                skills: [...template.skills],
                skillDetails: {},
                values: template.values ? [...template.values] : [],
                purpose: template.purpose || "",
                roles: [...template.roles],
                workHistory: template.workHistory ? JSON.parse(JSON.stringify(template.workHistory)) : [],
                education: template.education ? JSON.parse(JSON.stringify(template.education)) : [],
                certifications: template.certifications ? JSON.parse(JSON.stringify(template.certifications)) : [],
                verifications: template.verifications ? JSON.parse(JSON.stringify(template.verifications)) : [],
                preferences: {
                    seniorityLevel: template.profile.roleLevel || "Mid-Career",
                    targetTitles: [],
                    seniorityKeywords: ['vp', 'vice president', 'chief', 'head of', 'director', 'principal', 'senior director'],
                    excludeRoles: ['engineer', 'developer', 'designer', 'analyst', 'coordinator', 'specialist', 
                                  'junior', 'mid-level', 'associate', 'intern', 'entry', 'qa', 'frontend', 'backend',
                                  'full stack', 'fullstack', 'software', 'devops', 'ui/ux', 'data scientist'],
                    strategicKeywords: ['strategy', 'strategic', 'transformation', 'innovation', 'evangelist', 
                                       'thought leader', 'advisory', 'ai', 'ml', 'product', 'growth', 'business'],
                    targetIndustries: [],
                    minSalary: null,
                    locationPreferences: ["US", "Remote"],
                    minimumSkillMatches: 3,
                    minimumMatchScore: 50
                },
                applications: [],
                savedJobs: template.savedJobs ? JSON.parse(JSON.stringify(template.savedJobs)) : [],
                templateId: templateId  // Store which template this is
            };
            
            // Inject sample jobs for manifest-loaded sample profiles (always refresh on load)
            var isManifestProfile = false;
            if (window.profilesManifest && window.profilesManifest.profiles) {
                isManifestProfile = window.profilesManifest.profiles.some(function(p) { return p.id === templateId; });
            }
            if (isManifestProfile || templateId.indexOf('demo') !== -1 || templateId.indexOf('sample') !== -1) {
                userData.savedJobs = getSampleJobsForProfile(templateId, template);
            }
            
            console.log('  → userData.skills[0] has evidence:', userData.skills[0].evidence ? `YES (${userData.skills[0].evidence.length} items)` : 'NO');
            
            // Load skill evidence if it exists
            fetch('skill_evidence.json')
                .then(response => response.json())
                .then(data => {
                    userData.skillDetails = data;
                    console.log('✓ Loaded evidence for', Object.keys(data).length, 'skills');
                })
                .catch(error => console.log('No skill evidence file found'));
            
            saveUserData();
            console.log('✓ Template loaded:', template.templateName);
            return true;
        }
        
        // Initialize app - check for profile or show welcome

        // ===== HYDRATE SVG ICONS =====
        // Replaces data-icon placeholder spans with actual SVG markup
        function hydrateIcons() {
            document.querySelectorAll('[data-icon]').forEach(function(el) {
                var name = el.getAttribute('data-icon');
                var size = el.classList.contains('mobile-nav-icon') ? 20 : 
                           el.classList.contains('nav-icon') ? 16 : 
                           el.classList.contains('overflow-icon') ? 16 : 18;
                el.innerHTML = bpIcon(name, size);
                el.removeAttribute('data-icon');
            });
        }

        async function initializeApp() {
            initTheme(); // Apply saved theme before anything renders
            // Load profile manifest and templates dynamically
            try {
                const cacheBust = `?v=${Date.now()}`;
                
                // STEP 1: Load profiles manifest
                console.log('📋 Loading profiles manifest...');
                var sp = document.getElementById('splashProgress');
                if (sp) sp.style.width = '20%';
                const manifest = await fetch(`profiles-manifest.json${cacheBust}`).then(r => r.json());
                window.profilesManifest = manifest; // Store for profile selector
                
                // STEP 2: Load all enabled profiles from manifest
                const enabledProfiles = manifest.profiles.filter(p => p.enabled);
                console.log(`✓ Found ${enabledProfiles.length} enabled profiles in manifest`);
                
                for (const profileMeta of enabledProfiles) {
                    try {
                        const template = await fetch(`${profileMeta.path}${cacheBust}`).then(r => r.json());
                        templates[profileMeta.id] = template;
                        console.log(`  ✓ Loaded: ${profileMeta.name} (${profileMeta.title}) from ${profileMeta.path}`);
                    } catch (err) {
                        console.error(`  ✗ Failed to load ${profileMeta.path}:`, err);
                    }
                }
                
                // STEP 3: Load blank template
                const blankTemplate = await fetch(`profiles/templates/blank.json${cacheBust}`).then(r => r.json());
                templates['blank'] = blankTemplate;
                
                console.log(`✓ Profile loading complete: ${enabledProfiles.length} profiles ready`);
                if (sp) sp.style.width = '60%';
                
                // STEP 4: Build profile selector dropdown
                buildProfileSelector(enabledProfiles);
                
            } catch (e) {
                console.error('Error loading profiles:', e);
            }
            
            // Load O*NET skills library
            try {
                const onetLib = await fetch('onet-skills-library.json').then(r => r.json());
                window.onetSkillsLibrary = onetLib;
                console.log('✓ O*NET Skills Library loaded');
            } catch (e) {
                console.error('Error loading O*NET skills library:', e);
            }
            
            // Load O*NET abilities library  
            try {
                const abilitiesLib = await fetch('onet-abilities-library.json').then(r => r.json());
                window.onetAbilitiesLibrary = abilitiesLib;
                console.log('✓ O*NET Abilities Library loaded');
            } catch (e) {
                console.error('Error loading O*NET abilities library:', e);
            }
            
            // Load O*NET work styles library
            try {
                const workStylesLib = await fetch('onet-workstyles-library.json').then(r => r.json());
                window.onetWorkStylesLibrary = workStylesLib;
                const wsCount = workStylesLib.workStyles?.length || workStylesLib.count || '?';
                console.log(`✓ O*NET Work Styles Library loaded (${wsCount} work styles)`);
            } catch (e) {
                console.error('Error loading O*NET work styles library:', e);
            }
            
            // Load O*NET knowledge library
            try {
                const knowledgeLib = await fetch('onet-knowledge-library.json').then(r => r.json());
                window.onetKnowledgeLibrary = knowledgeLib;
                const kCount = knowledgeLib.knowledge?.length || knowledgeLib.count || '?';
                console.log(`✓ O*NET Knowledge Library loaded (${kCount} knowledge domains)`);
            } catch (e) {
                console.warn('O*NET Knowledge Library not yet deployed (onet-knowledge-library.json)');
            }
            
            // Load O*NET work activities library
            try {
                const activitiesLib = await fetch('onet-work-activities-library.json').then(r => r.json());
                window.onetWorkActivitiesLibrary = activitiesLib;
                const aCount = activitiesLib.activities?.length || activitiesLib.count || '?';
                console.log(`✓ O*NET Work Activities Library loaded (${aCount} work activities)`);
            } catch (e) {
                console.warn('O*NET Work Activities Library not yet deployed (onet-work-activities-library.json)');
            }
            
            // Load Trades & Creative skills library
            try {
                const tradesLib = await fetch('trades-creative-library.json').then(r => r.json());
                window.tradesCreativeLibrary = tradesLib;
                const tCount = tradesLib.count || 0;
                console.log(`✓ Trades & Creative Library loaded (${tCount} skills)`);
            } catch (e) {
                console.warn('Trades & Creative Library not yet deployed (trades-creative-library.json)');
            }
            
            // Load values library
            try {
                const lib = await fetch('values-library.json').then(r => r.json());
                valuesLibrary = lib.values || [];
                console.log('✓ Values library loaded:', valuesLibrary.length, 'values');
            } catch (e) {
                console.error('Error loading values library:', e);
            }
            
            // Load BLS OEWS wage data
            try {
                const blsData = await fetch('bls-wages.json').then(r => r.json());
                window.blsWages = blsData;
                console.log(`✅ BLS wage data loaded: ${blsData.count} occupations (${blsData.period})`);
            } catch (e) {
                console.warn('BLS wage data not found (bls-wages.json). Salary engine will use built-in tables only.');
                window.blsWages = null;
            }
            
            // ===== PROFILE DECISION FLOW =====
            const currentProfile = safeGet('currentProfile');
            
            // Always load a scaffold template so nav/rendering works
            var scaffoldId = currentProfile || 'cliff-jones-demo';
            if (!templates[scaffoldId]) scaffoldId = 'cliff-jones-demo';
            if (templates[scaffoldId]) loadTemplate(scaffoldId);
            initializeMainApp();
            
            // Determine which view to show
            var targetView = 'welcome'; // Default: welcome page
            
            // CASE 1: Signed-in user with Firestore data (skip for manifest sample profiles)
            var isDemoProfile = false;
            if (window.profilesManifest && window.profilesManifest.profiles) {
                isDemoProfile = window.profilesManifest.profiles.some(function(p) { return p.id === scaffoldId; });
            }
            if (!isDemoProfile) isDemoProfile = scaffoldId && (scaffoldId.indexOf('demo') !== -1 || scaffoldId.indexOf('sample') !== -1);
            if (fbUser && fbDb && !isDemoProfile) {
                try {
                    var loaded = await loadUserFromFirestore(fbUser.uid);
                    if (loaded) {
                        console.log('☁ Firestore profile applied');
                        targetView = 'blueprint';
                    }
                } catch(e) {
                    console.warn('Firestore load failed:', e);
                }
                checkReadOnly();
                rebuildProfileDropdown();
            } else if (fbUser && fbDb && isDemoProfile) {
                console.log('📋 Demo profile active — skipping Firestore load');
                targetView = 'blueprint';
                checkReadOnly();
                rebuildProfileDropdown();
            }
            // CASE 2: Not signed in → welcome page
            else {
                checkReadOnly();
            }
            
            // Always rebuild dropdown after manifest is available
            rebuildProfileDropdown();
            
            // Return target view so DOMContentLoaded can use it
            return targetView;
        }
        
        // Non-intrusive first-visit prompt to build own profile

        // Show welcome screen for new users
        
        // Start with selected template
        window.startWithTemplate = function(templateId) {
            console.log('🎯 Starting with template:', templateId);
            
            if (!templates[templateId]) {
                showToast('Template not found. Please refresh and try again.', 'error');
                return;
            }
            
            if (loadTemplate(templateId)) {
                console.log('✓ Template loaded successfully');
                
                // If blank, show onboarding wizard
                if (templateId === 'blank') {
                    showOnboardingWizard();
                } else {
                    // Force hard reload with cache bypass
                    console.log('🔄 Reloading page...');
                    window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
                }
            } else {
                showToast('Failed to load template. Please try again.', 'error');
            }
        };
        
        // Import profile from JSON file
        window.importProfile = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    userData = imported;
                    userData.initialized = true;
                    saveUserData();
                    location.reload();
                } catch (error) {
                    showToast('Import error: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        };
        
        // =====================================================================
        // ONBOARDING WIZARD v1.0
        // Multi-step guided profile builder with Claude AI resume parsing
        // =====================================================================

        let wizardState = {
            step: 1,
            totalSteps: 8,
            resumeText: '',
            parsedData: null,
            profile: {},
            skills: [],
            values: [],
            purpose: '',
            processing: false
        };

        function showOnboardingWizard() {
            if (demoGate('Build Your Blueprint')) return;
            // Remove any existing wizard
            const existing = document.getElementById('onboardingWizard');
            if (existing) existing.remove();

            wizardState = { step: 1, totalSteps: 8, resumeText: '', parsedData: null,
                            profile: {}, skills: [], values: [], purpose: '', processing: false };

            const overlay = document.createElement('div');
            overlay.id = 'onboardingWizard';
            overlay.style.cssText = `
                position: fixed; inset: 0; z-index: 50000;
                background: var(--bg-base);
                display: flex; flex-direction: column;
                overflow: hidden;
            `;
            document.body.appendChild(overlay);
            renderWizardStep();
        }

        function closeWizard() {
            const el = document.getElementById('onboardingWizard');
            if (el) el.remove();
        }

        function renderWizardStep() {
            const overlay = document.getElementById('onboardingWizard');
            if (!overlay) return;

            const steps = [
                { label: 'Start' },
                { label: 'Resume' },
                { label: 'Parsing' },
                { label: 'Profile' },
                { label: 'Skills' },
                { label: 'Values' },
                { label: 'Purpose' },
                { label: 'Complete' }
            ];

            const progressPct = ((wizardState.step - 1) / (wizardState.totalSteps - 1)) * 100;

            overlay.innerHTML = `
                <!-- Wizard Header -->
                <div style="display:flex; align-items:center; justify-content:space-between;
                            padding:0 28px; height:56px; border-bottom:1px solid var(--border);
                            background:var(--nav-bg); backdrop-filter:blur(20px); flex-shrink:0;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:28px; height:28px; display:flex; align-items:center; justify-content:center;">
                            <svg width="24" height="24" viewBox="0 0 52 52" fill="none"><circle cx="26" cy="26" r="24" stroke="#60a5fa" stroke-width="1.5" opacity="0.25"/><line x1="26" y1="26" x2="12" y2="10" stroke="#60a5fa" stroke-width="1.5" opacity="0.5"/><line x1="26" y1="26" x2="42" y2="12" stroke="#60a5fa" stroke-width="1.5" opacity="0.5"/><line x1="26" y1="26" x2="40" y2="40" stroke="#60a5fa" stroke-width="1.5" opacity="0.5"/><line x1="26" y1="26" x2="10" y2="40" stroke="#60a5fa" stroke-width="1.5" opacity="0.5"/><circle cx="26" cy="26" r="5" fill="#60a5fa"/><circle cx="12" cy="10" r="3.5" fill="#93bbfc"/><circle cx="42" cy="12" r="3" fill="#818cf8"/><circle cx="40" cy="40" r="3.5" fill="#93bbfc"/><circle cx="10" cy="40" r="3" fill="#818cf8"/></svg></div>
                        <span style="font-family:'Outfit',sans-serif; font-weight:500; color:var(--accent); font-size:0.82em; letter-spacing:0.22em; text-transform:uppercase;">
                            Blueprint
                        </span>
                        <span style="color:var(--text-muted); font-size:0.8em; margin-left:8px;">
                            Build Your Profile
                        </span>
                    </div>
                    <div style="display:flex; align-items:center; gap:16px;">
                        <span style="font-size:0.78em; color:var(--text-muted);">
                            Step ${wizardState.step} of ${wizardState.totalSteps}
                        </span>
                        <button onclick="confirmExitWizard()" style="
                            background:none; border:1px solid var(--border); border-radius:7px;
                            padding:5px 12px; color:var(--text-secondary); cursor:pointer; font-size:0.8em;">
                            Exit
                        </button>
                    </div>
                </div>

                <!-- Progress bar -->
                <div style="height:3px; background:var(--border); flex-shrink:0;">
                    <div style="height:100%; width:${progressPct}%;
                                background:linear-gradient(90deg,var(--accent),#818cf8);
                                transition:width 0.4s ease;"></div>
                </div>

                <!-- Step indicators -->
                <div style="display:flex; justify-content:center; gap:4px; padding:14px 28px 0;
                            flex-shrink:0; flex-wrap:wrap;">
                    ${steps.map((s, i) => {
                        const n = i + 1;
                        const active = n === wizardState.step;
                        const done = n < wizardState.step;
                        return `<div style="display:flex; align-items:center; gap:4px;">
                            <div style="width:22px; height:22px; border-radius:50%; display:flex;
                                        align-items:center; justify-content:center; font-size:0.7em;
                                        font-weight:700; transition:all 0.2s;
                                        background:${done ? 'var(--accent)' : active ? 'var(--accent)' : 'var(--input-bg)'};
                                        color:${done || active ? '#fff' : 'var(--text-muted)'};
                                        border:2px solid ${done || active ? 'var(--accent)' : 'var(--border)'};">
                                ${done ? '✓' : n}
                            </div>
                            <span style="font-size:0.72em; color:${active ? 'var(--accent)' : 'var(--text-muted)'};">
                                ${s.label}
                            </span>
                            ${i < steps.length - 1 ? '<div style="width:12px; height:1px; background:var(--border); margin:0 2px;"></div>' : ''}
                        </div>`;
                    }).join('')}
                </div>

                <!-- Step content -->
                <div id="wizardStepContent" style="flex:1; overflow-y:auto; padding:32px 28px;">
                    <div style="max-width:700px; margin:0 auto;" id="wizardInner">
                        <!-- Populated per step -->
                    </div>
                </div>
            `;

            // Render the current step content
            const inner = document.getElementById('wizardInner');
            switch(wizardState.step) {
                case 1: renderWizardStep1(inner); break;
                case 2: renderWizardStep2(inner); break;
                case 3: renderWizardStep3(inner); break;
                case 4: renderWizardStep4(inner); break;
                case 5: renderWizardStep5(inner); break;
                case 6: renderWizardStep6(inner); break;
                case 7: renderWizardStep7(inner); break;
                case 8: renderWizardStep8(inner); break;
            }
        }

        function wizardNext() {
            wizardState.step = Math.min(wizardState.step + 1, wizardState.totalSteps);
            renderWizardStep();
        }

        function wizardBack() {
            wizardState.step = Math.max(wizardState.step - 1, 1);
            renderWizardStep();
        }

        function confirmExitWizard() {
            if (wizardState.step > 2) {
                if (!confirm('Exit the wizard? Your progress will be lost.')) return;
            }
            closeWizard();
        }

        // ── Shared UI helpers ─────────────────────────────────────────────────
        // [removed] wizardCard — dead code cleanup v4.22.0

        function wizardHeading(icon, title, subtitle) {
            return `<div style="text-align:center; margin-bottom:32px;">
                        <div style="font-size:2.8em; margin-bottom:12px;">${icon}</div>
                        <h2 style="color:var(--text-primary); font-size:1.6em; font-weight:700;
                                   margin-bottom:8px; letter-spacing:-0.02em;">${title}</h2>
                        <p style="color:var(--text-secondary); font-size:0.95em; line-height:1.6;
                                  max-width:500px; margin:0 auto;">${subtitle}</p>
                    </div>`;
        }

        function wizardBtn(label, onclick, style='primary') {
            const styles = {
                primary: `background:var(--accent); color:#fff; border:none;`,
                secondary: `background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border);`,
                ghost: `background:none; color:var(--text-secondary); border:1px solid var(--border);`
            };
            return `<button onclick="${onclick}" style="${styles[style]}
                        padding:11px 24px; border-radius:9px; cursor:pointer; font-size:0.9em;
                        font-weight:600; transition:all 0.18s; letter-spacing:0.01em;">
                        ${label}
                    </button>`;
        }

        // ── STEP 1: Entry point ───────────────────────────────────────────────

        function renderWizardStep1(el) {
            el.innerHTML = `
                ${wizardHeading(bpIcon('blueprint',22), 'Build Your Blueprint',
                    'Most people undersell themselves when applying for work — not because they lack ability, but because they’ve never had the right tool to articulate it. This changes that.')}

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px;">
                    <div onclick="wizardChooseUpload()" id="card-upload"
                         style="background:var(--bg-elevated); border:2px solid var(--border);
                                border-radius:12px; padding:28px; cursor:pointer; transition:all 0.2s;
                                text-align:center;"
                         onmouseover="this.style.borderColor='var(--accent)'"
                         onmouseout="this.style.borderColor='var(--border)'">
                        <div style="margin-bottom:12px;">${bpIcon("file-text",32)}</div>
                        <div style="font-weight:700; color:var(--text-primary); margin-bottom:6px;">Upload Resume</div>
                        <div style="font-size:0.85em; color:var(--text-secondary); line-height:1.5;">
                            PDF or paste text. Claude reads it and builds your profile automatically.
                        </div>
                        <div style="margin-top:14px; font-size:0.78em; color:var(--accent); font-weight:600;">
                            RECOMMENDED — Fastest setup
                        </div>
                    </div>

                    <div onclick="wizardChooseManual()" id="card-manual"
                         style="background:var(--bg-elevated); border:2px solid var(--border);
                                border-radius:12px; padding:28px; cursor:pointer; transition:all 0.2s;
                                text-align:center;"
                         onmouseover="this.style.borderColor='var(--accent)'"
                         onmouseout="this.style.borderColor='var(--border)'">
                        <div style="font-size:2.2em; margin-bottom:12px;">${bpIcon('edit',32)}</div>
                        <div style="font-weight:700; color:var(--text-primary); margin-bottom:6px;">Start Fresh</div>
                        <div style="font-size:0.85em; color:var(--text-secondary); line-height:1.5;">
                            Build your profile step by step. Good if you don't have a resume handy.
                        </div>
                    </div>
                </div>

                <div onclick="wizardChooseImport()"
                     style="background:var(--bg-elevated); border:2px dashed var(--border);
                            border-radius:12px; padding:18px 24px; cursor:pointer; transition:all 0.2s;
                            display:flex; align-items:center; gap:16px; margin-bottom:24px;"
                     onmouseover="this.style.borderColor='var(--accent)'"
                     onmouseout="this.style.borderColor='var(--border)'">
                    <div>${bpIcon("layers",28)}</div>
                    <div>
                        <div style="font-weight:600; color:var(--text-primary); font-size:0.9em;">
                            Import Saved Blueprint
                        </div>
                        <div style="font-size:0.82em; color:var(--text-secondary);">
                            Already have a profile JSON? Load it here.
                        </div>
                    </div>
                    <input type="file" id="wizardImportFile" accept=".json" style="display:none"
                           onchange="wizardImportProfile(event)">
                </div>

                <p style="text-align:center; font-size:0.8em; color:var(--text-muted); margin-top:8px;">
                    ${bpIcon("lock",14)} Your data is saved securely to your account. You own everything.
                </p>
            `;
        }

        function wizardChooseUpload() {
            wizardState.entryMode = 'upload';
            wizardNext();
        }

        function wizardChooseManual() {
            wizardState.entryMode = 'manual';
            // Skip parsing step - go straight to profile
            wizardState.step = 4;
            renderWizardStep();
        }

        function wizardChooseImport() {
            document.getElementById('wizardImportFile').click();
        }

        function wizardImportProfile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    userData = { ...imported, initialized: true };
                    saveUserData();
                    closeWizard();
                    location.reload();
                } catch(err) {
                    showToast('File read error: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // ── STEP 2: Resume input ──────────────────────────────────────────────

        function renderWizardStep2(el) {
            el.innerHTML = `
                ${wizardHeading(bpIcon('file-text',22), 'Add Your Resume',
                    'Paste your resume text below, or upload a PDF. Claude will read it and extract your skills, experience, and outcomes automatically.')}

                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:24px; margin-bottom:20px;">
                    <div style="display:flex; gap:8px; margin-bottom:16px;">
                        <button onclick="wizardSetResumeTab('paste')" id="rtab-paste"
                                style="padding:7px 16px; border-radius:7px; border:none; cursor:pointer;
                                       background:var(--accent); color:#fff; font-size:0.85em; font-weight:600;">
                            Paste Text
                        </button>
                        <button onclick="wizardSetResumeTab('linkedin')" id="rtab-linkedin"
                                style="padding:7px 16px; border-radius:7px; border:1px solid var(--border);
                                       background:var(--input-bg); color:var(--text-secondary);
                                       cursor:pointer; font-size:0.85em;">
                            LinkedIn Text
                        </button>
                    </div>

                    <div id="rtab-paste-content">
                        <textarea id="wizardResumeText" placeholder="Paste your full resume here — the more detail, the better the profile Claude builds for you.

Include: job titles, companies, dates, responsibilities, achievements, metrics, skills, education, certifications..."
                                  style="width:100%; min-height:280px; background:var(--input-bg);
                                         border:1px solid var(--border); border-radius:8px; padding:14px;
                                         color:var(--text-primary); font-size:0.88em; line-height:1.7;
                                         font-family:inherit; resize:vertical; outline:none;
                                         transition:border-color 0.2s;"
                                  onfocus="this.style.borderColor='var(--accent)'"
                                  onblur="this.style.borderColor='var(--border)'"
                                  oninput="wizardCheckResumeReady()">${wizardState.resumeText}</textarea>
                    </div>

                    <div id="rtab-linkedin-content" style="display:none;">
                        <p style="color:var(--text-secondary); font-size:0.85em; line-height:1.6; margin-bottom:14px;">
                            Go to your LinkedIn profile → click <strong>More</strong> → <strong>Save to PDF</strong>,
                            then paste the text here. Or copy your About section and each job entry manually.
                        </p>
                        <textarea id="wizardLinkedInText" placeholder="Paste your LinkedIn profile text here..."
                                  style="width:100%; min-height:240px; background:var(--input-bg);
                                         border:1px solid var(--border); border-radius:8px; padding:14px;
                                         color:var(--text-primary); font-size:0.88em; line-height:1.7;
                                         font-family:inherit; resize:vertical; outline:none;"
                                  oninput="wizardCheckResumeReady()"></textarea>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    ${wizardBtn('← Back', 'wizardBack()', 'ghost')}
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button onclick="wizardSkipParsing()"
                                style="background:none; border:none; color:var(--text-muted);
                                       cursor:pointer; font-size:0.82em; text-decoration:underline;">
                            Skip — enter manually
                        </button>
                        <button id="wizardParseBtn" onclick="wizardStartParsing()" disabled
                                style="background:var(--accent); color:#fff; border:none;
                                       padding:11px 28px; border-radius:9px; cursor:pointer;
                                       font-size:0.9em; font-weight:600; opacity:0.5; transition:opacity 0.2s;">
                            Parse with Claude →
                        </button>
                    </div>
                </div>
            `;
        }

        function wizardSetResumeTab(tab) {
            const paste = document.getElementById('rtab-paste-content');
            const li = document.getElementById('rtab-linkedin-content');
            const btnPaste = document.getElementById('rtab-paste');
            const btnLi = document.getElementById('rtab-linkedin');

            if (tab === 'paste') {
                paste.style.display = 'block'; li.style.display = 'none';
                btnPaste.style.background = 'var(--accent)'; btnPaste.style.color = '#fff';
                btnPaste.style.border = 'none';
                btnLi.style.background = 'var(--input-bg)'; btnLi.style.color = 'var(--text-secondary)';
                btnLi.style.border = '1px solid var(--border)';
            } else {
                paste.style.display = 'none'; li.style.display = 'block';
                btnLi.style.background = 'var(--accent)'; btnLi.style.color = '#fff';
                btnLi.style.border = 'none';
                btnPaste.style.background = 'var(--input-bg)'; btnPaste.style.color = 'var(--text-secondary)';
                btnPaste.style.border = '1px solid var(--border)';
            }
        }

        function wizardCheckResumeReady() {
            const t1 = document.getElementById('wizardResumeText')?.value?.trim() || '';
            const t2 = document.getElementById('wizardLinkedInText')?.value?.trim() || '';
            const hasText = t1.length > 50 || t2.length > 50;
            const btn = document.getElementById('wizardParseBtn');
            if (btn) {
                btn.disabled = !hasText;
                btn.style.opacity = hasText ? '1' : '0.5';
                btn.style.cursor = hasText ? 'pointer' : 'default';
            }
        }

        function wizardSkipParsing() {
            wizardState.entryMode = 'manual';
            wizardState.step = 4;
            renderWizardStep();
        }

        async function wizardStartParsing() {
            const t1 = document.getElementById('wizardResumeText')?.value?.trim() || '';
            const t2 = document.getElementById('wizardLinkedInText')?.value?.trim() || '';
            wizardState.resumeText = t1 || t2;
            wizardNext(); // Go to step 3 (parsing/loading)
            await wizardRunParsing();
        }

        // ── STEP 3: AI Parsing ────────────────────────────────────────────────

        function renderWizardStep3(el) {
            el.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center;
                            justify-content:center; min-height:320px; text-align:center; gap:24px;">
                    <div id="wizardParsingIcon" style="animation:spin 2s linear infinite;">${bpIcon("settings",48)}</div>
                    <div>
                        <h2 style="color:var(--text-primary); font-size:1.4em; margin-bottom:10px;">
                            Claude is reading your resume
                        </h2>
                        <p id="wizardParsingStatus" style="color:var(--text-secondary); font-size:0.9em;">
                            Extracting skills, evidence, and outcomes...
                        </p>
                    </div>
                    <div style="width:280px; height:4px; background:var(--border); border-radius:4px; overflow:hidden;">
                        <div id="wizardParseProgress" style="height:100%; width:0%;
                                    background:linear-gradient(90deg,var(--accent),#818cf8);
                                    border-radius:4px; transition:width 0.5s ease;"></div>
                    </div>
                    <p style="color:var(--text-muted); font-size:0.8em;">Usually takes 10–20 seconds</p>
                </div>
            `;
        }

        async function wizardRunParsing() {
            const setStatus = (msg, pct) => {
                const s = document.getElementById('wizardParsingStatus');
                const p = document.getElementById('wizardParseProgress');
                if (s) s.textContent = msg;
                if (p) p.style.width = pct + '%';
            };

            try {
                setStatus('Sending to Claude...', 15);

                const systemPrompt = `You are a professional career analyst. Extract structured profile data from a resume or LinkedIn profile text.

Return ONLY valid JSON in this exact shape — no markdown, no explanation, just the JSON object:
{
  "profile": {
    "name": "Full Name",
    "currentTitle": "Current Job Title",
    "location": "City, State or Remote",
    "email": "",
    "phone": "",
    "yearsExperience": 10,
    "executiveSummary": "2-3 sentence professional summary in first person"
  },
  "roles": [
    { "id": "role1", "name": "Role Name", "years": "2019-Present", "company": "Company Name" }
  ],
  "skills": [
    {
      "name": "Skill Name",
      "level": "Mastery|Expert|Advanced|Proficient|Novice",
      "category": "skill|ability|workstyle|unique",
      "roles": ["role1"],
      "key": true,
      "evidence": [
        { "description": "What you did", "outcome": "Measurable result or impact" }
      ]
    }
  ],
  "values": [
    { "name": "Value Name", "description": "Brief personal description of this value", "selected": true }
  ],
  "purpose": "One paragraph purpose statement in first person — what you do, who you help, how you do it differently"
}

Rules:
- Extract 15-40 skills. Include technical skills, soft skills, leadership abilities, and unique differentiators.
- Level guide: Mastery=career-defining expertise (15+ yrs), Expert=deep proficiency (8-15 yrs), Advanced=strong competency (4-8 yrs), Proficient=solid (1-4 yrs), Novice=learning.
- For each skill, extract 1-3 evidence items from the resume. Outcomes must be specific — include numbers, percentages, dollar amounts wherever present in the text.
- Infer 4-6 values from the resume's tone, achievements, and career pattern. Make them personal, not generic.
- Write the purpose statement to be compelling and authentic to this person's actual experience.
- category="unique" for skills not in standard O*NET taxonomy (industry-specific, rare combinations).`;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        system: systemPrompt,
                        messages: [{ role: 'user', content: `Parse this resume:

${wizardState.resumeText}` }]
                    })
                });

                setStatus('Structuring your profile data...', 55);

                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                const rawText = data.content[0]?.text || '';

                setStatus('Extracting skills and evidence...', 75);

                // Strip markdown fences if present
                const clean = rawText.replace(/^```json\s*/i, '').replace(/^```\s*/i, '').replace(/```\s*$/i, '').trim();
                const parsed = JSON.parse(clean);

                setStatus('Building your Blueprint...', 95);

                wizardState.parsedData = parsed;
                wizardState.profile = parsed.profile || {};
                wizardState.skills = parsed.skills || [];
                wizardState.values = (parsed.values || []).map(v => ({ ...v, selected: v.selected !== false }));
                wizardState.purpose = parsed.purpose || '';

                await new Promise(r => setTimeout(r, 600));
                setStatus('Done! ✓', 100);
                await new Promise(r => setTimeout(r, 400));

                wizardState.step = 4;
                renderWizardStep();

            } catch (err) {
                console.error('Parsing error:', err);
                const el = document.getElementById('wizardParsingIcon');
                if (el) el.style.animation = 'none';
                const status = document.getElementById('wizardParsingStatus');
                if (status) status.innerHTML = `
                    <span style="color:var(--danger);">
                        Parsing failed: ${err.message}<br><br>
                    </span>
                    <button onclick="wizardState.step=2; renderWizardStep();"
                            style="background:var(--accent); color:#fff; border:none; padding:9px 20px;
                                   border-radius:7px; cursor:pointer; font-size:0.85em; margin-right:10px;">
                        ← Try Again
                    </button>
                    <button onclick="wizardSkipParsing()"
                            style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border);
                                   padding:9px 20px; border-radius:7px; cursor:pointer; font-size:0.85em;">
                        Enter Manually
                    </button>
                `;
            }
        }

        // ── STEP 4: Profile review ─────────────────────────────────────────────

        function renderWizardStep4(el) {
            const p = wizardState.profile;
            const isFromResume = !!wizardState.parsedData;

            el.innerHTML = `
                ${wizardHeading(isFromResume ? bpIcon('check',22) : bpIcon('profile',22), 
                    isFromResume ? 'Review Your Profile' : 'Your Profile',
                    isFromResume ? 'Claude extracted this from your resume. Review and correct anything that’s off.' 
                                 : 'Fill in your basic information to get started.')}

                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:24px; margin-bottom:20px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        ${wizardField('Full Name', 'wizardName', p.name || '', 'e.g. Alex Johnson')}
                        ${wizardField('Current Title', 'wizardTitle', p.currentTitle || '', 'e.g. VP of Engineering')}
                        ${wizardField('Location', 'wizardLocation', p.location || '', 'e.g. Austin, TX / Remote')}
                        ${wizardField('Email', 'wizardEmail', p.email || '', 'your@email.com')}
                        ${wizardField('Years of Experience', 'wizardYears', p.yearsExperience || '', 'e.g. 15')}
                        ${wizardField('Phone (optional)', 'wizardPhone', p.phone || '', '')}
                    </div>
                    <div style="margin-top:16px;">
                        <label style="display:block; font-size:0.82em; font-weight:600;
                                      color:var(--text-secondary); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.04em;">
                            Professional Summary
                        </label>
                        <textarea id="wizardSummary" placeholder="A 2-3 sentence summary of who you are professionally..."
                                  style="width:100%; min-height:100px; background:var(--input-bg);
                                         border:1px solid var(--border); border-radius:8px; padding:12px;
                                         color:var(--text-primary); font-size:0.9em; line-height:1.6;
                                         font-family:inherit; resize:vertical; outline:none;"
                                  onfocus="this.style.borderColor='var(--accent)'"
                                  onblur="this.style.borderColor='var(--border)'">${p.executiveSummary || ''}</textarea>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between;">
                    ${wizardBtn('← Back', wizardState.entryMode === 'manual' ? 'wizardBack()' : 'wizardBack()', 'ghost')}
                    ${wizardBtn('Continue → Skills', 'wizardSaveProfile()', 'primary')}
                </div>
            `;
        }

        function wizardField(label, id, value, placeholder) {
            return `<div>
                <label style="display:block; font-size:0.82em; font-weight:600;
                              color:var(--text-secondary); margin-bottom:6px;
                              text-transform:uppercase; letter-spacing:0.04em;">
                    ${label}
                </label>
                <input id="${id}" type="text" value="${(value || '').replace(/"/g, '&quot;')}"
                       placeholder="${placeholder}"
                       style="width:100%; padding:10px 12px; background:var(--input-bg);
                              border:1px solid var(--border); border-radius:8px;
                              color:var(--text-primary); font-size:0.9em; outline:none;
                              transition:border-color 0.2s; font-family:inherit;"
                       onfocus="this.style.borderColor='var(--accent)'"
                       onblur="this.style.borderColor='var(--border)'">
            </div>`;
        }

        function wizardSaveProfile() {
            wizardState.profile = {
                name: document.getElementById('wizardName')?.value?.trim() || '',
                currentTitle: document.getElementById('wizardTitle')?.value?.trim() || '',
                location: document.getElementById('wizardLocation')?.value?.trim() || '',
                email: document.getElementById('wizardEmail')?.value?.trim() || '',
                phone: document.getElementById('wizardPhone')?.value?.trim() || '',
                yearsExperience: parseInt(document.getElementById('wizardYears')?.value) || 0,
                executiveSummary: document.getElementById('wizardSummary')?.value?.trim() || ''
            };

            if (!wizardState.profile.name) {
                showToast('Please enter your name to continue.', 'warning');
                document.getElementById('wizardName')?.focus();
                return;
            }
            wizardNext();
        }

        // ── STEP 5: Skills review ──────────────────────────────────────────────

        function renderWizardStep5(el) {
            const skills = wizardState.skills;
            const isFromResume = skills.length > 0;
            const levelColors = { Mastery:'#ef4444', Expert:'#f97316', Advanced:'#f59e0b', Proficient:'#10b981', Novice:'#6b7280' };

            el.innerHTML = `
                ${wizardHeading(bpIcon('compass',22),
                    isFromResume ? `${skills.length} Skills Extracted` : 'Your Skills',
                    isFromResume ? 'Claude identified these from your resume. Toggle any off you do not want to include. You can add more later.'
                                 : 'Add your key skills. You can build this out further after setup.')}

                ${isFromResume ? `
                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:20px; margin-bottom:20px; max-height:420px; overflow-y:auto;">
                    ${skills.map((s, i) => `
                        <div style="display:flex; align-items:center; gap:12px; padding:10px 0;
                                    border-bottom:1px solid var(--border);">
                            <input type="checkbox" id="skill-check-${i}" checked
                                   style="width:16px; height:16px; cursor:pointer; accent-color:var(--accent);">
                            <div style="width:10px; height:10px; border-radius:50%; flex-shrink:0;
                                        background:${levelColors[s.level] || '#6b7280'};"></div>
                            <div style="flex:1; min-width:0;">
                                <div style="font-weight:600; color:var(--text-primary); font-size:0.9em;">
                                    ${s.name}
                                </div>
                                <div style="font-size:0.78em; color:var(--text-muted);">
                                    ${s.level} · ${s.evidence?.length || 0} evidence items
                                </div>
                            </div>
                            <span style="font-size:0.75em; padding:3px 9px; border-radius:10px;
                                         background:var(--chip-bg); color:var(--text-secondary);">
                                ${s.level}
                            </span>
                        </div>
                    `).join('')}
                </div>
                <p style="font-size:0.82em; color:var(--text-muted); margin-bottom:20px;">
                    Uncheck skills you want to exclude. You can add, edit, and add evidence to all skills after setup.
                </p>
                ` : `
                <div style="background:var(--bg-elevated); border:2px dashed var(--border);
                            border-radius:14px; padding:32px; text-align:center; margin-bottom:20px;">
                    <p style="color:var(--text-secondary); margin-bottom:16px;">
                        Skills are best built from your resume. You can add them manually in the Skills tab after setup.
                    </p>
                    <p style="color:var(--text-muted); font-size:0.85em;">
                        The system includes 90+ O*NET standard skills you can browse and add.
                    </p>
                </div>
                `}

                <div style="display:flex; justify-content:space-between;">
                    ${wizardBtn('← Back', 'wizardBack()', 'ghost')}
                    ${wizardBtn('Continue → Values', 'wizardSaveSkills()', 'primary')}
                </div>
            `;
        }

        function wizardSaveSkills() {
            // Filter to only checked skills
            wizardState.skills = wizardState.skills.filter((s, i) => {
                const cb = document.getElementById(`skill-check-${i}`);
                return !cb || cb.checked;
            });
            wizardNext();
        }

        // ── STEP 6: Values ────────────────────────────────────────────────────

        function renderWizardStep6(el) {
            const vals = wizardState.values.length > 0 ? wizardState.values : [
                { name: 'Intellectual Integrity', description: 'Evidence-based decisions. Challenge assumptions before accepting conclusions.', selected: true },
                { name: 'Outcome-Focused', description: 'Judge by impact delivered, not activity performed.', selected: true },
                { name: 'Continuous Learning', description: 'Seek disconfirming evidence. Update beliefs when data changes.', selected: true },
                { name: 'Authentic Leadership', description: 'Lead with transparency and truth.', selected: false },
                { name: 'Customer-Centric', description: 'Solve real problems. Understand needs before building.', selected: false },
                { name: 'Innovation', description: 'Find better ways. Challenge the status quo with purpose.', selected: false }
            ];
            wizardState.values = vals;

            const isFromResume = !!wizardState.parsedData;

            el.innerHTML = `
                ${wizardHeading(bpIcon('lightbulb',16),
                    'Your Professional Values',
                    isFromResume ? 'Claude inferred these from your career history. Select the ones that feel true. You can edit descriptions to make them personal.'
                                 : 'Select the values that define how you work. These appear in your Blueprint.')}

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:24px;">
                    ${vals.map((v, i) => `
                        <div onclick="wizardToggleValue(${i})" id="val-card-${i}"
                             style="background:var(--bg-elevated);
                                    border:2px solid ${v.selected ? 'var(--accent)' : 'var(--border)'};
                                    border-radius:10px; padding:14px; cursor:pointer; transition:all 0.18s;
                                    ${v.selected ? 'background:var(--accent-glow);' : ''}">
                            <div style="display:flex; align-items:start; gap:10px;">
                                <div style="width:18px; height:18px; border-radius:4px; flex-shrink:0; margin-top:2px;
                                            background:${v.selected ? 'var(--accent)' : 'var(--input-bg)'};
                                            border:2px solid ${v.selected ? 'var(--accent)' : 'var(--border)'};
                                            display:flex; align-items:center; justify-content:center;
                                            color:#fff; font-size:11px;">
                                    ${v.selected ? '✓' : ''}
                                </div>
                                <div style="flex:1;">
                                    <div style="font-weight:700; color:var(--text-primary); font-size:0.88em;
                                                margin-bottom:4px;">${v.name}</div>
                                    <div style="font-size:0.78em; color:var(--text-secondary);
                                                line-height:1.4;">${v.description || ''}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center;">
                    ${wizardBtn('← Back', 'wizardBack()', 'ghost')}
                    <div>
                        <span style="font-size:0.82em; color:var(--text-muted); margin-right:16px;">
                            ${vals.filter(v=>v.selected).length} selected
                        </span>
                        ${wizardBtn('Continue → Purpose', 'wizardSaveValues()', 'primary')}
                    </div>
                </div>
            `;
        }

        function wizardToggleValue(i) {
            wizardState.values[i].selected = !wizardState.values[i].selected;
            // Re-render step without full wizard rebuild
            const card = document.getElementById(`val-card-${i}`);
            const v = wizardState.values[i];
            if (card) {
                card.style.borderColor = v.selected ? 'var(--accent)' : 'var(--border)';
                card.style.background = v.selected ? 'var(--accent-glow)' : 'var(--bg-elevated)';
                const check = card.querySelector('div > div > div:first-child');
                if (check) {
                    check.style.background = v.selected ? 'var(--accent)' : 'var(--input-bg)';
                    check.style.borderColor = v.selected ? 'var(--accent)' : 'var(--border)';
                    check.textContent = v.selected ? '✓' : '';
                }
            }
            // Update count
            const countEl = document.querySelector('[style*="0.82em"][style*="var(--text-muted)"][style*="margin-right"]');
            if (countEl) countEl.textContent = wizardState.values.filter(v=>v.selected).length + ' selected';
        }

        function wizardSaveValues() {
            wizardNext();
        }

        // ── STEP 7: Purpose ───────────────────────────────────────────────────

        function renderWizardStep7(el) {
            const purpose = wizardState.purpose;
            const isFromResume = !!wizardState.parsedData;

            el.innerHTML = `
                ${wizardHeading(bpIcon('edit',22),
                    'Your Purpose Statement',
                    isFromResume ? 'Claude drafted this from your resume. Often the hardest thing to write about yourself — edit it until it sounds like you.'
                                 : 'Write a brief statement about what you do, who you help, and what makes your approach distinctive.')}

                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:24px; margin-bottom:20px;">
                    <textarea id="wizardPurpose"
                              placeholder="I help [who] achieve [what] through [how]. I bring [distinctive quality] that enables [specific outcome]..."
                              style="width:100%; min-height:160px; background:var(--input-bg);
                                     border:1px solid var(--border); border-radius:8px; padding:14px;
                                     color:var(--text-primary); font-size:0.95em; line-height:1.7;
                                     font-family:inherit; resize:vertical; outline:none;"
                              onfocus="this.style.borderColor='var(--accent)'"
                              onblur="this.style.borderColor='var(--border)'">${purpose}</textarea>

                    ${isFromResume ? `
                    <button onclick="wizardRegeneratePurpose()"
                            style="margin-top:12px; background:none; border:1px solid var(--border);
                                   border-radius:7px; padding:7px 14px; color:var(--text-secondary);
                                   cursor:pointer; font-size:0.82em; transition:all 0.18s;"
                            onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'"
                            onmouseout="this.style.borderColor='var(--border)'; this.style.color='var(--text-secondary)'">
                        ↺ Regenerate with Claude
                    </button>` : ''}
                </div>

                <div style="background:var(--accent-glow); border:1px solid var(--border);
                            border-radius:10px; padding:16px; margin-bottom:24px;">
                    <div style="font-size:0.82em; color:var(--text-secondary); line-height:1.6;">
                        <strong style="color:var(--accent);">${bpIcon('lightbulb',12)} What makes a strong purpose statement:</strong><br>
                        Specific about who you help · Describes real outcomes, not activities · Reflects your actual approach · Sounds like a person, not a job description
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between;">
                    ${wizardBtn('← Back', 'wizardBack()', 'ghost')}
                    ${wizardBtn('Continue → Finish', 'wizardSavePurpose()', 'primary')}
                </div>
            `;
        }

        async function wizardRegeneratePurpose() {
            const btn = event.target.closest('button');
            if (btn) { btn.textContent = '⟳ Regenerating...'; btn.disabled = true; }

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 300,
                        messages: [{
                            role: 'user',
                            content: `Write a 2-3 sentence professional purpose statement for this person. Make it specific, human, and authentic — not generic corporate speak. Return only the statement, no preamble.

Name: ${wizardState.profile.name}
Title: ${wizardState.profile.currentTitle}
Top skills: ${wizardState.skills.slice(0,8).map(s=>s.name).join(', ')}
Values: ${wizardState.values.filter(v=>v.selected).map(v=>v.name).join(', ')}
Selected outcomes: ${wizardState.skills.flatMap(s=>s.evidence||[]).slice(0,5).map(e=>e.outcome).filter(Boolean).join(' | ')}`
                        }]
                    })
                });
                const data = await response.json();
                const newPurpose = data.content[0]?.text?.trim() || '';
                if (newPurpose) {
                    wizardState.purpose = newPurpose;
                    const ta = document.getElementById('wizardPurpose');
                    if (ta) ta.value = newPurpose;
                }
            } catch(err) {
                console.error('Regenerate error:', err);
            }

            if (btn) { btn.textContent = '↺ Regenerate with Claude'; btn.disabled = false; }
        }

        function wizardSavePurpose() {
            wizardState.purpose = document.getElementById('wizardPurpose')?.value?.trim() || '';
            wizardNext();
        }

        // ── STEP 8: Complete ──────────────────────────────────────────────────

        function renderWizardStep8(el) {
            const skillCount = wizardState.skills.length;
            const valueCount = wizardState.values.filter(v => v.selected).length;
            const evidenceCount = wizardState.skills.reduce((n, s) => n + (s.evidence?.length || 0), 0);

            el.innerHTML = `
                ${wizardHeading(bpIcon('star',22), 'Your Blueprint is Ready',
                    'Here is what we built together. Download your profile to save it, then explore your full dashboard.')}

                <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:24px;">
                    ${[
                        [bpIcon('compass',14), skillCount, 'Skills'],
                        [bpIcon('clipboard',12), evidenceCount, 'Evidence Items'],
                        [bpIcon('lightbulb',12), valueCount, 'Values']
                    ].map(([icon, n, label]) => `
                        <div style="background:var(--bg-elevated); border:1px solid var(--border);
                                    border-radius:12px; padding:20px; text-align:center;">
                            <div style="font-size:1.8em; margin-bottom:6px;">${icon}</div>
                            <div style="font-size:1.8em; font-weight:800; color:var(--accent); line-height:1;">${n}</div>
                            <div style="font-size:0.82em; color:var(--text-secondary); margin-top:4px;">${label}</div>
                        </div>
                    `).join('')}
                </div>

                <div style="background:var(--bg-elevated); border:1px solid var(--border);
                            border-radius:14px; padding:22px; margin-bottom:20px;">
                    <div style="font-weight:700; color:var(--text-primary); margin-bottom:12px; font-size:0.95em;">
                        ${wizardState.profile.name || 'Your'} · ${wizardState.profile.currentTitle || ''}
                    </div>
                    ${wizardState.purpose ? `
                    <p style="color:var(--text-secondary); font-size:0.88em; line-height:1.7; margin-bottom:14px;
                               font-style:italic; border-left:3px solid var(--accent); padding-left:14px;">
                        "${wizardState.purpose}"
                    </p>` : ''}
                    <div style="display:flex; flex-wrap:wrap; gap:6px;">
                        ${wizardState.values.filter(v=>v.selected).slice(0,5).map(v =>
                            `<span style="background:var(--chip-bg); border:1px solid var(--border);
                                          padding:4px 10px; border-radius:10px; font-size:0.78em;
                                          color:var(--text-secondary);">${v.name}</span>`
                        ).join('')}
                    </div>
                </div>

                <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:24px;">
                    <button onclick="wizardDownloadAndLaunch()"
                            style="flex:1; background:var(--accent); color:#fff; border:none;
                                   padding:14px 24px; border-radius:10px; cursor:pointer;
                                   font-size:0.95em; font-weight:700; min-width:200px;">
                        ${bpIcon("save",14)} Save Profile & Go to Dashboard
                    </button>
                    <button onclick="wizardLaunchOnly()"
                            style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border);
                                   padding:14px 20px; border-radius:10px; cursor:pointer; font-size:0.88em;">
                        Explore Dashboard →
                    </button>
                </div>

                <p style="text-align:center; font-size:0.8em; color:var(--text-muted);">
                    Your profile is saved to your account automatically. Download the JSON file as a backup.
                </p>
            `;
        }

        function wizardBuildUserData() {
            return {
                initialized: true,
                templateId: 'wizard-built',
                profile: {
                    ...wizardState.profile,
                    headline: `${wizardState.profile.currentTitle || ''} · ${wizardState.profile.yearsExperience || ''}+ Years`
                },
                skills: wizardState.skills.map(s => ({
                    ...s,
                    roles: s.roles || [],
                    key: s.key || false,
                    onetId: s.onetId || null
                })),
                roles: (wizardState.parsedData?.roles || []).map((r, i) => ({
                    id: r.id || `role${i+1}`,
                    name: r.name || r.company || `Role ${i+1}`,
                    color: ['#ef4444','#f97316','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899'][i % 7]
                })),
                values: wizardState.values,
                purpose: wizardState.purpose,
                workHistory: wizardState.workHistory || [],
                education: wizardState.education || [],
                certifications: wizardState.certifications || [],
                verifications: [],
                preferences: { seniorityLevel: 'Senior', minimumMatchScore: 60, minimumSkillMatches: 3 },
                applications: []
            };
        }

        function wizardDownloadAndLaunch() {
            const built = wizardBuildUserData();
            // Download JSON
            const blob = new Blob([JSON.stringify(built, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `blueprint-${(built.profile.name || 'profile').toLowerCase().replace(/\s+/g,'-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            // Apply and launch
            wizardApplyAndLaunch(built);
        }

        function wizardLaunchOnly() {
            wizardApplyAndLaunch(wizardBuildUserData());
        }

        function wizardApplyAndLaunch(built) {
            userData = built;
            userData.initialized = true;
            safeSet('currentProfile', 'wizard-built');

            // Store wizard profile in templates so it loads on reload
            templates['wizard-built'] = built;

            // Save to Firestore if signed in
            if (fbUser && fbDb) {
                saveToFirestore();
                showToast('Profile saved to your account.', 'success');
            } else {
                // Prompt to sign in so data persists
                showToast('Sign in to save your profile permanently.', 'info');
            }

            closeWizard();
            // Re-initialize the app with new data
            skillsData.skills = userData.skills || [];
            skillsData.roles = userData.roles || [];
            skillsData.skillDetails = {};
            renderFilterChips();
            updateProfileChip(userData.profile.name || 'My Profile');
            // Reset tab initialization flags so they re-render with new data
            window.blueprintInitialized = false;
            window.opportunitiesInitialized = false;
            window.applicationsInitialized = false;
            window.consentInitialized = false;
            window.networkInitialized = false;
            window.cardViewInitialized = false;
            // Network will re-init when user navigates to Skills tab (lazy init)
            switchView('network');
        }
        
        // Initialize main app with user data
        function initializeMainApp() {
            // Replace skillsData with userData
            skillsData.skills = userData.skills || [];
            skillsData.roles = userData.roles || skillsData.roles;
            skillsData.skillDetails = userData.skillDetails || {};

        // Expose wizard and nav functions to global scope for onclick handlers
        window.showOnboardingWizard = showOnboardingWizard;
        window.wizardChooseUpload = wizardChooseUpload;
        window.wizardChooseManual = wizardChooseManual;
        window.wizardChooseImport = wizardChooseImport;
        window.wizardImportProfile = wizardImportProfile;
        window.wizardBack = wizardBack;
        window.wizardNext = wizardNext;
        window.wizardSetResumeTab = wizardSetResumeTab;
        window.wizardSkipParsing = wizardSkipParsing;
        window.wizardStartParsing = wizardStartParsing;
        window.wizardSaveProfile = wizardSaveProfile;
        window.wizardSaveSkills = wizardSaveSkills;
        window.wizardToggleValue = wizardToggleValue;
        window.wizardSaveValues = wizardSaveValues;
        window.wizardSavePurpose = wizardSavePurpose;
        window.wizardRegeneratePurpose = wizardRegeneratePurpose;
        window.wizardDownloadAndLaunch = wizardDownloadAndLaunch;
        window.wizardLaunchOnly = wizardLaunchOnly;
        window.confirmExitWizard = confirmExitWizard;
        window.toggleFilterPanel = toggleFilterPanel;
        window.renderFilterChips = renderFilterChips;

            // Render dynamic filter chips from profile data
            renderFilterChips();

            // Show mobile nav on small screens
            if (window.innerWidth <= 768) {
                const mobileNav = document.getElementById('mobileNav');
                if (mobileNav) mobileNav.style.display = 'flex';
            }
            
            console.log('✓ Main app initialized with', userData.skills.length, 'skills');
            hydrateIcons();
        }
        
        // Export current profile
        
        // ===== END v2.0 USER DATA MANAGEMENT =====
        
        // Load skill evidence dynamically
        fetch('skill_evidence.json')
            .then(response => response.json())
            .then(data => {
                skillsData.skillDetails = data;
                console.log('✓ Loaded evidence for', Object.keys(data).length, 'skills');
            })
            .catch(error => console.error('Error loading skill evidence:', error));

        const levelColors = {
            "Mastery":    "#ef4444",
            "Expert":     "#f97316",
            "Advanced":   "#f59e0b",
            "Proficient": "#10b981",
            "Novice":     "#6b7280"
        };

        let currentView = 'network';
        let activeRole = 'all';
        let activeLevel = null;
        let simulation;
        
        // Job overlay state
        let networkMatchMode = 'you'; // 'you' | 'job' | 'match'
        let activeJobForNetwork = null; // saved job object when overlay is active

        function initNetwork() {
            const width = window.innerWidth;
            const height = window.innerHeight - 160;
            const isMobile = width <= 768;
            
            // Scale factor — makes network fill viewport proportionally
            var scaleFactor = Math.min(width, height) / 900;
            scaleFactor = Math.max(0.8, Math.min(scaleFactor, 1.6));
            
            const svg = d3.select("#networkView")
                .attr("width", width)
                .attr("height", height);

            svg.selectAll("*").remove();

            // Create nodes — center pinned to upper area so name is readable
            var centerY = Math.max(80, height * 0.22);
            const nodes = [
                { id: "center", name: userData.profile.name || "You", type: "center", x: width/2, y: centerY, fx: width/2, fy: centerY }
            ];

            // Add role nodes
            skillsData.roles.forEach((role, i) => {
                const angle = (i / skillsData.roles.length) * 2 * Math.PI;
                const radius = (isMobile ? 120 : 200) * scaleFactor;
                nodes.push({
                    id: role.id,
                    name: role.name,
                    type: "role",
                    color: role.color,
                    x: width/2 + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius
                });
            });

            // Add skill nodes — on mobile, only key/top skills to reduce clutter
            var skillsToShow = skillsData.skills;
            if (isMobile) {
                var keySkills = skillsData.skills.filter(function(s) { return s.key; });
                var topLevelSkills = skillsData.skills.filter(function(s) { return s.level === 'Mastery' || s.level === 'Expert'; });
                // Merge key + top-level, deduplicate, cap at 25
                var seen = new Set();
                skillsToShow = [];
                keySkills.concat(topLevelSkills).forEach(function(s) {
                    if (!seen.has(s.name) && skillsToShow.length < 25) {
                        seen.add(s.name);
                        skillsToShow.push(s);
                    }
                });
                // If still under 25, backfill with Advanced
                if (skillsToShow.length < 25) {
                    skillsData.skills.filter(function(s) { return s.level === 'Advanced' && !seen.has(s.name); })
                        .slice(0, 25 - skillsToShow.length)
                        .forEach(function(s) { skillsToShow.push(s); seen.add(s.name); });
                }
                // If still under 25, backfill with Proficient
                if (skillsToShow.length < 25) {
                    skillsData.skills.filter(function(s) { return s.level === 'Proficient' && !seen.has(s.name); })
                        .slice(0, 25 - skillsToShow.length)
                        .forEach(function(s) { skillsToShow.push(s); seen.add(s.name); });
                }
            }

            skillsToShow.forEach((skill, i) => {
                nodes.push({
                    id: `skill-${i}`,
                    name: skill.name,
                    type: "skill",
                    level: skill.level,
                    roles: skill.roles,
                    key: skill.key
                });
            });

            // Create links
            const links = [];
            
            // Center to roles
            skillsData.roles.forEach(role => {
                links.push({ source: "center", target: role.id, type: "role" });
            });

            // Roles to skills
            skillsToShow.forEach((skill, i) => {
                skill.roles.forEach(roleId => {
                    links.push({ 
                        source: roleId, 
                        target: `skill-${i}`,
                        type: "skill"
                    });
                });
            });

            // Create simulation with viewport-scaled forces
            var linkDist = isMobile ? [120, 110] : [140 * scaleFactor, 160 * scaleFactor];
            var chargeStr = isMobile ? [-350, -150] : [-250 * scaleFactor, -180 * scaleFactor];
            var collisionR = isMobile ? [55, 50, 30] : [70 * scaleFactor, 65 * scaleFactor, 45 * scaleFactor];
            var gravityCenter = height * 0.48; // Gravity pulls network toward visual center (below pinned name)
            
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.type === "role") return linkDist[0];
                    return linkDist[1];
                }))
                .force("charge", d3.forceManyBody().strength(d => {
                    if (d.type === "center") return 0;
                    if (d.type === "role") return chargeStr[0];
                    return chargeStr[1];
                }))
                .force("center", d3.forceCenter(width / 2, gravityCenter))
                .force("collision", d3.forceCollide().radius(d => {
                    if (d.type === "center") return collisionR[0];
                    if (d.type === "role") return collisionR[1];
                    return collisionR[2];
                }))
                .force("x", d3.forceX(width / 2).strength(isMobile ? 0.08 : 0.08))
                .force("y", d3.forceY(gravityCenter).strength(isMobile ? 0.08 : 0.08))
                .force("radial", d3.forceRadial(d => {
                    if (d.type === "skill") return Math.min(width, height) * (isMobile ? 0.38 : 0.4) * scaleFactor;
                    return 0;
                }).strength(isMobile ? 0.15 : 0.1));

            // Draw links
            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link");

            // Draw nodes
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", d => `node ${d.type}`)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("r", d => {
                    if (d.type === "center") return isMobile ? 30 : Math.round(40 * scaleFactor);
                    if (d.type === "role") return isMobile ? 24 : Math.round(30 * scaleFactor);
                    var base = d.key ? 12 : 8;
                    return isMobile ? (d.key ? 14 : 10) : Math.round(base * scaleFactor);
                })
                .attr("fill", d => {
                    if (d.type === "center") return "#60a5fa";
                    if (d.type === "role") return d.color;
                    return levelColors[d.level];
                })
                .on("click", (event, d) => {
                    if (d.type === "center") {
                        // Center node click resets to show all
                        filterByRole('all');
                    } else if (d.type === "role") {
                        // Toggle: click active role again to reset
                        if (activeRole === d.id) {
                            filterByRole('all');
                        } else {
                            filterByRole(d.id);
                        }
                    } else if (d.type === "skill") {
                        event.stopPropagation();
                        // Look up full skill object from skillsData instead of using node data
                        const fullSkill = skillsData.skills.find(s => s.name === d.name);
                        if (fullSkill) {
                            openSkillModal(d.name, fullSkill);
                        } else {
                            console.error('Skill not found in skillsData:', d.name);
                        }
                    }
                })
                .style("cursor", d => (d.type === "center" || d.type === "role" || d.type === "skill") ? "pointer" : "default")
                .on("mouseover", (event, d) => showTooltip(event, d))
                .on("mouseout", hideTooltip);

            node.append("text")
                .each(function(d) {
                    if (d.type === 'skill') {
                        // Split long skill names into multiple lines
                        const words = d.name.split(' ');
                        const maxWidth = isMobile ? 12 : 15; // characters per line
                        let lines = [];
                        let currentLine = '';
                        
                        words.forEach(word => {
                            if ((currentLine + ' ' + word).length > maxWidth && currentLine.length > 0) {
                                lines.push(currentLine);
                                currentLine = word;
                            } else {
                                currentLine = currentLine ? currentLine + ' ' + word : word;
                            }
                        });
                        if (currentLine) lines.push(currentLine);
                        
                        // Create tspan for each line
                        const text = d3.select(this);
                        lines.forEach((line, i) => {
                            text.append('tspan')
                                .text(line)
                                .attr('x', 0)
                                .attr('dy', i === 0 ? -13 - (lines.length - 1) * 5 : 10)
                                .attr('text-anchor', 'middle');
                        });
                    } else {
                        // Single line for center and role nodes
                        var label = d.name;
                        // Truncate long role names on mobile
                        if (isMobile && d.type === 'role' && label.length > 22) {
                            label = label.substring(0, 20) + '\u2026';
                        }
                        d3.select(this)
                            .text(label)
                            .attr("x", 0)
                            .attr("y", d => {
                                if (d.type === "center") return Math.round(-45 * scaleFactor);
                                if (d.type === "role") return Math.round(-35 * scaleFactor);
                                return -13;
                            })
                            .attr("text-anchor", "middle");
                    }
                });

            simulation.on("tick", () => {
                // Constrain nodes to viewport with padding
                const padding = isMobile ? 60 : 100;
                nodes.forEach(d => {
                    if (d.type !== "center") {  // Don't constrain center node
                        d.x = Math.max(padding, Math.min(width - padding, d.x));
                        d.y = Math.max(padding, Math.min(height - padding, d.y));
                    }
                });
                
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });

            window.networkData = { nodes, links, svg, link, node };
            setTimeout(applyLabelToggles, 100);
            
            // On mobile: hide skill labels by default (too cluttered), show role labels
            if (isMobile) {
                node.selectAll('text').filter(d => d.type === 'skill').classed('hidden', true);
                // Uncheck the skill labels checkbox
                var skillLabelCb = document.querySelector('#networkControls input[onchange*="skill"]');
                if (skillLabelCb) skillLabelCb.checked = false;
                
                // Add info badge showing filtered count
                if (skillsToShow.length < skillsData.skills.length) {
                    var existing = document.getElementById('mobileNetworkBadge');
                    if (existing) existing.remove();
                    var badge = document.createElement('div');
                    badge.id = 'mobileNetworkBadge';
                    badge.style.cssText = 'position:absolute; bottom:12px; left:50%; transform:translateX(-50%); '
                        + 'background:rgba(30,64,175,0.8); color:#e0e0e0; font-size:0.72em; padding:5px 14px; '
                        + 'border-radius:20px; backdrop-filter:blur(8px); pointer-events:none; z-index:10;';
                    badge.textContent = 'Showing top ' + skillsToShow.length + ' of ' + skillsData.skills.length + ' skills';
                    var container = document.getElementById('networkView').parentElement;
                    if (container) { container.style.position = 'relative'; container.appendChild(badge); }
                }
            }
        }

        // ===== NETWORK OVERLAY ENGINE (Phase 2) =====
        
        function activateJobOverlay(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job) { showToast('Job not found.', 'error'); return; }
            
            activeJobForNetwork = job;
            networkMatchMode = 'match'; // Start on the overlay view
            
            // Switch to network view if not already there
            currentSkillsView = 'network';
            switchView('network');
            
            // Show the toggle and badge
            updateMatchOverlayUI();
            
            // Render the match network
            setNetworkMatchMode('match');
        }
        window.activateJobOverlay = activateJobOverlay;
        
        function clearJobOverlay() {
            activeJobForNetwork = null;
            networkMatchMode = 'you';
            
            // Hide toggle and badge
            var toggle = document.getElementById('matchModeToggle');
            var badge = document.getElementById('matchActiveBadge');
            if (toggle) toggle.style.display = 'none';
            if (badge) badge.style.display = 'none';
            
            // Remove legend and job info tile
            var legend = document.getElementById('matchLegend');
            if (legend) legend.remove();
            var jobTile = document.getElementById('jobInfoTile');
            if (jobTile) jobTile.remove();
            
            // Re-render normal network
            window.networkInitialized = false;
            initNetwork();
            window.networkInitialized = true;
        }
        window.clearJobOverlay = clearJobOverlay;
        
        function updateMatchOverlayUI() {
            var toggle = document.getElementById('matchModeToggle');
            var badge = document.getElementById('matchActiveBadge');
            
            if (!activeJobForNetwork) {
                if (toggle) toggle.style.display = 'none';
                if (badge) badge.style.display = 'none';
                return;
            }
            
            if (toggle) toggle.style.display = 'inline-flex';
            // Badge hidden — replaced by job info tile in network canvas
            if (badge) badge.style.display = 'none';
            
            // Update active mode button
            document.querySelectorAll('.match-mode-btn').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.mode === networkMatchMode);
            });
        }
        
        function setNetworkMatchMode(mode) {
            networkMatchMode = mode;
            updateMatchOverlayUI();
            // Ensure label toggles are visible for all network modes
            var nc = document.getElementById('networkControls');
            if (nc) nc.style.display = '';
            
            // Remove any existing overlays
            var legend = document.getElementById('matchLegend');
            if (legend) legend.remove();
            var jobTile = document.getElementById('jobInfoTile');
            if (jobTile) jobTile.remove();
            
            if (mode === 'you') {
                // Standard network
                window.networkInitialized = false;
                initNetwork();
                window.networkInitialized = true;
            } else if (mode === 'job') {
                initJobNetwork(activeJobForNetwork);
            } else if (mode === 'match') {
                initMatchNetwork(activeJobForNetwork);
            }
        }
        window.setNetworkMatchMode = setNetworkMatchMode;
        
        // ===== JOB-ONLY NETWORK =====
        
        function initJobNetwork(job) {
            if (!job || !job.parsedSkills) return;
            
            var width = window.innerWidth;
            var height = window.innerHeight - 160;
            var isMobile = width <= 768;
            var scaleFactor = Math.min(width, height) / 900;
            scaleFactor = Math.max(0.8, Math.min(scaleFactor, 1.6));
            
            var svg = d3.select("#networkView")
                .attr("width", width)
                .attr("height", height);
            svg.selectAll("*").remove();
            if (simulation) simulation.stop();
            
            // Center node = the job title — pinned to upper area
            var centerY = Math.max(80, height * 0.22);
            var nodes = [
                { id: "center", name: job.title || "Job", type: "center", x: width/2, y: centerY, fx: width/2, fy: centerY }
            ];
            
            // Group job skills by category into roles
            var categoryMap = {};
            var roleColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#a855f7', '#ec4899', '#06b6d4', '#84cc16'];
            job.parsedSkills.forEach(function(s) {
                var cat = s.category || 'General';
                if (!categoryMap[cat]) categoryMap[cat] = [];
                categoryMap[cat].push(s);
            });
            
            var categories = Object.keys(categoryMap);
            categories.forEach(function(cat, i) {
                var angle = (i / categories.length) * 2 * Math.PI;
                var radius = (isMobile ? 100 : 170) * scaleFactor;
                nodes.push({
                    id: 'role-' + cat,
                    name: cat,
                    type: 'role',
                    color: roleColors[i % roleColors.length],
                    x: width/2 + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius
                });
            });
            
            // Skill nodes
            var allSkills = [];
            categories.forEach(function(cat) {
                categoryMap[cat].forEach(function(s) { allSkills.push({ skill: s, cat: cat }); });
            });
            
            // Cap for mobile
            var skillsToRender = isMobile ? allSkills.slice(0, 25) : allSkills;
            
            skillsToRender.forEach(function(entry, i) {
                var isRequired = entry.skill.level === 'Required';
                nodes.push({
                    id: 'jskill-' + i,
                    name: entry.skill.name,
                    type: 'skill',
                    level: entry.skill.level,
                    category: entry.cat,
                    required: isRequired
                });
            });
            
            // Links
            var links = [];
            categories.forEach(function(cat) { links.push({ source: 'center', target: 'role-' + cat, type: 'role' }); });
            skillsToRender.forEach(function(entry, i) { links.push({ source: 'role-' + entry.cat, target: 'jskill-' + i, type: 'skill' }); });
            
            // Simulation — scaled
            var gravityCenter = height * 0.48;
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(function(d) { return d.id; }).distance(function(d) { return d.type === 'role' ? (isMobile ? 80 : 130 * scaleFactor) : (isMobile ? 90 : 140 * scaleFactor); }))
                .force("charge", d3.forceManyBody().strength(function(d) { return d.type === 'center' ? 0 : d.type === 'role' ? -200 * scaleFactor : -100 * scaleFactor; }))
                .force("center", d3.forceCenter(width/2, gravityCenter))
                .force("collision", d3.forceCollide().radius(function(d) { return d.type === 'center' ? 50 * scaleFactor : d.type === 'role' ? 40 * scaleFactor : 28 * scaleFactor; }))
                .force("x", d3.forceX(width/2).strength(0.1))
                .force("y", d3.forceY(gravityCenter).strength(0.1));
            
            // Draw
            var link = svg.append("g").selectAll("line").data(links).join("line")
                .attr("class", "link").style("stroke-opacity", 0.2);
            
            var node = svg.append("g").selectAll("g").data(nodes).join("g")
                .attr("class", function(d) { return 'node ' + d.type; })
                .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));
            
            node.append("circle")
                .attr("r", function(d) {
                    if (d.type === 'center') return isMobile ? 28 : Math.round(36 * scaleFactor);
                    if (d.type === 'role') return isMobile ? 20 : Math.round(26 * scaleFactor);
                    return d.required ? Math.round(12 * scaleFactor) : Math.round(9 * scaleFactor);
                })
                .attr("fill", function(d) {
                    if (d.type === 'center') return '#f59e0b';
                    if (d.type === 'role') return d.color;
                    return d.required ? '#ef4444' : '#f97316';
                })
                .attr("stroke", function(d) { return d.required ? '#fff' : 'none'; })
                .attr("stroke-width", function(d) { return d.required ? 2 : 0; });
            
            node.append("text")
                .text(function(d) { return d.name; })
                .attr("x", 0)
                .attr("y", function(d) { return d.type === 'center' ? -42 : d.type === 'role' ? -30 : -14; })
                .attr("text-anchor", "middle")
                .style("font-size", function(d) { return d.type === 'center' ? '14px' : d.type === 'role' ? '11px' : '9px'; });
            
            if (isMobile) node.selectAll('text').filter(function(d) { return d.type === 'skill'; }).classed('hidden', true);
            
            simulation.on("tick", function() {
                var padding = isMobile ? 50 : 80;
                nodes.forEach(function(d) { if (d.type !== 'center') { d.x = Math.max(padding, Math.min(width - padding, d.x)); d.y = Math.max(padding, Math.min(height - padding, d.y)); } });
                link.attr("x1", function(d) { return d.source.x; }).attr("y1", function(d) { return d.source.y; }).attr("x2", function(d) { return d.target.x; }).attr("y2", function(d) { return d.target.y; });
                node.attr("transform", function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
            });
            
            // Add job info tile
            addJobInfoTile(job);
            setTimeout(applyLabelToggles, 100);
        }
        
        // ===== MATCH OVERLAY NETWORK =====
        
        function initMatchNetwork(job) {
            if (!job || !job.matchData) return;
            
            var width = window.innerWidth;
            var height = window.innerHeight - 160;
            var isMobile = width <= 768;
            var match = job.matchData;
            var scaleFactor = Math.min(width, height) / 900;
            scaleFactor = Math.max(0.8, Math.min(scaleFactor, 1.6));
            
            var svg = d3.select("#networkView")
                .attr("width", width)
                .attr("height", height);
            svg.selectAll("*").remove();
            if (simulation) simulation.stop();
            
            // Build lookup sets for classification
            var matchedUserSkills = new Set();
            var matchedJobSkills = new Set();
            (match.matched || []).forEach(function(m) {
                matchedUserSkills.add(m.userSkill.toLowerCase());
                matchedJobSkills.add(m.jobSkill.toLowerCase());
            });
            var gapSkills = new Set();
            (match.gaps || []).forEach(function(g) { gapSkills.add(g.name.toLowerCase()); });
            
            // Center node — pinned to upper area
            var centerY = Math.max(80, height * 0.22);
            var nodes = [
                { id: "center", name: userData.profile.name || "You", type: "center", matchState: 'center', x: width/2, y: centerY, fx: width/2, fy: centerY }
            ];
            
            // Use the user's actual roles
            skillsData.roles.forEach(function(role, i) {
                var angle = (i / skillsData.roles.length) * 2 * Math.PI;
                var radius = (isMobile ? 110 : 180) * scaleFactor;
                nodes.push({
                    id: role.id, name: role.name, type: 'role', color: role.color, matchState: 'role',
                    x: width/2 + Math.cos(angle) * radius, y: centerY + Math.sin(angle) * radius
                });
            });
            
            // Add a "job requirements" pseudo-role
            var jobRoleAngle = Math.PI; // Put it opposite (below center)
            var jobRoleRadius = (isMobile ? 130 : 200) * scaleFactor;
            nodes.push({
                id: 'role-job-req', name: (job.title || 'Job') + ' Needs', type: 'role', color: '#ef4444', matchState: 'role',
                x: width/2 + Math.cos(jobRoleAngle) * jobRoleRadius,
                y: centerY + Math.sin(jobRoleAngle) * jobRoleRadius
            });
            
            var links = [];
            var nodeIdx = 0;
            
            // Center → user roles
            skillsData.roles.forEach(function(role) { links.push({ source: 'center', target: role.id, type: 'role' }); });
            // Center → job req role
            links.push({ source: 'center', target: 'role-job-req', type: 'role' });
            
            // User skills with match state
            var userSkillsToShow = isMobile
                ? skillsData.skills.filter(function(s) { return s.key || matchedUserSkills.has(s.name.toLowerCase()) || s.level === 'Mastery' || s.level === 'Expert'; }).slice(0, 30)
                : skillsData.skills;
            
            userSkillsToShow.forEach(function(skill) {
                var isMatched = matchedUserSkills.has(skill.name.toLowerCase());
                var state = isMatched ? 'matched' : 'surplus';
                var id = 'u-' + nodeIdx++;
                nodes.push({
                    id: id, name: skill.name, type: 'skill', level: skill.level, key: skill.key,
                    matchState: state, roles: skill.roles, source: 'user'
                });
                // Link to user roles
                (skill.roles || []).forEach(function(roleId) {
                    links.push({ source: roleId, target: id, type: 'skill' });
                });
                // Matched skills also link to job req
                if (isMatched) {
                    links.push({ source: 'role-job-req', target: id, type: 'match' });
                }
            });
            
            // Gap skills (job needs, user doesn't have)
            (match.gaps || []).forEach(function(gap) {
                // Cap gaps on mobile
                if (isMobile && nodeIdx > 40) return;
                var id = 'g-' + nodeIdx++;
                nodes.push({
                    id: id, name: gap.name, type: 'skill', level: gap.level || 'Required',
                    matchState: 'gap', source: 'job'
                });
                links.push({ source: 'role-job-req', target: id, type: 'skill' });
            });
            
            // Color scheme
            var matchColors = {
                matched: '#10b981', // green
                gap: '#ef4444',     // red
                surplus: '#475569'  // slate grey (dimmed)
            };
            
            // Simulation — scaled forces
            var gravityCenter = height * 0.48;
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(function(d) { return d.id; }).distance(function(d) {
                    if (d.type === 'role') return (isMobile ? 90 : 150) * scaleFactor;
                    if (d.type === 'match') return (isMobile ? 60 : 100) * scaleFactor;
                    return (isMobile ? 80 : 130) * scaleFactor;
                }))
                .force("charge", d3.forceManyBody().strength(function(d) {
                    if (d.type === 'center') return 0;
                    if (d.type === 'role') return (isMobile ? -180 : -250) * scaleFactor;
                    if (d.matchState === 'gap') return (isMobile ? -80 : -120) * scaleFactor;
                    return (isMobile ? -100 : -150) * scaleFactor;
                }))
                .force("center", d3.forceCenter(width/2, gravityCenter))
                .force("collision", d3.forceCollide().radius(function(d) {
                    if (d.type === 'center') return (isMobile ? 40 : 55) * scaleFactor;
                    if (d.type === 'role') return (isMobile ? 35 : 50) * scaleFactor;
                    return (isMobile ? 22 : 30) * scaleFactor;
                }))
                .force("x", d3.forceX(width/2).strength(0.08))
                .force("y", d3.forceY(gravityCenter).strength(0.08));
            
            // Draw links
            var link = svg.append("g").selectAll("line").data(links).join("line")
                .attr("class", "link")
                .style("stroke", function(d) { return d.type === 'match' ? matchColors.matched : undefined; })
                .style("stroke-opacity", function(d) { return d.type === 'match' ? 0.5 : 0.2; })
                .style("stroke-width", function(d) { return d.type === 'match' ? 2 : 1.5; })
                .style("stroke-dasharray", function(d) { return d.type === 'match' ? '4,3' : 'none'; });
            
            // Draw nodes
            var node = svg.append("g").selectAll("g").data(nodes).join("g")
                .attr("class", function(d) { return 'node ' + d.type; })
                .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));
            
            node.append("circle")
                .attr("r", function(d) {
                    if (d.type === 'center') return isMobile ? 28 : Math.round(38 * scaleFactor);
                    if (d.type === 'role') return isMobile ? 22 : Math.round(28 * scaleFactor);
                    if (d.matchState === 'matched') return isMobile ? 12 : Math.round(14 * scaleFactor);
                    if (d.matchState === 'gap') return isMobile ? 10 : Math.round(12 * scaleFactor);
                    return isMobile ? 7 : Math.round(8 * scaleFactor); // surplus
                })
                .attr("fill", function(d) {
                    if (d.type === 'center') return '#60a5fa';
                    if (d.type === 'role') {
                        // Job needs role = subtle red outline feel; user roles = neutral slate
                        return d.id === 'role-job-req' ? 'rgba(239,68,68,0.25)' : 'rgba(148,163,184,0.25)';
                    }
                    return matchColors[d.matchState] || '#6b7280';
                })
                .attr("opacity", function(d) {
                    if (d.matchState === 'surplus') return 0.35;
                    return 1;
                })
                .attr("stroke", function(d) {
                    if (d.type === 'role') {
                        return d.id === 'role-job-req' ? '#ef4444' : '#64748b';
                    }
                    if (d.matchState === 'matched') return '#fff';
                    if (d.matchState === 'gap') return '#fca5a5';
                    return 'none';
                })
                .attr("stroke-width", function(d) {
                    if (d.type === 'role') return 2;
                    if (d.matchState === 'matched' || d.matchState === 'gap') return 2;
                    return 0;
                })
                .on("click", function(event, d) {
                    if (d.type === 'skill' && d.source === 'user') {
                        var fullSkill = skillsData.skills.find(function(s) { return s.name === d.name; });
                        if (fullSkill) openSkillModal(d.name, fullSkill);
                    }
                })
                .on("mouseover", function(event, d) { showTooltip(event, d); })
                .on("mouseout", hideTooltip);
            
            // Labels
            node.append("text")
                .text(function(d) { return d.name; })
                .attr("x", 0)
                .attr("y", function(d) { return d.type === 'center' ? -44 : d.type === 'role' ? -34 : -16; })
                .attr("text-anchor", "middle")
                .style("font-size", function(d) { return d.type === 'center' ? '14px' : d.type === 'role' ? '11px' : '9px'; })
                .style("fill", function(d) {
                    if (d.matchState === 'matched') return matchColors.matched;
                    if (d.matchState === 'gap') return matchColors.gap;
                    if (d.matchState === 'surplus') return '#64748b';
                    if (d.type === 'role' && d.id === 'role-job-req') return '#ef4444';
                    if (d.type === 'role') return '#94a3b8';
                    return undefined;
                })
                .style("opacity", function(d) { return d.matchState === 'surplus' ? 0.4 : 1; });
            
            // On mobile hide skill labels
            if (isMobile) node.selectAll('text').filter(function(d) { return d.type === 'skill'; }).classed('hidden', true);
            
            // Tick
            simulation.on("tick", function() {
                var padding = isMobile ? 50 : 80;
                nodes.forEach(function(d) { if (d.type !== 'center') { d.x = Math.max(padding, Math.min(width - padding, d.x)); d.y = Math.max(padding, Math.min(height - padding, d.y)); } });
                link.attr("x1", function(d) { return d.source.x; }).attr("y1", function(d) { return d.source.y; }).attr("x2", function(d) { return d.target.x; }).attr("y2", function(d) { return d.target.y; });
                node.attr("transform", function(d) { return 'translate(' + d.x + ',' + d.y + ')'; });
            });
            
            // Add legend and job info tile
            addMatchLegend(match);
            addJobInfoTile(job);
            setTimeout(applyLabelToggles, 100);
        }
        
        function addJobInfoTile(job) {
            var existing = document.getElementById('jobInfoTile');
            if (existing) existing.remove();
            if (!job) return;
            
            var tile = document.createElement('div');
            tile.id = 'jobInfoTile';
            tile.className = 'job-info-tile';
            
            var html = '<div class="jit-title">' + (job.title || 'Untitled Position') + '</div>';
            if (job.company) {
                html += '<div class="jit-company">' + job.company + '</div>';
            }
            
            // Meta row: seniority, date added
            var metaItems = [];
            if (job.seniority) {
                metaItems.push('<span class="jit-meta-item">\uD83C\uDFAF ' + job.seniority + '</span>');
            }
            if (job.addedAt) {
                var d = new Date(job.addedAt);
                metaItems.push('<span class="jit-meta-item">\uD83D\uDCC5 ' + d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + '</span>');
            }
            if (metaItems.length > 0) {
                html += '<div class="jit-meta">' + metaItems.join('') + '</div>';
            }
            
            // BLS salary
            var bls = job.blsSalary;
            if (bls && bls.median) {
                var lo = bls.pct25 ? '$' + bls.pct25.toLocaleString() : null;
                var hi = bls.pct75 ? '$' + bls.pct75.toLocaleString() : null;
                var rangeStr = lo && hi ? lo + ' \u2013 ' + hi : '$' + bls.median.toLocaleString();
                html += '<div class="jit-salary">'
                    + '<div class="jit-salary-range">' + rangeStr + '</div>'
                    + '<div class="jit-salary-label">' + bls.title + ' \u00B7 BLS ' + (bls.source || '').replace('BLS OEWS ', '') + '</div>'
                    + '</div>';
            }
            
            // Source link
            if (job.sourceUrl) {
                html += '<div class="jit-source"><a href="' + job.sourceUrl + '" target="_blank">View posting \u2192</a></div>';
            }
            
            tile.innerHTML = html;
            
            var container = document.getElementById('networkView').parentElement;
            if (container) { container.style.position = 'relative'; container.appendChild(tile); }
        }
        
        function addMatchLegend(match) {
            var existing = document.getElementById('matchLegend');
            if (existing) existing.remove();
            
            var matchCount = (match.matched || []).length;
            var gapCount = (match.gaps || []).length;
            var surplusCount = (match.surplus || []).length;
            var profGapCount = (match.matched || []).filter(function(m) { return m.profGap; }).length;
            var score = match.score || 0;
            
            // Score color
            var scoreColor = score >= 70 ? '#10b981' : score >= 45 ? '#f59e0b' : '#ef4444';
            
            // Job info
            var job = activeJobForNetwork || {};
            var jobTitle = job.title || 'Job Match';
            var jobCompany = job.company || '';
            
            var legend = document.createElement('div');
            legend.id = 'matchLegend';
            legend.className = 'match-legend';
            
            legend.innerHTML = ''
                // Score row (no header — job info is in the tile)
                + '<div class="ml-score-row">'
                + '<div class="ml-score-num" style="color:' + scoreColor + ';">' + score + '%</div>'
                + '<div style="flex:1;">'
                + '<div style="font-size:0.78em; color:var(--text-muted); margin-bottom:4px;">Overall Match</div>'
                + '<div class="ml-score-bar"><div class="ml-score-fill" style="width:' + score + '%; background:' + scoreColor + ';"></div></div>'
                + '</div>'
                + '</div>'
                
                // Stats grid
                + '<div class="ml-stats">'
                + '<div class="ml-stat"><div class="ml-stat-num" style="color:#10b981;">' + matchCount + '</div><div class="ml-stat-label">Matched</div></div>'
                + '<div class="ml-stat"><div class="ml-stat-num" style="color:#ef4444;">' + gapCount + '</div><div class="ml-stat-label">Gaps</div></div>'
                + '<div class="ml-stat"><div class="ml-stat-num" style="color:#64748b;">' + surplusCount + '</div><div class="ml-stat-label">Surplus</div></div>'
                + '</div>'
                
                // Proficiency gaps if any
                + (profGapCount > 0 ? '<div style="padding:6px 16px; font-size:0.78em; color:#f59e0b; background:rgba(245,158,11,0.06);">' + bpIcon('warning',12) + ' ' + profGapCount + ' skill' + (profGapCount > 1 ? 's' : '') + ' matched at a lower proficiency</div>' : '')
                
                // Legend dots
                + '<div class="ml-legend-row">'
                + '<div class="match-legend-item"><div class="match-legend-dot" style="background:#10b981;"></div>You have</div>'
                + '<div class="match-legend-item"><div class="match-legend-dot" style="background:#ef4444;"></div>You need</div>'
                + '<div class="match-legend-item"><div class="match-legend-dot" style="background:#475569; opacity:0.4;"></div>Your extra</div>'
                + '</div>'
                
                // Action buttons
                + '<div class="ml-actions">'
                + '<button class="ml-action-btn" onclick="clearJobOverlay()">✕ Close</button>'
                + '<button class="ml-action-btn" style="color:var(--accent); border-color:rgba(96,165,250,0.3);" '
                + 'onclick="var idx=findJobIdx(); clearJobOverlay(); switchView(\'opportunities\'); setTimeout(function(){showJobDetail(idx);},200);">View Details</button>'
                + '</div>';
            
            var container = document.getElementById('networkView').parentElement;
            if (container) { container.style.position = 'relative'; container.appendChild(legend); }
        }
        
        function findJobIdx() {
            var job = activeJobForNetwork;
            if (!job) return 0;
            var jobs = userData.savedJobs || [];
            for (var i = 0; i < jobs.length; i++) {
                if (jobs[i].id === job.id || jobs[i].title === job.title) return i;
            }
            return 0;
        }
        window.findJobIdx = findJobIdx;

        function initCardView() {
            const cardView = document.getElementById('cardView');

            // ── Dynamic domain grouping — works for ANY profile ──────────────
            // Strategy: group by role first (uses the profile's own role names),
            // then fall back to O*NET category, then "Other Skills" catch-all.

            const roleIconMap = {
                // Common role name patterns → SVG icon name
                'strategy': 'target', 'vp': 'target', 'director': 'target', 'executive': 'target', 'chief': 'target',
                'technology': 'tool', 'engineer': 'tool', 'developer': 'tool', 'tech': 'tool', 'software': 'tool',
                'product': 'layers', 'manager': 'layers',
                'data': 'database', 'analyst': 'database', 'research': 'database', 'science': 'database',
                'design': 'compass', 'creative': 'compass', 'ux': 'compass', 'artist': 'compass',
                'marketing': 'send', 'communication': 'send', 'sales': 'send', 'content': 'send',
                'hr': 'users', 'talent': 'users', 'people': 'users', 'recruiting': 'users',
                'finance': 'dollar', 'accounting': 'dollar', 'operations': 'dollar',
                'pilot': 'compass', 'aviation': 'compass', 'flight': 'compass',
                'music': 'heart', 'musician': 'heart', 'performer': 'heart',
                'advocate': 'heart', 'nonprofit': 'heart', 'community': 'heart',
                'futurist': 'zap', 'innovation': 'zap', 'evangelist': 'zap',
                'entrepreneur': 'trending-up', 'founder': 'trending-up', 'startup': 'trending-up',
                'consultant': 'briefcase', 'advisor': 'briefcase',
            };

            const categoryMeta = {
                'skill':      { label: 'Skills',       iconName: 'compass' },
                'ability':    { label: 'Abilities',     iconName: 'zap' },
                'workstyle':  { label: 'Work Style',    iconName: 'flag' },
                'unique':     { label: 'Unique Strengths', iconName: 'star' },
            };

            function getRoleIcon(roleName) {
                const lower = (roleName || '').toLowerCase();
                for (const [keyword, iconName] of Object.entries(roleIconMap)) {
                    if (lower.includes(keyword)) return bpIcon(iconName, 20);
                }
                return bpIcon('briefcase', 20);
            }

            const domains = {};

            // Build role-based domains from the profile's actual roles
            const profileRoles = skillsData.roles || userData.roles || [];
            profileRoles.forEach(role => {
                domains[role.id] = {
                    label: role.name,
                    icon: getRoleIcon(role.name),
                    color: role.color,
                    skills: []
                };
            });

            // Catch-all domains for skills without a role or for category fallback
            const uncategorized = { label: 'Other Skills', icon: bpIcon('compass', 20), skills: [] };

            // Level priority for sorting within domains
            const levelPriority = { Mastery: 5, Expert: 4, Advanced: 3, Proficient: 2, Novice: 1 };

            // Assign each skill to its primary role domain, or uncategorized
            skillsData.skills.forEach(skill => {
                const skillRoles = skill.roles || [];
                if (skillRoles.length > 0 && domains[skillRoles[0]]) {
                    domains[skillRoles[0]].skills.push(skill);
                } else if (skillRoles.length > 1) {
                    // Try second role
                    const secondRole = skillRoles.find(r => domains[r]);
                    if (secondRole) {
                        domains[secondRole].skills.push(skill);
                    } else {
                        uncategorized.skills.push(skill);
                    }
                } else {
                    uncategorized.skills.push(skill);
                }
            });

            // Decide grouping strategy
            const totalInRoles = Object.values(domains).reduce((n, d) => n + d.skills.length, 0);
            const totalSkills = skillsData.skills.length;
            const finalDomains = {};

            if (totalSkills === 0) {
                // No skills — nothing to show
            } else if (totalInRoles >= totalSkills * 0.5) {
                // Good role coverage (50%+) — use role-based grouping
                Object.entries(domains).forEach(([id, d]) => {
                    if (d.skills.length > 0) finalDomains[id] = d;
                });
                // Add any uncategorized skills under their category
                if (uncategorized.skills.length > 0) {
                    // Sub-bucket uncategorized by O*NET category rather than one big pile
                    uncategorized.skills.forEach(skill => {
                        const cat = skill.category || 'skill';
                        const meta = categoryMeta[cat] || categoryMeta['skill'];
                        const key = '__cat_' + cat;
                        if (!finalDomains[key]) {
                            finalDomains[key] = { label: meta.label, icon: bpIcon(meta.iconName || 'compass', 20), skills: [] };
                        }
                        finalDomains[key].skills.push(skill);
                    });
                }
            } else {
                // Poor role coverage — group everything by O*NET category
                // This handles profiles where skills lack role assignments
                skillsData.skills.forEach(skill => {
                    const cat = skill.category || 'skill';
                    const meta = categoryMeta[cat] || categoryMeta['skill'];
                    if (!finalDomains[cat]) {
                        finalDomains[cat] = { label: meta.label, icon: bpIcon(meta.iconName || 'compass', 20), skills: [] };
                    }
                    finalDomains[cat].skills.push(skill);
                });
            }
            
            // Sort skills within each domain: key/core first, then by level
            Object.values(finalDomains).forEach(d => {
                d.skills.sort((a, b) => {
                    if (a.key && !b.key) return -1;
                    if (!a.key && b.key) return 1;
                    return (levelPriority[b.level] || 0) - (levelPriority[a.level] || 0);
                });
            });

            let html = '<div class="cards-grid">';
            
            Object.entries(finalDomains).forEach(([domainKey, data]) => {
                if (data.skills.length === 0) return;
                const domainTitle = data.label || domainKey;
                
                html += `
                    <div class="domain-card">
                        <div class="domain-header">
                            <span class="domain-icon">${data.icon}</span>
                            <span class="domain-title">${domainTitle}</span>
                        </div>
                        <div class="skills-list">
                `;
                
                data.skills.forEach(skill => {
                    const levelClass = skill.level.toLowerCase();
                    const keyBadge = skill.key ? '<span class="skill-badge">CORE</span>' : '';
                    const rolesList = skill.roles.map(roleId => {
                        const role = skillsData.roles.find(r => r.id === roleId);
                        return role ? role.name : roleId;
                    }).join(', ');
                    
                    // Get years of experience from skillDetails
                    const details = skillsData.skillDetails && skillsData.skillDetails[skill.name];
                    const years = details && details.years ? details.years + ' yrs' : '';
                    const yearsBadge = years ? `<span class="skill-years">${years}</span>` : '';
                    
                    // Get market impact rating (instead of dollar value)
                    const skillImpact = calculateSkillValue(skill);
                    const impactColor = getImpactColor(skillImpact.level);
                    const impactBadge = `<span class="skill-impact-badge" style="background: rgba(${impactColor === '#ef4444' ? '239, 68, 68' : impactColor === '#f59e0b' ? '245, 158, 11' : impactColor === '#3b82f6' ? '59, 130, 246' : '107, 114, 128'}, 0.2); color: ${impactColor}; font-size: 0.7em; padding: 3px 8px; border-radius: 3px; font-weight: 600; white-space: nowrap;">${skillImpact.icon} ${skillImpact.label.toUpperCase()}</span>`;
                    
                    // Category badge for all O*NET types + Unique
                    let categoryBadge = '';
                    if (skill.category === 'skill') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">SKILL</span>';
                    } else if (skill.category === 'ability') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(139, 92, 246, 0.2); color: #a78bfa; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">ABILITY</span>';
                    } else if (skill.category === 'workstyle') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">WORK STYLE</span>';
                    } else if (skill.category === 'unique') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">UNIQUE</span>';
                    }
                    
                    // Evidence indicator (v4.16.1)
                    let evidenceBadge = '';
                    if (typeof getEvidenceSummary === 'function') {
                        const evs = getEvidenceSummary(skill);
                        if (evs.hasGap) {
                            evidenceBadge = '<span style="font-size:0.65em; color:#fbbf24; margin-left:4px;" title="Evidence gap: claimed ' + evs.claimedLevel + ', evidence supports ' + evs.effectiveLevel + '">\u26A0</span>';
                        } else if (evs.evidenceCount > 0) {
                            evidenceBadge = '<span style="font-size:0.65em; color:#10b981; margin-left:4px;" title="' + evs.points + ' evidence pts, ' + evs.evidenceCount + ' outcomes">\u2713</span>';
                        }
                        if (evs.verifiedCount > 0) {
                            evidenceBadge += '<span style="font-size:0.6em; color:#a78bfa; margin-left:2px;" title="Verified by ' + evs.verifiedCount + '">\u2605</span>';
                        }
                    }
                    
                    html += `
                        <div class="skill-item ${levelClass}" title="${rolesList}" onclick='openSkillModalFromCard("${skill.name.replace(/'/g, "\\'")}")' style="cursor: pointer;">
                            <div class="skill-dot" style="background: ${levelColors[skill.level]}"></div>
                            <span class="skill-name">${skill.name}</span>
                            ${categoryBadge}
                            ${yearsBadge}
                            ${keyBadge}
                            ${impactBadge}
                            ${evidenceBadge}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Role-based skill suggestions
            var suggestions = getRoleSuggestions();
            if (suggestions.length > 0) {
                html += '<div style="margin-top:20px; padding:20px; border-radius:12px; '
                    + 'background:linear-gradient(135deg, rgba(96,165,250,0.06), rgba(139,92,246,0.04)); '
                    + 'border:1px solid rgba(96,165,250,0.15);">'
                    + '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">'
                    + '<h3 style="font-size:0.92em; font-weight:700; color:var(--accent); margin:0;">'
                    + bpIcon('lightbulb',16) + ' Suggested Skills for Your Roles</h3>'
                    + '<span style="font-size:0.72em; color:var(--text-muted);">Based on industry standards</span></div>'
                    + '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
                suggestions.slice(0, 20).forEach(function(s) {
                    html += '<span style="display:inline-flex; align-items:center; gap:4px; padding:5px 12px; border-radius:16px; '
                        + 'font-size:0.82em; cursor:pointer; transition:all 0.15s; '
                        + 'background:rgba(96,165,250,0.08); border:1px solid rgba(96,165,250,0.2); color:var(--text-secondary);" '
                        + 'onclick="quickAddSuggested(\'' + s.name.replace(/'/g, "\\'") + '\', \'' + s.level + '\', \'' + s.roleId + '\')" '
                        + 'title="Expected for ' + s.reason + ' (' + s.level + ') — click to add">'
                        + '<span style="font-size:0.9em;">+</span> ' + s.name
                        + '<span style="font-size:0.7em; opacity:0.5;">' + s.reason + '</span></span>';
                });
                if (suggestions.length > 20) {
                    html += '<span style="font-size:0.78em; color:var(--text-muted); padding:5px 8px;">+' + (suggestions.length - 20) + ' more</span>';
                }
                html += '</div></div>';
            }
            
            cardView.innerHTML = html;
        }

        var opportunitiesData = [];
        var currentMatchThreshold = 20;
        let currentSkillsView = 'network'; // Track whether showing network or card within Skills Ontology
        
        // Initialize user interface on load
        document.addEventListener('DOMContentLoaded', async () => {
            // v4.0: Check for magic link sign-in first
            checkMagicLinkSignIn();
            
            // Wait for auth state to resolve
            await authReadyPromise;
            
            // Initialize app and get target view
            var targetView = await initializeApp();
            
            // Detect app mode (demo/waitlisted/invited/active)
            detectAppMode();
            checkWaitlistInviteStatus();
            updateWaitlistCounter();
            console.log('\uD83C\uDFAF App mode:', appMode, waitlistPosition ? '(#' + waitlistPosition + ')' : '');
            
            // If user has profile, set up UI
            if (userData.initialized) {
                // Update profile chip with loaded user's name
                if (userData.profile.name) {
                    updateProfileChip(userData.profile.name);
                }
                
                // Pre-initialize card view data (doesn't display it)
                initCardView();
                
                // Auto-save every 60 seconds (Firestore + localStorage)
                setInterval(() => {
                    saveUserData();
                    if (fbUser && fbDb) saveToFirestore();
                }, 60000);
            }
            
            // Navigate to the target view
            if (targetView === 'welcome') {
                switchView('welcome');
            } else if (targetView === 'blueprint') {
                switchView('blueprint');
            } else {
                // Default: show skills (lazy-init handles network rendering)
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    currentSkillsView = 'card';
                }
                switchView('network');
            }
            
            // Final deferred dropdown rebuild - guarantees manifest + auth are both resolved
            setTimeout(function() { rebuildProfileDropdown(); }, 500);
            
            // Dismiss splash screen
            var splash = document.getElementById('appSplash');
            if (splash) {
                var sp2 = document.getElementById('splashProgress');
                if (sp2) sp2.style.width = '100%';
                setTimeout(function() {
                    splash.style.opacity = '0';
                    setTimeout(function() { splash.remove(); }, 400);
                }, 300);
            }
            // Demo mode: floating "aha moment" nudge after 2 minutes
            if (appMode === 'demo' || appMode === 'waitlisted') {
                setTimeout(function() {
                    if (appMode === 'active' || appMode === 'invited') return; // User signed up meanwhile
                    var nudge = document.createElement('div');
                    nudge.id = 'ahaNudge';
                    nudge.style.cssText = 'position:fixed; bottom:24px; right:24px; z-index:9000; '
                        + 'background:' + tv('#1a1a2e','#ffffff') + '; border:1px solid var(--accent); border-radius:14px; '
                        + 'padding:18px 22px; max-width:320px; box-shadow:0 12px 40px rgba(0,0,0,0.4); '
                        + 'animation: nudgeIn 0.4s ease; font-size:0.88em;';
                    nudge.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">'
                        + '<div style="font-weight:700; color:var(--accent);">\u25C8 Imagine your skills here</div>'
                        + '<button onclick="this.closest(\'#ahaNudge\').remove();" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:1.1em; padding:0 0 0 10px;">\u00D7</button>'
                        + '</div>'
                        + '<div style="color:var(--text-secondary); line-height:1.5; margin-bottom:12px;">'
                        + 'You\u2019re exploring a sample Blueprint. Your portfolio could have <strong>150\u2013300 skills</strong> you don\u2019t even know about yet.</div>'
                        + '<button onclick="this.closest(\'#ahaNudge\').remove(); showWaitlist();" '
                        + 'style="padding:8px 20px; border-radius:8px; border:none; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; font-size:0.9em;">'
                        + 'Map Your Blueprint</button>';
                    document.body.appendChild(nudge);
                    // Auto-dismiss after 20 seconds
                    setTimeout(function() { var n = document.getElementById('ahaNudge'); if (n) n.remove(); }, 20000);
                }, 120000); // 2 minutes
            }
        }); // Close DOMContentLoaded
        
        var _skipHistoryPush = false;
        function switchView(view, event) {
            // Map new view names to existing views
            if (view === 'skills') view = 'network';
            if (view === 'jobs') view = 'opportunities';
            if (view === 'applications') { view = 'opportunities'; jobsSubTab = 'tracker'; }
            
            currentView = view;
            window.scrollTo(0, 0);
            
            // Push browser history (skip if triggered by popstate)
            if (!_skipHistoryPush) {
                history.pushState({ view: view }, '', '#' + view);
            }
            // Update nav button active state
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const navMap = { network: 'nav-skills', skills: 'nav-skills', opportunities: 'nav-jobs', jobs: 'nav-jobs', applications: 'nav-jobs', blueprint: 'nav-blueprint', settings: 'nav-settings', consent: 'nav-settings' };
            const navId = navMap[view] || navMap[currentView];
            if (navId) { const nb = document.getElementById(navId); if (nb) nb.classList.add('active'); }
            
            const networkControls = document.getElementById('networkControls');
            const skillsViewToggle = document.getElementById('skillsViewToggle');
            const controls = document.querySelector('.controls');
            
            // Hide controls bar — shown only for Skills tab
            document.getElementById('controlsBar').style.display = 'none';
            document.querySelector('.main-content')?.classList.remove('with-filters');
            
            // Hide match overlay UI when leaving network view
            if (view !== 'network') {
                var mt = document.getElementById('matchModeToggle');
                var mb = document.getElementById('matchActiveBadge');
                var ml = document.getElementById('matchLegend');
                var jt = document.getElementById('jobInfoTile');
                var ric = document.getElementById('roleInfoCard');
                if (mt) mt.style.display = 'none';
                if (mb) mb.style.display = 'none';
                if (ml) ml.remove();
                if (jt) jt.remove();
                if (ric) ric.style.display = 'none';
            }

            // Update mobile nav
            document.querySelectorAll('.mobile-nav-btn').forEach(b => b.classList.remove('active'));
            const mobMap = { network: 'mob-skills', opportunities: 'mob-jobs', applications: 'mob-jobs', blueprint: 'mob-blueprint', settings: 'mob-settings', consent: 'mob-settings' };
            const mobId = mobMap[view];
            if (mobId) { const mb = document.getElementById(mobId); if (mb) mb.classList.add('active'); }

            // Hide all views
            document.getElementById('welcomeView').style.display = 'none';
            document.getElementById('networkView').style.display = 'none';
            document.getElementById('cardView').style.display = 'none';
            document.getElementById('opportunitiesView').style.display = 'none';
            document.getElementById('applicationsView').style.display = 'none';
            document.getElementById('blueprintView').style.display = 'none';
            document.getElementById('consentView').style.display = 'none';
            document.getElementById('settingsView').style.display = 'none';
            networkControls.style.display = 'none';
            controls.style.display = 'none';
            
            // Hide readonly banner on non-profile views
            var roBanner = document.getElementById('readonlyBanner');
            if (roBanner && (view === 'welcome' || view === 'consent' || view === 'settings')) {
                roBanner.style.display = 'none';
            }
            
            // Hide app footer on welcome view (welcome has its own disclaimer)
            var appFooter = document.getElementById('appFooter');
            if (appFooter) {
                appFooter.style.display = (view === 'welcome') ? 'none' : 'block';
            }
            
            // Show selected view
            if (view === 'welcome') {
                var wv = document.getElementById('welcomeView');
                wv.style.display = 'block';
                // Render welcome unless picker already set custom content
                if (!window._welcomePickerActive) {
                    renderWelcomePage();
                }
                window._welcomePickerActive = false;
            } else if (view === 'network') {
                // Skills Ontology view
                controls.style.display = 'flex';
                // Sync toggle pills with current sub-view
                document.querySelectorAll('#skillsViewToggle .view-pill').forEach(function(chip) {
                    chip.classList.toggle('active', chip.dataset.view === currentSkillsView);
                });
                if (currentSkillsView === 'network') {
                    document.getElementById('networkView').style.display = 'block';
                    networkControls.style.display = 'flex';
                    // Hide filter button in network view (filtering via node clicks)
                    var fBtn = document.getElementById('filterToggleBtn');
                    var fPnl = document.getElementById('filterPanel');
                    if (fBtn) fBtn.style.display = 'none';
                    if (fPnl) fPnl.classList.remove('open');
                    // Show network filter pill if role active
                    var nfp = document.getElementById('networkFilterPill');
                    if (nfp) nfp.style.display = (activeRole && activeRole !== 'all') ? 'flex' : 'none';
                    // Lazy-init network SVG on first visit
                    if (!window.networkInitialized) {
                        initNetwork();
                        window.networkInitialized = true;
                    }
                    // Restore match overlay UI if a job is active
                    if (activeJobForNetwork) {
                        updateMatchOverlayUI();
                        // Re-render the match/job network since overlays were removed on view exit
                        if (networkMatchMode !== 'you') {
                            setNetworkMatchMode(networkMatchMode);
                        }
                    }
                } else {
                    document.getElementById('cardView').style.display = 'block';
                    networkControls.style.display = 'none';
                    // Show filter button in card view
                    var fBtn2 = document.getElementById('filterToggleBtn');
                    if (fBtn2) fBtn2.style.display = '';
                    // Hide network filter pill
                    var nfp2 = document.getElementById('networkFilterPill');
                    if (nfp2) nfp2.style.display = 'none';
                    if (!window.cardViewInitialized) {
                        initCardView();
                        window.cardViewInitialized = true;
                    }
                }
                updateStatsBar();
            } else if (view === 'opportunities') {
                document.getElementById('opportunitiesView').style.display = 'block';
                if (!window.opportunitiesInitialized) {
                    initOpportunities();
                    window.opportunitiesInitialized = true;
                } else {
                    // Re-render to reflect current sub-tab (e.g. tracker from applications redirect)
                    initOpportunities();
                }
                updateStatsBar();
            } else if (view === 'applications') {
                document.getElementById('applicationsView').style.display = 'block';
                if (!window.applicationsInitialized) {
                    initApplications();
                    window.applicationsInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'blueprint') {
                document.getElementById('blueprintView').style.display = 'block';
                if (!window.blueprintInitialized) {
                    initBlueprint();
                    window.blueprintInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'consent') {
                document.getElementById('consentView').style.display = 'block';
                if (!window.consentInitialized) {
                    initConsent();
                    window.consentInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'settings') {
                document.getElementById('settingsView').style.display = 'block';
                if (!window.settingsInitialized) {
                    initSettings();
                    window.settingsInitialized = true;
                }
                updateStatsBar();
            }
        }
        
        function toggleSkillsView(view) {
            currentSkillsView = view;
            document.querySelectorAll('#skillsViewToggle .view-pill').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.view === view);
            });
            
            const networkControls = document.getElementById('networkControls');
            var matchToggle = document.getElementById('matchModeToggle');
            var matchBadge = document.getElementById('matchActiveBadge');
            
            if (view === 'network') {
                document.getElementById('networkView').style.display = 'block';
                document.getElementById('cardView').style.display = 'none';
                networkControls.style.display = 'flex';
                // Lazy-init network if needed (e.g. after profile switch)
                if (!window.networkInitialized) {
                    initNetwork();
                    window.networkInitialized = true;
                }
                // Hide filter button/panel in network view (filtering via node clicks)
                var filterBtn = document.getElementById('filterToggleBtn');
                var filterPnl = document.getElementById('filterPanel');
                if (filterBtn) filterBtn.style.display = 'none';
                if (filterPnl) filterPnl.classList.remove('open');
                // Show network filter pill if a role is active
                var nfPill = document.getElementById('networkFilterPill');
                if (nfPill) nfPill.style.display = (activeRole && activeRole !== 'all') ? 'flex' : 'none';
                // Show match UI if a job is active
                if (activeJobForNetwork) {
                    if (matchToggle) matchToggle.style.display = 'inline-flex';
                    if (matchBadge) matchBadge.style.display = 'inline-flex';
                }
            } else {
                document.getElementById('networkView').style.display = 'none';
                document.getElementById('cardView').style.display = 'block';
                networkControls.style.display = 'none';
                // Lazy-init card view if needed (e.g. after profile switch)
                if (!window.cardViewInitialized) {
                    initCardView();
                    window.cardViewInitialized = true;
                }
                // Show filter button in card view
                var filterBtn2 = document.getElementById('filterToggleBtn');
                if (filterBtn2) filterBtn2.style.display = '';
                // Hide network filter pill in card view
                var nfPill2 = document.getElementById('networkFilterPill');
                if (nfPill2) nfPill2.style.display = 'none';
                // Hide match UI on card view
                if (matchToggle) matchToggle.style.display = 'none';
                if (matchBadge) matchBadge.style.display = 'none';
            }
        }
        
        function updateStatsBar() {
            const statsBar = document.getElementById('statsBar');
            if (currentView === 'network') {
                // Calculate total market value
                const totalValue = calculateTotalMarketValue();
                const valueFormatted = totalValue.total > 0 ? `$${(totalValue.total/1000).toFixed(0)}k` : '';
                const valueDisplay = valueFormatted ? ` • <span style="color: #10b981; font-weight: 700;">Market Value: ${valueFormatted}/year</span>` : '';
                
                // Dynamic counts by category
                const skillCount = userData.skills?.length || 0;
                const roleCount = userData.roles?.length || 0;
                const onetSkillsCount = userData.skills?.filter(s => s.category === 'skill').length || 0;
                const abilitiesCount = userData.skills?.filter(s => s.category === 'ability').length || 0;
                const workStylesCount = userData.skills?.filter(s => s.category === 'workstyle').length || 0;
                const uniqueCount = userData.skills?.filter(s => s.category === 'unique').length || 0;
                
                // Show detailed breakdown for v2.0.6 comprehensive model
                let skillBreakdown = '';
                if (skillCount >= 90) {
                    // Comprehensive 90-skill model
                    skillBreakdown = ` (${onetSkillsCount} Skills + ${abilitiesCount} Abilities + ${workStylesCount} Work Styles + ${uniqueCount} Unique)`;
                } else if (onetSkillsCount > 0 && uniqueCount > 0) {
                    // Hybrid model (v2.0.5)
                    skillBreakdown = ` (${onetSkillsCount} O*NET + ${uniqueCount} Unique)`;
                }
                
                statsBar.innerHTML = `${skillCount} Total Skills${skillBreakdown} • ${roleCount} Career Roles${valueDisplay}`;
                // Append verification stats if any exist
                var vStats = getVerificationStats();
                if (vStats.verified > 0 || vStats.pending > 0) {
                    statsBar.innerHTML += ` • ${vStats.verified} Verified`;
                    if (vStats.pending > 0) statsBar.innerHTML += ` (${vStats.pending} pending)`;
                }
            } else if (currentView === 'opportunities') {
                const matches = opportunitiesData.filter(j => j.matchScore >= currentMatchThreshold).length;
                statsBar.innerHTML = `${matches} Matching Opportunities • ${currentMatchThreshold}%+ Match Threshold`;
            } else if (currentView === 'applications') {
                const total = userData.applications?.length || 0;
                const active = userData.applications?.filter(a => a.status !== 'rejected').length || 0;
                statsBar.innerHTML = `${total} Applications Tracked • ${active} Active`;
            } else if (currentView === 'blueprint') {
                const sharedOutcomes = blueprintData.outcomes.filter(o => o.shared).length;
                const selectedValues = blueprintData.values.filter(v => v.selected).length;
                statsBar.innerHTML = `${sharedOutcomes} Outcomes • ${selectedValues} Values • Purpose Statement`;
            } else if (currentView === 'consent') {
                const totalShared = blueprintData.outcomes.filter(o => o.shared).length + 
                                   blueprintData.values.filter(v => v.selected).length;
                statsBar.innerHTML = `${totalShared} Items Shared • Data Privacy & Control`;
            } else if (currentView === 'settings') {
                statsBar.innerHTML = `Profile Settings • ${userData.preferences.seniorityLevel} Level • Customize Your Experience`;
            }
        }
        
        function toggleLabels(type) {
            // v4.20.1: Read actual checkbox state and apply to ANY active network SVG
            var svg = d3.select("#networkView");
            if (svg.empty()) return;
            
            // Find the checkbox for this type
            var checkboxes = document.querySelectorAll('#networkControls input[type="checkbox"]');
            var isChecked = true;
            checkboxes.forEach(function(cb) {
                // Role checkbox is first, Skill checkbox is second
                if (type === 'role' && cb === checkboxes[0]) isChecked = cb.checked;
                if (type === 'skill' && cb === checkboxes[1]) isChecked = cb.checked;
            });
            
            svg.selectAll('text')
                .filter(function(d) { return d && d.type === type; })
                .classed('hidden', !isChecked);
        }
        
        // Apply current toggle states to network after any re-render
        function applyLabelToggles() {
            var checkboxes = document.querySelectorAll('#networkControls input[type="checkbox"]');
            if (checkboxes.length >= 2) {
                var roleChecked = checkboxes[0].checked;
                var skillChecked = checkboxes[1].checked;
                var svg = d3.select("#networkView");
                if (!svg.empty()) {
                    svg.selectAll('text')
                        .filter(function(d) { return d && d.type === 'role'; })
                        .classed('hidden', !roleChecked);
                    svg.selectAll('text')
                        .filter(function(d) { return d && d.type === 'skill'; })
                        .classed('hidden', !skillChecked);
                }
            }
        }
        window.applyLabelToggles = applyLabelToggles;

        // Render dynamic role chips and level counts from current profile data
        function renderFilterChips() {
            // --- ROLES ---
            const rolesContainer = document.getElementById('roleChipsContainer');
            if (rolesContainer && userData.roles) {
                rolesContainer.innerHTML = `<div class="role-chip active" data-role="all" onclick="filterByRole('all')">All</div>` +
                    userData.roles.map(role => 
                        `<div class="role-chip" data-role="${role.id}" onclick="filterByRole('${role.id}')">${role.name}</div>`
                    ).join('');
            }
            
            // --- LEVELS ---
            const levelContainer = document.getElementById('levelChipsContainer');
            if (levelContainer && userData.skills) {
                const levelDefs = [
                    { key: 'Mastery',    cls: 'mastery' },
                    { key: 'Expert',     cls: 'expert' },
                    { key: 'Advanced',   cls: 'advanced' },
                    { key: 'Proficient', cls: 'proficient' },
                    { key: 'Novice',     cls: 'novice' }
                ];
                levelContainer.innerHTML = levelDefs
                    .map(({ key, cls }) => {
                        const count = userData.skills.filter(s => s.level === key).length;
                        if (count === 0) return '';
                        return `<div class="level-chip ${cls}" onclick="filterByLevel('${key.toLowerCase()}')">${key} (${count})</div>`;
                    })
                    .join('');
            }
        }

        function filterByRole(roleId) {
            activeRole = roleId;
            
            // Update filter panel chips
            document.querySelectorAll('.role-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.role === roleId);
            });
            
            // Update Role Info Card
            var ric = document.getElementById('roleInfoCard');
            if (ric && currentSkillsView === 'network') {
                if (roleId === 'all') {
                    ric.style.display = 'none';
                } else {
                    var roleName = roleId;
                    var roleColor = 'var(--accent)';
                    if (window.networkData && window.networkData.nodes) {
                        var roleNode = window.networkData.nodes.find(function(n) { return n.id === roleId; });
                        if (roleNode) {
                            roleName = roleNode.name || roleId;
                            roleColor = roleNode.color || 'var(--accent)';
                        }
                    }
                    
                    document.getElementById('roleInfoName').textContent = roleName;
                    document.getElementById('roleInfoDot').style.background = roleColor;
                    
                    // Build stats from skills data
                    var roleSkills = skillsData.skills.filter(function(s) { return s.roles && s.roles.includes(roleId); });
                    var levelCounts = {};
                    var keyCount = 0;
                    roleSkills.forEach(function(s) {
                        levelCounts[s.level] = (levelCounts[s.level] || 0) + 1;
                        if (s.key) keyCount++;
                    });
                    
                    var statsHtml = '<div style="margin-bottom:6px;">' + bpIcon('layers',13) + ' <strong>' + roleSkills.length + '</strong> skills</div>';
                    var levelOrder = ['Mastery', 'Expert', 'Advanced', 'Proficient', 'Novice'];
                    var levelIcons = { Mastery: '#f59e0b', Expert: '#a855f7', Advanced: '#3b82f6', Proficient: '#10b981', Novice: '#6b7280' };
                    var levelBars = '';
                    levelOrder.forEach(function(lv) {
                        if (levelCounts[lv]) {
                            levelBars += '<div style="display:flex; align-items:center; gap:6px;">'
                                + '<span style="width:6px; height:6px; border-radius:50%; background:' + levelIcons[lv] + ';"></span>'
                                + '<span style="min-width:65px;">' + lv + '</span>'
                                + '<span style="font-weight:600; color:' + levelIcons[lv] + ';">' + levelCounts[lv] + '</span>'
                                + '</div>';
                        }
                    });
                    if (levelBars) statsHtml += '<div style="display:flex; flex-direction:column; gap:3px; margin-top:6px;">' + levelBars + '</div>';
                    if (keyCount > 0) statsHtml += '<div style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border);">' + bpIcon('star',13) + ' <strong>' + keyCount + '</strong> core competencies</div>';
                    
                    document.getElementById('roleInfoStats').innerHTML = statsHtml;
                    ric.style.display = 'block';
                }
            }
            // Keep legacy pill in sync for any external references
            var nfPill = document.getElementById('networkFilterPill');
            if (nfPill) nfPill.style.display = 'none';

            if (!window.networkData) return;

            const { nodes, links, node, link } = window.networkData;

            if (roleId === 'all') {
                node.classed('dimmed', false).classed('highlighted', false);
                link.classed('dimmed', false).classed('highlighted', false);
                
                // Show all labels
                node.selectAll('text').classed('hidden', false);
                return;
            }

            // Find skills that belong to this role
            const relevantSkills = skillsData.skills
                .filter(s => s.roles.includes(roleId))
                .map((s, i) => `skill-${skillsData.skills.indexOf(s)}`);

            node.classed('dimmed', d => {
                if (d.type === 'center') return false;
                if (d.type === 'role') return d.id !== roleId;
                return !relevantSkills.includes(d.id);
            });

            node.classed('highlighted', d => {
                if (d.type === 'role') return d.id === roleId;
                return relevantSkills.includes(d.id);
            });

            link.classed('dimmed', d => {
                return d.source.id !== roleId && !relevantSkills.includes(d.target.id);
            });

            link.classed('highlighted', d => {
                return d.source.id === roleId && relevantSkills.includes(d.target.id);
            });
            
            // STORYTELLING MODE: Show only relevant labels + selected role
            node.selectAll('text').classed('hidden', function(d) {
                if (d.type === 'center') return false;
                if (d.type === 'role') return true; // Hide ALL role labels (info card shows selected role)
                return !relevantSkills.includes(d.id); // Hide non-relevant skill labels
            });
        }
        window.filterByRole = filterByRole;

        function filterByLevel(level) {
            activeLevel = activeLevel === level ? null : level;
            
            event.target.classList.toggle('active');

            if (!window.networkData) return;
            const { node } = window.networkData;

            if (!activeLevel) {
                node.classed('dimmed', false);
                return;
            }

            node.classed('dimmed', d => {
                if (d.type !== 'skill') return false;
                return d.level.toLowerCase() !== activeLevel;
            });
        }


        function showTooltip(event, d) {
            if (d.type === 'center' || d.type === 'role') return;

            const tooltip = d3.select('#tooltip');
            let html = `<div class="tooltip-title">${d.name}</div>`;

            if (d.type === 'skill') {
                html += `<div class="tooltip-level">${d.level}${d.key ? ' • Core Differentiator' : ''}</div>`;
                html += `<div class="tooltip-roles">Used in: `;
                d.roles.forEach(roleId => {
                    const role = skillsData.roles.find(r => r.id === roleId);
                    html += `<span class="tooltip-role-tag">${role.name}</span>`;
                });
                html += `</div>`;
            }

            tooltip
                .html(html)
                .style('opacity', 1)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            d3.select('#tooltip').style('opacity', 0);
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            if (d.type !== 'center') {
                d.fx = null;
                d.fy = null;
            }
        }
        // [removed] openExportModal — dead code cleanup v4.22.0

        function closeExportModal() {
            var m = document.getElementById('exportModal');
            m.classList.remove('active');
            m.style.display = '';
        }
        
        // ===== WORK BLUEPRINT GENERATOR =====
        
        function generateWorkBlueprint() {
            console.log('Generating Blueprint...');
            
            try {
                const profileData = gatherBlueprintData();
                const html = createBlueprintHTML(profileData);
                downloadBlueprint(html, `blueprint-${profileData.name.replace(/\s+/g, '-').toLowerCase()}.html`);
                
                showToast('Blueprint downloaded! Open in any browser to view, print, or share.', 'success', 6000);
            } catch (error) {
                console.error('Error generating blueprint:', error);
                showToast('Error generating Blueprint. Check console for details.', 'error');
            }
        }
        
        function gatherBlueprintData() {
            const skills = skillsData.skills || userData.skills || [];
            const topSkills = skills.map(skill => ({ ...skill, impact: getSkillImpact(skill) })).sort((a, b) => (b.impact?.score || 0) - (a.impact?.score || 0)).slice(0, 10);
            const compensation = calculateTotalMarketValue();

            // Pull real strategic outcomes from skill evidence — prefer items with metrics
            const allEvidence = [];
            skills.forEach(skill => {
                (skill.evidence || []).forEach(ev => {
                    const text = (ev.outcome || '') + ' ' + (ev.description || '');
                    let score = 0;
                    if (/\$[\d,]+[MBK]?/i.test(text)) score += 5;
                    if (/\d+%/.test(text)) score += 4;
                    if (/million|billion/i.test(text)) score += 5;
                    if (/\d+x|\d+ times/i.test(text)) score += 3;
                    if (skill.level === 'Mastery' || skill.level === 'Expert') score += 2;
                    if (skill.key) score += 2;
                    allEvidence.push({ skill: skill.name, description: ev.description, outcome: ev.outcome, score });
                });
            });
            allEvidence.sort((a, b) => b.score - a.score);

            // Build strategicOutcomes from top 5 real evidence items
            const strategicOutcomes = allEvidence.slice(0, 5).map(item => ({
                title: item.skill,
                metric: extractMetric(item.outcome),
                description: item.description || '',
                outcome: item.outcome || ''
            }));

            // Use real values from profile
            const selectedValues = (userData.values || []).filter(v => v.selected !== false).map(v => v.name || v);

            return {
                name: userData.profile.name || 'Your Name',
                title: userData.profile.currentTitle || 'Your Title',
                company: userData.profile.currentCompany || '',
                location: userData.profile.location || '',
                headline: userData.profile.headline || `${userData.profile.currentTitle || 'Strategic Professional'} · ${userData.profile.yearsExperience || ''}+ Years`,
                generatedDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                executiveSummary: userData.profile.executiveSummary || userData.purpose || 'Accomplished professional with proven track record of delivering measurable business impact.',
                purpose: userData.purpose || '',
                coreCompetencies: topSkills,
                strategicOutcomes,
                leadershipPhilosophy: userData.purpose || 'Leadership is about creating conditions where great work becomes inevitable.',
                marketPositioning: selectedValues.length > 0
                    ? `Core principles: ${selectedValues.join(' · ')}.`
                    : 'Strategic professional with deep domain expertise and proven track record.',
                compensation: compensation,
                careerNarrative: userData.profile.executiveSummary || 'A career defined by building bridges between technical innovation and business strategy.',
                futureVision: userData.purpose || 'Focused on creating lasting impact through authentic leadership and evidence-based strategy.'
            };
        }

        // Extract the most compelling metric from an outcome string
        function extractMetric(text) {
            if (!text) return '';
            const dollarMatch = text.match(/\$[\d.,]+[MBK]?(?:\s*\w+)?/i);
            if (dollarMatch) return dollarMatch[0];
            const pctMatch = text.match(/\d+%(?:\s*\w+)?/);
            if (pctMatch) return pctMatch[0];
            const multMatch = text.match(/\d+x(?:\s*\w+)?/i);
            if (multMatch) return multMatch[0];
            // Fallback: first 40 chars
            return text.slice(0, 40) + (text.length > 40 ? '…' : '');
        }
        
        function createBlueprintHTML(data) {
            const htmlContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Blueprint - ' + data.name + '</title><link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}:root{--primary:#1e40af;--accent:#f59e0b;--text:#1f2937;--text-light:#6b7280;--border:#e5e7eb;--bg:#fff;--bg-alt:#f9fafb}body{font-family:Crimson Pro,Georgia,serif;color:var(--text);background:var(--bg);line-height:1.7;font-size:18px}.container{max-width:900px;margin:0 auto;padding:60px 40px}header{border-bottom:3px solid var(--primary);padding-bottom:40px;margin-bottom:60px}h1{font-size:48px;font-weight:700;color:var(--primary);margin-bottom:10px}h2{font-size:32px;font-weight:700;color:var(--primary);margin-bottom:20px;border-left:4px solid var(--accent);padding-left:20px}section{margin-bottom:60px}p{margin-bottom:16px}.subtitle{font-size:24px;color:var(--text-light);margin-bottom:20px}.headline{font-size:20px;color:var(--accent);font-weight:600}.meta{font-family:JetBrains Mono,monospace;font-size:14px;color:var(--text-light);margin-top:20px}.skills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:30px}.skill-card{background:var(--bg-alt);border:1px solid var(--border);border-left:4px solid #3b82f6;padding:20px}.skill-name{font-size:18px;font-weight:600;color:var(--primary);margin-bottom:8px}.skill-level{font-family:JetBrains Mono,monospace;font-size:12px;color:var(--accent);text-transform:uppercase}.outcome{background:linear-gradient(to right,var(--bg-alt),var(--bg));border-left:4px solid var(--accent);padding:24px;margin-bottom:20px}.outcome-title{font-size:20px;font-weight:600;color:var(--primary);margin-bottom:8px}.outcome-metric{font-family:JetBrains Mono,monospace;font-size:16px;color:var(--accent);margin-bottom:10px}.comp-framework{background:var(--bg-alt);border:2px solid var(--primary);padding:30px;margin-top:30px}.comp-row{display:flex;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border)}.comp-label{font-weight:600}.comp-value{font-family:JetBrains Mono,monospace;color:var(--primary);font-weight:600}.quote-block{background:linear-gradient(135deg,var(--primary),#3b82f6);color:#fff;padding:40px;margin:40px 0;font-size:22px;font-style:italic}@media print{body{font-size:11pt}.container{padding:20px}h1{font-size:28pt}h2{font-size:18pt}}</style></head><body><div class="container"><header><h1>' + data.name + '</h1><div class="subtitle">' + data.title + '</div><div class="headline">' + data.headline + '</div><div class="meta">Generated: ' + data.generatedDate + '</div></header><section><h2>Executive Summary</h2><p>' + data.executiveSummary + '</p></section><section><h2>Core Competencies</h2><p>Strategic capabilities driving measurable impact:</p><div class="skills-grid">' + data.coreCompetencies.map(s => '<div class="skill-card"><div class="skill-name">' + s.name + '</div><div class="skill-level">' + (s.proficiency || 'Expert') + '</div></div>').join('') + '</div></section><section><h2>Strategic Outcomes</h2>' + data.strategicOutcomes.map(o => '<div class="outcome"><div class="outcome-title">' + o.title + '</div><div class="outcome-metric">' + o.metric + '</div><p>' + o.description + '</p></div>').join('') + '</section><section><h2>Leadership Philosophy</h2><p>' + data.leadershipPhilosophy + '</p></section><div class="quote-block">"' + data.marketPositioning + '"</div><section><h2>Compensation Framework</h2><p>Market-informed positioning based on skill depth and impact:</p><div class="comp-framework"><div class="comp-row"><span class="comp-label">Base Market Rate</span><span class="comp-value">$' + Math.round(data.compensation.marketRate || 200000).toLocaleString() + '</span></div><div class="comp-row"><span class="comp-label">Conservative Range</span><span class="comp-value">$' + Math.round(data.compensation.conservativeOffer || 225000).toLocaleString() + '</span></div><div class="comp-row"><span class="comp-label">Competitive Range</span><span class="comp-value">$' + Math.round(data.compensation.competitiveOffer || 275000).toLocaleString() + '</span></div></div></section><section><h2>Career Narrative</h2><p>' + data.careerNarrative + '</p></section><section><h2>Future Vision</h2><p>' + data.futureVision + '</p></section><footer style="margin-top:80px;padding-top:40px;border-top:2px solid var(--border);color:var(--text-light);font-size:14px"><p>This Blueprint is a living document representing strategic capabilities and market positioning as of ' + data.generatedDate + '.</p><p style=\"margin-top:8px;\">&copy; ' + new Date().getFullYear() + ' Cliff Jurkiewicz. All rights reserved. Blueprint&trade; and its methodologies are the intellectual property of Cliff Jurkiewicz. · myblueprint.work</p></footer></div></body></html>';
            return htmlContent;
        }
        
        function downloadBlueprint(html, filename) {
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function openSkillModal(skillName, skillData) {
            const modal = document.getElementById('skillModal');
            const title = document.getElementById('skillDetailTitle');
            const subtitle = document.getElementById('skillDetailSubtitle');
            const body = document.getElementById('skillDetailBody');
            
            // Set title
            title.textContent = skillName;
            
            // Set subtitle (level, years, core badge, category badge)
            const levelClass = skillData.level.toLowerCase();
            const coreBadge = skillData.key ? '<span class="modal-core-badge">' + bpIcon('star',12) + ' CORE DIFFERENTIATOR</span>' : '';
            const details = skillsData.skillDetails[skillName] || {};
            
            // DEBUG: Log evidence availability
            console.log('=== EVIDENCE DEBUG ===');
            console.log('Skill:', skillName);
            console.log('skillData.evidence:', skillData.evidence);
            console.log('details.evidence:', details.evidence);
            
            // Get evidence from skill object if not in skillDetails
            const evidence = details.evidence || (skillData.evidence ? skillData.evidence.map(e => `${e.description}<br><strong>Outcome:</strong> ${e.outcome}`) : null);
            console.log('Final evidence:', evidence);
            
            const years = details.years || skillData.yearsExperience || 'N/A';
            
            // Category badge for all O*NET types + Unique
            let categoryBadge = '';
            if (skillData.category === 'skill') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">' + bpIcon('graduation',12) + ' O*NET Skill</span>';
            } else if (skillData.category === 'ability') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(139, 92, 246, 0.2); color: #a78bfa;">' + bpIcon('zap',12) + ' O*NET Ability</span>';
            } else if (skillData.category === 'workstyle') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">' + bpIcon('briefcase',12) + ' O*NET Work Style</span>';
            } else if (skillData.category === 'unique') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">' + bpIcon('star',12) + ' Unique Differentiator</span>';
            }
            
            subtitle.innerHTML = `
                <span class="modal-level-badge ${levelClass}">${skillData.level}</span>
                <span class="modal-years">${years} years experience</span>
                ${categoryBadge}
                ${coreBadge}
            `;
            
            // Build body content
            let bodyHTML = '';
            
            // Evidence Quality Panel (v4.16.0)
            const evSummary = getEvidenceSummary(skillData);
            const hasGap = evSummary.hasGap;
            const gapColor = hasGap ? tv('#fbbf24','#d97706') : tv('#10b981','#059669');
            const gapBg = hasGap ? tv('rgba(251,191,36,0.08)','rgba(251,191,36,0.05)') : tv('rgba(16,185,129,0.08)','rgba(16,185,129,0.05)');
            const gapBorder = hasGap ? tv('rgba(251,191,36,0.25)','rgba(251,191,36,0.15)') : tv('rgba(16,185,129,0.25)','rgba(16,185,129,0.15)');
            
            bodyHTML += '<div style="padding:14px; margin-bottom:16px; background:' + gapBg + '; border:1px solid ' + gapBorder + '; border-radius:10px;">';
            bodyHTML += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">';
            bodyHTML += '<div style="font-weight:700; font-size:0.88em; color:' + gapColor + ';">'
                + (hasGap ? '\u26A0 Evidence Gap' : '\u2705 Evidence Backed') + '</div>';
            bodyHTML += '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + ';">'
                + evSummary.points + ' pts \u2192 ' + evSummary.effectiveLevel + '</div>';
            bodyHTML += '</div>';
            
            // Progress bar
            var maxPts = evidenceConfig.thresholds['Mastery'];
            var pctFill = Math.min((evSummary.points / maxPts) * 100, 100);
            bodyHTML += '<div style="height:6px; background:' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + '; border-radius:3px; overflow:hidden;">';
            bodyHTML += '<div style="height:100%; width:' + pctFill + '%; background:' + gapColor + '; border-radius:3px; transition:width 0.3s;"></div>';
            bodyHTML += '</div>';
            
            if (hasGap) {
                bodyHTML += '<div style="font-size:0.78em; color:' + tv('#d1d5db','#475569') + '; margin-top:8px; line-height:1.45;">'
                    + 'Claimed <strong>' + evSummary.claimedLevel + '</strong> but evidence supports <strong>' + evSummary.effectiveLevel + '</strong>. '
                    + 'Market valuation uses the evidence-backed level. ';
                if (evSummary.nextLevel) {
                    bodyHTML += 'Add ' + evSummary.pointsNeeded + ' more points of evidence for <strong>' + evSummary.nextLevel + '</strong>.';
                }
                bodyHTML += '</div>';
            } else if (evSummary.nextLevel) {
                bodyHTML += '<div style="font-size:0.78em; color:' + tv('#9ca3af','#64748b') + '; margin-top:6px;">'
                    + evSummary.pointsNeeded + ' more points for ' + evSummary.nextLevel + '</div>';
            }
            
            // Verification badges
            if (evSummary.verifiedCount > 0 || evSummary.pendingCount > 0) {
                bodyHTML += '<div style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap;">';
                if (evSummary.verifiedCount > 0) {
                    bodyHTML += '<span style="font-size:0.72em; padding:2px 8px; border-radius:10px; background:' + tv('rgba(16,185,129,0.15)','rgba(16,185,129,0.1)') + '; color:#10b981;">\u2713 Verified by ' + evSummary.verifiedCount + '</span>';
                }
                if (evSummary.pendingCount > 0) {
                    bodyHTML += '<span style="font-size:0.72em; padding:2px 8px; border-radius:10px; background:' + tv('rgba(251,191,36,0.15)','rgba(251,191,36,0.1)') + '; color:#f59e0b;">\u23F3 ' + evSummary.pendingCount + ' pending</span>';
                }
                if (evSummary.hasCert) {
                    bodyHTML += '<span style="font-size:0.72em; padding:2px 8px; border-radius:10px; background:' + tv('rgba(139,92,246,0.15)','rgba(139,92,246,0.1)') + '; color:#a78bfa;">\uD83C\uDFC5 Certification linked</span>';
                }
                bodyHTML += '</div>';
            }
            
            bodyHTML += '</div>';
            
            // Roles section
            bodyHTML += `
                <div class="modal-section">
                    <div class="modal-section-title">
                        <span class="modal-section-icon">${bpIcon("target",18)}</span>
                        Used in These Roles
                    </div>
                    <div class="roles-tags">
            `;
            skillData.roles.forEach(roleId => {
                const role = skillsData.roles.find(r => r.id === roleId);
                if (role) {
                    bodyHTML += `<div class="role-tag">${getRoleIconSvg(role.name, 14)} ${role.name}</div>`;
                }
            });
            bodyHTML += `</div></div>`;
            
            // Evidence section — EDITABLE (v4.16.1)
            var rawEvidence = skillData.evidence || [];
            var escapedSkillName = skillName.replace(/'/g, "\\'");
            
            bodyHTML += '<div class="modal-section">';
            bodyHTML += '<div class="modal-section-title" style="display:flex; justify-content:space-between; align-items:center;">';
            bodyHTML += '<div><span class="modal-section-icon">' + bpIcon('check',16) + '</span> Evidence & Outcomes</div>';
            bodyHTML += '<button onclick="addOutcomeToSkill(\'' + escapedSkillName + '\')" '
                + 'style="padding:5px 14px; background:' + tv('rgba(16,185,129,0.15)','rgba(16,185,129,0.08)') + '; '
                + 'color:#10b981; border:1px solid ' + tv('rgba(16,185,129,0.3)','rgba(16,185,129,0.2)') + '; border-radius:6px; cursor:pointer; font-size:0.82em; font-weight:600;">'
                + '+ Add Outcome</button>';
            bodyHTML += '</div>';
            
            bodyHTML += '<div id="skillEvidenceList">';
            
            if (rawEvidence.length > 0) {
                rawEvidence.forEach(function(ev, idx) {
                    var pts = scoreOutcome(((ev.outcome || '') + ' ' + (ev.description || '')).trim());
                    var ptColor = pts >= 4 ? '#10b981' : pts >= 2.5 ? '#60a5fa' : tv('#9ca3af','#64748b');
                    
                    bodyHTML += '<div style="padding:10px 12px; margin-bottom:8px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; '
                        + 'border:1px solid ' + tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.06)') + '; border-radius:8px; position:relative;">';
                    
                    // Score badge + controls
                    bodyHTML += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">'
                        + '<span style="font-size:0.72em; padding:1px 8px; border-radius:8px; background:' + tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.04)') + '; color:' + ptColor + '; font-weight:600;">'
                        + pts + ' pt' + (pts !== 1 ? 's' : '') + '</span>'
                        + '<div style="display:flex; gap:6px;">'
                        + '<button onclick="editSkillOutcome(\'' + escapedSkillName + '\',' + idx + ')" style="background:none; border:none; cursor:pointer; font-size:0.8em; color:' + tv('#60a5fa','#2563eb') + ';">\u270E</button>'
                        + '<button onclick="removeOutcome(\'' + escapedSkillName + '\',' + idx + ')" style="background:none; border:none; cursor:pointer; font-size:0.85em; color:' + tv('#ef4444','#dc2626') + ';">\u00D7</button>'
                        + '</div></div>';
                    
                    if (ev.outcome) {
                        bodyHTML += '<div style="font-size:0.88em; font-weight:600; color:' + tv('#e0e0e0','#1f2937') + '; line-height:1.45;">' + ev.outcome + '</div>';
                    }
                    if (ev.description) {
                        bodyHTML += '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + '; margin-top:3px; line-height:1.4;">' + ev.description + '</div>';
                    }
                    
                    bodyHTML += '</div>';
                });
            } else {
                bodyHTML += '<div style="text-align:center; padding:20px; color:' + tv('#6b7280','#9ca3af') + '; font-size:0.88em;">'
                    + 'No evidence yet. Add outcomes to increase this skill\'s effective level and market value.'
                    + '</div>';
            }
            
            bodyHTML += '</div>'; // end skillEvidenceList
            bodyHTML += '</div>'; // end modal-section
            
            // MARKET IMPACT SECTION
            const skillImpact = calculateSkillValue(skillData);
            const impactColor = getImpactColor(skillImpact.level);
            
            bodyHTML += `
                <div class="modal-section" style="background: rgba(${impactColor === '#ef4444' ? '239, 68, 68' : impactColor === '#f59e0b' ? '245, 158, 11' : impactColor === '#3b82f6' ? '59, 130, 246' : '107, 114, 128'}, 0.1); border-left: 3px solid ${impactColor}; padding: 20px; border-radius: 8px;">
                    <div class="modal-section-title">
                        <span class="modal-section-icon">${bpIcon("bar-chart",18)}</span>
                        Market Impact
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="font-size: 1.8em; font-weight: 700; color: ${impactColor}; margin-bottom: 10px;">
                            ${skillImpact.icon} ${skillImpact.label}
                        </div>
                        
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px; line-height: 1.5;">
                            ${skillImpact.rationale || 'This skill contributes to your overall market value based on proficiency level and market demand.'}
                        </div>
                        
                        ${skillData.category === 'unique' && skillImpact.needsAssessment ? `
                            <div style="background: rgba(251, 191, 36, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #fbbf24;">
                                <div style="color: #fbbf24; font-weight: 600; margin-bottom: 8px;">${bpIcon("warning",14)} Estimated Rating</div>
                                <div style="color: #d1d5db; font-size: 0.9em; line-height: 1.5; margin-bottom: 12px;">
                                    ${skillImpact.rationale}
                                </div>
                                <button onclick="closeSkillModal(); openAssessSkillModal('${skillData.name.replace(/'/g, "\\'")}');" 
                                        style="padding: 8px 16px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: #000;">
                                    ${bpIcon("clipboard",14)} Assess This Skill
                                </button>
                            </div>
                        ` : ''}
                        
                        ${skillData.category === 'unique' && skillImpact.userAssessed ? `
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="color: #10b981; font-weight: 600; margin-bottom: 5px;">✓ User Assessed</div>
                                <div style="color: #d1d5db; font-size: 0.85em;">
                                    Based on your assessment of this skill's experience, impact, and market scarcity.
                                    <button onclick="closeSkillModal(); openAssessSkillModal('${skillData.name.replace(/'/g, "\\'")}');" 
                                            style="margin-left: 10px; padding: 4px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                        Edit Assessment
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 6px; margin-top: 15px;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px; display:flex; align-items:center; gap:6px;">${bpIcon("bar-chart",16)} Impact Scale</div>
                            <div style="color: #d1d5db; font-size: 0.9em; line-height: 1.6;">
                                • <strong style="color: #ef4444;">${bpIcon('flame',13)} Critical:</strong> Top 5% differentiators, significant premium<br>
                                • <strong style="color: #f59e0b;">${bpIcon('star',13)} High:</strong> Top 20% skills, strong differentiator<br>
                                • <strong style="color: #3b82f6;">${bpIcon('diamond',13)} Moderate:</strong> Expected for role level, valuable<br>
                                • <strong style="color: #6b7280;">${bpIcon('check',13)} Standard:</strong> Baseline expectations<br>
                                • <strong style="color: #9ca3af;">${bpIcon('check',13)} Supplementary:</strong> Supporting capabilities
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 5px;">${bpIcon('lightbulb',14)} How This Affects Your Strategic Value</div>
                            <div style="color: #d1d5db; font-size: 0.85em; line-height: 1.5;">
                                Your compensation positioning is driven by your <strong>Critical and High Impact skills combined</strong> with your experience level. Focus on developing and demonstrating these capabilities to command premium offers.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Story section
            if (details.story) {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">${bpIcon("book",16)}</span>
                            Context & Story
                        </div>
                        <div class="story-text">${details.story}</div>
                    </div>
                `;
            }
            
            // Related skills section
            if (details.relatedSkills && details.relatedSkills.length > 0) {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">${bpIcon("external",16)}</span>
                            Related Skills
                        </div>
                        <div class="related-skills">
                `;
                details.relatedSkills.forEach(relatedSkill => {
                    bodyHTML += `<div class="related-skill-chip" onclick="openRelatedSkill('${relatedSkill}')">${relatedSkill}</div>`;
                });
                bodyHTML += `</div></div>`;
            }
            
            body.innerHTML = bodyHTML;
            
            // Add action bar at bottom of modal
            var actionsHtml = '<div style="display:flex; gap:10px; margin-top:20px; padding-top:16px; border-top:1px solid var(--border);">'
                + '<button onclick="closeSkillModal(); openEditSkillModal(\'' + skillName.replace(/'/g, "\\'") + '\', \'' + (skillData.category || 'unique') + '\');" '
                + 'style="padding:10px 20px; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + `${bpIcon('edit',14)} Edit Skill</button>`
                + '<button onclick="closeSkillModal(); openAssessSkillModal(\'' + skillName.replace(/'/g, "\\'") + '\');" '
                + 'style="padding:10px 20px; background:rgba(96,165,250,0.15); color:var(--accent); border:1px solid rgba(96,165,250,0.3); border-radius:8px; cursor:pointer; font-size:0.9em;">'
                + `${bpIcon('clipboard',14)} Assess</button>`
                + '<button onclick="closeSkillModal(); requestVerification([\'' + skillName.replace(/'/g, "\\'") + '\']);" '
                + 'style="padding:10px 20px; background:rgba(16,185,129,0.12); color:#10b981; border:1px solid rgba(16,185,129,0.3); border-radius:8px; cursor:pointer; font-size:0.9em;">'
                + `${bpIcon('check',14)} Verify</button>`
                + '<button onclick="if(confirm(\'Remove ' + skillName.replace(/'/g, "\\'") + ' from your profile?\')){deleteSkillFromProfile(\'' + skillName.replace(/'/g, "\\'") + '\'); closeSkillModal();}" '
                + 'style="margin-left:auto; padding:10px 16px; background:none; color:#ef4444; border:1px solid rgba(239,68,68,0.3); border-radius:8px; cursor:pointer; font-size:0.9em;">'
                + `${bpIcon('trash',14)} Remove</button>`
                + '</div>';
            body.innerHTML += actionsHtml;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function closeSkillModal() {
            document.getElementById('skillModal').classList.remove('active');
        }
        
        function openRelatedSkill(skillName) {
            const skill = skillsData.skills.find(s => s.name === skillName);
            if (skill) {
                openSkillModal(skillName, skill);
            }
        }
        
        function openSkillModalFromCard(skillName) {
            const skill = skillsData.skills.find(s => s.name === skillName);
            
            if (skill) {
                console.log('  → Skill has evidence:', skill.evidence ? `YES (${skill.evidence.length} items)` : 'NO');
                openSkillModal(skillName, skill);
            } else {
                console.error('  → ERROR: Skill not found in skillsData.skills');
            }
        }

        // ===== PROFESSIONAL RESUME GENERATOR =====
        // Produces a clean, ATS-readable HTML resume styled for print-to-PDF.
        // Pulls real data: executiveSummary, skill evidence outcomes, values, purpose, market value.

        function generateResume() {
            try {
                const data = gatherResumeData();
                const html = buildResumeHTML(data);
                const filename = `resume-${(data.name || 'profile').replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.html`;
                downloadBlueprint(html, filename);
            } catch (err) {
                console.error('Resume generation error:', err);
                showToast('Error generating resume. See console for details.', 'error');
            }
        }

        function gatherResumeData() {
            const skills = skillsData.skills || userData.skills || [];
            const profile = userData.profile || {};
            const compensation = calculateTotalMarketValue();

            // --- Achievements: pull evidence items that have real outcomes ---
            const allEvidence = [];
            skills.forEach(skill => {
                (skill.evidence || []).forEach(ev => {
                    const text = (ev.outcome || '') + ' ' + (ev.description || '');
                    let score = 0;
                    if (/\$[\d,]+[MBK]?/i.test(text)) score += 5;
                    if (/\d+%/.test(text)) score += 4;
                    if (/\d+x|\d+ times/i.test(text)) score += 3;
                    if (/\d+ (months?|years?|days?)/i.test(text)) score += 2;
                    if (/million|billion/i.test(text)) score += 5;
                    if (/zero|perfect|first|award|recogni/i.test(text)) score += 2;
                    if (skill.level === 'Mastery') score += 3;
                    else if (skill.level === 'Expert') score += 2;
                    else if (skill.level === 'Advanced') score += 1;
                    if (skill.key) score += 2;
                    allEvidence.push({
                        skill: skill.name,
                        level: skill.level,
                        category: skill.category,
                        roles: skill.roles || [],
                        description: ev.description || '',
                        outcome: ev.outcome || '',
                        score
                    });
                });
            });
            allEvidence.sort((a, b) => b.score - a.score);
            const topAchievements = allEvidence.slice(0, 10);

            // --- Core competencies: key + mastery skills, deduplicated by category ---
            const keySkills = skills.filter(s => s.key || s.level === 'Mastery' || s.level === 'Expert');
            const compSet = [];
            const seen = new Set();
            keySkills.forEach(s => { if (!seen.has(s.name) && compSet.length < 18) { compSet.push(s); seen.add(s.name); } });
            skills.filter(s => s.level === 'Advanced' && !seen.has(s.name))
                  .slice(0, 18 - compSet.length)
                  .forEach(s => { compSet.push(s); seen.add(s.name); });

            // --- Role groupings for skills section ---
            const roleGroups = {};
            (userData.roles || skillsData.roles || []).forEach(role => {
                const roleSkills = skills.filter(s => (s.roles || []).includes(role.id));
                if (roleSkills.length > 0) roleGroups[role.name] = roleSkills;
            });

            // --- Values (selected only) ---
            const selectedValues = (userData.values || [])
                .filter(v => v.selected !== false)
                .map(v => v.name || v);

            // --- Work History ---
            const workHistory = (userData.workHistory || []).map(job => ({
                ...job,
                achievements: job.achievements || []
            }));

            // --- Education ---
            const education = userData.education || [];

            // --- Certifications ---
            const certifications = userData.certifications || [];

            return {
                name: profile.name || 'Your Name',
                title: profile.currentTitle || 'Professional',
                company: profile.currentCompany || '',
                location: profile.location || '',
                email: profile.email || '',
                phone: profile.phone || '',
                linkedinUrl: profile.linkedinUrl || '',
                yearsExperience: profile.yearsExperience || '',
                executiveSummary: profile.executiveSummary || userData.purpose || '',
                purpose: userData.purpose || '',
                topAchievements,
                competencies: compSet,
                roleGroups,
                values: selectedValues,
                workHistory,
                education,
                certifications,
                compensation,
                generatedDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                totalSkills: skills.length,
                masteryCount: skills.filter(s => s.level === 'Mastery').length,
                expertCount: skills.filter(s => s.level === 'Expert').length
            };
        }

        function buildResumeHTML(d) {
            const name = d.name;
            const title = d.title;
            const location = d.location ? d.location.split(',').slice(-2).join(',').trim() : '';
            const comp = d.compensation;
            const salaryRange = comp && comp.standardOffer
                ? `$${Math.round(comp.conservativeOffer / 1000)}K – $${Math.round(comp.competitiveOffer / 1000)}K`
                : '';

            // Achievement bullets
            const achievementHTML = d.topAchievements.map(item => {
                const outcome = item.outcome.trim().replace(/\.$/, '');
                const desc = item.description.trim().replace(/\.$/, '');
                const shortDesc = desc.length > 120 ? desc.slice(0, 117) + '…' : desc;
                return `<li><span class="ach-outcome">${outcome}.</span> <span class="ach-context">${shortDesc}.</span></li>`;
            }).join('\n');

            // Competencies grid
            const compHTML = d.competencies.map(s => {
                const levelDot = s.level === 'Mastery' ? '●●●' : s.level === 'Expert' ? '●●○' : s.level === 'Advanced' ? '●○○' : '○○○';
                return `<div class="comp-item"><span class="comp-name">${s.name}</span><span class="comp-dots">${levelDot}</span></div>`;
            }).join('\n');

            // Values
            const valuesHTML = d.values.length
                ? d.values.map(v => `<span class="value-tag">${v}</span>`).join('')
                : '';

            // Contact items
            const contactParts = [];
            if (d.email) contactParts.push(`<div class="contact-item">${d.email}</div>`);
            if (d.phone) contactParts.push(`<div class="contact-item">${d.phone}</div>`);
            if (location) contactParts.push(`<div class="contact-item">${location}</div>`);
            if (d.linkedinUrl) {
                const shortLi = d.linkedinUrl.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, '');
                contactParts.push(`<div class="contact-item"><a href="${d.linkedinUrl}" style="color:var(--ink-2); text-decoration:none;">${shortLi}</a></div>`);
            }
            if (d.yearsExperience) contactParts.push(`<div class="contact-item">${d.yearsExperience}+ Years Experience</div>`);
            const contactHTML = contactParts.join('<div class="contact-sep">·</div>');

            // Work History
            const workHistoryHTML = (d.workHistory || []).map(job => {
                const dateRange = (job.startDate || '') + ' – ' + (job.current ? 'Present' : (job.endDate || ''));
                const achList = (job.achievements || []).map(a => 
                    `<li>${a}</li>`
                ).join('\n');
                
                return `
                <div class="experience-block">
                    <div class="exp-header">
                        <div class="exp-title">${job.title || ''}</div>
                        <div class="exp-dates">${dateRange}</div>
                    </div>
                    <div class="exp-company">${job.company || ''}${job.location ? ' · ' + job.location : ''}</div>
                    ${job.description ? `<p class="exp-desc">${job.description}</p>` : ''}
                    ${achList ? `<ul class="exp-achievements">${achList}</ul>` : ''}
                </div>`;
            }).join('\n');

            // Education
            const educationHTML = (d.education || []).map(ed => {
                return `<div class="edu-item">
                    <div style="display:flex; justify-content:space-between; align-items:baseline;">
                        <div><strong>${ed.degree || ''}${ed.field ? ' in ' + ed.field : ''}</strong></div>
                        <div class="exp-dates">${ed.year || ''}</div>
                    </div>
                    <div style="color:var(--ink-2);">${ed.school || ''}</div>
                </div>`;
            }).join('\n');

            // Certifications
            const certHTML = (d.certifications || []).map(c => {
                return `<span class="cert-tag">${c.name}${c.issuer ? ' (' + c.issuer + ')' : ''}${c.year ? ' · ' + c.year : ''}</span>`;
            }).join('');

            // Salary target line
            const salaryLine = salaryRange
                ? `<div class="contact-item">Target: ${salaryRange}</div>`
                : '';

            // Determine if we have structured work history or need fallback
            const hasWorkHistory = d.workHistory && d.workHistory.length > 0;
            const hasEducation = d.education && d.education.length > 0;
            const hasCerts = d.certifications && d.certifications.length > 0;

            return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resume — ${name}</title>
<style>
/* =====================================================
   BLUEPRINT RESUME v2 — Professional Print-Ready
   ATS-optimized structure + clean human presentation
   Print: File → Print → Save as PDF
   ===================================================== */

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --ink:       #111827;
  --ink-2:     #374151;
  --ink-3:     #6b7280;
  --rule:      #d1d5db;
  --accent:    #1d4ed8;
  --accent-lt: #eff6ff;
  --pg-w:      8.5in;
  --pg-pad:    0.65in;
}

html { font-size: 11pt; }

body {
  font-family: 'Georgia', 'Times New Roman', serif;
  color: var(--ink);
  background: #f3f4f6;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}

.page {
  width: var(--pg-w);
  min-height: 11in;
  margin: 0.4in auto;
  padding: var(--pg-pad);
  background: #fff;
  box-shadow: 0 4px 24px rgba(0,0,0,0.12);
}

/* ---- HEADER ---- */
.resume-header {
  border-bottom: 2.5pt solid var(--accent);
  padding-bottom: 14pt;
  margin-bottom: 18pt;
}

.resume-name {
  font-family: 'Arial', 'Helvetica Neue', sans-serif;
  font-size: 26pt;
  font-weight: 700;
  color: var(--ink);
  letter-spacing: -0.5pt;
  line-height: 1;
  margin-bottom: 4pt;
}

.resume-title {
  font-family: 'Arial', sans-serif;
  font-size: 12pt;
  font-weight: 400;
  color: var(--accent);
  letter-spacing: 0.3pt;
  margin-bottom: 10pt;
}

.contact-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6pt 18pt;
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--ink-2);
}

.contact-item { display: flex; align-items: center; gap: 4pt; }
.contact-item a { color: var(--ink-2); text-decoration: none; }
.contact-sep { color: var(--rule); }

/* ---- SECTION STRUCTURE ---- */
.section { margin-bottom: 18pt; }

.section-label {
  font-family: 'Arial', sans-serif;
  font-size: 8.5pt;
  font-weight: 700;
  letter-spacing: 1.5pt;
  text-transform: uppercase;
  color: var(--accent);
  border-bottom: 1pt solid var(--rule);
  padding-bottom: 3pt;
  margin-bottom: 10pt;
}

/* ---- SUMMARY ---- */
.summary-text {
  font-size: 10.5pt;
  line-height: 1.65;
  color: var(--ink-2);
  max-width: 100%;
}

/* ---- ACHIEVEMENTS ---- */
.achievements-list {
  list-style: none;
  padding: 0;
}

.achievements-list li {
  font-size: 10pt;
  line-height: 1.6;
  padding: 5pt 0 5pt 14pt;
  border-bottom: 0.5pt solid #f0f0f0;
  position: relative;
}

.achievements-list li::before {
  content: '▸';
  position: absolute;
  left: 0;
  color: var(--accent);
  font-size: 9pt;
  top: 6pt;
}

.achievements-list li:last-child { border-bottom: none; }
.ach-outcome { font-weight: 600; color: var(--ink); }
.ach-context { color: var(--ink-2); }

/* ---- COMPETENCIES GRID ---- */
.comp-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 5pt 16pt;
}

.comp-item {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  font-size: 9.5pt;
  padding: 3pt 0;
  border-bottom: 0.5pt solid #f5f5f5;
}

.comp-name { color: var(--ink-2); }

.comp-dots {
  font-size: 7pt;
  color: var(--accent);
  letter-spacing: 2pt;
  flex-shrink: 0;
  margin-left: 6pt;
}

/* ---- EXPERIENCE ---- */
.experience-block { margin-bottom: 14pt; }

.exp-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 2pt;
}

.exp-title {
  font-family: 'Arial', sans-serif;
  font-size: 11pt;
  font-weight: 600;
  color: var(--ink);
}

.exp-dates {
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--ink-3);
}

.exp-company {
  font-family: 'Arial', sans-serif;
  font-size: 10pt;
  color: var(--ink-2);
  margin-bottom: 4pt;
}

.exp-desc {
  font-size: 9.5pt;
  line-height: 1.55;
  color: var(--ink-2);
  margin-bottom: 6pt;
}

.exp-achievements {
  list-style: none;
  padding: 0;
  margin: 0;
}

.exp-achievements li {
  font-size: 9.5pt;
  line-height: 1.55;
  padding: 2pt 0 2pt 14pt;
  color: var(--ink-2);
  position: relative;
}

.exp-achievements li::before {
  content: '▸';
  position: absolute;
  left: 0;
  color: var(--accent);
  font-size: 8.5pt;
  top: 3pt;
}

/* ---- EDUCATION ---- */
.edu-item {
  margin-bottom: 8pt;
  font-size: 10pt;
}

.edu-item strong {
  color: var(--ink);
  font-family: 'Arial', sans-serif;
}

/* ---- CERTIFICATIONS ---- */
.cert-tag {
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--ink-2);
  background: #f9fafb;
  padding: 2pt 8pt;
  border-radius: 2pt;
  border: 0.5pt solid #e5e7eb;
  display: inline-block;
  margin: 0 6pt 4pt 0;
}

/* ---- VALUES ---- */
.values-row { display: flex; flex-wrap: wrap; gap: 6pt; }

.value-tag {
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--accent);
  background: var(--accent-lt);
  padding: 2pt 8pt;
  border-radius: 2pt;
  border: 0.5pt solid #bfdbfe;
}

/* ---- FOOTER ---- */
.resume-footer {
  margin-top: 24pt;
  padding-top: 8pt;
  border-top: 0.5pt solid var(--rule);
  font-family: 'Arial', sans-serif;
  font-size: 8pt;
  color: var(--ink-3);
  display: flex;
  justify-content: space-between;
}

.legend {
  font-family: 'Arial', sans-serif;
  font-size: 8pt;
  color: var(--ink-3);
  margin-top: 6pt;
}

/* ---- PRINT ---- */
@media print {
  body { background: white; }
  .page {
    width: 100%;
    margin: 0;
    padding: 0.55in 0.65in;
    box-shadow: none;
    min-height: auto;
  }
  .section { page-break-inside: avoid; }
  .experience-block { page-break-inside: avoid; }
  .no-print { display: none !important; }
}

.print-bar {
  width: var(--pg-w);
  margin: 0 auto 10pt;
  display: flex;
  justify-content: flex-end;
  gap: 10pt;
}

.btn-print {
  font-family: 'Arial', sans-serif;
  font-size: 10pt;
  font-weight: 600;
  color: #fff;
  background: var(--accent);
  border: none;
  padding: 8pt 20pt;
  border-radius: 4pt;
  cursor: pointer;
  letter-spacing: 0.3pt;
}

.btn-print:hover { background: #1e40af; }
@media print { .print-bar { display: none; } }
</style>
</head>
<body>

<div class="print-bar no-print">
  <button class="btn-print" onclick="window.print()">⬇ Save as PDF</button>
</div>

<div class="page">

  <!-- HEADER -->
  <header class="resume-header">
    <div class="resume-name">${name}</div>
    <div class="resume-title">${title}</div>
    <div class="contact-row">
      ${contactHTML}
      ${salaryLine}
    </div>
  </header>

  <!-- PROFESSIONAL SUMMARY -->
  ${d.executiveSummary ? `
  <section class="section">
    <div class="section-label">Professional Summary</div>
    <p class="summary-text">${d.executiveSummary}</p>
  </section>` : ''}

  <!-- CORE COMPETENCIES -->
  ${d.competencies.length > 0 ? `
  <section class="section">
    <div class="section-label">Core Competencies</div>
    <div class="comp-grid">
      ${compHTML}
    </div>
    <div class="legend" style="margin-top:8pt;">Proficiency: ●●● Mastery &nbsp;·&nbsp; ●●○ Expert &nbsp;·&nbsp; ●○○ Advanced</div>
  </section>` : ''}

  <!-- PROFESSIONAL EXPERIENCE -->
  ${hasWorkHistory ? `
  <section class="section">
    <div class="section-label">Professional Experience</div>
    ${workHistoryHTML}
  </section>` : `
  <section class="section">
    <div class="section-label">Professional Experience</div>
    <div class="experience-block">
      <div class="exp-header">
        <div class="exp-title">${title}</div>
        <div class="exp-dates">Present${d.yearsExperience ? ' · ' + d.yearsExperience + '+ years' : ''}</div>
      </div>
      <div class="exp-company">${d.company}${location ? ' · ' + location : ''}</div>
    </div>
    ${d.purpose ? '<p class="summary-text" style="font-size:9.5pt; color: #4b5563;">' + d.purpose + '</p>' : ''}
  </section>`}

  <!-- SELECTED ACHIEVEMENTS -->
  ${d.topAchievements.length > 0 && !hasWorkHistory ? `
  <section class="section">
    <div class="section-label">Selected Achievements</div>
    <ul class="achievements-list">
      ${achievementHTML}
    </ul>
  </section>` : ''}

  <!-- EDUCATION -->
  ${hasEducation ? `
  <section class="section">
    <div class="section-label">Education</div>
    ${educationHTML}
  </section>` : ''}

  <!-- CERTIFICATIONS -->
  ${hasCerts ? `
  <section class="section">
    <div class="section-label">Certifications &amp; Licenses</div>
    <div style="display:flex; flex-wrap:wrap; gap:4pt;">
      ${certHTML}
    </div>
  </section>` : ''}

  <!-- VALUES -->
  ${valuesHTML ? `
  <section class="section">
    <div class="section-label">Core Values &amp; Leadership Principles</div>
    <div class="values-row">${valuesHTML}</div>
  </section>` : ''}

  <!-- FOOTER -->
  <footer class="resume-footer">
    <span>Generated by Blueprint&trade; · ${d.generatedDate} · &copy; ${new Date().getFullYear()} Cliff Jurkiewicz · myblueprint.work</span>
    <span>${d.totalSkills} documented skills · ${d.masteryCount + d.expertCount} at Mastery/Expert level</span>
  </footer>

</div><!-- /page -->
</body>
</html>`;
        }
        // ===== END RESUME GENERATOR =====

        // Resize handler
        
        // ===== WORK BLUEPRINT SYSTEM =====
        
        let blueprintData = {
            outcomes: [],
            values: [],
            purpose: "",
            shareSettings: {}
        };
        
        function initBlueprint() {
            extractOutcomesFromEvidence();
            inferValues();
            renderBlueprint();
        }
        
        function extractOutcomesFromEvidence() {
            const outcomes = [];

            // Evidence now lives in userData.skills[].evidence as {description, outcome} objects.
            // We pull from there first, then fall back to the legacy skillDetails strings.
            const skills = userData.skills || skillsData.skills || [];

            skills.forEach(skill => {
                (skill.evidence || []).forEach(ev => {
                    // ev is {description, outcome} — use the outcome field for display
                    const outcomeText = (ev.outcome || '').trim();
                    const descText   = (ev.description || '').trim();
                    if (!outcomeText && !descText) return;

                    // Score the outcome — anything with a real metric qualifies
                    const combined = outcomeText + ' ' + descText;
                    const hasMetric = /\$[\d,]+[MBK]?|\d+%|\d+x|\d+ times|million|billion/i.test(combined);
                    const hasResult = /retained|increased|reduced|improved|delivered|generated|achieved|enabled|saved|prevented|launched|built|founded|established/i.test(combined);

                    if (hasMetric || hasResult) {
                        // Build a combined display text: outcome is the headline, description adds context
                        const displayText = outcomeText
                            ? (descText ? `${outcomeText} (${descText.slice(0, 100)}${descText.length > 100 ? '…' : ''})` : outcomeText)
                            : descText;

                        outcomes.push({
                            text: displayText,
                            outcome: outcomeText,
                            description: descText,
                            skill: skill.name,
                            level: skill.level,
                            category: categorizeOutcome(skill.name, combined),
                            shared: !isSensitiveContent(combined), // sensitive items default to unshared
                            sensitive: isSensitiveContent(combined),
                            coachingSuggestion: generateCoachingFor(outcomeText || descText)
                        });
                    }
                });
            });

            // Also check legacy skillDetails (skill_evidence.json strings) — only if no skill-based outcomes found
            if (outcomes.length === 0) {
                const quantifiedPattern = /\$[\d,]+[MBK]?|\d+%|\d+ years?/gi;
                Object.entries(skillsData.skillDetails || {}).forEach(([skillName, details]) => {
                    if (!details.evidence) return;
                    details.evidence.forEach(evidenceItem => {
                        if (typeof evidenceItem !== 'string') return;
                        const hasQuantity = quantifiedPattern.test(evidenceItem);
                        if (hasQuantity) {
                            outcomes.push({
                                text: evidenceItem,
                                skill: skillName,
                                category: categorizeOutcome(skillName, evidenceItem),
                                shared: true,
                                sensitive: isSensitiveContent(evidenceItem),
                                coachingSuggestion: generateCoachingFor(evidenceItem)
                            });
                        }
                    });
                });
            }

            // Sort: unshared (sensitive) last, then by metric strength
            outcomes.sort((a, b) => {
                if (a.sensitive && !b.sensitive) return 1;
                if (!a.sensitive && b.sensitive) return -1;
                const scoreA = /\$[\d,]+[MBK]?/i.test(a.outcome||a.text) ? 2 : /\d+%/i.test(a.outcome||a.text) ? 1 : 0;
                const scoreB = /\$[\d,]+[MBK]?/i.test(b.outcome||b.text) ? 2 : /\d+%/i.test(b.outcome||b.text) ? 1 : 0;
                return scoreB - scoreA;
            });

            blueprintData.outcomes = outcomes;
        }
        
        function categorizeOutcome(skillName, evidence) {
            if (evidence.includes('$') || evidence.includes('revenue') || evidence.includes('sales')) return 'Business Impact';
            if (evidence.includes('predict') || evidence.includes('accuracy') || evidence.includes('%')) return 'Strategic Foresight';
            if (evidence.includes('emergency') || evidence.includes('crisis') || evidence.includes('zero')) return 'Crisis Leadership';
            if (evidence.includes('founded') || evidence.includes('built') || evidence.includes('created')) return 'Entrepreneurial';
            if (evidence.includes('published') || evidence.includes('speaker') || evidence.includes('featured')) return 'Thought Leadership';
            if (evidence.includes('recovery') || evidence.includes('sobriety') || evidence.includes('advocacy')) return 'Advocacy Impact';
            return 'Professional Achievement';
        }
        
        function isSensitiveContent(text) {
            const sensitiveKeywords = ['recovery', 'sobriety', 'addiction', 'Kyle', 'son', 'death', 'overdose', 'mental health'];
            return sensitiveKeywords.some(keyword => text.toLowerCase().includes(keyword));
        }
        
        function generateCoachingFor(outcome) {
            if (!outcome.includes('$') && !outcome.includes('%')) {
                return "Consider adding quantification: What was the measurable impact?";
            }
            if (!outcome.includes('client') && !outcome.includes('company') && !outcome.includes('people')) {
                return "Strengthen by adding: Who benefited from this outcome?";
            }
            if (outcome.length < 50) {
                return "Add context: What decision did this enable or what changed as a result?";
            }
            return null;
        }
        
        // ===== VALUES SYSTEM =====
        var VALUES_CATALOG = [
            { group: 'How I Think', values: [
                { name: 'Intellectual Honesty', keywords: ['integrity', 'honest', 'evidence', 'data', 'analy', 'research', 'rigor'], description: 'Following evidence wherever it leads, even when it challenges your own position.' },
                { name: 'Strategic Thinking', keywords: ['strateg', 'vision', 'foresight', 'roadmap', 'long-term', 'planning', 'framework'], description: 'Connecting present decisions to long-term outcomes others have not yet considered.' },
                { name: 'Curiosity', keywords: ['learn', 'curiosit', 'explor', 'research', 'discover', 'question', 'experiment'], description: 'Pursuing understanding for its own sake, not just when the job requires it.' },
                { name: 'Evidence-Based Decision Making', keywords: ['evidence', 'data', 'measur', 'metric', 'analy', 'research', 'validated'], description: 'Letting data settle debates that opinions cannot.' },
                { name: 'Systems Thinking', keywords: ['system', 'architect', 'integrat', 'complex', 'interdepend', 'holistic', 'scale'], description: 'Seeing how components interact across an entire system, not just the part in front of you.' }
            ]},
            { group: 'How I Lead', values: [
                { name: 'Accountability', keywords: ['account', 'responsib', 'own', 'deliver', 'commit', 'reliable', 'dependab'], description: 'Owning outcomes, not just tasks. Especially the ones that went wrong.' },
                { name: 'Servant Leadership', keywords: ['servant', 'mentor', 'coach', 'develop', 'empower', 'support', 'grow'], description: 'Measuring your success by the growth and readiness of the people around you.' },
                { name: 'Empowerment', keywords: ['empower', 'delegat', 'trust', 'autonom', 'enable', 'develop', 'grow'], description: 'Giving people the authority and resources to act, then getting out of their way.' },
                { name: 'Transparency', keywords: ['transparen', 'open', 'honest', 'candid', 'communicat', 'visible', 'share'], description: 'Sharing context freely so others can make informed decisions without you.' },
                { name: 'Courage', keywords: ['courag', 'bold', 'risk', 'challeng', 'spoke', 'stand', 'confront', 'difficult'], description: 'Saying the hard thing in the room when staying silent would be easier.' }
            ]},
            { group: 'How I Work', values: [
                { name: 'Excellence', keywords: ['excel', 'quality', 'precision', 'standard', 'best', 'outperform', 'world-class'], description: 'Setting a standard that makes good enough feel insufficient.' },
                { name: 'Resourcefulness', keywords: ['resourceful', 'creative', 'scrappy', 'bootstrap', 'efficien', 'lean', 'solve'], description: 'Finding a path forward when the obvious one is blocked.' },
                { name: 'Bias Toward Action', keywords: ['action', 'launch', 'ship', 'built', 'execut', 'deliver', 'implement', 'deploy'], description: 'Shipping something real rather than perfecting something theoretical.' },
                { name: 'Continuous Improvement', keywords: ['improv', 'optimi', 'iterat', 'refine', 'evolv', 'better', 'enhance'], description: 'Treating every process as a draft that can be rewritten.' },
                { name: 'Craftsmanship', keywords: ['craft', 'precision', 'detail', 'quality', 'artis', 'master', 'skill', 'technique'], description: 'Caring about the quality of work even when nobody is watching.' }
            ]},
            { group: 'How I Connect', values: [
                { name: 'Empathy', keywords: ['empathy', 'empathetic', 'understand', 'compassion', 'listen', 'perspective', 'human'], description: 'Understanding what someone needs before they have to explain it twice.' },
                { name: 'Collaboration', keywords: ['collaborat', 'partner', 'cross-functional', 'stakeholder', 'team', 'together', 'align'], description: 'Building shared ownership across boundaries that usually divide teams.' },
                { name: 'Trust', keywords: ['trust', 'reliab', 'credib', 'consistent', 'depend', 'faith', 'relationship'], description: 'Being the person others confide in because your word has always held.' },
                { name: 'Candor', keywords: ['candor', 'candid', 'direct', 'honest', 'feedback', 'frank', 'straightforward'], description: 'Delivering honest feedback as a form of respect, not confrontation.' },
                { name: 'Inclusion', keywords: ['inclusi', 'divers', 'equit', 'belong', 'access', 'representation', 'voice'], description: 'Making sure the quietest voice in the room is heard, not just the loudest.' }
            ]},
            { group: 'What I Protect', values: [
                { name: 'Integrity', keywords: ['integrity', 'ethical', 'principle', 'moral', 'honest', 'right', 'trust'], description: 'Doing the right thing when there is a personal cost to doing so.' },
                { name: 'Resilience', keywords: ['resilien', 'crisis', 'recover', 'adapt', 'persever', 'overcome', 'surviv', 'endur'], description: 'Converting setbacks into capabilities that did not exist before.' },
                { name: 'Authenticity', keywords: ['authentic', 'genuine', 'vulnerab', 'self-aware', 'real', 'true', 'honest'], description: 'Presenting yourself as you are, not as the audience expects.' },
                { name: 'Work-Life Boundaries', keywords: ['balance', 'boundar', 'sustain', 'wellbeing', 'health', 'burnout', 'life'], description: 'Protecting the conditions that let you sustain high performance over years, not weeks.' },
                { name: 'Purpose Over Profit', keywords: ['purpose', 'mission', 'impact', 'meaning', 'community', 'service', 'cause', 'foundation'], description: 'Choosing work that matters to people, not just to a balance sheet.' }
            ]}
        ];

        function saveValues() {
            try {
                safeSet('wbValues', JSON.stringify(blueprintData.values));
                safeSet('wbPurpose', blueprintData.purpose || '');
            } catch (e) { /* quota exceeded or private mode */ }
        }

        function loadSavedValues() {
            try {
                var stored = safeGet('wbValues');
                if (stored) return JSON.parse(stored);
            } catch (e) { /* parse error */ }
            return null;
        }

        function getEvidenceForValue(valueName) {
            var keywords = getKeywordsForValue(valueName);
            if (!keywords || keywords.length === 0) return [];
            var matches = [];
            var skills = (skillsData && skillsData.skills) || [];
            skills.forEach(function(skill) {
                (skill.evidence || []).forEach(function(ev) {
                    var text = ((ev.outcome || '') + ' ' + (ev.description || '')).toLowerCase();
                    var matched = keywords.some(function(kw) { return text.indexOf(kw) !== -1; });
                    if (matched) {
                        matches.push({ skill: skill.name, text: ev.outcome || ev.description || '' });
                    }
                });
            });
            return matches.slice(0, 3);
        }

        function getKeywordsForValue(name) {
            var n = name.toLowerCase();
            for (var g = 0; g < VALUES_CATALOG.length; g++) {
                for (var v = 0; v < VALUES_CATALOG[g].values.length; v++) {
                    if (VALUES_CATALOG[g].values[v].name.toLowerCase() === n) {
                        return VALUES_CATALOG[g].values[v].keywords;
                    }
                }
            }
            // Custom value: split name into keyword stems
            var result = [];
            n.split(/[\s\-]+/).forEach(function(w) {
                if (w.length > 3) result.push(w.substring(0, 6));
            });
            return result;
        }

        function scoreValueByEvidence(valueDef) {
            var skills = (skillsData && skillsData.skills) || [];
            var score = 0;
            skills.forEach(function(skill) {
                (skill.evidence || []).forEach(function(ev) {
                    var text = ((ev.outcome || '') + ' ' + (ev.description || '')).toLowerCase();
                    valueDef.keywords.forEach(function(kw) {
                        if (text.indexOf(kw) !== -1) score++;
                    });
                });
            });
            return score;
        }
        
        function getCatalogDescription(name) {
            var n = name.toLowerCase();
            for (var g = 0; g < VALUES_CATALOG.length; g++) {
                for (var v = 0; v < VALUES_CATALOG[g].values.length; v++) {
                    if (VALUES_CATALOG[g].values[v].name.toLowerCase() === n) {
                        return VALUES_CATALOG[g].values[v].description || '';
                    }
                }
            }
            return '';
        }
        
        function editValueNote(idx) {
            var value = blueprintData.values[idx];
            var currentNote = value.note || '';
            var modal = document.getElementById('exportModal');
            var modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Personal Note: ' + value.name + '</h2>'
                + '<p style="color:' + tv('#9ca3af','#64748b') + '; margin-top:5px;">Why does this value matter to you?</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<textarea id="valueNoteInput" placeholder="e.g., This shaped how I lead after watching top-down decisions fail repeatedly..." style="'
                + 'width:100%; min-height:100px; padding:14px; background:' + tv('rgba(255,255,255,0.05)','#fff') + '; '
                + 'border:1px solid ' + tv('rgba(96,165,250,0.3)','#d1d5db') + '; border-radius:8px; '
                + 'color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.95em; line-height:1.6; font-family:inherit; resize:vertical;'
                + '">' + currentNote + '</textarea>'
                + '<div style="margin-top:8px; font-size:0.78em; color:' + tv('#6b7280','#9ca3af') + ';">'
                + 'This note appears on your value card and in exported blueprints. Keep it concise.</div>'
                + '<div style="display:flex; gap:12px; justify-content:flex-end; margin-top:18px;">'
                + '<button onclick="closeExportModal()" style="'
                + 'background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.15)','#d1d5db') + '; '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">Cancel</button>'
                + '<button onclick="saveValueNote(' + idx + ')" style="'
                + 'background:' + tv('#1e40af','#2563eb') + '; color:#fff; border:none; '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + bpIcon('save',14) + ' Save Note</button>'
                + '</div></div>';
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            setTimeout(function() { document.getElementById('valueNoteInput').focus(); }, 100);
        }
        window.editValueNote = editValueNote;
        
        function saveValueNote(idx) {
            var noteEl = document.getElementById('valueNoteInput');
            if (!noteEl) return;
            blueprintData.values[idx].note = noteEl.value.trim();
            saveUserData();
            saveValues();
            closeExportModal();
            var contentEl = document.getElementById('blueprintTabContent');
            if (contentEl) contentEl.innerHTML = renderBlueprintTabContent();
        }
        window.saveValueNote = saveValueNote;

        function inferValues() {
            // STEP 1: Check localStorage for saved edits
            var saved = loadSavedValues();
            if (saved && saved.length > 0) {
                blueprintData.values = saved;
            } else {
                // STEP 2: Use profile values if they exist
                var profileValues = userData.values || [];
                if (profileValues.length > 0) {
                    blueprintData.values = profileValues.map(function(v) {
                        return {
                            name: v.name,
                            selected: v.selected !== undefined ? v.selected : true,
                            inferred: v.inferred || false,
                            custom: false
                        };
                    });
                } else {
                    // STEP 3: Auto-select top 5 by evidence score
                    var scored = [];
                    VALUES_CATALOG.forEach(function(group) {
                        group.values.forEach(function(val) {
                            scored.push({ name: val.name, score: scoreValueByEvidence(val) });
                        });
                    });
                    scored.sort(function(a, b) { return b.score - a.score; });
                    var topNames = scored.slice(0, 5).filter(function(s) { return s.score > 0; }).map(function(s) { return s.name; });
                    
                    // If no evidence at all, select sensible defaults
                    if (topNames.length === 0) {
                        topNames = ['Intellectual Honesty', 'Accountability', 'Excellence', 'Collaboration', 'Integrity'];
                    }
                    
                    blueprintData.values = topNames.map(function(n) {
                        return { name: n, selected: true, inferred: true, custom: false };
                    });
                }
            }
            
            // Purpose
            var savedPurpose = null;
            try { savedPurpose = safeGet('wbPurpose'); } catch(e) {}
            if (savedPurpose !== null && savedPurpose.trim().length > 0) {
                blueprintData.purpose = savedPurpose;
            } else if (userData.purpose && userData.purpose.trim().length > 0) {
                blueprintData.purpose = userData.purpose;
            } else {
                blueprintData.purpose = "";
            }
            
            // Enforce max 7 values
            if (blueprintData.values.length > 7) {
                blueprintData.values = blueprintData.values.slice(0, 7);
            }
        }

        var showingValuesPicker = false;
        
        let blueprintTab = 'dashboard';
        
        function renderBlueprint() {
            const view = document.getElementById('blueprintView');
            const outcomesCount = blueprintData.outcomes.length;
            const valuesCount = blueprintData.values.filter(v => v.selected).length;
            const skillCount = (skillsData.skills || []).length;
            
            view.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-subnav" id="blueprintSubnav" style="position:sticky; top:56px; z-index:20; background:var(--bg-base); padding:8px 0 4px; border-bottom:1px solid ${tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.06)')}; margin-bottom:12px;">
                        <button class="bp-tab ${blueprintTab === 'dashboard' ? 'active' : ''}" onclick="switchBlueprintTab('dashboard')">
                            <span class="bp-tab-icon">${bpIcon('blueprint',16)}</span>
                            <span class="bp-tab-label">Dashboard</span>
                        </button>
                        <button class="bp-tab ${blueprintTab === 'skills' ? 'active' : ''}" onclick="switchBlueprintTab('skills')">
                            <span class="bp-tab-icon">${bpIcon('skills',16)}</span>
                            <span class="bp-tab-label">Skills</span>
                            <span class="bp-tab-count">${skillCount}</span>
                        </button>
                        <button class="bp-tab ${blueprintTab === 'experience' ? 'active' : ''}" onclick="switchBlueprintTab('experience')">
                            <span class="bp-tab-icon">${bpIcon('experience',16)}</span>
                            <span class="bp-tab-label">Experience</span>
                        </button>
                        <button class="bp-tab ${blueprintTab === 'outcomes' ? 'active' : ''}" onclick="switchBlueprintTab('outcomes')">
                            <span class="bp-tab-icon">${bpIcon('outcomes',16)}</span>
                            <span class="bp-tab-label">Outcomes</span>
                            <span class="bp-tab-count">${outcomesCount}</span>
                        </button>
                        <button class="bp-tab ${blueprintTab === 'values' ? 'active' : ''}" onclick="switchBlueprintTab('values')">
                            <span class="bp-tab-icon">${bpIcon('values',16)}</span>
                            <span class="bp-tab-label">Values</span>
                            <span class="bp-tab-count">${valuesCount}</span>
                        </button>
                        <button class="bp-tab ${blueprintTab === 'export' ? 'active' : ''}" onclick="switchBlueprintTab('export')">
                            <span class="bp-tab-icon">${bpIcon('export',16)}</span>
                            <span class="bp-tab-label">Export</span>
                        </button>
                    </div>
                    
                    <div id="blueprintTabContent">
                        ${renderBlueprintTabContent()}
                    </div>
                </div>
            `;
        }
        
        function switchBlueprintTab(tab) {
            blueprintTab = tab;
            document.querySelectorAll('.bp-tab').forEach(function(btn) {
                var onclickStr = btn.getAttribute('onclick') || '';
                btn.classList.toggle('active', onclickStr.indexOf("'" + tab + "'") !== -1);
            });
            var contentEl = document.getElementById('blueprintTabContent');
            if (contentEl) {
                try {
                    contentEl.innerHTML = renderBlueprintTabContent();
                } catch(e) {
                    console.error('Blueprint tab render error (' + tab + '):', e);
                    contentEl.innerHTML = '<div style="padding:40px; text-align:center; color:#ef4444;">'
                        + '<div style="font-size:1.2em; margin-bottom:8px;">' + bpIcon('warning',18) + ' Rendering Error</div>'
                        + '<div style="font-size:0.85em; color:' + tv('#9ca3af','#64748b') + ';">' + (e.message || e) + '</div></div>';
                }
            }
        }
        window.switchBlueprintTab = switchBlueprintTab;
        
        function renderBlueprintTabContent() {
            if (blueprintTab === 'dashboard') return renderDashboardTab();
            if (blueprintTab === 'skills')    return renderSkillsManagementTab();
            if (blueprintTab === 'experience') return renderExperienceTab();
            if (blueprintTab === 'outcomes') return renderOutcomesSection();
            if (blueprintTab === 'values')   return renderValuesSection();
            if (blueprintTab === 'purpose')  return renderDashboardTab(); // redirect legacy
            if (blueprintTab === 'export')   return renderExportSection();
            return renderDashboardTab();
        }
        
        // Theme-aware color helper for inline styles
        function tv(darkVal, lightVal) {
            return document.documentElement.getAttribute('data-theme') === 'light' ? lightVal : darkVal;
        }
        // Theme-aware background helper
        function tb(darkBg, lightBg) {
            return document.documentElement.getAttribute('data-theme') === 'light' ? lightBg : darkBg;
        }

        function renderDashboardTab() {
            var skills = skillsData.skills || [];
            var roles = skillsData.roles || [];
            var outcomes = blueprintData.outcomes || [];
            var sharedOutcomes = outcomes.filter(function(o) { return o.shared; }).length;
            var values = (blueprintData.values || []).filter(function(v) { return v.selected; });
            var purpose = blueprintData.purpose || '';
            var totalValue = calculateTotalMarketValue();
            var hasValuation = totalValue && totalValue.total > 0 && skillValuations && Object.keys(skillValuations.skillBaseValues || {}).length > 0;
            // Calculate both modes for dual cards
            var evidenceValue = hasValuation ? calculateTotalMarketValue('evidence') : null;
            var potentialValue = hasValuation ? calculateTotalMarketValue('potential') : null;
            
            var masteryCount = skills.filter(function(s) { return s.level === 'Mastery'; }).length;
            var advancedCount = skills.filter(function(s) { return s.level === 'Advanced'; }).length;
            var savedJobs = (userData.savedJobs || []).filter(function(j) { return j && j.title; });
            var topMatch = savedJobs.length > 0 ? savedJobs.reduce(function(best, j) { return (j.matchData && j.matchData.score || 0) > (best.matchData && best.matchData.score || 0) ? j : best; }, savedJobs[0]) : null;
            var topMatchScore = topMatch && topMatch.matchData ? topMatch.matchData.score : 0;
            
            // Calculate readiness score early (used in multiple places)
            var completeness = [];
            if (skills.length > 0) completeness.push({ label: 'Skills mapped', done: true, action: "switchView('skills')" });
            else completeness.push({ label: 'Map your skills', done: false, action: "switchView('skills')" });
            if (outcomes.length > 0) completeness.push({ label: 'Outcomes documented', done: true, action: "switchBlueprintTab('outcomes')" });
            else completeness.push({ label: 'Add outcomes', done: false, action: "switchBlueprintTab('outcomes')" });
            if (values.length >= 3) completeness.push({ label: 'Values selected', done: true, action: "switchBlueprintTab('values')" });
            else completeness.push({ label: 'Select values (3\u20137)', done: false, action: "switchBlueprintTab('values')" });
            if (purpose && purpose.length > 10) completeness.push({ label: 'Purpose defined', done: true, action: '' });
            else completeness.push({ label: 'Write purpose statement', done: false, action: '' });
            if (savedJobs.length > 0) completeness.push({ label: 'Jobs tracked', done: true, action: "switchView('jobs')" });
            else completeness.push({ label: 'Add target jobs', done: false, action: "switchView('jobs')" });
            var doneCount = completeness.filter(function(c) { return c.done; }).length;
            var readinessPct = Math.round((doneCount / completeness.length) * 100);
            
            var html = '';
            
            // ── STAT CARDS ROW ──
            html += '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:20px;">';
            
            // Evidence-Based Value card
            if (hasValuation && evidenceValue) {
                var evActive = valuationMode === 'evidence';
                html += '<div style="background:' + (evActive ? tv('rgba(16,185,129,0.08)','rgba(16,185,129,0.05)') : tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)')) + '; border:' + (evActive ? '2px' : '1px') + ' solid ' + (evActive ? tv('rgba(16,185,129,0.35)','rgba(16,185,129,0.25)') : tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)')) + '; border-radius:12px; padding:18px; cursor:pointer;" onclick="setValuationMode(\'evidence\'); switchBlueprintTab(\'dashboard\');">'
                    + '<div style="display:flex; align-items:center; gap:5px; font-size:0.78em; color:' + tv('#9ca3af','#64748b') + '; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">'
                    + bpIcon('lock',11) + ' Evidence-Based</div>'
                    + '<div style="font-size:1.8em; font-weight:800; color:#10b981;">$' + evidenceValue.yourWorth.toLocaleString() + '</div>'
                    + '<div style="font-size:0.75em; color:' + tv('#6b7280','#9ca3af') + '; margin-top:4px;">' + evidenceValue.compaRatio + '% of median</div>'
                    + '</div>';
            }
            
            // Potential Value card
            if (hasValuation && potentialValue) {
                var potActive = valuationMode === 'potential';
                html += '<div style="background:' + (potActive ? tv('rgba(245,158,11,0.08)','rgba(245,158,11,0.05)') : tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)')) + '; border:' + (potActive ? '2px' : '1px') + ' solid ' + (potActive ? tv('rgba(245,158,11,0.35)','rgba(245,158,11,0.25)') : tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)')) + '; border-radius:12px; padding:18px; cursor:pointer;" onclick="setValuationMode(\'potential\'); switchBlueprintTab(\'dashboard\');">'
                    + '<div style="display:flex; align-items:center; gap:5px; font-size:0.78em; color:' + tv('#9ca3af','#64748b') + '; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">'
                    + bpIcon('star',11) + ' Potential</div>'
                    + '<div style="font-size:1.8em; font-weight:800; color:#f59e0b;">$' + potentialValue.yourWorth.toLocaleString() + '</div>'
                    + '<div style="font-size:0.75em; color:' + tv('#6b7280','#9ca3af') + '; margin-top:4px;">' + potentialValue.compaRatio + '% of median</div>'
                    + '</div>';
            }
            
            // Skills card
            html += '<div style="background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + '; border-radius:12px; padding:18px; cursor:pointer;" onclick="switchView(\'skills\')">'
                + '<div style="font-size:0.78em; color:' + tv('#9ca3af','#64748b') + '; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">Skills</div>'
                + '<div style="font-size:1.8em; font-weight:800; color:#60a5fa;">' + skills.length + '</div>'
                + '<div style="font-size:0.75em; color:' + tv('#6b7280','#9ca3af') + '; margin-top:4px;">' + roles.length + ' domains \u00B7 ' + (masteryCount + advancedCount) + ' expert+</div>'
                + '</div>';
            
            // Outcomes card
            html += '<div style="background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + '; border-radius:12px; padding:18px; cursor:pointer;" onclick="switchBlueprintTab(\'outcomes\')">'
                + '<div style="font-size:0.78em; color:' + tv('#9ca3af','#64748b') + '; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">Outcomes</div>'
                + '<div style="font-size:1.8em; font-weight:800; color:#f59e0b;">' + outcomes.length + '</div>'
                + '<div style="font-size:0.75em; color:' + tv('#6b7280','#9ca3af') + '; margin-top:4px;">' + sharedOutcomes + ' shared \u00B7 ' + (outcomes.length - sharedOutcomes) + ' private</div>'
                + '</div>';
            
            // Values card
            html += '<div style="background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + '; border-radius:12px; padding:18px; cursor:pointer;" onclick="switchBlueprintTab(\'values\')">'
                + '<div style="font-size:0.78em; color:' + tv('#9ca3af','#64748b') + '; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">Values</div>'
                + '<div style="font-size:1.8em; font-weight:800; color:#818cf8;">' + values.length + '</div>'
                + '<div style="font-size:0.75em; color:' + tv('#6b7280','#9ca3af') + '; margin-top:4px;">' + (values.length >= 3 ? '\u2713 Selected' : 'Pick 3\u20137') + '</div>'
                + '</div>';
            
            html += '</div>'; // end stats grid
            
            // ── CAREER READINESS SCORE ──
            (function() {
                var ringSize = 64;
                var strokeWidth = 5;
                var radius = (ringSize - strokeWidth) / 2;
                var circumference = 2 * Math.PI * radius;
                var offset = circumference - (readinessPct / 100) * circumference;
                var ringColor = readinessPct >= 100 ? '#10b981' : readinessPct >= 60 ? '#3b82f6' : '#f59e0b';
                var readinessLabel = readinessPct >= 100 ? 'Profile Complete' : readinessPct >= 80 ? 'Almost There' : readinessPct >= 60 ? 'Good Progress' : 'Getting Started';
                
                if (readinessPct < 100) {
                    html += '<div style="background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + '; border-radius:12px; padding:16px 18px; margin-bottom:16px; display:flex; align-items:center; gap:18px;">';
                    
                    // SVG score ring
                    html += '<div style="flex-shrink:0;">'
                        + '<svg width="' + ringSize + '" height="' + ringSize + '" viewBox="0 0 ' + ringSize + ' ' + ringSize + '" style="transform:rotate(-90deg);">'
                        + '<circle cx="' + (ringSize/2) + '" cy="' + (ringSize/2) + '" r="' + radius + '" fill="none" stroke="' + tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.06)') + '" stroke-width="' + strokeWidth + '"/>'
                        + '<circle cx="' + (ringSize/2) + '" cy="' + (ringSize/2) + '" r="' + radius + '" fill="none" stroke="' + ringColor + '" stroke-width="' + strokeWidth + '" stroke-linecap="round" stroke-dasharray="' + circumference + '" stroke-dashoffset="' + offset + '" style="transition:stroke-dashoffset 0.5s ease;"/>'
                        + '</svg>'
                        + '<div style="position:relative; top:-' + (ringSize * 0.72) + 'px; text-align:center; font-weight:800; font-size:0.95em; color:' + ringColor + '; line-height:1;">' + readinessPct + '%</div>'
                        + '</div>';
                    
                    // Label + incomplete items
                    html += '<div style="flex:1; min-width:0;">'
                        + '<div style="font-size:0.82em; font-weight:700; color:' + tv('#d1d5db','#1e293b') + '; margin-bottom:2px;">' + readinessLabel + '</div>'
                        + '<div style="font-size:0.75em; color:' + tv('#6b7280','#9ca3af') + '; margin-bottom:8px;">Complete all steps to unlock your full career intelligence profile.</div>'
                        + '<div style="display:flex; gap:6px; flex-wrap:wrap;">';
                    completeness.forEach(function(c) {
                        if (!c.done) {
                            html += '<button onclick="' + c.action + '" style="font-size:0.72em; padding:3px 10px; border-radius:12px; border:1px solid ' + tv('rgba(96,165,250,0.25)','rgba(37,99,235,0.2)') + '; background:' + tv('rgba(96,165,250,0.08)','rgba(37,99,235,0.05)') + '; color:#60a5fa; cursor:pointer; white-space:nowrap;">' + bpIcon('plus',10) + ' ' + c.label + '</button>';
                        }
                    });
                    html += '</div></div></div>';
                } else {
                    // Compact complete badge
                    html += '<div style="display:flex; align-items:center; gap:8px; padding:10px 16px; margin-bottom:16px; background:' + tv('rgba(16,185,129,0.06)','rgba(16,185,129,0.04)') + '; border:1px solid ' + tv('rgba(16,185,129,0.2)','rgba(16,185,129,0.12)') + '; border-radius:10px;">'
                        + '<span style="color:#10b981;">' + bpIcon('check',16) + '</span>'
                        + '<span style="font-size:0.82em; font-weight:600; color:#10b981;">Blueprint Complete</span>'
                        + '<span style="font-size:0.72em; color:' + tv('#6b7280','#9ca3af') + '; margin-left:auto;">' + skills.length + ' skills \u00B7 ' + outcomes.length + ' outcomes \u00B7 ' + values.length + ' values</span>'
                        + '</div>';
                }
            })();
            
            // ── SKILL DISTRIBUTION BAR ──
            if (skills.length > 0) {
                var profLevels = [
                    { key: 'Mastery', color: '#10b981', label: 'Mastery' },
                    { key: 'Advanced', color: '#3b82f6', label: 'Advanced' },
                    { key: 'Intermediate', color: '#8b5cf6', label: 'Intermediate' },
                    { key: 'Foundational', color: '#6b7280', label: 'Foundational' }
                ];
                var profCounts = {};
                profLevels.forEach(function(p) { profCounts[p.key] = 0; });
                skills.forEach(function(s) {
                    var lv = s.level || 'Foundational';
                    if (profCounts[lv] !== undefined) profCounts[lv]++;
                    else profCounts['Foundational']++;
                });
                var total = skills.length;
                
                html += '<div style="background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border:1px solid ' + tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.05)') + '; border-radius:10px; padding:14px 16px; margin-bottom:16px;">'
                    + '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">'
                    + '<div style="font-size:0.75em; font-weight:700; text-transform:uppercase; letter-spacing:0.08em; color:' + tv('#6b7280','#9ca3af') + ';">Skill Distribution</div>'
                    + '<div style="display:flex; align-items:center; gap:12px;">'
                    + '<span style="font-size:0.72em; color:' + tv('#6b7280','#9ca3af') + ';">' + roles.length + ' domains</span>'
                    + '<button onclick="switchBlueprintTab(\'skills\')" style="font-size:0.72em; color:#60a5fa; background:none; border:none; cursor:pointer; font-weight:600;">Manage Skills \u2192</button>'
                    + '</div></div>';
                
                // Stacked bar
                html += '<div style="display:flex; height:10px; border-radius:5px; overflow:hidden; background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.04)') + '; margin-bottom:10px;">';
                profLevels.forEach(function(p) {
                    var pct = total > 0 ? (profCounts[p.key] / total * 100) : 0;
                    if (pct > 0) {
                        html += '<div title="' + p.label + ': ' + profCounts[p.key] + '" style="width:' + pct + '%; background:' + p.color + '; transition:width 0.3s;"></div>';
                    }
                });
                html += '</div>';
                
                // Legend row
                html += '<div style="display:flex; gap:14px; flex-wrap:wrap;">';
                profLevels.forEach(function(p) {
                    if (profCounts[p.key] > 0) {
                        html += '<div style="display:flex; align-items:center; gap:5px; font-size:0.75em;">'
                            + '<div style="width:8px; height:8px; border-radius:2px; background:' + p.color + ';"></div>'
                            + '<span style="color:' + tv('#9ca3af','#64748b') + ';">' + p.label + '</span>'
                            + '<span style="font-weight:700; color:' + tv('#d1d5db','#334155') + ';">' + profCounts[p.key] + '</span>'
                            + '</div>';
                    }
                });
                html += '</div></div>';
            }
            
            // ── PURPOSE (inline, editable) ──
            html += '<div style="background:' + tv('rgba(96,165,250,0.06)','rgba(37,99,235,0.04)') + '; border:1px solid ' + tv('rgba(96,165,250,0.15)','rgba(37,99,235,0.1)') + '; border-radius:12px; padding:20px; margin-bottom:20px;">'
                + '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">'
                + '<div style="font-size:0.82em; font-weight:700; text-transform:uppercase; letter-spacing:0.08em; color:' + tv('#60a5fa','#2563eb') + '; display:flex; align-items:center; gap:6px;">'
                + bpIcon('purpose',14) + ' Purpose Statement</div>'
                + '<button onclick="var ta=document.getElementById(\'dashPurposeEdit\'); if(ta.readOnly){ta.readOnly=false; ta.focus(); ta.style.background=\'' + tv('rgba(0,0,0,0.2)','#fff') + '\'; this.textContent=\'Save\';} else {ta.readOnly=true; ta.style.background=\'transparent\'; updatePurpose(ta.value); this.textContent=\'Edit\';}" '
                + 'style="font-size:0.78em; padding:4px 12px; border-radius:6px; border:1px solid ' + tv('rgba(96,165,250,0.2)','rgba(37,99,235,0.15)') + '; background:transparent; color:#60a5fa; cursor:pointer;">'
                + 'Edit</button></div>'
                + '<textarea id="dashPurposeEdit" readonly onchange="updatePurpose(this.value)" style="'
                + 'width:100%; min-height:48px; background:transparent; border:none; color:' + tv('#d1d5db','#334155') + '; '
                + 'font-size:0.95em; line-height:1.6; resize:vertical; outline:none; font-style:italic;">'
                + (purpose || 'No purpose statement yet. Click Edit to add yours.')
                + '</textarea></div>';
            
            // ── QUICK ACTIONS ──
            html += '<div style="margin-bottom:20px;">'
                + '<div style="font-size:0.78em; font-weight:700; text-transform:uppercase; letter-spacing:0.08em; color:' + tv('#6b7280','#9ca3af') + '; margin-bottom:10px;">Quick Actions</div>'
                + '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:10px;">';
            
            // Manage Skills
            html += '<button onclick="switchBlueprintTab(\'skills\')" style="display:flex; align-items:center; gap:10px; padding:14px 16px; background:' + tv('rgba(16,185,129,0.08)','rgba(16,185,129,0.06)') + '; border:1px solid ' + tv('rgba(16,185,129,0.25)','rgba(16,185,129,0.15)') + '; border-radius:10px; cursor:pointer; text-align:left; width:100%;">'
                + '<span style="color:#10b981;">' + bpIcon('skills',18) + '</span>'
                + '<div><div style="font-weight:600; color:' + tv('#e0e0e0','#1e293b') + '; font-size:0.9em;">Manage Skills</div>'
                + '<div style="font-size:0.75em; color:' + tv('#9ca3af','#64748b') + ';">Add, edit, organize</div></div>'
                + '</button>';
            
            // Scouting Report
            html += '<button onclick="showScoutingReportPicker()" style="display:flex; align-items:center; gap:10px; padding:14px 16px; background:' + tv('rgba(96,165,250,0.08)','rgba(59,130,246,0.06)') + '; border:1px solid ' + tv('rgba(96,165,250,0.25)','rgba(59,130,246,0.15)') + '; border-radius:10px; cursor:pointer; text-align:left; width:100%;">'
                + '<span style="color:#60a5fa;">' + bpIcon('target',18) + '</span>'
                + '<div><div style="font-weight:600; color:' + tv('#e0e0e0','#1e293b') + '; font-size:0.9em;">\u25C8 Scouting Report</div>'
                + '<div style="font-size:0.75em; color:' + tv('#9ca3af','#64748b') + ';">Targeted job analysis</div></div>'
                + '</button>';
            
            // PDF Summary
            html += '<button onclick="exportBlueprint(\'pdf\')" style="display:flex; align-items:center; gap:10px; padding:14px 16px; background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)') + '; border-radius:10px; cursor:pointer; text-align:left; width:100%;">'
                + '<span style="color:' + tv('#d1d5db','#475569') + ';">' + bpIcon('pdf',18) + '</span>'
                + '<div><div style="font-weight:600; color:' + tv('#e0e0e0','#1e293b') + '; font-size:0.9em;">PDF Summary</div>'
                + '<div style="font-size:0.75em; color:' + tv('#9ca3af','#64748b') + ';">Full career report</div></div>'
                + '</button>';
            
            // Executive Blueprint
            html += '<button onclick="exportBlueprint(\'html\')" style="display:flex; align-items:center; gap:10px; padding:14px 16px; background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)') + '; border-radius:10px; cursor:pointer; text-align:left; width:100%;">'
                + '<span style="color:' + tv('#d1d5db','#475569') + ';">' + bpIcon('export',18) + '</span>'
                + '<div><div style="font-weight:600; color:' + tv('#e0e0e0','#1e293b') + '; font-size:0.9em;">Executive Blueprint</div>'
                + '<div style="font-size:0.75em; color:' + tv('#9ca3af','#64748b') + ';">HTML for email</div></div>'
                + '</button>';
            
            // Negotiation Guide
            if (hasValuation) {
                html += '<button onclick="showNegotiationGuide()" style="display:flex; align-items:center; gap:10px; padding:14px 16px; background:' + tv('rgba(251,191,36,0.08)','rgba(217,119,6,0.06)') + '; border:1px solid ' + tv('rgba(251,191,36,0.2)','rgba(217,119,6,0.15)') + '; border-radius:10px; cursor:pointer; text-align:left; width:100%;">'
                    + '<span style="color:#fbbf24;">' + bpIcon('dollar',18) + '</span>'
                    + '<div><div style="font-weight:600; color:' + tv('#e0e0e0','#1e293b') + '; font-size:0.9em;">Negotiation Guide</div>'
                    + '<div style="font-size:0.75em; color:' + tv('#9ca3af','#64748b') + ';">Salary strategy</div></div>'
                    + '</button>';
            }
            
            html += '</div></div>'; // end quick actions
            
            // ── TOP JOB MATCH (if jobs saved) ──
            if (topMatch && topMatchScore > 0) {
                var tmColor = topMatchScore >= 70 ? '#10b981' : topMatchScore >= 50 ? '#f59e0b' : '#ef4444';
                html += '<div style="background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + '; border-radius:12px; padding:18px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="switchView(\'jobs\')">'
                    + '<div>'
                    + '<div style="font-size:0.75em; color:' + tv('#9ca3af','#64748b') + '; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">Best Job Match</div>'
                    + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1e293b') + ';">' + topMatch.title + '</div>'
                    + '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + ';">' + (topMatch.company || '') + ' \u00B7 ' + savedJobs.length + ' jobs tracked</div>'
                    + '</div>'
                    + '<div style="text-align:center;">'
                    + '<div style="font-size:1.6em; font-weight:800; color:' + tmColor + ';">' + topMatchScore + '%</div>'
                    + '<div style="font-size:0.65em; color:' + tv('#9ca3af','#64748b') + '; text-transform:uppercase;">Match</div>'
                    + '</div></div>';
            }
            
            // ── MARKET POSITION (collapsible) ──
            if (hasValuation) {
                var negotiationGap = totalValue.yourWorth - totalValue.standardOffer;
                
                html += '<div style="border:1px solid ' + tv('rgba(16,185,129,0.25)','rgba(16,185,129,0.15)') + '; border-radius:12px; overflow:hidden; margin-bottom:20px;">'
                    
                    // Compact header (always visible)
                    + '<div onclick="var detail=document.getElementById(\'valDetailExpand\'); var arrow=document.getElementById(\'valExpandArrow\'); if(detail.style.display===\'none\'){detail.style.display=\'block\'; arrow.textContent=\'\u25B2\';}else{detail.style.display=\'none\'; arrow.textContent=\'\u25BC\';}" '
                    + 'style="padding:18px 20px; background:' + tv('linear-gradient(135deg, rgba(16,185,129,0.08), rgba(96,165,250,0.06))','linear-gradient(135deg, rgba(16,185,129,0.06), rgba(96,165,250,0.04))') + '; cursor:pointer; display:flex; justify-content:space-between; align-items:center;">'
                    + '<div style="display:flex; align-items:center; gap:14px;">'
                    + '<span style="color:#10b981;">' + bpIcon('money',20) + '</span>'
                    + '<div>'
                    + '<div style="font-weight:700; color:' + tv('#e0e0e0','#1e293b') + ';">Market Position <span style="font-size:0.72em; font-weight:600; color:' + (valuationMode === 'potential' ? '#f59e0b' : '#10b981') + ';">\u00B7 ' + (valuationMode === 'potential' ? 'Potential' : 'Evidence') + '</span></div>'
                    + '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + ';">Offers: $' + totalValue.conservativeOffer.toLocaleString() + ' \u2013 $' + totalValue.competitiveOffer.toLocaleString() + '</div>'
                    + '</div></div>'
                    + '<div style="display:flex; align-items:center; gap:14px;">'
                    + '<div style="text-align:right;">'
                    + '<div style="font-weight:700; color:#fbbf24; font-size:0.88em;">Gap: $' + negotiationGap.toLocaleString() + '</div>'
                    + '</div>'
                    + '<span id="valExpandArrow" style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.9em;">\u25BC</span>'
                    + '</div></div>'
                    
                    // Expandable detail
                    + '<div id="valDetailExpand" style="display:none; padding:20px;">';
                
                // Offer ranges
                html += '<div style="display:grid; gap:10px; margin-bottom:16px;">';
                var offerData = [
                    { label: 'Conservative (75%)', value: totalValue.conservativeOffer, desc: 'Budget-constrained', color: '#9ca3af', bg: tv('rgba(107,114,128,0.15)','rgba(107,114,128,0.08)') },
                    { label: 'Standard (85%)', value: totalValue.standardOffer, desc: 'Most common', color: '#60a5fa', bg: tv('rgba(96,165,250,0.15)','rgba(37,99,235,0.08)') },
                    { label: 'Competitive (95%)', value: totalValue.competitiveOffer, desc: 'Top employers', color: '#10b981', bg: tv('rgba(16,185,129,0.15)','rgba(5,150,105,0.08)') }
                ];
                offerData.forEach(function(o) {
                    html += '<div style="background:' + o.bg + '; padding:12px 16px; border-radius:8px; border-left:3px solid ' + o.color + '; display:flex; justify-content:space-between; align-items:center;">'
                        + '<div><div style="color:' + o.color + '; font-weight:600; font-size:0.88em;">' + o.label + '</div>'
                        + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.78em;">' + o.desc + '</div></div>'
                        + '<div style="font-weight:700; font-size:1.15em; color:' + tv('#e0e0e0','#1e293b') + ';">$' + o.value.toLocaleString() + '</div>'
                        + '</div>';
                });
                html += '</div>';
                
                // Static mode indicator
                var modeLabel = valuationMode === 'potential' ? 'Potential Value' : 'Evidence-Based Value';
                var modeColor = valuationMode === 'potential' ? '#f59e0b' : '#10b981';
                var modeIcon = valuationMode === 'potential' ? bpIcon('star',12) : bpIcon('lock',12);
                html += '<div style="display:flex; align-items:center; gap:6px; margin-bottom:14px; padding:8px 12px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border-radius:8px; border-left:3px solid ' + modeColor + ';">'
                    + '<span style="color:' + modeColor + ';">' + modeIcon + '</span>'
                    + '<span style="font-size:0.82em; font-weight:600; color:' + modeColor + ';">Showing: ' + modeLabel + '</span>'
                    + '<span style="font-size:0.72em; color:' + tv('#6b7280','#9ca3af') + '; margin-left:auto;">Switch using cards above</span>'
                    + '</div>';
                
                // Compact stats row
                html += '<div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-bottom:14px;">'
                    + '<div style="text-align:center; padding:10px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border-radius:8px;">'
                    + '<div style="font-size:0.72em; color:' + tv('#9ca3af','#64748b') + ';">Market Rate</div>'
                    + '<div style="font-weight:700; color:#60a5fa;">$' + totalValue.marketRate.toLocaleString() + '</div></div>'
                    + '<div style="text-align:center; padding:10px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border-radius:8px;">'
                    + '<div style="font-size:0.72em; color:' + tv('#9ca3af','#64748b') + ';">Premium</div>'
                    + '<div style="font-weight:700; color:#10b981;">+$' + totalValue.premiumAmount.toLocaleString() + '</div></div>'
                    + '<div style="text-align:center; padding:10px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border-radius:8px;">'
                    + '<div style="font-size:0.72em; color:' + tv('#9ca3af','#64748b') + ';">Compa-Ratio</div>'
                    + '<div style="font-weight:700; color:' + tv('#e0e0e0','#1e293b') + ';">' + totalValue.compaRatio + '%</div></div>'
                    + '</div>';
                
                // Top skills (compact)
                html += '<div style="font-size:0.82em; font-weight:600; color:#60a5fa; margin-bottom:8px;">' + bpIcon('flame',12) + ' Top Skills Driving Value</div>'
                    + '<div style="display:grid; gap:4px; margin-bottom:14px;">';
                (totalValue.top10Skills || []).slice(0, 5).forEach(function(skill, idx) {
                    var isCritical = skill.impact === 'Critical';
                    html += '<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 10px; background:' + (isCritical ? 'rgba(239,68,68,0.1)' : 'rgba(251,191,36,0.1)') + '; border-radius:5px; font-size:0.85em;">'
                        + '<span style="color:' + tv('#e0e0e0','#1e293b') + ';"><span style="color:' + tv('#6b7280','#9ca3af') + ';">' + (idx + 1) + '.</span> ' + skill.skill + ' <span style="color:' + tv('#6b7280','#9ca3af') + '; font-size:0.85em;">(' + skill.level + ')</span></span>'
                        + '<span style="color:' + (isCritical ? '#ef4444' : '#fbbf24') + '; font-size:0.78em; font-weight:600;">' + skill.impactLabel + '</span>'
                        + '</div>';
                });
                html += '</div>';
                
                // View all + methodology link
                html += '<div style="display:flex; gap:8px;">'
                    + '<button onclick="showValuationBreakdown()" style="flex:1; padding:8px 14px; background:transparent; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)') + '; border-radius:6px; color:' + tv('#d1d5db','#475569') + '; cursor:pointer; font-size:0.82em;">'
                    + bpIcon('bar-chart',12) + ' View All ' + skills.length + ' Skills</button>'
                    + '<button onclick="showNegotiationGuide()" style="flex:1; padding:8px 14px; background:transparent; border:1px solid ' + tv('rgba(251,191,36,0.2)','rgba(217,119,6,0.15)') + '; border-radius:6px; color:#fbbf24; cursor:pointer; font-size:0.82em;">'
                    + bpIcon('dollar',12) + ' Negotiation Guide</button>'
                    + '</div>';
                
                html += '</div></div>'; // close expandable + container
            }
            
            
            return html;
        }
        
        // ===== SKILLS MANAGEMENT TAB =====
        function renderSkillsManagementTab() {
            var skills = skillsData.skills || [];
            var roles = skillsData.roles || [];
            var html = '';
            
            // Action bar
            html += '<div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px;">';
            html += '<button onclick="showAddSkillsEmpty()" style="display:flex; align-items:center; gap:7px; padding:10px 18px; background:linear-gradient(135deg, rgba(96,165,250,0.15), rgba(96,165,250,0.08)); border:1px solid ' + tv('rgba(96,165,250,0.3)','rgba(37,99,235,0.2)') + '; border-radius:8px; color:#60a5fa; cursor:pointer; font-weight:600; font-size:0.88em;">'
                + bpIcon('plus',14) + ' Add Skill</button>';
            html += '<button onclick="openBulkImport()" style="display:flex; align-items:center; gap:7px; padding:10px 18px; background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)') + '; border-radius:8px; color:' + tv('#d1d5db','#475569') + '; cursor:pointer; font-weight:600; font-size:0.88em;">'
                + bpIcon('upload',14) + ' Bulk Import</button>';
            html += '<button onclick="switchView(\'skills\')" style="display:flex; align-items:center; gap:7px; padding:10px 18px; background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)') + '; border-radius:8px; color:' + tv('#d1d5db','#475569') + '; cursor:pointer; font-weight:600; font-size:0.88em; margin-left:auto;">'
                + bpIcon('skills',14) + ' Network View</button>';
            html += '</div>';
            
            if (skills.length === 0) {
                html += '<div style="text-align:center; padding:60px 20px; color:' + tv('#6b7280','#9ca3af') + ';">'
                    + '<div style="font-size:2em; margin-bottom:12px; opacity:0.5;">' + bpIcon('skills',48) + '</div>'
                    + '<div style="font-size:1.1em; font-weight:600; color:' + tv('#d1d5db','#334155') + '; margin-bottom:6px;">No skills mapped yet</div>'
                    + '<div style="font-size:0.9em; max-width:400px; margin:0 auto; line-height:1.5;">Start by adding skills from the library, importing a resume, or using bulk import to build your professional profile.</div>'
                    + '</div>';
                return html;
            }
            
            // Stats summary
            var levelCounts = { 'Mastery': 0, 'Advanced': 0, 'Intermediate': 0, 'Foundational': 0 };
            var levelColors = { 'Mastery': '#10b981', 'Advanced': '#3b82f6', 'Intermediate': '#8b5cf6', 'Foundational': '#6b7280' };
            skills.forEach(function(s) { var lv = s.level || 'Foundational'; if (levelCounts[lv] !== undefined) levelCounts[lv]++; else levelCounts['Foundational']++; });
            
            html += '<div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom:20px;">';
            ['Mastery','Advanced','Intermediate','Foundational'].forEach(function(lv) {
                if (levelCounts[lv] > 0) {
                    html += '<div style="display:flex; align-items:center; gap:6px; font-size:0.85em;">'
                        + '<div style="width:10px; height:10px; border-radius:3px; background:' + levelColors[lv] + ';"></div>'
                        + '<span style="color:' + tv('#9ca3af','#64748b') + ';">' + lv + '</span>'
                        + '<span style="font-weight:700; color:' + tv('#d1d5db','#334155') + ';">' + levelCounts[lv] + '</span>'
                        + '</div>';
                }
            });
            html += '<div style="font-size:0.85em; color:' + tv('#6b7280','#9ca3af') + '; margin-left:auto;">' + skills.length + ' total \u00B7 ' + roles.length + ' domains</div>';
            html += '</div>';
            
            // Group skills by role
            var skillsByRole = {};
            var unassigned = [];
            skills.forEach(function(s) {
                var assigned = false;
                (s.roles || []).forEach(function(roleIdx) {
                    var role = roles[roleIdx];
                    var roleName = role ? role.name : 'Unknown';
                    if (!skillsByRole[roleName]) skillsByRole[roleName] = [];
                    skillsByRole[roleName].push(s);
                    assigned = true;
                });
                if (!assigned) unassigned.push(s);
            });
            
            // Render each domain
            var domainNames = Object.keys(skillsByRole).sort();
            if (unassigned.length > 0) domainNames.push('_unassigned');
            
            domainNames.forEach(function(domain) {
                var domainSkills = domain === '_unassigned' ? unassigned : skillsByRole[domain];
                var displayName = domain === '_unassigned' ? 'Uncategorized' : domain;
                domainSkills.sort(function(a,b) {
                    var order = {'Mastery':0,'Advanced':1,'Intermediate':2,'Foundational':3};
                    return (order[a.level]||3) - (order[b.level]||3);
                });
                
                html += '<div style="margin-bottom:16px; border:1px solid ' + tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.06)') + '; border-radius:10px; overflow:hidden;">';
                
                // Domain header
                html += '<div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; border-bottom:1px solid ' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.04)') + ';">'
                    + '<div style="font-weight:600; font-size:0.88em; color:' + tv('#d1d5db','#334155') + ';">' + bpIcon('layers',14) + ' ' + displayName + '</div>'
                    + '<span style="font-size:0.75em; color:' + tv('#6b7280','#9ca3af') + ';">' + domainSkills.length + ' skills</span>'
                    + '</div>';
                
                // Skills list
                domainSkills.forEach(function(s) {
                    var lv = s.level || 'Foundational';
                    var lvColor = levelColors[lv] || '#6b7280';
                    var escapedName = s.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    html += '<div style="display:flex; align-items:center; gap:10px; padding:10px 16px; border-bottom:1px solid ' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.03)') + ';">'
                        + '<div style="flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:0.88em; color:' + tv('#e0e0e0','#1e293b') + '; cursor:pointer;" onclick="openSkillModalFromCard(\'' + escapedName + '\')">' + s.name + '</div>'
                        + '<span style="font-size:0.7em; padding:2px 8px; border-radius:10px; background:' + lvColor + '22; color:' + lvColor + '; font-weight:600; white-space:nowrap;">' + lv + '</span>';
                    
                    if (s.core) {
                        html += '<span style="font-size:0.65em; padding:2px 6px; border-radius:8px; background:' + tv('rgba(245,158,11,0.15)','rgba(245,158,11,0.1)') + '; color:#f59e0b; font-weight:600;">CORE</span>';
                    }
                    
                    html += '<button onclick="openSkillModalFromCard(\'' + escapedName + '\')" title="Edit" style="background:none; border:none; cursor:pointer; color:#60a5fa; padding:4px;">' + bpIcon('edit',14) + '</button>'
                        + '<button onclick="if(confirm(\'Remove skill: ' + escapedName + '?\')) { removeSkillFromProfile(\'' + escapedName + '\', \'' + (s.category || 'skill') + '\'); switchBlueprintTab(\'skills\'); }" title="Remove" style="background:none; border:none; cursor:pointer; color:' + tv('#6b7280','#9ca3af') + '; padding:4px;">' + bpIcon('trash',14) + '</button>'
                        + '</div>';
                });
                
                html += '</div>';
            });
            
            return html;
        }
        
        // ===== EXPERIENCE TAB (wraps Settings Experience content) =====
        function renderExperienceTab() {
            return renderExperienceSettings();
        }
        
        function toggleValuationExpand() {
            var detail = document.getElementById('valDetailExpand');
            var arrow = document.getElementById('valExpandArrow');
            if (!detail) return;
            if (detail.style.display === 'none') {
                detail.style.display = 'block';
                if (arrow) arrow.textContent = '\u25B2';
            } else {
                detail.style.display = 'none';
                if (arrow) arrow.textContent = '\u25BC';
            }
        }
        window.toggleValuationExpand = toggleValuationExpand;
        
        function renderOutcomesSection() {
            const outcomes = blueprintData.outcomes;
            
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">${bpIcon("outcomes",20)}</span>
                            <span>Outcomes I Drive</span>
                            <span class="section-count">${outcomes.length}</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ${bpIcon("lightbulb",14)} COACHING TIP
                        </div>
                        <div class="coaching-tip-content">
                            Top performers quantify impact. Notice the pattern:
                            <ul>
                                <li><strong>Numbers:</strong> $200M, 85%, 5 years, zero injuries</li>
                                <li><strong>Comparisons:</strong> "5 years early", "before market consensus"</li>
                                <li><strong>Consequences:</strong> What changed because of this?</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="outcomesContainer">
                        ${outcomes.map((outcome, idx) => renderOutcomeItem(outcome, idx)).join('')}
                    </div>
                    
                    <button class="add-outcome-btn" onclick="addCustomOutcome()">
                        <span>${bpIcon("plus",14)}</span>
                        <span>Add Custom Outcome</span>
                    </button>
                    
                    <div class="reflection-prompts">
                        <div class="reflection-title">${bpIcon("message",14)} REFLECTION PROMPTS</div>
                        <ul>
                            <li>What problem did you solve that others couldn't?</li>
                            <li>What changed because of your work?</li>
                            <li>What would have happened without you?</li>
                            <li>How do you know this worked? (proof/evidence)</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function renderOutcomeItem(outcome, idx) {
            const shareChecked = outcome.shared ? 'checked' : '';
            const sensitiveWarning = outcome.sensitive ? 
                '<span class="meta-tag sensitive">${bpIcon("warning",12)} SENSITIVE: Consider context before sharing</span>' : '';
            const coachingNote = outcome.coachingSuggestion ? 
                `<div class="outcome-coaching">${bpIcon('lightbulb',12)} ${outcome.coachingSuggestion}</div>` : '';
            
            return `
                <div class="outcome-item" data-idx="${idx}">
                    <div class="outcome-header">
                        <div class="outcome-text">${outcome.text}</div>
                        <div class="outcome-controls">
                            <label class="share-toggle">
                                <input type="checkbox" ${shareChecked} onchange="toggleOutcomeShare(${idx})">
                                <span class="share-toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="outcome-meta">
                        <span class="meta-tag category">${bpIcon("layers",12)} ${outcome.category}</span>
                        <span class="meta-tag evidence">${bpIcon("check",12)} From: ${outcome.skill}</span>
                        ${sensitiveWarning}
                    </div>
                    
                    ${coachingNote}
                    
                    <div class="outcome-actions">
                        <button class="outcome-btn" onclick="editOutcome(${idx})">${bpIcon("edit",12)} Edit</button>
                        <button class="outcome-btn" onclick="viewOutcomeEvidence(${idx})">${bpIcon("search",12)} View Evidence</button>
                        <button class="outcome-btn" onclick="deleteBlueprintOutcome(${idx})" style="color:#ef4444;">${bpIcon("trash",12)} Delete</button>
                    </div>
                </div>
            `;
        }
        
        function renderValuesSection() {
            var values = blueprintData.values || [];
            if (!Array.isArray(values)) values = [];
            var selectedCount = values.filter(function(v) { return v && v.selected; }).length;
            
            var html = '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('values',20) + '</span>'
                + '<span>Values & Principles</span>'
                + '<span class="section-count">' + selectedCount + ' selected</span>'
                + '</div>'
                + '</div>';
            
            if (showingValuesPicker) {
                html += renderValuesPicker();
            } else {
                html += renderSelectedValues();
            }
            
            html += '</div>';
            return html;
        }
        
        function renderSelectedValues() {
            var values = blueprintData.values || [];
            if (!Array.isArray(values)) values = [];
            var selectedCount = values.filter(function(v) { return v && v.selected; }).length;
            
            var html = '<div class="coaching-tip">'
                + '<div class="coaching-tip-title">' + bpIcon('lightbulb',14) + ' YOUR CORE VALUES</div>'
                + '<div class="coaching-tip-content">'
                + (selectedCount === 0
                    ? 'You haven\u2019t selected any values yet. Use the picker below to choose 3-7 that represent how you operate.'
                    : 'These are the values you operate by. Add a personal note to explain why each matters to you.')
                + '</div>'
                + '</div>';
            
            // Selected values as compact cards
            if (values.length > 0) {
                html += '<div class="values-grid">';
                values.forEach(function(value, idx) {
                    if (!value || !value.name) return;
                    var evidence = getEvidenceForValue(value.name);
                    var evCount = evidence.length;
                    var catalogDesc = getCatalogDescription(value.name);
                    
                    html += '<div class="value-card selected" style="position:relative;">';
                    
                    // Controls
                    html += '<div style="position:absolute; top:8px; right:8px; display:flex; gap:3px; opacity:0.45;" '
                        + 'onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.45">';
                    if (idx > 0) {
                        html += '<button onclick="event.stopPropagation(); moveValue(' + idx + ',-1)" title="Move up" style="'
                            + 'background:none; border:none; cursor:pointer; font-size:0.75em; color:' + tv('#9ca3af','#64748b') + '; padding:2px 4px;">\u25B2</button>';
                    }
                    if (idx < values.length - 1) {
                        html += '<button onclick="event.stopPropagation(); moveValue(' + idx + ',1)" title="Move down" style="'
                            + 'background:none; border:none; cursor:pointer; font-size:0.75em; color:' + tv('#9ca3af','#64748b') + '; padding:2px 4px;">\u25BC</button>';
                    }
                    html += '<button onclick="event.stopPropagation(); removeSelectedValue(' + idx + ')" title="Remove" style="'
                        + 'background:none; border:none; cursor:pointer; font-size:0.9em; color:' + tv('#9ca3af','#64748b') + '; padding:2px 4px;">\u00D7</button>';
                    html += '</div>';
                    
                    html += '<div class="value-title">' + value.name + '</div>';
                    
                    // Description from catalog
                    if (catalogDesc) {
                        html += '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + '; line-height:1.45; margin-top:4px;">'
                            + catalogDesc + '</div>';
                    }
                    
                    // Badges
                    html += '<div style="display:flex; gap:5px; flex-wrap:wrap; margin-top:6px;">';
                    if (value.inferred) {
                        html += '<span style="font-size:0.7em; padding:2px 7px; border-radius:10px; '
                            + 'background:' + tv('rgba(16,185,129,0.12)','rgba(16,185,129,0.08)') + '; '
                            + 'color:#10b981;">Evidence-matched</span>';
                    }
                    if (value.custom) {
                        html += '<span style="font-size:0.7em; padding:2px 7px; border-radius:10px; '
                            + 'background:' + tv('rgba(139,92,246,0.12)','rgba(139,92,246,0.08)') + '; '
                            + 'color:#a78bfa;">Custom</span>';
                    }
                    if (evCount > 0) {
                        html += '<span style="font-size:0.7em; padding:2px 7px; border-radius:10px; '
                            + 'background:' + tv('rgba(251,191,36,0.12)','rgba(251,191,36,0.08)') + '; '
                            + 'color:#f59e0b;">' + evCount + ' evidence</span>';
                    }
                    html += '</div>';
                    
                    // Personal note (editable)
                    if (value.note) {
                        html += '<div style="margin-top:8px; padding:8px 10px; border-radius:6px; '
                            + 'background:' + tv('rgba(96,165,250,0.06)','rgba(30,64,175,0.04)') + '; '
                            + 'border-left:2px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + ';">'
                            + '<div style="font-size:0.76em; color:' + tv('#d1d5db','#475569') + '; line-height:1.45; font-style:italic;">'
                            + '\u201C' + value.note + '\u201D</div>'
                            + '<button onclick="event.stopPropagation(); editValueNote(' + idx + ')" style="'
                            + 'background:none; border:none; font-size:0.7em; color:' + tv('#60a5fa','#2563eb') + '; cursor:pointer; margin-top:4px; padding:0;">Edit note</button>'
                            + '</div>';
                    } else {
                        html += '<button onclick="event.stopPropagation(); editValueNote(' + idx + ')" style="'
                            + 'background:none; border:1px dashed ' + tv('rgba(96,165,250,0.25)','rgba(30,64,175,0.15)') + '; '
                            + 'color:' + tv('#6b7280','#9ca3af') + '; font-size:0.73em; padding:5px 10px; border-radius:5px; '
                            + 'cursor:pointer; margin-top:8px; width:100%; text-align:left;">+ Add a personal note</button>';
                    }
                    
                    // Evidence preview
                    if (evCount > 0) {
                        html += '<div style="margin-top:8px; padding-top:7px; border-top:1px solid '
                            + tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.06)') + ';">'
                            + '<div style="font-size:0.76em; color:' + tv('#6b7280','#9ca3af') + '; font-style:italic; line-height:1.4;">'
                            + '\u201C' + evidence[0].text.substring(0, 90) + (evidence[0].text.length > 90 ? '\u2026' : '') + '\u201D'
                            + '<span style="color:' + tv('#60a5fa','#2563eb') + '; font-style:normal; margin-left:5px;">\u2014 ' + evidence[0].skill + '</span>'
                            + '</div></div>';
                    }
                    
                    html += '</div>';
                });
                html += '</div>';
            }
            
            // Action buttons
            html += '<div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:18px;">'
                + '<button onclick="toggleValuesPicker()" style="'
                + 'background:' + tv('rgba(96,165,250,0.12)','rgba(30,64,175,0.08)') + '; '
                + 'border:1px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + '; '
                + 'color:' + tv('#60a5fa','#1e40af') + '; '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em; font-weight:600;'
                + '">' + (values.length === 0 ? '\u2B50 Choose Your Values' : '+ Add / Change Values') + '</button>'
                + '<button onclick="showAddCustomValueForm()" style="'
                + 'background:transparent; '
                + 'border:1px dashed ' + tv('rgba(139,92,246,0.4)','rgba(139,92,246,0.3)') + '; '
                + 'color:' + tv('#a78bfa','#7c3aed') + '; '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;'
                + '">+ Custom Value</button>'
                + '</div>';
            
            // Inline custom value form (hidden)
            html += '<div id="addValueForm" style="display:none; margin-top:16px; padding:20px; '
                + 'background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)') + '; '
                + 'border:1px solid ' + tv('rgba(139,92,246,0.3)','rgba(139,92,246,0.2)') + '; border-radius:10px;">'
                + '<input id="newValueName" placeholder="Value name (e.g., Radical Transparency)" style="'
                + 'width:100%; padding:10px 14px; margin-bottom:12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid ' + tv('rgba(255,255,255,0.15)','#d1d5db') + '; border-radius:6px; '
                + 'color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.95em;" />'
                + '<div style="display:flex; gap:8px;">'
                + '<button onclick="addCustomValue()" style="'
                + 'background:' + tv('#7c3aed','#6d28d9') + '; color:#fff; border:none; padding:8px 18px; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.88em;">'
                + 'Add</button>'
                + '<button onclick="hideAddValueForm()" style="'
                + 'background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','#d1d5db') + '; '
                + 'padding:8px 18px; border-radius:6px; cursor:pointer; font-size:0.88em;">'
                + 'Cancel</button>'
                + '</div></div>';
            
            return html;
        }
        
        function renderValuesPicker() {
            var selectedNames = {};
            blueprintData.values.forEach(function(v) { selectedNames[v.name] = true; });
            
            var html = '<div class="coaching-tip">'
                + '<div class="coaching-tip-title">' + bpIcon('lightbulb',14) + ' PICK 3-7 VALUES</div>'
                + '<div class="coaching-tip-content">'
                + 'Tap values that resonate with how you actually work. Values with evidence in your profile are highlighted.'
                + '</div>'
                + '</div>';
            
            VALUES_CATALOG.forEach(function(group) {
                html += '<div style="margin-bottom:20px;">'
                    + '<div style="font-size:0.82em; font-weight:700; text-transform:uppercase; letter-spacing:0.08em; '
                    + 'color:' + tv('#6b7280','#9ca3af') + '; margin-bottom:10px; padding-left:2px;">'
                    + group.group + '</div>'
                    + '<div style="display:flex; flex-wrap:wrap; gap:8px;">';
                
                group.values.forEach(function(val) {
                    var isSelected = selectedNames[val.name] || false;
                    var evScore = scoreValueByEvidence(val);
                    var hasEvidence = evScore > 0;
                    
                    var bg, border, color;
                    if (isSelected) {
                        bg = tv('rgba(96,165,250,0.2)','rgba(30,64,175,0.12)');
                        border = tv('rgba(96,165,250,0.6)','rgba(30,64,175,0.4)');
                        color = tv('#93c5fd','#1e40af');
                    } else if (hasEvidence) {
                        bg = tv('rgba(16,185,129,0.08)','rgba(16,185,129,0.05)');
                        border = tv('rgba(16,185,129,0.25)','rgba(16,185,129,0.15)');
                        color = tv('#d1d5db','#334155');
                    } else {
                        bg = tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.03)');
                        border = tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)');
                        color = tv('#9ca3af','#64748b');
                    }
                    
                    html += '<button onclick="pickValue(\'' + val.name.replace(/'/g, "\\'") + '\')" title="' + (val.description || '').replace(/"/g, '&quot;') + '" style="'
                        + 'background:' + bg + '; border:1.5px solid ' + border + '; color:' + color + '; '
                        + 'padding:8px 16px; border-radius:20px; cursor:pointer; font-size:0.88em; '
                        + 'font-weight:' + (isSelected ? '700' : '500') + '; transition:all 0.15s ease;">'
                        + (isSelected ? '\u2713 ' : '')
                        + val.name
                        + (hasEvidence && !isSelected ? ' \u2022' : '')
                        + '</button>';
                });
                
                html += '</div></div>';
            });
            
            // Done button
            var count = blueprintData.values.filter(function(v) { return v.selected; }).length;
            var countColor = count > 7 ? '#ef4444' : count >= 3 ? '#10b981' : '#f59e0b';
            html += '<div style="margin-top:16px; display:flex; gap:10px; align-items:center;">'
                + '<button onclick="toggleValuesPicker()" style="'
                + 'background:' + tv('#1e40af','#2563eb') + '; color:#fff; border:none; '
                + 'padding:10px 24px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.92em;">'
                + 'Done (' + count + '/7)</button>'
                + '<span style="font-size:0.82em; color:' + tv('#6b7280','#9ca3af') + ';">'
                + '\u2022 = evidence in your profile'
                + (count >= 7 ? ' &nbsp;\u2022&nbsp; <span style="color:#f59e0b;">Maximum reached</span>' : '')
                + '</span>'
                + '</div>';
            
            return html;
        }
        
        function renderExportSection() {
            const sharedOutcomes = blueprintData.outcomes.filter(o => o.shared).length;
            const sharedValues = blueprintData.values.filter(v => v.selected).length;
            const skillCount = (skillsData.skills || []).length;
            var hasJobs = (userData.savedJobs || []).filter(function(j) { return j && j.title; }).length > 0;
            
            // Section header helper
            function sectionHead(icon, label) {
                return '<div style="margin-top:28px; margin-bottom:14px; display:flex; align-items:center; gap:8px;">'
                    + '<span style="color:' + tv('#6b7280','#9ca3af') + ';">' + bpIcon(icon,14) + '</span>'
                    + '<div style="font-size:0.78em; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:' + tv('#6b7280','#9ca3af') + ';">' + label + '</div>'
                    + '<div style="flex:1; height:1px; background:' + tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.06)') + ';"></div>'
                    + '</div>';
            }
            
            // Export card helper
            function exportCard(opts) {
                var bg = opts.bg || tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)');
                var border = opts.border || tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.1)');
                var h = '<div style="background:' + bg + '; border:1px solid ' + border + '; border-radius:12px; padding:20px; cursor:pointer;' + (opts.span ? ' grid-column:1/-1;' : '') + '" onclick="' + opts.action + '">'
                    + '<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">'
                    + '<span style="color:' + (opts.iconColor || tv('#d1d5db','#475569')) + ';">' + bpIcon(opts.icon, 22) + '</span>'
                    + '<div style="font-weight:600; color:' + (opts.titleColor || tv('#e0e0e0','#1f2937')) + ';">' + opts.title + '</div>'
                    + (opts.badge ? '<span style="font-size:0.7em; padding:2px 8px; border-radius:10px; background:' + opts.badge.bg + '; color:' + opts.badge.color + '; font-weight:600;">' + opts.badge.text + '</span>' : '')
                    + '</div>'
                    + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.88em; line-height:1.5;">' + opts.desc + '</div>';
                if (opts.tags) {
                    h += '<div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">';
                    opts.tags.forEach(function(t) {
                        h += '<span style="font-size:0.75em; padding:3px 10px; border-radius:20px; background:' + t.bg + '; color:' + t.color + ';">' + t.text + '</span>';
                    });
                    h += '</div>';
                }
                h += '</div>';
                return h;
            }
            
            var html = '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('export',20) + '</span>'
                + '<span>Export Your Blueprint</span>'
                + '</div>'
                + '</div>'
                + '<div class="coaching-tip">'
                + '<div class="coaching-tip-title">' + bpIcon('lightbulb',14) + ' SHARING SUMMARY</div>'
                + '<div class="coaching-tip-content">'
                + 'Currently sharing <strong>' + sharedOutcomes + ' outcomes</strong>, '
                + '<strong>' + sharedValues + ' values</strong>, and '
                + '<strong>' + skillCount + ' skills</strong>. '
                + 'Adjust selections in the Outcomes and Values tabs.'
                + '</div></div>';
            
            // ── CAREER INTELLIGENCE ──
            html += sectionHead('compass', 'Career Intelligence');
            html += '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:16px;">';
            
            // Executive Blueprint (hero)
            html += '<div style="grid-column:1/-1; background:linear-gradient(135deg, rgba(30,64,175,0.15), rgba(96,165,250,0.1)); border:2px solid ' + tv('rgba(96,165,250,0.4)','rgba(30,64,175,0.3)') + '; border-radius:12px; padding:24px; cursor:pointer;" onclick="generateWorkBlueprint()">'
                + '<div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">'
                + '<span style="color:var(--accent);">' + bpIcon('compass',28) + '</span>'
                + '<div>'
                + '<div style="font-size:1.15em; font-weight:700; color:' + tv('#60a5fa','#1e40af') + ';">Executive Blueprint</div>'
                + '<div style="font-size:0.85em; color:' + tv('#9ca3af','#64748b') + ';">Recommended for recruiters and hiring managers</div>'
                + '</div></div>'
                + '<div style="color:' + tv('#d1d5db','#334155') + '; font-size:0.92em; line-height:1.55;">'
                + 'Standalone HTML document with editorial design. Includes executive summary, top competencies, strategic outcomes, values, compensation framework, and career narrative.'
                + '</div>'
                + '<div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;">'
                + '<span style="font-size:0.75em; padding:3px 10px; border-radius:20px; background:' + tv('rgba(16,185,129,0.15)','rgba(16,185,129,0.1)') + '; color:#10b981;">HTML</span>'
                + '<span style="font-size:0.75em; padding:3px 10px; border-radius:20px; background:' + tv('rgba(96,165,250,0.15)','rgba(96,165,250,0.1)') + '; color:#60a5fa;">Print to PDF</span>'
                + '<span style="font-size:0.75em; padding:3px 10px; border-radius:20px; background:' + tv('rgba(251,191,36,0.15)','rgba(251,191,36,0.1)') + '; color:#f59e0b;">Email Attachment</span>'
                + '</div></div>';
            
            // Scouting Report
            html += exportCard({
                icon: 'target', iconColor: '#60a5fa', title: '\u25C8 Scouting Report',
                titleColor: tv('#e0e0e0','#1f2937'),
                badge: { text: 'NEW', bg: 'rgba(96,165,250,0.2)', color: '#60a5fa' },
                bg: tv('rgba(96,165,250,0.06)','rgba(59,130,246,0.04)'),
                border: tv('rgba(96,165,250,0.25)','rgba(59,130,246,0.15)'),
                desc: 'Career intelligence report targeted to a specific job. Match analysis, gaps, talking points, and market positioning.',
                action: 'showScoutingReportPicker()',
                tags: [
                    { text: 'PDF', bg: tv('rgba(96,165,250,0.15)','rgba(96,165,250,0.1)'), color: '#60a5fa' },
                    { text: 'Match Analysis', bg: tv('rgba(16,185,129,0.15)','rgba(16,185,129,0.1)'), color: '#10b981' }
                ]
            });
            
            // PDF Summary
            html += exportCard({
                icon: 'pdf', title: 'PDF Summary',
                desc: 'Compact one-to-two page PDF. Outcomes, values, purpose, skills summary, and market context.',
                action: "exportBlueprint('pdf')"
            });
            
            html += '</div>'; // end Career Intelligence grid
            
            // ── JOB-SPECIFIC TOOLS ──
            html += sectionHead('briefcase', 'Job-Specific Tools');
            if (!hasJobs) {
                html += '<div style="padding:14px 18px; background:' + tv('rgba(255,255,255,0.02)','rgba(0,0,0,0.01)') + '; border:1px dashed ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)') + '; border-radius:10px; margin-bottom:16px;">'
                    + '<div style="font-size:0.85em; color:' + tv('#6b7280','#9ca3af') + ';">'
                    + bpIcon('info',14) + ' Save jobs in the Jobs tab to unlock cover letters, interview prep, and resume targeting.'
                    + '</div></div>';
            }
            html += '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:16px;">';
            
            html += exportCard({
                icon: 'file-text', title: 'Professional Resume',
                desc: 'Traditional resume format with skills, experience, and achievements. HTML file, print to PDF.',
                action: 'generateResume()'
            });
            
            html += exportCard({
                icon: 'send', iconColor: '#10b981', title: 'Cover Letter',
                titleColor: '#10b981',
                bg: 'linear-gradient(135deg, rgba(16,185,129,0.12), rgba(16,185,129,0.04))',
                border: 'rgba(16,185,129,0.25)',
                desc: 'Cover letter tailored to a saved job. Uses your matched skills, outcomes, and values.',
                action: 'generateCoverLetter()'
            });
            
            html += exportCard({
                icon: 'interview', iconColor: '#fbbf24', title: 'Interview Prep',
                titleColor: '#fbbf24',
                bg: 'linear-gradient(135deg, rgba(251,191,36,0.12), rgba(251,191,36,0.04))',
                border: 'rgba(251,191,36,0.25)',
                desc: 'STAR stories for matched skills, bridging language for gaps, and talking points for your strengths.',
                action: 'generateInterviewPrep()'
            });
            
            html += '</div>'; // end Job-Specific grid
            
            // ── NETWORKING & PROFILE ──
            html += sectionHead('linkedin', 'Networking & Profile');
            html += '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:16px;">';
            
            html += exportCard({
                icon: 'linkedin', iconColor: '#0a66c2', title: 'LinkedIn Profile',
                titleColor: '#0a66c2',
                bg: 'linear-gradient(135deg, rgba(10,102,194,0.12), rgba(10,102,194,0.04))',
                border: 'rgba(10,102,194,0.25)',
                desc: 'Optimized headline, About section, and skills list formatted for LinkedIn. Copy and paste directly.',
                action: 'generateLinkedInProfile()'
            });
            
            html += exportCard({
                icon: 'copy', title: 'Copy to Clipboard',
                desc: 'Plain text summary for pasting into emails, messages, or cover letters.',
                action: 'copyBlueprintText()'
            });
            
            html += '</div>'; // end Networking grid
            
            // ── DATA & BACKUP ──
            html += sectionHead('json', 'Data & Backup');
            html += '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:16px;">';
            
            html += exportCard({
                icon: 'json', title: 'JSON Data Export',
                desc: 'Structured data export. Use for backups, imports, or integration with other tools.',
                action: "exportBlueprint('json')"
            });
            
            html += '</div>'; // end Data grid
            
            html += '</div>'; // close blueprint-section
            return html;
        }
        
        // Blueprint interaction functions
        function toggleOutcomeShare(idx) {
            blueprintData.outcomes[idx].shared = !blueprintData.outcomes[idx].shared;
            saveUserData();  // Auto-save
        }
        
        function deleteBlueprintOutcome(idx) {
            if (readOnlyGuard()) return;
            var outcome = blueprintData.outcomes[idx];
            if (!outcome) return;
            var preview = outcome.text.length > 60 ? outcome.text.substring(0, 60) + '...' : outcome.text;
            if (!confirm('Delete this outcome?\n\n"' + preview + '"')) return;
            blueprintData.outcomes.splice(idx, 1);
            saveUserData();
            switchBlueprintTab('outcomes');
            showToast('Outcome deleted.', 'info');
        }
        window.deleteBlueprintOutcome = deleteBlueprintOutcome;
        
        function editOutcome(idx) {
            const outcome = blueprintData.outcomes[idx];
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Edit Outcome</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Refine how you describe this achievement</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="margin-bottom: 20px;">
                        <label class="settings-label">
                            Outcome Text
                        </label>
                        <textarea id="editOutcomeText" style="
                            width: 100%;
                            min-height: 120px;
                            padding: 15px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                            line-height: 1.6;
                            font-family: inherit;
                            resize: vertical;
                        ">${outcome.text}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label class="settings-label">
                            Category
                        </label>
                        <select id="editOutcomeCategory" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                        ">
                            <option value="Business Impact" ${outcome.category === 'Business Impact' ? 'selected' : ''}>Business Impact</option>
                            <option value="Strategic Foresight" ${outcome.category === 'Strategic Foresight' ? 'selected' : ''}>Strategic Foresight</option>
                            <option value="Crisis Leadership" ${outcome.category === 'Crisis Leadership' ? 'selected' : ''}>Crisis Leadership</option>
                            <option value="Entrepreneurial" ${outcome.category === 'Entrepreneurial' ? 'selected' : ''}>Entrepreneurial</option>
                            <option value="Thought Leadership" ${outcome.category === 'Thought Leadership' ? 'selected' : ''}>Thought Leadership</option>
                            <option value="Advocacy Impact" ${outcome.category === 'Advocacy Impact' ? 'selected' : ''}>Advocacy Impact</option>
                            <option value="Professional Achievement" ${outcome.category === 'Professional Achievement' ? 'selected' : ''}>Professional Achievement</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="editOutcomeSensitive" ${outcome.sensitive ? 'checked' : ''} style="
                                width: 20px;
                                height: 20px;
                                cursor: pointer;
                            ">
                            <span style="color: #ef4444; font-weight: 600;">Mark as Sensitive Content</span>
                        </label>
                        <p style="color: #9ca3af; font-size: 0.85em; margin-top: 5px; margin-left: 30px;">
                            Flag personal stories (recovery, loss, etc.) that require context before sharing
                        </p>
                    </div>
                    
                    <div style="background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <strong style="color: #fbbf24;">${bpIcon('lightbulb',12)} COACHING TIP:</strong>
                        <p style="color: #d1d5db; margin-top: 8px; font-size: 0.9em;">
                            Strong outcomes include:
                            <br>• Quantification (numbers, percentages, time saved)
                            <br>• Who benefited (clients, company, team)
                            <br>• What changed as a result
                            <br>• Comparison or context (vs industry average, timeline)
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="action-btn" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Cancel
                        </button>
                        <button class="export-btn-large" onclick="saveOutcomeEdit(${idx})" style="padding: 10px 20px;">
                            ${bpIcon("save",14)} Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function saveOutcomeEdit(idx) {
            const newText = document.getElementById('editOutcomeText').value;
            const newCategory = document.getElementById('editOutcomeCategory').value;
            const newSensitive = document.getElementById('editOutcomeSensitive').checked;
            
            // Update outcome
            blueprintData.outcomes[idx].text = newText;
            blueprintData.outcomes[idx].category = newCategory;
            blueprintData.outcomes[idx].sensitive = newSensitive;
            
            // Regenerate coaching suggestion
            blueprintData.outcomes[idx].coachingSuggestion = generateCoachingFor(newText);
            
            // Save to localStorage
            saveUserData();
            
            // Close modal and refresh
            closeExportModal();
            renderBlueprint();
            
            showToast('Outcome updated.', 'success');
        }
        
        function viewOutcomeEvidence(idx) {
            const outcome = blueprintData.outcomes[idx];
            const skill = skillsData.skills.find(s => s.name === outcome.skill);
            if (skill) {
                openSkillModal(outcome.skill, skill);
            }
        }
        
        function addCustomOutcome() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Add Custom Outcome</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Describe an achievement or impact you've made</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="margin-bottom: 20px;">
                        <label class="settings-label">
                            Outcome Template
                        </label>
                        <select id="outcomeTemplate" onchange="fillOutcomeTemplate(this.value)" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                            margin-bottom: 15px;
                        ">
                            <option value="">-- Choose a template (optional) --</option>
                            <option value="revenue">Revenue/Financial Impact</option>
                            <option value="team">Team Building/Leadership</option>
                            <option value="innovation">Innovation/New Capability</option>
                            <option value="efficiency">Efficiency/Process Improvement</option>
                            <option value="crisis">Crisis Management</option>
                            <option value="strategic">Strategic Initiative</option>
                            <option value="thought">Thought Leadership</option>
                        </select>
                        
                        <textarea id="customOutcomeText" placeholder="Example: Led strategic initiative that increased revenue by 40% year-over-year through new market expansion" style="
                            width: 100%;
                            min-height: 120px;
                            padding: 15px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                            line-height: 1.6;
                            font-family: inherit;
                            resize: vertical;
                        "></textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label class="settings-label">
                            Category
                        </label>
                        <select id="customOutcomeCategory" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                        ">
                            <option value="Business Impact">Business Impact</option>
                            <option value="Strategic Foresight">Strategic Foresight</option>
                            <option value="Crisis Leadership">Crisis Leadership</option>
                            <option value="Entrepreneurial">Entrepreneurial</option>
                            <option value="Thought Leadership">Thought Leadership</option>
                            <option value="Advocacy Impact">Advocacy Impact</option>
                            <option value="Professional Achievement">Professional Achievement</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label class="settings-label">
                            Related Skill (Optional)
                        </label>
                        <select id="customOutcomeSkill" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                        ">
                            <option value="">-- None --</option>
                            ${skillsData.skills.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <strong style="color: #fbbf24;">${bpIcon('lightbulb',12)} REFLECTION PROMPTS:</strong>
                        <ul style="color: #d1d5db; margin-top: 8px; font-size: 0.9em; margin-left: 20px;">
                            <li>What problem did you solve that others couldn't?</li>
                            <li>What measurable change resulted from your work?</li>
                            <li>Who benefited and how do you know?</li>
                            <li>What would have happened without your contribution?</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="action-btn" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Cancel
                        </button>
                        <button class="export-btn-large" onclick="saveCustomOutcome()" style="padding: 10px 20px;">
                            ${bpIcon("plus",14)} Add Outcome
                        </button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function fillOutcomeTemplate(type) {
            const textarea = document.getElementById('customOutcomeText');
            const templates = {
                revenue: 'Led [initiative] that increased revenue by [X%/amount] through [approach/method]. Resulted in [specific outcome/benefit].',
                team: 'Built and scaled [team/function] from [starting point] to [end state]. Team delivered [key achievements] within [timeframe].',
                innovation: 'Created [new capability/system] that enabled [organization/team] to [achieve what]. Adopted by [number/scope] with [measurable impact].',
                efficiency: 'Redesigned [process/system] reducing [time/cost/effort] by [X%]. Eliminated [waste/bottleneck] affecting [scope/scale].',
                crisis: 'Managed [crisis/incident] under [constraints]. Achieved [outcome] with [metric: zero injuries/minimal impact/rapid resolution].',
                strategic: 'Developed [strategy/framework] for [challenge/opportunity]. Predicted [outcome] [timeframe] ahead of market, enabling [advantage/benefit].',
                thought: 'Published [content type] reaching [audience size]. [Recognition/adoption]: [specific examples of influence/impact].'
            };
            
            if (templates[type]) {
                textarea.value = templates[type];
                textarea.focus();
            }
        }
        
        function saveCustomOutcome() {
            const text = document.getElementById('customOutcomeText').value.trim();
            if (!text) {
                showToast('Please enter an outcome description.', 'warning');
                return;
            }
            
            const category = document.getElementById('customOutcomeCategory').value;
            const skill = document.getElementById('customOutcomeSkill').value;
            
            // Create new outcome
            const newOutcome = {
                text: text,
                skill: skill || 'Custom',
                category: category,
                shared: true,
                sensitive: false,
                coachingSuggestion: generateCoachingFor(text)
            };
            
            // Add to beginning of outcomes array
            blueprintData.outcomes.unshift(newOutcome);
            
            // Save
            saveUserData();
            
            // Close and refresh
            closeExportModal();
            renderBlueprint();
            
            showToast('Custom outcome added.', 'success');
        }
        
        function toggleValue(idx) {
            blueprintData.values[idx].selected = !blueprintData.values[idx].selected;
            saveValues();
            refreshValuesUI();
        }
        
        function refreshValuesUI() {
            var contentEl = document.getElementById('blueprintTabContent');
            if (contentEl) contentEl.innerHTML = renderBlueprintTabContent();
            updateValuesBadge();
        }
        
        function updateValuesBadge() {
            var count = blueprintData.values.filter(function(v) { return v.selected; }).length;
            var tabs = document.querySelectorAll('.bp-tab');
            if (tabs.length > 1) {
                var badge = tabs[1].querySelector('.bp-tab-count');
                if (badge) badge.textContent = count;
            }
        }
        
        function toggleValuesPicker() {
            showingValuesPicker = !showingValuesPicker;
            refreshValuesUI();
        }
        window.toggleValuesPicker = toggleValuesPicker;
        
        function pickValue(name) {
            // Toggle: if already selected, remove; otherwise add
            var idx = -1;
            blueprintData.values.forEach(function(v, i) {
                if (v.name === name) idx = i;
            });
            
            if (idx >= 0) {
                // Remove it
                blueprintData.values.splice(idx, 1);
            } else {
                // Enforce max 7
                if (blueprintData.values.length >= 7) {
                    showToast('Maximum 7 values. Remove one before adding another.', 'warning');
                    return;
                }
                // Add it
                blueprintData.values.push({
                    name: name,
                    selected: true,
                    inferred: false,
                    custom: false
                });
            }
            saveValues();
            refreshValuesUI();
        }
        window.pickValue = pickValue;
        
        function removeSelectedValue(idx) {
            var value = blueprintData.values[idx];
            if (!value) return;
            blueprintData.values.splice(idx, 1);
            saveValues();
            refreshValuesUI();
            showToast('Removed "' + value.name + '".', 'info');
        }
        window.removeSelectedValue = removeSelectedValue;
        
        function showAddCustomValueForm() {
            // Re-render first to make sure form element exists
            showingValuesPicker = false;
            refreshValuesUI();
            setTimeout(function() {
                var form = document.getElementById('addValueForm');
                if (form) { form.style.display = 'block'; }
                var nameEl = document.getElementById('newValueName');
                if (nameEl) nameEl.focus();
            }, 50);
        }
        window.showAddCustomValueForm = showAddCustomValueForm;
        
        function showAddValueForm() { showAddCustomValueForm(); }
        window.showAddValueForm = showAddValueForm;
        
        function hideAddValueForm() {
            var form = document.getElementById('addValueForm');
            if (form) form.style.display = 'none';
            var nameEl = document.getElementById('newValueName');
            if (nameEl) nameEl.value = '';
        }
        window.hideAddValueForm = hideAddValueForm;
        
        function addCustomValue() {
            var nameEl = document.getElementById('newValueName');
            var name = (nameEl ? nameEl.value : '').trim();
            
            if (!name) {
                showToast('Please enter a value name.', 'warning');
                return;
            }
            
            if (blueprintData.values.length >= 7) {
                showToast('Maximum 7 values. Remove one before adding another.', 'warning');
                return;
            }
            
            var exists = blueprintData.values.some(function(v) {
                return v.name.toLowerCase() === name.toLowerCase();
            });
            if (exists) {
                showToast('That value is already in your list.', 'warning');
                return;
            }
            
            blueprintData.values.push({
                name: name,
                selected: true,
                inferred: false,
                custom: true
            });
            
            saveValues();
            hideAddValueForm();
            refreshValuesUI();
            showToast('Added "' + name + '".', 'success');
        }
        window.addCustomValue = addCustomValue;
        
        function moveValue(idx, direction) {
            var newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= blueprintData.values.length) return;
            var temp = blueprintData.values[idx];
            blueprintData.values[idx] = blueprintData.values[newIdx];
            blueprintData.values[newIdx] = temp;
            saveValues();
            refreshValuesUI();
        }
        window.moveValue = moveValue;
        window.toggleValue = toggleValue;
        window.updatePurpose = updatePurpose;
        
        function updatePurpose(newPurpose) {
            blueprintData.purpose = newPurpose;
            saveValues();
        }
        
        // ===== SCOUTING REPORT JOB PICKER =====
        function showScoutingReportPicker() {
            var savedJobs = (userData.savedJobs || []).filter(function(j) { return j && j.title && j.matchData; });
            
            var modal = document.getElementById('exportModal');
            var modalContent = modal.querySelector('.modal-content');
            
            if (savedJobs.length === 0) {
                modalContent.innerHTML = '<div class="modal-header">'
                    + '<div class="modal-header-left"><h2 class="modal-title">\u25C8 Scouting Report</h2></div>'
                    + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                    + '</div>'
                    + '<div class="modal-body" style="padding:40px 32px; text-align:center;">'
                    + '<div style="font-size:2.4em; margin-bottom:16px; opacity:0.5;">' + bpIcon('target',48) + '</div>'
                    + '<div style="font-size:1.1em; font-weight:600; color:var(--text-primary); margin-bottom:10px;">No jobs in your pipeline yet</div>'
                    + '<div style="font-size:0.9em; color:var(--text-secondary); line-height:1.6; margin-bottom:24px;">'
                    + 'Save a job from Find Jobs, or paste a job description in the Jobs tab. Blueprint will score the match and you can generate a targeted scouting report.</div>'
                    + '<button onclick="closeExportModal(); switchView(\'jobs\');" style="padding:10px 24px; border-radius:8px; border:none; background:var(--accent); color:#fff; font-weight:600; cursor:pointer;">Go to Jobs</button>'
                    + '</div>';
                history.pushState({ modal: true }, '');
                modal.classList.add('active');
                return;
            }
            
            // Sort by match score descending
            savedJobs.sort(function(a, b) { return (b.matchData.score || 0) - (a.matchData.score || 0); });
            
            var jobCardsHTML = savedJobs.map(function(job, idx) {
                var score = (job.matchData && job.matchData.score) || 0;
                var matchedCount = (job.matchData && job.matchData.matched) ? job.matchData.matched.length : 0;
                var gapCount = (job.matchData && job.matchData.gaps) ? job.matchData.gaps.length : 0;
                var scoreColor = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                var realIdx = userData.savedJobs.indexOf(job);
                
                return '<div onclick="generateScoutingReport(' + realIdx + ')" style="padding:16px; background:' + tv('rgba(255,255,255,0.04)','rgba(0,0,0,0.02)') + '; '
                    + 'border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)') + '; border-radius:10px; cursor:pointer; transition:border-color 0.2s; display:flex; justify-content:space-between; align-items:center;" '
                    + 'onmouseover="this.style.borderColor=\'rgba(96,165,250,0.4)\'" onmouseout="this.style.borderColor=\'' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.08)') + '\'">'
                    + '<div style="flex:1; min-width:0;">'
                    + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1e293b') + '; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' + job.title + '</div>'
                    + '<div style="font-size:0.82em; color:' + tv('#9ca3af','#64748b') + ';">' + (job.company || 'Unknown company')
                    + ' \u00B7 ' + matchedCount + ' matched \u00B7 ' + gapCount + ' gap' + (gapCount !== 1 ? 's' : '') + '</div>'
                    + '</div>'
                    + '<div style="text-align:center; min-width:56px; margin-left:12px;">'
                    + '<div style="font-size:1.5em; font-weight:800; color:' + scoreColor + ';">' + score + '%</div>'
                    + '<div style="font-size:0.65em; color:' + tv('#9ca3af','#64748b') + '; text-transform:uppercase; letter-spacing:0.5px;">Match</div>'
                    + '</div>'
                    + '</div>';
            }).join('');
            
            modalContent.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left"><h2 class="modal-title">\u25C8 Scouting Report</h2></div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<div style="font-size:0.88em; color:var(--text-secondary); margin-bottom:16px; line-height:1.5;">'
                + 'Select a job to generate a targeted career intelligence report. This is your scouting report \u2014 built to send to recruiters and hiring managers.</div>'
                + '<div style="display:grid; gap:10px;">' + jobCardsHTML + '</div>'
                + '<div style="margin-top:16px; padding-top:14px; border-top:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.06)') + ';">'
                + '<button onclick="closeExportModal(); exportBlueprint(\'pdf\')" style="width:100%; padding:10px; border:1px solid ' + tv('rgba(255,255,255,0.1)','rgba(0,0,0,0.1)') + '; background:transparent; color:var(--text-secondary); border-radius:8px; cursor:pointer; font-size:0.88em;">'
                + 'Or generate a general Blueprint PDF (no job targeting)</button>'
                + '</div>'
                + '</div>';
            
            history.pushState({ modal: true }, '');
            modal.classList.add('active');
        }
        window.showScoutingReportPicker = showScoutingReportPicker;
        
        function generateScoutingReport(jobIdx) {
            var job = (userData.savedJobs || [])[jobIdx];
            if (!job) { showToast('Job not found.', 'error'); return; }
            
            closeExportModal();
            
            // Build shared data same as normal export
            var sharedData = {
                profile: userData.profile || {},
                outcomes: blueprintData.outcomes.filter(function(o) { return o.shared; }),
                values: blueprintData.values.filter(function(v) { return v.selected; }),
                purpose: blueprintData.purpose,
                skills: (skillsData.skills || []).map(function(s) {
                    return { name: s.name, level: s.level, category: s.category, key: s.key, roles: s.roles };
                }),
                roles: skillsData.roles || [],
                exportedAt: new Date().toISOString()
            };
            
            generatePDF(sharedData, job);
        }
        window.generateScoutingReport = generateScoutingReport;
        
        function exportBlueprint(format) {
            var sharedData = {
                profile: userData.profile || {},
                outcomes: blueprintData.outcomes.filter(function(o) { return o.shared; }),
                values: blueprintData.values.filter(function(v) { return v.selected; }),
                purpose: blueprintData.purpose,
                skills: (skillsData.skills || []).map(function(s) {
                    return { name: s.name, level: s.level, category: s.category, key: s.key, roles: s.roles };
                }),
                roles: skillsData.roles || [],
                exportedAt: new Date().toISOString()
            };
            
            if (format === 'json') {
                var dataStr = JSON.stringify(sharedData, null, 2);
                var dataBlob = new Blob([dataStr], {type: 'application/json'});
                var url = URL.createObjectURL(dataBlob);
                var link = document.createElement('a');
                link.href = url;
                var safeName = ((userData.profile && userData.profile.name) || 'profile').replace(/\s+/g, '-').toLowerCase();
                link.download = 'blueprint-' + safeName + '.json';
                link.click();
                URL.revokeObjectURL(url);
                showToast('JSON exported. Use this for backups or data portability.', 'success');
            } else if (format === 'pdf') {
                generatePDF(sharedData);
            }
        }
        
        function generatePDF(data, targetJob) {
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF({ unit: 'mm', format: 'a4' });
            
            var isScoutingReport = !!(targetJob && targetJob.matchData);
            
            var pageWidth = doc.internal.pageSize.getWidth();   // 210
            var pageHeight = doc.internal.pageSize.getHeight();  // 297
            var margin = 18;
            var maxWidth = pageWidth - (margin * 2);
            var name = (userData.profile && userData.profile.name) || 'Blueprint';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            var location = (userData.profile && userData.profile.location) || '';
            var dateLine = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            var skills = skillsData.skills || [];
            var roles = skillsData.roles || [];
            var yPos = 0;
            var pageNum = 0;
            
            // Color palette
            var C = {
                brand: [30, 64, 175],       // #1e40af
                accent: [96, 165, 250],      // #60a5fa
                dark: [15, 23, 42],          // #0f172a
                text: [30, 41, 59],          // #1e293b
                textLight: [100, 116, 139],  // #64748b
                textMuted: [148, 163, 184],  // #94a3b8
                green: [16, 185, 129],       // #10b981
                amber: [245, 158, 11],       // #f59e0b
                rose: [244, 114, 182],       // #f472b6
                purple: [129, 140, 248],     // #818cf8
                bgLight: [248, 250, 252],    // #f8fafc
                border: [226, 232, 240],     // #e2e8f0
                white: [255, 255, 255]
            };
            
            // Level colors
            var levelColor = {
                'Mastery': C.amber,
                'Advanced': C.accent,
                'Proficient': C.green,
                'Developing': C.purple,
                'Foundational': C.textMuted
            };
            
            // ============================================================
            // UTILITY FUNCTIONS
            // ============================================================
            
            function setColor(c) { doc.setTextColor(c[0], c[1], c[2]); }
            function setDraw(c) { doc.setDrawColor(c[0], c[1], c[2]); }
            function setFill(c) { doc.setFillColor(c[0], c[1], c[2]); }
            
            function newPage() {
                if (pageNum > 0) addFooter();
                if (pageNum > 0) doc.addPage();
                pageNum++;
                yPos = margin;
                // Header line on non-cover pages
                if (pageNum > 1) {
                    doc.setFontSize(6.5);
                    setColor(C.textMuted);
                    doc.text('BLUEPRINT\u2122 CAREER INTELLIGENCE REPORT', margin, 10);
                    doc.text('CONFIDENTIAL', pageWidth - margin, 10, { align: 'right' });
                    setDraw(C.border);
                    doc.setLineWidth(0.3);
                    doc.line(margin, 12, pageWidth - margin, 12);
                    yPos = 18;
                }
            }
            
            function checkPage(needed) {
                if (yPos + needed > pageHeight - 22) {
                    newPage();
                }
            }
            
            function addFooter() {
                setDraw(C.border);
                doc.setLineWidth(0.2);
                doc.line(margin, pageHeight - 14, pageWidth - margin, pageHeight - 14);
                doc.setFontSize(6.5);
                setColor(C.textMuted);
                doc.text(name + '  \u2022  ' + dateLine + '  \u2022  myblueprint.work', margin, pageHeight - 10);
                doc.text('Page ' + pageNum, pageWidth - margin, pageHeight - 10, { align: 'right' });
                doc.setFontSize(5.5);
                doc.text('\u00A9 ' + new Date().getFullYear() + ' Cliff Jurkiewicz. All rights reserved.', margin, pageHeight - 7);
            }
            
            function sectionHead(label, heading) {
                checkPage(22);
                yPos += 6;
                // Label
                doc.setFontSize(7);
                doc.setFont(undefined, 'bold');
                setColor(C.accent);
                doc.text(label.toUpperCase(), margin, yPos);
                yPos += 5;
                // Heading
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                setColor(C.dark);
                doc.text(heading, margin, yPos);
                yPos += 3;
                // Accent bar
                setDraw(C.accent);
                doc.setLineWidth(0.8);
                doc.line(margin, yPos, margin + 40, yPos);
                yPos += 6;
                doc.setFont(undefined, 'normal');
            }
            
            function bodyText(text, indent) {
                indent = indent || 0;
                doc.setFontSize(9);
                setColor(C.text);
                doc.setFont(undefined, 'normal');
                var lines = doc.splitTextToSize(text, maxWidth - indent);
                checkPage(lines.length * 4.2 + 2);
                doc.text(lines, margin + indent, yPos);
                yPos += lines.length * 4.2;
            }
            
            function drawPill(x, y, text, bgColor, textColor) {
                doc.setFontSize(6);
                var w = doc.getTextWidth(text) + 5;
                setFill(bgColor);
                doc.roundedRect(x, y - 3, w, 4.5, 2, 2, 'F');
                doc.setTextColor(textColor[0], textColor[1], textColor[2]);
                doc.text(text, x + 2.5, y);
                return w + 1.5;
            }
            
            // ============================================================
            // PAGE 1: COVER
            // ============================================================
            pageNum = 1;
            
            // Dark header band
            setFill(C.dark);
            doc.rect(0, 0, pageWidth, 105, 'F');
            
            // Accent line
            setFill(C.accent);
            doc.rect(0, 105, pageWidth, 1.2, 'F');
            
            // Blueprint logo mark — mini network graph
            var cx = pageWidth / 2;
            var cy = 38;
            var nodes = [
                { x: cx, y: cy, r: 3.5, color: C.accent },          // center
                { x: cx - 18, y: cy - 14, r: 2, color: [147, 187, 252] },  // TL
                { x: cx + 20, y: cy - 12, r: 1.8, color: C.purple },       // TR
                { x: cx + 18, y: cy + 15, r: 2, color: [147, 187, 252] },  // BR
                { x: cx - 16, y: cy + 16, r: 1.8, color: C.purple },       // BL
                { x: cx - 8, y: cy - 22, r: 1.2, color: C.green },
                { x: cx + 10, y: cy - 20, r: 1.3, color: C.amber },
                { x: cx + 25, y: cy + 2, r: 1.1, color: C.rose },
                { x: cx - 24, y: cy + 4, r: 1.2, color: C.green },
            ];
            
            // Draw connections
            setDraw([96, 165, 250]);
            doc.setLineWidth(0.2);
            for (var ni = 1; ni < nodes.length; ni++) {
                doc.line(nodes[0].x, nodes[0].y, nodes[ni].x, nodes[ni].y);
            }
            // Cross-connections
            doc.setLineWidth(0.1);
            doc.line(nodes[1].x, nodes[1].y, nodes[2].x, nodes[2].y);
            doc.line(nodes[2].x, nodes[2].y, nodes[3].x, nodes[3].y);
            doc.line(nodes[3].x, nodes[3].y, nodes[4].x, nodes[4].y);
            doc.line(nodes[4].x, nodes[4].y, nodes[1].x, nodes[1].y);
            doc.line(nodes[5].x, nodes[5].y, nodes[6].x, nodes[6].y);
            doc.line(nodes[7].x, nodes[7].y, nodes[3].x, nodes[3].y);
            doc.line(nodes[8].x, nodes[8].y, nodes[4].x, nodes[4].y);
            
            // Outer ring
            setDraw([96, 165, 250]);
            doc.setLineWidth(0.3);
            doc.circle(cx, cy, 28, 'S');
            
            // Draw nodes
            nodes.forEach(function(n) {
                setFill(n.color);
                doc.circle(n.x, n.y, n.r, 'F');
            });
            
            // Title text
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(96, 165, 250);
            doc.text('BLUEPRINT\u2122', cx, cy + 36, { align: 'center' });
            
            // Subtitle
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(148, 163, 184);
            doc.text('CAREER INTELLIGENCE REPORT', cx, cy + 42, { align: 'center' });
            
            // Target job subtitle on cover
            if (isScoutingReport) {
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(200, 210, 230);
                doc.text('PREPARED FOR: ' + (targetJob.title || '').toUpperCase(), cx, cy + 48, { align: 'center' });
                if (targetJob.company) {
                    doc.setFontSize(7);
                    doc.text(targetJob.company.toUpperCase(), cx, cy + 53, { align: 'center' });
                }
            }
            
            // Name block
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 255, 255);
            doc.text(name, cx, cy + 56, { align: 'center' });
            
            // Info below dark band
            yPos = 116;
            if (title) {
                doc.setFontSize(13);
                doc.setFont(undefined, 'normal');
                setColor(C.text);
                doc.text(title, cx, yPos, { align: 'center' });
                yPos += 7;
            }
            if (location) {
                doc.setFontSize(9);
                setColor(C.textLight);
                doc.text(location, cx, yPos, { align: 'center' });
                yPos += 7;
            }
            doc.setFontSize(9);
            setColor(C.textMuted);
            doc.text(dateLine, cx, yPos, { align: 'center' });
            yPos += 12;
            
            // Quick stats boxes
            var comp = calculateTotalMarketValue();
            var masteryCount = skills.filter(function(s) { return s.level === 'Mastery'; }).length;
            var advancedCount = skills.filter(function(s) { return s.level === 'Advanced'; }).length;
            var evidenceCount = 0;
            skills.forEach(function(s) { evidenceCount += (s.evidence || []).length; });
            var outcomeCount = (data.outcomes || []).length;
            
            var stats = [];
            if (isScoutingReport) {
                var matchScore = targetJob.matchData.score || 0;
                stats = [
                    { value: matchScore + '%', label: 'Match Score' },
                    { value: String(skills.length), label: 'Total Skills' },
                    { value: String((targetJob.matchData.matched || []).length), label: 'Skills Aligned' },
                    { value: String((targetJob.matchData.gaps || []).length), label: 'Gaps' }
                ];
            } else {
                stats = [
                    { value: String(skills.length), label: 'Total Skills' },
                    { value: String(roles.length), label: 'Roles' },
                    { value: String(masteryCount + advancedCount), label: 'Expert+' },
                    { value: String(evidenceCount), label: 'Evidence Items' }
                ];
            }
            
            var boxW = (maxWidth - 9) / 4;
            var boxX = margin;
            var boxY = yPos;
            stats.forEach(function(stat, i) {
                setFill(C.bgLight);
                setDraw(C.border);
                doc.setLineWidth(0.3);
                doc.roundedRect(boxX, boxY, boxW, 18, 2, 2, 'FD');
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                setColor(C.brand);
                doc.text(stat.value, boxX + boxW / 2, boxY + 8, { align: 'center' });
                
                doc.setFontSize(6.5);
                doc.setFont(undefined, 'normal');
                setColor(C.textMuted);
                doc.text(stat.label.toUpperCase(), boxX + boxW / 2, boxY + 13.5, { align: 'center' });
                
                boxX += boxW + 3;
            });
            yPos = boxY + 26;
            
            // Purpose on cover
            if (data.purpose && data.purpose.trim()) {
                setDraw(C.accent);
                doc.setLineWidth(0.6);
                doc.line(margin, yPos, margin, yPos + 18);
                doc.setFontSize(10);
                doc.setFont(undefined, 'italic');
                setColor(C.text);
                var purposeLines = doc.splitTextToSize(data.purpose.trim(), maxWidth - 8);
                doc.text(purposeLines.slice(0, 4), margin + 4, yPos + 5);
                yPos += Math.min(purposeLines.length, 4) * 5 + 10;
                doc.setFont(undefined, 'normal');
            }
            
            // Market positioning on cover
            if (comp && comp.marketRate) {
                yPos += 4;
                setFill(C.dark);
                doc.roundedRect(margin, yPos, maxWidth, 28, 3, 3, 'F');
                
                var colW = maxWidth / 3;
                var mLabels = ['Base Market Rate', 'Conservative Range', 'Competitive Range'];
                var mValues = [
                    '$' + Math.round(comp.marketRate).toLocaleString(),
                    '$' + Math.round(comp.conservativeOffer || comp.marketRate * 1.1).toLocaleString(),
                    '$' + Math.round(comp.competitiveOffer || comp.marketRate * 1.3).toLocaleString()
                ];
                
                mLabels.forEach(function(label, i) {
                    var cx2 = margin + (colW * i) + colW / 2;
                    doc.setFontSize(6);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(148, 163, 184);
                    doc.text(label.toUpperCase(), cx2, yPos + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(96, 165, 250);
                    doc.text(mValues[i], cx2, yPos + 17, { align: 'center' });
                    
                    // Vertical divider
                    if (i < 2) {
                        doc.setDrawColor(50, 60, 80);
                        doc.setLineWidth(0.2);
                        doc.line(margin + colW * (i + 1), yPos + 4, margin + colW * (i + 1), yPos + 24);
                    }
                });
                yPos += 36;
            }
            
            // Confidentiality
            doc.setFontSize(7);
            setColor(C.textMuted);
            doc.text('CONFIDENTIAL \u2014 This document contains proprietary career intelligence data.', cx, pageHeight - 20, { align: 'center' });
            addFooter();
            
            // ============================================================
            // SCOUTING REPORT: MATCH ANALYSIS (if targeting a job)
            // ============================================================
            if (isScoutingReport) {
                var match = targetJob.matchData;
                var matchScore = match.score || 0;
                var matchedSkills = match.matched || [];
                var gapSkills = match.gaps || [];
                var surplusSkills = match.surplus || [];
                
                // ---- PAGE: MATCH OVERVIEW ----
                newPage();
                sectionHead('Match Analysis', (targetJob.title || 'Target Position') + ' \u2014 ' + (targetJob.company || ''));
                
                // Score circle (large, centered)
                var scoreCx = pageWidth / 2;
                var scoreCy = yPos + 28;
                var scoreR = 22;
                var scoreColor = matchScore >= 70 ? C.green : matchScore >= 50 ? C.amber : C.rose;
                
                // Background ring
                setDraw(C.border);
                doc.setLineWidth(3);
                doc.circle(scoreCx, scoreCy, scoreR, 'S');
                
                // Score arc (filled portion)
                setDraw(scoreColor);
                doc.setLineWidth(3.5);
                var arcEnd = (matchScore / 100) * 360;
                // Draw arc as series of line segments
                for (var ai = 0; ai < arcEnd; ai += 2) {
                    var a1 = ((ai - 90) * Math.PI) / 180;
                    var a2 = ((ai + 2 - 90) * Math.PI) / 180;
                    doc.line(
                        scoreCx + Math.cos(a1) * scoreR,
                        scoreCy + Math.sin(a1) * scoreR,
                        scoreCx + Math.cos(a2) * scoreR,
                        scoreCy + Math.sin(a2) * scoreR
                    );
                }
                
                // Score text
                doc.setFontSize(28);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(scoreColor[0], scoreColor[1], scoreColor[2]);
                doc.text(matchScore + '%', scoreCx, scoreCy + 4, { align: 'center' });
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                setColor(C.textMuted);
                doc.text('MATCH SCORE', scoreCx, scoreCy + 11, { align: 'center' });
                
                // Flanking stats
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                setColor(C.green);
                doc.text(String(matchedSkills.length), scoreCx - 50, scoreCy + 2, { align: 'center' });
                doc.setFontSize(6.5);
                doc.setFont(undefined, 'normal');
                setColor(C.textMuted);
                doc.text('SKILLS ALIGNED', scoreCx - 50, scoreCy + 8, { align: 'center' });
                
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                setColor(C.rose);
                doc.text(String(gapSkills.length), scoreCx + 50, scoreCy + 2, { align: 'center' });
                doc.setFontSize(6.5);
                doc.setFont(undefined, 'normal');
                setColor(C.textMuted);
                doc.text('GAPS', scoreCx + 50, scoreCy + 8, { align: 'center' });
                
                yPos = scoreCy + scoreR + 14;
                
                // Executive match summary
                var strongMatches = matchedSkills.filter(function(m) { return m.profMatch >= 0.9 && m.requirement === 'Required'; });
                var partialMatches = matchedSkills.filter(function(m) { return m.profMatch < 0.9; });
                var requiredGaps = gapSkills.filter(function(g) { return g.requirement === 'Required'; });
                
                setFill(C.bgLight);
                setDraw(C.border);
                doc.setLineWidth(0.3);
                var summaryH = 32;
                doc.roundedRect(margin, yPos, maxWidth, summaryH, 3, 3, 'FD');
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                setColor(C.dark);
                doc.text('EXECUTIVE SUMMARY', margin + 8, yPos + 7);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                setColor(C.text);
                
                var summaryText = name + ' demonstrates a ' + matchScore + '% skill alignment with the '
                    + (targetJob.title || 'target') + ' position'
                    + (targetJob.company ? ' at ' + targetJob.company : '') + '. ';
                if (strongMatches.length > 0) {
                    summaryText += strongMatches.length + ' of ' + matchedSkills.length + ' matched skills meet or exceed the required proficiency level. ';
                }
                if (requiredGaps.length > 0) {
                    summaryText += requiredGaps.length + ' required skill' + (requiredGaps.length > 1 ? 's' : '') + ' represent development opportunities. ';
                }
                if (surplusSkills.length > 5) {
                    summaryText += 'Additionally, ' + surplusSkills.length + ' skills in the candidate\'s portfolio extend beyond the stated requirements, indicating breadth and adaptability.';
                }
                
                var sumLines = doc.splitTextToSize(summaryText, maxWidth - 16);
                doc.text(sumLines.slice(0, 4), margin + 8, yPos + 13);
                yPos += summaryH + 8;
                
                // ---- PAGE: SKILL ALIGNMENT TABLE ----
                if (matchedSkills.length > 0) {
                    checkPage(30);
                    if (yPos > 130) newPage();
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    setColor(C.dark);
                    doc.text('Skill Alignment (' + matchedSkills.length + ' matched)', margin, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 6;
                    
                    // Table header
                    setFill(C.dark);
                    doc.roundedRect(margin, yPos, maxWidth, 7, 1, 1, 'F');
                    doc.setFontSize(6.5);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(200, 210, 230);
                    doc.text('REQUIRED SKILL', margin + 4, yPos + 4.5);
                    doc.text('CANDIDATE SKILL', margin + 62, yPos + 4.5);
                    doc.text('LEVEL', margin + 118, yPos + 4.5);
                    doc.text('FIT', pageWidth - margin - 4, yPos + 4.5, { align: 'right' });
                    yPos += 9;
                    
                    // Sort: Required first, then by proficiency match desc
                    var sortedMatched = matchedSkills.slice().sort(function(a, b) {
                        if (a.requirement !== b.requirement) return a.requirement === 'Required' ? -1 : 1;
                        return b.profMatch - a.profMatch;
                    });
                    
                    sortedMatched.forEach(function(m, idx) {
                        checkPage(8);
                        var rowY = yPos;
                        
                        if (idx % 2 === 0) {
                            setFill(C.bgLight);
                            doc.rect(margin, rowY - 3, maxWidth, 7, 'F');
                        }
                        
                        // Requirement indicator
                        var reqColor = m.requirement === 'Required' ? C.brand : C.textMuted;
                        setFill(reqColor);
                        doc.circle(margin + 2, rowY + 0.5, 1, 'F');
                        
                        doc.setFontSize(7.5);
                        doc.setFont(undefined, 'normal');
                        setColor(C.text);
                        var jobName = (m.jobSkill || '').length > 28 ? m.jobSkill.slice(0, 26) + '\u2026' : m.jobSkill;
                        doc.text(jobName, margin + 5, rowY + 1);
                        
                        setColor(C.brand);
                        var userName = (m.userSkill || '').length > 26 ? m.userSkill.slice(0, 24) + '\u2026' : m.userSkill;
                        doc.text(userName, margin + 62, rowY + 1);
                        
                        // Level comparison
                        doc.setFontSize(6.5);
                        var lc = levelColor[m.userLevel] || C.textMuted;
                        doc.setTextColor(lc[0], lc[1], lc[2]);
                        doc.text(m.userLevel || '', margin + 118, rowY + 1);
                        
                        // Fit indicator
                        var fitColor = m.profMatch >= 0.9 ? C.green : m.profMatch >= 0.6 ? C.amber : C.rose;
                        var fitText = m.profMatch >= 0.9 ? '\u2713' : m.profMatch >= 0.6 ? '\u223C' : '\u2191';
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(fitColor[0], fitColor[1], fitColor[2]);
                        doc.text(fitText, pageWidth - margin - 4, rowY + 1.5, { align: 'right' });
                        
                        yPos += 7;
                    });
                    yPos += 4;
                }
                
                // ---- GAP ANALYSIS ----
                if (gapSkills.length > 0) {
                    checkPage(30);
                    if (yPos > 200) newPage();
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    setColor(C.dark);
                    doc.text('Gap Analysis (' + gapSkills.length + ' skills)', margin, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 6;
                    
                    // Table header
                    setFill([60, 20, 30]);
                    doc.roundedRect(margin, yPos, maxWidth, 7, 1, 1, 'F');
                    doc.setFontSize(6.5);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(230, 180, 180);
                    doc.text('SKILL NEEDED', margin + 4, yPos + 4.5);
                    doc.text('PRIORITY', margin + 90, yPos + 4.5);
                    doc.text('LEVEL REQUIRED', margin + 120, yPos + 4.5);
                    yPos += 9;
                    
                    gapSkills.forEach(function(g, idx) {
                        checkPage(8);
                        var rowY = yPos;
                        
                        if (idx % 2 === 0) {
                            setFill([255, 248, 248]);
                            doc.rect(margin, rowY - 3, maxWidth, 7, 'F');
                        }
                        
                        doc.setFontSize(7.5);
                        doc.setFont(undefined, 'normal');
                        setColor(C.text);
                        doc.text(g.name || '', margin + 4, rowY + 1);
                        
                        // Priority badge
                        var priColor = g.requirement === 'Required' ? C.rose : C.amber;
                        doc.setFontSize(6);
                        doc.setTextColor(priColor[0], priColor[1], priColor[2]);
                        doc.setFont(undefined, 'bold');
                        doc.text(g.requirement || 'Preferred', margin + 90, rowY + 1);
                        
                        doc.setFont(undefined, 'normal');
                        setColor(C.textMuted);
                        doc.setFontSize(6.5);
                        doc.text(g.proficiency || 'Proficient', margin + 120, rowY + 1);
                        
                        yPos += 7;
                    });
                    yPos += 4;
                }
                
                // ---- SURPLUS VALUE / DIFFERENTIATORS ----
                if (surplusSkills.length > 0) {
                    checkPage(30);
                    if (yPos > 200) newPage();
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    setColor(C.dark);
                    doc.text('Additional Value \u2014 Beyond Requirements', margin, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 3;
                    doc.setFontSize(8);
                    setColor(C.textLight);
                    doc.text('Skills in the candidate\u2019s portfolio not listed in the job requirements, representing untapped value.', margin, yPos);
                    yPos += 7;
                    
                    // Show top surplus skills sorted by level
                    var levelVal = { 'Mastery': 5, 'Advanced': 4, 'Proficient': 3, 'Developing': 2, 'Foundational': 1 };
                    var topSurplus = surplusSkills.slice().sort(function(a, b) { return (levelVal[b.level] || 0) - (levelVal[a.level] || 0); }).slice(0, 20);
                    
                    // 3-column layout
                    var col3W = (maxWidth - 8) / 3;
                    topSurplus.forEach(function(s, idx) {
                        var colIdx = idx % 3;
                        var xPos = margin + colIdx * (col3W + 4);
                        
                        if (colIdx === 0) checkPage(7);
                        
                        doc.setFontSize(7);
                        setColor(C.text);
                        var sName = s.name.length > 24 ? s.name.slice(0, 22) + '\u2026' : s.name;
                        doc.text(sName, xPos, yPos);
                        
                        var lc2 = levelColor[s.level] || C.textMuted;
                        doc.setFontSize(5.5);
                        doc.setTextColor(lc2[0], lc2[1], lc2[2]);
                        doc.text(s.level || '', xPos + doc.getTextWidth(sName) + 2, yPos);
                        
                        if (colIdx === 2 || idx === topSurplus.length - 1) yPos += 5;
                    });
                    yPos += 4;
                }
                
                // ---- TALKING POINTS ----
                checkPage(40);
                if (yPos > 180) newPage();
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                setColor(C.dark);
                doc.text('Recommended Talking Points', margin, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 3;
                doc.setFontSize(8);
                setColor(C.textLight);
                doc.text('Key narratives for interview preparation and recruiter conversations.', margin, yPos);
                yPos += 8;
                
                var talkingPoints = [];
                
                // Generate talking points based on data
                if (strongMatches.length >= 3) {
                    var topNames = strongMatches.slice(0, 3).map(function(m) { return m.userSkill; }).join(', ');
                    talkingPoints.push({
                        title: 'Core Alignment',
                        text: 'Direct proficiency match in ' + strongMatches.length + ' required skills, including ' + topNames + '. These represent immediate contribution areas with no ramp-up needed.'
                    });
                }
                
                if (surplusSkills.length > 10) {
                    var topSurp = surplusSkills.filter(function(s) { return s.level === 'Mastery' || s.level === 'Advanced'; }).slice(0, 3);
                    if (topSurp.length > 0) {
                        talkingPoints.push({
                            title: 'Hidden Depth',
                            text: skills.length + ' total documented skills vs ' + (targetJob.parsedSkills || []).length + ' listed in the job description. Advanced capabilities in ' + topSurp.map(function(s) { return s.name; }).join(', ') + ' provide strategic value beyond the defined role.'
                        });
                    }
                }
                
                if (requiredGaps.length > 0 && requiredGaps.length <= 5) {
                    talkingPoints.push({
                        title: 'Growth Trajectory',
                        text: requiredGaps.length + ' gap' + (requiredGaps.length > 1 ? 's' : '') + ' identified (' + requiredGaps.map(function(g) { return g.name; }).join(', ') + '). With ' + skills.length + ' existing skills, the candidate\u2019s learning velocity and adjacent competencies suggest rapid closure.'
                    });
                }
                
                if (comp && comp.marketRate) {
                    talkingPoints.push({
                        title: 'Market Position',
                        text: 'Skill portfolio supports a competitive compensation range of $' + Math.round(comp.conservativeOffer || comp.marketRate * 1.1).toLocaleString() + '\u2013$' + Math.round(comp.competitiveOffer || comp.marketRate * 1.3).toLocaleString() + ' based on ' + skills.length + ' documented skills, ' + (masteryCount + advancedCount) + ' at expert level or above.'
                    });
                }
                
                if (matchScore >= 70) {
                    talkingPoints.push({
                        title: 'Recommendation',
                        text: 'At ' + matchScore + '% alignment with ' + matchedSkills.length + ' skill matches, this candidate is a strong fit for the role. Recommend advancing to interview stage with focus on ' + (requiredGaps.length > 0 ? 'assessing gap areas in ' + requiredGaps[0].name : 'verifying depth in top matched skills') + '.'
                    });
                } else if (matchScore >= 50) {
                    talkingPoints.push({
                        title: 'Recommendation',
                        text: 'At ' + matchScore + '% alignment, this candidate shows solid foundational fit with development potential. ' + (surplusSkills.length > 15 ? 'The breadth of ' + surplusSkills.length + ' additional skills suggests strong adaptability.' : 'Recommend evaluating transferable skills in conversation.')
                    });
                }
                
                talkingPoints.forEach(function(tp) {
                    checkPage(18);
                    
                    // Title with accent bar
                    setFill(C.accent);
                    doc.rect(margin, yPos, 2, 5, 'F');
                    doc.setFontSize(8.5);
                    doc.setFont(undefined, 'bold');
                    setColor(C.dark);
                    doc.text(tp.title, margin + 5, yPos + 3.5);
                    doc.setFont(undefined, 'normal');
                    yPos += 7;
                    
                    doc.setFontSize(8);
                    setColor(C.text);
                    var tpLines = doc.splitTextToSize(tp.text, maxWidth - 6);
                    doc.text(tpLines, margin + 5, yPos);
                    yPos += tpLines.length * 3.8 + 6;
                });
            } // end scouting report pages
            
            // ============================================================
            // PAGE 2: SKILL ARCHITECTURE
            // ============================================================
            newPage();
            sectionHead('Skill Architecture', 'Professional Competencies by Domain');
            
            // Summary line
            doc.setFontSize(9);
            setColor(C.textLight);
            doc.text(skills.length + ' documented skills across ' + roles.length + ' professional domains. '
                + masteryCount + ' at mastery level, ' + advancedCount + ' advanced.', margin, yPos);
            yPos += 8;
            
            // Group skills by primary role
            var roleGroups = {};
            roles.forEach(function(role) { roleGroups[role.id] = { role: role, skills: [] }; });
            
            skills.forEach(function(skill) {
                var primaryRole = (skill.roles && skill.roles[0]) || 'general';
                if (roleGroups[primaryRole]) {
                    roleGroups[primaryRole].skills.push(skill);
                } else {
                    // Find first valid role
                    var placed = false;
                    (skill.roles || []).forEach(function(rid) {
                        if (!placed && roleGroups[rid]) {
                            roleGroups[rid].skills.push(skill);
                            placed = true;
                        }
                    });
                    if (!placed) {
                        var firstKey = Object.keys(roleGroups)[0];
                        if (firstKey) roleGroups[firstKey].skills.push(skill);
                    }
                }
            });
            
            // Active roles (used by network viz and distribution pages)
            var roleList = Object.keys(roleGroups).filter(function(k) { return roleGroups[k].skills.length > 0; });
            
            // Render each role group
            Object.keys(roleGroups).forEach(function(roleId) {
                var group = roleGroups[roleId];
                if (group.skills.length === 0) return;
                
                var roleName = group.role.name;
                var roleColor = group.role.color || '#60a5fa';
                var rc = [
                    parseInt(roleColor.slice(1,3), 16) || 96,
                    parseInt(roleColor.slice(3,5), 16) || 165,
                    parseInt(roleColor.slice(5,7), 16) || 250
                ];
                
                checkPage(18);
                
                // Role header with colored bar
                setFill(rc);
                doc.rect(margin, yPos - 1, 2, 6, 'F');
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                setColor(C.dark);
                doc.text(roleName + ' (' + group.skills.length + ')', margin + 5, yPos + 3);
                doc.setFont(undefined, 'normal');
                yPos += 9;
                
                // Skills in 2-column layout with level pills
                var col1X = margin + 4;
                var col2X = margin + (maxWidth / 2) + 2;
                var startY = yPos;
                var rowH = 5.8;
                
                // Sort: Mastery first, then Advanced, etc.
                var levelOrder = { 'Mastery': 0, 'Advanced': 1, 'Proficient': 2, 'Developing': 3, 'Foundational': 4 };
                group.skills.sort(function(a, b) {
                    return (levelOrder[a.level] || 4) - (levelOrder[b.level] || 4);
                });
                
                group.skills.forEach(function(skill, idx) {
                    var xPos = idx % 2 === 0 ? col1X : col2X;
                    var rowY = startY + Math.floor(idx / 2) * rowH;
                    
                    if (rowY + 4 > pageHeight - 25) {
                        yPos = rowY;
                        newPage();
                        startY = yPos;
                        rowY = startY + Math.floor(0) * rowH; // Reset row counting
                    }
                    
                    // Skill name
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    setColor(C.text);
                    var displayName = skill.name.length > 32 ? skill.name.slice(0, 30) + '\u2026' : skill.name;
                    doc.text(displayName, xPos, rowY);
                    
                    // Level text (small, colored)
                    var lc = levelColor[skill.level] || C.textMuted;
                    doc.setFontSize(6);
                    doc.setTextColor(lc[0], lc[1], lc[2]);
                    var nameW = doc.getTextWidth(displayName);
                    if (nameW < (maxWidth / 2) - 22) {
                        doc.text(skill.level || '', xPos + nameW + 2, rowY);
                    }
                });
                
                yPos = startY + Math.ceil(group.skills.length / 2) * rowH + 4;
            });
            
            // ============================================================
            // PAGE: SKILL NETWORK VISUALIZATION
            // ============================================================
            (function drawNetworkPage() {
                newPage();
                sectionHead('Skill Network', 'Professional Capability Architecture');
                
                doc.setFontSize(8.5);
                setColor(C.textLight);
                doc.text('Interactive network visualization of ' + skills.length + ' skills across ' + roles.length + ' professional domains.', margin, yPos);
                yPos += 4;
                doc.text('Node size reflects proficiency level. Connections show skills that share a domain.', margin, yPos);
                yPos += 8;
                
                // Compute layout — simple radial force-directed
                var graphCx = pageWidth / 2;
                var graphCy = yPos + 68;
                var graphR = 58;
                var graphNodes = [];
                var graphLinks = [];
                
                // Role nodes (hubs) — evenly spaced around inner ring
                roleList.forEach(function(roleId, i) {
                    var group = roleGroups[roleId];
                    var angle = (i / roleList.length) * Math.PI * 2 - Math.PI / 2;
                    var dist = graphR * 0.38;
                    var rc = group.role.color || '#60a5fa';
                    var rgb = [
                        parseInt(rc.slice(1,3), 16) || 96,
                        parseInt(rc.slice(3,5), 16) || 165,
                        parseInt(rc.slice(5,7), 16) || 250
                    ];
                    graphNodes.push({
                        x: graphCx + Math.cos(angle) * dist,
                        y: graphCy + Math.sin(angle) * dist,
                        r: 4.5,
                        color: rgb,
                        type: 'role',
                        label: group.role.name,
                        roleIdx: i
                    });
                });
                
                // Skill nodes — spread around their parent role
                var levelSizes = { 'Mastery': 2.8, 'Advanced': 2.2, 'Proficient': 1.8, 'Developing': 1.4, 'Foundational': 1.0 };
                var skillNodeStart = graphNodes.length;
                
                // Deterministic hash for consistent layout
                function hashStr(s) { var h = 0; for (var i = 0; i < s.length; i++) { h = ((h << 5) - h + s.charCodeAt(i)) | 0; } return h; }
                function hashFloat(s, min, max) { var h = Math.abs(hashStr(s)) % 10000; return min + (h / 10000) * (max - min); }
                
                roleList.forEach(function(roleId, ri) {
                    var group = roleGroups[roleId];
                    var parentAngle = (ri / roleList.length) * Math.PI * 2 - Math.PI / 2;
                    
                    // Sort skills by level for consistent ordering
                    var sortedSkills = group.skills.slice().sort(function(a, b) {
                        var lv = { 'Mastery': 0, 'Advanced': 1, 'Proficient': 2, 'Developing': 3, 'Foundational': 4 };
                        return (lv[a.level] || 4) - (lv[b.level] || 4) || a.name.localeCompare(b.name);
                    });
                    
                    sortedSkills.forEach(function(skill, si) {
                        var spreadAngle = parentAngle + ((si / Math.max(sortedSkills.length, 1)) - 0.5) * 1.8;
                        var dist = graphR * (0.55 + hashFloat(skill.name + ri, 0, 0.4));
                        var jitter = hashFloat(skill.name + 'j', -4, 4);
                        
                        var lc = levelColor[skill.level] || C.textMuted;
                        graphNodes.push({
                            x: graphCx + Math.cos(spreadAngle) * dist + jitter,
                            y: graphCy + Math.sin(spreadAngle) * dist + jitter * 0.6,
                            r: levelSizes[skill.level] || 1.4,
                            color: lc,
                            type: 'skill',
                            label: skill.name,
                            roleIdx: ri
                        });
                        
                        // Link skill to its role hub
                        graphLinks.push({ from: ri, to: graphNodes.length - 1 });
                    });
                });
                
                // Add cross-links between nearby skills (deterministic)
                for (var si = skillNodeStart; si < graphNodes.length; si++) {
                    for (var sj = si + 1; sj < Math.min(si + 6, graphNodes.length); sj++) {
                        var ddx = graphNodes[si].x - graphNodes[sj].x;
                        var ddy = graphNodes[si].y - graphNodes[sj].y;
                        var dd = Math.sqrt(ddx * ddx + ddy * ddy);
                        if (dd < 18 && ((si * 7 + sj * 13) % 10 < 3)) {
                            graphLinks.push({ from: si, to: sj });
                        }
                    }
                }
                
                // Draw background circle
                setDraw([40, 50, 70]);
                doc.setLineWidth(0.15);
                doc.circle(graphCx, graphCy, graphR + 6, 'S');
                
                // Draw links
                graphLinks.forEach(function(link) {
                    var a = graphNodes[link.from];
                    var b = graphNodes[link.to];
                    var isRoleLink = a.type === 'role' || b.type === 'role';
                    doc.setLineWidth(isRoleLink ? 0.15 : 0.08);
                    doc.setDrawColor(96, 165, 250);
                    doc.line(a.x, a.y, b.x, b.y);
                });
                
                // Draw skill nodes (smaller, behind role nodes)
                graphNodes.forEach(function(n) {
                    if (n.type === 'skill') {
                        setFill(n.color);
                        doc.circle(n.x, n.y, n.r, 'F');
                    }
                });
                
                // Draw role nodes (on top, with labels)
                graphNodes.forEach(function(n) {
                    if (n.type === 'role') {
                        // Glow ring
                        setDraw(n.color);
                        doc.setLineWidth(0.3);
                        doc.circle(n.x, n.y, n.r + 2, 'S');
                        // Filled node
                        setFill(n.color);
                        doc.circle(n.x, n.y, n.r, 'F');
                        // Label
                        doc.setFontSize(6.5);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(n.color[0], n.color[1], n.color[2]);
                        doc.text(n.label, n.x, n.y - n.r - 3.5, { align: 'center' });
                        doc.setFont(undefined, 'normal');
                    }
                });
                
                yPos = graphCy + graphR + 14;
                
                // Legend
                checkPage(14);
                doc.setFontSize(6.5);
                setColor(C.textMuted);
                doc.text('PROFICIENCY LEVELS:', margin, yPos);
                var legendX = margin + 32;
                var legendItems = [
                    { label: 'Mastery', color: C.amber, r: 2.8 },
                    { label: 'Advanced', color: C.accent, r: 2.2 },
                    { label: 'Proficient', color: C.green, r: 1.8 },
                    { label: 'Developing', color: C.purple, r: 1.4 },
                    { label: 'Foundational', color: C.textMuted, r: 1.0 }
                ];
                legendItems.forEach(function(item) {
                    setFill(item.color);
                    doc.circle(legendX, yPos - 1, item.r, 'F');
                    doc.setFontSize(6);
                    setColor(C.text);
                    doc.text(item.label, legendX + item.r + 2, yPos);
                    legendX += doc.getTextWidth(item.label) + item.r + 8;
                });
                yPos += 4;
            })();
            
            // ============================================================
            // PAGE: PROFICIENCY & ROLE DISTRIBUTION
            // ============================================================
            (function drawDistributionPage() {
                newPage();
                sectionHead('Skill Distribution', 'Proficiency Breakdown & Role Coverage');
                
                // --- PROFICIENCY BAR CHART ---
                var levelOrder = ['Mastery', 'Advanced', 'Proficient', 'Developing', 'Foundational'];
                var levelCounts = {};
                levelOrder.forEach(function(l) { levelCounts[l] = 0; });
                skills.forEach(function(s) { if (levelCounts[s.level] !== undefined) levelCounts[s.level]++; });
                var maxCount = Math.max.apply(null, levelOrder.map(function(l) { return levelCounts[l]; })) || 1;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                setColor(C.dark);
                doc.text('Proficiency Distribution', margin, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 7;
                
                var barMaxW = maxWidth - 55;
                var barH = 8;
                
                levelOrder.forEach(function(level) {
                    var count = levelCounts[level] || 0;
                    var barW = (count / maxCount) * barMaxW;
                    var lc = levelColor[level] || C.textMuted;
                    
                    // Label
                    doc.setFontSize(7.5);
                    setColor(C.text);
                    doc.text(level, margin, yPos + 5.5);
                    
                    // Bar background
                    setFill(C.bgLight);
                    doc.roundedRect(margin + 30, yPos + 1, barMaxW, barH, 1.5, 1.5, 'F');
                    
                    // Filled bar
                    if (barW > 2) {
                        setFill(lc);
                        doc.roundedRect(margin + 30, yPos + 1, barW, barH, 1.5, 1.5, 'F');
                    }
                    
                    // Count label
                    doc.setFontSize(7);
                    doc.setFont(undefined, 'bold');
                    setColor(count > 0 ? C.dark : C.textMuted);
                    doc.text(String(count), margin + 32 + barMaxW, yPos + 5.5);
                    doc.setFont(undefined, 'normal');
                    
                    yPos += barH + 3;
                });
                
                yPos += 10;
                
                // --- ROLE BREAKDOWN ---
                var roleSorted = roleList.map(function(roleId) {
                    return roleGroups[roleId];
                }).filter(function(g) { return g.skills.length > 0; }).sort(function(a, b) {
                    return b.skills.length - a.skills.length;
                });
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                setColor(C.dark);
                doc.text('Skills by Professional Domain', margin, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 7;
                
                var roleMaxCount = roleSorted.length > 0 ? roleSorted[0].skills.length : 1;
                
                roleSorted.forEach(function(group) {
                    checkPage(14);
                    var rc = group.role.color || '#60a5fa';
                    var rgb = [
                        parseInt(rc.slice(1,3), 16) || 96,
                        parseInt(rc.slice(3,5), 16) || 165,
                        parseInt(rc.slice(5,7), 16) || 250
                    ];
                    var count = group.skills.length;
                    var barW = (count / roleMaxCount) * barMaxW;
                    var pct = Math.round((count / skills.length) * 100);
                    
                    // Color indicator
                    setFill(rgb);
                    doc.rect(margin, yPos + 2, 2, 6, 'F');
                    
                    // Role label
                    doc.setFontSize(7.5);
                    setColor(C.text);
                    var roleLabel = group.role.name;
                    if (roleLabel.length > 18) roleLabel = roleLabel.slice(0, 16) + '\u2026';
                    doc.text(roleLabel, margin + 5, yPos + 6);
                    
                    // Bar background
                    setFill(C.bgLight);
                    doc.roundedRect(margin + 38, yPos + 2, barMaxW - 8, 6, 1, 1, 'F');
                    
                    // Filled bar
                    if (barW > 2) {
                        setFill(rgb);
                        doc.roundedRect(margin + 38, yPos + 2, barW - 8, 6, 1, 1, 'F');
                    }
                    
                    // Count + percentage
                    doc.setFontSize(6.5);
                    doc.setFont(undefined, 'bold');
                    setColor(C.dark);
                    doc.text(count + ' (' + pct + '%)', margin + 32 + barMaxW, yPos + 6);
                    doc.setFont(undefined, 'normal');
                    
                    yPos += 10;
                });
                
                yPos += 8;
                
                // --- LEVEL SUMMARY TABLE ---
                checkPage(30);
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                setColor(C.dark);
                doc.text('Portfolio Summary', margin, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 6;
                
                var summaryRows = [
                    ['Total Skills Documented', String(skills.length)],
                    ['Professional Domains', String(roles.length)],
                    ['Mastery-Level Skills', String(levelCounts['Mastery'] || 0)],
                    ['Advanced + Mastery', String((levelCounts['Mastery'] || 0) + (levelCounts['Advanced'] || 0))],
                    ['Evidence Items', String(evidenceCount)],
                    ['Documented Outcomes', String(outcomeCount)]
                ];
                
                summaryRows.forEach(function(row, idx) {
                    if (idx % 2 === 0) {
                        setFill(C.bgLight);
                        doc.rect(margin, yPos - 3, maxWidth, 7, 'F');
                    }
                    doc.setFontSize(8);
                    setColor(C.text);
                    doc.text(row[0], margin + 3, yPos + 1);
                    doc.setFont(undefined, 'bold');
                    setColor(C.brand);
                    doc.text(row[1], pageWidth - margin - 3, yPos + 1, { align: 'right' });
                    doc.setFont(undefined, 'normal');
                    yPos += 7.5;
                });
            })();
            
            // ============================================================
            // PAGE: OUTCOMES & EVIDENCE
            // ============================================================
            if (data.outcomes && data.outcomes.length > 0) {
                newPage();
                sectionHead('Evidence & Outcomes', 'Measurable Impact & Achievements');
                
                doc.setFontSize(9);
                setColor(C.textLight);
                doc.text(data.outcomes.length + ' documented outcomes with measurable evidence.', margin, yPos);
                yPos += 7;
                
                // Group outcomes by category
                var catGroups = {};
                data.outcomes.forEach(function(o) {
                    var cat = o.category || 'General';
                    if (!catGroups[cat]) catGroups[cat] = [];
                    catGroups[cat].push(o);
                });
                
                Object.keys(catGroups).forEach(function(cat) {
                    checkPage(16);
                    
                    // Category header
                    doc.setFontSize(8.5);
                    doc.setFont(undefined, 'bold');
                    setColor(C.brand);
                    doc.text(cat.toUpperCase(), margin, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 5;
                    
                    catGroups[cat].forEach(function(outcome) {
                        checkPage(14);
                        
                        // Accent bullet
                        setFill(C.accent);
                        doc.circle(margin + 2, yPos - 1.2, 0.8, 'F');
                        
                        // Outcome text
                        doc.setFontSize(8.5);
                        setColor(C.text);
                        var oText = outcome.text || '';
                        if (oText.length > 200) oText = oText.slice(0, 197) + '\u2026';
                        var oLines = doc.splitTextToSize(oText, maxWidth - 8);
                        doc.text(oLines, margin + 5, yPos);
                        yPos += oLines.length * 3.8 + 1;
                        
                        // Skill attribution
                        if (outcome.skill) {
                            doc.setFontSize(6.5);
                            setColor(C.textMuted);
                            doc.text('Skill: ' + outcome.skill, margin + 5, yPos);
                            yPos += 3.5;
                        }
                        yPos += 1.5;
                    });
                    yPos += 3;
                });
            }
            
            // ============================================================
            // PAGE: VALUES & PURPOSE
            // ============================================================
            if ((data.values && data.values.length > 0) || (data.purpose && data.purpose.trim())) {
                checkPage(50);
                if (yPos > 80) newPage();
                sectionHead('Values & Philosophy', 'Core Principles & Professional Identity');
                
                if (data.purpose && data.purpose.trim()) {
                    doc.setFontSize(9.5);
                    doc.setFont(undefined, 'italic');
                    setColor(C.text);
                    setDraw(C.accent);
                    doc.setLineWidth(0.5);
                    var pLines = doc.splitTextToSize(data.purpose.trim(), maxWidth - 8);
                    doc.line(margin, yPos - 1, margin, yPos + pLines.length * 4.5 + 1);
                    doc.text(pLines, margin + 5, yPos + 3);
                    yPos += pLines.length * 4.5 + 10;
                    doc.setFont(undefined, 'normal');
                }
                
                if (data.values && data.values.length > 0) {
                    data.values.forEach(function(value) {
                        checkPage(16);
                        
                        // Value name
                        doc.setFontSize(9.5);
                        doc.setFont(undefined, 'bold');
                        setColor(C.dark);
                        doc.text(value.name, margin, yPos);
                        yPos += 4.5;
                        
                        // Description
                        var desc = value.description || getCatalogDescription(value.name) || '';
                        if (desc) {
                            doc.setFontSize(8.5);
                            doc.setFont(undefined, 'normal');
                            setColor(C.textLight);
                            var dLines = doc.splitTextToSize(desc, maxWidth - 4);
                            doc.text(dLines, margin + 1, yPos);
                            yPos += dLines.length * 3.8;
                        }
                        
                        // Personal note
                        if (value.note) {
                            doc.setFontSize(8);
                            doc.setFont(undefined, 'italic');
                            setColor(C.accent);
                            var nLines = doc.splitTextToSize('\u201C' + value.note + '\u201D', maxWidth - 10);
                            checkPage(nLines.length * 3.8 + 4);
                            doc.text(nLines, margin + 4, yPos + 2);
                            yPos += nLines.length * 3.8 + 2;
                            doc.setFont(undefined, 'normal');
                        }
                        yPos += 4;
                    });
                }
            }
            
            // ============================================================
            // PAGE: MARKET VALUATION DETAIL
            // ============================================================
            if (comp && comp.marketRate) {
                checkPage(80);
                if (yPos > 60) newPage();
                sectionHead('Market Valuation', 'Skill Portfolio Analysis & Compensation Positioning');
                
                // Compensation table
                var tableData = [
                    ['Base Market Rate', '$' + Math.round(comp.marketRate).toLocaleString(), 'Median for detected function and seniority'],
                    ['Conservative Offer', '$' + Math.round(comp.conservativeOffer || comp.marketRate * 1.1).toLocaleString(), 'With evidence-based premium applied'],
                    ['Standard Offer', '$' + Math.round(comp.standardOffer || comp.marketRate * 1.2).toLocaleString(), 'Market-competitive positioning'],
                    ['Competitive Offer', '$' + Math.round(comp.competitiveOffer || comp.marketRate * 1.3).toLocaleString(), 'Reflects full skill portfolio value']
                ];
                
                // Table header
                setFill(C.dark);
                doc.roundedRect(margin, yPos, maxWidth, 7, 1.5, 1.5, 'F');
                doc.setFontSize(7);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(200, 210, 230);
                doc.text('METRIC', margin + 4, yPos + 4.5);
                doc.text('VALUE', margin + 68, yPos + 4.5);
                doc.text('BASIS', margin + 100, yPos + 4.5);
                yPos += 9;
                
                tableData.forEach(function(row, idx) {
                    var rowY = yPos;
                    if (idx % 2 === 0) {
                        setFill(C.bgLight);
                        doc.rect(margin, rowY - 3, maxWidth, 7, 'F');
                    }
                    
                    doc.setFontSize(8.5);
                    doc.setFont(undefined, 'normal');
                    setColor(C.text);
                    doc.text(row[0], margin + 4, rowY + 1);
                    
                    doc.setFont(undefined, 'bold');
                    setColor(C.brand);
                    doc.text(row[1], margin + 68, rowY + 1);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(7);
                    setColor(C.textMuted);
                    doc.text(row[2], margin + 100, rowY + 1);
                    
                    yPos += 8;
                });
                
                yPos += 6;
                
                // Premium breakdown
                if (comp.criticalSkills && comp.criticalSkills.length > 0) {
                    checkPage(20);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    setColor(C.dark);
                    doc.text('Premium Skills (High Market Demand)', margin, yPos);
                    yPos += 5;
                    
                    doc.setFontSize(7.5);
                    doc.setFont(undefined, 'normal');
                    setColor(C.text);
                    comp.criticalSkills.slice(0, 8).forEach(function(s) {
                        checkPage(6);
                        doc.text('\u2022  ' + s, margin + 3, yPos);
                        yPos += 4;
                    });
                    yPos += 3;
                }
                
                // Top 10 skills by value
                if (comp.top10Skills && comp.top10Skills.length > 0) {
                    checkPage(25);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    setColor(C.dark);
                    doc.text('Highest-Value Skills', margin, yPos);
                    yPos += 5;
                    
                    comp.top10Skills.slice(0, 10).forEach(function(s, i) {
                        checkPage(6);
                        doc.setFontSize(7.5);
                        doc.setFont(undefined, 'normal');
                        setColor(C.text);
                        var sName = (typeof s === 'string') ? s : (s.name || s.skill || '');
                        var sVal = (typeof s === 'object' && s.value) ? '  $' + Math.round(s.value).toLocaleString() : '';
                        doc.text((i + 1) + '.  ' + sName, margin + 3, yPos);
                        if (sVal) {
                            doc.setFont(undefined, 'bold');
                            setColor(C.brand);
                            doc.text(sVal, margin + 90, yPos);
                        }
                        yPos += 4.2;
                    });
                }
            }
            
            // ============================================================
            // PAGE: JOB MATCHES (if any)
            // ============================================================
            var savedJobs = (userData.savedJobs || []).filter(function(j) { return j && j.title; });
            if (savedJobs.length > 0) {
                checkPage(40);
                if (yPos > 60) newPage();
                sectionHead('Job Pipeline', 'Current Opportunities & Match Analysis');
                
                doc.setFontSize(9);
                setColor(C.textLight);
                doc.text(savedJobs.length + ' positions in pipeline.', margin, yPos);
                yPos += 7;
                
                savedJobs.slice(0, 8).forEach(function(job) {
                    checkPage(20);
                    
                    // Job card
                    setFill(C.bgLight);
                    setDraw(C.border);
                    doc.setLineWidth(0.2);
                    doc.roundedRect(margin, yPos - 2, maxWidth, 16, 2, 2, 'FD');
                    
                    // Title
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    setColor(C.dark);
                    var jobTitle = job.title.length > 50 ? job.title.slice(0, 48) + '\u2026' : job.title;
                    doc.text(jobTitle, margin + 4, yPos + 3);
                    
                    // Company
                    doc.setFontSize(7.5);
                    doc.setFont(undefined, 'normal');
                    setColor(C.textLight);
                    doc.text(job.company || '', margin + 4, yPos + 8);
                    
                    // Match score
                    if (job.matchScore || job.score) {
                        var score = job.matchScore || job.score || 0;
                        var scoreColor = score >= 70 ? C.green : score >= 50 ? C.amber : C.textMuted;
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(scoreColor[0], scoreColor[1], scoreColor[2]);
                        doc.text(Math.round(score) + '%', pageWidth - margin - 4, yPos + 5, { align: 'right' });
                        doc.setFontSize(6);
                        doc.setFont(undefined, 'normal');
                        doc.text('MATCH', pageWidth - margin - 4, yPos + 9.5, { align: 'right' });
                    }
                    
                    yPos += 20;
                });
            }
            
            // ============================================================
            // FINAL PAGE: BACK COVER
            // ============================================================
            newPage();
            
            // Centered content
            var finalY = pageHeight / 2 - 30;
            
            // Mini logo
            setFill(C.accent);
            doc.circle(cx, finalY, 3, 'F');
            setDraw(C.accent);
            doc.setLineWidth(0.2);
            doc.circle(cx, finalY, 12, 'S');
            doc.line(cx, finalY, cx - 8, finalY - 7);
            doc.line(cx, finalY, cx + 9, finalY - 6);
            doc.line(cx, finalY, cx + 8, finalY + 8);
            doc.line(cx, finalY, cx - 7, finalY + 8);
            setFill([147, 187, 252]);
            doc.circle(cx - 8, finalY - 7, 1.5, 'F');
            doc.circle(cx + 8, finalY + 8, 1.5, 'F');
            setFill(C.purple);
            doc.circle(cx + 9, finalY - 6, 1.3, 'F');
            doc.circle(cx - 7, finalY + 8, 1.3, 'F');
            
            finalY += 22;
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            setColor(C.brand);
            doc.text('BLUEPRINT\u2122', cx, finalY, { align: 'center' });
            
            finalY += 6;
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            setColor(C.textMuted);
            doc.text('Career Intelligence Platform', cx, finalY, { align: 'center' });
            
            finalY += 12;
            doc.setFontSize(9);
            setColor(C.textLight);
            doc.text('This report was generated from ' + name + '\'s Blueprint profile.', cx, finalY, { align: 'center' });
            finalY += 5;
            if (isScoutingReport) {
                doc.text('Targeted analysis for: ' + (targetJob.title || 'Target Position') + (targetJob.company ? ' at ' + targetJob.company : ''), cx, finalY, { align: 'center' });
                finalY += 5;
            }
            doc.text('It represents a living capability analysis, not a static document.', cx, finalY, { align: 'center' });
            
            finalY += 12;
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            setColor(C.accent);
            doc.text('myblueprint.work', cx, finalY, { align: 'center' });
            
            finalY += 14;
            doc.setFontSize(7);
            doc.setFont(undefined, 'normal');
            setColor(C.textMuted);
            doc.text('\u00A9 ' + new Date().getFullYear() + ' Cliff Jurkiewicz. All rights reserved.', cx, finalY, { align: 'center' });
            finalY += 4;
            doc.text('Blueprint\u2122 and its associated methodologies are the intellectual property of Cliff Jurkiewicz.', cx, finalY, { align: 'center' });
            
            addFooter();
            
            // ============================================================
            // SAVE
            // ============================================================
            var dateStr = new Date().toISOString().split('T')[0];
            var fileName;
            if (isScoutingReport) {
                var jobSlug = (targetJob.company || targetJob.title || 'job').replace(/[^a-zA-Z0-9]+/g, '_').slice(0, 30);
                fileName = ('Blueprint_' + name.replace(/\s+/g, '_') + '_ScoutingReport_' + jobSlug + '_' + dateStr + '.pdf').replace(/[^a-zA-Z0-9_\-.]/g, '');
            } else {
                fileName = ('Blueprint_' + name.replace(/\s+/g, '_') + '_' + dateStr + '.pdf').replace(/[^a-zA-Z0-9_\-.]/g, '');
            }
            doc.save(fileName);
            showToast(isScoutingReport ? 'Scouting Report downloaded.' : 'Career Intelligence Report downloaded.', 'success');
        }
        
        function copyBlueprintText() {
            var name = (userData.profile && userData.profile.name) || 'Professional';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            var location = (userData.profile && userData.profile.location) || '';
            
            var lines = [];
            lines.push(name.toUpperCase());
            if (title) lines.push(title);
            if (location) lines.push(location);
            lines.push('');
            
            // Purpose
            if (blueprintData.purpose && blueprintData.purpose.trim()) {
                lines.push('PURPOSE');
                lines.push(blueprintData.purpose.trim());
                lines.push('');
            }
            
            // Outcomes
            var sharedOutcomes = blueprintData.outcomes.filter(function(o) { return o.shared; });
            if (sharedOutcomes.length > 0) {
                lines.push('KEY OUTCOMES');
                sharedOutcomes.forEach(function(o) {
                    lines.push('\u2022 ' + o.text);
                });
                lines.push('');
            }
            
            // Values
            var selectedValues = blueprintData.values.filter(function(v) { return v.selected; });
            if (selectedValues.length > 0) {
                lines.push('CORE VALUES');
                selectedValues.forEach(function(v) {
                    var desc = getCatalogDescription(v.name);
                    lines.push('\u2022 ' + v.name + (desc ? ' \u2014 ' + desc : ''));
                    if (v.note) lines.push('  ' + v.note);
                });
                lines.push('');
            }
            
            // Top skills summary
            var skills = skillsData.skills || [];
            var topSkills = skills.filter(function(s) { return s.key; }).slice(0, 10);
            if (topSkills.length > 0) {
                lines.push('CORE COMPETENCIES');
                lines.push(topSkills.map(function(s) { return s.name; }).join(', '));
                lines.push('');
            }
            
            // Market context
            var comp = calculateTotalMarketValue();
            if (comp && comp.marketRate) {
                lines.push('MARKET POSITIONING');
                lines.push('Market Rate: $' + Math.round(comp.marketRate).toLocaleString());
                if (comp.competitiveOffer) {
                    lines.push('Competitive Range: $' + Math.round(comp.competitiveOffer).toLocaleString());
                }
                lines.push('');
            }
            
            lines.push('Generated by Blueprint\u2122 \u2022 ' + new Date().toLocaleDateString() + ' \u2022 \u00A9 2026 Cliff Jurkiewicz \u2022 myblueprint.work');
            
            var text = lines.join('\n');
            navigator.clipboard.writeText(text).then(function() {
                showToast('Blueprint copied to clipboard. Ready to paste.', 'success');
            }).catch(function() {
                // Fallback: select from textarea
                var ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('Blueprint copied to clipboard.', 'success');
            });
        }
        window.copyBlueprintText = copyBlueprintText;
        window.generateWorkBlueprint = generateWorkBlueprint;
        window.generateResume = generateResume;
        window.exportBlueprint = exportBlueprint;

        // ===== COVER LETTER GENERATOR =====

        function generateCoverLetter() {
            var jobs = userData.savedJobs || [];
            if (jobs.length === 0) {
                showToast('Add a job in the Jobs tab first, then generate a cover letter.', 'info');
                return;
            }
            // Show job picker modal
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Generate Cover Letter</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">Select a job to tailor your letter</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + jobs.map(function(j, i) {
                    var score = j.matchData ? Math.round(j.matchData.score) : 0;
                    var scoreColor = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                    return '<div onclick="buildCoverLetter(' + i + ')" style="display:flex; align-items:center; gap:14px; '
                        + 'padding:16px; border:1px solid var(--border); border-radius:10px; cursor:pointer; '
                        + 'margin-bottom:10px; transition:all 0.15s;" '
                        + 'onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">'
                        + '<div style="width:44px; height:44px; border-radius:10px; background:rgba(96,165,250,0.1); '
                        + 'display:flex; align-items:center; justify-content:center; font-weight:700; color:' + scoreColor + '; font-size:0.85em;">'
                        + score + '%</div>'
                        + '<div style="flex:1; min-width:0;">'
                        + '<div style="font-weight:600; color:var(--text-primary); font-size:0.92em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">'
                        + (j.title || 'Untitled') + '</div>'
                        + '<div style="font-size:0.82em; color:var(--text-muted);">' + (j.company || 'Unknown company') + '</div>'
                        + '</div>'
                        + '<div style="color:var(--text-muted); font-size:1.2em;">\u2192</div>'
                        + '</div>';
                }).join('')
                + '</div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.generateCoverLetter = generateCoverLetter;

        function buildCoverLetter(jobIdx) {
            var job = (userData.savedJobs || [])[jobIdx];
            if (!job || !job.matchData) { showToast('No match data for this job.', 'error'); return; }
            closeExportModal();

            var name = (userData.profile && userData.profile.name) || 'Professional';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            var purpose = userData.purpose || blueprintData.purpose || '';
            var matched = job.matchData.matched || [];
            var gaps = job.matchData.gaps || [];
            var sharedOutcomes = (blueprintData.outcomes || []).filter(function(o) { return o.shared; });
            var selectedValues = (blueprintData.values || []).filter(function(v) { return v.selected; });

            var apiKey = safeGet('wbAnthropicKey');

            if (apiKey) {
                showToast('Generating cover letter with AI...', 'info');
                var prompt = 'Write a professional cover letter for ' + name
                    + (title ? ', currently ' + title : '')
                    + ', applying for ' + (job.title || 'a role') + ' at ' + (job.company || 'the company') + '.\n\n'
                    + 'MATCHED SKILLS (strengths to emphasize): ' + matched.map(function(m) { return m.name || m; }).join(', ') + '\n\n'
                    + 'SKILL GAPS (acknowledge indirectly or show transferable experience): ' + gaps.map(function(g) { return g.name || g; }).join(', ') + '\n\n'
                    + 'KEY OUTCOMES: ' + sharedOutcomes.slice(0, 5).map(function(o) { return o.text; }).join('; ') + '\n\n'
                    + 'CORE VALUES: ' + selectedValues.slice(0, 5).map(function(v) { return v.name; }).join(', ') + '\n\n'
                    + (purpose ? 'PURPOSE STATEMENT: ' + purpose + '\n\n' : '')
                    + 'INSTRUCTIONS: Write 3-4 paragraphs. Opening: show specific knowledge of the company and role. '
                    + 'Middle: connect 2-3 matched skills to outcomes with concrete evidence. '
                    + 'Address gaps by showing adjacent experience. '
                    + 'Close: express genuine interest, reference values alignment. '
                    + 'Tone: confident but not arrogant, specific not generic. No cliches. '
                    + 'Do NOT include placeholder brackets like [Company] or [Name]. Use the actual names provided.';

                fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{ role: 'user', content: prompt }]
                    })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var text = (data.content || []).map(function(c) { return c.text || ''; }).join('\n');
                    if (!text) throw new Error('Empty response');
                    showCoverLetterResult(text, job);
                })
                .catch(function(err) {
                    console.error('Cover letter API error:', err);
                    showToast('AI generation failed, using template.', 'warning');
                    showCoverLetterResult(buildTemplateCoverLetter(job, name, title, matched, sharedOutcomes, purpose), job);
                });
            } else {
                showCoverLetterResult(buildTemplateCoverLetter(job, name, title, matched, sharedOutcomes, purpose), job);
            }
        }
        window.buildCoverLetter = buildCoverLetter;

        function buildTemplateCoverLetter(job, name, title, matched, outcomes, purpose) {
            var matchedNames = matched.slice(0, 5).map(function(m) { return m.name || m; });
            var outcomeTexts = outcomes.slice(0, 3).map(function(o) { return o.text; });
            var lines = [];
            lines.push('Dear Hiring Manager,');
            lines.push('');
            lines.push('I am writing to express my interest in the ' + (job.title || 'open position')
                + ' at ' + (job.company || 'your organization') + '.'
                + (title ? ' As a ' + title + ',' : '') + ' I bring a combination of '
                + (matchedNames.length > 2 ? matchedNames.slice(0, 2).join(', ') + ', and ' + matchedNames[2] : matchedNames.join(' and '))
                + ' that aligns directly with what you are looking for.');
            lines.push('');
            if (outcomeTexts.length > 0) {
                lines.push('In my current and recent roles, I have delivered measurable results: '
                    + outcomeTexts.join('. ') + '.'
                    + ' These outcomes reflect the same capabilities your team needs to succeed.');
            }
            lines.push('');
            if (purpose) {
                lines.push(purpose + ' This philosophy drives my approach to every challenge and every team I join.');
            }
            lines.push('');
            lines.push('I would welcome the opportunity to discuss how my experience and approach can contribute to '
                + (job.company || 'your team') + '\'s continued success.');
            lines.push('');
            lines.push('Sincerely,');
            lines.push(name);
            return lines.join('\n');
        }

        function showCoverLetterResult(text, job) {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Cover Letter</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">'
                + (job.title || '') + ' at ' + (job.company || '') + '</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<textarea id="coverLetterOutput" style="width:100%; min-height:350px; padding:18px; '
                + 'background:var(--input-bg); border:1px solid var(--border); border-radius:10px; '
                + 'color:var(--text-primary); font-size:0.95em; line-height:1.7; font-family:inherit; resize:vertical;">'
                + text.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                + '</textarea>'
                + '<div style="display:flex; gap:10px; margin-top:16px;">'
                + '<button onclick="copyCoverLetter()" style="flex:1; background:var(--accent); color:#fff; border:none; '
                + 'padding:12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + '\uD83D\uDCCB Copy to Clipboard</button>'
                + '<button onclick="downloadCoverLetter(\'' + (job.company || 'company').replace(/'/g, '') + '\')" '
                + 'style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border); '
                + 'padding:12px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">'
                + '\uD83D\uDCE5 Download</button>'
                + '</div></div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }

        function copyCoverLetter() {
            var ta = document.getElementById('coverLetterOutput');
            if (ta) {
                navigator.clipboard.writeText(ta.value).then(function() {
                    showToast('Cover letter copied to clipboard.', 'success');
                });
            }
        }
        window.copyCoverLetter = copyCoverLetter;

        function downloadCoverLetter(company) {
            var ta = document.getElementById('coverLetterOutput');
            if (!ta) return;
            var blob = new Blob([ta.value], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'cover-letter-' + company.toLowerCase().replace(/\s+/g, '-') + '.txt';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Cover letter downloaded.', 'success');
        }
        window.downloadCoverLetter = downloadCoverLetter;

        // ===== INTERVIEW PREP GENERATOR =====

        function generateInterviewPrep() {
            var jobs = userData.savedJobs || [];
            if (jobs.length === 0) {
                showToast('Add a job in the Jobs tab first, then generate interview prep.', 'info');
                return;
            }
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Interview Prep</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">Select a job for tailored STAR stories and talking points</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + jobs.map(function(j, i) {
                    var score = j.matchData ? Math.round(j.matchData.score) : 0;
                    var scoreColor = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                    return '<div onclick="buildInterviewPrep(' + i + ')" style="display:flex; align-items:center; gap:14px; '
                        + 'padding:16px; border:1px solid var(--border); border-radius:10px; cursor:pointer; '
                        + 'margin-bottom:10px; transition:all 0.15s;" '
                        + 'onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">'
                        + '<div style="width:44px; height:44px; border-radius:10px; background:rgba(96,165,250,0.1); '
                        + 'display:flex; align-items:center; justify-content:center; font-weight:700; color:' + scoreColor + '; font-size:0.85em;">'
                        + score + '%</div>'
                        + '<div style="flex:1; min-width:0;">'
                        + '<div style="font-weight:600; color:var(--text-primary); font-size:0.92em;">' + (j.title || 'Untitled') + '</div>'
                        + '<div style="font-size:0.82em; color:var(--text-muted);">' + (j.company || 'Unknown') + '</div>'
                        + '</div>'
                        + '<div style="color:var(--text-muted); font-size:1.2em;">\u2192</div>'
                        + '</div>';
                }).join('')
                + '</div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.generateInterviewPrep = generateInterviewPrep;

        function buildInterviewPrep(jobIdx) {
            var job = (userData.savedJobs || [])[jobIdx];
            if (!job || !job.matchData) { showToast('No match data.', 'error'); return; }
            closeExportModal();

            var name = (userData.profile && userData.profile.name) || 'Professional';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            var matched = job.matchData.matched || [];
            var gaps = job.matchData.gaps || [];
            var surplus = job.matchData.surplus || [];
            var sharedOutcomes = (blueprintData.outcomes || []).filter(function(o) { return o.shared; });
            var skills = skillsData.skills || [];

            var apiKey = safeGet('wbAnthropicKey');

            if (apiKey) {
                showToast('Generating interview prep with AI...', 'info');

                // Build skill-evidence map
                var skillEvidence = {};
                skills.forEach(function(s) {
                    if (s.evidence && s.evidence.length > 0) {
                        skillEvidence[s.name] = s.evidence.slice(0, 2).map(function(e) { return typeof e === 'string' ? e : e.text || ''; });
                    }
                });

                var prompt = 'Create an interview preparation guide for ' + name
                    + (title ? ' (' + title + ')' : '')
                    + ' interviewing for ' + (job.title || 'a role') + ' at ' + (job.company || 'the company') + '.\n\n'
                    + 'MATCHED SKILLS WITH EVIDENCE:\n'
                    + matched.slice(0, 10).map(function(m) {
                        var n = m.name || m;
                        var ev = skillEvidence[n];
                        return '- ' + n + (ev ? ': ' + ev.join('; ') : '');
                    }).join('\n') + '\n\n'
                    + 'SKILL GAPS (job requires, candidate lacks): ' + gaps.slice(0, 8).map(function(g) { return (g.name || g) + (g.required ? ' [REQUIRED]' : ''); }).join(', ') + '\n\n'
                    + 'SURPLUS STRENGTHS: ' + surplus.slice(0, 5).map(function(s) { return s.name || s; }).join(', ') + '\n\n'
                    + 'KEY OUTCOMES: ' + sharedOutcomes.slice(0, 5).map(function(o) { return o.text; }).join('; ') + '\n\n'
                    + 'INSTRUCTIONS:\n'
                    + '1. For the top 5 matched skills, write a STAR story framework: Situation (one sentence setup), Task, Action, Result. Use the evidence provided.\n'
                    + '2. For each gap, write bridging language that connects adjacent experience. Frame: "While I haven\'t done X specifically, my experience with Y translates because..."\n'
                    + '3. Write 3 surplus strengths as "unexpected value" talking points. These differentiate the candidate.\n'
                    + '4. Write 3 smart questions to ask the interviewer that demonstrate strategic thinking.\n'
                    + 'Format with clear section headers. Be specific, not generic.';

                fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2500,
                        messages: [{ role: 'user', content: prompt }]
                    })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var text = (data.content || []).map(function(c) { return c.text || ''; }).join('\n');
                    if (!text) throw new Error('Empty response');
                    showInterviewPrepResult(text, job);
                })
                .catch(function(err) {
                    console.error('Interview prep API error:', err);
                    showToast('AI generation failed, using template.', 'warning');
                    showInterviewPrepResult(buildTemplateInterviewPrep(job, matched, gaps, surplus, skills, sharedOutcomes), job);
                });
            } else {
                showInterviewPrepResult(buildTemplateInterviewPrep(job, matched, gaps, surplus, skills, sharedOutcomes), job);
            }
        }
        window.buildInterviewPrep = buildInterviewPrep;

        function buildTemplateInterviewPrep(job, matched, gaps, surplus, skills, outcomes) {
            var lines = [];
            lines.push('INTERVIEW PREP: ' + (job.title || 'Role') + ' at ' + (job.company || 'Company'));
            lines.push('Match Score: ' + Math.round(job.matchData.score) + '%');
            lines.push('');

            lines.push('=== YOUR STRONGEST TALKING POINTS ===');
            lines.push('');
            matched.slice(0, 6).forEach(function(m) {
                var n = m.name || m;
                var skill = skills.find(function(s) { return s.name === n; });
                var evidence = (skill && skill.evidence) ? skill.evidence.slice(0, 2) : [];
                lines.push('\u2705 ' + n + (m.level ? ' (' + m.level + ')' : ''));
                if (evidence.length > 0) {
                    evidence.forEach(function(e) {
                        var txt = typeof e === 'string' ? e : e.text || '';
                        if (txt) lines.push('   Evidence: ' + txt);
                    });
                }
                lines.push('   STAR Framework: [Situation] Describe when you used this skill. [Task] What was the challenge? [Action] What specifically did you do? [Result] What was the measurable outcome?');
                lines.push('');
            });

            if (gaps.length > 0) {
                lines.push('=== BRIDGING LANGUAGE FOR GAPS ===');
                lines.push('');
                gaps.slice(0, 5).forEach(function(g) {
                    var n = g.name || g;
                    lines.push('\u26A0\uFE0F ' + n + (g.required ? ' [REQUIRED]' : ''));
                    lines.push('   "While I haven\'t worked with ' + n + ' specifically, my experience with [related skill] translates directly because..."');
                    lines.push('');
                });
            }

            if (surplus.length > 0) {
                lines.push('=== UNEXPECTED VALUE (YOUR DIFFERENTIATORS) ===');
                lines.push('');
                surplus.slice(0, 4).forEach(function(s) {
                    lines.push('\uD83D\uDCA1 ' + (s.name || s));
                    lines.push('   This skill isn\'t in the job description but adds value because...');
                    lines.push('');
                });
            }

            lines.push('=== QUESTIONS TO ASK ===');
            lines.push('');
            lines.push('1. What does success look like in this role at the 6-month mark?');
            lines.push('2. How does the team approach [a key matched skill area] today, and where do you want it to go?');
            lines.push('3. What\'s the biggest challenge the person in this role will face in the first quarter?');
            lines.push('');
            lines.push('Generated by Blueprint\u2122 \u2022 ' + new Date().toLocaleDateString() + ' \u2022 myblueprint.work');
            return lines.join('\n');
        }

        function showInterviewPrepResult(text, job) {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Interview Prep</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">'
                + (job.title || '') + ' at ' + (job.company || '') + '</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<textarea id="interviewPrepOutput" style="width:100%; min-height:400px; padding:18px; '
                + 'background:var(--input-bg); border:1px solid var(--border); border-radius:10px; '
                + 'color:var(--text-primary); font-size:0.92em; line-height:1.7; font-family:inherit; resize:vertical;">'
                + text.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                + '</textarea>'
                + '<div style="display:flex; gap:10px; margin-top:16px;">'
                + '<button onclick="copyInterviewPrep()" style="flex:1; background:var(--accent); color:#fff; border:none; '
                + 'padding:12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + '\uD83D\uDCCB Copy to Clipboard</button>'
                + '<button onclick="downloadInterviewPrep(\'' + (job.company || 'company').replace(/'/g, '') + '\')" '
                + 'style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border); '
                + 'padding:12px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">'
                + '\uD83D\uDCE5 Download</button>'
                + '</div></div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }

        function copyInterviewPrep() {
            var ta = document.getElementById('interviewPrepOutput');
            if (ta) {
                navigator.clipboard.writeText(ta.value).then(function() {
                    showToast('Interview prep copied to clipboard.', 'success');
                });
            }
        }
        window.copyInterviewPrep = copyInterviewPrep;

        function downloadInterviewPrep(company) {
            var ta = document.getElementById('interviewPrepOutput');
            if (!ta) return;
            var blob = new Blob([ta.value], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'interview-prep-' + company.toLowerCase().replace(/\s+/g, '-') + '.txt';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Interview prep downloaded.', 'success');
        }
        window.downloadInterviewPrep = downloadInterviewPrep;

        // ===== LINKEDIN PROFILE GENERATOR =====

        function generateLinkedInProfile() {
            var name = (userData.profile && userData.profile.name) || 'Professional';
            var title = (userData.profile && userData.profile.currentTitle) || '';
            var purpose = userData.purpose || blueprintData.purpose || '';
            var sharedOutcomes = (blueprintData.outcomes || []).filter(function(o) { return o.shared; });
            var selectedValues = (blueprintData.values || []).filter(function(v) { return v.selected; });
            var skills = skillsData.skills || [];
            var topSkills = skills.filter(function(s) { return s.key; }).slice(0, 15);
            var allSkills = skills.slice(0, 50);

            var apiKey = safeGet('wbAnthropicKey');

            if (apiKey) {
                showToast('Generating LinkedIn profile with AI...', 'info');
                var prompt = 'Generate an optimized LinkedIn profile for ' + name
                    + (title ? ', ' + title : '') + '.\n\n'
                    + 'PURPOSE: ' + (purpose || 'Not provided') + '\n\n'
                    + 'KEY OUTCOMES:\n' + sharedOutcomes.slice(0, 6).map(function(o) { return '- ' + o.text; }).join('\n') + '\n\n'
                    + 'CORE VALUES: ' + selectedValues.slice(0, 5).map(function(v) { return v.name; }).join(', ') + '\n\n'
                    + 'TOP SKILLS: ' + topSkills.map(function(s) { return s.name; }).join(', ') + '\n\n'
                    + 'INSTRUCTIONS:\n'
                    + '1. HEADLINE (max 220 chars): Title | Value proposition | 2-3 key differentiators. No buzzwords.\n'
                    + '2. ABOUT SECTION (2000 chars max, ~3 paragraphs): First paragraph hooks with a specific outcome. Second connects purpose to capabilities. Third is forward-looking, what you are building toward. End with a brief "Specialties:" line. Write in first person. No generic openers like "Passionate professional" or "Results-driven leader".\n'
                    + '3. SKILLS LIST: The top 15 skills ordered by impact, one per line.\n'
                    + 'Separate each section with a clear header.';

                fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1500,
                        messages: [{ role: 'user', content: prompt }]
                    })
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var text = (data.content || []).map(function(c) { return c.text || ''; }).join('\n');
                    if (!text) throw new Error('Empty response');
                    showLinkedInResult(text);
                })
                .catch(function(err) {
                    console.error('LinkedIn API error:', err);
                    showToast('AI generation failed, using template.', 'warning');
                    showLinkedInResult(buildTemplateLinkedIn(name, title, purpose, sharedOutcomes, selectedValues, topSkills));
                });
            } else {
                showLinkedInResult(buildTemplateLinkedIn(name, title, purpose, sharedOutcomes, selectedValues, topSkills));
            }
        }
        window.generateLinkedInProfile = generateLinkedInProfile;

        function buildTemplateLinkedIn(name, title, purpose, outcomes, values, topSkills) {
            var lines = [];
            lines.push('=== HEADLINE ===');
            lines.push(title + (values.length > 0 ? ' | ' + values.slice(0, 3).map(function(v) { return v.name; }).join(' \u00B7 ') : '')
                + (topSkills.length > 0 ? ' | ' + topSkills.slice(0, 3).map(function(s) { return s.name; }).join(', ') : ''));
            lines.push('');
            lines.push('=== ABOUT ===');
            if (outcomes.length > 0) {
                lines.push(outcomes[0].text + '\n');
            }
            if (purpose) {
                lines.push(purpose + '\n');
            }
            if (outcomes.length > 1) {
                lines.push('Key results I have delivered:');
                outcomes.slice(1, 5).forEach(function(o) {
                    lines.push('\u2022 ' + o.text);
                });
                lines.push('');
            }
            if (topSkills.length > 0) {
                lines.push('Specialties: ' + topSkills.map(function(s) { return s.name; }).join(' \u00B7 '));
            }
            lines.push('');
            lines.push('=== SKILLS (Top 15) ===');
            topSkills.forEach(function(s, i) {
                lines.push((i + 1) + '. ' + s.name);
            });
            lines.push('');
            lines.push('Generated by Blueprint\u2122 \u2022 myblueprint.work');
            return lines.join('\n');
        }

        function showLinkedInResult(text) {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">LinkedIn Profile</h2>'
                + '<p style="color:var(--text-secondary); margin-top:5px;">Copy each section directly to LinkedIn</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00d7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<textarea id="linkedinOutput" style="width:100%; min-height:380px; padding:18px; '
                + 'background:var(--input-bg); border:1px solid var(--border); border-radius:10px; '
                + 'color:var(--text-primary); font-size:0.92em; line-height:1.7; font-family:inherit; resize:vertical;">'
                + text.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                + '</textarea>'
                + '<div style="display:flex; gap:10px; margin-top:16px;">'
                + '<button onclick="copyLinkedIn()" style="flex:1; background:#0a66c2; color:#fff; border:none; '
                + 'padding:12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">'
                + '\uD83D\uDD17 Copy to Clipboard</button>'
                + '</div></div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }

        function copyLinkedIn() {
            var ta = document.getElementById('linkedinOutput');
            if (ta) {
                navigator.clipboard.writeText(ta.value).then(function() {
                    showToast('LinkedIn profile copied. Open LinkedIn to paste.', 'success');
                });
            }
        }
        window.copyLinkedIn = copyLinkedIn;
        
        // ===== OPPORTUNITIES SYSTEM =====

        let jobsSubTab = 'your-jobs';
        let activeJobId = null; // Currently selected job for network overlay
        
        function initOpportunities() {
            const view = document.getElementById('opportunitiesView');
            var savedCount = (userData.savedJobs || []).length;
            var appCount = (userData.applications || []).length;
            
            view.innerHTML = '<div style="max-width:1200px; margin:0 auto; padding:24px;">'
                + '<div class="jobs-subtabs">'
                + '<button class="jobs-subtab ' + (jobsSubTab === 'your-jobs' ? 'active' : '') + '" onclick="switchJobsSubTab(\'your-jobs\')">' + bpIcon('target',14) + ' Pipeline' + (savedCount > 0 ? ' (' + savedCount + ')' : '') + '</button>'
                + '<button class="jobs-subtab ' + (jobsSubTab === 'tracker' ? 'active' : '') + '" onclick="switchJobsSubTab(\'tracker\')">' + bpIcon('tracker',14) + ' Tracker' + (appCount > 0 ? ' (' + appCount + ')' : '') + '</button>'
                + '<button class="jobs-subtab ' + (jobsSubTab === 'find-jobs' ? 'active' : '') + '" onclick="switchJobsSubTab(\'find-jobs\')">' + bpIcon('search',14) + ' Find Jobs</button>'
                + '</div>'
                + '<div id="jobsSubTabContent"></div>'
                + '</div>';
            
            renderJobsSubTab();
        }
        
        function switchJobsSubTab(tab) {
            jobsSubTab = tab;
            // Re-render the full jobs view to update subtab active states and counts
            window.opportunitiesInitialized = false;
            initOpportunities();
            window.opportunitiesInitialized = true;
        }
        window.switchJobsSubTab = switchJobsSubTab;
        
        function renderJobsSubTab() {
            var el = document.getElementById('jobsSubTabContent');
            if (!el) return;
            if (jobsSubTab === 'your-jobs') {
                el.innerHTML = renderSavedJobs();
            } else if (jobsSubTab === 'tracker') {
                el.innerHTML = renderTrackerInJobs();
            } else {
                el.innerHTML = renderFindJobs();
                // Show previous results if any, otherwise show prompt
                if (opportunitiesData && opportunitiesData.length > 0) {
                    renderOpportunities();
                }
            }
        }
        
        // Render the Application Tracker inline within Jobs tab
        function renderTrackerInJobs() {
            var apps = userData.applications || [];
            var html = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">'
                + '<div>'
                + '<h2 style="font-family:Outfit,sans-serif; font-size:1.3em; font-weight:700; color:var(--text-primary); margin:0; letter-spacing:0.08em; text-transform:uppercase;">Application Tracker</h2>'
                + '<p style="font-size:0.85em; color:var(--text-muted); margin-top:4px;">Track your applications and follow-ups</p>'
                + '</div>'
                + '<button onclick="addApplicationModal()" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:10px 20px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.9em;">+ Add Application</button>'
                + '</div>';
            
            if (apps.length === 0) {
                html += '<div style="text-align:center; padding:60px 20px;">'
                    + '<div style="margin-bottom:16px; opacity:0.4;">' + bpIcon('tracker',48) + '</div>'
                    + '<div style="font-size:1.1em; font-weight:600; color:var(--text-primary); margin-bottom:8px;">No applications tracked yet</div>'
                    + '<div style="color:var(--text-muted); max-width:400px; margin:0 auto 24px; line-height:1.5;">'
                    + 'When you add a job to your pipeline and generate a pitch, you can track the application here.</div>'
                    + '<button onclick="addApplicationModal()" style="'
                    + 'background:var(--accent); color:#fff; border:none; padding:12px 28px; border-radius:8px; '
                    + 'cursor:pointer; font-weight:600; font-size:0.95em;">+ Track an Application</button>'
                    + '</div>';
                return html;
            }
            
            // Status summary
            var grouped = {
                applied: apps.filter(function(a) { return a.status === 'applied'; }),
                interviewing: apps.filter(function(a) { return a.status === 'interviewing'; }),
                offer: apps.filter(function(a) { return a.status === 'offer'; }),
                rejected: apps.filter(function(a) { return a.status === 'rejected'; })
            };
            
            html += '<div style="margin-bottom:20px; display:flex; gap:15px; flex-wrap:wrap;">'
                + '<div class="application-status status-applied">' + grouped.applied.length + ' Applied</div>'
                + '<div class="application-status status-interviewing">' + grouped.interviewing.length + ' Interviewing</div>'
                + '<div class="application-status status-offer">' + grouped.offer.length + ' Offers</div>'
                + '<div class="application-status status-rejected">' + grouped.rejected.length + ' Closed</div>'
                + '</div>'
                + '<div class="applications-grid">'
                + apps.map(function(app, idx) { return renderApplicationCard(app, idx); }).join('')
                + '</div>';
            
            return html;
        }
        window.renderTrackerInJobs = renderTrackerInJobs;
        
        function renderSavedJobs() {
            var jobs = userData.savedJobs || [];
            var html = '';
            
            // Add Job button
            html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">'
                + '<div>'
                + '<h2 style="font-family:Outfit,sans-serif; font-size:1.3em; font-weight:700; color:var(--text-primary); margin:0; letter-spacing:0.08em; text-transform:uppercase;">Job Pipeline</h2>'
                + '<p style="font-size:0.85em; color:var(--text-muted); margin-top:4px;">Paste a job description to analyze your fit</p>'
                + '</div>'
                + '<div style="display:flex; gap:8px;">'
                + '<button onclick="rescoreAllJobs(); renderJobsSubTab();" style="'
                + 'background:none; border:1px solid var(--border); color:var(--text-muted); padding:10px 16px; border-radius:8px; '
                + 'cursor:pointer; font-size:0.85em;" title="Re-calculate match scores based on current skills">\u21BB Refresh Matches</button>'
                + '<button onclick="showAddJobModal()" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:10px 20px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.9em;">+ Add a Job</button>'
                + '</div>'
                + '</div>';
            
            if (jobs.length === 0) {
                html += '<div style="text-align:center; padding:60px 20px;">'
                    + '<div style="margin-bottom:16px; opacity:0.4;">' + bpIcon('target',48) + '</div>'
                    + '<div style="font-size:1.1em; font-weight:600; color:var(--text-primary); margin-bottom:8px;">No jobs yet</div>'
                    + '<div style="color:var(--text-muted); max-width:400px; margin:0 auto 24px; line-height:1.5;">'
                    + 'Paste a job description and see exactly how your skills map to what they need. Not a percentage. A network.</div>'
                    + '<button onclick="showAddJobModal()" style="'
                    + 'background:var(--accent); color:#fff; border:none; padding:12px 28px; border-radius:8px; '
                    + 'cursor:pointer; font-weight:600; font-size:0.95em;">+ Add Your First Job</button>'
                    + '</div>';
                return html;
            }
            
            // Render job cards
            jobs.forEach(function(job, idx) {
                var match = job.matchData || {};
                var matchPct = match.score || 0;
                var matchColor = matchPct >= 70 ? '#10b981' : matchPct >= 45 ? '#f59e0b' : '#6b7280';
                var matchedCount = (match.matched || []).length;
                var gapCount = (match.gaps || []).length;
                var surplusCount = (match.surplus || []).length;
                var dateStr = job.addedAt ? new Date(job.addedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                
                html += '<div class="job-cart-card" onclick="showJobDetail(' + idx + ')">'
                    + '<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">'
                    + '<div style="flex:1; min-width:0;">'
                    + '<div style="font-size:1.1em; font-weight:600; color:var(--text-primary); margin-bottom:3px;">' + (job.title || 'Untitled Position') + '</div>'
                    + '<div style="font-size:0.88em; color:var(--text-muted);">'
                    + (job.company || '')
                    + (job.company && dateStr ? ' \u00B7 ' : '') + dateStr
                    + (job.sourceUrl ? ' \u00B7 <a href="' + job.sourceUrl + '" target="_blank" onclick="event.stopPropagation();" style="color:var(--accent); text-decoration:none;">Source \u2192</a>' : '')
                    + (job.sourceNote ? ' \u00B7 ' + job.sourceNote : '')
                    + '</div></div>'
                    + '<div style="text-align:right; min-width:70px;">'
                    + '<div style="font-size:1.5em; font-weight:700; color:' + matchColor + ';">' + matchPct + '%</div>'
                    + '<div style="font-size:0.7em; color:var(--text-muted);">match</div>'
                    + '</div></div>';
                
                // Match bar
                html += '<div class="job-cart-match" style="margin-top:12px;">'
                    + '<div class="job-cart-match-bar">'
                    + '<div class="job-cart-match-fill" style="width:' + matchPct + '%; background:' + matchColor + ';"></div>'
                    + '</div></div>';
                
                // Skill summary chips
                html += '<div style="margin-top:10px; display:flex; gap:12px; font-size:0.78em; color:var(--text-muted);">'
                    + '<span style="color:#10b981;">\u2713 ' + matchedCount + ' matched</span>'
                    + '<span style="color:#ef4444;">\u25CB ' + gapCount + ' gaps</span>'
                    + '<span style="color:#6b7280;">\u25CF ' + surplusCount + ' surplus</span>'
                    + '</div>';
                
                // BLS salary range (if available)
                if (job.blsSalary && job.blsSalary.median) {
                    var bls = job.blsSalary;
                    var lo = bls.pct25 ? '$' + bls.pct25.toLocaleString() : '';
                    var hi = bls.pct75 ? '$' + bls.pct75.toLocaleString() : '';
                    var med = '$' + bls.median.toLocaleString();
                    var rangeStr = lo && hi ? lo + ' \u2013 ' + hi : 'Median ' + med;
                    html += '<div style="margin-top:8px; font-size:0.78em; color:var(--text-muted); display:flex; align-items:center; gap:6px;">'
                        + '<span style="color:#a78bfa;">\uD83D\uDCB0</span> '
                        + '<span style="color:#a78bfa;">' + rangeStr + '</span>'
                        + '<span style="opacity:0.5;"> \u00B7 ' + bls.title + ' (BLS)</span>'
                        + '</div>';
                }
                
                // Edit/remove — hidden for sample jobs unless admin
                var isSampleJob = job.sample === true;
                if (isSampleJob && !fbIsAdmin) {
                    html += '<div style="margin-top:8px; font-size:0.72em; color:var(--text-muted); text-align:right; font-style:italic;">\uD83D\uDD12 Demo job</div>';
                } else {
                    html += '<div style="margin-top:8px; display:flex; justify-content:flex-end; gap:8px;">'
                        + (isSampleJob ? '<span style="font-size:0.72em; color:var(--text-muted); align-self:center; margin-right:auto; font-style:italic;">\uD83D\uDD12 Demo</span>' : '')
                        + '<button onclick="event.stopPropagation(); editJobInfo(' + idx + ')" style="'
                        + 'background:none; border:1px solid var(--border); color:var(--text-muted); font-size:0.75em; '
                        + 'cursor:pointer; padding:4px 10px; border-radius:5px;" '
                        + 'onmouseover="this.style.color=\'var(--accent)\'" onmouseout="this.style.color=\'var(--text-muted)\'">\u270E Edit</button>'
                        + '<button onclick="event.stopPropagation(); removeJob(' + idx + ')" style="'
                        + 'background:none; border:1px solid rgba(239,68,68,0.2); color:var(--text-muted); font-size:0.75em; '
                        + 'cursor:pointer; padding:4px 10px; border-radius:5px;" '
                        + 'onmouseover="this.style.color=\'#ef4444\';this.style.borderColor=\'rgba(239,68,68,0.5)\'" '
                        + 'onmouseout="this.style.color=\'var(--text-muted)\';this.style.borderColor=\'rgba(239,68,68,0.2)\'">\u2715 Remove</button>'
                        + '</div>';
                }
                
                html += '</div>';
            });
            
            return html;
        }
        
        function renderFindJobs() {
            // Build role suggestions from user's profile
            var roleSuggestions = '';
            if (userData.roles && userData.roles.length > 0) {
                roleSuggestions = userData.roles.map(function(r) {
                    return '<button onclick="document.getElementById(\'findJobsKeyword\').value=\'' + r.name.replace(/'/g, "\\'") + '\'; searchOpportunities();" '
                        + 'style="padding:4px 12px; border-radius:14px; border:1px solid var(--border); background:none; '
                        + 'color:var(--text-secondary); cursor:pointer; font-size:0.82em; transition:all 0.15s;" '
                        + 'onmouseover="this.style.borderColor=\'var(--accent)\'; this.style.color=\'var(--accent)\'" '
                        + 'onmouseout="this.style.borderColor=\'var(--border)\'; this.style.color=\'var(--text-secondary)\'">'
                        + r.name + '</button>';
                }).join('');
            }
            
            return '<div style="margin-bottom:24px;">'
                + '<h2 style="font-family:Outfit,sans-serif; font-size:1.3em; font-weight:700; color:var(--text-primary); margin:0 0 4px 0; letter-spacing:0.08em; text-transform:uppercase;">'
                + bpIcon('search',20) + ' Find Jobs</h2>'
                + '<p style="color:var(--text-muted); font-size:0.88em; margin:0;">Search remote jobs from Remotive, Himalayas, and Jobicy. Results are scored against your skills.</p>'
                + '</div>'
                
                // Search bar
                + '<div style="display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap;">'
                + '<input id="findJobsKeyword" type="text" placeholder="Search by role, skill, or keyword..." '
                + 'value="' + (window._lastJobSearch || '') + '" '
                + 'onkeydown="if(event.key===\'Enter\') searchOpportunities();" '
                + 'style="flex:1; min-width:200px; padding:10px 14px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:0.92em;" />'
                
                + '<button onclick="document.getElementById(\'findJobsKeyword\').value=\'\'; document.getElementById(\'findJobsCategory\').selectedIndex=0; window._lastJobSearch=\'\'; opportunitiesData=[]; var r=document.getElementById(\'opportunitiesResults\'); if(r) r.innerHTML=\'\';" '
                + 'style="padding:10px 12px; background:none; border:1px solid var(--border); border-radius:8px; '
                + 'color:var(--text-muted); cursor:pointer;" title="Clear search">' + bpIcon('x',14) + '</button>'
                
                + '<select id="findJobsCategory" style="padding:10px 14px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:0.88em; min-width:150px;">'
                + '<option value="">All Categories</option>'
                + '<option value="software-dev">Software Dev</option>'
                + '<option value="marketing">Marketing</option>'
                + '<option value="business">Business</option>'
                + '<option value="data">Data Science</option>'
                + '<option value="design">Design</option>'
                + '<option value="product">Product</option>'
                + '<option value="hr">Human Resources</option>'
                + '<option value="finance">Finance</option>'
                + '<option value="sales">Sales</option>'
                + '<option value="customer-support">Customer Support</option>'
                + '<option value="writing">Writing</option>'
                + '<option value="devops">DevOps / SysAdmin</option>'
                + '</select>'
                
                + '<button onclick="searchOpportunities()" style="padding:10px 20px; background:var(--accent); '
                + 'color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em; '
                + 'display:flex; align-items:center; gap:6px; white-space:nowrap;">'
                + bpIcon('search',14) + ' Search</button>'
                + '</div>'
                
                // Quick role chips
                + (roleSuggestions ? '<div style="display:flex; gap:6px; margin-bottom:16px; flex-wrap:wrap;">'
                + '<span style="font-size:0.78em; color:var(--text-muted); padding:4px 0;">Your roles:</span>'
                + roleSuggestions + '</div>' : '')
                
                // Match threshold
                + '<div style="display:flex; align-items:center; gap:12px; margin-bottom:20px; padding:10px 14px; '
                + 'border-radius:8px; background:' + tv('rgba(96,165,250,0.04)','rgba(30,64,175,0.03)') + '; border:1px solid ' + tv('rgba(96,165,250,0.1)','rgba(30,64,175,0.08)') + ';">'
                + '<span style="font-size:0.82em; color:var(--text-muted); white-space:nowrap;">Min match:</span>'
                + '<input type="range" min="0" max="80" value="' + currentMatchThreshold + '" '
                + 'oninput="updateMatchThreshold(this.value)" '
                + 'style="flex:1; accent-color:var(--accent);" />'
                + '<span id="matchValue" style="font-weight:600; color:var(--accent); min-width:40px; text-align:right;">' + currentMatchThreshold + '%</span>'
                + '</div>'
                
                // Results container
                + '<div id="opportunitiesResults"></div>';
        }
        
        // ===== ADD JOB MODAL =====
        
        function showAddJobModal() {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            var savedKey = safeGet('wbAnthropicKey') || '';
            
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Add a Job</h2>'
                + '<p style="color:var(--text-muted); margin-top:5px;">Paste a job description to analyze your fit</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                
                // JD paste area
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px;">Job Description *</label>'
                + '<textarea id="jdTextInput" placeholder="Paste the full job description here..." style="'
                + 'width:100%; min-height:180px; padding:14px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:8px; color:var(--text-primary); '
                + 'font-size:0.92em; line-height:1.6; font-family:inherit; resize:vertical;"></textarea>'
                
                // Source URL
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:14px;">'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Source URL</label>'
                + '<input id="jdSourceUrl" placeholder="https://..." style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div>'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Source Note</label>'
                + '<input id="jdSourceNote" placeholder="e.g., Recruiter email, LinkedIn" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div></div>'
                
                // API key (collapsible)
                + '<details style="margin-top:16px;">'
                + '<summary style="cursor:pointer; font-size:0.82em; color:var(--text-muted);">'
                + '\u26A1 AI-powered analysis (optional, requires API key)</summary>'
                + '<div style="margin-top:8px; padding:12px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; '
                + 'border:1px solid var(--border); border-radius:8px;">'
                + '<input id="jdApiKey" type="password" placeholder="sk-ant-..." value="' + savedKey + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.88em; font-family:monospace;" />'
                + '<div style="font-size:0.75em; color:var(--text-muted); margin-top:6px; line-height:1.5;">'
                + 'Stored locally, never sent to our servers. Get a key at <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent);">console.anthropic.com</a>. '
                + 'Without a key, analysis uses local skill matching (still good, but less nuanced).'
                + '</div></div></details>'
                
                + '<div id="jdParsingStatus" style="display:none; margin-top:16px; padding:16px; border-radius:8px; text-align:center;"></div>'
                
                // Actions
                + '<div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">'
                + '<button onclick="closeExportModal()" style="'
                + 'background:transparent; color:var(--text-muted); border:1px solid var(--border); '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">Cancel</button>'
                + '<button id="analyzeJobBtn" onclick="analyzeJob()" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:10px 24px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.9em;">\uD83D\uDD0D Analyze Fit</button>'
                + '</div></div>';
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            setTimeout(function() { document.getElementById('jdTextInput').focus(); }, 100);
        }
        window.showAddJobModal = showAddJobModal;
        
        // ===== JOB ANALYSIS ENGINE =====
        
        // ===== BLS OCCUPATION MATCHING =====
        function matchJobToBLS(titleText, descText) {
            if (!window.blsWages) return null;
            var bls = window.blsWages;
            var text = ((titleText || '') + ' ' + (descText || '').substring(0, 500)).toLowerCase();
            var scores = {};
            
            // Phase 1: Alias matching (strongest signal, weight 5)
            if (bls.aliases) {
                // Sort aliases by length descending so longer phrases match first
                var sortedAliases = Object.keys(bls.aliases).sort(function(a, b) { return b.length - a.length; });
                for (var ai = 0; ai < sortedAliases.length; ai++) {
                    var alias = sortedAliases[ai];
                    if (text.indexOf(alias) !== -1) {
                        var soc = bls.aliases[alias];
                        scores[soc] = (scores[soc] || 0) + 5;
                    }
                }
            }
            
            // Phase 2: Title keyword matching (weight 1 per word)
            var words = text.match(/[a-z]+/g) || [];
            var skip = {and:1,or:1,the:1,of:1,for:1,all:1,other:1,except:1,a:1,an:1,in:1,to:1,with:1,by:1,is:1,are:1,was:1,will:1,this:1,that:1,you:1,our:1,your:1,we:1};
            words = words.filter(function(w) { return !skip[w] && w.length > 2; });
            
            for (var oi = 0; oi < bls.occupations.length; oi++) {
                var occ = bls.occupations[oi];
                var occWords = (occ.keywords || []);
                var overlap = 0;
                for (var wi = 0; wi < words.length; wi++) {
                    if (occWords.indexOf(words[wi]) !== -1) overlap++;
                }
                if (overlap > 0) {
                    scores[occ.soc] = (scores[occ.soc] || 0) + overlap;
                }
            }
            
            // Find best match
            var best = null;
            var bestScore = 0;
            for (var soc in scores) {
                if (scores[soc] > bestScore) {
                    bestScore = scores[soc];
                    best = soc;
                }
            }
            
            if (!best) return null;
            
            // Look up the occupation data
            var matched = null;
            for (var mi = 0; mi < bls.occupations.length; mi++) {
                if (bls.occupations[mi].soc === best) {
                    matched = bls.occupations[mi];
                    break;
                }
            }
            
            if (!matched) return null;
            
            return {
                soc: matched.soc,
                title: matched.title,
                median: matched.a_median,
                pct10: matched.a_pct10,
                pct25: matched.a_pct25,
                pct75: matched.a_pct75,
                pct90: matched.a_pct90,
                employment: matched.employment,
                confidence: bestScore,
                source: 'BLS OEWS ' + (bls.period || '2024')
            };
        }
        window.matchJobToBLS = matchJobToBLS;
        
        async function analyzeJob() {
            var jdText = (document.getElementById('jdTextInput').value || '').trim();
            if (!jdText || jdText.length < 50) {
                showToast('Paste a job description (at least a few sentences).', 'warning');
                return;
            }
            
            var sourceUrl = (document.getElementById('jdSourceUrl').value || '').trim();
            var sourceNote = (document.getElementById('jdSourceNote').value || '').trim();
            var apiKey = (document.getElementById('jdApiKey').value || '').trim();
            
            // Save API key for reuse
            if (apiKey) localStorage.setItem('wbAnthropicKey', apiKey);
            
            // Show progress
            var statusEl = document.getElementById('jdParsingStatus');
            var btn = document.getElementById('analyzeJobBtn');
            statusEl.style.display = 'block';
            statusEl.style.background = tv('rgba(96,165,250,0.08)','rgba(30,64,175,0.06)');
            statusEl.innerHTML = '<div class="loading-spinner" style="width:24px; height:24px; border-width:2px; margin:0 auto 8px;"></div>'
                + '<div style="color:var(--text-secondary); font-size:0.88em;">'
                + (apiKey ? 'Analyzing with AI...' : 'Matching against skill library...') + '</div>';
            btn.disabled = true;
            btn.style.opacity = '0.5';
            
            try {
                var parsed;
                if (apiKey) {
                    parsed = await parseJobWithAPI(jdText, apiKey);
                } else {
                    parsed = parseJobLocally(jdText);
                }
                
                // Calculate match against user's skills
                var matchData = matchJobToProfile(parsed);
                
                // Build the job object
                var blsSalary = matchJobToBLS(parsed.title, jdText);
                var job = {
                    id: 'job-' + Date.now(),
                    title: parsed.title || 'Untitled Position',
                    company: parsed.company || '',
                    sourceUrl: sourceUrl,
                    sourceNote: sourceNote,
                    rawText: jdText.substring(0, 5000), // Cap storage
                    parsedSkills: parsed.skills || [],
                    parsedRoles: parsed.roles || [],
                    seniority: parsed.seniority || '',
                    matchData: matchData,
                    blsSalary: blsSalary,
                    addedAt: new Date().toISOString()
                };
                
                // Save
                if (!userData.savedJobs) userData.savedJobs = [];
                if (userData.savedJobs.length >= 10) {
                    showToast('Job pipeline is full (10 max). Remove one first.', 'warning');
                    return;
                }
                userData.savedJobs.unshift(job);
                saveUserData();
                if (fbUser) saveToFirestore();
                
                closeExportModal();
                
                // Refresh the jobs view
                window.opportunitiesInitialized = false;
                switchView('opportunities');
                
                showToast('Job analyzed: ' + matchData.score + '% match with ' + (matchData.matched || []).length + ' skills aligned.', 'success', 5000);
                
            } catch (err) {
                console.error('Job analysis error:', err);
                statusEl.style.background = tv('rgba(239,68,68,0.08)','rgba(239,68,68,0.05)');
                statusEl.innerHTML = '<div style="color:#ef4444; font-size:0.88em;">\u26A0 ' + (err.message || 'Analysis failed.') + '</div>';
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }
        window.analyzeJob = analyzeJob;
        
        // ===== CLAUDE API PARSING =====
        
        async function parseJobWithAPI(jdText, apiKey) {
            var userSkillNames = (skillsData.skills || []).map(function(s) { return s.name; });
            
            var systemPrompt = 'You extract structured data from job descriptions. Respond ONLY with valid JSON, no markdown fences, no preamble.';
            
            // Build vocabulary hint: user skills + canonical synonym keys
            var vocabSet = new Set();
            userSkillNames.slice(0, 60).forEach(function(n) { vocabSet.add(n); });
            Object.keys(SKILL_SYNONYMS).forEach(function(k) {
                // Capitalize for display
                vocabSet.add(k.replace(/\b\w/g, function(c) { return c.toUpperCase(); }));
            });
            var vocabHint = Array.from(vocabSet).slice(0, 120).join(', ');
            
            var userPrompt = 'Extract from this job description:\n\n' + jdText.substring(0, 4000) + '\n\n'
                + 'Return JSON with this exact structure:\n'
                + '{\n'
                + '  "title": "Job title",\n'
                + '  "company": "Company name or empty string",\n'
                + '  "seniority": "Entry|Mid|Senior|Executive",\n'
                + '  "roles": ["functional area 1", "functional area 2"],\n'
                + '  "skills": [\n'
                + '    {"name": "Skill Name", "requirement": "Required|Preferred|Nice-to-have", "proficiency": "Novice|Competent|Proficient|Expert|Mastery", "category": "Technical|Leadership|Business|Communication|Domain"}\n'
                + '  ]\n'
                + '}\n\n'
                + 'Rules:\n'
                + '- Extract 15-30 distinct skills from explicit requirements AND implied competencies\n'
                + '- Use professional skill names (e.g., "Strategic Planning" not "plan stuff")\n'
                + '- CRITICAL: Normalize skill names to match this vocabulary where possible: ' + vocabHint + '\n'
                + '- Use the FULL form of abbreviations (e.g., "Applicant Tracking System" not "ATS", "Customer Relationship Management" not "CRM") so matching works across profiles\n'
                + '- For skills NOT in the above list, use standard industry terminology (O*NET, LinkedIn Skills, etc.)\n'
                + '- Include both hard and soft skills\n'
                + '- Infer skills from responsibilities even if not explicitly listed\n'
                + '- requirement: Required for must-haves, Preferred for should-haves, Nice-to-have for bonus skills\n'
                + '- proficiency: infer the MINIMUM proficiency the job demands for each skill based on seniority and context:\n'
                + '  Novice = basic awareness, Competent = can do with guidance, Proficient = independent and effective,\n'
                + '  Expert = deep mastery and can teach others, Mastery = industry-leading authority\n'
                + '  For Executive/Senior roles, default most core skills to Expert or Mastery.\n'
                + '  For Mid roles, default to Proficient. For Entry, default to Competent or Novice.\n'
                + '- For common role-implied skills that are obvious but unstated (e.g., ATS for recruiters, Excel for analysts, Git for developers), include them as Preferred';
            
            var response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 2000,
                    system: systemPrompt,
                    messages: [{ role: 'user', content: userPrompt }]
                })
            });
            
            if (!response.ok) {
                var errBody = await response.text().catch(function() { return ''; });
                if (response.status === 401) throw new Error('Invalid API key. Check your key at console.anthropic.com.');
                if (response.status === 429) throw new Error('Rate limited. Wait a moment and try again.');
                throw new Error('API error (' + response.status + '): ' + (errBody.substring(0, 100) || 'Unknown'));
            }
            
            var data = await response.json();
            var text = data.content.map(function(c) { return c.text || ''; }).join('');
            
            // Parse JSON, strip any fences
            text = text.replace(/```json|```/g, '').trim();
            var parsed = JSON.parse(text);
            return parsed;
        }
        
        // ===== LOCAL FALLBACK PARSING =====
        
        function parseJobLocally(jdText) {
            var text = jdText.toLowerCase();
            var lines = jdText.split('\n');
            
            // ===== TITLE EXTRACTION =====
            // Skip meta lines, find first line that looks like a job title
            var title = '';
            var company = '';
            var skipPatterns = /^(about|we are|our |the |at |join|summary|generated|posted|apply|location|date|salary|benefits|equal|eeo|disclaimer|copyright|\d+\s*(day|hour|week|ago))/i;
            var titlePatterns = /\b(manager|director|lead|head|chief|vp|vice|president|senior|junior|engineer|designer|developer|analyst|recruiter|coordinator|specialist|consultant|architect|strategist|officer|partner|associate|advisor|scientist)\b/i;
            
            for (var i = 0; i < Math.min(lines.length, 15); i++) {
                var line = lines[i].trim();
                if (line.length < 5 || line.length > 150) continue;
                if (skipPatterns.test(line)) continue;
                
                // Prefer lines that contain a role keyword
                if (!title && titlePatterns.test(line)) {
                    title = line.replace(/^(job title|position|role|opening|title)[\s:\-]+/i, '').trim();
                    continue;
                }
                // Otherwise take the first substantial non-meta line
                if (!title && line.length > 8 && line.length < 120) {
                    title = line;
                }
            }
            
            // Try to extract company from common patterns
            var companyMatch = jdText.match(/(?:company|employer|organization|at)\s*[:|\-]?\s*([A-Z][A-Za-z0-9\s&.,]+)/);
            if (companyMatch) company = companyMatch[1].trim().substring(0, 60);
            if (!company) {
                // Try "About [Company]" pattern
                var aboutMatch = jdText.match(/about\s+([A-Z][A-Za-z0-9\s&]+?)(?:\n|\.|\,)/);
                if (aboutMatch && aboutMatch[1].length < 50) company = aboutMatch[1].trim();
            }
            
            // ===== SENIORITY (detect early for proficiency inference) =====
            var seniority = 'Mid';
            if (/\b(vp|vice president|chief|c-suite|head of|svp|evp)\b/i.test(jdText)) seniority = 'Executive';
            else if (/\b(senior director|director|principal|senior manager)\b/i.test(jdText)) seniority = 'Senior';
            else if (/\b(junior|entry|associate|intern|coordinator)\b/i.test(jdText)) seniority = 'Entry';
            
            // ===== SKILL EXTRACTION =====
            var skillMatches = [];
            var seen = new Set();
            var allSkills = skillsData.skills || [];
            
            // First pass: match user's own skill names in JD text
            allSkills.forEach(function(skill) {
                var skillLower = skill.name.toLowerCase();
                if (skillLower.length > 3 && text.indexOf(skillLower) !== -1 && !seen.has(skillLower)) {
                    seen.add(skillLower);
                    skillMatches.push({
                        name: skill.name,
                        requirement: classifyRequirementLevel(text, skillLower),
                        proficiency: inferJobProficiency(text, skillLower, seniority),
                        category: skill.category || 'General'
                    });
                }
            });
            
            // Second pass: check the full O*NET library if loaded
            if (skillLibraryIndex && skillLibraryIndex.index) {
                skillLibraryIndex.index.forEach(function(libSkill) {
                    var n = (libSkill.n || libSkill.name || '').toLowerCase();
                    if (n.length > 3 && text.indexOf(n) !== -1 && !seen.has(n)) {
                        seen.add(n);
                        skillMatches.push({
                            name: libSkill.n || libSkill.name,
                            requirement: classifyRequirementLevel(text, n),
                            proficiency: inferJobProficiency(text, n, seniority),
                            category: libSkill.c || libSkill.category || 'General'
                        });
                    }
                });
            }
            
            // Third pass: comprehensive skill keyword dictionary
            var skillDictionary = [
                // Recruiting & Talent
                'Talent Acquisition', 'Full-Cycle Recruiting', 'Sourcing', 'Boolean Search', 'Candidate Experience',
                'Employer Branding', 'Applicant Tracking System', 'ATS', 'Onboarding', 'Workforce Planning',
                'Diversity Recruiting', 'Campus Recruiting', 'Executive Search', 'Headhunting', 'Interviewing',
                'Offer Negotiation', 'Recruitment Marketing', 'Talent Pipeline', 'Screening', 'Reference Checking',
                // HR
                'Human Resources', 'Employee Relations', 'Performance Management', 'Compensation', 'Benefits Administration',
                'HRIS', 'Succession Planning', 'Organizational Development', 'Compliance', 'Labor Relations',
                'Employee Engagement', 'Retention', 'Training and Development', 'Learning and Development',
                // Project & Program Management
                'Project Management', 'Program Management', 'Strategic Planning', 'Roadmap', 'Risk Management',
                'Agile', 'Scrum', 'Kanban', 'Waterfall', 'Sprint Planning', 'JIRA', 'Confluence',
                'Stakeholder Management', 'Change Management', 'Process Improvement', 'Continuous Improvement',
                // Leadership
                'Team Leadership', 'People Management', 'Cross-Functional Collaboration', 'Mentoring',
                'Coaching', 'Executive Presence', 'Decision Making', 'Conflict Resolution', 'Delegation',
                // Communication
                'Communication', 'Presentation', 'Public Speaking', 'Technical Writing', 'Copywriting',
                'Storytelling', 'Negotiation', 'Persuasion', 'Active Listening', 'Relationship Building',
                // Technical
                'Python', 'JavaScript', 'TypeScript', 'React', 'Node.js', 'SQL', 'NoSQL',
                'AWS', 'Azure', 'GCP', 'Cloud Computing', 'DevOps', 'CI/CD', 'Docker', 'Kubernetes',
                'Machine Learning', 'Artificial Intelligence', 'Data Science', 'Data Engineering',
                'API Design', 'Microservices', 'System Design', 'Architecture',
                // Data & Analytics
                'Data Analysis', 'Business Intelligence', 'Tableau', 'Power BI', 'Excel',
                'SQL', 'Reporting', 'Dashboards', 'KPI', 'Metrics', 'Forecasting', 'Modeling',
                // Business
                'Business Development', 'Sales Strategy', 'Account Management', 'Pipeline Management',
                'Revenue Growth', 'Client Relations', 'Customer Success', 'Market Research',
                'Product Management', 'UX Design', 'User Research', 'A/B Testing', 'Go-to-Market',
                'Budgeting', 'Financial Analysis', 'P&L Management', 'Vendor Management',
                // Strategy
                'Strategy', 'Innovation', 'Transformation', 'Digital Transformation', 'Thought Leadership',
                'Competitive Analysis', 'Market Analysis', 'Business Strategy', 'GTM Strategy',
                // Marketing
                'Content Marketing', 'SEO', 'SEM', 'Social Media', 'Email Marketing', 'Brand Strategy',
                'Demand Generation', 'Lead Generation', 'Marketing Automation', 'CRM',
                // Soft Skills
                'Problem Solving', 'Critical Thinking', 'Analytical Thinking', 'Attention to Detail',
                'Time Management', 'Adaptability', 'Creativity', 'Emotional Intelligence',
                'Collaboration', 'Teamwork', 'Self-Motivation', 'Results-Oriented'
            ];
            
            skillDictionary.forEach(function(skill) {
                var lower = skill.toLowerCase();
                if (text.indexOf(lower) !== -1 && !seen.has(lower)) {
                    seen.add(lower);
                    skillMatches.push({ name: skill, requirement: classifyRequirementLevel(text, lower), proficiency: inferJobProficiency(text, lower, seniority), category: 'General' });
                }
            });
            
            // Fourth pass: extract phrase-level skills from requirement lines
            // Look for bullet-pointed or numbered requirements
            var reqLines = jdText.split('\n').filter(function(line) {
                return /^\s*[\u2022\u2023\u25E6\u2043\-\*\u2713\u2714]\s|^\s*\d+[\.\)]\s|^\s*[a-z][\.\)]\s/i.test(line);
            });
            
            // Common skill-indicator phrases in requirements
            var phrasePatterns = [
                /(\d+)\+?\s*years?\s+(?:of\s+)?(?:experience\s+(?:in|with)\s+)?(.+?)(?:\.|,|;|$)/gi,
                /(?:proficien|experienc|knowledge|expertise|skill|familiar)\w*\s+(?:in|with|of)\s+(.+?)(?:\.|,|;|$)/gi,
                /(?:strong|excellent|proven|demonstrated)\s+(.+?)(?:\s+(?:skills?|abilities?|experience))(?:\.|,|;|$)/gi
            ];
            
            reqLines.forEach(function(line) {
                phrasePatterns.forEach(function(pat) {
                    var m;
                    pat.lastIndex = 0;
                    while ((m = pat.exec(line)) !== null) {
                        var extracted = (m[2] || m[1] || '').trim();
                        // Clean up and split on conjunctions
                        extracted.split(/\s*(?:and|or|,)\s*/).forEach(function(phrase) {
                            phrase = phrase.replace(/^\s*(?:a|an|the)\s+/i, '').trim();
                            if (phrase.length > 2 && phrase.length < 50 && !seen.has(phrase.toLowerCase())) {
                                seen.add(phrase.toLowerCase());
                                // Capitalize first letter of each word
                                var clean = phrase.replace(/\b\w/g, function(c) { return c.toUpperCase(); });
                                skillMatches.push({ name: clean, requirement: classifyRequirementLevel(text, phrase.toLowerCase()), proficiency: inferJobProficiency(text, phrase.toLowerCase(), seniority), category: 'Extracted' });
                            }
                        });
                    }
                });
            });
            
            // Extract roles/departments
            var roles = [];
            var rolePatterns = { 'Engineering': /engineer|develop|software|technical/i, 'Product': /product|ux|design/i,
                'Marketing': /marketing|brand|content|growth/i, 'Sales': /sales|revenue|account|business development/i,
                'Data': /data|analy|science|ml|ai/i, 'Operations': /operations|supply|logistics/i,
                'Finance': /finance|accounting|budget|treasury/i, 'HR': /human resources|talent|recruiting|people/i,
                'Strategy': /strategy|strateg|transformation|innovation/i, 'Leadership': /leader|executive|management/i
            };
            Object.keys(rolePatterns).forEach(function(role) { if (rolePatterns[role].test(jdText)) roles.push(role); });
            if (roles.length === 0) roles.push('General');
            
            return {
                title: title || 'Untitled Position',
                company: company,
                seniority: seniority,
                roles: roles,
                skills: skillMatches.slice(0, 30)
            };
        }
        
        function classifyRequirementLevel(text, skillLower) {
            // Look for context around the skill mention
            var idx = text.indexOf(skillLower);
            if (idx === -1) return 'Required';
            var context = text.substring(Math.max(0, idx - 100), Math.min(text.length, idx + 100));
            if (/nice.to.have|bonus|plus|preferred|ideal/i.test(context)) return 'Nice-to-have';
            if (/prefer|desired|strongly prefer/i.test(context)) return 'Preferred';
            return 'Required';
        }
        
        function inferJobProficiency(text, skillLower, seniority) {
            // Infer minimum proficiency from context and seniority
            var idx = text.indexOf(skillLower);
            var context = idx >= 0 ? text.substring(Math.max(0, idx - 150), Math.min(text.length, idx + 150)) : '';
            
            // Context clues for specific proficiency
            if (/master|authority|world.class|industry.leading|thought leader|deep expertise/i.test(context)) return 'Mastery';
            if (/expert|extensive|advanced|senior|deep|strong|proven track/i.test(context)) return 'Expert';
            if (/proficien|solid|experienced|demonstrated|working knowledge/i.test(context)) return 'Proficient';
            if (/familiar|basic|exposure|awareness|entry|junior/i.test(context)) return 'Competent';
            
            // Years context
            var yearsMatch = context.match(/(\d+)\+?\s*years/);
            if (yearsMatch) {
                var yrs = parseInt(yearsMatch[1]);
                if (yrs >= 10) return 'Mastery';
                if (yrs >= 7) return 'Expert';
                if (yrs >= 4) return 'Proficient';
                if (yrs >= 2) return 'Competent';
                return 'Novice';
            }
            
            // Fall back to seniority-based default
            if (seniority === 'Executive') return 'Expert';
            if (seniority === 'Senior') return 'Proficient';
            if (seniority === 'Entry') return 'Competent';
            return 'Proficient'; // Mid default
        }
        
        // ===== PROFICIENCY SCALE =====
        var PROFICIENCY_SCALE = { 'Novice': 1, 'Competent': 2, 'Proficient': 3, 'Advanced': 3.5, 'Expert': 4, 'Mastery': 5 };
        
        function proficiencyValue(level) {
            return PROFICIENCY_SCALE[level] || PROFICIENCY_SCALE['Proficient'];
        }
        
        // ===== SKILL REGISTRY UTILITIES =====
        
        // Register a skill in the searchable library index (deduped by name)
        function registerInSkillLibrary(skillName, category) {
            if (!skillLibraryIndex) return;
            if (!skillLibraryIndex.index) skillLibraryIndex.index = [];
            var lower = skillName.toLowerCase();
            var exists = skillLibraryIndex.index.some(function(s) {
                return (s.n || s.name || '').toLowerCase() === lower;
            });
            if (!exists) {
                skillLibraryIndex.index.push({ n: skillName, c: category || 'Custom', source: 'custom' });
                if (skillLibraryIndex.totalSkills) skillLibraryIndex.totalSkills++;
                console.log('📚 Registered in skill library:', skillName);
            }
        }
        window.registerInSkillLibrary = registerInSkillLibrary;
        
        // ===== COMPREHENSIVE SKILL SYNONYMS =====
        // Bidirectional: abbreviation ↔ full name, plus common variants
        var SKILL_SYNONYMS = {
            // Recruiting & HR
            'ats': ['applicant tracking system', 'applicant tracking systems', 'applicant tracking'],
            'applicant tracking system': ['ats'],
            'hris': ['human resources information system', 'hr information system', 'hcm'],
            'hcm': ['human capital management', 'hris'],
            'deib': ['diversity equity inclusion belonging', 'dei', 'diversity recruiting'],
            'dei': ['diversity equity inclusion', 'deib', 'diversity recruiting'],
            // Business & Strategy
            'crm': ['customer relationship management', 'salesforce', 'hubspot crm'],
            'erp': ['enterprise resource planning', 'sap', 'oracle erp'],
            'kpi': ['key performance indicator', 'key performance indicators', 'metrics'],
            'kpis': ['key performance indicators', 'kpi', 'metrics'],
            'roi': ['return on investment'],
            'p&l': ['profit and loss', 'p&l management', 'financial management'],
            'gtm': ['go-to-market', 'go to market', 'gtm strategy'],
            'go-to-market': ['gtm', 'gtm strategy'],
            'okr': ['objectives and key results', 'okrs'],
            'okrs': ['objectives and key results', 'okr'],
            'b2b': ['business-to-business', 'business to business'],
            'b2c': ['business-to-consumer', 'business to consumer'],
            'saas': ['software as a service', 'cloud software'],
            // Technical
            'ml': ['machine learning'],
            'ai': ['artificial intelligence'],
            'nlp': ['natural language processing'],
            'ci/cd': ['continuous integration', 'continuous deployment', 'continuous integration/continuous deployment'],
            'devops': ['development operations', 'dev ops'],
            'seo': ['search engine optimization'],
            'sem': ['search engine marketing', 'paid search'],
            'ux': ['user experience', 'ux design'],
            'ui': ['user interface', 'ui design'],
            'qa': ['quality assurance', 'testing'],
            'api': ['application programming interface', 'api design', 'api development'],
            'sdk': ['software development kit'],
            'sql': ['structured query language', 'database querying'],
            'aws': ['amazon web services'],
            'gcp': ['google cloud platform'],
            // Project Management
            'pmp': ['project management professional', 'project management'],
            'scrum': ['scrum methodology', 'agile scrum'],
            'jira': ['jira project management', 'atlassian jira'],
            // Communication & Leadership
            'executive presence': ['leadership presence', 'gravitas'],
            'storytelling': ['narrative', 'business storytelling', 'data storytelling'],
            'stakeholder management': ['stakeholder engagement', 'stakeholder relations'],
            'change management': ['organizational change', 'change leadership', 'transformation'],
            'cross-functional collaboration': ['cross functional collaboration', 'cross-team collaboration', 'interdepartmental collaboration'],
            // Common variations (singular/plural, hyphenation)
            'problem solving': ['problem-solving'],
            'decision making': ['decision-making'],
            'team leadership': ['team management', 'people management', 'people leadership'],
            'people management': ['team management', 'team leadership', 'direct reports management'],
            'data analysis': ['data analytics', 'analytics', 'data-driven decision making'],
            'strategic planning': ['strategy development', 'strategic thinking', 'business strategy'],
            'talent acquisition': ['recruiting', 'recruitment', 'talent management'],
            'full-cycle recruiting': ['full cycle recruiting', 'full lifecycle recruiting', 'end-to-end recruiting'],
            'boolean search': ['boolean sourcing', 'advanced sourcing', 'sourcing techniques'],
            'sourcing': ['talent sourcing', 'candidate sourcing'],
            'offer negotiation': ['compensation negotiation', 'salary negotiation'],
            'employer branding': ['employer brand', 'employment branding', 'talent branding'],
            'workforce planning': ['headcount planning', 'capacity planning', 'workforce strategy'],
            'employee engagement': ['engagement strategy', 'employee experience'],
            'performance management': ['performance review', 'performance evaluation', 'performance coaching'],
            'succession planning': ['talent pipeline planning', 'leadership pipeline'],
            'compensation': ['compensation and benefits', 'total rewards', 'comp and ben'],
            'vendor management': ['vendor relations', 'supplier management', 'third-party management'],
            'process improvement': ['continuous improvement', 'lean', 'six sigma', 'process optimization'],
            'digital transformation': ['digital strategy', 'digitalization'],
            'market research': ['market analysis', 'competitive intelligence', 'market intelligence'],
            'business development': ['biz dev', 'business growth', 'partnership development'],
            'account management': ['account management', 'client management', 'key account management'],
            'financial analysis': ['financial modeling', 'financial planning', 'fp&a'],
            'fp&a': ['financial planning and analysis', 'financial analysis'],
            'content marketing': ['content strategy', 'content creation'],
            'demand generation': ['demand gen', 'lead generation', 'pipeline generation'],
            'marketing automation': ['martech', 'marketing technology'],
            'product management': ['product strategy', 'product development', 'product ownership'],
            'user research': ['ux research', 'customer research', 'user testing']
        };
        
        // Build a fast lookup: lowercased name → array of synonym lowercased names
        var _synonymLookup = {};
        Object.keys(SKILL_SYNONYMS).forEach(function(key) {
            var lower = key.toLowerCase();
            if (!_synonymLookup[lower]) _synonymLookup[lower] = [];
            SKILL_SYNONYMS[key].forEach(function(syn) {
                var synLower = syn.toLowerCase();
                _synonymLookup[lower].push(synLower);
                // Bidirectional: also map synonym back to key
                if (!_synonymLookup[synLower]) _synonymLookup[synLower] = [];
                if (_synonymLookup[synLower].indexOf(lower) === -1) _synonymLookup[synLower].push(lower);
            });
        });
        
        // Get all known synonyms for a skill name (lowercased)
        function getSkillSynonyms(skillNameLower) {
            return _synonymLookup[skillNameLower] || [];
        }
        
        // ===== ROLE-TO-SKILL MAPPING =====
        // Expected skills for common roles with typical proficiency levels
        var ROLE_SKILL_MAP = {
            'recruiter': [
                { name: 'Applicant Tracking System', level: 'Proficient' }, { name: 'Full-Cycle Recruiting', level: 'Proficient' },
                { name: 'Boolean Search', level: 'Proficient' }, { name: 'Sourcing', level: 'Expert' },
                { name: 'Candidate Experience', level: 'Proficient' }, { name: 'Interviewing', level: 'Expert' },
                { name: 'Offer Negotiation', level: 'Proficient' }, { name: 'Employer Branding', level: 'Competent' },
                { name: 'Diversity Recruiting', level: 'Competent' }, { name: 'Talent Pipeline', level: 'Proficient' },
                { name: 'Screening', level: 'Expert' }, { name: 'Stakeholder Management', level: 'Proficient' },
                { name: 'Recruitment Marketing', level: 'Competent' }, { name: 'Workforce Planning', level: 'Competent' }
            ],
            'talent acquisition': [
                { name: 'Applicant Tracking System', level: 'Expert' }, { name: 'Full-Cycle Recruiting', level: 'Expert' },
                { name: 'Sourcing', level: 'Expert' }, { name: 'Boolean Search', level: 'Proficient' },
                { name: 'Employer Branding', level: 'Proficient' }, { name: 'Workforce Planning', level: 'Proficient' },
                { name: 'Diversity Recruiting', level: 'Proficient' }, { name: 'Talent Pipeline', level: 'Expert' },
                { name: 'Stakeholder Management', level: 'Expert' }, { name: 'Data Analysis', level: 'Competent' },
                { name: 'Recruitment Marketing', level: 'Proficient' }, { name: 'Vendor Management', level: 'Competent' }
            ],
            'product manager': [
                { name: 'Product Management', level: 'Expert' }, { name: 'Roadmap', level: 'Expert' },
                { name: 'A/B Testing', level: 'Proficient' }, { name: 'User Research', level: 'Proficient' },
                { name: 'Data Analysis', level: 'Proficient' }, { name: 'Stakeholder Management', level: 'Expert' },
                { name: 'Go-to-Market', level: 'Proficient' }, { name: 'Agile', level: 'Expert' },
                { name: 'Strategic Planning', level: 'Proficient' }, { name: 'Cross-Functional Collaboration', level: 'Expert' },
                { name: 'JIRA', level: 'Proficient' }, { name: 'SQL', level: 'Competent' }
            ],
            'software engineer': [
                { name: 'System Design', level: 'Proficient' }, { name: 'API Design', level: 'Proficient' },
                { name: 'CI/CD', level: 'Proficient' }, { name: 'Git', level: 'Expert' },
                { name: 'Code Review', level: 'Proficient' }, { name: 'Testing', level: 'Proficient' },
                { name: 'Agile', level: 'Proficient' }, { name: 'Problem Solving', level: 'Expert' },
                { name: 'Technical Writing', level: 'Competent' }, { name: 'Cloud Computing', level: 'Competent' }
            ],
            'data analyst': [
                { name: 'SQL', level: 'Expert' }, { name: 'Excel', level: 'Expert' },
                { name: 'Data Analysis', level: 'Expert' }, { name: 'Tableau', level: 'Proficient' },
                { name: 'Python', level: 'Competent' }, { name: 'Reporting', level: 'Expert' },
                { name: 'Business Intelligence', level: 'Proficient' }, { name: 'Dashboards', level: 'Proficient' },
                { name: 'Forecasting', level: 'Competent' }, { name: 'Presentation', level: 'Proficient' }
            ],
            'marketing manager': [
                { name: 'Content Marketing', level: 'Expert' }, { name: 'SEO', level: 'Proficient' },
                { name: 'Social Media', level: 'Expert' }, { name: 'Email Marketing', level: 'Proficient' },
                { name: 'Brand Strategy', level: 'Expert' }, { name: 'Marketing Automation', level: 'Proficient' },
                { name: 'Data Analysis', level: 'Competent' }, { name: 'CRM', level: 'Proficient' },
                { name: 'Demand Generation', level: 'Proficient' }, { name: 'Budgeting', level: 'Proficient' }
            ],
            'hr': [
                { name: 'Human Resources', level: 'Expert' }, { name: 'Employee Relations', level: 'Proficient' },
                { name: 'Performance Management', level: 'Proficient' }, { name: 'Compensation', level: 'Proficient' },
                { name: 'HRIS', level: 'Proficient' }, { name: 'Compliance', level: 'Proficient' },
                { name: 'Succession Planning', level: 'Competent' }, { name: 'Employee Engagement', level: 'Proficient' },
                { name: 'Training and Development', level: 'Competent' }, { name: 'Change Management', level: 'Competent' }
            ],
            'strategy': [
                { name: 'Strategic Planning', level: 'Expert' }, { name: 'Business Strategy', level: 'Expert' },
                { name: 'Competitive Analysis', level: 'Expert' }, { name: 'Market Analysis', level: 'Expert' },
                { name: 'Financial Analysis', level: 'Proficient' }, { name: 'Stakeholder Management', level: 'Expert' },
                { name: 'Change Management', level: 'Proficient' }, { name: 'Presentation', level: 'Expert' },
                { name: 'Data Analysis', level: 'Proficient' }, { name: 'Innovation', level: 'Expert' }
            ],
            'sales': [
                { name: 'Sales Strategy', level: 'Expert' }, { name: 'Pipeline Management', level: 'Expert' },
                { name: 'CRM', level: 'Expert' }, { name: 'Negotiation', level: 'Expert' },
                { name: 'Account Management', level: 'Proficient' }, { name: 'Client Relations', level: 'Expert' },
                { name: 'Revenue Growth', level: 'Proficient' }, { name: 'Presentation', level: 'Proficient' },
                { name: 'Forecasting', level: 'Proficient' }, { name: 'Business Development', level: 'Proficient' }
            ],
            'project manager': [
                { name: 'Project Management', level: 'Expert' }, { name: 'Agile', level: 'Expert' },
                { name: 'Stakeholder Management', level: 'Expert' }, { name: 'Risk Management', level: 'Proficient' },
                { name: 'Budgeting', level: 'Proficient' }, { name: 'JIRA', level: 'Expert' },
                { name: 'Change Management', level: 'Proficient' }, { name: 'Process Improvement', level: 'Proficient' },
                { name: 'Cross-Functional Collaboration', level: 'Expert' }, { name: 'Communication', level: 'Expert' }
            ],
            'ux designer': [
                { name: 'UX Design', level: 'Expert' }, { name: 'User Research', level: 'Expert' },
                { name: 'Wireframing', level: 'Expert' }, { name: 'Prototyping', level: 'Expert' },
                { name: 'Usability Testing', level: 'Proficient' }, { name: 'Design Systems', level: 'Proficient' },
                { name: 'Figma', level: 'Expert' }, { name: 'Accessibility', level: 'Proficient' },
                { name: 'Information Architecture', level: 'Proficient' }, { name: 'Interaction Design', level: 'Expert' }
            ],
            'customer success': [
                { name: 'Customer Success', level: 'Expert' }, { name: 'Account Management', level: 'Expert' },
                { name: 'CRM', level: 'Proficient' }, { name: 'Client Relations', level: 'Expert' },
                { name: 'Onboarding', level: 'Proficient' }, { name: 'Data Analysis', level: 'Competent' },
                { name: 'Presentation', level: 'Proficient' }, { name: 'Negotiation', level: 'Proficient' },
                { name: 'Process Improvement', level: 'Competent' }, { name: 'Cross-Functional Collaboration', level: 'Proficient' }
            ],
            'operations': [
                { name: 'Process Improvement', level: 'Expert' }, { name: 'Project Management', level: 'Proficient' },
                { name: 'Data Analysis', level: 'Proficient' }, { name: 'Budgeting', level: 'Proficient' },
                { name: 'Vendor Management', level: 'Expert' }, { name: 'Risk Management', level: 'Proficient' },
                { name: 'Compliance', level: 'Proficient' }, { name: 'Strategic Planning', level: 'Proficient' },
                { name: 'Change Management', level: 'Proficient' }, { name: 'Reporting', level: 'Expert' }
            ],
            'executive': [
                { name: 'Strategic Planning', level: 'Mastery' }, { name: 'Executive Presence', level: 'Expert' },
                { name: 'Stakeholder Management', level: 'Mastery' }, { name: 'Change Management', level: 'Expert' },
                { name: 'P&L Management', level: 'Expert' }, { name: 'Board Relations', level: 'Proficient' },
                { name: 'Cross-Functional Collaboration', level: 'Expert' }, { name: 'Innovation', level: 'Expert' },
                { name: 'Talent Development', level: 'Expert' }, { name: 'Business Strategy', level: 'Mastery' }
            ],
            'futurist': [
                { name: 'Strategic Planning', level: 'Mastery' }, { name: 'Innovation', level: 'Mastery' },
                { name: 'Thought Leadership', level: 'Expert' }, { name: 'Market Research', level: 'Expert' },
                { name: 'Data Analysis', level: 'Proficient' }, { name: 'Public Speaking', level: 'Expert' },
                { name: 'Storytelling', level: 'Expert' }, { name: 'Digital Transformation', level: 'Expert' },
                { name: 'Competitive Analysis', level: 'Expert' }, { name: 'Presentation', level: 'Expert' }
            ],
            'content': [
                { name: 'Content Marketing', level: 'Expert' }, { name: 'Copywriting', level: 'Expert' },
                { name: 'SEO', level: 'Proficient' }, { name: 'Storytelling', level: 'Expert' },
                { name: 'Social Media', level: 'Proficient' }, { name: 'Brand Strategy', level: 'Proficient' },
                { name: 'Data Analysis', level: 'Competent' }, { name: 'Email Marketing', level: 'Proficient' },
                { name: 'Content Marketing', level: 'Expert' }, { name: 'Technical Writing', level: 'Competent' }
            ],
            'general manager': [
                { name: 'P&L Management', level: 'Expert' }, { name: 'Strategic Planning', level: 'Expert' },
                { name: 'Team Leadership', level: 'Expert' }, { name: 'Budgeting', level: 'Expert' },
                { name: 'Stakeholder Management', level: 'Expert' }, { name: 'Cross-Functional Collaboration', level: 'Expert' },
                { name: 'Business Development', level: 'Proficient' }, { name: 'Change Management', level: 'Proficient' },
                { name: 'Data Analysis', level: 'Proficient' }, { name: 'Vendor Management', level: 'Proficient' }
            ]
        };
        
        // Get suggested skills for a user based on their roles
        function getRoleSuggestions() {
            var userRoles = userData.roles || [];
            var userSkillNames = new Set((skillsData.skills || []).map(function(s) { return s.name.toLowerCase(); }));
            // Also build synonym-aware set
            var userSkillSynonyms = new Set();
            userSkillNames.forEach(function(n) {
                userSkillSynonyms.add(n);
                getSkillSynonyms(n).forEach(function(syn) { userSkillSynonyms.add(syn); });
            });
            
            var suggestions = [];
            var seen = new Set();
            
            // Role-name-to-map-key matching with keyword fallbacks
            var ROLE_KEYWORDS = {
                'recruiter': ['recruit', 'sourcing', 'talent acquisition'],
                'talent acquisition': ['talent acquisition', 'ta ', 'recruiting lead', 'head of recruiting'],
                'product manager': ['product', 'pm'],
                'software engineer': ['engineer', 'developer', 'programmer', 'coder'],
                'data analyst': ['data analyst', 'analytics', 'business analyst'],
                'marketing manager': ['marketing', 'growth', 'demand gen'],
                'hr': ['human resource', 'people operations', 'people ops', 'hrbp'],
                'strategy': ['strateg', 'futur', 'advisory', 'consulting'],
                'sales': ['sales', 'revenue', 'business development', 'account executive'],
                'project manager': ['project manager', 'program manager', 'delivery manager'],
                'ux designer': ['ux', 'design', 'user experience'],
                'customer success': ['customer success', 'client success', 'csm'],
                'operations': ['operations', 'ops', 'supply chain'],
                'executive': ['executive', 'vp ', 'vice president', 'chief', 'c-suite', 'general manager', 'gm'],
                'futurist': ['futurist', 'thought leader', 'evangelist'],
                'content': ['content', 'copywrite', 'editorial'],
                'general manager': ['general manager', 'gm', 'country manager', 'regional manager']
            };
            
            userRoles.forEach(function(role) {
                var roleName = role.name.toLowerCase();
                
                // Try exact/partial match first
                var mapKey = Object.keys(ROLE_SKILL_MAP).find(function(k) {
                    return roleName.indexOf(k) !== -1 || k.indexOf(roleName) !== -1;
                });
                
                // Try keyword fallback
                if (!mapKey) {
                    mapKey = Object.keys(ROLE_KEYWORDS).find(function(k) {
                        return ROLE_KEYWORDS[k].some(function(kw) { return roleName.indexOf(kw) !== -1; });
                    });
                }
                
                if (!mapKey || !ROLE_SKILL_MAP[mapKey]) return;
                
                ROLE_SKILL_MAP[mapKey].forEach(function(suggested) {
                    var lower = suggested.name.toLowerCase();
                    // Check both direct name AND synonyms to avoid suggesting skills the user already has under a different name
                    if (!userSkillSynonyms.has(lower) && !seen.has(lower)) {
                        seen.add(lower);
                        suggestions.push({
                            name: suggested.name,
                            level: suggested.level,
                            reason: role.name,
                            roleId: role.id
                        });
                    }
                });
            });
            
            return suggestions;
        }
        
        // ===== MATCH CALCULATION =====
        
        function matchJobToProfile(parsed) {
            var jobSkills = parsed.skills || [];
            var userSkills = skillsData.skills || [];
            
            // Build lookup of user's skills (lowercase → skill object)
            // Include synonym variants for fuzzy matching
            var userMap = {};
            var userNameIndex = []; // for word-overlap search
            userSkills.forEach(function(s) {
                var lower = s.name.toLowerCase();
                userMap[lower] = s;
                userNameIndex.push({ lower: lower, skill: s, words: lower.split(/[\s\-\/&]+/).filter(function(w) { return w.length > 2; }) });
                // Also add simplified versions (strip extra spaces, ampersands)
                var simplified = lower.replace(/\s*&\s*/g, ' ').replace(/\s+/g, ' ').trim();
                if (simplified !== lower) userMap[simplified] = s;
                // Register all known synonyms
                var synonyms = getSkillSynonyms(lower);
                synonyms.forEach(function(syn) {
                    if (!userMap[syn]) userMap[syn] = s;
                });
            });
            
            var matched = [];
            var gaps = [];
            var matchedUserSkills = new Set();
            var totalWeight = 0;
            var earnedWeight = 0;
            
            jobSkills.forEach(function(jobSkill) {
                // Backward compat: support old 'level' field as 'requirement'
                var requirement = jobSkill.requirement || jobSkill.level || 'Required';
                var reqWeight = requirement === 'Required' ? 3 : requirement === 'Preferred' ? 2 : 1;
                totalWeight += reqWeight;
                
                // Job's demanded proficiency (default Proficient if not specified)
                var jobProf = proficiencyValue(jobSkill.proficiency || 'Proficient');
                
                var jLower = jobSkill.name.toLowerCase();
                var jWords = jLower.split(/[\s\-\/&]+/).filter(function(w) { return w.length > 2; });
                var found = null;
                var nameMatchQuality = 0;
                
                // 1. Exact match
                if (userMap[jLower]) {
                    found = userMap[jLower];
                    nameMatchQuality = 1.0;
                }
                
                // 1b. Synonym match: check all synonyms of the job skill
                if (!found) {
                    var jobSynonyms = getSkillSynonyms(jLower);
                    for (var si = 0; si < jobSynonyms.length; si++) {
                        if (userMap[jobSynonyms[si]]) {
                            found = userMap[jobSynonyms[si]];
                            nameMatchQuality = 0.95; // near-exact via synonym
                            break;
                        }
                    }
                }
                
                // 2. Substring containment (one contains the other)
                if (!found) {
                    for (var key in userMap) {
                        if (key.length > 3 && (jLower.indexOf(key) !== -1 || key.indexOf(jLower) !== -1)) {
                            found = userMap[key];
                            nameMatchQuality = 0.85;
                            break;
                        }
                    }
                }
                
                // 3. Word overlap: 50%+ of words match
                if (!found && jWords.length > 0) {
                    var bestOverlap = 0;
                    var bestSkill = null;
                    userNameIndex.forEach(function(entry) {
                        var overlap = 0;
                        jWords.forEach(function(jw) {
                            if (entry.words.some(function(uw) { return uw === jw || (uw.length > 4 && (uw.indexOf(jw) !== -1 || jw.indexOf(uw) !== -1)); })) overlap++;
                        });
                        var score = overlap / Math.max(jWords.length, 1);
                        if (score > bestOverlap && score >= 0.5) {
                            bestOverlap = score;
                            bestSkill = entry.skill;
                        }
                    });
                    if (bestSkill) {
                        found = bestSkill;
                        nameMatchQuality = bestOverlap * 0.75;
                    }
                }
                
                if (found) {
                    // Proficiency comparison
                    var userProf = proficiencyValue(found.level);
                    var profMatch;
                    if (userProf >= jobProf) {
                        profMatch = 1.0; // Meets or exceeds requirement
                    } else {
                        profMatch = userProf / jobProf; // Partial credit (e.g., Competent/Expert = 0.5)
                    }
                    
                    var skillCredit = reqWeight * nameMatchQuality * profMatch;
                    earnedWeight += skillCredit;
                    
                    var profGap = userProf < jobProf;
                    matched.push({
                        jobSkill: jobSkill.name,
                        userSkill: found.name,
                        userLevel: found.level,
                        jobProficiency: jobSkill.proficiency || 'Proficient',
                        requirement: requirement,
                        category: jobSkill.category,
                        nameMatch: nameMatchQuality,
                        profMatch: profMatch,
                        profGap: profGap
                    });
                    matchedUserSkills.add(found.name.toLowerCase());
                } else {
                    gaps.push({
                        name: jobSkill.name,
                        requirement: requirement,
                        proficiency: jobSkill.proficiency || 'Proficient',
                        category: jobSkill.category
                    });
                }
            });
            
            // Surplus: user skills not needed by job
            var surplus = [];
            userSkills.forEach(function(s) {
                if (!matchedUserSkills.has(s.name.toLowerCase())) {
                    surplus.push({ name: s.name, level: s.level, category: s.category });
                }
            });
            
            var score = totalWeight > 0 ? Math.round((earnedWeight / totalWeight) * 100) : 0;
            
            return {
                score: Math.min(score, 100),
                matched: matched,
                gaps: gaps,
                surplus: surplus,
                totalJobSkills: jobSkills.length,
                totalUserSkills: userSkills.length
            };
        }
        
        // ===== RE-SCORE ALL SAVED JOBS =====
        // Called whenever profile skills change (add, edit, remove, proficiency change)
        function rescoreAllJobs() {
            if (!userData.savedJobs || userData.savedJobs.length === 0) return;
            
            var updated = 0;
            userData.savedJobs.forEach(function(job) {
                if (!job.parsedSkills || job.parsedSkills.length === 0) return;
                var oldScore = job.matchData ? job.matchData.score : 0;
                job.matchData = matchJobToProfile({ skills: job.parsedSkills, roles: job.parsedRoles || [] });
                if (job.matchData.score !== oldScore) updated++;
            });
            
            if (updated > 0) {
                saveUserData();
                if (fbUser) saveToFirestore();
                showToast(updated + ' job match score' + (updated > 1 ? 's' : '') + ' updated.', 'info', 3000);
            }
        }
        window.rescoreAllJobs = rescoreAllJobs;
        
        function rescoreOneJob(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job || !job.parsedSkills || job.parsedSkills.length === 0) {
                showToast('No parsed skills for this job. Try Re-analyze instead.', 'warning');
                return;
            }
            var oldScore = job.matchData ? job.matchData.score : 0;
            job.matchData = matchJobToProfile({ skills: job.parsedSkills, roles: job.parsedRoles || [] });
            saveUserData();
            if (fbUser) saveToFirestore();
            showJobDetail(idx);
            var delta = job.matchData.score - oldScore;
            var deltaStr = delta > 0 ? ' (+' + delta + ')' : delta < 0 ? ' (' + delta + ')' : '';
            showToast('Match rescored: ' + job.matchData.score + '%' + deltaStr, 'success', 3000);
        }
        window.rescoreOneJob = rescoreOneJob;
        
        // ===== QUICK-ADD GAP SKILL FROM JOB DETAIL =====
        function quickAddGapSkill(skillName, suggestedLevel, jobIdx) {
            if (readOnlyGuard()) return;
            
            // Check if already in profile
            if (userData.skills.some(function(s) { return s.name.toLowerCase() === skillName.toLowerCase(); })) {
                showToast('"' + skillName + '" is already in your profile.', 'info');
                // Still rescore in case something changed
                rescoreAllJobs();
                showJobDetail(jobIdx);
                return;
            }
            
            // Show inline proficiency picker
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            var levels = ['Novice', 'Competent', 'Proficient', 'Expert', 'Mastery'];
            var sugIdx = levels.indexOf(suggestedLevel);
            if (sugIdx === -1) sugIdx = 2;
            
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left"><h2 class="modal-title">Add Skill: ' + skillName + '</h2></div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button></div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<p style="color:var(--text-secondary); margin-bottom:16px;">This job expects <strong>' + suggestedLevel + '</strong> proficiency. What\'s your actual level?</p>'
                + '<div style="display:flex; flex-direction:column; gap:8px; margin-bottom:20px;">'
                + levels.map(function(lvl, i) {
                    var isSelected = i === sugIdx;
                    var barWidth = ((i + 1) / 5 * 100);
                    var barColor = i < sugIdx ? '#f59e0b' : i === sugIdx ? '#10b981' : '#60a5fa';
                    return '<label style="display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:8px; cursor:pointer; '
                        + 'border:1px solid ' + (isSelected ? 'var(--accent)' : 'var(--border)') + '; '
                        + 'background:' + (isSelected ? 'var(--accent-glow)' : 'transparent') + ';">'
                        + '<input type="radio" name="gapSkillLevel" value="' + lvl + '"' + (isSelected ? ' checked' : '') + ' style="margin:0;">'
                        + '<div style="flex:1;">'
                        + '<div style="font-weight:600; font-size:0.92em;">' + lvl + '</div>'
                        + '<div style="height:4px; width:100%; background:var(--border); border-radius:2px; margin-top:4px;">'
                        + '<div style="height:100%; width:' + barWidth + '%; background:' + barColor + '; border-radius:2px;"></div></div>'
                        + '</div></label>';
                }).join('')
                + '</div>'
                + '<p style="font-size:0.82em; color:var(--text-muted); margin-bottom:16px;">The skill will be added to your profile and all job matches will be rescored automatically.</p>'
                + '<div style="display:flex; gap:10px; justify-content:flex-end;">'
                + '<button onclick="closeExportModal()" style="padding:10px 20px; background:rgba(255,255,255,0.1); border:1px solid var(--border); border-radius:6px; cursor:pointer; color:var(--text-primary);">Cancel</button>'
                + '<button onclick="confirmQuickAddGapSkill(\'' + skillName.replace(/'/g, "\\'") + '\', ' + jobIdx + ')" style="'
                + 'padding:10px 20px; background:var(--accent); color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Add to Profile</button>'
                + '</div></div>';
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.quickAddGapSkill = quickAddGapSkill;
        
        function confirmQuickAddGapSkill(skillName, jobIdx) {
            var level = 'Proficient';
            var checked = document.querySelector('input[name="gapSkillLevel"]:checked');
            if (checked) level = checked.value;
            
            // Add to profile
            var firstRole = (userData.roles && userData.roles[0]) ? userData.roles[0].id : 'general';
            var newSkill = {
                name: skillName,
                category: 'unique',
                level: level,
                roles: [firstRole],
                key: false,
                addedFrom: 'job-gap'
            };
            userData.skills.push(newSkill);
            skillsData.skills.push(newSkill);
            
            // Register in library
            registerInSkillLibrary(skillName, 'unique');
            
            saveUserData();
            if (fbUser) saveToFirestore();
            rescoreAllJobs();
            
            closeExportModal();
            showJobDetail(jobIdx);
            showToast('Added "' + skillName + '" at ' + level + '. Match scores updated.', 'success', 4000);
        }
        window.confirmQuickAddGapSkill = confirmQuickAddGapSkill;
        
        // ===== QUICK-ADD ROLE SUGGESTION =====
        function quickAddSuggested(skillName, level, roleId) {
            if (readOnlyGuard()) return;
            if (userData.skills.some(function(s) { return s.name.toLowerCase() === skillName.toLowerCase(); })) {
                showToast('"' + skillName + '" is already in your profile.', 'info');
                return;
            }
            var newSkill = { name: skillName, category: 'unique', level: level, roles: [roleId], key: false, addedFrom: 'role-suggestion' };
            userData.skills.push(newSkill);
            skillsData.skills.push(newSkill);
            registerInSkillLibrary(skillName, 'unique');
            saveUserData();
            rescoreAllJobs();
            // Re-render card view to update suggestions
            window.cardViewInitialized = false;
            initCardView();
            window.cardViewInitialized = true;
            showToast('Added "' + skillName + '" at ' + level + '.', 'success', 3000);
        }
        window.quickAddSuggested = quickAddSuggested;

        // ===== JOB DETAIL VIEW =====
        
        function showJobDetail(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job) return;
            
            var match = job.matchData || {};
            var matchPct = match.score || 0;
            var matchColor = matchPct >= 70 ? '#10b981' : matchPct >= 45 ? '#f59e0b' : '#6b7280';
            var matched = match.matched || [];
            var gaps = match.gaps || [];
            var surplus = match.surplus || [];
            
            var el = document.getElementById('jobsSubTabContent');
            if (!el) return;
            
            var html = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">'
                + '<button onclick="renderJobsSubTab()" style="background:none; border:none; color:var(--accent); '
                + 'cursor:pointer; font-size:0.88em; padding:0;">\u2190 Back to Pipeline</button>'
                + '<div style="display:flex; gap:8px; align-items:center;">';
            
            var isSampleJob = job.sample === true;
            if (isSampleJob && !fbIsAdmin) {
                html += '<span style="font-size:0.78em; color:var(--text-muted); font-style:italic;">\uD83D\uDD12 Demo job (read-only)</span>';
            } else {
                if (isSampleJob) html += '<span style="font-size:0.72em; color:var(--text-muted); font-style:italic; margin-right:4px;">\uD83D\uDD12 Demo</span>';
                html += '<button onclick="editJobInfo(' + idx + ')" style="background:none; border:1px solid var(--border); '
                    + 'color:var(--text-muted); padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.78em;">\u270E Edit Info</button>'
                    + '<button onclick="rescoreOneJob(' + idx + ')" style="background:none; border:1px solid var(--border); '
                    + 'color:var(--text-muted); padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.78em;">\u21BB Refresh Match</button>'
                    + '<button onclick="reanalyzeJob(' + idx + ')" style="background:none; border:1px solid var(--border); '
                    + 'color:var(--text-muted); padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.78em;">\u21BB Re-analyze</button>'
                    + '<button onclick="removeJob(' + idx + ')" style="background:none; border:1px solid rgba(239,68,68,0.3); '
                    + 'color:#ef4444; padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.78em;">\u2715 Delete</button>';
            }
            html += '</div></div>';
            
            // Header
            html += '<div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:24px; flex-wrap:wrap; gap:16px;">'
                + '<div>'
                + '<h2 style="font-size:1.5em; font-weight:700; color:var(--text-primary); margin:0;">' + (job.title || 'Untitled') + '</h2>'
                + '<div style="color:var(--text-muted); margin-top:4px;">' + (job.company || '') 
                + (job.sourceUrl ? ' \u00B7 <a href="' + job.sourceUrl + '" target="_blank" style="color:var(--accent);">View original</a>' : '') + '</div>'
                + '</div>'
                + '<div style="text-align:center; padding:12px 24px; border-radius:12px; '
                + 'background:' + matchColor + '15; border:2px solid ' + matchColor + '40;">'
                + '<div style="font-size:2em; font-weight:700; color:' + matchColor + ';">' + matchPct + '%</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Overall Match</div>'
                + '</div></div>';
            
            // Network Overlay CTA (prominent, above the fold)
            html += '<div style="display:flex; align-items:center; gap:16px; padding:16px 20px; margin-bottom:20px; '
                + 'border-radius:10px; background:linear-gradient(135deg, rgba(30,64,175,0.12), rgba(96,165,250,0.06)); '
                + 'border:1px solid rgba(96,165,250,0.25);">'
                + '<button onclick="activateJobOverlay(' + idx + ')" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:10px 20px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.9em; display:flex; align-items:center; gap:8px; white-space:nowrap;">'
                + bpIcon('network',16) + ' Compare Skills</button>'
                + '<div style="font-size:0.82em; color:var(--text-muted); line-height:1.4;">'
                + 'See your skills as connected nodes alongside job requirements. Toggle between your network, job view, and match overlay.</div>'
                + '</div>';
            
            // Summary stats
            var profGapCount = matched.filter(function(m) { return m.profGap; }).length;
            html += '<div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; margin-bottom:24px;">'
                + '<div style="text-align:center; padding:16px; border-radius:10px; background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2);">'
                + '<div style="font-size:1.6em; font-weight:700; color:#10b981;">' + matched.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Skills Matched</div></div>'
                + '<div style="text-align:center; padding:16px; border-radius:10px; background:rgba(251,191,36,0.06); border:1px solid rgba(251,191,36,0.15);">'
                + '<div style="font-size:1.6em; font-weight:700; color:#f59e0b;">' + profGapCount + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Proficiency Gaps</div></div>'
                + '<div style="text-align:center; padding:16px; border-radius:10px; background:rgba(239,68,68,0.06); border:1px solid rgba(239,68,68,0.2);">'
                + '<div style="font-size:1.6em; font-weight:700; color:#ef4444;">' + gaps.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Missing Skills</div></div>'
                + '<div style="text-align:center; padding:16px; border-radius:10px; background:rgba(107,114,128,0.06); border:1px solid rgba(107,114,128,0.15);">'
                + '<div style="font-size:1.6em; font-weight:700; color:#6b7280;">' + surplus.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Your Surplus</div></div>'
                + '</div>';
            
            // BLS Salary Range (if available)
            if (job.blsSalary && job.blsSalary.median) {
                var bls = job.blsSalary;
                html += '<div style="margin-bottom:24px; padding:16px 20px; border-radius:10px; '
                    + 'background:rgba(167,139,250,0.06); border:1px solid rgba(167,139,250,0.2);">'
                    + '<div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">'
                    + '<div>'
                    + '<div style="font-size:0.82em; font-weight:600; color:#a78bfa; margin-bottom:4px;">\uD83D\uDCB0 Market Salary Range</div>'
                    + '<div style="font-size:0.78em; color:var(--text-muted);">BLS Match: ' + bls.title + ' (SOC ' + bls.soc + ')</div>'
                    + '</div>'
                    + '<div style="text-align:right;">'
                    + '<div style="font-size:1.3em; font-weight:700; color:#a78bfa;">$' + bls.median.toLocaleString() + '</div>'
                    + '<div style="font-size:0.72em; color:var(--text-muted);">median annual</div>'
                    + '</div></div>';
                
                // Percentile bar
                if (bls.pct10 && bls.pct90) {
                    var range = bls.pct90 - bls.pct10;
                    var p25Pos = bls.pct25 ? ((bls.pct25 - bls.pct10) / range * 100) : 15;
                    var medPos = ((bls.median - bls.pct10) / range * 100);
                    var p75Pos = bls.pct75 ? ((bls.pct75 - bls.pct10) / range * 100) : 85;
                    
                    html += '<div style="margin-top:12px;">'
                        + '<div style="position:relative; height:8px; background:rgba(167,139,250,0.15); border-radius:4px; margin:8px 0;">'
                        + '<div style="position:absolute; left:' + p25Pos + '%; right:' + (100 - p75Pos) + '%; height:100%; background:rgba(167,139,250,0.4); border-radius:4px;"></div>'
                        + '<div style="position:absolute; left:' + medPos + '%; width:3px; height:14px; top:-3px; background:#a78bfa; border-radius:2px;"></div>'
                        + '</div>'
                        + '<div style="display:flex; justify-content:space-between; font-size:0.72em; color:var(--text-muted);">'
                        + '<span>$' + bls.pct10.toLocaleString() + ' (10th)</span>'
                        + '<span>$' + (bls.pct90 || 0).toLocaleString() + ' (90th)</span>'
                        + '</div></div>';
                }
                
                html += '<div style="margin-top:8px; font-size:0.7em; color:var(--text-muted); opacity:0.6;">Source: ' + bls.source + ' \u00B7 National cross-industry</div>'
                    + '</div>';
            }
            
            // Matched skills (with proficiency comparison)
            if (matched.length > 0) {
                html += '<div style="margin-bottom:20px;">'
                    + '<h3 style="font-size:0.95em; font-weight:700; color:#10b981; margin-bottom:10px;">\u2713 Matched Skills</h3>'
                    + '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
                matched.forEach(function(m) {
                    var profColor = m.profGap ? '#f59e0b' : '#10b981';
                    var profLabel = m.userLevel || '';
                    var reqLabel = m.requirement === 'Required' ? ' \u2605' : '';
                    var profTip = m.profGap ? ' (job wants ' + (m.jobProficiency || '?') + ')' : '';
                    html += '<span class="jd-skill-chip jd-chip-matched" style="border-color:' + profColor + '40;" '
                        + 'title="Your level: ' + profLabel + profTip + '">'
                        + m.userSkill + ' <span style="font-size:0.75em; opacity:0.7;">' + profLabel + '</span>' + reqLabel + '</span>';
                });
                html += '</div></div>';
            }
            
            // Gaps (clickable to quick-add)
            if (gaps.length > 0) {
                html += '<div style="margin-bottom:20px;">'
                    + '<h3 style="font-size:0.95em; font-weight:700; color:#ef4444; margin-bottom:10px;">\u25CB Gaps (Job Needs, You Don\u2019t Have)</h3>'
                    + '<p style="font-size:0.75em; color:var(--text-muted); margin-bottom:8px;">Click a skill to add it to your profile</p>'
                    + '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
                gaps.forEach(function(g, gi) {
                    var reqBadge = g.requirement === 'Required' ? ' \u2605' : '';
                    var profLabel = g.proficiency ? ' (' + g.proficiency + ')' : '';
                    html += '<span class="jd-skill-chip jd-chip-gap" style="cursor:pointer;" '
                        + 'onclick="quickAddGapSkill(\'' + g.name.replace(/'/g, "\\'") + '\', \'' + (g.proficiency || 'Proficient') + '\', ' + idx + ')" '
                        + 'title="Click to add to your profile">'
                        + g.name + '<span style="font-size:0.72em; opacity:0.6;">' + profLabel + '</span>' + reqBadge + '</span>';
                });
                html += '</div>'
                    + '<div style="margin-top:8px; font-size:0.75em; color:var(--text-muted);">\u2605 = Required by employer</div>'
                    + '</div>';
            }
            
            // Proficiency gaps (matched skills where you're below the required level)
            var profGaps = matched.filter(function(m) { return m.profGap; });
            if (profGaps.length > 0) {
                html += '<div style="margin-bottom:20px; padding:16px; border-radius:10px; '
                    + 'background:rgba(251,191,36,0.06); border:1px solid rgba(251,191,36,0.15);">'
                    + '<h3 style="font-size:0.95em; font-weight:700; color:#f59e0b; margin-bottom:10px;">\u26A0 Proficiency Gaps (You Have It, But Need to Level Up)</h3>'
                    + '<div style="display:flex; flex-direction:column; gap:6px;">';
                profGaps.forEach(function(m) {
                    var userVal = proficiencyValue(m.userLevel);
                    var jobVal = proficiencyValue(m.jobProficiency);
                    var pct = Math.round((userVal / jobVal) * 100);
                    html += '<div style="display:flex; flex-wrap:wrap; align-items:center; gap:6px 10px; padding:8px 10px; '
                        + 'background:rgba(251,191,36,0.04); border-radius:6px; font-size:0.85em;">'
                        + '<span style="font-weight:600; color:var(--text-primary); flex:1 1 120px;">' + m.userSkill + '</span>'
                        + '<span style="color:#f59e0b;">You: ' + m.userLevel + '</span>'
                        + '<span style="color:var(--text-muted);">\u2192</span>'
                        + '<span style="color:#ef4444;">Need: ' + m.jobProficiency + '</span>'
                        + '</div>';
                });
                html += '</div></div>';
            }
            
            // Role-based skill suggestions (skills expected for your roles but not in profile)
            var roleSuggestions = getRoleSuggestions();
            // Filter to suggestions that are ALSO in the job gaps (most actionable)
            var gapNames = new Set(gaps.map(function(g) { return g.name.toLowerCase(); }));
            var roleGapOverlap = roleSuggestions.filter(function(s) { return gapNames.has(s.name.toLowerCase()); });
            var roleOther = roleSuggestions.filter(function(s) { return !gapNames.has(s.name.toLowerCase()); });
            
            if (roleGapOverlap.length > 0 || roleOther.length > 0) {
                html += '<div style="margin-bottom:20px; padding:16px; border-radius:10px; '
                    + 'background:linear-gradient(135deg, rgba(96,165,250,0.06), rgba(139,92,246,0.04)); '
                    + 'border:1px solid rgba(96,165,250,0.15);">'
                    + '<h3 style="font-size:0.95em; font-weight:700; color:var(--accent); margin-bottom:4px;">'
                    + '\uD83D\uDCA1 Suggested for Your Roles</h3>'
                    + '<p style="font-size:0.75em; color:var(--text-muted); margin-bottom:10px;">Industry-standard skills for your roles. Click to add.</p>';
                if (roleGapOverlap.length > 0) {
                    html += '<p style="font-size:0.78em; font-weight:600; color:#f59e0b; margin-bottom:6px;">Also needed by this job:</p>'
                        + '<div style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px;">';
                    roleGapOverlap.forEach(function(s) {
                        html += '<span style="display:inline-flex; align-items:center; gap:4px; padding:5px 12px; border-radius:16px; '
                            + 'font-size:0.82em; cursor:pointer; background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.25); color:var(--text-secondary);" '
                            + 'onclick="quickAddSuggested(\'' + s.name.replace(/'/g, "\\'") + '\', \'' + s.level + '\', \'' + s.roleId + '\'); showJobDetail(' + idx + ');" '
                            + 'title="Expected for ' + s.reason + ' at ' + s.level + '">+ ' + s.name + '</span>';
                    });
                    html += '</div>';
                }
                if (roleOther.length > 0) {
                    html += '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
                    roleOther.slice(0, 12).forEach(function(s) {
                        html += '<span style="display:inline-flex; align-items:center; gap:4px; padding:5px 12px; border-radius:16px; '
                            + 'font-size:0.82em; cursor:pointer; background:rgba(96,165,250,0.08); border:1px solid rgba(96,165,250,0.2); color:var(--text-secondary);" '
                            + 'onclick="quickAddSuggested(\'' + s.name.replace(/'/g, "\\'") + '\', \'' + s.level + '\', \'' + s.roleId + '\'); showJobDetail(' + idx + ');" '
                            + 'title="Expected for ' + s.reason + ' at ' + s.level + '">+ ' + s.name + '</span>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // Top surplus (capped at 15 to avoid wall of chips)
            if (surplus.length > 0) {
                var showSurplus = surplus.filter(function(s) { return s.level === 'Mastery' || s.level === 'Expert' || s.level === 'Advanced'; }).slice(0, 15);
                if (showSurplus.length === 0) showSurplus = surplus.slice(0, 10);
                html += '<div style="margin-bottom:20px;">'
                    + '<h3 style="font-size:0.95em; font-weight:700; color:#6b7280; margin-bottom:10px;">\u25CF Your Surplus (Not Listed in JD)</h3>'
                    + '<div style="display:flex; flex-wrap:wrap; gap:6px;">';
                showSurplus.forEach(function(s) {
                    html += '<span class="jd-skill-chip jd-chip-surplus">' + s.name + '</span>';
                });
                if (surplus.length > showSurplus.length) {
                    html += '<span style="font-size:0.75em; color:var(--text-muted); padding:4px 8px;">+' + (surplus.length - showSurplus.length) + ' more</span>';
                }
                html += '</div></div>';
            }
            
            // [v4.20.1] Overlay CTA moved to top of job detail
            
            el.innerHTML = html;
        }
        window.showJobDetail = showJobDetail;
        
        function removeJob(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (job && job.sample && !fbIsAdmin) { showToast('Demo jobs cannot be removed.', 'warning'); return; }
            if (!confirm('Remove this job from your pipeline?')) return;
            userData.savedJobs.splice(idx, 1);
            saveUserData();
            if (fbUser) saveToFirestore();
            // Clear overlay if this was the active job
            if (activeJobForNetwork && activeJobForNetwork.id === (userData.savedJobs[idx] || {}).id) {
                clearJobOverlay();
            }
            window.opportunitiesInitialized = false;
            switchView('opportunities');
        }
        window.removeJob = removeJob;
        
        function editJobInfo(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job) return;
            if (job.sample && !fbIsAdmin) { showToast('Demo jobs cannot be edited.', 'warning'); return; }
            
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Edit Job Info</h2>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Job Title</label>'
                + '<input id="editJobTitle" value="' + (job.title || '').replace(/"/g, '&quot;') + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div>'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Company</label>'
                + '<input id="editJobCompany" value="' + (job.company || '').replace(/"/g, '&quot;') + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div></div>'
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Source URL</label>'
                + '<input id="editJobUrl" value="' + (job.sourceUrl || '').replace(/"/g, '&quot;') + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div>'
                + '<div>'
                + '<label style="font-weight:600; color:var(--text-secondary); display:block; margin-bottom:6px; font-size:0.88em;">Source Note</label>'
                + '<input id="editJobNote" value="' + (job.sourceNote || '').replace(/"/g, '&quot;') + '" style="'
                + 'width:100%; padding:10px 12px; background:' + tv('rgba(0,0,0,0.2)','#fff') + '; '
                + 'border:1px solid var(--border); border-radius:6px; color:var(--text-primary); font-size:0.9em;" />'
                + '</div></div>'
                + '<div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">'
                + '<button onclick="closeExportModal()" style="'
                + 'background:transparent; color:var(--text-muted); border:1px solid var(--border); '
                + 'padding:10px 20px; border-radius:8px; cursor:pointer; font-size:0.9em;">Cancel</button>'
                + '<button onclick="saveJobEdit(' + idx + ')" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:10px 24px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.9em;">Save Changes</button>'
                + '</div></div>';
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.editJobInfo = editJobInfo;
        
        function saveJobEdit(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (!job) return;
            
            job.title = (document.getElementById('editJobTitle').value || '').trim() || job.title;
            job.company = (document.getElementById('editJobCompany').value || '').trim();
            job.sourceUrl = (document.getElementById('editJobUrl').value || '').trim();
            job.sourceNote = (document.getElementById('editJobNote').value || '').trim();
            
            saveUserData();
            if (fbUser) saveToFirestore();
            closeExportModal();
            showJobDetail(idx);
            showToast('Job info updated.', 'success');
        }
        window.saveJobEdit = saveJobEdit;
        
        function reanalyzeJob(idx) {
            var job = (userData.savedJobs || [])[idx];
            if (job && job.sample && !fbIsAdmin) { showToast('Demo jobs cannot be re-analyzed.', 'warning'); return; }
            if (!job || !job.rawText) {
                showToast('No raw JD text saved for this job.', 'warning');
                return;
            }
            
            var apiKey = safeGet('wbAnthropicKey') || '';
            
            // Re-parse
            var statusEl = document.getElementById('jobsSubTabContent');
            var origHtml = statusEl.innerHTML;
            statusEl.innerHTML = '<div style="text-align:center; padding:60px 20px;">'
                + '<div class="loading-spinner" style="width:30px; height:30px; border-width:2px; margin:0 auto 12px;"></div>'
                + '<div style="color:var(--text-muted);">Re-analyzing job description...</div></div>';
            
            (async function() {
                try {
                    var parsed;
                    if (apiKey) {
                        parsed = await parseJobWithAPI(job.rawText, apiKey);
                    } else {
                        parsed = parseJobLocally(job.rawText);
                    }
                    
                    var matchData = matchJobToProfile(parsed);
                    
                    // Update job
                    job.parsedSkills = parsed.skills || [];
                    job.parsedRoles = parsed.roles || [];
                    job.matchData = matchData;
                    job.blsSalary = matchJobToBLS(job.title, job.rawText);
                    if (parsed.title && parsed.title !== 'Untitled Position') job.title = parsed.title;
                    if (parsed.company) job.company = parsed.company;
                    
                    saveUserData();
                    if (fbUser) saveToFirestore();
                    
                    showJobDetail(idx);
                    showToast('Re-analyzed: ' + matchData.score + '% match with ' + (matchData.matched || []).length + ' skills.', 'success', 5000);
                } catch (err) {
                    statusEl.innerHTML = origHtml;
                    showToast('Re-analysis failed: ' + (err.message || 'Unknown error'), 'error');
                }
            })();
        }
        window.reanalyzeJob = reanalyzeJob;
        
        function updateMatchThreshold(value) {
            currentMatchThreshold = parseInt(value);
            document.getElementById('matchValue').textContent = value + '%+';
            filterOpportunities();
        }
        
        function calculateMatchScore(jobSkills, requiredSkills) {
            let totalPoints = 0;
            let earnedPoints = 0;
            let matchedSkills = [];
            let gapSkills = [];
            
            // Build lookup of your skills (with synonyms)
            const yourSkillsMap = {};
            skillsData.skills.forEach(skill => {
                var lower = skill.name.toLowerCase();
                yourSkillsMap[lower] = skill;
                var simplified = lower.replace(/\s*&\s*/g, ' ').replace(/\s+/g, ' ').trim();
                if (simplified !== lower) yourSkillsMap[simplified] = skill;
                // Register synonyms
                var syns = getSkillSynonyms(lower);
                syns.forEach(function(syn) { if (!yourSkillsMap[syn]) yourSkillsMap[syn] = skill; });
            });
            
            // Score each required skill
            requiredSkills.forEach(reqSkill => {
                const reqLower = reqSkill.toLowerCase();
                let matched = false;
                let matchPoints = 5; // base points for any match
                
                // Try exact match first (includes synonym-expanded user map)
                if (yourSkillsMap[reqLower]) {
                    const yourSkill = yourSkillsMap[reqLower];
                    matched = true;
                    
                    // Weight by proficiency
                    if (yourSkill.level === 'Mastery') {
                        matchPoints = 10;
                    } else if (yourSkill.level === 'Advanced') {
                        matchPoints = 7;
                    } else if (yourSkill.level === 'Proficient') {
                        matchPoints = 5;
                    }
                    
                    // Bonus for core differentiators
                    if (yourSkill.key) {
                        matchPoints += 5;
                    }
                    
                    matchedSkills.push(yourSkill.name);
                }
                
                // Try job-side synonym resolution
                if (!matched) {
                    var reqSyns = getSkillSynonyms(reqLower);
                    for (var rsi = 0; rsi < reqSyns.length; rsi++) {
                        if (yourSkillsMap[reqSyns[rsi]]) {
                            matched = true;
                            matchPoints = 4; // synonym match
                            matchedSkills.push(yourSkillsMap[reqSyns[rsi]].name);
                            break;
                        }
                    }
                }
                
                if (!matched) {
                    // Try fuzzy matching for related skills
                    for (const [skillName, skillData] of Object.entries(yourSkillsMap)) {
                        if (reqLower.includes(skillName) || skillName.includes(reqLower)) {
                            matched = true;
                            matchPoints = 3; // partial match points
                            matchedSkills.push(skillData.name);
                            break;
                        }
                    }
                }
                
                totalPoints += 10; // Each required skill worth 10 points max
                if (matched) {
                    earnedPoints += matchPoints;
                } else {
                    gapSkills.push(reqSkill);
                }
            });
            
            const matchPercent = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
            
            return {
                score: matchPercent,
                matched: [...new Set(matchedSkills)], // Remove duplicates
                gaps: gapSkills
            };
        }
        // [removed] extractSkillsFromJobEnhanced — dead code cleanup v4.22.0
        // [removed] loadSampleData — dead code cleanup v4.22.0
        // [removed] extractSkillsFromJob — dead code cleanup v4.22.0
        
        function filterOpportunities() {
            renderOpportunities();
        }
        
        function renderOpportunities() {
            var filtered = opportunitiesData.filter(function(job) { return job.matchScore >= currentMatchThreshold; });
            var resultsDiv = document.getElementById('opportunitiesResults');
            if (!resultsDiv) return;
            
            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align:center; padding:40px;">'
                    + '<p style="color:var(--text-primary);">No jobs above ' + currentMatchThreshold + '% match threshold</p>'
                    + '<p style="color:var(--text-muted); font-size:0.88em; margin-top:6px;">' + opportunitiesData.length + ' total results. Try lowering the slider.</p></div>';
                return;
            }
            
            // Summary bar
            var html = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding:8px 0;">'
                + '<span style="font-size:0.88em; color:var(--text-secondary);">'
                + '<strong>' + filtered.length + '</strong> jobs' + (filtered.length < opportunitiesData.length ? ' (of ' + opportunitiesData.length + ')' : '')
                + ' above ' + currentMatchThreshold + '% match</span>'
                + (window._findJobsSources ? '<span style="font-size:0.78em; color:var(--text-muted);">' + window._findJobsSources + '</span>' : '')
                + '</div>';
            
            // Pipeline IDs for dedup check
            var pipelineIds = {};
            (userData.savedJobs || []).forEach(function(j) {
                pipelineIds[(j.title + '-' + (j.company || '')).toLowerCase()] = true;
            });
            
            html += '<div style="display:flex; flex-direction:column; gap:12px;">';
            
            filtered.forEach(function(job, idx) {
                var matchColor = job.matchScore >= 70 ? '#10b981' : job.matchScore >= 45 ? '#f59e0b' : '#6b7280';
                var jobUrl = job.url || '#';
                var salary = job.salary || '';
                var alreadyInPipeline = pipelineIds[(job.title + '-' + (job.company || '')).toLowerCase()];
                
                html += '<div style="padding:16px 20px; border-radius:10px; border:1px solid ' + (job.matchScore >= 70 ? 'rgba(16,185,129,0.3)' : 'var(--border)') + '; '
                    + 'background:' + tv('rgba(0,0,0,0.15)','#fff') + '; transition:border-color 0.2s;">'
                    
                    // Header row
                    + '<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px; margin-bottom:10px;">'
                    + '<div style="flex:1; min-width:0;">'
                    + '<a href="' + jobUrl + '" target="_blank" style="font-size:1.05em; font-weight:600; color:var(--text-primary); text-decoration:none; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"'
                    + ' onmouseover="this.style.color=\'var(--accent)\'" onmouseout="this.style.color=\'var(--text-primary)\'">' + job.title + '</a>'
                    + '<div style="font-size:0.88em; color:var(--text-muted); margin-top:2px;">'
                    + (job.company || 'Unknown') + (job.location ? ' \u00B7 ' + job.location : '') + '</div>'
                    + '</div>'
                    + '<div style="text-align:center; min-width:56px;">'
                    + '<div style="font-size:1.4em; font-weight:700; color:' + matchColor + ';">' + job.matchScore + '%</div>'
                    + '<div style="font-size:0.68em; color:var(--text-muted);">match</div>'
                    + '</div></div>'
                    
                    // Meta row
                    + '<div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:10px; font-size:0.82em; color:var(--text-muted);">'
                    + (job.type ? '<span>' + bpIcon('briefcase',12) + ' ' + job.type + '</span>' : '')
                    + (salary ? '<span>' + bpIcon('dollar',12) + ' ' + salary + '</span>' : '')
                    + '<span style="color:' + (job.source === 'Remotive' ? '#8b5cf6' : job.source === 'Himalayas' ? '#10b981' : '#3b82f6') + ';">'
                    + bpIcon('external',12) + ' ' + (job.source || 'Remote') + '</span>'
                    + '</div>'
                    
                    // Matched skills chips
                    + (job.matchedSkills.length > 0 ? '<div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:10px;">'
                    + job.matchedSkills.slice(0, 6).map(function(s) {
                        return '<span style="padding:2px 8px; border-radius:10px; font-size:0.75em; '
                            + 'background:rgba(16,185,129,0.1); color:#10b981; border:1px solid rgba(16,185,129,0.2);">' + s + '</span>';
                    }).join('')
                    + (job.matchedSkills.length > 6 ? '<span style="font-size:0.75em; color:var(--text-muted); padding:2px 6px;">+' + (job.matchedSkills.length - 6) + ' more</span>' : '')
                    + '</div>' : '')
                    
                    // Gap skills
                    + (job.gapSkills && job.gapSkills.length > 0 ? '<div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:10px;">'
                    + job.gapSkills.slice(0, 4).map(function(s) {
                        return '<span style="padding:2px 8px; border-radius:10px; font-size:0.72em; '
                            + 'background:rgba(239,68,68,0.06); color:#ef4444; border:1px solid rgba(239,68,68,0.15);">' + s + '</span>';
                    }).join('')
                    + '</div>' : '')
                    
                    // Actions
                    + '<div style="display:flex; gap:8px; align-items:center;">'
                    + '<a href="' + jobUrl + '" target="_blank" style="padding:5px 12px; border-radius:6px; font-size:0.82em; '
                    + 'background:none; border:1px solid var(--border); color:var(--accent); text-decoration:none; cursor:pointer; '
                    + 'display:inline-flex; align-items:center; gap:4px;">' + bpIcon('external',12) + ' View</a>'
                    + (alreadyInPipeline
                        ? '<span style="font-size:0.78em; color:#10b981; display:inline-flex; align-items:center; gap:4px;">' + bpIcon('check',12) + ' In Pipeline</span>'
                        : '<button onclick="addRemoteJobToPipeline(' + idx + ')" style="padding:5px 12px; border-radius:6px; font-size:0.82em; '
                        + 'background:var(--accent); border:none; color:#fff; cursor:pointer; display:inline-flex; align-items:center; gap:4px;">'
                        + bpIcon('plus',12) + ' Add to Pipeline</button>')
                    + '</div>'
                    
                    + '</div>';
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        function searchOpportunities() {
            if (demoGate('Find Jobs')) return;
            var keyword = (document.getElementById('findJobsKeyword') || {}).value || '';
            keyword = keyword.trim();
            window._lastJobSearch = keyword;
            
            var category = (document.getElementById('findJobsCategory') || {}).value || '';
            
            var resultsDiv = document.getElementById('opportunitiesResults');
            if (!resultsDiv) return;
            
            resultsDiv.innerHTML = '<div style="text-align:center; padding:40px;">'
                + '<div class="loading-spinner" style="width:32px; height:32px; border-width:3px; margin:0 auto 12px;"></div>'
                + '<p style="font-size:1em; color:var(--text-secondary);">Searching 3 job boards...</p>'
                + '<p style="font-size:0.82em; color:var(--text-muted); margin-top:6px;">Remotive, Himalayas, Jobicy</p>'
                + '</div>';
            
            var _apiFailCount = 0;
            var _apiStatus = {};
            
            Promise.all([
                fetchRemotiveJobs2(keyword, category).then(function(r) { _apiStatus.remotive = r.length; return r; }).catch(function(e) { _apiFailCount++; _apiStatus.remotive = 'failed'; console.warn('Remotive:', e.message); return []; }),
                fetchHimalayasJobs(keyword).then(function(r) { _apiStatus.himalayas = r.length; return r; }).catch(function(e) { _apiFailCount++; _apiStatus.himalayas = 'failed'; console.warn('Himalayas:', e.message); return []; }),
                fetchJobicyJobs(keyword, category).then(function(r) { _apiStatus.jobicy = r.length; return r; }).catch(function(e) { _apiFailCount++; _apiStatus.jobicy = 'failed'; console.warn('Jobicy:', e.message); return []; })
            ]).then(function(results) {
                var allJobs = results[0].concat(results[1]).concat(results[2]);
                
                // Deduplicate
                var seen = {};
                opportunitiesData = allJobs.filter(function(job) {
                    var key = (job.title + '-' + job.company).toLowerCase().replace(/[^a-z0-9]/g, '');
                    if (seen[key]) return false;
                    seen[key] = true;
                    return true;
                });
                
                opportunitiesData.sort(function(a, b) { return b.matchScore - a.matchScore; });
                
                console.log('Find Jobs: ' + opportunitiesData.length + ' results after dedup. API status:', _apiStatus);
                
                if (opportunitiesData.length === 0) {
                    var isCors = _apiFailCount >= 2;
                    resultsDiv.innerHTML = '<div style="text-align:center; padding:40px 20px;">'
                        + '<div style="margin-bottom:16px; opacity:0.35;">' + bpIcon('search',48) + '</div>'
                        + (isCors
                            ? '<p style="font-size:1.05em; color:var(--text-primary); margin-bottom:8px;">Job board APIs are blocked by CORS</p>'
                              + '<p style="color:var(--text-muted); font-size:0.88em; line-height:1.6; max-width:480px; margin:0 auto 20px;">'
                              + 'Some browsers block cross-origin API requests. You can still paste job descriptions in Pipeline > Add a Job for full skill matching.</p>'
                              + '<div style="display:flex; gap:8px; justify-content:center;">'
                              + '<button onclick="switchJobsSubTab(\'your-jobs\')" style="padding:8px 16px; background:var(--accent); color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:0.88em;">'
                              + bpIcon('plus',12) + ' Add a Job Manually</button></div>'
                            : '<p style="font-size:1.05em; color:var(--text-primary); margin-bottom:8px;">No matching jobs found</p>'
                              + '<p style="color:var(--text-muted); font-size:0.88em;">Try different keywords or lower the match threshold.</p>')
                        + '</div>';
                    return;
                }
                
                var sources = [];
                if (_apiStatus.remotive !== 'failed') sources.push('Remotive: ' + (_apiStatus.remotive || 0));
                if (_apiStatus.himalayas !== 'failed') sources.push('Himalayas: ' + (_apiStatus.himalayas || 0));
                if (_apiStatus.jobicy !== 'failed') sources.push('Jobicy: ' + (_apiStatus.jobicy || 0));
                window._findJobsSources = sources.join(' \u00B7 ');
                
                renderOpportunities();
            });
        }
        
        // ===== JOB BOARD API FETCH FUNCTIONS (v4.21.0) =====
        // Three free, no-auth APIs: Remotive, Himalayas, Jobicy
        // Uses CORS proxy as fallback for browser restrictions
        
        var CORS_PROXIES = [
            function(url) { return url; }, // Try direct first
            function(url) { return 'https://corsproxy.io/?' + encodeURIComponent(url); },
            function(url) { return 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url); }
        ];
        
        async function fetchWithCorsRetry(url) {
            for (var i = 0; i < CORS_PROXIES.length; i++) {
                try {
                    var proxiedUrl = CORS_PROXIES[i](url);
                    var response = await fetch(proxiedUrl, { signal: AbortSignal.timeout(8000) });
                    if (response.ok) return await response.json();
                } catch (e) {
                    if (i === CORS_PROXIES.length - 1) throw e;
                }
            }
            throw new Error('All fetch methods failed for ' + url);
        }
        
        function quickScoreJob(title, description, tags) {
            var searchText = ((title || '') + ' ' + (description || '') + ' ' + (tags || []).join(' ')).toLowerCase();
            // Strip HTML
            searchText = searchText.replace(/<[^>]+>/g, ' ').replace(/&[^;]+;/g, ' ');
            
            var userSkills = skillsData.skills || [];
            var matchedSkills = [];
            var seen = {};
            
            userSkills.forEach(function(skill) {
                var lower = skill.name.toLowerCase();
                if (lower.length < 3) return;
                if (searchText.indexOf(lower) !== -1 && !seen[lower]) {
                    seen[lower] = true;
                    matchedSkills.push(skill.name);
                }
            });
            
            // Also check synonyms
            Object.keys(SKILL_SYNONYMS).forEach(function(canonical) {
                if (seen[canonical]) return;
                var syns = SKILL_SYNONYMS[canonical];
                for (var i = 0; i < syns.length; i++) {
                    if (searchText.indexOf(syns[i]) !== -1) {
                        // Check if user has this skill
                        var userSkill = userSkills.find(function(s) { return s.name.toLowerCase() === canonical; });
                        if (userSkill && !seen[canonical]) {
                            seen[canonical] = true;
                            matchedSkills.push(userSkill.name);
                        }
                        break;
                    }
                }
            });
            
            // Extract gap skills (keywords in JD not in user profile)
            var gapSkills = [];
            var commonSkillTerms = ['project management', 'data analysis', 'machine learning', 'product management',
                'strategic planning', 'business development', 'change management', 'stakeholder management',
                'agile', 'scrum', 'python', 'javascript', 'sql', 'excel', 'powerpoint', 'salesforce',
                'leadership', 'communication', 'negotiation', 'presentation', 'analytics', 'budgeting',
                'forecasting', 'customer success', 'account management', 'marketing strategy'];
            commonSkillTerms.forEach(function(term) {
                if (searchText.indexOf(term) !== -1 && !seen[term]) {
                    gapSkills.push(term.replace(/\b\w/g, function(c) { return c.toUpperCase(); }));
                }
            });
            
            var total = matchedSkills.length + gapSkills.length;
            var score = total > 0 ? Math.min(98, Math.round((matchedSkills.length / Math.max(total, 1)) * 100)) : 0;
            // Bonus for having many matched skills
            if (matchedSkills.length >= 5) score = Math.min(98, score + 10);
            if (matchedSkills.length >= 10) score = Math.min(98, score + 10);
            
            return { score: score, matched: matchedSkills, gaps: gapSkills.slice(0, 8) };
        }
        
        // === REMOTIVE ===
        async function fetchRemotiveJobs2(keyword, category) {
            var url = 'https://remotive.com/api/remote-jobs?limit=50';
            if (category) {
                var catMap = {
                    'software-dev': 'software-dev', 'marketing': 'marketing', 'business': 'business',
                    'data': 'data', 'design': 'design', 'product': 'product', 'hr': 'hr',
                    'finance': 'finance-legal', 'sales': 'sales', 'customer-support': 'customer-support',
                    'writing': 'writing', 'devops': 'devops-sysadmin'
                };
                if (catMap[category]) url += '&category=' + catMap[category];
            }
            if (keyword) url += '&search=' + encodeURIComponent(keyword);
            
            var data = await fetchWithCorsRetry(url);
            if (!data || !data.jobs) return [];
            
            return data.jobs.slice(0, 40).map(function(job) {
                var match = quickScoreJob(job.title, job.description, job.tags);
                return {
                    id: 'remotive-' + job.id,
                    title: job.title || 'Untitled',
                    company: job.company_name || '',
                    location: job.candidate_required_location || 'Worldwide',
                    type: (job.job_type || 'full_time').replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); }),
                    url: job.url || '',
                    salary: job.salary || '',
                    description: (job.description || '').substring(0, 2000),
                    tags: job.tags || [],
                    matchScore: match.score,
                    matchedSkills: match.matched,
                    gapSkills: match.gaps,
                    source: 'Remotive',
                    pubDate: job.publication_date || ''
                };
            });
        }
        
        // === HIMALAYAS ===
        async function fetchHimalayasJobs(keyword) {
            var url = 'https://himalayas.app/jobs/api?limit=50';
            // Himalayas doesn't support keyword search via API, so we filter client-side
            
            var data = await fetchWithCorsRetry(url);
            if (!data || !Array.isArray(data)) return [];
            
            var jobs = data;
            
            // Client-side keyword filter
            if (keyword) {
                var kw = keyword.toLowerCase();
                jobs = jobs.filter(function(job) {
                    return ((job.title || '') + ' ' + (job.companyName || '') + ' ' + ((job.categories || []).join(' '))).toLowerCase().indexOf(kw) !== -1;
                });
            }
            
            return jobs.slice(0, 40).map(function(job) {
                var match = quickScoreJob(job.title, job.description, job.categories);
                var salary = '';
                if (job.minSalary && job.maxSalary) {
                    salary = '$' + (job.minSalary / 1000).toFixed(0) + 'k - $' + (job.maxSalary / 1000).toFixed(0) + 'k' + (job.currency && job.currency !== 'USD' ? ' ' + job.currency : '');
                }
                return {
                    id: 'himalayas-' + (job.id || Date.now()),
                    title: job.title || 'Untitled',
                    company: job.companyName || '',
                    location: (job.locationRestrictions || []).join(', ') || 'Worldwide',
                    type: job.employmentType || 'Full Time',
                    url: job.applicationUrl || job.url || '',
                    salary: salary,
                    description: (job.description || '').substring(0, 2000),
                    tags: job.categories || [],
                    matchScore: match.score,
                    matchedSkills: match.matched,
                    gapSkills: match.gaps,
                    source: 'Himalayas',
                    pubDate: job.pubDate || ''
                };
            });
        }
        
        // === JOBICY ===
        async function fetchJobicyJobs(keyword, category) {
            var url = 'https://jobicy.com/api/v2/remote-jobs?count=30';
            if (keyword) url += '&tag=' + encodeURIComponent(keyword);
            if (category) {
                var catMap = {
                    'software-dev': 'dev', 'marketing': 'marketing', 'business': 'business',
                    'data': 'data-science', 'design': 'design-multimedia', 'hr': 'hr',
                    'finance': 'accounting-finance', 'sales': 'seller', 'customer-support': 'supporting',
                    'writing': 'copywriting', 'devops': 'dev'
                };
                if (catMap[category]) url += '&job_categories=' + catMap[category];
            }
            
            var data = await fetchWithCorsRetry(url);
            if (!data || !data.jobs) return [];
            
            return data.jobs.slice(0, 30).map(function(job) {
                var match = quickScoreJob(job.jobTitle, job.jobDescription, [job.jobIndustry]);
                var salary = '';
                if (job.annualSalaryMin && job.annualSalaryMax) {
                    salary = '$' + (job.annualSalaryMin / 1000).toFixed(0) + 'k - $' + (job.annualSalaryMax / 1000).toFixed(0) + 'k';
                } else if (job.salaryMin && job.salaryMax) {
                    salary = '$' + (job.salaryMin / 1000).toFixed(0) + 'k - $' + (job.salaryMax / 1000).toFixed(0) + 'k';
                }
                return {
                    id: 'jobicy-' + (job.id || Date.now()),
                    title: job.jobTitle || 'Untitled',
                    company: job.companyName || '',
                    location: job.jobGeo || 'Anywhere',
                    type: (job.jobType || 'full-time').replace(/-/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); }),
                    url: job.url || '',
                    salary: salary,
                    description: (job.jobDescription || '').substring(0, 2000),
                    tags: [job.jobIndustry || ''],
                    matchScore: match.score,
                    matchedSkills: match.matched,
                    gapSkills: match.gaps,
                    source: 'Jobicy',
                    pubDate: job.pubDate || ''
                };
            });
        }
        
        // === ADD REMOTE JOB TO PIPELINE ===
        function addRemoteJobToPipeline(idx) {
            var job = opportunitiesData[idx];
            if (!job) { showToast('Job not found.', 'warning'); return; }
            
            if (!userData.savedJobs) userData.savedJobs = [];
            if (userData.savedJobs.length >= 10) {
                showToast('Pipeline is full (10 max). Remove one first.', 'warning');
                return;
            }
            
            // Check dupe
            var key = (job.title + '-' + job.company).toLowerCase();
            var exists = userData.savedJobs.some(function(j) {
                return (j.title + '-' + (j.company || '')).toLowerCase() === key;
            });
            if (exists) { showToast('Already in your pipeline.', 'warning'); return; }
            
            // Parse skills from description for full matching
            var parsed = parseJobLocally(job.description || job.title);
            parsed.title = job.title;
            parsed.company = job.company;
            var matchData = matchJobToProfile(parsed);
            var blsSalary = matchJobToBLS(job.title, job.description || '');
            
            var pipelineJob = {
                id: 'job-' + Date.now(),
                title: job.title,
                company: job.company,
                sourceUrl: job.url,
                sourceNote: 'Found via ' + job.source,
                rawText: (job.description || '').substring(0, 5000),
                parsedSkills: parsed.skills || [],
                parsedRoles: parsed.roles || [],
                seniority: parsed.seniority || '',
                matchData: matchData,
                blsSalary: blsSalary,
                addedAt: new Date().toISOString()
            };
            
            userData.savedJobs.unshift(pipelineJob);
            saveUserData();
            if (fbUser) saveToFirestore();
            
            showToast(job.title + ' added to pipeline: ' + matchData.score + '% match.', 'success', 4000);
            
            // Re-render to update the "In Pipeline" badge
            renderOpportunities();
        }
        window.addRemoteJobToPipeline = addRemoteJobToPipeline;
        // [removed] generatePitch — dead code cleanup v4.22.0
        
        function showPitchModal(job, pitch) {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Generated Pitch</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">${job.title} at ${job.company}</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <textarea id="pitchText" style="width: 100%; min-height: 400px; background: transparent; border: none; color: #e0e0e0; font-family: inherit; font-size: 0.95em; line-height: 1.7; resize: vertical;">${pitch}</textarea>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="action-btn" onclick="copyPitch()" style="padding: 10px 20px;">
                            ${bpIcon('clipboard',14)} Copy to Clipboard
                        </button>
                        <button class="action-btn" onclick="downloadPitch('${job.title}', '${job.company}')" style="padding: 10px 20px;">
                            ${bpIcon("download",14)} Download as Text
                        </button>
                        <button class="action-btn" onclick="trackFromPitch('${job.id}')" style="padding: 10px 20px; background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981;">
                            ${bpIcon("plus",14)} Track Application
                        </button>
                        <button class="export-btn-large" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Done
                        </button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function copyPitch() {
            const pitchText = document.getElementById('pitchText');
            pitchText.select();
            document.execCommand('copy');
            showToast('Pitch copied to clipboard.', 'success');
        }
        
        function downloadPitch(jobTitle, company) {
            const pitchText = document.getElementById('pitchText').value;
            const blob = new Blob([pitchText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pitch-${jobTitle.replace(/\s+/g, '-')}-${company.replace(/\s+/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function trackFromPitch(jobId) {
            const job = opportunitiesData.find(j => j.id == jobId);
            if (!job) return;
            
            closeExportModal();
            addApplicationModal(job);
        }
        // [removed] viewOnNetwork — dead code cleanup v4.22.0
        
        function initNetworkWithHighlight(job) {
            const svg = d3.select("#networkView");
            svg.selectAll("*").remove();
            
            const width = svg.node().getBoundingClientRect().width;
            const height = svg.node().getBoundingClientRect().height;
            
            // Prepare data
            const centerNode = { id: "center", name: userData.profile.name || "You", type: "center" };
            const roleNodes = skillsData.roles.map(role => ({
                id: role.id,
                name: role.name,
                type: "role",
                skills: role.skills
            }));
            
            const skillNodes = skillsData.skills.map(skill => ({
                id: skill.name,
                name: skill.name,
                type: "skill",
                level: skill.level,
                years: skill.years,
                roles: skill.roles,
                isMatch: job.matchedSkills.includes(skill.name)  // NEW: Track if matches job
            }));
            
            const nodes = [centerNode, ...roleNodes, ...skillNodes];
            
            // Create links
            const links = [];
            roleNodes.forEach(role => {
                links.push({ source: "center", target: role.id, type: "role" });
                role.skills.forEach(skillName => {
                    links.push({ source: role.id, target: skillName, type: "skill" });
                });
            });
            
            // Create simulation (same physics as before)
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.type === "role") return 140;
                    return 160;
                }))
                .force("charge", d3.forceManyBody().strength(d => {
                    if (d.type === "center") return 0;
                    if (d.type === "role") return -250;
                    return -180;
                }))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(d => {
                    if (d.type === "center") return 70;
                    if (d.type === "role") return 65;
                    return 45;
                }))
                .force("x", d3.forceX(width / 2).strength(0.08))
                .force("y", d3.forceY(height / 2).strength(0.08))
                .force("radial", d3.forceRadial(d => {
                    if (d.type === "skill") return Math.min(width, height) * 0.4;
                    return 0;
                }).strength(0.1));
            
            // Draw links with highlighting
            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link")
                .style("opacity", d => {
                    // Dim links that don't connect to matching skills
                    if (d.type === "skill") {
                        const targetNode = nodes.find(n => n.id === d.target);
                        return targetNode && targetNode.isMatch ? 0.6 : 0.1;
                    }
                    return 0.3;
                });
            
            // Draw nodes with highlighting
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", "node")
                .style("opacity", d => {
                    // Highlight matching skills, dim others
                    if (d.type === "skill") {
                        return d.isMatch ? 1 : 0.2;
                    }
                    return 1;  // Keep center and roles fully visible
                })
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
            
            // Add circles
            node.append("circle")
                .attr("r", d => {
                    if (d.type === "center") return 60;
                    if (d.type === "role") return 50;
                    return d.isMatch ? 25 : 15;  // Matching skills are larger
                })
                .attr("class", d => {
                    if (d.type === "center") return "node-center";
                    if (d.type === "role") return `node-role role-${d.id}`;
                    return `node-skill level-${d.level.toLowerCase().replace(/\s/g, '-')}`;
                })
                .style("stroke", d => {
                    // Green border for matching skills
                    return d.isMatch ? "#10b981" : null;
                })
                .style("stroke-width", d => d.isMatch ? 3 : null);
            
            // Add labels (only show matching skills and roles)
            node.filter(d => d.type === "center" || d.type === "role" || d.isMatch)
                .append("text")
                .text(d => d.name)
                .attr("class", "node-label")
                .style("font-weight", d => d.isMatch ? "bold" : "normal")
                .style("fill", d => d.isMatch ? "#10b981" : "#e0e0e0");
            
            // Update positions on tick
            simulation.on("tick", () => {
                const padding = 100;
                nodes.forEach(d => {
                    if (d.type !== "center") {
                        d.x = Math.max(padding, Math.min(width - padding, d.x));
                        d.y = Math.max(padding, Math.min(height - padding, d.y));
                    }
                });
                
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });
            
            // Add "Return to Opportunities" button overlay
            const buttonContainer = svg.append("foreignObject")
                .attr("x", 20)
                .attr("y", 20)
                .attr("width", 200)
                .attr("height", 50);
            
            buttonContainer.append("xhtml:div")
                .html(`
                    <button onclick="returnToOpportunities()" style="
                        padding: 10px 20px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                    ">
                        ← Back to Jobs
                    </button>
                `);
        }
        
        function returnToOpportunities() {
            window.currentHighlightJob = null;
            switchView('opportunities');
        }
        
        // ===== SETTINGS SYSTEM =====
        
        function initSettings() {
            const view = document.getElementById('settingsView');
            
            // Initialize current tab if not set
            if (!window.currentSettingsTab) {
                window.currentSettingsTab = 'profile';
            }
            
            view.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-header">
                        <h1 class="blueprint-title">Settings</h1>
                        <p class="blueprint-subtitle">Site &amp; Personal Settings</p>
                    </div>
                    
                    <div class="settings-tabs">
                        <button class="settings-tab ${window.currentSettingsTab === 'profile' ? 'active' : ''}" 
                                onclick="switchSettingsTab('profile')">
                            ${bpIcon('profile',15)} Profile
                        </button>
                        <button class="settings-tab ${window.currentSettingsTab === 'preferences' ? 'active' : ''}" 
                                onclick="switchSettingsTab('preferences')">
                            ${bpIcon('preferences',15)} Preferences
                        </button>
                        <button class="settings-tab ${window.currentSettingsTab === 'privacy' ? 'active' : ''}" 
                                onclick="switchSettingsTab('privacy')">
                            ${bpIcon('privacy',15)} Privacy & Data
                        </button>
                    </div>
                    
                    <div id="settingsTabContent">
                        ${renderSettingsTabContent()}
                    </div>
                </div>
            `;
        }
        
        function switchSettingsTab(tab) {
            window.currentSettingsTab = tab;
            document.getElementById('settingsTabContent').innerHTML = renderSettingsTabContent();
            
            // Update tab styling
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function renderSettingsTabContent() {
            switch(window.currentSettingsTab) {
                case 'profile':
                    return renderProfileSettings();
                case 'experience':
                    // Moved to Blueprint > Experience tab
                    window.currentSettingsTab = 'profile';
                    return renderProfileSettings();
                case 'preferences':
                    return renderJobPreferences();
                case 'privacy':
                    return renderPrivacyAndData();
                default:
                    return renderProfileSettings();
            }
        }
        
        function renderProfileSettings() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">${bpIcon("profile",20)}</span>
                            <span>Profile Information</span>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Your Name</label>
                        <input type="text" class="settings-input" id="settingName" 
                               value="${userData.profile.name || ''}" 
                               placeholder="Enter your name">
                        <div class="settings-help">This appears in the header and exports</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Profile Photo</label>
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div id="settingPhotoPreview" onclick="document.getElementById('settingPhotoInput').click()" 
                                 style="width:64px; height:64px; border-radius:50%; background:var(--accent); color:#fff; 
                                        display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1.2em;
                                        cursor:pointer; overflow:hidden; border:2px solid var(--border); flex-shrink:0;
                                        ${userData.profile.photo ? 'padding:0' : ''}">
                                ${userData.profile.photo 
                                    ? '<img src="' + userData.profile.photo + '" alt="Profile photo" style="width:100%;height:100%;object-fit:cover;">' 
                                    : (userData.profile.name || 'U').split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase()}
                            </div>
                            <div>
                                <button onclick="document.getElementById('settingPhotoInput').click()" 
                                        style="background:var(--accent-glow); border:1px solid var(--border); color:var(--text-primary); padding:6px 14px; border-radius:6px; cursor:pointer; font-size:0.85em;">
                                    Upload Photo
                                </button>
                                ${userData.profile.photo ? '<button onclick="removeProfilePhoto()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:0.82em; margin-left:8px;">Remove</button>' : ''}
                                <input type="file" id="settingPhotoInput" accept="image/*" onchange="handleProfilePhoto(this)" style="display:none;">
                                <div class="settings-help" style="margin-top:4px;">Max 200KB, resized to 128px</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Email (Optional)</label>
                        <input type="email" class="settings-input" id="settingEmail" 
                               value="${userData.profile.email || ''}" 
                               placeholder="your.email@example.com">
                        <div class="settings-help">For export contact information</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Phone (Optional)</label>
                        <input type="tel" class="settings-input" id="settingPhone" 
                               value="${userData.profile.phone || ''}" 
                               placeholder="(555) 123-4567">
                        <div class="settings-help">Included in resume exports</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">LinkedIn URL (Optional)</label>
                        <input type="url" class="settings-input" id="settingLinkedIn" 
                               value="${userData.profile.linkedinUrl || ''}" 
                               placeholder="https://linkedin.com/in/yourname">
                        <div class="settings-help">Included in resume and executive blueprint exports</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Location (for market valuation)</label>
                        <select class="settings-select" id="settingLocation">
                            <option value="Philadelphia, PA" ${userData.profile.location === 'Philadelphia, PA' ? 'selected' : ''}>Philadelphia, PA</option>
                            <option value="San Francisco Bay Area, CA">San Francisco Bay Area, CA</option>
                            <option value="New York City, NY">New York City, NY</option>
                            <option value="Seattle, WA">Seattle, WA</option>
                            <option value="Boston, MA">Boston, MA</option>
                            <option value="Washington DC">Washington DC</option>
                            <option value="Los Angeles, CA">Los Angeles, CA</option>
                            <option value="San Diego, CA">San Diego, CA</option>
                            <option value="Denver, CO">Denver, CO</option>
                            <option value="Austin, TX">Austin, TX</option>
                            <option value="Chicago, IL">Chicago, IL</option>
                            <option value="Atlanta, GA">Atlanta, GA</option>
                            <option value="Remote">Remote</option>
                            <option value="Phoenix, AZ">Phoenix, AZ</option>
                            <option value="Dallas, TX">Dallas, TX</option>
                            <option value="Houston, TX">Houston, TX</option>
                            <option value="Miami, FL">Miami, FL</option>
                            <option value="Portland, OR">Portland, OR</option>
                            <option value="Charlotte, NC">Charlotte, NC</option>
                            <option value="Nashville, TN">Nashville, TN</option>
                            <option value="Indianapolis, IN">Indianapolis, IN</option>
                            <option value="Columbus, OH">Columbus, OH</option>
                            <option value="Kansas City, MO">Kansas City, MO</option>
                            <option value="Omaha, NE">Omaha, NE</option>
                            <option value="Lincoln, NE">Lincoln, NE</option>
                            <option value="Other US Metro">Other US Metro</option>
                            <option value="Rural US">Rural US</option>
                        </select>
                        <div class="settings-help">Your location affects skill market valuations (cost of living adjustment)</div>
                    </div>
                </div>
            `;
        }
        
        // ===== EXPERIENCE SETTINGS (Work History, Education, Certifications) =====
        
        function refreshExperienceContent() {
            // Works from both Blueprint > Experience and Settings > Experience (legacy)
            var target = document.getElementById('blueprintTabContent') || document.getElementById('settingsTabContent');
            if (target && (blueprintTab === 'experience' || window.currentSettingsTab === 'experience')) {
                target.innerHTML = renderExperienceSettings();
            }
        }
        
        function renderExperienceSettings() {
            var whItems = userData.workHistory || [];
            var edItems = userData.education || [];
            var certItems = userData.certifications || [];
            
            var html = '';
            
            // --- Work History ---
            html += '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('briefcase',20) + '</span>'
                + '<span>Work History</span>'
                + '<span class="section-count">' + whItems.length + ' entries</span>'
                + '</div>'
                + '</div>'
                + '<div class="coaching-tip">'
                + '<div class="coaching-tip-title">' + bpIcon('lightbulb',14) + ' BUILD YOUR CAREER TIMELINE</div>'
                + '<div class="coaching-tip-content">'
                + 'Add your work history in reverse chronological order. Achievements here will appear in resume exports. '
                + 'For best results, include 2-4 quantified accomplishments per role.'
                + '</div>'
                + '</div>';
            
            if (whItems.length > 0) {
                whItems.forEach(function(job, idx) {
                    var dateRange = (job.startDate || '?') + ' \u2013 ' + (job.current ? 'Present' : (job.endDate || '?'));
                    html += '<div style="padding:16px; margin-bottom:12px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; '
                        + 'border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.08)') + '; border-radius:10px; position:relative;">';
                    
                    // Controls
                    html += '<div style="position:absolute; top:10px; right:10px; display:flex; gap:6px;">'
                        + '<button onclick="editWorkHistoryItem(' + idx + ')" title="Edit" style="background:none; border:none; cursor:pointer; font-size:0.85em; color:' + tv('#60a5fa','#2563eb') + ';">\u270E</button>'
                        + '<button onclick="removeWorkHistoryItem(' + idx + ')" title="Remove" style="background:none; border:none; cursor:pointer; font-size:0.9em; color:' + tv('#ef4444','#dc2626') + ';">\u00D7</button>'
                        + '</div>';
                    
                    html += '<div style="font-weight:700; color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.95em;">' + (job.title || 'Untitled Role') + '</div>'
                        + '<div style="color:' + tv('#60a5fa','#2563eb') + '; font-size:0.88em; margin-top:2px;">' + (job.company || '') + (job.location ? ' \u00B7 ' + job.location : '') + '</div>'
                        + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.82em; margin-top:2px;">' + dateRange + '</div>';
                    
                    if (job.description) {
                        html += '<div style="color:' + tv('#d1d5db','#334155') + '; font-size:0.85em; margin-top:8px; line-height:1.5;">' + job.description + '</div>';
                    }
                    
                    if (job.achievements && job.achievements.length > 0) {
                        html += '<div style="margin-top:8px;">';
                        job.achievements.forEach(function(ach) {
                            html += '<div style="font-size:0.83em; color:' + tv('#d1d5db','#334155') + '; padding:3px 0 3px 14px; position:relative; line-height:1.45;">'
                                + '<span style="position:absolute; left:0; color:' + tv('#10b981','#059669') + ';">\u25B8</span>'
                                + ach + '</div>';
                        });
                        html += '</div>';
                    }
                    
                    html += '</div>';
                });
            } else {
                html += '<div style="text-align:center; padding:24px; color:' + tv('#6b7280','#9ca3af') + '; font-size:0.9em;">'
                    + 'No work history added yet. Add your roles to power resume generation.'
                    + '</div>';
            }
            
            html += '<button onclick="addWorkHistoryItem()" style="'
                + 'background:' + tv('rgba(96,165,250,0.12)','rgba(30,64,175,0.08)') + '; '
                + 'border:1px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + '; '
                + 'color:' + tv('#60a5fa','#1e40af') + '; padding:10px 20px; border-radius:8px; cursor:pointer; '
                + 'font-size:0.9em; font-weight:600; margin-top:12px;">'
                + '+ Add Position</button>'
                + '</div>';
            
            // --- Education ---
            html += '<div class="blueprint-section" style="margin-top:24px;">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('graduation',20) + '</span>'
                + '<span>Education</span>'
                + '<span class="section-count">' + edItems.length + ' entries</span>'
                + '</div>'
                + '</div>';
            
            if (edItems.length > 0) {
                edItems.forEach(function(ed, idx) {
                    html += '<div style="padding:12px 16px; margin-bottom:8px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; '
                        + 'border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.08)') + '; border-radius:8px; '
                        + 'display:flex; justify-content:space-between; align-items:center;">'
                        + '<div>'
                        + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.9em;">'
                        + (ed.degree || '') + (ed.field ? ' in ' + ed.field : '') + '</div>'
                        + '<div style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.82em;">'
                        + (ed.school || '') + (ed.year ? ' \u00B7 ' + ed.year : '') + '</div>'
                        + '</div>'
                        + '<div style="display:flex; gap:6px;">'
                        + '<button onclick="editEducationItem(' + idx + ')" style="background:none; border:none; cursor:pointer; font-size:0.85em; color:' + tv('#60a5fa','#2563eb') + ';">\u270E</button>'
                        + '<button onclick="removeEducationItem(' + idx + ')" style="background:none; border:none; cursor:pointer; font-size:0.9em; color:' + tv('#ef4444','#dc2626') + ';">\u00D7</button>'
                        + '</div></div>';
                });
            } else {
                html += '<div style="text-align:center; padding:16px; color:' + tv('#6b7280','#9ca3af') + '; font-size:0.88em;">'
                    + 'No education entries yet.'
                    + '</div>';
            }
            
            html += '<button onclick="addEducationItem()" style="'
                + 'background:' + tv('rgba(96,165,250,0.12)','rgba(30,64,175,0.08)') + '; '
                + 'border:1px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + '; '
                + 'color:' + tv('#60a5fa','#1e40af') + '; padding:8px 16px; border-radius:8px; cursor:pointer; '
                + 'font-size:0.85em; font-weight:600; margin-top:8px;">'
                + '+ Add Education</button>'
                + '</div>';
            
            // --- Certifications ---
            html += '<div class="blueprint-section" style="margin-top:24px;">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('award',20) + '</span>'
                + '<span>Certifications, Licenses & Degrees</span>'
                + '<span class="section-count">' + certItems.length + ' entries</span>'
                + '</div>'
                + '</div>';
            
            if (certItems.length > 0) {
                certItems.forEach(function(cert, idx) {
                    var tierColor = cert.tier >= 2 ? '#f59e0b' : '#10b981';
                    var tierTag = cert.tier >= 2 ? 'ADV' : 'PRO';
                    var linkedCount = (cert.linkedSkills || []).length;
                    var libSkills = cert.libraryMatch ? (findCertInLibrary(cert.libraryMatch) || {}).skills : null;
                    var totalLinks = linkedCount + (libSkills ? libSkills.length : 0);
                    
                    html += '<div style="padding:12px 16px; margin-bottom:8px; background:' + tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)') + '; '
                        + 'border:1px solid ' + tv('rgba(255,255,255,0.08)','rgba(0,0,0,0.08)') + '; border-radius:8px; '
                        + 'display:flex; justify-content:space-between; align-items:center;">'
                        + '<div>'
                        + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.9em;">'
                        + (cert.name || '')
                        + (cert.abbr ? ' <span style="color:' + tv('#60a5fa','#2563eb') + '; font-size:0.85em;">(' + cert.abbr + ')</span>' : '')
                        + '</div>'
                        + '<div style="display:flex; gap:6px; align-items:center; margin-top:3px;">'
                        + '<span style="color:' + tv('#9ca3af','#64748b') + '; font-size:0.82em;">'
                        + (cert.issuer || '') + (cert.year ? ' \u00B7 ' + cert.year : '') + '</span>'
                        + (cert.tier ? ' <span style="font-size:0.68em; padding:1px 6px; border-radius:6px; background:rgba(' + (cert.tier >= 2 ? '245,158,11' : '16,185,129') + ',0.12); color:' + tierColor + '; font-weight:700;">' + tierTag + '</span>' : '')
                        + (totalLinks > 0 ? ' <span style="font-size:0.72em; color:' + tv('#a78bfa','#7c3aed') + ';">\uD83D\uDD17 ' + totalLinks + ' skills</span>' : '')
                        + '</div>'
                        + '</div>'
                        + '<div style="display:flex; gap:6px;">'
                        + '<button onclick="editCertItem(' + idx + ')" style="background:none; border:none; cursor:pointer; font-size:0.85em; color:' + tv('#60a5fa','#2563eb') + ';">\u270E</button>'
                        + '<button onclick="removeCertItem(' + idx + ')" style="background:none; border:none; cursor:pointer; font-size:0.9em; color:' + tv('#ef4444','#dc2626') + ';">\u00D7</button>'
                        + '</div></div>';
                });
            } else {
                html += '<div style="text-align:center; padding:16px; color:' + tv('#6b7280','#9ca3af') + '; font-size:0.88em;">'
                    + 'No credentials yet. Add certifications, licenses, or degrees from the library.'
                    + '</div>';
            }
            
            html += '<button onclick="addCertItem()" style="'
                + 'background:' + tv('rgba(96,165,250,0.12)','rgba(30,64,175,0.08)') + '; '
                + 'border:1px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + '; '
                + 'color:' + tv('#60a5fa','#1e40af') + '; padding:8px 16px; border-radius:8px; cursor:pointer; '
                + 'font-size:0.85em; font-weight:600; margin-top:8px;">'
                + '+ Add Credential</button>'
                + '</div>';
            
            // Save button
            html += '<div style="margin-top:24px; display:flex; gap:12px;">'
                + '<button onclick="saveAll(); showToast(\'Experience saved.\', \'success\')" style="'
                + 'background:var(--accent); color:#fff; border:none; padding:12px 28px; border-radius:8px; '
                + 'cursor:pointer; font-weight:600; font-size:0.95em;">'
                + 'Save All Changes</button>'
                + '</div>';
            
            return html;
        }
        
        // --- Work History CRUD ---
        function addWorkHistoryItem() {
            if (readOnlyGuard()) return;
            openWorkHistoryModal(-1);
        }
        function editWorkHistoryItem(idx) {
            if (readOnlyGuard()) return;
            openWorkHistoryModal(idx);
        }
        function removeWorkHistoryItem(idx) {
            if (readOnlyGuard()) return;
            if (!confirm('Remove this position?')) return;
            userData.workHistory.splice(idx, 1);
            saveAll();
            refreshExperienceContent();
            showToast('Position removed.', 'info');
        }
        
        function openWorkHistoryModal(idx) {
            var job = idx >= 0 ? userData.workHistory[idx] : { title:'', company:'', location:'', startDate:'', endDate:'', current:false, description:'', achievements:[] };
            var isEdit = idx >= 0;
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            
            var achHTML = (job.achievements || []).map(function(a, i) {
                return '<div style="display:flex; gap:8px; margin-bottom:8px;">'
                    + '<input type="text" class="settings-input wh-ach-input" value="' + (a||'').replace(/"/g,'&quot;') + '" '
                    + 'placeholder="e.g., Increased pipeline velocity 40% through process redesign" '
                    + 'style="flex:1; font-size:0.88em;">'
                    + '<button onclick="this.parentElement.remove()" style="background:none; border:none; color:' + tv('#ef4444','#dc2626') + '; cursor:pointer; font-size:1.1em; padding:0 4px;">\u00D7</button>'
                    + '</div>';
            }).join('');
            
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">' + (isEdit ? 'Edit Position' : 'Add Position') + '</h2>'
                + '<p style="color:' + tv('#9ca3af','#64748b') + '; margin-top:5px;">Add your role details and key accomplishments</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px; max-height:70vh; overflow-y:auto;">'
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">'
                + '<div class="settings-group"><label class="settings-label">Job Title *</label>'
                + '<input type="text" class="settings-input" id="whTitle" value="' + (job.title||'').replace(/"/g,'&quot;') + '" placeholder="VP of Strategy"></div>'
                + '<div class="settings-group"><label class="settings-label">Company *</label>'
                + '<input type="text" class="settings-input" id="whCompany" value="' + (job.company||'').replace(/"/g,'&quot;') + '" placeholder="Acme Corp"></div>'
                + '<div class="settings-group"><label class="settings-label">Location</label>'
                + '<input type="text" class="settings-input" id="whLocation" value="' + (job.location||'').replace(/"/g,'&quot;') + '" placeholder="Philadelphia, PA"></div>'
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">'
                + '<div class="settings-group"><label class="settings-label">Start Date</label>'
                + '<input type="text" class="settings-input" id="whStartDate" value="' + (job.startDate||'') + '" placeholder="Jan 2020"></div>'
                + '<div class="settings-group"><label class="settings-label">End Date</label>'
                + '<input type="text" class="settings-input" id="whEndDate" value="' + (job.endDate||'') + '" placeholder="Present" ' + (job.current ? 'disabled' : '') + '></div>'
                + '</div>'
                + '</div>'
                + '<div class="settings-group" style="margin-top:4px;">'
                + '<label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:0.88em; color:' + tv('#d1d5db','#334155') + ';">'
                + '<input type="checkbox" id="whCurrent" ' + (job.current ? 'checked' : '') + ' onchange="document.getElementById(\'whEndDate\').disabled=this.checked; if(this.checked) document.getElementById(\'whEndDate\').value=\'\';">'
                + ' I currently work here</label>'
                + '</div>'
                + '<div class="settings-group" style="margin-top:10px;">'
                + '<label class="settings-label">Role Description (Optional)</label>'
                + '<textarea class="settings-input" id="whDescription" rows="2" style="resize:vertical; font-size:0.88em;" '
                + 'placeholder="Brief summary of your responsibilities and scope">' + (job.description||'') + '</textarea>'
                + '</div>'
                + '<div class="settings-group" style="margin-top:10px;">'
                + '<label class="settings-label">Key Achievements</label>'
                + '<div class="settings-help" style="margin-bottom:8px;">Quantify where possible: revenue impact, team size, efficiency gains, etc.</div>'
                + '<div id="whAchievementsContainer">' + achHTML + '</div>'
                + '<button onclick="addAchievementInput()" style="background:none; border:1px dashed ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + '; '
                + 'color:' + tv('#60a5fa','#2563eb') + '; padding:6px 14px; border-radius:6px; cursor:pointer; font-size:0.82em; margin-top:4px;">'
                + '+ Add Achievement</button>'
                + '</div>'
                + '<div style="display:flex; gap:10px; margin-top:20px;">'
                + '<button onclick="saveWorkHistoryFromModal(' + idx + ')" style="background:var(--accent); color:#fff; border:none; padding:10px 24px; border-radius:8px; cursor:pointer; font-weight:600;">'
                + (isEdit ? 'Save Changes' : 'Add Position') + '</button>'
                + '<button onclick="closeExportModal()" style="background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','#d1d5db') + '; padding:10px 20px; border-radius:8px; cursor:pointer;">'
                + 'Cancel</button>'
                + '</div></div>';
            
            modal.style.display = 'flex';
        }
        
        function addAchievementInput() {
            var container = document.getElementById('whAchievementsContainer');
            var div = document.createElement('div');
            div.style.cssText = 'display:flex; gap:8px; margin-bottom:8px;';
            div.innerHTML = '<input type="text" class="settings-input wh-ach-input" placeholder="e.g., Led $2M digital transformation initiative" style="flex:1; font-size:0.88em;">'
                + '<button onclick="this.parentElement.remove()" style="background:none; border:none; color:' + tv('#ef4444','#dc2626') + '; cursor:pointer; font-size:1.1em; padding:0 4px;">\u00D7</button>';
            container.appendChild(div);
            div.querySelector('input').focus();
        }
        
        function saveWorkHistoryFromModal(idx) {
            var title = document.getElementById('whTitle').value.trim();
            var company = document.getElementById('whCompany').value.trim();
            if (!title || !company) { showToast('Title and company are required.', 'warning'); return; }
            
            var achievements = [];
            document.querySelectorAll('.wh-ach-input').forEach(function(inp) {
                var v = inp.value.trim();
                if (v) achievements.push(v);
            });
            
            var entry = {
                id: idx >= 0 ? (userData.workHistory[idx].id || 'wh-' + Date.now()) : 'wh-' + Date.now(),
                title: title,
                company: company,
                location: document.getElementById('whLocation').value.trim(),
                startDate: document.getElementById('whStartDate').value.trim(),
                endDate: document.getElementById('whEndDate').value.trim(),
                current: document.getElementById('whCurrent').checked,
                description: document.getElementById('whDescription').value.trim(),
                achievements: achievements
            };
            
            if (idx >= 0) {
                userData.workHistory[idx] = entry;
            } else {
                userData.workHistory.unshift(entry); // newest first
            }
            
            closeExportModal();
            saveAll();
            refreshExperienceContent();
            showToast(idx >= 0 ? 'Position updated.' : 'Position added.', 'success');
        }
        
        // --- Education CRUD ---
        function addEducationItem() {
            if (readOnlyGuard()) return;
            openEducationModal(-1);
        }
        function editEducationItem(idx) {
            if (readOnlyGuard()) return;
            openEducationModal(idx);
        }
        function removeEducationItem(idx) {
            if (readOnlyGuard()) return;
            if (!confirm('Remove this education entry?')) return;
            userData.education.splice(idx, 1);
            saveAll();
            refreshExperienceContent();
        }
        
        function openEducationModal(idx) {
            var ed = idx >= 0 ? userData.education[idx] : { school:'', degree:'', field:'', year:'' };
            var isEdit = idx >= 0;
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">' + (isEdit ? 'Edit Education' : 'Add Education') + '</h2>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">'
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">'
                + '<div class="settings-group"><label class="settings-label">School / University</label>'
                + '<input type="text" class="settings-input" id="edSchool" value="' + (ed.school||'').replace(/"/g,'&quot;') + '" placeholder="University of Pennsylvania"></div>'
                + '<div class="settings-group"><label class="settings-label">Degree</label>'
                + '<input type="text" class="settings-input" id="edDegree" value="' + (ed.degree||'').replace(/"/g,'&quot;') + '" placeholder="B.S., M.B.A., etc."></div>'
                + '<div class="settings-group"><label class="settings-label">Field of Study</label>'
                + '<input type="text" class="settings-input" id="edField" value="' + (ed.field||'').replace(/"/g,'&quot;') + '" placeholder="Business Administration"></div>'
                + '<div class="settings-group"><label class="settings-label">Year</label>'
                + '<input type="text" class="settings-input" id="edYear" value="' + (ed.year||'') + '" placeholder="2012"></div>'
                + '</div>'
                + '<div style="display:flex; gap:10px; margin-top:20px;">'
                + '<button onclick="saveEducationFromModal(' + idx + ')" style="background:var(--accent); color:#fff; border:none; padding:10px 24px; border-radius:8px; cursor:pointer; font-weight:600;">'
                + (isEdit ? 'Save' : 'Add') + '</button>'
                + '<button onclick="closeExportModal()" style="background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','#d1d5db') + '; padding:10px 20px; border-radius:8px; cursor:pointer;">Cancel</button>'
                + '</div></div>';
            
            modal.style.display = 'flex';
        }
        
        function saveEducationFromModal(idx) {
            var entry = {
                id: idx >= 0 ? (userData.education[idx].id || 'ed-' + Date.now()) : 'ed-' + Date.now(),
                school: document.getElementById('edSchool').value.trim(),
                degree: document.getElementById('edDegree').value.trim(),
                field: document.getElementById('edField').value.trim(),
                year: document.getElementById('edYear').value.trim()
            };
            if (!entry.school && !entry.degree) { showToast('Add at least a school or degree.', 'warning'); return; }
            
            if (idx >= 0) { userData.education[idx] = entry; }
            else { userData.education.push(entry); }
            
            closeExportModal();
            saveAll();
            refreshExperienceContent();
            showToast(idx >= 0 ? 'Education updated.' : 'Education added.', 'success');
        }
        
        // --- Certifications CRUD ---
        function addCertItem() {
            if (readOnlyGuard()) return;
            openCertModal(-1);
        }
        function editCertItem(idx) {
            if (readOnlyGuard()) return;
            openCertModal(idx);
        }
        function removeCertItem(idx) {
            if (readOnlyGuard()) return;
            if (!confirm('Remove this certification?')) return;
            userData.certifications.splice(idx, 1);
            saveAll();
            refreshExperienceContent();
        }
        
        function openCertModal(idx) {
            var cert = idx >= 0 ? userData.certifications[idx] : { name:'', abbr:'', issuer:'', year:'', type:'Certification', linkedSkills:[], tier:1, libraryMatch:null };
            var isEdit = idx >= 0;
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            
            // Build linked skills display
            var linkedSkills = cert.linkedSkills || [];
            var linkedHTML = linkedSkills.map(function(sn) {
                return '<span style="display:inline-flex; align-items:center; gap:4px; padding:3px 10px; background:' + tv('rgba(139,92,246,0.12)','rgba(139,92,246,0.08)') + '; '
                    + 'color:' + tv('#a78bfa','#7c3aed') + '; border-radius:12px; font-size:0.82em; margin:2px 4px 2px 0;">'
                    + sn + ' <button onclick="removeCertLinkedSkill(this, \'' + sn.replace(/'/g,"\\'") + '\')" style="background:none; border:none; cursor:pointer; color:inherit; font-size:1em; padding:0 2px;">\u00D7</button></span>';
            }).join('');
            
            // Build skill suggestion datalist from profile skills
            var skillOptions = (skillsData.skills || []).map(function(s) {
                return '<option value="' + s.name.replace(/"/g,'&quot;') + '">';
            }).join('');
            
            // Determine tier display
            var tierLevel = cert.tier || 1;
            var tierLabel = tierLevel >= 2 ? 'Advanced' : 'Proficient';
            var tierColor = tierLevel >= 2 ? '#f59e0b' : '#10b981';
            
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">' + (isEdit ? 'Edit Credential' : 'Add Credential') + '</h2>'
                + '<p style="color:' + tv('#9ca3af','#64748b') + '; margin-top:4px; font-size:0.85em;">Search the library or enter manually</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px; max-height:75vh; overflow-y:auto;">'
                
                // Library search
                + '<div class="settings-group" style="margin-bottom:16px; position:relative;">'
                + '<label class="settings-label">\uD83D\uDD0D Search Credential Library <span style="font-weight:400; color:' + tv('#6b7280','#9ca3af') + '; font-size:0.88em;">(191 credentials)</span></label>'
                + '<input type="text" class="settings-input" id="certLibrarySearch" '
                + 'placeholder="Type name, abbreviation, or category..." '
                + 'oninput="onCertLibrarySearch()" autocomplete="off" '
                + 'style="font-size:0.9em;"'
                + (isEdit ? ' value="' + (cert.name||'').replace(/"/g,'&quot;') + '"' : '') + '>'
                + '<div id="certSearchResults" style="display:none; position:absolute; top:100%; left:0; right:0; z-index:100; max-height:240px; overflow-y:auto; '
                + 'background:' + tv('#1e1e2e','#fff') + '; border:1px solid ' + tv('rgba(255,255,255,0.15)','#d1d5db') + '; border-radius:8px; margin-top:4px; '
                + 'box-shadow:0 8px 24px rgba(0,0,0,0.3);"></div>'
                + '</div>'
                
                // Tier badge
                + '<div id="certTierBadge" style="margin-bottom:14px;' + (isEdit && cert.tier ? '' : ' display:none;') + '">'
                + '<span style="font-size:0.78em; padding:3px 10px; border-radius:10px; font-weight:600; background:rgba(' + (tierLevel >= 2 ? '245,158,11' : '16,185,129') + ',0.12); color:' + tierColor + ';">'
                + (tierLevel >= 2 ? '\u2B50 Tier 2: Advanced' : '\u2705 Tier 1: Proficient') + ' floor for linked skills</span>'
                + '</div>'
                
                // Manual fields
                + '<div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">'
                + '<div class="settings-group" style="grid-column:1/-1;"><label class="settings-label">Credential Name *</label>'
                + '<input type="text" class="settings-input" id="certName" value="' + (cert.name||'').replace(/"/g,'&quot;') + '" placeholder="Full credential name"></div>'
                + '<div class="settings-group"><label class="settings-label">Abbreviation</label>'
                + '<input type="text" class="settings-input" id="certAbbr" value="' + (cert.abbr||'').replace(/"/g,'&quot;') + '" placeholder="PMP, CFA, CDL-A" style="font-size:0.9em;"></div>'
                + '<div class="settings-group"><label class="settings-label">Issuing Organization</label>'
                + '<input type="text" class="settings-input" id="certIssuer" value="' + (cert.issuer||'').replace(/"/g,'&quot;') + '" placeholder="PMI, SHRM, AWS, etc."></div>'
                + '<div class="settings-group"><label class="settings-label">Type</label>'
                + '<select class="settings-select" id="certType" style="font-size:0.88em;">'
                + ['Certification','License','Degree','Rating','Endorsement','Credential','Certificate','Commission'].map(function(t) {
                    return '<option value="' + t + '"' + ((cert.type || 'Certification') === t ? ' selected' : '') + '>' + t + '</option>';
                }).join('')
                + '</select></div>'
                + '<div class="settings-group"><label class="settings-label">Year Obtained</label>'
                + '<input type="text" class="settings-input" id="certYear" value="' + (cert.year||'') + '" placeholder="2023"></div>'
                + '</div>'
                
                // Linked skills
                + '<div class="settings-group" style="margin-top:14px;">'
                + '<label class="settings-label">\uD83D\uDD17 Linked Skills</label>'
                + '<div class="settings-help" style="margin-bottom:8px;">Skills linked to this credential receive a <strong id="certFloorLabel">' + tierLabel + '</strong> evidence floor for market valuation.</div>'
                + '<div id="certLinkedSkillsContainer" style="display:flex; flex-wrap:wrap; margin-bottom:8px;">' + linkedHTML + '</div>'
                + '<div style="display:flex; gap:8px;">'
                + '<input type="text" class="settings-input" id="certLinkSkillInput" list="certSkillSuggestions" placeholder="Type skill name..." style="flex:1; font-size:0.88em;">'
                + '<datalist id="certSkillSuggestions">' + skillOptions + '</datalist>'
                + '<button onclick="addCertLinkedSkill()" style="padding:6px 14px; background:' + tv('rgba(139,92,246,0.15)','rgba(139,92,246,0.08)') + '; color:' + tv('#a78bfa','#7c3aed') + '; border:1px solid ' + tv('rgba(139,92,246,0.3)','rgba(139,92,246,0.2)') + '; border-radius:6px; cursor:pointer; font-size:0.82em; white-space:nowrap;">+ Link</button>'
                + '</div></div>'
                
                // Save/Cancel
                + '<div style="display:flex; gap:10px; margin-top:20px;">'
                + '<button onclick="saveCertFromModal(' + idx + ')" style="background:var(--accent); color:#fff; border:none; padding:10px 24px; border-radius:8px; cursor:pointer; font-weight:600;">'
                + (isEdit ? 'Save' : 'Add Credential') + '</button>'
                + '<button onclick="closeExportModal()" style="background:transparent; color:' + tv('#9ca3af','#64748b') + '; border:1px solid ' + tv('rgba(255,255,255,0.1)','#d1d5db') + '; padding:10px 20px; border-radius:8px; cursor:pointer;">Cancel</button>'
                + '</div></div>';
            
            modal.style.display = 'flex';
            initCertLinkedSkills(linkedSkills);
            window._selectedLibCert = cert.libraryMatch || null;
        }
        
        // Library search handler
        function onCertLibrarySearch() {
            var input = document.getElementById('certLibrarySearch');
            var results = document.getElementById('certSearchResults');
            if (!input || !results) return;
            
            var query = input.value.trim();
            if (query.length < 2) { results.style.display = 'none'; return; }
            
            var matches = searchCertLibrary(query);
            if (matches.length === 0) {
                results.innerHTML = '<div style="padding:12px 16px; color:' + tv('#6b7280','#9ca3af') + '; font-size:0.85em;">No matches. Enter the credential manually below.</div>';
                results.style.display = 'block';
                return;
            }
            
            var html = '';
            matches.forEach(function(c) {
                var tierBg = c.tier >= 2 ? 'rgba(245,158,11,0.1)' : 'rgba(16,185,129,0.1)';
                var tierColor = c.tier >= 2 ? '#f59e0b' : '#10b981';
                var tierTag = c.tier >= 2 ? 'ADV' : 'PRO';
                
                html += '<div onclick="selectCertFromLibrary(\'' + c.abbr.replace(/'/g,"\\'") + '\')" '
                    + 'style="padding:10px 16px; cursor:pointer; border-bottom:1px solid ' + tv('rgba(255,255,255,0.05)','rgba(0,0,0,0.04)') + '; '
                    + 'transition:background 0.1s;" '
                    + 'onmouseover="this.style.background=\'' + tv('rgba(255,255,255,0.06)','rgba(0,0,0,0.03)') + '\'" '
                    + 'onmouseout="this.style.background=\'transparent\'">'
                    + '<div style="display:flex; justify-content:space-between; align-items:center;">'
                    + '<div>'
                    + '<div style="font-weight:600; color:' + tv('#e0e0e0','#1f2937') + '; font-size:0.88em;">'
                    + c.name + ' <span style="color:' + tv('#60a5fa','#2563eb') + '; font-size:0.85em;">(' + c.abbr + ')</span></div>'
                    + '<div style="font-size:0.78em; color:' + tv('#9ca3af','#64748b') + ';">' + c.category + ' \u00B7 ' + c.type
                    + (c.skills ? ' \u00B7 ' + c.skills.length + ' skill links' : '') + '</div>'
                    + '</div>'
                    + '<span style="font-size:0.7em; padding:2px 8px; border-radius:8px; background:' + tierBg + '; color:' + tierColor + '; font-weight:700;">' + tierTag + '</span>'
                    + '</div></div>';
            });
            
            results.innerHTML = html;
            results.style.display = 'block';
        }
        window.onCertLibrarySearch = onCertLibrarySearch;
        
        function selectCertFromLibrary(abbr) {
            var cert = findCertInLibrary(abbr);
            if (!cert) return;
            
            document.getElementById('certName').value = cert.name;
            document.getElementById('certAbbr').value = cert.abbr;
            document.getElementById('certLibrarySearch').value = cert.name;
            
            var typeSelect = document.getElementById('certType');
            if (typeSelect) {
                var opts = Array.from(typeSelect.options);
                var match = opts.find(function(o) { return o.value === cert.type; });
                if (match) typeSelect.value = cert.type;
            }
            
            // Update tier badge
            var badge = document.getElementById('certTierBadge');
            var floorLabel = document.getElementById('certFloorLabel');
            if (badge) {
                var tColor = cert.tier >= 2 ? '#f59e0b' : '#10b981';
                var tBg = cert.tier >= 2 ? '245,158,11' : '16,185,129';
                badge.style.display = '';
                badge.innerHTML = '<span style="font-size:0.78em; padding:3px 10px; border-radius:10px; font-weight:600; background:rgba(' + tBg + ',0.12); color:' + tColor + ';">'
                    + (cert.tier >= 2 ? '\u2B50 Tier 2: Advanced' : '\u2705 Tier 1: Proficient') + ' floor for linked skills</span>'
                    + (cert.skills ? ' <span style="font-size:0.72em; color:' + tv('#9ca3af','#64748b') + ';">\u00B7 ' + cert.skills.length + ' curated skill links</span>' : '');
            }
            if (floorLabel) floorLabel.textContent = cert.tier >= 2 ? 'Advanced' : 'Proficient';
            
            // Auto-suggest skill links
            var associations = getCertSkillAssociations(cert);
            if (associations.length > 0) {
                window._certLinkedSkills = [];
                var container = document.getElementById('certLinkedSkillsContainer');
                container.innerHTML = '';
                associations.forEach(function(sn) {
                    window._certLinkedSkills.push(sn);
                    var span = document.createElement('span');
                    span.style.cssText = 'display:inline-flex; align-items:center; gap:4px; padding:3px 10px; background:' + tv('rgba(139,92,246,0.12)','rgba(139,92,246,0.08)') + '; color:' + tv('#a78bfa','#7c3aed') + '; border-radius:12px; font-size:0.82em; margin:2px 4px 2px 0;';
                    span.innerHTML = sn + ' <button onclick="removeCertLinkedSkill(this, \'' + sn.replace(/'/g,"\\'") + '\')" style="background:none; border:none; cursor:pointer; color:inherit; font-size:1em; padding:0 2px;">\u00D7</button>';
                    container.appendChild(span);
                });
            }
            
            window._selectedLibCert = cert;
            document.getElementById('certSearchResults').style.display = 'none';
        }
        window.selectCertFromLibrary = selectCertFromLibrary;
        
        // Helper: track linked skills in modal state
        window._certLinkedSkills = [];
        function initCertLinkedSkills(skills) { window._certLinkedSkills = skills.slice(); }
        
        function addCertLinkedSkill() {
            var input = document.getElementById('certLinkSkillInput');
            var name = input.value.trim();
            if (!name) return;
            if (window._certLinkedSkills.indexOf(name) >= 0) { input.value = ''; return; }
            window._certLinkedSkills.push(name);
            
            var container = document.getElementById('certLinkedSkillsContainer');
            var span = document.createElement('span');
            span.style.cssText = 'display:inline-flex; align-items:center; gap:4px; padding:3px 10px; background:' + tv('rgba(139,92,246,0.12)','rgba(139,92,246,0.08)') + '; color:' + tv('#a78bfa','#7c3aed') + '; border-radius:12px; font-size:0.82em; margin:2px 4px 2px 0;';
            span.innerHTML = name + ' <button onclick="removeCertLinkedSkill(this, \'' + name.replace(/'/g,"\\'") + '\')" style="background:none; border:none; cursor:pointer; color:inherit; font-size:1em; padding:0 2px;">\u00D7</button>';
            container.appendChild(span);
            input.value = '';
            input.focus();
        }
        window.addCertLinkedSkill = addCertLinkedSkill;
        
        function removeCertLinkedSkill(btn, name) {
            var idx = window._certLinkedSkills.indexOf(name);
            if (idx >= 0) window._certLinkedSkills.splice(idx, 1);
            btn.parentElement.remove();
        }
        window.removeCertLinkedSkill = removeCertLinkedSkill;
        
        function saveCertFromModal(idx) {
            var libCert = window._selectedLibCert || null;
            var entry = {
                id: idx >= 0 ? (userData.certifications[idx].id || 'cert-' + Date.now()) : 'cert-' + Date.now(),
                name: document.getElementById('certName').value.trim(),
                abbr: (document.getElementById('certAbbr') || {}).value ? document.getElementById('certAbbr').value.trim() : '',
                issuer: document.getElementById('certIssuer').value.trim(),
                type: (document.getElementById('certType') || {}).value || 'Certification',
                year: document.getElementById('certYear').value.trim(),
                linkedSkills: window._certLinkedSkills ? window._certLinkedSkills.slice() : [],
                tier: libCert ? libCert.tier : 1,
                libraryMatch: libCert ? libCert.abbr : null
            };
            if (!entry.name) { showToast('Certification name is required.', 'warning'); return; }
            
            if (idx >= 0) { userData.certifications[idx] = entry; }
            else { userData.certifications.push(entry); }
            
            // Auto-add and bump skills from cert associations
            var certFloorLevel = entry.tier >= 2 ? 'Advanced' : 'Proficient';
            var certFloorVal = proficiencyValue(certFloorLevel);
            var allLinkedSkills = entry.linkedSkills.slice();
            
            // Also include library curated skills if not already in linked list
            if (libCert && libCert.skills) {
                libCert.skills.forEach(function(sn) {
                    if (allLinkedSkills.indexOf(sn) < 0) allLinkedSkills.push(sn);
                });
            }
            
            var added = [];
            var bumped = [];
            var defaultRoles = (userData.roles || []).map(function(r) { return r.id; });
            
            allLinkedSkills.forEach(function(skillName) {
                var existing = userData.skills.find(function(s) { return s.name.toLowerCase() === skillName.toLowerCase(); });
                var existingSD = (skillsData.skills || []).find(function(s) { return s.name.toLowerCase() === skillName.toLowerCase(); });
                
                if (!existing) {
                    // Skill not in profile: add it at the cert floor level
                    var newSkill = {
                        name: skillName,
                        category: 'unique',
                        level: certFloorLevel,
                        roles: defaultRoles,
                        key: false,
                        addedFrom: 'certification',
                        certSource: entry.name
                    };
                    userData.skills.push(newSkill);
                    skillsData.skills.push(newSkill);
                    if (typeof registerInSkillLibrary === 'function') registerInSkillLibrary(skillName, 'unique');
                    added.push(skillName);
                } else {
                    // Skill exists: check if it needs a bump
                    var currentVal = proficiencyValue(existing.level);
                    if (currentVal < certFloorVal) {
                        var oldLevel = existing.level;
                        existing.level = certFloorLevel;
                        if (existingSD) existingSD.level = certFloorLevel;
                        bumped.push(skillName + ' (' + oldLevel + ' \u2192 ' + certFloorLevel + ')');
                    }
                }
            });
            
            closeExportModal();
            saveAll();
            rescoreAllJobs();
            refreshAllViews();
            refreshExperienceContent();
            
            // Build notification
            var msgs = [];
            if (idx >= 0) {
                msgs.push('\uD83C\uDFC5 Credential updated: ' + entry.name);
            } else {
                msgs.push('\uD83C\uDFC5 Credential added: ' + entry.name);
            }
            
            if (added.length > 0) {
                msgs.push('\u2795 Added ' + added.length + ' skill' + (added.length > 1 ? 's' : '') + ': ' + added.join(', '));
            }
            if (bumped.length > 0) {
                msgs.push('\u2B06 Bumped ' + bumped.length + ' skill' + (bumped.length > 1 ? 's' : '') + ' to ' + certFloorLevel + ': ' + bumped.join(', '));
            }
            
            if (added.length > 0 || bumped.length > 0) {
                // Show detailed notification modal
                showCertSkillNotification(entry, added, bumped, certFloorLevel);
            } else {
                showToast(msgs[0], 'success');
            }
        }
        
        function showCertSkillNotification(cert, added, bumped, floorLevel) {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            
            var tierColor = cert.tier >= 2 ? '#f59e0b' : '#10b981';
            var tierLabel = cert.tier >= 2 ? 'Tier 2 (Advanced)' : 'Tier 1 (Proficient)';
            
            var html = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">\uD83C\uDFC5 Credential Impact</h2>'
                + '<p style="color:' + tv('#9ca3af','#64748b') + '; margin-top:4px; font-size:0.85em;">' + cert.name + (cert.abbr ? ' (' + cert.abbr + ')' : '') + '</p>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">\u00D7</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:24px;">';
            
            // Summary
            html += '<div style="background:' + tv('rgba(16,185,129,0.08)','rgba(16,185,129,0.05)') + '; border:1px solid ' + tv('rgba(16,185,129,0.2)','rgba(16,185,129,0.12)') + '; border-radius:10px; padding:16px; margin-bottom:16px;">'
                + '<div style="font-weight:700; color:' + tierColor + '; font-size:0.9em; margin-bottom:8px;">' + tierLabel + ' \u2014 ' + floorLevel + ' floor applied</div>'
                + '<div style="color:' + tv('#d1d5db','#475569') + '; font-size:0.85em; line-height:1.5;">'
                + 'This credential proves competence in the skills below. Evidence points and market valuation have been updated automatically.'
                + '</div></div>';
            
            // Added skills
            if (added.length > 0) {
                html += '<div style="margin-bottom:14px;">'
                    + '<div style="font-weight:600; color:' + tv('#10b981','#059669') + '; font-size:0.85em; margin-bottom:8px;">\u2795 Skills Added to Profile (' + added.length + ')</div>';
                added.forEach(function(sn) {
                    html += '<div style="padding:6px 12px; margin-bottom:4px; background:' + tv('rgba(16,185,129,0.06)','rgba(16,185,129,0.03)') + '; border-radius:6px; font-size:0.85em; color:' + tv('#e0e0e0','#1f2937') + ';">'
                        + sn + ' <span style="color:' + tierColor + '; font-size:0.85em;">\u2192 ' + floorLevel + '</span></div>';
                });
                html += '</div>';
            }
            
            // Bumped skills
            if (bumped.length > 0) {
                html += '<div style="margin-bottom:14px;">'
                    + '<div style="font-weight:600; color:' + tv('#60a5fa','#2563eb') + '; font-size:0.85em; margin-bottom:8px;">\u2B06 Skills Upgraded (' + bumped.length + ')</div>';
                bumped.forEach(function(desc) {
                    html += '<div style="padding:6px 12px; margin-bottom:4px; background:' + tv('rgba(96,165,250,0.06)','rgba(96,165,250,0.03)') + '; border-radius:6px; font-size:0.85em; color:' + tv('#e0e0e0','#1f2937') + ';">'
                        + desc + '</div>';
                });
                html += '</div>';
            }
            
            html += '<div style="text-align:center; margin-top:18px;">'
                + '<button onclick="closeExportModal()" style="padding:10px 28px; background:var(--accent); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;">Got It</button>'
                + '</div></div>';
            
            mc.innerHTML = html;
            modal.style.display = 'flex';
        }
        window.showCertSkillNotification = showCertSkillNotification;
        
        // Expose experience functions to global scope
        window.addWorkHistoryItem = addWorkHistoryItem;
        window.editWorkHistoryItem = editWorkHistoryItem;
        window.removeWorkHistoryItem = removeWorkHistoryItem;
        window.addAchievementInput = addAchievementInput;
        window.saveWorkHistoryFromModal = saveWorkHistoryFromModal;
        window.addEducationItem = addEducationItem;
        window.editEducationItem = editEducationItem;
        window.removeEducationItem = removeEducationItem;
        window.saveEducationFromModal = saveEducationFromModal;
        window.addCertItem = addCertItem;
        window.editCertItem = editCertItem;
        window.removeCertItem = removeCertItem;
        window.saveCertFromModal = saveCertFromModal;
        
        function renderJobPreferences() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">${bpIcon("target",20)}</span>
                            <span>Job Matching Preferences</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ${bpIcon("lightbulb",14)} HOW JOB MATCHING WORKS
                        </div>
                        <div class="coaching-tip-content">
                            These settings control which jobs appear in your Opportunities feed. 
                            Set your seniority level to filter out irrelevant positions.
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Seniority Level</label>
                        <select class="settings-select" id="settingSeniority">
                            <option value="Entry" ${userData.preferences.seniorityLevel === 'Entry' ? 'selected' : ''}>Entry Level</option>
                            <option value="Mid" ${userData.preferences.seniorityLevel === 'Mid' ? 'selected' : ''}>Mid Level</option>
                            <option value="Senior" ${userData.preferences.seniorityLevel === 'Senior' ? 'selected' : ''}>Senior Level</option>
                            <option value="Executive" ${userData.preferences.seniorityLevel === 'Executive' ? 'selected' : ''}>Executive Level</option>
                        </select>
                        <div class="settings-help">
                            <strong>Entry:</strong> Includes junior, associate roles<br>
                            <strong>Mid:</strong> Includes senior, lead, manager roles<br>
                            <strong>Senior:</strong> Includes senior manager, director roles<br>
                            <strong>Executive:</strong> VP, Chief, Head of roles only
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Minimum Match Score</label>
                        <input type="range" min="0" max="100" value="${userData.preferences.minimumMatchScore}" 
                               class="match-slider" style="width: 100%;"
                               oninput="document.getElementById('matchScoreValue').textContent = this.value + '%'">
                        <div style="text-align: center; color: #fbbf24; font-weight: 600; font-size: 1.2em; margin-top: 10px;">
                            <span id="matchScoreValue">${userData.preferences.minimumMatchScore}%</span>
                        </div>
                        <div class="settings-help">Only show jobs with at least this match percentage</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Minimum Skill Matches</label>
                        <input type="number" min="1" max="10" class="settings-input" id="settingMinSkills"
                               value="${userData.preferences.minimumSkillMatches}">
                        <div class="settings-help">Jobs must match at least this many of your skills</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Minimum Salary (Optional)</label>
                        <input type="number" class="settings-input" id="settingMinSalary" 
                               value="${userData.preferences.minSalary || ''}"
                               placeholder="e.g., 150000">
                        <div class="settings-help">Leave blank for no minimum. Enter annual salary (USD).</div>
                    </div>
                    
                    <button class="save-settings-btn" onclick="saveSettings()">
                        ${bpIcon("save",14)} Save Settings
                    </button>
                </div>
            `;
        }
        
        function renderDataExport() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">${bpIcon("save",20)}</span>
                            <span>Backup & Restore</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ${bpIcon("lightbulb",14)} DATA PORTABILITY
                        </div>
                        <div class="coaching-tip-content">
                            Export your complete Blueprint as JSON to back up all your data. 
                            Import from a previous export to restore or transfer to another device.
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 20px;">
                            <h3 style="color: #60a5fa; margin-bottom: 10px;">${bpIcon("upload",14)} Export Profile</h3>
                            <p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">
                                Download complete backup including skills, outcomes, values, and all settings
                            </p>
                            <button class="export-btn-large" onclick="exportFullProfile()" style="width: 100%;">
                                Download Backup
                            </button>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 20px;">
                            <h3 style="color: #10b981; margin-bottom: 10px;">${bpIcon("download",14)} Import Profile</h3>
                            <p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">
                                Restore from a previous backup or transfer from another device
                            </p>
                            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importFullProfile(this)">
                            <button class="export-btn-large" onclick="document.getElementById('importFileInput').click()" 
                                    style="width: 100%; background: #10b981;">
                                Select Backup File
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px;">
                        <strong style="color: #ef4444;">${bpIcon("warning",14)} Warning:</strong>
                        <span style="color: #d1d5db; font-size: 0.9em;">
                            Importing will replace all current data. Make sure to export first if you want to keep your current profile!
                        </span>
                    </div>
                </div>
            `;
        }
        

        // ===== PRIVACY & DATA (v4.20.0, absorbed from Consent + Data Export) =====
        function renderPrivacyAndData() {
            var tc = tv('#d1d5db','#334155');
            var hc = tv('#60a5fa','#1e40af');
            var sc = tv('#9ca3af','#64748b');
            var bgCard = tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)');
            
            var html = '';
            
            // --- Sharing Presets (from Consent) ---
            html += '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('share',20) + '</span>'
                + '<span>Sharing Presets</span>'
                + '</div>'
                + '</div>'
                + '<div class="coaching-tip">'
                + '<div class="coaching-tip-title">'
                + bpIcon('lightbulb',14) + ' CHOOSE YOUR SHARING LEVEL'
                + '</div>'
                + '<div class="coaching-tip-content">'
                + 'Select a preset that matches your audience. These control what data appears in exports and shared views.'
                + '</div>'
                + '</div>'
                + '<div class="values-grid">'
                + Object.entries(sharePresets).map(function(entry) { return renderPresetCard(entry[0], entry[1]); }).join('')
                + '</div>'
                + '</div>';
            
            // --- What You're Sharing (from Consent) ---
            var skillCount = (skillsData.skills || []).length;
            var sharedSkills = currentPreset === 'full' ? skillCount : 
                                currentPreset === 'executive' ? Math.min(20, skillCount) :
                                currentPreset === 'advisory' ? skillsData.skills.filter(function(s) { return s.key; }).length :
                                currentPreset === 'board' ? skillsData.skills.filter(function(s) { return s.key || s.level === 'Mastery'; }).length :
                                skillCount;
            var sharedOutcomes = blueprintData.outcomes.filter(function(o) { return o.shared; }).length;
            var sharedValues = blueprintData.values.filter(function(v) { return v.selected; }).length;
            
            html += '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('eye',20) + '</span>'
                + '<span>What You\'re Sharing</span>'
                + '</div>'
                + '</div>'
                + '<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:16px;">'
                + '<div style="background:rgba(96,165,250,0.1); border:1px solid rgba(96,165,250,0.3); border-radius:8px; padding:20px; text-align:center;">'
                + '<div style="font-size:2em; color:#60a5fa; font-weight:bold;">' + sharedSkills + '</div>'
                + '<div style="color:' + sc + '; margin-top:5px;">Skills</div></div>'
                + '<div style="background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); border-radius:8px; padding:20px; text-align:center;">'
                + '<div style="font-size:2em; color:#10b981; font-weight:bold;">' + sharedOutcomes + '</div>'
                + '<div style="color:' + sc + '; margin-top:5px;">Outcomes</div></div>'
                + '<div style="background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.3); border-radius:8px; padding:20px; text-align:center;">'
                + '<div style="font-size:2em; color:#fbbf24; font-weight:bold;">' + sharedValues + '</div>'
                + '<div style="color:' + sc + '; margin-top:5px;">Values</div></div>'
                + '</div>'
                + '<div style="margin-top:16px; padding:12px 15px; background:rgba(251,191,36,0.08); border-left:3px solid #fbbf24; border-radius:4px; font-size:0.9em;">'
                + '<strong style="color:#fbbf24;">Note:</strong> '
                + '<span style="color:' + tc + ';">Sensitive content (recovery, personal loss) is flagged in Blueprint. Review before sharing.</span>'
                + '</div>'
                + '</div>';
            
            // --- Backup & Restore ---
            html += renderDataExport();
            
            // --- Privacy & Legal (from Consent) ---
            html += '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('privacy',20) + '</span>'
                + '<span>Privacy & Data Rights</span>'
                + '</div>'
                + '</div>'
                + '<div style="color:' + tc + '; line-height:1.7;">'
                + '<p style="margin-bottom:16px;">When signed in, your Blueprint data is stored securely in Firebase (Google Cloud). '
                + 'When not signed in, data persists locally in your browser. You have complete control over what you share.</p>'
                + '<div style="display:grid; gap:8px;">'
                + '<div style="padding:10px; background:' + bgCard + '; border-radius:6px;">'
                + '<strong>CCPA</strong> &mdash; <span style="font-size:0.9em; color:' + sc + ';">Right to know, delete, and opt-out of data sale</span></div>'
                + '<div style="padding:10px; background:' + bgCard + '; border-radius:6px;">'
                + '<strong>GDPR</strong> &mdash; <span style="font-size:0.9em; color:' + sc + ';">Right to access, rectify, erase, and port your data</span></div>'
                + '<div style="padding:10px; background:' + bgCard + '; border-radius:6px;">'
                + '<strong>EEOC</strong> &mdash; <span style="font-size:0.9em; color:' + sc + ';">Employers must handle your data fairly, no discrimination</span></div>'
                + '</div>'
                + '</div></div>';
            
            // --- Data Rights Actions ---
            html += '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('lock',20) + '</span>'
                + '<span>Your Data Rights</span>'
                + '</div>'
                + '</div>'
                + '<div style="color:' + tc + '; line-height:1.7; font-size:0.93em;">'
                + '<p style="margin-bottom:16px;">Under GDPR and similar privacy regulations, you have the right to access, export, and delete your personal data at any time.</p>'
                + '<div style="display:flex; gap:12px; flex-wrap:wrap;">'
                + '<button onclick="viewMyData()" style="background:' + tv('rgba(96,165,250,0.12)','rgba(30,64,175,0.08)') + '; border:1px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + '; color:' + tv('#60a5fa','#1e40af') + '; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">' + bpIcon('eye',14) + ' View My Stored Data</button>'
                + '<button onclick="exportMyData()" style="background:' + tv('rgba(16,185,129,0.12)','rgba(5,150,105,0.08)') + '; border:1px solid ' + tv('rgba(16,185,129,0.3)','rgba(5,150,105,0.2)') + '; color:' + tv('#10b981','#059669') + '; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">' + bpIcon('download',14) + ' Export My Data</button>'
                + '<button onclick="requestDataDeletion()" style="background:' + tv('rgba(239,68,68,0.08)','rgba(220,38,38,0.05)') + '; border:1px solid ' + tv('rgba(239,68,68,0.3)','rgba(220,38,38,0.2)') + '; color:' + tv('#ef4444','#dc2626') + '; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;">' + bpIcon('trash',14) + ' Delete All My Data</button>'
                + '</div>'
                + '<div style="margin-top:12px; font-size:0.82em; color:' + tv('#6b7280','#9ca3af') + ';">'
                + 'You must be signed in to use these features. Data deletion is permanent and cannot be undone.'
                + '</div>'
                + '</div></div>';
            
            return html;
        }
        window.renderPrivacyAndData = renderPrivacyAndData;


        // ===== SAMPLE MODE BULK ACTION DISABLING (v4.20.2) =====
        function disableBulkActionsInSampleMode() {
            // Check if viewing a sample profile
            var isSample = window.isReadOnlyProfile || (window.currentProfileType && window.currentProfileType !== 'user');
            if (!isSample && typeof skillsData !== 'undefined' && skillsData.sample) isSample = true;
            
            if (isSample) {
                // Disable all bulk action buttons
                document.querySelectorAll('.bulk-action-btn').forEach(function(btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.35';
                    btn.style.cursor = 'not-allowed';
                    btn.style.pointerEvents = 'none';
                    btn.title = 'Not available in sample/demo mode';
                });
                
                // Also handle inline onclick buttons for openBulkImport and openBulkManager
                document.querySelectorAll('.export-btn-large').forEach(function(btn) {
                    var onclick = btn.getAttribute('onclick') || '';
                    if (onclick.includes('openBulkImport') || onclick.includes('openBulkManager')) {
                        btn.disabled = true;
                        btn.style.opacity = '0.35';
                        btn.style.cursor = 'not-allowed';
                        btn.title = 'Not available in sample/demo mode';
                    }
                });
            }
        }
        window.disableBulkActionsInSampleMode = disableBulkActionsInSampleMode;
        // [removed] renderSkillManagement — dead code cleanup v4.22.0
        
        function renderSkillsList() {
            const categoryFilter = document.getElementById('skillCategoryFilter')?.value || 'all';
            const searchQuery = document.getElementById('skillSearchInput')?.value.toLowerCase() || '';
            
            let skills = userData.skills || [];
            
            // Apply filters
            if (categoryFilter !== 'all') {
                skills = skills.filter(s => s.category === categoryFilter);
            }
            if (searchQuery) {
                skills = skills.filter(s => s.name.toLowerCase().includes(searchQuery));
            }
            
            if (skills.length === 0) {
                return `<div style="text-align: center; padding: 40px; color: #9ca3af;">
                    No skills found. ${searchQuery ? 'Try a different search.' : 'Add some skills to get started!'}
                </div>`;
            }
            
            // Group by category
            const grouped = {
                skill: skills.filter(s => s.category === 'skill'),
                ability: skills.filter(s => s.category === 'ability'),
                workstyle: skills.filter(s => s.category === 'workstyle'),
                unique: skills.filter(s => s.category === 'unique')
            };
            
            const categoryLabels = {
                skill: { name: 'O*NET Skills', color: '#60a5fa', badge: 'SKILL' },
                ability: { name: 'O*NET Abilities', color: '#a78bfa', badge: 'ABILITY' },
                workstyle: { name: 'O*NET Work Styles', color: '#10b981', badge: 'WORK STYLE' },
                unique: { name: 'Unique Skills', color: '#fbbf24', badge: 'UNIQUE' }
            };
            
            let html = '';
            
            Object.entries(grouped).forEach(([category, categorySkills]) => {
                if (categorySkills.length === 0) return;
                
                const label = categoryLabels[category];
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: ${label.color}; font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>${label.name}</span>
                            <span style="font-size: 0.8em; opacity: 0.7;">(${categorySkills.length})</span>
                        </h3>
                        <div style="display: grid; gap: 10px;">
                `;
                
                categorySkills.forEach(skill => {
                    const roleNames = skill.roles.map(roleId => {
                        const role = userData.roles.find(r => r.id === roleId);
                        return role ? role.name : roleId;
                    }).join(', ');
                    
                    const levelColors = {
                        'Mastery':    '#ef4444',
                        'Expert':     '#f97316',
                        'Advanced':   '#f59e0b',
                        'Proficient': '#10b981',
                        'Novice':     '#6b7280'
                    };
                    
                    html += `
                        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                        <span style="font-weight: 600; font-size: 1.05em;">${skill.name}</span>
                                        <span style="background: rgba(${category === 'skill' ? '59, 130, 246' : category === 'ability' ? '139, 92, 246' : category === 'workstyle' ? '16, 185, 129' : '251, 191, 36'}, 0.2); 
                                                     color: ${label.color}; 
                                                     font-size: 0.7em; 
                                                     padding: 2px 6px; 
                                                     border-radius: 3px;">
                                            ${label.badge}
                                        </span>
                                        ${skill.key ? '<span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; font-size: 0.7em; padding: 2px 6px; border-radius: 3px;">CORE</span>' : ''}
                                    </div>
                                    <div style="color: #9ca3af; font-size: 0.9em;">
                                        <span style="color: ${levelColors[skill.level]}; font-weight: 600;">${skill.level}</span>
                                        ${roleNames ? ` • ${roleNames}` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                    <button onclick="openEditSkillModal('${skill.name.replace(/'/g, "\\'")}', '${category}')" 
                                            style="padding: 6px 12px; background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
                                        ${bpIcon("edit",12)} Edit
                                    </button>
                                    <button onclick="confirmDeleteSkill('${skill.name.replace(/'/g, "\\'")}', '${category}')" 
                                            style="padding: 6px 12px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 4px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
                                        ${bpIcon("trash",14)}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function filterSkillsList() {
            const container = document.getElementById('skillsList');
            if (container) {
                container.innerHTML = renderSkillsList();
            }
        }
        
        // saveUserData and loadUserData: single source of truth is the profile JSON.
        // localStorage only stores which profile is currently active (handled in first saveUserData definition).
        // This comment replaces duplicate/conflicting definitions that were removed in v3.5.2.
        
        function exportFullProfile() {
            const fullData = {
                userData: userData,
                blueprintData: blueprintData,
                skillsData: {
                    skills: skillsData.skills,
                    roles: skillsData.roles,
                    skillDetails: skillsData.skillDetails
                },
                version: '1.0',
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(fullData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `blueprint-full-${userData.profile.name || 'profile'}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function importFullProfile(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace your current Blueprint data. Continue?')) {
                        // Restore all data
                        if (imported.userData) Object.assign(userData, imported.userData);
                        if (imported.blueprintData) Object.assign(blueprintData, imported.blueprintData);
                        if (imported.skillsData) {
                            if (imported.skillsData.skills) skillsData.skills = imported.skillsData.skills;
                            if (imported.skillsData.roles) skillsData.roles = imported.skillsData.roles;
                            if (imported.skillsData.skillDetails) skillsData.skillDetails = imported.skillsData.skillDetails;
                        }
                        
                        // Save to localStorage
                        saveUserData();
                        
                        showToast('Profile imported. Refreshing page...', 'success');
                        location.reload();
                    }
                } catch (err) {
                    showToast('Import error: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // ===== APPLICATIONS TRACKER SYSTEM =====
        
        function initApplications() {
            const view = document.getElementById('applicationsView');
            
            view.innerHTML = `
                <div class="applications-header">
                    <h2 style="font-size: 2em; color: #60a5fa; margin-bottom: 10px;">Application Tracker</h2>
                    <p style="color: #9ca3af; margin-bottom: 20px;">Track your job applications and follow-ups</p>
                    <button class="export-btn-large" onclick="addApplicationModal()" style="display: inline-flex; align-items: center; gap: 8px;">
                        ${bpIcon("plus",14)} Add Application
                    </button>
                </div>
                
                <div id="applicationsContainer"></div>
            `;
            
            renderApplications();
        }
        
        function renderApplications() {
            const container = document.getElementById('applicationsContainer');
            
            if (!userData.applications || userData.applications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="margin-bottom: 20px;">${bpIcon("clipboard",48)}</div>
                        <h3 style="color: #d1d5db; margin-bottom: 10px;">No applications tracked yet</h3>
                        <p>Click "Add Application" above to start tracking your job search</p>
                        <div style="margin-top: 30px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                            <strong style="color: #60a5fa;">Track from Opportunities:</strong>
                            <p style="font-size: 0.9em; margin-top: 8px;">When you generate a pitch for a job, you'll have the option to automatically add it to your application tracker.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Group by status
            const grouped = {
                applied: userData.applications.filter(a => a.status === 'applied'),
                interviewing: userData.applications.filter(a => a.status === 'interviewing'),
                offer: userData.applications.filter(a => a.status === 'offer'),
                rejected: userData.applications.filter(a => a.status === 'rejected')
            };
            
            container.innerHTML = `
                <div style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="application-status status-applied">${grouped.applied.length} Applied</div>
                    <div class="application-status status-interviewing">${grouped.interviewing.length} Interviewing</div>
                    <div class="application-status status-offer">${grouped.offer.length} Offers</div>
                    <div class="application-status status-rejected">${grouped.rejected.length} Closed</div>
                </div>
                
                <div class="applications-grid">
                    ${userData.applications.map((app, idx) => renderApplicationCard(app, idx)).join('')}
                </div>
            `;
        }
        
        function renderApplicationCard(app, idx) {
            const statusLabels = {
                applied: 'Applied',
                interviewing: 'Interviewing',
                offer: 'Offer Received',
                rejected: 'Closed'
            };
            
            return `
                <div class="application-card">
                    <div class="application-status status-${app.status}">
                        ${statusLabels[app.status]}
                    </div>
                    
                    <div class="application-title">${app.title}</div>
                    <div class="application-company">${app.company}</div>
                    
                    <div class="application-meta-grid">
                        <div class="application-meta-item">
                            <div class="application-meta-label">Applied</div>
                            <div class="application-meta-value">${new Date(app.appliedDate).toLocaleDateString()}</div>
                        </div>
                        <div class="application-meta-item">
                            <div class="application-meta-label">Match</div>
                            <div class="application-meta-value">${app.matchScore || 'N/A'}%</div>
                        </div>
                        ${app.salary ? `
                            <div class="application-meta-item">
                                <div class="application-meta-label">Salary</div>
                                <div class="application-meta-value">${app.salary}</div>
                            </div>
                        ` : ''}
                        ${app.nextFollowUp ? `
                            <div class="application-meta-item">
                                <div class="application-meta-label">Follow Up</div>
                                <div class="application-meta-value">${new Date(app.nextFollowUp).toLocaleDateString()}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${app.notes ? `
                        <div class="application-notes">
                            ${bpIcon("edit",12)} ${app.notes}
                        </div>
                    ` : ''}
                    
                    <div class="application-actions">
                        <button class="application-btn" onclick="updateApplicationStatus(${idx})">
                            ${bpIcon("clock",12)} Update Status
                        </button>
                        <button class="application-btn" onclick="editApplication(${idx})">
                            ✏️ Edit
                        </button>
                        ${app.url ? `
                            <button class="application-btn" onclick="window.open('${app.url}', '_blank')">
                                ${bpIcon("external",12)} View Job
                            </button>
                        ` : ''}
                        <button class="application-btn delete" onclick="deleteApplication(${idx})">
                            ${bpIcon("trash",14)} Remove
                        </button>
                    </div>
                </div>
            `;
        }
        
        function addApplicationModal(jobData = null) {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Add Application</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Track a job you've applied to</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <label class="settings-label">Job Title *</label>
                            <input type="text" id="appTitle" value="${jobData?.title || ''}" class="settings-input" required>
                        </div>
                        
                        <div>
                            <label class="settings-label">Company *</label>
                            <input type="text" id="appCompany" value="${jobData?.company || ''}" class="settings-input" required>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label class="settings-label">Applied Date *</label>
                                <input type="date" id="appDate" value="${new Date().toISOString().split('T')[0]}" class="settings-input" required>
                            </div>
                            <div>
                                <label class="settings-label">Status</label>
                                <select id="appStatus" class="settings-select">
                                    <option value="applied">Applied</option>
                                    <option value="interviewing">Interviewing</option>
                                    <option value="offer">Offer Received</option>
                                    <option value="rejected">Closed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label class="settings-label">Salary Range</label>
                                <input type="text" id="appSalary" value="${jobData?.salary || ''}" placeholder="e.g., $150k-$200k" class="settings-input">
                            </div>
                            <div>
                                <label class="settings-label">Match Score</label>
                                <input type="number" id="appMatch" value="${jobData?.matchScore || ''}" min="0" max="100" class="settings-input">
                            </div>
                        </div>
                        
                        <div>
                            <label class="settings-label">Job URL</label>
                            <input type="url" id="appUrl" value="${jobData?.url || ''}" placeholder="https://" class="settings-input">
                        </div>
                        
                        <div>
                            <label class="settings-label">Follow-Up Date</label>
                            <input type="date" id="appFollowUp" class="settings-input">
                        </div>
                        
                        <div>
                            <label class="settings-label">Notes</label>
                            <textarea id="appNotes" class="purpose-editor" style="min-height: 80px;" placeholder="Contact names, interview details, etc."></textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                        <button class="action-btn" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Cancel
                        </button>
                        <button class="export-btn-large" onclick="saveApplication()" style="padding: 10px 20px;">
                            ${bpIcon("plus",14)} Add Application
                        </button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function saveApplication() {
            const title = document.getElementById('appTitle').value.trim();
            const company = document.getElementById('appCompany').value.trim();
            
            if (!title || !company) {
                showToast('Please enter job title and company.', 'warning');
                return;
            }
            
            const newApp = {
                id: Date.now(),
                title: title,
                company: company,
                appliedDate: document.getElementById('appDate').value,
                status: document.getElementById('appStatus').value,
                salary: document.getElementById('appSalary').value.trim(),
                matchScore: document.getElementById('appMatch').value ? parseInt(document.getElementById('appMatch').value) : null,
                url: document.getElementById('appUrl').value.trim(),
                nextFollowUp: document.getElementById('appFollowUp').value || null,
                notes: document.getElementById('appNotes').value.trim()
            };
            
            if (!userData.applications) userData.applications = [];
            userData.applications.unshift(newApp);
            
            saveUserData();
            closeExportModal();
            renderApplications();
            
            showToast('Application added.', 'success');
        }
        
        function updateApplicationStatus(idx) {
            const app = userData.applications[idx];
            const newStatus = prompt(`Update status for "${app.title}":\n\n1 = Applied\n2 = Interviewing\n3 = Offer\n4 = Closed\n\nEnter number:`, 
                                     app.status === 'applied' ? '1' : app.status === 'interviewing' ? '2' : app.status === 'offer' ? '3' : '4');
            
            if (newStatus) {
                const statusMap = {'1': 'applied', '2': 'interviewing', '3': 'offer', '4': 'rejected'};
                userData.applications[idx].status = statusMap[newStatus] || app.status;
                saveUserData();
                renderApplications();
            }
        }
        
        function editApplication(idx) {
            const app = userData.applications[idx];
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Edit Application</h2>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <label class="settings-label">Job Title</label>
                            <input type="text" id="editAppTitle" value="${app.title}" class="settings-input">
                        </div>
                        
                        <div>
                            <label class="settings-label">Company</label>
                            <input type="text" id="editAppCompany" value="${app.company}" class="settings-input">
                        </div>
                        
                        <div>
                            <label class="settings-label">Status</label>
                            <select id="editAppStatus" class="settings-select">
                                <option value="applied" ${app.status === 'applied' ? 'selected' : ''}>Applied</option>
                                <option value="interviewing" ${app.status === 'interviewing' ? 'selected' : ''}>Interviewing</option>
                                <option value="offer" ${app.status === 'offer' ? 'selected' : ''}>Offer Received</option>
                                <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Closed</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="settings-label">Follow-Up Date</label>
                            <input type="date" id="editAppFollowUp" value="${app.nextFollowUp || ''}" class="settings-input">
                        </div>
                        
                        <div>
                            <label class="settings-label">Notes</label>
                            <textarea id="editAppNotes" class="purpose-editor" style="min-height: 80px;">${app.notes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                        <button class="action-btn" onclick="closeExportModal()">Cancel</button>
                        <button class="export-btn-large" onclick="saveApplicationEdit(${idx})">${bpIcon("save",14)} Save Changes</button>
                    </div>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function saveApplicationEdit(idx) {
            userData.applications[idx].title = document.getElementById('editAppTitle').value;
            userData.applications[idx].company = document.getElementById('editAppCompany').value;
            userData.applications[idx].status = document.getElementById('editAppStatus').value;
            userData.applications[idx].nextFollowUp = document.getElementById('editAppFollowUp').value || null;
            userData.applications[idx].notes = document.getElementById('editAppNotes').value.trim();
            
            saveUserData();
            closeExportModal();
            renderApplications();
        }
        
        function deleteApplication(idx) {
            const app = userData.applications[idx];
            if (confirm(`Remove "${app.title}" at ${app.company} from tracker?`)) {
                userData.applications.splice(idx, 1);
                saveUserData();
                renderApplications();
            }
        }
        
        // ===== CONSENT & SHARING SYSTEM =====
        
        let sharePresets = {
            'full': { name: 'Full Transparency', skills: 'all', outcomes: 'all', values: 'all', purpose: true },
            'executive': { name: 'Executive Brief', skills: 'top20', outcomes: 'all', values: 'all', purpose: true },
            'advisory': { name: 'Advisory Pitch', skills: 'strategic', outcomes: 'strategic', values: 'all', purpose: true },
            'board': { name: 'Board Candidate', skills: 'leadership', outcomes: 'business', values: 'selected', purpose: true },
            'custom': { name: 'Custom', skills: 'selected', outcomes: 'selected', values: 'selected', purpose: true }
        };
        
        let currentPreset = 'custom';
        
        function initConsent() {
            const view = document.getElementById('consentView');
            
            view.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-header">
                        <h1 class="blueprint-title">Consent & Sharing</h1>
                        <p class="blueprint-subtitle">Your Data, Your Control</p>
                        <p class="blueprint-tagline">Choose exactly what you share and with whom</p>
                    </div>
                    
                    ${renderSharePresets()}
                    ${renderSharingStatus()}
                    ${renderLegalSection()}
                </div>
            `;
        }
        
        function renderSharePresets() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">${bpIcon("preferences",18)}</span>
                            <span>Share Profile Presets</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ${bpIcon('lightbulb',14)} CHOOSE YOUR SHARING LEVEL
                        </div>
                        <div class="coaching-tip-content">
                            Select a preset that matches your audience, or use Custom to choose exactly what to share.
                            All presets respect your individual item toggles from the Blueprint.
                        </div>
                    </div>
                    
                    <div class="values-grid">
                        ${Object.entries(sharePresets).map(([key, preset]) => renderPresetCard(key, preset)).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderPresetCard(key, preset) {
            const selectedClass = currentPreset === key ? 'selected' : '';
            var skillCount = (skillsData.skills || []).length;
            var keyCount = skillsData.skills.filter(function(s) { return s.key; }).length;
            const descriptions = {
                'full': 'Share everything: all ' + skillCount + ' skills, outcomes, values, and purpose',
                'executive': 'Top ' + Math.min(20, skillCount) + ' skills + all outcomes and values, ideal for executive search',
                'advisory': keyCount + ' strategic skills + relevant outcomes, for advisory and consulting',
                'board': 'Leadership and business outcomes + governance experience, for board positions',
                'custom': 'You choose exactly which skills, outcomes, and values to share'
            };
            
            return `
                <div class="value-card ${selectedClass}" onclick="selectPreset('${key}')">
                    <div class="value-title">${preset.name}</div>
                    <div class="value-description">${descriptions[key]}</div>
                </div>
            `;
        }
        
        function renderSharingStatus() {
            var skillCount = (skillsData.skills || []).length;
            var sharedSkills = currentPreset === 'full' ? skillCount : 
                                currentPreset === 'executive' ? Math.min(20, skillCount) :
                                currentPreset === 'advisory' ? skillsData.skills.filter(function(s) { return s.key; }).length :
                                currentPreset === 'board' ? skillsData.skills.filter(function(s) { return s.key || s.level === 'Mastery'; }).length :
                                skillCount;
            var sharedOutcomes = blueprintData.outcomes.filter(o => o.shared).length;
            var sharedValues = blueprintData.values.filter(v => v.selected).length;
            
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">${bpIcon('bar-chart',18)}</span>
                            <span>What You're Sharing</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #60a5fa; font-weight: bold;">${sharedSkills}</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Skills</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #10b981; font-weight: bold;">${sharedOutcomes}</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Outcomes</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #fbbf24; font-weight: bold;">${sharedValues}</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Values</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #a78bfa; font-weight: bold;">✓</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Purpose</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
                        <strong style="color: #fbbf24;">Note:</strong> 
                        <span style="color: #d1d5db;">Sensitive content (recovery, personal loss) is flagged in Blueprint. Review before sharing.</span>
                    </div>
                </div>
            `;
        }
        
        function renderLegalSection() {
            var tc = tv('#d1d5db','#334155');
            var hc = tv('#60a5fa','#1e40af');
            var sc = tv('#9ca3af','#64748b');
            var bgCard = tv('rgba(255,255,255,0.03)','rgba(0,0,0,0.02)');
            var borderWarn = tv('rgba(251,191,36,0.3)','rgba(217,119,6,0.2)');
            
            return '<div id="disclaimerSection" class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('warning',20) + '</span>'
                + '<span>Disclaimer & Terms of Use</span>'
                + '</div>'
                + '</div>'
                
                // Prominent disclaimer banner
                + '<div style="padding:20px; background:' + tv('rgba(251,191,36,0.08)','rgba(251,191,36,0.06)') + '; '
                + 'border:1px solid ' + borderWarn + '; border-radius:10px; margin-bottom:24px;">'
                + '<p style="color:' + tc + '; line-height:1.7; margin:0; font-size:0.95em;">'
                + '<strong style="color:' + tv('#fbbf24','#d97706') + ';">Blueprint is a personal demonstration project provided as-is for educational and illustrative purposes only.</strong> '
                + 'It is not a commercial product and carries no warranty of any kind, express or implied.'
                + '</p>'
                + '</div>'
                
                + '<div style="color:' + tc + '; line-height:1.7; font-size:0.93em;">'

                // Data accuracy
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Data Accuracy</h4>'
                + '<p style="margin:0;">Skill taxonomies, market valuations, compensation estimates, and any generated content may contain errors, omissions, or outdated information. '
                + 'ESCO, O*NET, and other referenced datasets are used under their respective licenses and may not reflect current labor market conditions. '
                + 'No figure produced by this tool should be treated as a verified market rate or guaranteed outcome.</p>'
                + '</div>'

                // Not professional advice
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Not Professional Advice</h4>'
                + '<p style="margin:0;">Nothing in this application constitutes legal, financial, career, compensation, or employment advice. '
                + 'Users should consult qualified professionals before making decisions based on any information presented here.</p>'
                + '</div>'

                // No liability
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">No Liability</h4>'
                + '<p style="margin:0;">The creator of this tool accepts no responsibility for decisions made, opportunities pursued or declined, '
                + 'salary negotiations conducted, or any other action taken based on information generated by this application.</p>'
                + '</div>'

                // Local data only
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Local Data Only</h4>'
                + '<p style="margin:0;">All user data is stored in your browser\u2019s local storage. No data is transmitted to or stored on any server. '
                + 'Clearing your browser data will permanently delete your profile. The creator has no access to your data.</p>'
                + '</div>'

                // Third-party AI
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Third-Party AI</h4>'
                + '<p style="margin:0;">The onboarding wizard uses the Anthropic API to parse resumes and infer skills. '
                + 'Resume text submitted during onboarding is sent to Anthropic\u2019s servers and is subject to '
                + '<a href="https://www.anthropic.com/policies" target="_blank" rel="noopener" style="color:' + hc + '; text-decoration:underline;">Anthropic\u2019s usage policies</a>. '
                + 'No resume data is stored by this application after processing.</p>'
                + '</div>'

                // Demo profiles
                + '<div style="padding:16px; background:' + bgCard + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + hc + '; margin:0 0 8px 0;">Demonstration Profiles</h4>'
                + '<p style="margin:0;">Pre-loaded demo profiles represent real professional histories and are included with the profile owner\u2019s consent. '
                + 'Do not redistribute demo profile data.</p>'
                + '</div>'

                // Use at your own risk
                + '<div style="padding:16px; background:' + tv('rgba(239,68,68,0.06)','rgba(239,68,68,0.04)') + '; '
                + 'border:1px solid ' + tv('rgba(239,68,68,0.2)','rgba(239,68,68,0.15)') + '; border-radius:8px; margin-bottom:12px;">'
                + '<h4 style="color:' + tv('#f87171','#dc2626') + '; margin:0 0 8px 0;">Use at Your Own Risk</h4>'
                + '<p style="margin:0;">By using this tool, you acknowledge these limitations and accept full responsibility for how you apply its outputs.</p>'
                + '</div>'

                + '</div>'
                + '</div>'

                // Existing privacy section below disclaimer
                + '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('scale',20) + '</span>'
                + '<span>Privacy & Data Rights</span>'
                + '</div>'
                + '</div>'
                + '<div style="color:' + tc + '; line-height:1.7;">'
                + '<p style="margin-bottom:20px;">When signed in, your Blueprint data is stored securely in Firebase (Google Cloud). When not signed in, data persists locally in your browser. You have complete control over what you share, '
                + 'when you share it, and with whom.</p>'

                + '<h4 style="color:' + hc + '; margin-bottom:10px;">Relevant Privacy Laws:</h4>'
                + '<div style="padding:10px; background:' + bgCard + '; margin-bottom:8px; border-radius:6px;">'
                + '<strong>\uD83C\uDDFA\uD83C\uDDF8 CCPA (California Consumer Privacy Act)</strong><br>'
                + '<span style="font-size:0.9em; color:' + sc + ';">Right to know what data is collected, right to delete, right to opt-out of sale</span><br>'
                + '<a href="https://oag.ca.gov/privacy/ccpa" target="_blank" style="color:' + hc + '; text-decoration:none; font-size:0.85em;">Learn more \u2192</a>'
                + '</div>'
                + '<div style="padding:10px; background:' + bgCard + '; margin-bottom:8px; border-radius:6px;">'
                + '<strong>\uD83C\uDDEA\uD83C\uDDFA GDPR (General Data Protection Regulation)</strong><br>'
                + '<span style="font-size:0.9em; color:' + sc + ';">Right to access, rectify, erase, and port your personal data</span><br>'
                + '<a href="https://gdpr.eu/" target="_blank" style="color:' + hc + '; text-decoration:none; font-size:0.85em;">Learn more \u2192</a>'
                + '</div>'
                + '<div style="padding:10px; background:' + bgCard + '; margin-bottom:8px; border-radius:6px;">'
                + '<strong>\uD83D\uDCCB Employment Data Rights (US)</strong><br>'
                + '<span style="font-size:0.9em; color:' + sc + ';">Employers must handle your data fairly and cannot discriminate based on protected characteristics</span><br>'
                + '<a href="https://www.eeoc.gov/" target="_blank" style="color:' + hc + '; text-decoration:none; font-size:0.85em;">EEOC Guidelines \u2192</a>'
                + '</div>'

                + '<h4 style="color:' + hc + '; margin:25px 0 10px 0;">Best Practices:</h4>'
                + '<div style="color:' + tc + '; line-height:2;">'
                + '\u2022 Never share sensitive personal information (SSN, financial details)<br>'
                + '\u2022 Review what you are sharing before exporting<br>'
                + '\u2022 Keep Blueprint data up to date but do not embellish<br>'
                + '\u2022 Consider context before sharing recovery or advocacy work'
                + '</div>'
                + '</div>'
                + '</div>'

                // GDPR Data Rights section
                + '<div class="blueprint-section">'
                + '<div class="blueprint-section-header">'
                + '<div class="blueprint-section-title">'
                + '<span class="section-icon">' + bpIcon('lock',20) + '</span>'
                + '<span>Your Data Rights</span>'
                + '</div>'
                + '</div>'
                + '<div style="color:' + tv('#d1d5db','#334155') + '; line-height:1.7; font-size:0.93em;">'
                + '<p style="margin-bottom:16px;">Under GDPR and similar privacy regulations, you have the right to access, export, and delete your personal data at any time. '
                + 'Use the controls below to exercise these rights.</p>'
                + '<div style="display:flex; gap:12px; flex-wrap:wrap;">'
                + '<button onclick="viewMyData()" style="'
                + 'background:' + tv('rgba(96,165,250,0.12)','rgba(30,64,175,0.08)') + '; '
                + 'border:1px solid ' + tv('rgba(96,165,250,0.3)','rgba(30,64,175,0.2)') + '; '
                + 'color:' + tv('#60a5fa','#1e40af') + '; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;'
                + '">\uD83D\uDCC4 View My Stored Data</button>'
                + '<button onclick="exportMyData()" style="'
                + 'background:' + tv('rgba(16,185,129,0.12)','rgba(5,150,105,0.08)') + '; '
                + 'border:1px solid ' + tv('rgba(16,185,129,0.3)','rgba(5,150,105,0.2)') + '; '
                + 'color:' + tv('#10b981','#059669') + '; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;'
                + '">\uD83D\uDCE5 Export My Data (JSON)</button>'
                + '<button onclick="requestDataDeletion()" style="'
                + 'background:' + tv('rgba(239,68,68,0.08)','rgba(220,38,38,0.05)') + '; '
                + 'border:1px solid ' + tv('rgba(239,68,68,0.3)','rgba(220,38,38,0.2)') + '; '
                + 'color:' + tv('#ef4444','#dc2626') + '; padding:12px 20px; border-radius:8px; cursor:pointer; font-weight:600; font-size:0.9em;'
                + '">\uD83D\uDDD1 Delete All My Data</button>'
                + '</div>'
                + '<div style="margin-top:12px; font-size:0.82em; color:' + tv('#6b7280','#9ca3af') + ';">'
                + 'You must be signed in to use these features. Data deletion is permanent and cannot be undone.'
                + '</div>'
                + '</div></div>';
        }
        
        function handleProfilePhoto(input) {
            var file = input.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) { showToast('Image must be under 2MB.', 'warning'); return; }
            
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    // Resize to 128x128
                    var canvas = document.createElement('canvas');
                    canvas.width = 128; canvas.height = 128;
                    var ctx = canvas.getContext('2d');
                    var size = Math.min(img.width, img.height);
                    var sx = (img.width - size) / 2;
                    var sy = (img.height - size) / 2;
                    ctx.drawImage(img, sx, sy, size, size, 0, 0, 128, 128);
                    var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    
                    userData.profile.photo = dataUrl;
                    // Update preview
                    var preview = document.getElementById('settingPhotoPreview');
                    if (preview) preview.innerHTML = '<img src="' + dataUrl + '" alt="Profile photo" style="width:100%;height:100%;object-fit:cover;">';
                    // Update header chip
                    var avatar = document.getElementById('profileAvatar');
                    if (avatar) { avatar.innerHTML = '<img src="' + dataUrl + '" alt="Profile photo" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">'; }
                    saveUserData();
                    showToast('Profile photo updated.', 'success');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        window.handleProfilePhoto = handleProfilePhoto;
        
        function removeProfilePhoto() {
            delete userData.profile.photo;
            var avatar = document.getElementById('profileAvatar');
            if (avatar) avatar.textContent = (userData.profile.name || 'U').split(' ').map(function(w){ return w[0]; }).join('').slice(0,2).toUpperCase();
            saveUserData();
            // Re-render settings
            window.settingsInitialized = false;
            initSettings();
            window.settingsInitialized = true;
        }
        window.removeProfilePhoto = removeProfilePhoto;

        function saveSettings() {
            if (readOnlyGuard()) return;
            // Get values from form
            userData.profile.name = document.getElementById('settingName').value;
            userData.profile.email = document.getElementById('settingEmail').value;
            userData.profile.phone = document.getElementById('settingPhone') ? document.getElementById('settingPhone').value : '';
            userData.profile.linkedinUrl = document.getElementById('settingLinkedIn') ? document.getElementById('settingLinkedIn').value : '';
            userData.profile.location = document.getElementById('settingLocation').value;
            
            const newSeniority = document.getElementById('settingSeniority').value;
            userData.preferences.seniorityLevel = newSeniority;
            userData.preferences.minimumMatchScore = parseInt(document.querySelector('#settingsView .match-slider').value);
            userData.preferences.minimumSkillMatches = parseInt(document.getElementById('settingMinSkills').value);
            const minSalaryInput = document.getElementById('settingMinSalary').value;
            userData.preferences.minSalary = minSalaryInput ? parseInt(minSalaryInput) : null;
            
            // Update seniority keywords based on level
            if (newSeniority === 'Entry') {
                userData.preferences.seniorityKeywords = ['junior', 'associate', 'entry', 'coordinator'];
                userData.preferences.excludeRoles = ['senior', 'lead', 'manager', 'director', 'vp', 'chief', 'principal'];
            } else if (newSeniority === 'Mid') {
                userData.preferences.seniorityKeywords = ['senior', 'lead', 'manager', 'specialist'];
                userData.preferences.excludeRoles = ['junior', 'entry', 'associate', 'intern'];
            } else if (newSeniority === 'Senior') {
                userData.preferences.seniorityKeywords = ['senior manager', 'director', 'senior director', 'principal'];
                userData.preferences.excludeRoles = ['junior', 'entry', 'mid-level', 'associate'];
            } else { // Executive
                userData.preferences.seniorityKeywords = ['vp', 'vice president', 'chief', 'head of', 'director', 'principal', 'senior director'];
                userData.preferences.excludeRoles = ['engineer', 'developer', 'designer', 'analyst', 'coordinator', 'specialist', 
                                                    'junior', 'mid-level', 'associate', 'intern', 'entry'];
            }
            
            // Update profile chip with new name
            if (userData.profile.name) {
                updateProfileChip(userData.profile.name);
            }
            
            // Save to localStorage
            saveUserData();
            
            showToast('Settings saved. Go to Opportunities and click Find Matching Jobs to see updated results.', 'success', 5000);
        }
        window.saveSettings = saveSettings;
        
        function selectPreset(key) {
            currentPreset = key;
            
            // Apply preset logic to outcomes and values sharing flags
            if (key === 'full') {
                blueprintData.outcomes.forEach(function(o) { o.shared = true; });
                blueprintData.values.forEach(function(v) { v.selected = true; });
            } else if (key === 'executive') {
                blueprintData.outcomes.forEach(function(o) { o.shared = true; });
                blueprintData.values.forEach(function(v) { v.selected = true; });
            } else if (key === 'advisory') {
                blueprintData.outcomes.forEach(function(o) {
                    o.shared = (o.category === 'Strategic Foresight' || o.category === 'Thought Leadership' || o.category === 'Business Impact');
                });
                blueprintData.values.forEach(function(v) { v.selected = true; });
            } else if (key === 'board') {
                blueprintData.outcomes.forEach(function(o) {
                    o.shared = (o.category === 'Business Impact' || o.category === 'Crisis Leadership' || o.category === 'Entrepreneurial');
                });
                blueprintData.values.forEach(function(v) { v.selected = true; });
            }
            // 'custom' leaves everything as-is
            
            saveUserData();
            initConsent(); // Re-render to show selection
        }
        window.selectPreset = selectPreset;
        
        function filterSkillsView(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            
            if (currentSkillsView === 'network') {
                // Filter network nodes
                const svg = d3.select("#networkView");
                const nodes = svg.selectAll(".node");
                
                nodes.style("opacity", function(d) {
                    if (d.type !== "skill") return 1;  // Keep center and roles visible
                    if (!term) return 1;  // No search, show all
                    return d.name.toLowerCase().includes(term) ? 1 : 0.1;
                });
                
                // Also filter text labels
                const labels = svg.selectAll(".node-label");
                labels.style("opacity", function(d) {
                    if (d.type !== "skill") return 1;
                    if (!term) return 1;
                    return d.name.toLowerCase().includes(term) ? 1 : 0.1;
                });
                
            } else {
                // Filter card view - skill items within domain cards
                var domainCards = document.querySelectorAll('.domain-card');
                domainCards.forEach(function(card) {
                    var items = card.querySelectorAll('.skill-item');
                    var anyVisible = false;
                    items.forEach(function(item) {
                        var nameEl = item.querySelector('.skill-name');
                        var name = nameEl ? nameEl.textContent.toLowerCase() : '';
                        if (!term || name.includes(term)) {
                            item.style.display = '';
                            anyVisible = true;
                        } else {
                            item.style.display = 'none';
                        }
                    });
                    // Hide entire domain card if no skills match
                    card.style.display = anyVisible || !term ? '' : 'none';
                });
            }
        }
        
        function showValuationBreakdown() {
            const totalValue = calculateTotalMarketValue();
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Get all skills with their impact ratings
            const allSkillsWithImpact = skillsData.skills.map(skill => {
                const impact = getSkillImpact(skill);
                return {
                    name: skill.name,
                    level: skill.level,
                    category: skill.category,
                    impact: impact,
                    impactLevel: impact.level
                };
            });
            
            // Sort by impact level then alphabetically
            const impactOrder = { 'critical': 1, 'high': 2, 'moderate': 3, 'standard': 4, 'supplementary': 5 };
            allSkillsWithImpact.sort((a, b) => {
                const orderDiff = impactOrder[a.impactLevel] - impactOrder[b.impactLevel];
                if (orderDiff !== 0) return orderDiff;
                return a.name.localeCompare(b.name);
            });
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">All ${skillsData.skills.length} Skills</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Complete list with impact ratings</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                            <div>
                                <div style="color: #ef4444; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'critical').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">${bpIcon('flame',14)} Critical</div>
                            </div>
                            <div>
                                <div style="color: #f59e0b; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'high').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">${bpIcon('star',14)} High</div>
                            </div>
                            <div>
                                <div style="color: #3b82f6; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'moderate').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">${bpIcon('diamond',14)} Moderate</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'standard').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">${bpIcon('check',14)} Standard</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">All Skills (Sorted by Impact)</h3>
                        <div style="display: grid; gap: 8px; max-height: 500px; overflow-y: auto; padding-right: 10px;">
                            ${allSkillsWithImpact.map((skill, idx) => {
                                const impactColor = getImpactColor(skill.impactLevel);
                                const categoryBadge = skill.category === 'skill' ? 'SKILL' : 
                                                     skill.category === 'ability' ? 'ABILITY' : 
                                                     skill.category === 'workstyle' ? 'WORK STYLE' : 'UNIQUE';
                                return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 6px; border-left: 3px solid ${impactColor};">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="color: #e0e0e0; font-weight: 500;">${skill.name}</span>
                                            <span style="color: #6b7280; font-size: 0.75em; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">${categoryBadge}</span>
                                        </div>
                                        <div style="color: #9ca3af; font-size: 0.85em;">
                                            ${skill.level} • ${skill.impact.label}
                                        </div>
                                    </div>
                                    <div style="color: ${impactColor}; font-weight: 600; font-size: 1.2em; min-width: 40px; text-align: right;">
                                        ${skill.impact.icon}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Your Market Value</h3>
                        <div style="color: #d1d5db; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>Base Market Rate (${totalValue.percentile} percentile):</span>
                                <strong>$${totalValue.marketRate.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>Critical Skills Premium (${totalValue.criticalSkills.length} skills):</span>
                                <strong style="color: #10b981;">+$${totalValue.criticalBonus.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>High Impact Skills (${totalValue.highSkills.length} skills):</span>
                                <strong style="color: #10b981;">+$${totalValue.highBonus.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>Rare Combinations:</span>
                                <strong style="color: #10b981;">+$${totalValue.rarityBonus.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 1.2em; margin-top: 10px;">
                                <strong>Total Market Value:</strong>
                                <strong style="color: #10b981;">$${totalValue.total.toLocaleString()}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <button class="export-btn-large" onclick="closeExportModal()" style="width: 100%; background: rgba(96, 165, 250, 0.2); border-color: #60a5fa; color: #60a5fa;">
                        Close
                    </button>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function showNegotiationGuide() {
            const totalValue = calculateTotalMarketValue();
            const negotiationGap = totalValue.yourWorth - totalValue.standardOffer;
            
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">${bpIcon("briefcase",18)} Salary Negotiation Strategy</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Compa-ratio based negotiation guidance</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <div style="color: #10b981; font-weight: 600; margin-bottom: 10px;">Your Market Worth</div>
                        <div style="font-size: 2em; font-weight: 700; color: #e0e0e0;">
                            $${totalValue.yourWorth.toLocaleString()}/year
                        </div>
                        <div style="color: #9ca3af; margin-top: 8px;">
                            ${totalValue.roleLevel} • ${totalValue.compaRatio}% compa-ratio • ${userData.profile.location}
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">${bpIcon("bar-chart",14)} Understanding Compa-Ratios</h3>
                        <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.7;">
                            <strong>Compa-ratio</strong> = Your salary ÷ Market median × 100%
                            <br><br>
                            <strong>How Companies Use This:</strong>
                            <br>• <strong>80-120%</strong> = Acceptable range
                            <br>• <strong>100%</strong> = Exactly at market median
                            <br>• <strong>&lt;80%</strong> = Underpaid (flight risk)
                            <br>• <strong>&gt;120%</strong> = Overpaid for role
                            <br><br>
                            <strong>Market Rate (50th percentile):</strong> $${totalValue.marketRate.toLocaleString()}
                            <br><strong>Your Worth (with premiums):</strong> $${totalValue.yourWorth.toLocaleString()} (${totalValue.compaRatio}%)
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #fbbf24; margin-bottom: 15px;">${bpIcon("dollar",14)} Expected Offer Ranges</h3>
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">
                            Companies typically offer <strong>75-95%</strong> of your market worth. Here's what to expect:
                        </div>
                        
                        <div style="background: rgba(107, 114, 128, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #9ca3af;">
                            <div style="color: #9ca3af; font-weight: 600; margin-bottom: 5px;">Conservative Offer (75%)</div>
                            <div style="font-size: 1.3em; color: #e0e0e0; font-weight: 600;">
                                $${totalValue.conservativeOffer.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                                Budget-constrained companies • Startups • Non-profits
                            </div>
                        </div>
                        
                        <div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #60a5fa;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Standard Offer (85%) ← Most Common</div>
                            <div style="font-size: 1.3em; color: #e0e0e0; font-weight: 600;">
                                $${totalValue.standardOffer.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                                Typical initial offers • Room to negotiate up
                            </div>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #10b981;">
                            <div style="color: #10b981; font-weight: 600; margin-bottom: 5px;">Competitive Offer (95%)</div>
                            <div style="font-size: 1.3em; color: #e0e0e0; font-weight: 600;">
                                $${totalValue.competitiveOffer.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                                High-demand roles • Top-tier companies • Multiple offers
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: rgba(251, 191, 36, 0.2); border-radius: 8px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 5px;">${bpIcon('lightbulb',14)} Your Negotiation Gap</div>
                            <div style="color: #d1d5db; font-size: 0.95em;">
                                <strong>$${negotiationGap.toLocaleString()}</strong> between standard offer and your worth
                                <br>This is your leverage. Start at your worth ($${totalValue.yourWorth.toLocaleString()}) and negotiate down to competitive range ($${totalValue.competitiveOffer.toLocaleString()}+).
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(251, 191, 36, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid #fbbf24; margin-bottom: 25px;">
                        <h3 style="color: #fbbf24; margin-bottom: 15px;">${bpIcon('target',16)} Your Talking Points</h3>
                        <div style="color: #d1d5db; line-height: 1.8;">
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">1. Lead with Your Worth:</strong><br>
                                "Based on my skill profile and market analysis, my value is in the $${Math.round(totalValue.yourWorth * 0.95 / 1000) * 1000}-$${Math.round(totalValue.yourWorth * 1.05 / 1000) * 1000} range for ${totalValue.roleLevel} roles in ${userData.profile.location}."
                            </p>
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">2. Reference Your Top 10 Skills:</strong><br>
                                "I bring ${totalValue.top10Skills.filter(s => s.level === 'Mastery').length} mastery-level skills including ${totalValue.top10Skills.slice(0, 3).map(s => s.skill).join(', ')}. These command premiums in the current market."
                            </p>
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">3. Show the Data:</strong><br>
                                "The market rate for ${totalValue.roleLevel} is $${totalValue.marketRate.toLocaleString()}. My critical and high-impact skills justify a ${Math.round(((totalValue.yourWorth - totalValue.marketRate) / totalValue.marketRate) * 100)}% premium."
                            </p>
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">4. Use Your Outcomes:</strong><br>
                                "I've consistently delivered [cite 2-3 quantified outcomes from your Blueprint]. This track record supports my valuation."
                            </p>
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">${bpIcon("clipboard",14)} Negotiation Script</h3>
                        <div style="color: #d1d5db; line-height: 1.8; font-size: 0.95em;">
                            <strong>When they ask for salary expectations:</strong>
                            <br><br>
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px; margin: 10px 0; font-style: italic;">
                            "I appreciate you asking. Based on my research and skill profile, I'm looking at the $${Math.round(totalValue.competitiveOffer / 1000) * 1000}-$${Math.round(totalValue.yourWorth / 1000) * 1000} range. But I'm flexible depending on the total compensation package, including equity and benefits. What range were you considering?"
                            </div>
                            <br>
                            <strong>When they give a low offer ($${totalValue.conservativeOffer.toLocaleString()}):</strong>
                            <br><br>
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px; margin: 10px 0; font-style: italic;">
                            "I appreciate the offer. Based on market data for ${totalValue.roleLevel} roles with my skill set—particularly my ${totalValue.top10Skills[0].skill} expertise—the range is typically closer to $${totalValue.standardOffer.toLocaleString()}-$${totalValue.competitiveOffer.toLocaleString()}. Can we explore options in that range?"
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">✓ Best Practices</h3>
                        <div style="color: #d1d5db; line-height: 1.8;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #10b981;">DO:</strong>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    <li>Start at your worth ($${totalValue.yourWorth.toLocaleString()})</li>
                                    <li>Reference the $${negotiationGap.toLocaleString()} gap as your leverage</li>
                                    <li>Cite your top 10 skills as justification</li>
                                    <li>Ask about total comp (equity, bonus, benefits)</li>
                                    <li>Get offers in writing before negotiating</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: #ef4444;">DON'T:</strong>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    <li>Accept the first offer—they expect negotiation</li>
                                    <li>Give a range first—make them lead</li>
                                    <li>Focus only on base salary</li>
                                    <li>Negotiate without data</li>
                                    <li>Accept below $${totalValue.conservativeOffer.toLocaleString()} (75%)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <button class="export-btn-large" onclick="closeExportModal()" style="width: 100%; margin-top: 25px;">
                        Close Guide
                    </button>
                </div>
            `;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        // ===== IMPACT RATING ENGINE =====
        
        let impactRatings = null;
        
        async function loadImpactRatings() {
            try {
                const response = await fetch('onet-impact-ratings.json');
                impactRatings = await response.json();
                console.log('✓ Impact ratings loaded');
            } catch (e) {
                console.error('Error loading impact ratings:', e);
            }
        }
        
        // Load impact ratings on startup
        loadImpactRatings();
        
        function getSkillImpact(skill) {
            if (!impactRatings) {
                return { level: 'moderate', label: 'Moderate Impact', icon: bpIcon('diamond',14), rationale: 'Loading ratings...' };
            }
            
            // Handle unique skills (no O*NET match)
            if (skill.category === 'unique') {
                return getUniqueSkillImpact(skill);
            }
            
            // Get O*NET rating
            const category = skill.category; // 'skill', 'ability', 'workstyle'
            const categoryData = impactRatings[category + 's']; // 'skills', 'abilities', 'workstyles'
            
            if (!categoryData || !skill.onetId) {
                return { level: 'moderate', label: 'Moderate Impact', icon: bpIcon('diamond',14), rationale: 'No rating data available' };
            }
            
            const skillRating = categoryData[skill.onetId];
            if (!skillRating) {
                return { level: 'moderate', label: 'Moderate Impact', icon: bpIcon('diamond',14), rationale: 'Skill not found in ratings' };
            }
            
            // Apply proficiency multiplier
            const impactLevel = skillRating.proficiencyMultiplier[skill.level] || skillRating.baseImpact;
            
            return {
                level: impactLevel,
                label: getImpactLabel(impactLevel),
                icon: getImpactIcon(impactLevel),
                rationale: skillRating.rationale,
                executiveImportance: skillRating.executiveImportance,
                marketScarcity: skillRating.marketScarcity
            };
        }
        
        function getUniqueSkillImpact(skill) {
            // Check if user has assessed this skill
            if (skill.userAssessment) {
                return calculateUniqueSkillImpact(skill.userAssessment);
            }
            
            // Try to find comparable O*NET skill
            const comparable = findComparableSkill(skill.name);
            if (comparable) {
                return {
                    ...comparable,
                    rationale: `Estimated based on similar skills. Consider providing custom assessment for more accuracy.`,
                    needsAssessment: true
                };
            }
            
            // Default for unique skills without assessment
            return {
                level: 'high',
                label: 'High Impact',
                icon: '⭐',
                rationale: 'Unique differentiator. Provide assessment for accurate rating.',
                needsAssessment: true
            };
        }
        
        function findComparableSkill(skillName) {
            if (!impactRatings) return null;
            
            const name = skillName.toLowerCase();
            
            // Simple keyword matching to find comparable
            if (name.includes('ai') || name.includes('artificial intelligence')) {
                return getSkillImpact({ category: 'skill', onetId: 'systems-analysis', level: 'Mastery' });
            }
            if (name.includes('strategy')) {
                return getSkillImpact({ category: 'skill', onetId: 'complex-problem-solving', level: 'Mastery' });
            }
            if (name.includes('leadership')) {
                return getSkillImpact({ category: 'workstyle', onetId: 'leadership', level: 'Mastery' });
            }
            
            return null;
        }
        
        function calculateUniqueSkillImpact(assessment) {
            let score = 0;
            
            // Years experience (mastery indicator)
            if (assessment.years >= 10) score += 3;
            else if (assessment.years >= 5) score += 2;
            else score += 1;
            
            // Business impact
            if (assessment.impact === 'major') score += 3;
            else if (assessment.impact === 'significant') score += 2;
            else score += 1;
            
            // Scarcity
            if (assessment.rarity === 'rare') score += 3;
            else if (assessment.rarity === 'uncommon') score += 2;
            else score += 1;
            
            // Salary band
            if (assessment.salaryBand === '>$250k') score += 3;
            else if (assessment.salaryBand === '$150-250k') score += 2;
            else score += 1;
            
            // Total: 4-12
            let impactLevel;
            if (score >= 10) impactLevel = 'critical';
            else if (score >= 8) impactLevel = 'high';
            else if (score >= 6) impactLevel = 'moderate';
            else impactLevel = 'standard';
            
            return {
                level: impactLevel,
                label: getImpactLabel(impactLevel),
                icon: getImpactIcon(impactLevel),
                rationale: 'Based on your assessment',
                userAssessed: true
            };
        }
        
        function getImpactLabel(level) {
            const labels = {
                'critical': 'Critical Impact',
                'high': 'High Impact',
                'moderate': 'Moderate Impact',
                'standard': 'Standard',
                'supplementary': 'Supplementary'
            };
            return labels[level] || 'Moderate Impact';
        }
        
        function getImpactIcon(level) {
            var icons = {
                'critical': bpIcon('flame', 14),
                'high': bpIcon('star', 14),
                'moderate': bpIcon('diamond', 14),
                'standard': bpIcon('check', 14),
                'supplementary': bpIcon('check', 14)
            };
            return icons[level] || bpIcon('diamond', 14);
        }
        
        function getImpactColor(level) {
            const colors = {
                'critical': '#ef4444',
                'high': '#f59e0b',
                'moderate': '#3b82f6',
                'standard': '#6b7280',
                'supplementary': '#9ca3af'
            };
            return colors[level] || '#3b82f6';
        }
        
        // ===== SKILL MANAGEMENT FUNCTIONS =====
        
        let onetSelectedSkills = [];
        let currentONETTab = 'skills';
        let currentEditingSkill = null;
        
        function openONETPicker() {
            if (demoGate('O*NET Skill Explorer')) return;
            const modal = document.getElementById('onetPickerModal');
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            switchONETTab('skills');
            updateONETSelectedCount(); // Initialize count display
        }
        
        function closeONETPicker() {
            const modal = document.getElementById('onetPickerModal');
            modal.classList.remove('active');
            onetSelectedSkills = [];
        }
        
        window.switchONETTab = function switchONETTab(tab) {
            currentONETTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.onet-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('onetTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            // Load content
            renderONETLibrary();
        }
        
        function renderONETLibrary() {
            const container = document.getElementById('onetLibraryContent');
            const searchQuery = document.getElementById('onetSearchInput').value.toLowerCase();
            
            let html = '';
            let library, categoryKey;
            
            if (currentONETTab === 'skills') {
                library = window.onetSkillsLibrary;
                categoryKey = 'skill';
            } else if (currentONETTab === 'abilities') {
                library = window.onetAbilitiesLibrary;
                categoryKey = 'ability';
            } else if (currentONETTab === 'knowledge') {
                library = window.onetKnowledgeLibrary;
                categoryKey = 'knowledge';
            } else if (currentONETTab === 'activities') {
                library = window.onetWorkActivitiesLibrary;
                categoryKey = 'workactivity';
            } else {
                library = window.onetWorkStylesLibrary;
                categoryKey = 'workstyle';
            }
            
            if (!library) {
                container.innerHTML = `<div style="text-align:center;padding:40px;color:#9ca3af;">
                    Library not loaded.<br><small style="opacity:0.6">Make sure the JSON file is deployed to GitHub.</small>
                </div>`;
                return;
            }
            
            // Get user's existing skills of this category
            const existingSkillNames = userData.skills
                .filter(s => s.category === categoryKey)
                .map(s => s.name);
            
            // Knowledge and Work Activities: flat arrays grouped by onetGroup
            if (currentONETTab === 'knowledge' || currentONETTab === 'activities') {
                const items = currentONETTab === 'knowledge' ? library.knowledge : library.activities;
                const grouped = {};
                items.forEach(item => {
                    const grp = item.group || 'Other';
                    if (!grouped[grp]) grouped[grp] = [];
                    grouped[grp].push(item);
                });
                Object.entries(grouped).forEach(([groupName, groupItems]) => {
                    let groupHtml = '';
                    let hasResults = false;
                    groupItems.forEach(item => {
                        const isAdded = existingSkillNames.includes(item.name);
                        const isSelected = onetSelectedSkills.some(s => s.id === item.onetCode);
                        const matchesSearch = !searchQuery ||
                            item.name.toLowerCase().includes(searchQuery) ||
                            (item.description || '').toLowerCase().includes(searchQuery);
                        if (!matchesSearch) return;
                        hasResults = true;
                        // Normalize to expected shape
                        const normalized = {
                            id: item.onetCode,
                            name: item.name,
                            definition: item.description || '',
                            category: categoryKey
                        };
                        groupHtml += renderONETSkillItem(normalized, categoryKey, isAdded, isSelected);
                    });
                    if (hasResults) {
                        html += `<div class="onet-category">
                            <div class="onet-category-title">▼ ${groupName}</div>
                            ${groupHtml}
                        </div>`;
                    }
                });
            } else if (currentONETTab === 'workstyles') {
                // Work styles are a flat array
                const wsItems = library.workStyles || [];
                // Group by onetGroup if available
                const grouped = {};
                wsItems.forEach(item => {
                    const grp = item.group || item.onetGroup || 'Work Styles';
                    if (!grouped[grp]) grouped[grp] = [];
                    grouped[grp].push(item);
                });
                const isGrouped = Object.keys(grouped).length > 1;
                wsItems.forEach(item => {
                    const isAdded = existingSkillNames.includes(item.name);
                    const isSelected = onetSelectedSkills.some(s => s.id === (item.id || item.onetCode));
                    const matchesSearch = !searchQuery || 
                        item.name.toLowerCase().includes(searchQuery) ||
                        (item.definition || item.description || '').toLowerCase().includes(searchQuery);
                    
                    if (!matchesSearch) return;
                    
                    // Normalize
                    const normalized = {
                        id: item.id || item.onetCode,
                        name: item.name,
                        definition: item.definition || item.description || '',
                        category: categoryKey
                    };
                    html += renderONETSkillItem(normalized, categoryKey, isAdded, isSelected);
                });
            } else {
                // Skills and abilities have category/subcategory structure
                const categories = currentONETTab === 'skills' ? library.categories : library.categories;
                
                Object.entries(categories).forEach(([catId, category]) => {
                    let categoryHtml = '';
                    let categoryHasResults = false;
                    
                    if (category.subcategories) {
                        Object.entries(category.subcategories).forEach(([subId, subcategory]) => {
                            let subcategoryHtml = '';
                            let subcategoryHasResults = false;
                            
                            const items = currentONETTab === 'skills' ? subcategory.skills : subcategory.abilities;
                            if (!items) return;
                            
                            items.forEach(item => {
                                const isAdded = existingSkillNames.includes(item.name);
                                const isSelected = onetSelectedSkills.some(s => s.id === item.id);
                                const matchesSearch = !searchQuery || 
                                    item.name.toLowerCase().includes(searchQuery) ||
                                    item.definition.toLowerCase().includes(searchQuery);
                                
                                if (!matchesSearch) return;
                                
                                subcategoryHtml += renderONETSkillItem(item, categoryKey, isAdded, isSelected);
                                subcategoryHasResults = true;
                                categoryHasResults = true;
                            });
                            
                            if (subcategoryHasResults) {
                                categoryHtml += `
                                    <div class="onet-subcategory">
                                        <div class="onet-subcategory-title">${subcategory.name}</div>
                                        ${subcategoryHtml}
                                    </div>
                                `;
                            }
                        });
                    }
                    
                    if (categoryHasResults) {
                        html += `
                            <div class="onet-category">
                                <div class="onet-category-title">▼ ${category.name}</div>
                                ${categoryHtml}
                            </div>
                        `;
                    }
                });
            }
            
            if (!html) {
                html = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No results found</div>';
            }
            
            container.innerHTML = html;
            updateONETSelectedCount();
        }
        
        function renderONETSkillItem(item, category, isAdded, isSelected) {
            const disabled = isAdded ? 'disabled' : '';
            const selectedClass = isSelected ? 'selected' : '';
            
            return `
                <div class="onet-skill-item ${disabled} ${selectedClass}" 
                     onclick="${isAdded ? '' : `toggleONETSkillSelection('${item.id}', '${item.name}', '${category}')`}">
                    <input type="checkbox" 
                           class="onet-skill-checkbox" 
                           ${isSelected ? 'checked' : ''}
                           ${isAdded ? 'disabled' : ''}
                           onclick="event.stopPropagation();">
                    <div class="onet-skill-content">
                        <div class="onet-skill-name">
                            ${item.name}
                            ${isAdded ? '<span class="onet-skill-added">✓ Added</span>' : ''}
                        </div>
                        <div class="onet-skill-definition">${item.definition}</div>
                    </div>
                </div>
            `;
        }
        
        function toggleONETSkillSelection(id, name, category) {
            const index = onetSelectedSkills.findIndex(s => s.id === id);
            
            if (index === -1) {
                onetSelectedSkills.push({ id, name, category });
            } else {
                onetSelectedSkills.splice(index, 1);
            }
            
            renderONETLibrary();
            updateONETSelectedCount(); // FIX: Update count display
        }
        
        function updateONETSelectedCount() {
            const count = onetSelectedSkills.length;
            const countEl = document.getElementById('onetSelectedCount');
            const buttonEl = document.getElementById('onetAddButton');
            
            if (count === 0) {
                countEl.textContent = 'Select skills to add';
                buttonEl.disabled = true;
                buttonEl.style.opacity = '0.5';
            } else {
                countEl.textContent = `${count} skill${count > 1 ? 's' : ''} selected`;
                buttonEl.disabled = false;
                buttonEl.style.opacity = '1';
            }
        }
        
        function filterONETLibrary() {
            renderONETLibrary();
        }
        
        function addSelectedONETSkills() {
            if (onetSelectedSkills.length === 0) return;
            
            onetSelectedSkills.forEach(selectedSkill => {
                // Create skill object
                const newSkill = {
                    name: selectedSkill.name,
                    category: selectedSkill.category,
                    onetId: selectedSkill.id,
                    level: 'Advanced', // Default
                    roles: [userData.roles[0].id], // Default to first role
                    key: false
                };
                
                // Add to userData
                userData.skills.push(newSkill);
                skillsData.skills.push(newSkill);
            });
            
            // Save and refresh
            saveUserData();
            rescoreAllJobs();
            refreshAllViews();
            
            closeONETPicker();
            
            // Show success message
            showToast(`Added ${onetSelectedSkills.length} skill${onetSelectedSkills.length > 1 ? 's' : ''}.`, 'success');
        }
        
        function openCustomSkillBuilder() {
            if (demoGate('Custom Skill Builder')) return;
            const modal = document.getElementById('customSkillModal');
            
            // Populate roles checkboxes
            const rolesContainer = document.getElementById('customSkillRoles');
            rolesContainer.innerHTML = userData.roles.map(role => `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" value="${role.id}" class="custom-skill-role-checkbox">
                    <span>${role.name}</span>
                </label>
            `).join('');
            
            // Reset form
            document.getElementById('customSkillName').value = '';
            document.getElementById('customSkillCore').checked = false;
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function closeCustomSkillBuilder() {
            const modal = document.getElementById('customSkillModal');
            modal.classList.remove('active');
        }
        
        function createCustomSkill() {
            if (readOnlyGuard()) return;
            const name = document.getElementById('customSkillName').value.trim();
            const level = document.querySelector('input[name="customSkillLevel"]:checked').value;
            const core = document.getElementById('customSkillCore').checked;
            const roles = Array.from(document.querySelectorAll('.custom-skill-role-checkbox:checked')).map(cb => cb.value);
            
            // Validate
            if (!name) {
                showToast('Please enter a skill name.', 'warning');
                return;
            }
            
            if (roles.length === 0) {
                roles = (userData.roles || []).map(function(r) { return r.id; });
            }
            
            // Check for duplicates
            if (userData.skills.some(s => s.name === name)) {
                showToast('A skill with this name already exists.', 'warning');
                return;
            }
            
            // Create skill
            const newSkill = {
                name: name,
                category: 'unique',
                level: level,
                roles: roles,
                key: core
            };
            
            // Add to userData
            userData.skills.push(newSkill);
            skillsData.skills.push(newSkill);
            
            // Register in skill library index so future job parses can match it
            registerInSkillLibrary(name, 'unique');
            
            // Save, re-score jobs, refresh
            saveUserData();
            rescoreAllJobs();
            refreshAllViews();
            
            closeCustomSkillBuilder();
            
            showToast(`Created "${name}".`, 'success');
        }
        
        // ===== BULK SKILL IMPORT =====
        var _bulkParsedSkills = []; // Staged skills from parse step
        var _bulkCsvData = null;    // Raw CSV text from file upload
        
        function openBulkImport() {
            // Block in sample mode
            var isSample = window.isReadOnlyProfile || (window.currentProfileType && window.currentProfileType !== 'user');
            if (!isSample && typeof skillsData !== 'undefined' && skillsData.sample) isSample = true;
            if (isSample) { showToast('Bulk import is not available in sample/demo mode.', 'warning'); return; }

            var modal = document.getElementById('bulkImportModal');
            if (!modal) return;
            
            // Reset state
            _bulkParsedSkills = [];
            _bulkCsvData = null;
            document.getElementById('bulkSkillsText').value = '';
            document.getElementById('bulkCsvFile').value = '';
            document.getElementById('bulkCsvPreview').innerHTML = '';
            document.getElementById('bulkImportStep1').style.display = '';
            document.getElementById('bulkImportStep2').style.display = 'none';
            switchBulkTab('text');
            
            // Populate role checkboxes from current profile
            var rolesEl = document.getElementById('bulkImportRoles');
            rolesEl.innerHTML = (userData.roles || []).map(function(role) {
                return '<label style="display:flex; align-items:center; gap:8px; cursor:pointer;">'
                    + '<input type="checkbox" value="' + role.id + '" class="bulk-role-checkbox">'
                    + '<span style="font-size:0.9em;">' + role.name + '</span></label>';
            }).join('');
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.openBulkImport = openBulkImport;
        
        function closeBulkImport() {
            var modal = document.getElementById('bulkImportModal');
            if (modal) modal.classList.remove('active');
        }
        window.closeBulkImport = closeBulkImport;
        
        function switchBulkTab(tab) {
            document.getElementById('bulkTabText').className = 'onet-tab' + (tab === 'text' ? ' active' : '');
            document.getElementById('bulkTabCsv').className = 'onet-tab' + (tab === 'csv' ? ' active' : '');
            document.getElementById('bulkTextInput').style.display = tab === 'text' ? '' : 'none';
            document.getElementById('bulkCsvInput').style.display = tab === 'csv' ? '' : 'none';
        }
        window.switchBulkTab = switchBulkTab;
        
        function handleBulkCsvFile(input) {
            var file = input.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                _bulkCsvData = e.target.result;
                var lines = _bulkCsvData.split('\n').filter(function(l) { return l.trim(); });
                document.getElementById('bulkCsvPreview').innerHTML = '✓ Loaded ' + file.name + ' (' + lines.length + ' lines, ' + Math.round(file.size / 1024) + ' KB)';
            };
            reader.readAsText(file);
        }
        window.handleBulkCsvFile = handleBulkCsvFile;
        
        var VALID_LEVELS = ['Novice', 'Competent', 'Proficient', 'Advanced', 'Expert', 'Mastery'];
        var LEVEL_LOOKUP = {};
        VALID_LEVELS.forEach(function(l) { LEVEL_LOOKUP[l.toLowerCase()] = l; });
        
        function parseBulkSkills() {
            var defaultLevel = document.getElementById('bulkDefaultLevel').value;
            var roles = Array.from(document.querySelectorAll('.bulk-role-checkbox:checked')).map(function(cb) { return cb.value; });
            
            // If no roles checked, assign to all current roles
            if (roles.length === 0) {
                roles = (userData.roles || []).map(function(r) { return r.id; });
            }
            
            var rawItems = [];
            
            // Check which tab is active
            var csvActive = document.getElementById('bulkCsvInput').style.display !== 'none';
            
            if (csvActive && _bulkCsvData) {
                rawItems = parseCsvToItems(_bulkCsvData, defaultLevel);
            } else {
                var text = document.getElementById('bulkSkillsText').value.trim();
                if (!text) {
                    showToast('Paste some skills first.', 'warning');
                    return;
                }
                rawItems = parseTextToItems(text, defaultLevel);
            }
            
            if (rawItems.length === 0) {
                showToast('No valid skills found in input.', 'warning');
                return;
            }
            
            // Deduplicate within the import list itself
            var seen = {};
            var deduped = [];
            rawItems.forEach(function(item) {
                var key = item.name.toLowerCase();
                if (!seen[key]) {
                    seen[key] = true;
                    deduped.push(item);
                }
                // If dupe within import, keep higher level
                else {
                    var existing = deduped.find(function(d) { return d.name.toLowerCase() === key; });
                    if (existing && proficiencyValue(item.level) > proficiencyValue(existing.level)) {
                        existing.level = item.level;
                    }
                }
            });
            
            // Now compare against existing profile skills + synonyms
            var existingMap = {};
            (userData.skills || []).forEach(function(s) {
                existingMap[s.name.toLowerCase()] = s;
                var syns = getSkillSynonyms(s.name.toLowerCase());
                syns.forEach(function(syn) { existingMap[syn] = s; });
            });
            
            var mergeStrategy = document.getElementById('bulkMergeStrategy').value;
            
            _bulkParsedSkills = deduped.map(function(item) {
                var key = item.name.toLowerCase();
                var existingSkill = existingMap[key];
                
                // Also check synonyms of the import skill
                if (!existingSkill) {
                    var importSyns = getSkillSynonyms(key);
                    for (var i = 0; i < importSyns.length; i++) {
                        if (existingMap[importSyns[i]]) {
                            existingSkill = existingMap[importSyns[i]];
                            break;
                        }
                    }
                }
                
                var action = 'add';
                var conflict = null;
                
                if (existingSkill) {
                    conflict = existingSkill;
                    if (mergeStrategy === 'skip') {
                        action = 'skip';
                    } else if (mergeStrategy === 'higher') {
                        if (proficiencyValue(item.level) > proficiencyValue(existingSkill.level)) {
                            action = 'upgrade';
                        } else {
                            action = 'skip';
                        }
                    } else {
                        action = 'overwrite';
                    }
                }
                
                return {
                    name: item.name,
                    level: item.level,
                    category: item.category || 'unique',
                    core: item.core || false,
                    roles: roles,
                    action: action,
                    conflict: conflict
                };
            });
            
            renderBulkReview();
        }
        window.parseBulkSkills = parseBulkSkills;
        
        function parseTextToItems(text, defaultLevel) {
            var items = [];
            // Split by newlines first, then try commas if single line
            var lines = text.split(/\n/).map(function(l) { return l.trim(); }).filter(Boolean);
            
            // If only one line and it has commas but no level keywords, treat as comma-separated names
            if (lines.length === 1 && lines[0].indexOf(',') !== -1) {
                var parts = lines[0].split(',').map(function(p) { return p.trim(); }).filter(Boolean);
                // Check if any part looks like a level
                var hasLevels = parts.some(function(p) { return LEVEL_LOOKUP[p.toLowerCase()]; });
                if (!hasLevels) {
                    // All names, no levels
                    parts.forEach(function(name) {
                        if (name.length > 1 && name.length < 100) items.push({ name: titleCase(name), level: defaultLevel });
                    });
                    return items;
                }
            }
            
            lines.forEach(function(line) {
                // Strip bullet points, dashes, numbers at start
                line = line.replace(/^[\s\-\u2022\u2023\u25E6\u2043\*\d\.)\]]+\s*/, '').trim();
                if (!line || line.length < 2) return;
                
                // Try "Name, Level" or "Name - Level" format
                var match = line.match(/^(.+?)\s*[,\-\|]\s*(Novice|Competent|Proficient|Advanced|Expert|Mastery)\s*$/i);
                if (match) {
                    items.push({ name: titleCase(match[1].trim()), level: LEVEL_LOOKUP[match[2].toLowerCase()] || defaultLevel });
                } else {
                    // Just a name
                    items.push({ name: titleCase(line), level: defaultLevel });
                }
            });
            
            return items;
        }
        
        function parseCsvToItems(csvText, defaultLevel) {
            var items = [];
            var lines = csvText.split(/\r?\n/).filter(function(l) { return l.trim(); });
            if (lines.length < 2) return items; // Need header + at least 1 data row
            
            // Parse header
            var sep = lines[0].indexOf('\t') !== -1 ? '\t' : ',';
            var headers = lines[0].split(sep).map(function(h) { return h.trim().toLowerCase().replace(/['"]/g, ''); });
            
            var nameCol = headers.indexOf('name');
            if (nameCol === -1) nameCol = headers.indexOf('skill');
            if (nameCol === -1) nameCol = headers.indexOf('skill name');
            if (nameCol === -1) nameCol = 0; // Fallback to first column
            
            var levelCol = headers.indexOf('level');
            if (levelCol === -1) levelCol = headers.indexOf('proficiency');
            
            var catCol = headers.indexOf('category');
            if (catCol === -1) catCol = headers.indexOf('type');
            
            var coreCol = headers.indexOf('core');
            if (coreCol === -1) coreCol = headers.indexOf('key');
            if (coreCol === -1) coreCol = headers.indexOf('differentiator');
            
            // Parse rows
            for (var i = 1; i < lines.length; i++) {
                var cols = parseCsvLine(lines[i], sep);
                var name = (cols[nameCol] || '').trim();
                if (!name || name.length < 2) continue;
                
                var level = defaultLevel;
                if (levelCol !== -1 && cols[levelCol]) {
                    var parsed = LEVEL_LOOKUP[(cols[levelCol] || '').trim().toLowerCase()];
                    if (parsed) level = parsed;
                }
                
                var category = 'unique';
                if (catCol !== -1 && cols[catCol]) category = cols[catCol].trim().toLowerCase() || 'unique';
                
                var core = false;
                if (coreCol !== -1 && cols[coreCol]) {
                    var cv = cols[coreCol].trim().toLowerCase();
                    core = cv === 'true' || cv === 'yes' || cv === '1' || cv === 'x';
                }
                
                items.push({ name: titleCase(name), level: level, category: category, core: core });
            }
            
            return items;
        }
        
        // Simple CSV line parser (handles quoted fields with commas)
        function parseCsvLine(line, sep) {
            var result = [];
            var current = '';
            var inQuotes = false;
            for (var i = 0; i < line.length; i++) {
                var c = line[i];
                if (c === '"' || c === "'") {
                    inQuotes = !inQuotes;
                } else if (c === sep && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += c;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function titleCase(str) {
            // Capitalize first letter of each word, but keep acronyms uppercase
            return str.replace(/\b\w+/g, function(word) {
                if (word === word.toUpperCase() && word.length <= 5) return word; // Keep acronyms like ATS, CRM, SQL
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            });
        }
        
        function renderBulkReview() {
            document.getElementById('bulkImportStep1').style.display = 'none';
            document.getElementById('bulkImportStep2').style.display = '';
            
            var adding = _bulkParsedSkills.filter(function(s) { return s.action === 'add'; });
            var upgrading = _bulkParsedSkills.filter(function(s) { return s.action === 'upgrade'; });
            var overwriting = _bulkParsedSkills.filter(function(s) { return s.action === 'overwrite'; });
            var skipping = _bulkParsedSkills.filter(function(s) { return s.action === 'skip'; });
            
            var actionCount = adding.length + upgrading.length + overwriting.length;
            
            var summaryHtml = '<div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-bottom:16px;">'
                + '<div style="text-align:center; padding:12px; border-radius:8px; background:rgba(16,185,129,0.08); border:1px solid rgba(16,185,129,0.2);">'
                + '<div style="font-size:1.4em; font-weight:700; color:#10b981;">' + adding.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">New</div></div>'
                + '<div style="text-align:center; padding:12px; border-radius:8px; background:rgba(96,165,250,0.08); border:1px solid rgba(96,165,250,0.2);">'
                + '<div style="font-size:1.4em; font-weight:700; color:#60a5fa;">' + upgrading.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Upgrading</div></div>'
                + '<div style="text-align:center; padding:12px; border-radius:8px; background:rgba(251,191,36,0.08); border:1px solid rgba(251,191,36,0.2);">'
                + '<div style="font-size:1.4em; font-weight:700; color:#f59e0b;">' + overwriting.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Overwriting</div></div>'
                + '<div style="text-align:center; padding:12px; border-radius:8px; background:rgba(107,114,128,0.06); border:1px solid rgba(107,114,128,0.15);">'
                + '<div style="font-size:1.4em; font-weight:700; color:#6b7280;">' + skipping.length + '</div>'
                + '<div style="font-size:0.78em; color:var(--text-muted);">Skipped</div></div>'
                + '</div>';
            
            document.getElementById('bulkReviewSummary').innerHTML = summaryHtml;
            document.getElementById('bulkImportConfirmBtn').textContent = 'Import ' + actionCount + ' Skill' + (actionCount !== 1 ? 's' : '');
            document.getElementById('bulkImportConfirmBtn').disabled = actionCount === 0;
            document.getElementById('bulkImportConfirmBtn').style.opacity = actionCount === 0 ? '0.4' : '1';
            
            // Build review list
            var listHtml = '';
            
            _bulkParsedSkills.forEach(function(skill, idx) {
                var bg, icon, detail;
                if (skill.action === 'add') {
                    bg = 'rgba(16,185,129,0.06)'; icon = '✚'; detail = '<span style="color:#10b981;">New at ' + skill.level + '</span>';
                } else if (skill.action === 'upgrade') {
                    bg = 'rgba(96,165,250,0.06)'; icon = '⬆'; detail = '<span style="color:#60a5fa;">' + skill.conflict.level + ' → ' + skill.level + '</span>';
                } else if (skill.action === 'overwrite') {
                    bg = 'rgba(251,191,36,0.06)'; icon = '↻'; detail = '<span style="color:#f59e0b;">Replace ' + skill.conflict.level + ' with ' + skill.level + '</span>';
                } else {
                    bg = 'rgba(107,114,128,0.04)'; icon = '⊘';
                    var reason = skill.conflict ? 'Already exists as "' + skill.conflict.name + '" (' + skill.conflict.level + ')' : 'Duplicate';
                    detail = '<span style="color:#6b7280;">' + reason + '</span>';
                }
                
                listHtml += '<div style="display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:6px; background:' + bg + '; margin-bottom:4px;">'
                    + '<span style="font-size:1.1em; width:20px; text-align:center;">' + icon + '</span>'
                    + '<span style="flex:1; font-weight:500; font-size:0.9em; color:var(--text-primary);">' + skill.name + '</span>'
                    + '<span style="font-size:0.82em;">' + detail + '</span>'
                    + '<select data-bulk-idx="' + idx + '" onchange="updateBulkAction(this)" '
                    + 'style="padding:4px 8px; background:var(--bg-card); border:1px solid var(--border); border-radius:4px; color:var(--text-primary); font-size:0.78em;">'
                    + '<option value="add"' + (skill.action === 'add' ? ' selected' : '') + '>Add</option>'
                    + (skill.conflict ? '<option value="upgrade"' + (skill.action === 'upgrade' ? ' selected' : '') + '>Upgrade</option>' : '')
                    + (skill.conflict ? '<option value="overwrite"' + (skill.action === 'overwrite' ? ' selected' : '') + '>Overwrite</option>' : '')
                    + '<option value="skip"' + (skill.action === 'skip' ? ' selected' : '') + '>Skip</option>'
                    + '</select>'
                    + '</div>';
            });
            
            document.getElementById('bulkReviewList').innerHTML = listHtml;
        }
        
        function updateBulkAction(select) {
            var idx = parseInt(select.getAttribute('data-bulk-idx'));
            if (!isNaN(idx) && _bulkParsedSkills[idx]) {
                _bulkParsedSkills[idx].action = select.value;
                // Re-render summary counts
                var adding = _bulkParsedSkills.filter(function(s) { return s.action === 'add'; }).length;
                var upgrading = _bulkParsedSkills.filter(function(s) { return s.action === 'upgrade'; }).length;
                var overwriting = _bulkParsedSkills.filter(function(s) { return s.action === 'overwrite'; }).length;
                var actionCount = adding + upgrading + overwriting;
                document.getElementById('bulkImportConfirmBtn').textContent = 'Import ' + actionCount + ' Skill' + (actionCount !== 1 ? 's' : '');
                document.getElementById('bulkImportConfirmBtn').disabled = actionCount === 0;
                document.getElementById('bulkImportConfirmBtn').style.opacity = actionCount === 0 ? '0.4' : '1';
            }
        }
        window.updateBulkAction = updateBulkAction;
        
        function bulkImportBack() {
            document.getElementById('bulkImportStep1').style.display = '';
            document.getElementById('bulkImportStep2').style.display = 'none';
        }
        window.bulkImportBack = bulkImportBack;
        
        function toggleBulkProfileOptions() {
            var dest = document.querySelector('input[name="bulkDestination"]:checked');
            var opts = document.getElementById('bulkProfileOptions');
            if (dest && opts) {
                opts.style.display = dest.value === 'library' ? 'none' : '';
            }
        }
        window.toggleBulkProfileOptions = toggleBulkProfileOptions;
        
        function executeBulkImport() {
            var dest = document.querySelector('input[name="bulkDestination"]:checked');
            var libraryOnly = dest && dest.value === 'library';
            var added = 0, upgraded = 0, overwritten = 0, registered = 0;
            
            _bulkParsedSkills.forEach(function(item) {
                if (item.action === 'skip') return;
                
                // Always register in library
                registerInSkillLibrary(item.name, item.category || 'unique');
                registered++;
                
                if (libraryOnly) return; // Don't touch profile
                
                if (item.action === 'add') {
                    var newSkill = { name: item.name, category: item.category, level: item.level, roles: item.roles, key: item.core };
                    userData.skills.push(newSkill);
                    skillsData.skills.push(newSkill);
                    added++;
                } else if (item.action === 'upgrade' || item.action === 'overwrite') {
                    var existing = userData.skills.find(function(s) { return s.name.toLowerCase() === (item.conflict ? item.conflict.name.toLowerCase() : item.name.toLowerCase()); });
                    if (existing) {
                        existing.level = item.level;
                        if (item.action === 'overwrite') {
                            existing.key = item.core;
                        }
                        var sdIdx = skillsData.skills.findIndex(function(s) { return s.name === existing.name; });
                        if (sdIdx !== -1) skillsData.skills[sdIdx] = {...existing};
                        if (item.action === 'upgrade') upgraded++;
                        else overwritten++;
                    }
                }
            });
            
            // Save, rescore, refresh
            saveUserData();
            if (fbUser) saveToFirestore();
            rescoreAllJobs();
            refreshAllViews();
            
            closeBulkImport();
            
            var parts = [];
            if (libraryOnly) {
                parts.push(registered + ' added to library');
            } else {
                if (added) parts.push(added + ' added');
                if (upgraded) parts.push(upgraded + ' upgraded');
                if (overwritten) parts.push(overwritten + ' overwritten');
            }
            showToast('Bulk import: ' + parts.join(', ') + '.', 'success', 5000);
        }
        window.executeBulkImport = executeBulkImport;
        
        // ===== BULK SKILL MANAGER =====
        function openBulkManager() {
            // Block in sample mode
            var isSample = window.isReadOnlyProfile || (window.currentProfileType && window.currentProfileType !== 'user');
            if (!isSample && typeof skillsData !== 'undefined' && skillsData.sample) isSample = true;
            if (isSample) { showToast('Bulk edit is not available in sample/demo mode.', 'warning'); return; }

            var modal = document.getElementById('bulkSkillManagerModal');
            if (!modal) return;
            document.getElementById('bulkManagerSearch').value = '';
            document.getElementById('bulkManagerSelectAll').checked = false;
            renderBulkManagerList();
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.openBulkManager = openBulkManager;
        
        function closeBulkManager() {
            var modal = document.getElementById('bulkSkillManagerModal');
            if (modal) modal.classList.remove('active');
        }
        window.closeBulkManager = closeBulkManager;
        
        function renderBulkManagerList() {
            var search = (document.getElementById('bulkManagerSearch').value || '').toLowerCase();
            var skills = (userData.skills || []).slice().sort(function(a, b) { return a.name.localeCompare(b.name); });
            
            if (search) {
                skills = skills.filter(function(s) { return s.name.toLowerCase().indexOf(search) !== -1; });
            }
            
            document.getElementById('bulkManagerCount').textContent = skills.length + ' skill' + (skills.length !== 1 ? 's' : '');
            
            var levelColors = { Novice: '#6b7280', Competent: '#22d3ee', Proficient: '#10b981', Advanced: '#3b82f6', Expert: '#f59e0b', Mastery: '#ef4444' };
            
            var html = skills.map(function(skill) {
                var lc = levelColors[skill.level] || '#6b7280';
                var roleNames = (skill.roles || []).map(function(rid) {
                    var r = (userData.roles || []).find(function(role) { return role.id === rid; });
                    return r ? r.name : rid;
                }).join(', ') || 'All roles';
                
                return '<div class="bm-row" style="display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:6px; border-bottom:1px solid var(--border);">'
                    + '<input type="checkbox" class="bm-checkbox" value="' + skill.name.replace(/"/g, '&quot;') + '" onchange="updateBulkManagerSelection()">'
                    + '<span style="flex:1; font-size:0.9em; font-weight:500; color:var(--text-primary);">' + skill.name + '</span>'
                    + '<span style="font-size:0.75em; padding:3px 8px; border-radius:4px; background:' + lc + '22; color:' + lc + '; font-weight:600;">' + skill.level + '</span>'
                    + '<span style="font-size:0.75em; color:var(--text-muted); max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="' + roleNames + '">' + roleNames + '</span>'
                    + '</div>';
            }).join('');
            
            if (!html) html = '<div style="padding:20px; text-align:center; color:var(--text-muted);">No skills match your filter.</div>';
            
            document.getElementById('bulkManagerList').innerHTML = html;
            updateBulkManagerSelection();
        }
        
        function filterBulkManager() {
            renderBulkManagerList();
        }
        window.filterBulkManager = filterBulkManager;
        
        function toggleBulkManagerAll(checked) {
            var boxes = document.querySelectorAll('.bm-checkbox');
            boxes.forEach(function(cb) { cb.checked = checked; });
            updateBulkManagerSelection();
        }
        window.toggleBulkManagerAll = toggleBulkManagerAll;
        
        function updateBulkManagerSelection() {
            var checked = document.querySelectorAll('.bm-checkbox:checked');
            var bar = document.getElementById('bulkManagerActions');
            var label = document.getElementById('bulkManagerSelected');
            if (checked.length > 0) {
                bar.style.display = 'flex';
                label.textContent = checked.length + ' selected';
            } else {
                bar.style.display = 'none';
            }
        }
        window.updateBulkManagerSelection = updateBulkManagerSelection;
        
        function getSelectedBulkSkillNames() {
            return Array.from(document.querySelectorAll('.bm-checkbox:checked')).map(function(cb) { return cb.value; });
        }
        
        function bulkManagerSetLevel() {
            var names = getSelectedBulkSkillNames();
            if (names.length === 0) return;
            
            // Build a small inline picker
            var bar = document.getElementById('bulkManagerActions');
            var levels = ['Novice', 'Competent', 'Proficient', 'Advanced', 'Expert', 'Mastery'];
            var html = '<div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-top:8px;" id="bmLevelPicker">'
                + '<span style="font-size:0.82em; color:var(--text-muted);">Set ' + names.length + ' skill' + (names.length > 1 ? 's' : '') + ' to:</span>';
            levels.forEach(function(l) {
                html += '<button onclick="executeBulkSetLevel(\'' + l + '\')" style="padding:5px 12px; border-radius:5px; cursor:pointer; font-size:0.82em; font-weight:600; '
                    + 'background:rgba(139,92,246,0.1); color:#a78bfa; border:1px solid rgba(139,92,246,0.25);">' + l + '</button>';
            });
            html += '<button onclick="document.getElementById(\'bmLevelPicker\').remove();" style="padding:5px 10px; border:none; background:none; cursor:pointer; color:var(--text-muted); font-size:0.82em;">Cancel</button>';
            html += '</div>';
            
            // Remove existing picker if any
            var existing = document.getElementById('bmLevelPicker');
            if (existing) existing.remove();
            
            bar.insertAdjacentHTML('beforeend', html);
        }
        window.bulkManagerSetLevel = bulkManagerSetLevel;
        
        function executeBulkSetLevel(level) {
            var names = getSelectedBulkSkillNames();
            var count = 0;
            names.forEach(function(name) {
                var skill = userData.skills.find(function(s) { return s.name === name; });
                if (skill) {
                    skill.level = level;
                    var sdIdx = skillsData.skills.findIndex(function(s) { return s.name === name; });
                    if (sdIdx !== -1) skillsData.skills[sdIdx].level = level;
                    count++;
                }
            });
            
            saveUserData();
            if (fbUser) saveToFirestore();
            rescoreAllJobs();
            refreshAllViews();
            renderBulkManagerList();
            showToast('Set ' + count + ' skill' + (count !== 1 ? 's' : '') + ' to ' + level + '.', 'success');
        }
        window.executeBulkSetLevel = executeBulkSetLevel;
        
        function bulkManagerRemove() {
            var names = getSelectedBulkSkillNames();
            if (names.length === 0) return;
            if (!confirm('Remove ' + names.length + ' skill' + (names.length > 1 ? 's' : '') + ' from this profile?\n\nThis cannot be undone.')) return;
            
            var count = 0;
            names.forEach(function(name) {
                var idx = userData.skills.findIndex(function(s) { return s.name === name; });
                if (idx !== -1) { userData.skills.splice(idx, 1); count++; }
                var sdIdx = skillsData.skills.findIndex(function(s) { return s.name === name; });
                if (sdIdx !== -1) skillsData.skills.splice(sdIdx, 1);
            });
            
            saveUserData();
            if (fbUser) saveToFirestore();
            rescoreAllJobs();
            refreshAllViews();
            renderBulkManagerList();
            showToast('Removed ' + count + ' skill' + (count !== 1 ? 's' : '') + ' from profile.', 'info');
        }
        window.bulkManagerRemove = bulkManagerRemove;
        
        function openEditSkillModal(skillName, category) {
            const skill = userData.skills.find(s => s.name === skillName);
            if (!skill) return;
            
            currentEditingSkill = skillName;
            const modal = document.getElementById('editSkillModal');
            
            // Populate form
            document.getElementById('editSkillName').value = skill.name;
            var levelRadio = document.querySelector('input[name="editSkillLevel"][value="' + skill.level + '"]');
            if (levelRadio) levelRadio.checked = true;
            else {
                // Fallback: try to find closest match
                var fb = document.querySelector('input[name="editSkillLevel"][value="Proficient"]');
                if (fb) fb.checked = true;
            }
            document.getElementById('editSkillCore').checked = skill.key || false;
            
            // Populate roles
            const rolesContainer = document.getElementById('editSkillRoles');
            rolesContainer.innerHTML = userData.roles.map(role => `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" value="${role.id}" class="edit-skill-role-checkbox" ${skill.roles.includes(role.id) ? 'checked' : ''}>
                    <span>${role.name}</span>
                </label>
            `).join('');
            
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            
            // Populate evidence status (v4.16.1)
            var evStatus = document.getElementById('editSkillEvidenceStatus');
            if (evStatus && typeof getEvidenceSummary === 'function') {
                var evs = getEvidenceSummary(skill);
                var evColor = evs.hasGap ? tv('#fbbf24','#d97706') : tv('#10b981','#059669');
                var evBg = evs.hasGap ? tv('rgba(251,191,36,0.08)','rgba(251,191,36,0.05)') : tv('rgba(16,185,129,0.08)','rgba(16,185,129,0.05)');
                evStatus.innerHTML = '<div style="padding:10px 14px; background:' + evBg + '; border-radius:8px; font-size:0.82em;">'
                    + '<span style="color:' + evColor + '; font-weight:600;">' + evs.points + ' evidence pts \u2192 ' + evs.effectiveLevel + '</span>'
                    + '<span style="color:' + tv('#9ca3af','#64748b') + '; margin-left:8px;">(' + evs.evidenceCount + ' outcome' + (evs.evidenceCount !== 1 ? 's' : '') + ')</span>'
                    + (evs.verifiedCount > 0 ? ' <span style="color:#10b981;"> \u2713 ' + evs.verifiedCount + ' verified</span>' : '')
                    + '<br><button onclick="closeEditSkillModal(); setTimeout(function(){ var sk = (skillsData.skills||[]).find(function(s){return s.name===\'' + skillName.replace(/'/g,"\\'") + '\';}); if(sk) openSkillModal(\'' + skillName.replace(/'/g,"\\'") + '\', sk); }, 100);" '
                    + 'style="margin-top:6px; padding:3px 10px; background:transparent; border:1px solid ' + tv('rgba(16,185,129,0.3)','rgba(16,185,129,0.2)') + '; color:#10b981; border-radius:4px; cursor:pointer; font-size:0.88em;">+ Add Evidence</button>'
                    + '</div>';
            }
            updateEditSkillGapWarning();
        }
        
        function closeEditSkillModal() {
            const modal = document.getElementById('editSkillModal');
            modal.classList.remove('active');
            currentEditingSkill = null;
        }
        
        function updateEditSkillGapWarning() {
            var warning = document.getElementById('editSkillGapWarning');
            if (!warning || !currentEditingSkill) return;
            
            var skill = (skillsData.skills || []).find(function(s) { return s.name === currentEditingSkill; });
            if (!skill) return;
            
            var selectedLevel = (document.querySelector('input[name="editSkillLevel"]:checked') || {}).value || 'Novice';
            var evs = getEvidenceSummary(skill);
            var selectedVal = proficiencyValue(selectedLevel);
            var effectiveVal = proficiencyValue(evs.effectiveLevel);
            
            if (selectedVal > effectiveVal) {
                warning.innerHTML = '<div style="padding:8px 12px; background:' + tv('rgba(251,191,36,0.08)','rgba(251,191,36,0.05)') + '; '
                    + 'border:1px solid ' + tv('rgba(251,191,36,0.2)','rgba(251,191,36,0.12)') + '; border-radius:6px; font-size:0.82em; color:' + tv('#fbbf24','#d97706') + ';">'
                    + '\u26A0 Claiming <strong>' + selectedLevel + '</strong> but evidence supports <strong>' + evs.effectiveLevel + '</strong>. '
                    + 'Market valuation will use ' + evs.effectiveLevel + ' until more evidence is added.'
                    + '</div>';
            } else {
                warning.innerHTML = '';
            }
        }
        window.updateEditSkillGapWarning = updateEditSkillGapWarning;
        
        function deleteSkillFromProfile(skillName) {
            var idx = userData.skills.findIndex(function(s) { return s.name === skillName; });
            if (idx === -1) return;
            userData.skills.splice(idx, 1);
            var sdIdx = skillsData.skills.findIndex(function(s) { return s.name === skillName; });
            if (sdIdx !== -1) skillsData.skills.splice(sdIdx, 1);
            saveUserData();
            rescoreAllJobs();
            refreshAllViews();
            showToast('Removed "' + skillName + '" from profile.', 'info');
        }
        window.deleteSkillFromProfile = deleteSkillFromProfile;
        
        function saveSkillEdit() {
            if (!currentEditingSkill) return;
            
            const skill = userData.skills.find(s => s.name === currentEditingSkill);
            if (!skill) return;
            
            const level = document.querySelector('input[name="editSkillLevel"]:checked').value;
            const core = document.getElementById('editSkillCore').checked;
            var roles = Array.from(document.querySelectorAll('.edit-skill-role-checkbox:checked')).map(cb => cb.value);
            
            // Default to all roles if none selected
            if (roles.length === 0) {
                roles = (userData.roles || []).map(function(r) { return r.id; });
            }
            
            // Update skill
            skill.level = level;
            skill.key = core;
            skill.roles = roles;
            
            // Update skillsData too
            const skillDataIndex = skillsData.skills.findIndex(s => s.name === currentEditingSkill);
            if (skillDataIndex !== -1) {
                skillsData.skills[skillDataIndex] = {...skill};
            }
            
            // Save, re-score jobs, refresh
            saveUserData();
            rescoreAllJobs();
            refreshAllViews();
            
            var updatedName = currentEditingSkill;
            closeEditSkillModal();
            
            showToast('Updated "' + updatedName + '".', 'success');
        }
        
        function confirmDeleteSkill(skillName, category) {
            if (!confirm(`Delete "${skillName}"?\n\nThis cannot be undone.`)) {
                return;
            }
            
            deleteSkill(skillName);
        }
        
        function deleteSkill(skillName) {
            // Remove from userData
            const userIndex = userData.skills.findIndex(s => s.name === skillName);
            if (userIndex !== -1) {
                userData.skills.splice(userIndex, 1);
            }
            
            // Remove from skillsData
            const skillsIndex = skillsData.skills.findIndex(s => s.name === skillName);
            if (skillsIndex !== -1) {
                skillsData.skills.splice(skillsIndex, 1);
            }
            
            // Save, re-score, refresh
            saveUserData();
            rescoreAllJobs();
            refreshAllViews();
        }
        
        // ===== SKILL ASSESSMENT FUNCTIONS =====
        
        let currentAssessingSkill = null;
        
        function openAssessSkillModal(skillName) {
            const skill = userData.skills.find(s => s.name === skillName);
            if (!skill) return;
            
            currentAssessingSkill = skillName;
            const modal = document.getElementById('assessSkillModal');
            
            // Set skill name
            document.getElementById('assessSkillName').textContent = skill.name;
            
            // Pre-fill with existing assessment if available
            if (skill.userAssessment) {
                document.getElementById('assessYears').value = skill.userAssessment.years || 5;
                document.querySelector(`input[name="assessImpact"][value="${skill.userAssessment.impact}"]`).checked = true;
                document.querySelector(`input[name="assessRarity"][value="${skill.userAssessment.rarity}"]`).checked = true;
                document.querySelector(`input[name="assessSalary"][value="${skill.userAssessment.salaryBand}"]`).checked = true;
            } else {
                // Defaults
                document.getElementById('assessYears').value = 5;
                document.querySelector('input[name="assessImpact"][value="significant"]').checked = true;
                document.querySelector('input[name="assessRarity"][value="uncommon"]').checked = true;
                document.querySelector('input[name="assessSalary"][value="$150-250k"]').checked = true;
            }
            
            updateAssessmentPreview();
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            
            // Add listeners for live preview
            document.getElementById('assessYears').addEventListener('input', updateAssessmentPreview);
            document.querySelectorAll('input[name="assessImpact"]').forEach(r => 
                r.addEventListener('change', updateAssessmentPreview));
            document.querySelectorAll('input[name="assessRarity"]').forEach(r => 
                r.addEventListener('change', updateAssessmentPreview));
            document.querySelectorAll('input[name="assessSalary"]').forEach(r => 
                r.addEventListener('change', updateAssessmentPreview));
        }
        
        function closeAssessSkillModal() {
            const modal = document.getElementById('assessSkillModal');
            modal.classList.remove('active');
            currentAssessingSkill = null;
        }
        
        function updateAssessmentPreview() {
            const years = parseInt(document.getElementById('assessYears').value) || 0;
            const impact = document.querySelector('input[name="assessImpact"]:checked')?.value || 'significant';
            const rarity = document.querySelector('input[name="assessRarity"]:checked')?.value || 'uncommon';
            const salaryBand = document.querySelector('input[name="assessSalary"]:checked')?.value || '$150-250k';
            
            const assessment = { years, impact, rarity, salaryBand };
            const result = calculateUniqueSkillImpact(assessment);
            
            const preview = document.getElementById('assessmentPreview');
            const icon = getImpactIcon(result.level);
            const label = getImpactLabel(result.level);
            const color = getImpactColor(result.level);
            
            preview.innerHTML = `Predicted rating: <span style="color: ${color}; font-weight: 600;">${icon} ${label}</span>`;
        }
        
        function saveSkillAssessment() {
            if (readOnlyGuard()) return;
            if (!currentAssessingSkill) return;
            
            const skill = userData.skills.find(s => s.name === currentAssessingSkill);
            if (!skill) return;
            
            // Gather assessment data
            const years = parseInt(document.getElementById('assessYears').value) || 0;
            const impact = document.querySelector('input[name="assessImpact"]:checked')?.value || 'significant';
            const rarity = document.querySelector('input[name="assessRarity"]:checked')?.value || 'uncommon';
            const salaryBand = document.querySelector('input[name="assessSalary"]:checked')?.value || '$150-250k';
            
            // Save to skill object
            skill.userAssessment = {
                years: years,
                impact: impact,
                rarity: rarity,
                salaryBand: salaryBand,
                assessedDate: new Date().toISOString()
            };
            
            // Update skillsData too
            const skillDataIndex = skillsData.skills.findIndex(s => s.name === currentAssessingSkill);
            if (skillDataIndex !== -1) {
                skillsData.skills[skillDataIndex].userAssessment = skill.userAssessment;
            }
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            closeAssessSkillModal();
            
            const result = calculateUniqueSkillImpact(skill.userAssessment);
            showToast(`Assessment saved. "${currentAssessingSkill}" rated as ${result.label}.`, 'success');
        }
        
        function refreshAllViews() {
            // Refresh settings skill list
            const skillsList = document.getElementById('skillsList');
            if (skillsList) {
                skillsList.innerHTML = renderSkillsList();
            }
            
            // Refresh network graph
            if (currentView === 'network') {
                initNetwork();
            }
            
            // Refresh card view
            if (currentView === 'network' && currentSkillsView === 'cards') {
                renderCardView();
            }
            
            // Update stats bar
            updateStatsBar();
            
            // Re-render settings (to update counts)
            if (currentView === 'settings') {
                initSettings();
            }
        }
        
        // ===== SKILL SEARCH MODAL FUNCTIONS (v2.3.0) =====
        
        // ===== UNIFIED SKILL MANAGEMENT SYSTEM (v2.4.0) =====
        
        let currentSkillManagementTab = 'yours';

        function openSkillManagement() {
            if (demoGate('Skill Library')) return;
            const modal = document.getElementById('skillManagementModal');
            history.pushState({ modal: true }, ''); modal.classList.add('active');
            
            if (!skillLibraryIndex || !skillLibraryIndex.index) {
                loadSkillLibraryIndex();
            }
            
            populateCategoryFilter();
            updateSkillManagementCounts();
            switchSkillManagementTab('yours');
        }

        // Build category dropdown from actual skills in this profile — only show categories that exist
        window.populateCategoryFilter = function populateCategoryFilter() {
            const select = document.getElementById('yourSkillsCategoryFilter');
            if (!select) return;
            const currentVal = select.value;
            
            const categoryMeta = {
                'skill':         { label: 'Skills',           icon: bpIcon('compass',14) },
                'ability':       { label: 'Abilities',        icon: bpIcon('zap',14) },
                'workstyle':     { label: 'Work Styles',      icon: bpIcon('flag',14) },
                'knowledge':     { label: 'Knowledge',        icon: bpIcon('book',14) },
                'workactivity':  { label: 'Work Activities',  icon: bpIcon('settings',14) },
                'trades':        { label: 'Trade Skills',     icon: bpIcon('tool',14) },
                'unique':        { label: 'Custom Skills',    icon: '⭐' },
            };
            
            // Count skills by category
            const counts = {};
            userData.skills.forEach(s => {
                const cat = s.category || 'skill';
                counts[cat] = (counts[cat] || 0) + 1;
            });
            
            // Build options — only include categories that have skills
            let html = `<option value="all">All Categories (${userData.skills.length})</option>`;
            // Use preferred order
            const order = ['skill','ability','workstyle','knowledge','workactivity','trades','unique'];
            order.forEach(cat => {
                const count = counts[cat];
                if (!count) return; // skip empty categories
                const meta = categoryMeta[cat] || { label: cat, icon: '•' };
                html += `<option value="${cat}">${meta.icon} ${meta.label} (${count})</option>`;
            });
            // Catch any unexpected categories in the data
            Object.keys(counts).forEach(cat => {
                if (!order.includes(cat)) {
                    html += `<option value="${cat}">${cat} (${counts[cat]})</option>`;
                }
            });
            
            select.innerHTML = html;
            // Restore previous selection if still valid
            if (currentVal && select.querySelector(`option[value="${currentVal}"]`)) {
                select.value = currentVal;
            }
        }

        function closeSkillManagement() {
            const modal = document.getElementById('skillManagementModal');
            modal.classList.remove('active');
        }

        function switchSkillManagementTab(tab) {
            currentSkillManagementTab = tab;
            
            document.getElementById('yourSkillsTab').classList.toggle('active', tab === 'yours');
            document.getElementById('addSkillsTab').classList.toggle('active', tab === 'add');
            
            document.getElementById('yourSkillsContent').style.display = tab === 'yours' ? 'block' : 'none';
            document.getElementById('addSkillsContent').style.display = tab === 'add' ? 'block' : 'none';
            
            if (tab === 'yours') {
                renderYourSkills();
            } else {
                showAddSkillsEmpty();
            }
        }

        // Central count function — always call this after loading any library or adding skills
        function getTotalAvailableSkillCount() {
            let total = 0;
            // ESCO searchable library
            if (skillLibraryIndex?.totalSkills) total += skillLibraryIndex.totalSkills;
            else if (skillLibraryIndex?.index?.length) total += skillLibraryIndex.index.length;
            // O*NET libraries
            if (window.onetSkillsLibrary) total += 35; // nested categories structure
            if (window.onetAbilitiesLibrary?.abilities) total += window.onetAbilitiesLibrary.abilities.length;
            if (window.onetWorkStylesLibrary?.workStyles) total += window.onetWorkStylesLibrary.workStyles.length;
            if (window.onetKnowledgeLibrary?.knowledge) total += window.onetKnowledgeLibrary.knowledge.length;
            if (window.onetWorkActivitiesLibrary?.activities) total += window.onetWorkActivitiesLibrary.activities.length;
            // Trades & Creative
            if (window.tradesCreativeLibrary?.count) total += window.tradesCreativeLibrary.count;
            // Future: Lightcast, ESCO full, etc. add here
            return total > 0 ? total : 2384; // fallback if libraries not yet loaded
        }
        
        function updateSkillManagementCounts() {
            const yourCount = userData.skills.length;
            const availableCount = getTotalAvailableSkillCount();
            
            document.getElementById('yourSkillsCount').textContent = yourCount;
            document.getElementById('availableSkillsCount').textContent = availableCount.toLocaleString();
            document.getElementById('skillManagementCount').textContent = 
                `${yourCount} selected • ${availableCount.toLocaleString()} available`;
        }

        function renderYourSkills() {
            const container = document.getElementById('yourSkillsList');
            const searchQuery = document.getElementById('yourSkillsSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('yourSkillsCategoryFilter').value;
            const levelFilter = document.getElementById('yourSkillsLevelFilter').value;
            
            let skills = userData.skills.filter(skill => {
                const matchesSearch = !searchQuery || skill.name.toLowerCase().includes(searchQuery);
                const matchesCategory = categoryFilter === 'all' || skill.category === categoryFilter;
                const matchesLevel = levelFilter === 'all' || skill.level === levelFilter;
                return matchesSearch && matchesCategory && matchesLevel;
            });
            
            if (skills.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 3em; margin-bottom: 10px;">${bpIcon("clipboard",14)}</div>
                        <div style="font-size: 1.1em;">No skills found</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">Try adjusting your filters</div>
                    </div>
                `;
                return;
            }
            
            const grouped = {};
            skills.forEach(skill => {
                const cat = skill.category || 'unique';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(skill);
            });
            
            const categoryNames = {
                'skill': 'Technology',
                'ability': 'General Professional',
                'workstyle': 'Work Styles',
                'unique': 'Custom Skills'
            };
            
            container.innerHTML = Object.entries(grouped).map(([cat, catSkills]) => `
                <div style="margin-bottom: 25px;">
                    <div style="color: #9ca3af; font-size: 0.85em; font-weight: 600; margin-bottom: 12px; text-transform: uppercase;">
                        ${categoryNames[cat] || cat} (${catSkills.length})
                    </div>
                    ${catSkills.map(skill => `
                        <div class="your-skill-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="color: #e0e0e0; font-weight: 600; margin-bottom: 6px; font-size: 1.05em;">
                                        ${skill.name}
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <span style="color: #60a5fa; font-size: 0.8em; padding: 2px 8px; background: rgba(96, 165, 250, 0.2); border-radius: 3px;">
                                            ${skill.level}
                                        </span>
                                        ${skill.key ? '<span style="color: #fbbf24; font-size: 0.8em;">⭐ Core</span>' : ''}
                                        ${skill.roles ? `<span style="color: #9ca3af; font-size: 0.8em;">${skill.roles.length} role${skill.roles.length > 1 ? 's' : ''}</span>` : ''}
                                    </div>
                                </div>
                                <button onclick="removeSkillFromProfile('${skill.name.replace(/'/g, "\\'")}', '${cat}')" 
                                        style="padding: 8px 16px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap; font-weight: 600; transition: all 0.2s;"
                                        onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                                        onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function filterYourSkills() {
            renderYourSkills();
        }

        function removeSkillFromProfile(skillName, category) {
            if (!confirm(`Remove "${skillName}" from your profile?`)) return;
            
            const skillIndex = userData.skills.findIndex(s => s.name === skillName && s.category === category);
            if (skillIndex !== -1) {
                userData.skills.splice(skillIndex, 1);
            }
            
            const dataIndex = skillsData.skills.findIndex(s => s.name === skillName && s.category === category);
            if (dataIndex !== -1) {
                skillsData.skills.splice(dataIndex, 1);
            }
            
            saveUserData();
            updateSkillManagementCounts();
            renderYourSkills();
            refreshAllViews();
        }

        function showAddSkillsEmpty() {
            const container = document.getElementById('addSkillsResults');
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                    <div style="margin-bottom: 10px;">' + bpIcon('search',48) + '</div>
                    <div style="font-size: 1.1em;">Start typing to search skills</div>
                    <div style="font-size: 0.9em; margin-top: 10px;">Try: "python", "marketing", "leadership"</div>
                </div>
            `;
            document.getElementById('skillManagementStatus').textContent = '';
            document.getElementById('addSkillsCategories').style.display = 'block';
        }

        let addSkillsSearchTimeout;
        function handleAddSkillsSearch() {
            clearTimeout(addSkillsSearchTimeout);
            
            addSkillsSearchTimeout = setTimeout(() => {
                const query = document.getElementById('addSkillsSearchInput').value;
                console.log('Search triggered for:', query);
                
                if (!skillLibraryIndex || !skillLibraryIndex.index) {
                    console.error('Skill library not loaded!');
                    const container = document.getElementById('addSkillsResults');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #f59e0b;">
                            <div style="font-size: 3em; margin-bottom: 10px;">⏳</div>
                            <div style="font-size: 1.1em;">Loading skill library...</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">Please wait</div>
                        </div>
                    `;
                    // Force reload
                    loadSkillLibraryIndex().then(() => {
                        console.log('Library loaded, retrying search');
                        handleAddSkillsSearch();
                    });
                    return;
                }
                
                console.log('Library loaded with', skillLibraryIndex.totalSkills, 'skills');
                
                if (!query || query.trim().length < 2) {
                    console.log('Query too short, showing empty state');
                    showAddSkillsEmpty();
                    return;
                }
                
                console.log('Performing search for:', query);
                performAddSkillsSearch(query);
            }, 300);
        }

        // Search across ALL loaded libraries and return normalized results
        function searchAllLibraries(query) {
            const q = query.toLowerCase().trim();
            if (q.length < 2) return [];
            const results = [];
            const seen = new Set();
            
            // 1. ESCO searchable index
            const escoResults = searchSkills(query);
            escoResults.forEach(s => {
                const key = (s.n || '').toLowerCase();
                if (!seen.has(key)) {
                    seen.add(key);
                    results.push({ id: s.id, n: s.n, c: s.c, sc: s.sc || '', definition: '', source: 'esco', category: null, _raw: s });
                }
            });
            
            // 2. Trades & Creative library
            if (window.tradesCreativeLibrary && window.tradesCreativeLibrary.categories) {
                Object.entries(window.tradesCreativeLibrary.categories).forEach(function([catKey, cat]) {
                    (cat.skills || []).forEach(function(skill) {
                        const nameMatch = skill.name.toLowerCase().includes(q);
                        const defMatch = (skill.definition || '').toLowerCase().includes(q);
                        const adjMatch = (skill.adjacencies || []).some(function(a) { return a.toLowerCase().includes(q); });
                        if (nameMatch || defMatch || adjMatch) {
                            const key = skill.name.toLowerCase();
                            if (!seen.has(key)) {
                                seen.add(key);
                                results.push({ id: skill.id, n: skill.name, c: cat.name, sc: 'Trades & Creative', definition: skill.definition || '', source: 'trades', category: 'trades', _raw: skill });
                            }
                        }
                    });
                });
            }
            
            // 3. O*NET Knowledge
            if (window.onetKnowledgeLibrary && window.onetKnowledgeLibrary.knowledge) {
                window.onetKnowledgeLibrary.knowledge.forEach(function(skill) {
                    if (skill.name.toLowerCase().includes(q) || (skill.description || '').toLowerCase().includes(q)) {
                        const key = skill.name.toLowerCase();
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ id: skill.onetCode, n: skill.name, c: 'Knowledge', sc: skill.group || '', definition: skill.description || '', source: 'onet-knowledge', category: 'knowledge', _raw: skill });
                        }
                    }
                });
            }
            
            // 4. O*NET Work Activities
            if (window.onetWorkActivitiesLibrary && window.onetWorkActivitiesLibrary.activities) {
                window.onetWorkActivitiesLibrary.activities.forEach(function(skill) {
                    if (skill.name.toLowerCase().includes(q) || (skill.description || '').toLowerCase().includes(q)) {
                        const key = skill.name.toLowerCase();
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ id: skill.onetCode, n: skill.name, c: 'Work Activities', sc: skill.group || '', definition: skill.description || '', source: 'onet-activities', category: 'workactivity', _raw: skill });
                        }
                    }
                });
            }
            
            // 5. O*NET Abilities
            if (window.onetAbilitiesLibrary && window.onetAbilitiesLibrary.abilities) {
                window.onetAbilitiesLibrary.abilities.forEach(function(skill) {
                    const def = skill.definition || skill.description || '';
                    if (skill.name.toLowerCase().includes(q) || def.toLowerCase().includes(q)) {
                        const key = skill.name.toLowerCase();
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ id: skill.id || skill.onetCode, n: skill.name, c: 'Abilities', sc: skill.group || '', definition: def, source: 'onet-abilities', category: 'ability', _raw: skill });
                        }
                    }
                });
            }
            
            // 6. O*NET Work Styles
            if (window.onetWorkStylesLibrary && window.onetWorkStylesLibrary.workStyles) {
                window.onetWorkStylesLibrary.workStyles.forEach(function(skill) {
                    const def = skill.definition || skill.description || '';
                    if (skill.name.toLowerCase().includes(q) || def.toLowerCase().includes(q)) {
                        const key = skill.name.toLowerCase();
                        if (!seen.has(key)) {
                            seen.add(key);
                            results.push({ id: skill.id || skill.onetCode, n: skill.name, c: 'Work Styles', sc: skill.group || '', definition: def, source: 'onet-workstyles', category: 'workstyle', _raw: skill });
                        }
                    }
                });
            }
            
            return results.slice(0, 30);
        }
        
        function performAddSkillsSearch(query) {
            try {
                const safeResults = searchAllLibraries(query);
                
                const container = document.getElementById('addSkillsResults');
                if (!container) {
                    console.error('ERROR: addSkillsResults container not found!');
                    return;
                }
                
                const categoriesDiv = document.getElementById('addSkillsCategories');
                if (categoriesDiv) {
                    categoriesDiv.style.display = 'none';
                }
                
                if (safeResults.length === 0) {
                    console.log('No results found, showing empty state');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                            <div style="font-size: 3em; margin-bottom: 10px;">❌</div>
                            <div style="font-size: 1.1em;">No skills found for "${query}"</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">Try a different search term</div>
                        </div>
                    `;
                    const statusEl = document.getElementById('skillManagementStatus');
                    if (statusEl) statusEl.textContent = 'No results';
                    return;
                }
                
                console.log('Rendering', safeResults.length, 'results');
                container.innerHTML = safeResults.map(skill => {
                    try {
                        const isAdded = isSkillAlreadyAdded(skill.n);
                        const categoryColor = getCategoryColor(skill.c);
                        
                        return `
                            <div class="skill-search-result ${isAdded ? 'added' : ''}" 
                                 style="padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid ${categoryColor}; cursor: ${isAdded ? 'default' : 'pointer'}; transition: all 0.2s;"
                                 ${isAdded ? '' : `onclick="addSkillFromLibrary('${skill.id}')"`}
                                 onmouseover="if (!this.classList.contains('added')) this.style.background='rgba(255,255,255,0.06)'"
                                 onmouseout="if (!this.classList.contains('added')) this.style.background='rgba(255,255,255,0.03)'">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="color: #e0e0e0; font-weight: 600; margin-bottom: 4px;">
                                            ${skill.n}
                                            ${isAdded ? '<span style="color: #10b981; font-size: 0.85em; margin-left: 8px;">✓ Already have</span>' : ''}
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <span style="color: ${categoryColor}; font-size: 0.75em; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                                ${skill.c}
                                            </span>
                                            ${skill.sc ? `
                                                <span style="color: #9ca3af; font-size: 0.75em;">
                                                    ${skill.sc}
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${!isAdded ? `
                                        <button style="padding: 6px 12px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; border-radius: 6px; color: white; font-size: 0.85em; font-weight: 600; cursor: pointer;"
                                                onclick="event.stopPropagation(); addSkillFromLibrary('${skill.id}')">
                                            + Add
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    } catch (skillError) {
                        console.error('Error rendering skill:', skill, skillError);
                        return '';
                    }
                }).filter(Boolean).join('');
                
                const statusEl = document.getElementById('skillManagementStatus');
                if (statusEl) {
                    statusEl.textContent = `Found ${safeResults.length} skill${safeResults.length > 1 ? 's' : ''}`;
                }
                
                
            } catch (error) {
                console.error('=== CRITICAL ERROR in performAddSkillsSearch ===');
                console.error('Error:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                const container = document.getElementById('addSkillsResults');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #ef4444;">
                            <div style="margin-bottom: 10px;">${bpIcon("warning",48)}</div>
                            <div style="font-size: 1.1em; font-weight: bold;">Search Error</div>
                            <div style="font-size: 0.9em; margin-top: 10px; font-family: monospace;">
                                ${error.message}
                            </div>
                            <div style="font-size: 0.85em; margin-top: 10px; color: #9ca3af;">
                                Check browser console (F12) for details
                            </div>
                        </div>
                    `;
                }
                
                showToast('Search error: ' + error.message, 'error');
            }
        }

        function searchAddSkillsByCategory(category) {
            if (category === 'Trades') {
                var categoriesDiv = document.getElementById('addSkillsCategories');
                if (categoriesDiv) categoriesDiv.style.display = 'none';
                var container = document.getElementById('addSkillsResults');
                if (!container) return;
                var tradeResults = [];
                if (window.tradesCreativeLibrary && window.tradesCreativeLibrary.categories) {
                    Object.values(window.tradesCreativeLibrary.categories).forEach(function(cat) {
                        (cat.skills || []).forEach(function(skill) {
                            tradeResults.push({ id: skill.id, n: skill.name, c: cat.name, sc: 'Trades & Creative', definition: skill.definition || '', source: 'trades', category: 'trades' });
                        });
                    });
                }
                if (tradeResults.length === 0) {
                    container.innerHTML = '<div style="text-align:center;padding:30px;color:#9ca3af;">Trades library not loaded yet.</div>';
                    return;
                }
                var catColors = {'Woodworking & Construction':'#d97706','Electrical/Plumbing/Mechanical':'#0891b2','Painting & Finishing':'#7c3aed','Culinary Arts':'#dc2626','Visual Arts':'#db2777','Fiber & Textile':'#059669','Performing Arts':'#ea580c','Outdoor & Agriculture':'#16a34a','Technology & Making':'#2563eb'};
                container.innerHTML = tradeResults.map(function(skill) {
                    var isAdded = isSkillAlreadyAdded(skill.n);
                    var color = catColors[skill.c] || '#d97706';
                    return '<div style="padding:12px;margin-bottom:8px;background:rgba(255,255,255,0.03);border-radius:8px;border-left:3px solid '+color+';cursor:'+(isAdded?'default':'pointer')+';" '+(isAdded?'':'onclick="addSkillFromLibrary(\'' + skill.id + '\')"')+'>'
                        +'<div style="display:flex;justify-content:space-between;align-items:start;">'
                        +'<div style="flex:1;"><div style="color:#e0e0e0;font-weight:600;margin-bottom:4px;">'+skill.n+(isAdded?' <span style="color:#10b981;font-size:0.85em;">✓ Added</span>':'')+'</div>'
                        +'<span style="color:'+color+';font-size:0.75em;padding:2px 6px;background:rgba(255,255,255,0.1);border-radius:3px;">'+skill.c+'</span></div>'
                        +(!isAdded?'<button style="padding:6px 12px;background:linear-gradient(135deg,#60a5fa,#3b82f6);border:none;border-radius:6px;color:white;font-size:0.85em;font-weight:600;cursor:pointer;" onclick="event.stopPropagation();addSkillFromLibrary(\'' + skill.id + '\')">+ Add</button>':'')
                        +'</div></div>';
                }).join('');
                var statusEl = document.getElementById('skillManagementStatus');
                if (statusEl) statusEl.textContent = 'Showing ' + tradeResults.length + ' Trade Skills';
                return;
            }
            document.getElementById('addSkillsSearchInput').value = category;
            handleAddSkillsSearch();
        }

        function addSkillFromLibrary(skillId) {
            // Find the skill across all libraries
            let skillName = null, category = 'skill', definition = '';
            
            // Check ESCO index
            if (skillLibraryIndex && skillLibraryIndex.index) {
                const found = skillLibraryIndex.index.find(s => s.id === skillId);
                if (found) {
                    skillName = found.n;
                    const sc = (found.sc || '').toLowerCase();
                    const cat = (found.c || '').toLowerCase();
                    if (cat === 'work styles' || sc.includes('work style')) category = 'workstyle';
                    else if (['transversal skills','language skills','cognitive abilities','sensory abilities','physical abilities','psychomotor abilities'].includes(cat)) category = 'ability';
                    else category = 'skill';
                }
            }
            
            // Check trades library
            if (!skillName && window.tradesCreativeLibrary && window.tradesCreativeLibrary.categories) {
                outer: for (const cat of Object.values(window.tradesCreativeLibrary.categories)) {
                    for (const skill of (cat.skills || [])) {
                        if (skill.id === skillId) {
                            skillName = skill.name;
                            category = 'trades';
                            definition = skill.definition || '';
                            break outer;
                        }
                    }
                }
            }
            
            // Check O*NET libraries by code
            if (!skillName) {
                const onetSources = [
                    { lib: window.onetKnowledgeLibrary?.knowledge, cat: 'knowledge', nameField: 'name', idField: 'onetCode' },
                    { lib: window.onetWorkActivitiesLibrary?.activities, cat: 'workactivity', nameField: 'name', idField: 'onetCode' },
                    { lib: window.onetAbilitiesLibrary?.abilities, cat: 'ability', nameField: 'name', idField: 'id' },
                    { lib: window.onetWorkStylesLibrary?.workStyles, cat: 'workstyle', nameField: 'name', idField: 'id' },
                ];
                for (const src of onetSources) {
                    if (!src.lib) continue;
                    const found = src.lib.find(s => (s[src.idField] || s.id || s.onetCode) === skillId);
                    if (found) {
                        skillName = found.name;
                        category = src.cat;
                        definition = found.definition || found.description || '';
                        break;
                    }
                }
            }
            
            if (!skillName) { console.warn('Skill not found for id:', skillId); return; }
            if (isSkillAlreadyAdded(skillName)) return;
            
            const newSkill = {
                name: skillName,
                category: category,
                level: 'Advanced',
                roles: [userData.roles[0]?.id || 'default'],
                key: false,
                evidence: [],
                source: 'library',
                libraryId: skillId
            };
            
            userData.skills.push(newSkill);
            skillsData.skills.push(newSkill);
            
            saveUserData();
            populateCategoryFilter();
            updateSkillManagementCounts();
            refreshAllViews();
            
            const query = document.getElementById('addSkillsSearchInput').value;
            if (query) performAddSkillsSearch(query);
        }
        
        // ===== OVERFLOW MENU FUNCTIONS =====
        
        // ===== THEME TOGGLE =====
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') !== 'light';
            html.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeToggleBtn').textContent = isDark ? '☀️' : '🌙';
            safeSet('wbTheme', isDark ? 'light' : 'dark');
            
            // Re-render current view so tv()/tb() inline styles pick up new theme
            if (typeof currentView !== 'undefined' && currentView) {
                if (currentView === 'network' || currentView === 'skills') {
                    if (typeof initCardView === 'function' && currentSkillsView === 'card') {
                        initCardView();
                    }
                    // Network SVG uses CSS variables, no re-render needed
                } else if (currentView === 'blueprint' && typeof renderBlueprint === 'function') {
                    renderBlueprint();
                } else if (currentView === 'consent' && typeof initConsent === 'function') {
                    initConsent();
                } else if (currentView === 'settings' && typeof initSettings === 'function') {
                    initSettings();
                } else if (currentView === 'jobs' && typeof initOpportunities === 'function') {
                    initOpportunities();
                } else if (currentView === 'applications' && typeof initApplications === 'function') {
                    initApplications();
                }
            }
        }
        window.toggleTheme = toggleTheme;

        function initTheme() {
            const saved = safeGet('wbTheme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            const btn = document.getElementById('themeToggleBtn');
            if (btn) btn.textContent = saved === 'light' ? '☀️' : '🌙';
        }
        window.initTheme = initTheme;

        // ===== PROFILE DROPDOWN =====
        var _profileDropdownClosing = false;
        function toggleProfileDropdown(event) {
            event.stopPropagation();
            if (_profileDropdownClosing) return;
            var dropdown = document.getElementById('profileDropdown');
            var options = document.getElementById('profileDropdownOptions');
            // If click came from inside the dropdown options, don't toggle (let the option's own onclick handle it)
            if (options && options.contains(event.target)) return;
            dropdown.classList.toggle('open');
        }
        window.toggleProfileDropdown = toggleProfileDropdown;

        function closeProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) dropdown.classList.remove('open');
            // Brief flag to prevent the bubbling click from re-opening
            _profileDropdownClosing = true;
            setTimeout(function() { _profileDropdownClosing = false; }, 100);
        }
        window.closeProfileDropdown = closeProfileDropdown;

        function buildProfileDropdown(profiles, currentId) {
            const container = document.getElementById('profileDropdownOptions');
            if (!container) return;
            container.innerHTML = profiles.map(p => {
                const initials = p.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
                const isActive = p.id === currentId;
                return `<div class="profile-option ${isActive ? 'active-profile' : ''}" onclick="switchProfile('${p.id}'); closeProfileDropdown();">
                    <div class="profile-option-avatar">${initials}</div>
                    <div class="profile-option-info">
                        <div class="profile-option-name">${p.name}</div>
                        <div class="profile-option-title">${p.title || ''}</div>
                    </div>
                    ${isActive ? '<span class="profile-option-check">✓</span>' : ''}
                </div>`;
            }).join('');
        }

        function updateProfileChip(name) {
            const initials = name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
            const avatar = document.getElementById('profileAvatar');
            const chipName = document.getElementById('profileChipName');
            if (avatar) {
                if (userData.profile && userData.profile.photo) {
                    avatar.innerHTML = '<img src="' + userData.profile.photo + '" alt="Profile photo" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
                } else {
                    avatar.textContent = initials;
                }
            }
            if (chipName) chipName.textContent = name;
            document.title = name + ' \u2014 Blueprint\u2122';
        }

        // ===== FILTER PANEL TOGGLE =====
        function toggleFilterPanel() {
            const panel = document.getElementById('filterPanel');
            const btn = document.getElementById('filterToggleBtn');
            const isOpen = panel.classList.toggle('open');
            btn.classList.toggle('active', isOpen);
        }

        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            // Close overflow menu
            const menu = document.getElementById('overflowMenu');
            const moreBtn = document.getElementById('overflowMenuBtn');
            if (menu && moreBtn && menu.style.display === 'block') {
                if (!menu.contains(e.target) && !moreBtn.contains(e.target)) closeOverflowMenu();
            }
            // Close profile dropdown
            const chip = document.getElementById('profileChip');
            if (chip && !chip.contains(e.target)) closeProfileDropdown();
        });

        function toggleOverflowMenu(event) {
            if (event) {
                event.stopPropagation();
            }
            
            const menu = document.getElementById('overflowMenu');
            const btn = document.getElementById('overflowMenuBtn');
            const isVisible = menu.style.display === 'block';
            
            if (isVisible) {
                menu.style.display = 'none';
                btn.classList.remove('active');
            } else {
                menu.style.display = 'block';
                btn.classList.add('active');
            }
        }
        
        function closeOverflowMenu() {
            const menu = document.getElementById('overflowMenu');
            const btn = document.getElementById('overflowMenuBtn');
            if (menu) menu.style.display = 'none';
            if (btn) btn.classList.remove('active');
        }
        
        function showHelp() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">How to Use Blueprint</h2>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="min-width: 40px;">${bpIcon("compass",28)}</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Skills Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">View your full skill network as an interactive graph or card view. Click any skill to see your evidence and outcomes. Use the role and level filters to explore different facets of your profile.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="min-width: 40px;">${bpIcon("briefcase",28)}</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Jobs Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">Find opportunities matched to your actual skill profile. Skills you have are highlighted green; gaps shown in red. Generate a personalized outreach message for any role.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">${bpIcon("clipboard",14)}</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Applications Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">Track every role you've applied to. Log status, salary targets, contacts and notes. Keep your job search organized in one place.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">${bpIcon("bar-chart",14)}</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Blueprint Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">See your market valuation, manage your outcomes, choose your values, and write your purpose statement. This is your source of truth. Export as a resume or personalized page to share with recruiters.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="min-width: 40px;">${bpIcon("settings",28)}</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Settings (More menu)</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">Update your profile info, preferences, and manage your skills. Export your full profile as JSON to save your work or move it to another device.</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function showAbout() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Blueprint</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">v4.18.1 · Your career, fully represented</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">×</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <p style="color: #d1d5db; line-height: 1.8; margin-bottom: 20px;">
                        Most people underrepresent themselves when applying for work — not because they lack ability, 
                        but because they lack the tools to articulate it. Blueprint changes that.
                    </p>
                    <p style="color: #d1d5db; line-height: 1.8; margin-bottom: 20px;">
                        This tool guides you through fully discovering and documenting your skills, evidence, outcomes, 
                        values and purpose — then shows you what that profile is worth in the market. Export it as a 
                        traditional resume for ATS systems, or as a personalized interactive page for the humans 
                        making the actual hiring decision.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                        <div style="background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">${bpIcon("compass",14)} Skills Ontology</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">Map your full skill landscape — O*NET standard skills, abilities, work styles, and unique differentiators.</div>
                        </div>
                        <div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #10b981; font-weight: 600; margin-bottom: 8px;">${bpIcon("dollar",14)} Market Valuation</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">See what your specific skill portfolio is worth — with negotiation ranges, not just a single number.</div>
                        </div>
                        <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 8px;">${bpIcon("bar-chart",14)} Blueprint</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">Build your complete professional narrative — outcomes, values, purpose — with full control over what you share.</div>
                        </div>
                        <div style="background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #a78bfa; font-weight: 600; margin-bottom: 8px;">${bpIcon("external",14)} Personalized Outreach</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">Generate a company-specific page and recruiter email — one link that tells your story their way.</div>
                        </div>
                    </div>
                    <p style="color: #6b7280; font-size: 0.85em; text-align: center;">Free to explore · Sign in to save your profile · Your data stays yours</p>
                </div>
            `;
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        
        function showLegalNotice() {
            var modal = document.getElementById('exportModal');
            var mc = modal.querySelector('.modal-content');
            mc.innerHTML = '<div class="modal-header">'
                + '<div class="modal-header-left">'
                + '<h2 class="modal-title">Legal &amp; Intellectual Property Notice</h2>'
                + '</div>'
                + '<button class="modal-close" onclick="closeExportModal()">&times;</button>'
                + '</div>'
                + '<div class="modal-body" style="padding:28px; color:var(--text-secondary); line-height:1.8; font-size:0.9em;">'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">Trademark</h3>'
                + '<p style="margin-bottom:20px;">Blueprint&trade; is a trademark of Cliff Jurkiewicz. '
                + 'The Blueprint name, logo, network mark, and associated visual identity are the property of Cliff Jurkiewicz. '
                + 'Unauthorized use of the Blueprint name or mark is prohibited.</p>'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">Copyright</h3>'
                + '<p style="margin-bottom:20px;">&copy; ' + new Date().getFullYear() + ' Cliff Jurkiewicz. All rights reserved. '
                + 'The Blueprint software, including its source code, user interface design, visual assets, and documentation, '
                + 'is the copyrighted work of Cliff Jurkiewicz. No portion of this software may be reproduced, distributed, '
                + 'or transmitted in any form without prior written permission.</p>'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">Intellectual Property</h3>'
                + '<p style="margin-bottom:20px;">The following are original methodologies and intellectual property of Cliff Jurkiewicz:</p>'
                + '<div style="margin-bottom:20px; padding:16px; background:' + tv('rgba(96,165,250,0.06)','rgba(96,165,250,0.08)') + '; border:1px solid ' + tv('rgba(96,165,250,0.15)','rgba(96,165,250,0.2)') + '; border-radius:8px;">'
                + '<div style="margin-bottom:8px;"><strong style="color:var(--text-primary);">Blueprint Ontology System</strong> &mdash; The professional skill ontology architecture, role-cluster mapping methodology, and 90-skill framework integrating O*NET occupational data with individualized career modeling.</div>'
                + '<div style="margin-bottom:8px;"><strong style="color:var(--text-primary);">Match Algorithm</strong> &mdash; The weighted skill-matching engine including fuzzy word-overlap scoring, requirement-level classification, and proficiency-weighted gap analysis.</div>'
                + '<div style="margin-bottom:8px;"><strong style="color:var(--text-primary);">Network Visualization</strong> &mdash; The force-directed ontology visualization system including the match overlay methodology for displaying skill alignment between professional profiles and job requirements.</div>'
                + '<div><strong style="color:var(--text-primary);">Proprietary Frameworks</strong> &mdash; Including but not limited to: human-in-the-lead (vs. human-in-the-loop), candidate experience architecture, and AI fluency models.</div>'
                + '</div>'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">Third-Party Data</h3>'
                + '<p style="margin-bottom:20px;">Blueprint incorporates data from the O*NET program (U.S. Department of Labor) and the ESCO classification (European Commission). '
                + 'These datasets are used under their respective open-access terms. Their inclusion does not imply endorsement by these organizations.</p>'
                + '<h3 style="color:var(--text-primary); font-size:1.05em; margin-bottom:12px;">User Data</h3>'
                + '<p>Users retain ownership of their personal data entered into Blueprint. Blueprint does not sell, share, or monetize user data. '
                + 'Profile data is stored locally in the browser and, when authenticated, encrypted in cloud storage accessible only to the account holder.</p>'
                + '</div>';
            history.pushState({ modal: true }, ''); modal.classList.add('active');
        }
        window.showLegalNotice = showLegalNotice;
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('overflowMenu');
            const btn = document.getElementById('overflowMenuBtn');
            if (menu && btn && menu.style.display === 'block') {
                if (!menu.contains(event.target) && !btn.contains(event.target)) {
                    closeOverflowMenu();
                }
            }
        });
        
        // ===== BULK OPERATIONS =====
        
        let bulkSelectionMode = false;
        let selectedSkills = [];
        // [removed] selectAllSkills — dead code cleanup v4.22.0
        // [removed] updateBulkModeBar — dead code cleanup v4.22.0
        
        
        
        
        
        // ===== SKILL TEMPLATES =====
        
        
        
        
        // ===== SORTING =====
        
        let currentSort = 'category'; // category, proficiency, alphabetical, role, core, recent
        
        
        
        // Resize handler — preserves active job match mode
        var _resizeTimer = null;
        window.addEventListener('resize', function() {
            clearTimeout(_resizeTimer);
            _resizeTimer = setTimeout(function() {
                if (currentView === 'network' && currentSkillsView === 'network') {
                    if (activeJobForNetwork && networkMatchMode !== 'you') {
                        // Re-render the active match/job view
                        setNetworkMatchMode(networkMatchMode);
                    } else {
                        window.networkInitialized = false;
                        initNetwork();
                        window.networkInitialized = true;
                    }
                }
            }, 250);
        });

        // C2: Browser back button navigation
        window.addEventListener('popstate', function(e) {
            // Close any open modals first
            var openModal = document.querySelector('.modal.active');
            if (openModal) {
                openModal.classList.remove('active');
                return;
            }
            var view = (e.state && e.state.view) ? e.state.view : 'welcome';
            _skipHistoryPush = true;
            switchView(view);
            _skipHistoryPush = false;
        });
    </script>

    <!-- Waitlist Registration Modal -->
    <div class="waitlist-overlay" id="waitlistOverlay">
        <div class="waitlist-modal">
            <button class="wl-close" onclick="closeWaitlist()">&times;</button>
            <div id="waitlistFormView">
                <h3>&#9672; Get Early Access</h3>
                <p class="wl-subtitle">Most professionals can name 15&ndash;20 skills. Blueprint maps 150&ndash;300. Join the waitlist to see your full professional architecture.</p>
                <label>Name</label>
                <input type="text" id="wlName" placeholder="Your name" autocomplete="name">
                <label>Email</label>
                <input type="email" id="wlEmail" placeholder="you@company.com" autocomplete="email">
                <label>What describes you best?</label>
                <select id="wlType">
                    <option value="">Select one...</option>
                    <option value="individual">Individual professional</option>
                    <option value="leader">Talent / People leader</option>
                    <option value="recruiter">Recruiter / TA professional</option>
                    <option value="executive">Executive / C-suite</option>
                    <option value="other">Other</option>
                </select>
                <button class="wl-submit-btn" id="wlSubmitBtn" onclick="submitWaitlist()">Join the Waitlist</button>
                <div class="wl-skill-question" id="wlSkillHint">How many skills do you think you have? Most people guess 15&ndash;20. The real number will surprise you.</div>
            </div>
            <div id="waitlistConfirmView" style="display:none; text-align:center; padding:20px 0;">
                <div style="font-size:2.2em; margin-bottom:12px;">&#10003;</div>
                <h3 style="color:var(--accent); margin-bottom:8px;">You're on the list!</h3>
                <div id="wlPositionMsg" style="font-size:0.95em; color:var(--text-secondary); margin-bottom:16px;"></div>
                <div class="wl-position-badge" id="wlPositionBadge" style="margin:0 auto 20px;"></div>
                <p style="font-size:0.85em; color:var(--text-muted); line-height:1.5;">We'll notify you when it's your turn. In the meantime, explore the sample profiles to see what Blueprint can do.</p>
                <button onclick="closeWaitlist()" style="margin-top:16px; padding:10px 28px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text-primary); cursor:pointer; font-weight:600;">Continue Exploring</button>
            </div>
        </div>
    </div>

</body>
</html>