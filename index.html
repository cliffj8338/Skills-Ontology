<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliff Jones - Work Blueprint</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #e0e0e0;
            overflow-x: hidden;
        }
        
        .header {
            background: rgba(26, 26, 46, 0.8);
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-left h1 {
            color: #60a5fa;
            font-size: 1.8em;
            margin-bottom: 5px;
        }
        
        .header-left .subtitle {
            color: #9ca3af;
            font-size: 0.9em;
        }
        
        #statsBar {
            display: inline-flex;
            gap: 15px;
            align-items: center;
        }
        
        .stat-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        #consentView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #settingsView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #applicationsView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        .applications-header {
            margin-bottom: 30px;
        }
        
        .applications-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .application-card {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .application-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .application-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .status-applied {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .status-interviewing {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .status-offer {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-rejected {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }
        
        .application-title {
            font-size: 1.2em;
            color: #e0e0e0;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .application-company {
            color: #9ca3af;
            margin-bottom: 15px;
        }
        
        .application-meta-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
        }
        
        .application-meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .application-meta-label {
            font-size: 0.75em;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .application-meta-value {
            color: #e0e0e0;
            font-size: 0.95em;
        }
        
        .application-notes {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid rgba(96, 165, 250, 0.5);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #d1d5db;
            line-height: 1.5;
        }
        
        .application-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .application-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .application-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .application-btn.delete {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .application-btn.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        .settings-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: inherit;
        }
        
        .settings-input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .settings-select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            font-family: inherit;
        }
        
        .settings-group {
            margin-bottom: 25px;
        }
        
        .settings-label {
            display: block;
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .settings-help {
            color: #9ca3af;
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            min-height: 45px;
        }
        
        .tag-chip {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tag-remove {
            cursor: pointer;
            color: #ef4444;
            font-weight: bold;
        }
        
        .save-settings-btn {
            width: 100%;
            padding: 15px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .save-settings-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .view-toggle {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            display: flex;
            overflow: hidden;
        }
        
        .view-toggle button {
            background: transparent;
            border: none;
            color: #9ca3af;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .view-toggle button.active {
            background: #60a5fa;
            color: #fff;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
        }
        
        .controls {
            background: rgba(26, 26, 46, 0.6);
            border-bottom: 1px solid rgba(96, 165, 250, 0.1);
            padding: 15px 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .controls-left {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .controls-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-label {
            color: #9ca3af;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .role-chip {
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }
        
        .role-chip:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .role-chip.active {
            background: #60a5fa;
            color: #fff;
            border-color: #60a5fa;
        }
        
        .level-filter {
            display: flex;
            gap: 8px;
        }
        
        .level-chip {
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            border: 1px solid transparent;
        }
        
        .level-chip.mastery {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .level-chip.mastery.active {
            background: #ef4444;
            color: #fff;
        }
        
        .level-chip.advanced {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .level-chip.advanced.active {
            background: #f59e0b;
            color: #fff;
        }
        
        .level-chip.proficient {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .level-chip.proficient.active {
            background: #10b981;
            color: #fff;
        }
        
        .level-chip.expert {
            background: rgba(249, 115, 22, 0.2);
            border-color: rgba(249, 115, 22, 0.3);
        }
        
        .level-chip.expert.active {
            background: #f97316;
            color: #fff;
        }
        
        .level-chip.novice {
            background: rgba(107, 114, 128, 0.2);
            border-color: rgba(107, 114, 128, 0.3);
        }
        
        .level-chip.novice.active {
            background: #6b7280;
            color: #fff;
        }
        
        .label-toggle {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(96, 165, 250, 0.3);
            transition: .3s;
            border-radius: 20px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #60a5fa;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .toggle-label {
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        .main-content {
            position: relative;
            height: calc(100vh - 160px);
        }
        
        #networkView {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        #cardView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #opportunitiesView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
        }
        
        #blueprintView {
            display: none;
            padding: 30px;
            height: 100%;
            overflow-y: auto;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
        }
        
        .blueprint-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .blueprint-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.3);
        }
        
        .blueprint-title {
            font-size: 2.5em;
            color: #60a5fa;
            margin-bottom: 10px;
        }
        
        .blueprint-subtitle {
            font-size: 1.2em;
            color: #9ca3af;
            margin-bottom: 20px;
        }
        
        .blueprint-tagline {
            font-size: 1em;
            color: #d1d5db;
            font-style: italic;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .blueprint-section {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .blueprint-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        }
        
        .blueprint-section-title {
            font-size: 1.5em;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-icon {
            font-size: 1.3em;
        }
        
        .section-count {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
        }
        
        .coaching-tip {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            border-left: 4px solid #fbbf24;
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 8px;
        }
        
        .coaching-tip-title {
            color: #fbbf24;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .coaching-tip-content {
            color: #d1d5db;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .coaching-tip-content ul {
            margin: 10px 0 0 20px;
        }
        
        .coaching-tip-content li {
            margin: 5px 0;
        }
        
        .outcome-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .outcome-item:hover {
            border-color: rgba(96, 165, 250, 0.4);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .outcome-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .outcome-text {
            flex: 1;
            font-size: 1.05em;
            color: #e0e0e0;
            line-height: 1.5;
        }
        
        .outcome-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .share-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .share-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .share-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(107, 114, 128, 0.3);
            transition: .3s;
            border-radius: 26px;
        }
        
        .share-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        .share-toggle input:checked + .share-toggle-slider {
            background-color: #10b981;
        }
        
        .share-toggle input:checked + .share-toggle-slider:before {
            transform: translateX(24px);
        }
        
        .outcome-meta {
            display: flex;
            gap: 15px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(96, 165, 250, 0.1);
            flex-wrap: wrap;
        }
        
        .meta-tag {
            font-size: 0.8em;
            padding: 4px 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .meta-tag.category {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }
        
        .meta-tag.evidence {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .meta-tag.sensitive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .outcome-coaching {
            background: rgba(251, 191, 36, 0.1);
            border-left: 3px solid #fbbf24;
            padding: 10px 15px;
            margin-top: 12px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #fbbf24;
        }
        
        .outcome-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        
        .outcome-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .outcome-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .add-outcome-btn {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.05);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .add-outcome-btn:hover {
            background: rgba(96, 165, 250, 0.1);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .reflection-prompts {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .reflection-title {
            color: #a78bfa;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 0.95em;
        }
        
        .reflection-prompts ul {
            list-style: none;
            padding: 0;
        }
        
        .reflection-prompts li {
            color: #d1d5db;
            padding: 8px 0;
            padding-left: 20px;
            position: relative;
            font-size: 0.9em;
        }
        
        .reflection-prompts li:before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: #a78bfa;
        }
        
        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .value-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(96, 165, 250, 0.2);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .value-card.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .value-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .value-title {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 5px;
        }
        
        .value-description {
            font-size: 0.85em;
            color: #9ca3af;
            line-height: 1.4;
        }
        
        .purpose-editor {
            width: 100%;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: #e0e0e0;
            font-size: 1em;
            line-height: 1.6;
            font-family: inherit;
            resize: vertical;
        }
        
        .purpose-editor:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .export-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }
        
        .export-title {
            color: #ef4444;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .export-btn-large {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: #ef4444;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-btn-large:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        .opportunities-header {
            max-width: 1400px;
            margin: 0 auto 30px;
        }
        
        .opportunities-title {
            font-size: 2em;
            color: #60a5fa;
            margin-bottom: 10px;
        }
        
        .opportunities-subtitle {
            color: #9ca3af;
            font-size: 1.1em;
            margin-bottom: 30px;
        }
        
        .opportunities-filters {
            background: rgba(26, 26, 46, 0.6);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-section-label {
            color: #60a5fa;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .match-slider {
            width: 200px;
        }
        
        .match-value {
            color: #fbbf24;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .opportunity-card {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(26, 26, 46, 0.6) 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .opportunity-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .opportunity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .opportunity-company {
            font-size: 0.9em;
            color: #9ca3af;
            margin-bottom: 5px;
        }
        
        .opportunity-title {
            font-size: 1.2em;
            color: #e0e0e0;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .match-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .match-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            font-weight: bold;
            position: relative;
        }
        
        .match-circle.high {
            background: radial-gradient(circle, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 3px solid #10b981;
            color: #10b981;
        }
        
        .match-circle.medium {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.2) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 3px solid #f59e0b;
            color: #f59e0b;
        }
        
        .match-circle.low {
            background: radial-gradient(circle, rgba(107, 114, 128, 0.2) 0%, rgba(107, 114, 128, 0.05) 100%);
            border: 3px solid #6b7280;
            color: #6b7280;
        }
        
        .match-label {
            font-size: 0.75em;
            color: #9ca3af;
            text-transform: uppercase;
        }
        
        .opportunity-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .matched-skills {
            margin-bottom: 15px;
        }
        
        .matched-skills-title {
            font-size: 0.85em;
            color: #60a5fa;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .skill-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .skill-chip-match {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        
        .skill-chip-gap {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        
        .opportunity-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(96, 165, 250, 0.1);
        }
        
        .action-btn {
            flex: 1;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .action-btn:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(96, 165, 250, 0.2);
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .domain-card {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(26, 26, 46, 0.6) 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .domain-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            transform: translateY(-2px);
        }
        
        .domain-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        }
        
        .domain-icon {
            font-size: 24px;
        }
        
        .domain-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #60a5fa;
        }
        
        .skill-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid transparent;
            margin-bottom: 8px;
        }
        
        .skill-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .skill-name {
            flex: 1;
            font-size: 0.95em;
        }
        
        .skill-badge {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }
        
        .skill-years {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: auto;
        }
        
        /* Network styles */
        .node circle {
            stroke: #fff;
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .node.dimmed circle {
            opacity: 0.2;
        }
        
        .node.highlighted circle {
            stroke-width: 4px;
            filter: brightness(1.3);
        }
        
        .node text {
            font-size: 11px;
            pointer-events: none;
            text-shadow: 0 0 4px #000, 0 0 4px #000, 0 0 4px #000;
            fill: #e0e0e0;
            display: block;
        }
        
        .node text.hidden {
            display: none;
        }
        
        .node.role text {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .node.center text {
            font-size: 16px;
            font-weight: bold;
            fill: #60a5fa;
            text-shadow: 0 0 6px #000, 0 0 6px #000;
        }
        
        .node.skill text {
            font-size: 10px;
        }
        
        .link {
            stroke: #4a5568;
            stroke-opacity: 0.3;
            stroke-width: 1.5px;
            fill: none;
        }
        
        .link.dimmed {
            opacity: 0.1;
        }
        
        .link.highlighted {
            stroke: #60a5fa;
            stroke-opacity: 0.8;
            stroke-width: 2.5px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(26, 26, 46, 0.98);
            border: 1px solid #60a5fa;
            border-radius: 8px;
            padding: 15px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 350px;
            font-size: 13px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .tooltip-title {
            font-weight: bold;
            color: #60a5fa;
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .tooltip-level {
            color: #fbbf24;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .tooltip-roles {
            color: #d1d5db;
            line-height: 1.6;
        }
        
        .tooltip-role-tag {
            display: inline-block;
            background: rgba(96, 165, 250, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            margin: 2px;
            font-size: 11px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a2e;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            padding: 0;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            width: 90%;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 30px 30px 20px 30px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(26, 26, 46, 0.6) 100%);
        }
        
        .modal-header-left {
            flex: 1;
        }
        
        .modal-title {
            font-size: 1.8em;
            color: #60a5fa;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .modal-subtitle {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .modal-level-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .modal-level-badge.mastery {
            background: #ef4444;
            color: #fff;
        }
        
        .modal-level-badge.advanced {
            background: #f59e0b;
            color: #fff;
        }
        
        .modal-level-badge.proficient {
            background: #10b981;
            color: #fff;
        }
        
        .modal-years {
            color: #9ca3af;
            font-size: 0.9em;
        }
        
        .modal-core-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
        }
        
        .modal-category-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: 600;
            border: 1px solid currentColor;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-section {
            margin-bottom: 30px;
        }
        
        .modal-section:last-child {
            margin-bottom: 0;
        }
        
        .modal-section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-section-icon {
            font-size: 1.2em;
        }
        
        .evidence-list {
            list-style: none;
            padding: 0;
        }
        
        .evidence-item {
            background: rgba(96, 165, 250, 0.05);
            border-left: 3px solid #60a5fa;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            line-height: 1.6;
        }
        
        .evidence-item strong {
            color: #60a5fa;
        }
        
        .story-text {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            line-height: 1.7;
            color: #d1d5db;
        }
        
        .roles-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .role-tag {
            background: rgba(96, 165, 250, 0.2);
            border: 1px solid rgba(96, 165, 250, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .related-skills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .related-skill-chip {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .related-skill-chip:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: translateY(-2px);
        }
        
        .placeholder-text {
            color: #6b7280;
            font-style: italic;
            font-size: 0.9em;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .export-option {
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-option:hover {
            background: rgba(96, 165, 250, 0.2);
            transform: translateY(-2px);
        }
        
        .export-option-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .export-option-desc {
            font-size: 0.85em;
            color: #9ca3af;
        }
        
        /* ===== MOBILE RESPONSIVENESS ===== */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .header-left h1 {
                font-size: 1.3em;
            }
            
            .header-right {
                width: 100%;
                flex-direction: column;
                gap: 10px;
            }
            
            .view-toggle {
                width: 100%;
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            .view-toggle button {
                font-size: 0.85em;
                padding: 8px 12px;
                flex: 0 1 auto;
            }
            
            .export-btn {
                width: 100%;
                justify-content: center;
            }
            
            .controls {
                flex-direction: column;
                padding: 15px;
            }
            
            .filter-group {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .role-chip {
                font-size: 0.75em;
                padding: 6px 10px;
            }
            
            .opportunities-grid {
                grid-template-columns: 1fr;
            }
            
            .opportunity-card {
                padding: 15px;
            }
            
            .opportunity-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
            
            .values-grid {
                grid-template-columns: 1fr;
            }
            
            .blueprint-section {
                padding: 20px;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .export-btn-large {
                width: 100%;
            }
            
            /* Network view adjustments for mobile */
            #networkView {
                touch-action: pan-x pan-y;
            }
            
            .network-controls {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .label-toggle {
                font-size: 0.75em;
            }
        }
        
        @media (max-width: 480px) {
            .header-left h1 {
                font-size: 1.1em;
            }
            
            .header-left .subtitle {
                font-size: 0.75em;
            }
            
            .view-toggle button {
                font-size: 0.75em;
                padding: 6px 10px;
            }
            
            .filter-label {
                font-size: 0.7em;
            }
            
            .role-chip {
                font-size: 0.7em;
                padding: 5px 8px;
            }
            
            .blueprint-title {
                font-size: 1.8em;
            }
            
            .blueprint-subtitle {
                font-size: 1em;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
        
        /* Overflow Menu Styles */
        .overflow-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(30, 30, 40, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            min-width: 200px;
            z-index: 1000;
            padding: 8px 0;
        }
        
        .overflow-menu button {
            width: 100%;
            text-align: left;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .overflow-menu button:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        #overflowMenuBtn.active {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Skills View Tabs */
        .skills-view-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .skills-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .skills-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #d1d5db;
        }
        
        .skills-tab.active {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            color: white;
        }
        
        /* Quick Action Bar */
        .quick-action-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .quick-action-bar .btn-primary {
            padding: 10px 16px;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .quick-action-bar .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
        }
        
        .quick-action-bar .btn-secondary {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action-bar .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Bulk Selection Mode */
        .bulk-mode-bar {
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.3);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .skill-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .settings-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
        }
        
        .settings-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #d1d5db;
        }
        
        .settings-tab.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        /* Skill Management Styles */
        .onet-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
        }
        
        .onet-tab:hover {
            color: #d1d5db;
        }
        
        .onet-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }
        
        .onet-category {
            margin-bottom: 20px;
        }
        
        .onet-category-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .onet-category-title:hover {
            color: #93c5fd;
        }
        
        .onet-subcategory {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .onet-subcategory-title {
            font-size: 0.95em;
            font-weight: 500;
            color: #9ca3af;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .onet-skill-item {
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        
        .onet-skill-item:hover:not(.disabled) {
            background: rgba(255,255,255,0.08);
            border-color: rgba(96, 165, 250, 0.3);
        }
        
        .onet-skill-item.selected {
            background: rgba(96, 165, 250, 0.15);
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .onet-skill-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .onet-skill-checkbox {
            margin-top: 2px;
            cursor: pointer;
        }
        
        .onet-skill-checkbox:disabled {
            cursor: not-allowed;
        }
        
        .onet-skill-content {
            flex: 1;
        }
        
        .onet-skill-name {
            font-weight: 600;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .onet-skill-definition {
            font-size: 0.9em;
            color: #9ca3af;
            line-height: 1.4;
        }
        
        .onet-skill-added {
            font-size: 0.8em;
            color: #10b981;
            font-weight: 600;
        }
        
        /* Skill Search Results (v2.3.0) */
        .skill-search-result {
            transition: all 0.2s ease;
        }
        
        .skill-search-result:not(.added):hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .skill-search-result.added {
            opacity: 0.6;
        }
        
        /* Unified Skill Management (v2.4.0) */
        .skill-mgmt-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #9ca3af;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .skill-mgmt-tab:hover {
            color: #e0e0e0;
            background: rgba(255,255,255,0.05);
        }
        
        .skill-mgmt-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .skill-mgmt-content {
            animation: fadeIn 0.2s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .your-skill-item {
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            border-left: 3px solid #60a5fa;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        
        .your-skill-item:hover {
            background: rgba(255,255,255,0.06);
            transform: translateX(4px);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1><span id="userName">Your</span> Work Blueprint</h1>
            <div class="subtitle">
                <span id="statsBar">Loading...</span>
            </div>
        </div>
        <div class="header-right" style="position: relative;">
            <!-- Profile Selector (Admin) - Populated dynamically from manifest -->
            <div style="margin-bottom: 10px; padding: 8px 12px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); border-radius: 6px; border: 2px solid #60a5fa;">
                <label style="color: #fff; font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">ðŸ“‹ ADMIN: Profile</label>
                <select id="profileSelector" onchange="switchProfile(this.value)" style="width: 100%; padding: 6px 10px; border: 1px solid #60a5fa; border-radius: 4px; background: #0f172a; color: #fff; font-size: 14px; font-weight: 500; cursor: pointer;">
                    <!-- Options populated dynamically from profiles-manifest.json -->
                </select>
            </div>
            
            <div class="view-toggle">
                <button class="active" onclick="switchView('skills', event)">ðŸŽ¯ Skills</button>
                <button onclick="switchView('jobs', event)">ðŸ’¼ Jobs</button>
                <button onclick="switchView('applications', event)">ðŸ“‹ Applications</button>
                <button onclick="switchView('blueprint', event)">ðŸ“ Work Blueprint</button>
                <button onclick="toggleOverflowMenu(event)" id="overflowMenuBtn">â‹¯ More</button>
            </div>
            <!-- Overflow Menu Dropdown -->
            <div id="overflowMenu" class="overflow-menu" style="display: none;">
                <button onclick="switchView('settings', event); closeOverflowMenu();">âš™ï¸ Settings</button>
                <button onclick="openExportModal(); closeOverflowMenu();">ðŸ“„ Export Profile</button>
                <button onclick="generateWorkBlueprint(); closeOverflowMenu();">ðŸ“ Generate Work Blueprint</button>
                <button onclick="switchView('consent'); closeOverflowMenu();">ðŸ”’ Consent Settings</button>
                <button onclick="showHelp(); closeOverflowMenu();">â“ Help</button>
                <button onclick="showAbout(); closeOverflowMenu();">â„¹ï¸ About</button>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <div class="controls-left">
            <div class="filter-group" id="skillsViewToggle" style="display: flex;">
                <span class="filter-label">VIEW:</span>
                <div class="role-chip active" data-view="network" onclick="toggleSkillsView('network')">Network</div>
                <div class="role-chip" data-view="card" onclick="toggleSkillsView('card')">Card</div>
            </div>
            
            <div class="filter-group" style="flex: 1; max-width: 300px;">
                <span class="filter-label">SEARCH:</span>
                <input type="text" id="skillSearch" placeholder="Search skills..." 
                       onkeyup="filterSkillsView(this.value)"
                       style="
                           width: 100%;
                           padding: 8px 12px;
                           background: rgba(255, 255, 255, 0.05);
                           border: 1px solid rgba(96, 165, 250, 0.3);
                           border-radius: 6px;
                           color: #e0e0e0;
                           font-size: 0.9em;
                       ">
            </div>
            
            <div class="filter-group" id="rolesFilterGroup">
                <span class="filter-label">ROLES:</span>
                <div id="roleChipsContainer">
                    <div class="role-chip active" data-role="all" onclick="filterByRole('all')">All</div>
                </div>
            </div>
            
            <div class="filter-group">
                <span class="filter-label">LEVELS:</span>
                <div class="level-filter" id="levelChipsContainer">
                    <!-- Rendered dynamically by renderFilterChips() -->
                </div>
            </div>
        </div>
        
        <div class="controls-right" id="networkControls" style="display: flex;">
            <div class="label-toggle">
                <span class="toggle-label">Role Labels</span>
                <label class="toggle-switch">
                    <input type="checkbox" checked onchange="toggleLabels('role')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="label-toggle">
                <span class="toggle-label">Skill Labels</span>
                <label class="toggle-switch">
                    <input type="checkbox" checked onchange="toggleLabels('skill')">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <svg id="networkView"></svg>
        <div id="cardView"></div>
        <div id="opportunitiesView"></div>
        <div id="applicationsView"></div>
        <div id="blueprintView"></div>
        <div id="consentView"></div>
        <div id="settingsView"></div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <!-- Skill Detail Modal -->
    <div class="modal" id="skillModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title" id="skillDetailTitle"></h2>
                    <div class="modal-subtitle" id="skillDetailSubtitle"></div>
                </div>
                <button class="modal-close" onclick="closeSkillModal()">Ã—</button>
            </div>
            <div class="modal-body" id="skillDetailBody"></div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Export Profile</h2>
                </div>
                <button class="modal-close" onclick="closeExportModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="color: #9ca3af; margin-bottom: 20px;">Select a format to export your skills profile:</p>
                <div class="export-options">
                    <div class="export-option" onclick="exportProfile('resume')">
                        <div class="export-option-title">ðŸ“„ Resume</div>
                        <div class="export-option-desc">Professional resume Â· print to PDF</div>
                    </div>
                    <div class="export-option" onclick="exportProfile('capability')">
                        <div class="export-option-title">ðŸŽ¯ Capability Statement</div>
                        <div class="export-option-desc">One-page overview</div>
                    </div>
                    <div class="export-option" onclick="exportProfile('linkedin')">
                        <div class="export-option-title">ðŸ’¼ LinkedIn Profile</div>
                        <div class="export-option-desc">Profile sections</div>
                    </div>
                    <div class="export-option" onclick="exportProfile('interview')">
                        <div class="export-option-title">ðŸ’¬ Interview Prep</div>
                        <div class="export-option-desc">STAR stories</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- O*NET Skill Picker Modal -->
    <div class="modal" id="onetPickerModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Add Skills from O*NET Library</h2>
                </div>
                <button class="modal-close" onclick="closeONETPicker()">Ã—</button>
            </div>
            <div class="modal-body" style="overflow-y: auto;">
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid rgba(255,255,255,0.1);">
                        <button id="onetTabSkills" class="onet-tab active" onclick="switchONETTab('skills')">
                            Skills (35)
                        </button>
                        <button id="onetTabAbilities" class="onet-tab" onclick="switchONETTab('abilities')">
                            Abilities (52)
                        </button>
                        <button id="onetTabWorkStyles" class="onet-tab" onclick="switchONETTab('workstyles')">
                            Work Styles (16)
                        </button>
                    </div>
                    <input type="text" id="onetSearchInput" placeholder="Search O*NET library..." 
                           class="settings-input" oninput="filterONETLibrary()" style="width: 100%; margin-bottom: 15px;">
                </div>
                <div id="onetLibraryContent" style="max-height: 400px; overflow-y: auto;">
                    <!-- Populated by JavaScript -->
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span id="onetSelectedCount" style="color: #9ca3af;"></span>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="closeONETPicker()" style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="addSelectedONETSkills()" id="onetAddButton" 
                                    style="padding: 10px 20px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Add Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Skill Builder Modal -->
    <div class="modal" id="customSkillModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Create Custom Skill</h2>
                </div>
                <button class="modal-close" onclick="closeCustomSkillBuilder()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Skill Name *</label>
                    <input type="text" id="customSkillName" class="settings-input" placeholder="e.g., Quantum Computing Strategy">
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Proficiency Level *</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Novice" style="margin-right: 5px;">
                            Novice
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Proficient" style="margin-right: 5px;">
                            Proficient
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Advanced" checked style="margin-right: 5px;">
                            Advanced
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Expert" style="margin-right: 5px;">
                            Expert
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="customSkillLevel" value="Mastery" style="margin-right: 5px;">
                            Mastery
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Used in Roles *</label>
                    <div id="customSkillRoles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="settings-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="customSkillCore">
                        <span class="settings-label" style="margin: 0;">Mark as Core Differentiator</span>
                    </label>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <button onclick="closeCustomSkillBuilder()" 
                            style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="createCustomSkill()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Create Skill
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Skill Modal -->
    <div class="modal" id="editSkillModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Edit Skill</h2>
                </div>
                <button class="modal-close" onclick="closeEditSkillModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="settings-group">
                    <label class="settings-label">Skill Name</label>
                    <input type="text" id="editSkillName" class="settings-input" readonly style="background: rgba(255,255,255,0.05);">
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Proficiency Level *</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Novice" style="margin-right: 5px;">
                            Novice
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Proficient" style="margin-right: 5px;">
                            Proficient
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Advanced" style="margin-right: 5px;">
                            Advanced
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Expert" style="margin-right: 5px;">
                            Expert
                        </label>
                        <label style="cursor: pointer; text-align: center;">
                            <input type="radio" name="editSkillLevel" value="Mastery" style="margin-right: 5px;">
                            Mastery
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Used in Roles *</label>
                    <div id="editSkillRoles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <div class="settings-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="editSkillCore">
                        <span class="settings-label" style="margin: 0;">Mark as Core Differentiator</span>
                    </label>
                </div>
                
                <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                    <button onclick="closeEditSkillModal()" 
                            style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveSkillEdit()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Assessment Modal (for unique skills) -->
    <div class="modal" id="assessSkillModal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Assess Skill Impact</h2>
                </div>
                <button class="modal-close" onclick="closeAssessSkillModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="coaching-tip" style="margin-bottom: 25px;">
                    <div class="coaching-tip-title">
                        ðŸ’¡ WHY ASSESS THIS SKILL?
                    </div>
                    <div class="coaching-tip-content">
                        This skill doesn't have a direct O*NET match. Answer a few questions so we can accurately rate its market impact.
                    </div>
                </div>
                
                <div id="assessSkillName" style="font-size: 1.2em; font-weight: 600; margin-bottom: 25px; color: #fbbf24;"></div>
                
                <div class="settings-group">
                    <label class="settings-label">How many years of experience do you have with this skill? *</label>
                    <input type="number" id="assessYears" class="settings-input" min="0" max="50" value="5" 
                           style="width: 120px;">
                    <div class="settings-help">More experience generally indicates higher impact</div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">Impact on business outcomes: *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessImpact" value="minor">
                            <div>
                                <div style="font-weight: 600;">Minor Impact</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Supports work but doesn't directly drive major outcomes</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessImpact" value="significant" checked>
                            <div>
                                <div style="font-weight: 600;">Significant Impact</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Directly contributes to key business results</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessImpact" value="major">
                            <div>
                                <div style="font-weight: 600;">Major Impact</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Critical differentiator, drives strategic outcomes</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">How common is this skill in the market? *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessRarity" value="common">
                            <div>
                                <div style="font-weight: 600;">Common</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Many professionals have this skill</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessRarity" value="uncommon" checked>
                            <div>
                                <div style="font-weight: 600;">Uncommon</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Specialized, not widely held</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessRarity" value="rare">
                            <div>
                                <div style="font-weight: 600;">Rare</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Very few people have this expertise</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <label class="settings-label">This skill is typically used in roles paying: *</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessSalary" value="<$150k">
                            <div>
                                <div style="font-weight: 600;">Under $150k</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Mid-level to senior roles</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessSalary" value="$150-250k" checked>
                            <div>
                                <div style="font-weight: 600;">$150k - $250k</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">Director to VP level</div>
                            </div>
                        </label>
                        <label style="cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                            <input type="radio" name="assessSalary" value=">$250k">
                            <div>
                                <div style="font-weight: 600;">Over $250k</div>
                                <div style="font-size: 0.9em; color: #9ca3af;">VP to C-Suite level</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div id="assessmentPreview" style="color: #9ca3af; font-size: 0.9em;"></div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="closeAssessSkillModal()" 
                                style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="saveSkillAssessment()" 
                                style="padding: 10px 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            Save Assessment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skill Search Modal (v2.3.0) -->
    <!-- Unified Skill Management Modal (v2.4.0) -->
    <div class="modal" id="skillManagementModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-header-left">
                    <h2 class="modal-title">Manage Skills</h2>
                    <p style="color: #9ca3af; margin-top: 5px; font-size: 0.9em;">
                        <span id="skillManagementCount">Loading...</span>
                    </p>
                </div>
                <button class="modal-close" onclick="closeSkillManagement()">Ã—</button>
            </div>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 10px; padding: 0 20px; border-bottom: 2px solid rgba(255,255,255,0.1);">
                <button id="yourSkillsTab" class="skill-mgmt-tab active" onclick="switchSkillManagementTab('yours')">
                    ðŸ“Š Your Skills (<span id="yourSkillsCount">0</span>)
                </button>
                <button id="addSkillsTab" class="skill-mgmt-tab" onclick="switchSkillManagementTab('add')">
                    âž• Add Skills (<span id="availableSkillsCount">2,138</span>)
                </button>
            </div>
            
            <div class="modal-body" style="padding: 20px; overflow-y: auto; max-height: calc(90vh - 200px);">
                
                <!-- YOUR SKILLS TAB -->
                <div id="yourSkillsContent" class="skill-mgmt-content">
                    <div style="position: relative; margin-bottom: 20px;">
                        <input 
                            type="text" 
                            id="yourSkillsSearchInput" 
                            class="settings-input" 
                            placeholder="Search your skills..."
                            style="width: 100%; padding-right: 40px;"
                            oninput="filterYourSkills()">
                        <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 1.2em;">
                            ðŸ”
                        </span>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="yourSkillsCategoryFilter" onchange="filterYourSkills()" style="padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            <option value="all">All Categories</option>
                            <option value="skill">Technology</option>
                            <option value="ability">General Professional</option>
                            <option value="workstyle">Work Styles</option>
                            <option value="unique">Custom Skills</option>
                        </select>
                        
                        <select id="yourSkillsLevelFilter" onchange="filterYourSkills()" style="padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            <option value="all">All Levels</option>
                            <option value="Mastery">Mastery</option>
                            <option value="Expert">Expert</option>
                            <option value="Advanced">Advanced</option>
                            <option value="Proficient">Proficient</option>
                            <option value="Novice">Novice</option>
                        </select>
                    </div>
                    
                    <div id="yourSkillsList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
                
                <!-- ADD SKILLS TAB -->
                <div id="addSkillsContent" class="skill-mgmt-content" style="display: none;">
                    <div style="position: relative; margin-bottom: 20px;">
                        <input 
                            type="text" 
                            id="addSkillsSearchInput" 
                            class="settings-input" 
                            placeholder="Search 2,138 skills to add... (e.g., 'python', 'marketing', 'leadership')"
                            style="width: 100%; padding-right: 40px; font-size: 1.1em;"
                            oninput="handleAddSkillsSearch()"
                            autofocus>
                        <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 1.2em;">
                            ðŸ”
                        </span>
                    </div>
                    
                    <div id="addSkillsResults" style="min-height: 200px;">
                        <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                            <div style="font-size: 3em; margin-bottom: 10px;">ðŸ”</div>
                            <div style="font-size: 1.1em;">Start typing to search skills</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">Try: "python", "marketing", "leadership"</div>
                        </div>
                    </div>
                    
                    <div id="addSkillsCategories" style="margin-top: 25px;">
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px; font-weight: 600;">
                            BROWSE BY CATEGORY:
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button onclick="searchAddSkillsByCategory('Technology')" 
                                    style="padding: 8px 16px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); color: #60a5fa; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                ðŸ’» Technology
                            </button>
                            <button onclick="searchAddSkillsByCategory('Business')" 
                                    style="padding: 8px 16px; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); color: #a78bfa; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                ðŸ’¼ Business
                            </button>
                            <button onclick="searchAddSkillsByCategory('Finance')" 
                                    style="padding: 8px 16px; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); color: #10b981; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                ðŸ’° Finance
                            </button>
                            <button onclick="searchAddSkillsByCategory('Marketing')" 
                                    style="padding: 8px 16px; background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); color: #fbbf24; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                ðŸ“¢ Marketing
                            </button>
                            <button onclick="searchAddSkillsByCategory('Creative')" 
                                    style="padding: 8px 16px; background: rgba(249, 115, 22, 0.2); border: 1px solid rgba(249, 115, 22, 0.4); color: #fb923c; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                ðŸŽ¨ Creative
                            </button>
                            <button onclick="searchAddSkillsByCategory('Leadership')" 
                                    style="padding: 8px 16px; background: rgba(100, 116, 139, 0.2); border: 1px solid rgba(100, 116, 139, 0.4); color: #94a3b8; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                â­ Leadership
                            </button>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <div style="padding: 15px 20px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="color: #9ca3af; font-size: 0.85em;">
                        <span id="skillManagementStatus"></span>
                    </div>
                    <button onclick="closeSkillManagement()" 
                            style="padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // WORK BLUEPRINT v3.5.2 - BUILD 20260218-1100
        // PREMIUM: 5-Factor Comprehensive Premium Calculation
        // ============================================================
        console.log('%c==============================================', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c   WORK BLUEPRINT v3.5.2                    ', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c   Build: 20260218-0600                     ', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c   Everyone Has Premium Value!              ', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        console.log('%c==============================================', 'color: #60a5fa; font-weight: bold; font-size: 14px;');
        
        // ===== USER DATA CONFIGURATION =====
        // This will eventually come from onboarding wizard
        
        // userData now defined in v2.0 architecture below (line ~2224)
        
        // ===== MARKET VALUATION CALCULATOR =====
        
        function calculateSkillValue(skill) {
            // Now returns IMPACT rating, not dollar value
            return getSkillImpact(skill);
        }
        
        function calculateTotalMarketValue() {
            if (!skillsData || !skillsData.skills) {
                return { 
                    total: 0, 
                    yourWorth: 0,
                    marketRate: 0,
                    conservativeOffer: 0,
                    standardOffer: 0,
                    competitiveOffer: 0,
                    breakdown: [], 
                    roleLevel: 'Entry',
                    top10Skills: [],
                    totalPoints: 0,
                    compaRatio: 100,
                    criticalSkills: [],
                    highSkills: [],
                    criticalBonus: 0,
                    highBonus: 0,
                    rarityBonus: 0,
                    premiumAmount: 0
                };
            }
            
            // REDESIGNED MODEL: Realistic premiums based on skill mix percentage
            
            // Step 1: Calculate base value from role tier (based on proficiency distribution)
            const masteryCount = skillsData.skills.filter(s => s.level === 'Mastery').length;
            const expertCount = skillsData.skills.filter(s => s.level === 'Expert').length;
            const advancedCount = skillsData.skills.filter(s => s.level === 'Advanced').length;
            const proficientCount = skillsData.skills.filter(s => s.level === 'Proficient').length;
            const totalSkills = skillsData.skills.length;
            
            // Updated point system:
            // Mastery (40+ yrs mastery): 4 points
            // Expert (20-40 yrs expertise): 3 points
            // Advanced (10-20 yrs strong): 2 points
            // Proficient (5-10 yrs competent): 1 point
            // Novice (0-5 yrs learning): 0 points
            const totalPoints = (masteryCount * 4) + (expertCount * 3) + (advancedCount * 2) + (proficientCount * 1);
            
            let baseMarketRate = 0;
            let roleLevel = '';
            let percentile = '50th'; // Default to median
            
            // Adjusted thresholds for 5-level system
            if (totalPoints >= 100) {
                baseMarketRate = 280000; // Executive/C-Suite (Cliff: 230 pts)
                roleLevel = 'VP/C-Suite';
                percentile = '75th';
            } else if (totalPoints >= 40) {
                baseMarketRate = 165000; // Senior Management (Mike: 49 pts)
                roleLevel = 'Senior Director';
            } else if (totalPoints >= 30) {
                baseMarketRate = 110000; // Director level (Sarah: 36 pts)
                roleLevel = 'Director';
            } else if (totalPoints >= 20) {
                baseMarketRate = 55000; // Mid-level professional (Jamie: 28 pts)
                roleLevel = 'Mid-Level Professional';
            } else if (totalPoints >= 10) {
                baseMarketRate = 38000; // Entry-level professional (Alex: 17 pts)
                roleLevel = 'Entry Professional';
            } else {
                baseMarketRate = 30000; // Entry level
                roleLevel = 'Entry Level';
            }
            
            // Step 2: Calculate comprehensive premium using 5-factor system
            
            // FACTOR 1: Work Styles & Soft Skills (20-30% max)
            const workStyleSkills = skillsData.skills.filter(s => 
                s.category === 'workstyle' && (s.level === 'Advanced' || s.level === 'Expert' || s.level === 'Mastery')
            );
            const workStylesPct = Math.min((workStyleSkills.length * 0.015), 0.30); // 1.5% per skill, max 30%
            
            // FACTOR 2: Evidence Quality (30-40% max)
            let evidenceScore = 0;
            skillsData.skills.forEach(skill => {
                if (skill.evidence && skill.evidence.length > 0) {
                    skill.evidence.forEach(ev => {
                        // Has quantified outcome (numbers, %, $)
                        if (ev.outcome && (ev.outcome.match(/\d+%|\$\d+|[0-9,]+/) || ev.outcome.includes('reduced') || ev.outcome.includes('increased'))) {
                            evidenceScore += 2; // High-quality evidence
                        } else if (ev.outcome) {
                            evidenceScore += 1; // Basic evidence
                        }
                    });
                }
            });
            const evidenceQualityPct = Math.min((evidenceScore * 0.005), 0.40); // 0.5% per quality point, max 40%
            
            // FACTOR 3: Skill Mix Rarity (15-25% max)
            let rarityPct = 0;
            const hasAI = skillsData.skills.some(s => s.name.toLowerCase().includes('ai') || s.name.toLowerCase().includes('machine learning'));
            const hasPilot = skillsData.skills.some(s => s.name.toLowerCase().includes('aviation') || s.name.toLowerCase().includes('ifr'));
            const hasStrategy = skillsData.skills.some(s => s.name.toLowerCase().includes('strategic'));
            const hasTechnical = skillsData.skills.some(s => s.category === 'skill' && s.name.toLowerCase().includes('programming'));
            const hasLeadership = skillsData.skills.some(s => s.name.toLowerCase().includes('leadership') || s.name.toLowerCase().includes('management'));
            const hasCreative = skillsData.skills.some(s => s.name.toLowerCase().includes('color') || s.name.toLowerCase().includes('styling') || s.name.toLowerCase().includes('creative'));
            const hasBehavioral = skillsData.skills.some(s => s.name.toLowerCase().includes('behavioral') || s.name.toLowerCase().includes('economics'));
            
            // Rare combinations add premium
            if (hasPilot && hasStrategy) rarityPct += 0.10; // Very rare: Aviation + Strategy
            if (hasAI && hasStrategy) rarityPct += 0.05; // Rare: AI + Strategy
            if (hasTechnical && hasLeadership) rarityPct += 0.05; // Valuable: Tech + Leadership
            if (hasCreative && hasTechnical) rarityPct += 0.08; // Uncommon: Creative + Technical
            if (hasBehavioral && hasStrategy) rarityPct += 0.05; // Rare: Behavioral Econ + Strategy
            rarityPct = Math.min(rarityPct, 0.25); // Max 25%
            
            // FACTOR 4: Critical Depth (10-15% max)
            const masteryInCriticalSkills = skillsData.skills.filter(s => {
                const impact = getSkillImpact(s);
                return (s.level === 'Mastery' || s.level === 'Expert') && (impact.level === 'critical' || impact.level === 'high');
            });
            const criticalDepthPct = Math.min((masteryInCriticalSkills.length * 0.02), 0.15); // 2% per critical mastery, max 15%
            
            // FACTOR 5: Learning & Growth (10-15% max)
            const noviceSkills = skillsData.skills.filter(s => s.level === 'Novice');
            const learningPct = Math.min((noviceSkills.length * 0.02), 0.15); // 2% per novice skill (shows growth), max 15%
            
            // Total premium percentage
            const totalPremiumPct = workStylesPct + evidenceQualityPct + rarityPct + criticalDepthPct + learningPct;
            
            // Calculate dollar amounts for breakdown
            const workStylesBonus = Math.round(baseMarketRate * workStylesPct);
            const evidenceBonus = Math.round(baseMarketRate * evidenceQualityPct);
            const rarityBonus = Math.round(baseMarketRate * rarityPct);
            const criticalDepthBonus = Math.round(baseMarketRate * criticalDepthPct);
            const learningBonus = Math.round(baseMarketRate * learningPct);
            const premiumAmount = workStylesBonus + evidenceBonus + rarityBonus + criticalDepthBonus + learningBonus;
            
            // Step 3: Location adjustment
            const locationMultiplier = skillValuations?.locationMultipliers?.[userData.profile.location] || 1.0;
            
            const totalValue = Math.round((baseMarketRate + premiumAmount) * locationMultiplier);
            
            // Calculate offer ranges
            const conservativeOffer = Math.round(totalValue * 0.75);
            const standardOffer = Math.round(totalValue * 0.85);
            const competitiveOffer = Math.round(totalValue * 0.95);
            
            // Build critical/high skills for compatibility
            const criticalSkills = skillsData.skills.filter(s => {
                const impact = getSkillImpact(s);
                return impact.level === 'critical';
            });
            
            const highSkills = skillsData.skills.filter(s => {
                const impact = getSkillImpact(s);
                return impact.level === 'high';
            });
            
            // Build top10Skills for compatibility
            const top10Skills = [
                ...criticalSkills.slice(0, 5).map(s => ({ skill: s.name, level: s.level, impact: 'Critical', impactLabel: 'Critical Impact' })),
                ...highSkills.slice(0, 5).map(s => ({ skill: s.name, level: s.level, impact: 'High', impactLabel: 'High Impact' }))
            ].slice(0, 10);
            
            // Calculate compa-ratio (your worth vs base market rate)
            const compaRatio = baseMarketRate > 0 ? Math.round((totalValue / baseMarketRate) * 100) : 100;
            
            return {
                // New structure
                total: totalValue,
                baseMarketRate: baseMarketRate,
                roleLevel: roleLevel,
                criticalSkills: criticalSkills.map(s => ({ name: s.name, level: s.level })),
                highSkills: highSkills.map(s => ({ name: s.name, level: s.level })),
                
                // NEW: Premium breakdown
                workStylesBonus: workStylesBonus,
                evidenceBonus: evidenceBonus,
                rarityBonus: rarityBonus,
                criticalDepthBonus: criticalDepthBonus,
                learningBonus: learningBonus,
                
                // Backward compatibility
                criticalBonus: criticalDepthBonus, // Map to new system
                highBonus: evidenceBonus, // Map to new system
                
                // Backward compatibility fields
                yourWorth: totalValue,
                marketRate: baseMarketRate,
                conservativeOffer: conservativeOffer,
                standardOffer: standardOffer,
                competitiveOffer: competitiveOffer,
                top10Skills: top10Skills,
                totalPoints: totalPoints,
                compaRatio: compaRatio,
                premiumAmount: premiumAmount,
                domainPremium: totalPremiumPct, // Now this is a proper percentage (0-0.60)
                percentile: percentile, // 50th or 75th based on role level
                
                breakdown: {
                    base: baseMarketRate,
                    critical: criticalDepthBonus,
                    high: evidenceBonus,
                    rarity: rarityBonus,
                    location: locationMultiplier
                }
            };
        }
        
        function getClosestRoleBenchmark(calculatedValue) {
            if (!skillValuations || !skillValuations.roleBenchmarks) {
                return null;
            }
            
            let closest = null;
            let minDiff = Infinity;
            
            Object.entries(skillValuations.roleBenchmarks).forEach(([role, data]) => {
                const diff = Math.abs(data.median - calculatedValue);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = { role, ...data };
                }
            });
            
            return closest;
        }
        
        // ===== SKILL VALUATIONS SYSTEM =====
        let skillValuations = {
            skillBaseValues: {},
            proficiencyMultipliers: { 
                "Novice": 0.7, 
                "Proficient": 1.0, 
                "Advanced": 1.5, 
                "Expert": 1.9, 
                "Mastery": 2.2 
            },
            locationMultipliers: {},
            demandFactors: {},
            rarityBonuses: {},
            roleBenchmarks: {}
        };
        
        // Load skill valuations from JSON
        fetch('skill_valuations.json')
            .then(response => response.json())
            .then(data => {
                skillValuations = data;
                console.log('âœ… Skill valuations loaded');
                // Recalculate values if already rendered
                if (document.getElementById('totalMarketValue')) {
                    updateMarketValueDisplay();
                }
            })
            .catch(error => {
                console.warn('âš ï¸ Could not load skill valuations, using defaults:', error);
            });
        
        // Data structure
        const skillsData = {
            roles: [
                { id: "strategy", name: "VP Global Strategy", icon: "ðŸŽ¯", color: "#ef4444" },
                { id: "futurist", name: "Futurist & Evangelist", icon: "ðŸ”®", color: "#f59e0b" },
                { id: "pilot", name: "IFR Pilot", icon: "âœˆï¸", color: "#3b82f6" },
                { id: "musician", name: "Musician", icon: "ðŸŽµ", color: "#8b5cf6" },
                { id: "advocate", name: "Recovery Advocate", icon: "ðŸ’š", color: "#10b981" },
                { id: "tech", name: "Technology Strategist", icon: "âš™ï¸", color: "#06b6d4" },
                { id: "creative", name: "Creative Director", icon: "ðŸŽ¨", color: "#ec4899" },
                { id: "operations", name: "Operations Leader", icon: "ðŸ”", color: "#f97316" },
                { id: "entrepreneur", name: "Entrepreneur", icon: "ðŸš€", color: "#a855f7" }
            ],
            
            skills: [
                // Strategic Core
                { name: "Enterprise AI Strategy", level: "Mastery", roles: ["strategy", "futurist", "tech"], key: false },
                { name: "Go-to-Market Strategy", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "Business Case Development", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "C-Suite Advisory & Influence", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Customer Advisory Board Leadership", level: "Mastery", roles: ["strategy"], key: false },
                { name: "Strategic Foresight & Market Prediction", level: "Mastery", roles: ["strategy", "futurist"], key: true },
                { name: "Organizational Transformation", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "Risk Assessment & Mitigation", level: "Mastery", roles: ["strategy", "pilot", "operations", "entrepreneur"], key: false },
                { name: "Revenue Pipeline Development", level: "Advanced", roles: ["strategy", "operations", "entrepreneur"], key: false },
                { name: "Financial Management & Budget Discipline", level: "Proficient", roles: ["strategy", "operations", "entrepreneur"], key: false },
                
                // Technology & Product
                { name: "AI/ML Product Strategy", level: "Mastery", roles: ["strategy", "tech", "futurist"], key: false },
                { name: "Talent Intelligence Platform Design", level: "Mastery", roles: ["strategy", "tech"], key: false },
                { name: "HR Technology Market Intelligence", level: "Mastery", roles: ["strategy", "futurist"], key: false },
                { name: "Technology Lifecycle & Disruption Analysis", level: "Mastery", roles: ["futurist", "tech"], key: false },
                { name: "Computational & Systems Thinking", level: "Advanced", roles: ["tech", "pilot"], key: false },
                { name: "Platform Integration Architecture", level: "Advanced", roles: ["tech", "entrepreneur"], key: false },
                { name: "Weak Signal Detection & Trend Recognition", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Spatial Reasoning & 3D Problem Solving", level: "Mastery", roles: ["pilot", "musician", "creative", "tech"], key: true },
                
                // Futurist & Innovation
                { name: "Technology Trend Forecasting", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Predictive Framework Development", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Disruptive Innovation Identification", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Scenario Planning & Strategic Alternatives", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Human-AI Collaboration Model Design", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                
                // Communication & Influence
                { name: "Executive Narrative & Storytelling", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Technical Concept Translation", level: "Mastery", roles: ["futurist", "tech", "strategy"], key: true },
                { name: "Public Speaking & Keynote Delivery", level: "Mastery", roles: ["futurist", "musician"], key: false },
                { name: "Thought Leadership Authorship", level: "Mastery", roles: ["futurist"], key: false },
                { name: "Rhetorical Strategy & Persuasion", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Media Relations & Spokesperson Work", level: "Mastery", roles: ["futurist"], key: false },
                { name: "Podcast Production & Hosting", level: "Advanced", roles: ["futurist", "musician"], key: false },
                { name: "Real-Time Improvisation", level: "Mastery", roles: ["musician", "futurist"], key: false },
                { name: "Industry Evangelism", level: "Mastery", roles: ["futurist"], key: false },
                { name: "Teaching & Knowledge Transfer", level: "Advanced", roles: ["futurist", "advocate"], key: false },
                
                // Domain Expertise
                { name: "Talent Acquisition Strategy", level: "Mastery", roles: ["strategy"], key: false },
                { name: "Candidate Experience Architecture", level: "Mastery", roles: ["strategy"], key: true },
                { name: "AI Ethics & Responsible Implementation", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Workforce Intelligence & Analytics", level: "Mastery", roles: ["strategy"], key: false },
                { name: "Talent Marketplace Dynamics", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Behavioral Economics in Talent", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Workforce Trends & Future of Work Analysis", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                { name: "Generational Workforce Analysis", level: "Advanced", roles: ["futurist", "strategy"], key: false },
                { name: "AI Impact on Human Work", level: "Mastery", roles: ["futurist", "strategy"], key: false },
                
                // Leadership & Interpersonal
                { name: "Enterprise Client Relationship Management", level: "Mastery", roles: ["strategy", "entrepreneur"], key: false },
                { name: "Strategic Team Building", level: "Advanced", roles: ["strategy", "operations", "tech", "entrepreneur"], key: false },
                { name: "Executive Mentorship", level: "Advanced", roles: ["strategy"], key: false },
                { name: "Multi-Stakeholder Alignment", level: "Advanced", roles: ["strategy", "tech", "entrepreneur"], key: false },
                { name: "Executive Presence & Authority", level: "Mastery", roles: ["strategy", "futurist"], key: false },
                { name: "Crisis Leadership & Decision Making", level: "Mastery", roles: ["pilot", "operations", "advocate", "strategy", "entrepreneur"], key: true },
                { name: "High-Pressure Performance", level: "Mastery", roles: ["pilot", "musician", "operations"], key: false },
                
                // Creative & Performance
                { name: "Creative Direction", level: "Mastery", roles: ["creative", "entrepreneur"], key: false },
                { name: "Live Musical Performance", level: "Mastery", roles: ["musician"], key: false },
                { name: "Music Composition & Arrangement", level: "Advanced", roles: ["musician"], key: false },
                { name: "Music Production & Artist Development", level: "Advanced", roles: ["musician"], key: false },
                { name: "Stage Command & Audience Connection", level: "Mastery", roles: ["musician", "futurist"], key: false },
                { name: "Performance Logistics", level: "Proficient", roles: ["musician"], key: false },
                
                // Aviation
                { name: "Single-Pilot IFR in Complex Airspace", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Single-Pilot Resource Management", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Weather Systems Analysis", level: "Advanced", roles: ["pilot"], key: false },
                { name: "ATC Communication & Coordination", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Emergency Airmanship", level: "Mastery", roles: ["pilot"], key: true },
                { name: "Aeronautical Decision Making Under Uncertainty", level: "Mastery", roles: ["pilot"], key: false },
                { name: "Situational Awareness in Dynamic Environments", level: "Mastery", roles: ["pilot", "operations"], key: false },
                { name: "Multi-Channel Cognitive Load Management", level: "Mastery", roles: ["pilot", "operations"], key: false },
                
                // Analytical & Research
                { name: "Data-Driven Strategy Development", level: "Advanced", roles: ["strategy", "tech"], key: false },
                { name: "Market & Competitive Intelligence", level: "Advanced", roles: ["strategy", "futurist"], key: false },
                { name: "Research Synthesis & Pattern Recognition", level: "Mastery", roles: ["futurist", "strategy"], key: true },
                { name: "Critical Analysis & Evaluation", level: "Advanced", roles: ["strategy", "tech", "futurist"], key: false },
                
                // Advocacy
                { name: "Leadership Through Lived Experience", level: "Mastery", roles: ["advocate"], key: false },
                { name: "Mental Health & Addiction Advocacy", level: "Mastery", roles: ["advocate"], key: false },
                { name: "Nonprofit Founding & Operations", level: "Advanced", roles: ["advocate", "entrepreneur"], key: false },
                { name: "Authentic Leadership & Trust Building", level: "Mastery", roles: ["advocate", "futurist"], key: true },
                { name: "Culture Change & Inclusion Initiatives", level: "Advanced", roles: ["advocate"], key: false },
                { name: "Complex Problem Diagnosis & Resolution", level: "Advanced", roles: ["advocate"], key: false }
            ],
            
            skillDetails: {} // Will be loaded from skill_evidence.json
        };
        
        // ===== v2.0: USER DATA MANAGEMENT SYSTEM =====
        
        let userData = {
            initialized: false,
            profile: {
                name: "",
                email: "",
                location: "Remote"
            },
            skills: [],
            skillDetails: {},
            values: [],
            purpose: "",
            roles: [],
            preferences: {
                seniorityLevel: "Mid-Career",
                targetTitles: [],
                seniorityKeywords: ['vp', 'vice president', 'chief', 'head of', 'director', 'principal', 'senior director'],
                excludeRoles: ['engineer', 'developer', 'designer', 'analyst', 'coordinator', 'specialist', 
                              'junior', 'mid-level', 'associate', 'intern', 'entry', 'qa', 'frontend', 'backend',
                              'full stack', 'fullstack', 'software', 'devops', 'ui/ux', 'data scientist'],
                strategicKeywords: ['strategy', 'strategic', 'transformation', 'innovation', 'evangelist', 
                                   'thought leader', 'advisory', 'ai', 'ml', 'product', 'growth', 'business'],
                targetIndustries: [],
                minSalary: null,
                locationPreferences: ["US", "Remote"],
                minimumSkillMatches: 3,
                minimumMatchScore: 50
            },
            applications: []
        };
        
        let templates = {};
        let valuesLibrary = [];
        
        // Check if user has existing profile
        // Removed checkUserProfile - using template-based loading instead
        
        // Build profile selector dropdown from manifest
        function buildProfileSelector(profiles) {
            const selector = document.getElementById('profileSelector');
            if (!selector) {
                console.error('Profile selector not found');
                return;
            }
            
            // Clear existing options
            selector.innerHTML = '';
            
            // Get current profile
            const currentProfile = localStorage.getItem('currentProfile') || profiles[0]?.id;
            
            // Add option for each profile
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.icon} ${profile.name} (${profile.title})`;
                
                // Select current profile
                if (profile.id === currentProfile) {
                    option.selected = true;
                }
                
                selector.appendChild(option);
            });
            
            console.log(`âœ“ Profile selector built with ${profiles.length} options`);
        }
        
        // Switch to a different profile (admin functionality)
        function switchProfile(templateId) {
            console.log('ðŸ”„ Switching profile to:', templateId);
            
            // Save preference
            localStorage.setItem('currentProfile', templateId);
            
            // Reload page to load new profile fresh
            window.location.reload();
        }
        
        // Save user data preference (which profile they're viewing)
        function saveUserData() {
            try {
                // Don't save userData to localStorage anymore
                // Only save which profile is active
                const currentProfileId = userData.templateId || 'cliff-jones-demo';
                localStorage.setItem('currentProfile', currentProfileId);
                console.log('âœ“ Profile preference saved:', currentProfileId);
                return true;
            } catch (e) {
                console.error('Error saving profile preference:', e);
                return false;
            }
        }
        
        // ===== SKILL LIBRARY SYSTEM (v2.3.0) =====
        let skillLibraryIndex = null;

        async function loadSkillLibraryIndex() {
            console.log('=== LOADING SKILL LIBRARY ===');
            
            // Cache-busting timestamp
            const cacheBuster = '?v=20260217-1510';
            const url = 'skills/index-v3.json' + cacheBuster;
            console.log('Fetching:', url);
            
            try {
                const response = await fetch(url);
                console.log('Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('JSON parsed successfully');
                console.log('Data structure:', Object.keys(data));
                console.log('Total skills:', data.totalSkills);
                console.log('Index array length:', data.index ? data.index.length : 'NO INDEX');
                
                skillLibraryIndex = data;
                console.log(`âœ… Skill library loaded: ${skillLibraryIndex.totalSkills} skills`);
                console.log('=== LIBRARY LOAD COMPLETE ===');
                
                // Test search immediately
                console.log('Testing search with "leadership"...');
                const testResults = searchSkills('leadership');
                console.log('Test search results:', testResults.length, 'skills found');
                
            } catch (error) {
                console.error('âŒ ERROR loading skill library:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                skillLibraryIndex = { totalSkills: 0, index: [] };
                
                alert('CRITICAL ERROR: Skill library failed to load!\n\n' + 
                      'Error: ' + error.message + '\n\n' +
                      'Check browser console (F12) for details.\n\n' +
                      'The skills/index-v3.json file may be missing or corrupted.');
            }
        }

        // Search skills by query - GUARANTEED to return array
        function searchSkills(query) {
            console.log('=== searchSkills START ===');
            console.log('Query:', query);
            console.log('skillLibraryIndex:', skillLibraryIndex);
            
            try {
                if (!skillLibraryIndex) {
                    console.error('ERROR: skillLibraryIndex is null/undefined');
                    return [];
                }
                
                if (!skillLibraryIndex.index) {
                    console.error('ERROR: skillLibraryIndex.index is null/undefined');
                    console.log('skillLibraryIndex keys:', Object.keys(skillLibraryIndex));
                    return [];
                }
                
                if (!query) {
                    console.log('No query provided');
                    return [];
                }
                
                const q = query.toLowerCase().trim();
                console.log('Trimmed query:', q);
                
                if (q.length < 2) {
                    console.log('Query too short');
                    return [];
                }
                
                console.log('Searching through', skillLibraryIndex.index.length, 'skills');
                
                const results = skillLibraryIndex.index
                    .filter(skill => {
                        try {
                            const name = (skill.n || '').toLowerCase();
                            const category = (skill.c || '').toLowerCase();
                            const subcategory = (skill.sc || '').toLowerCase();
                            return name.includes(q) || category.includes(q) || subcategory.includes(q);
                        } catch (filterError) {
                            console.error('Error filtering skill:', skill, filterError);
                            return false;
                        }
                    })
                    .sort((a, b) => {
                        try {
                            const aName = (a.n || '').toLowerCase();
                            const bName = (b.n || '').toLowerCase();
                            
                            const aExact = aName === q;
                            const bExact = bName === q;
                            if (aExact && !bExact) return -1;
                            if (!aExact && bExact) return 1;
                            
                            const aStarts = aName.startsWith(q);
                            const bStarts = bName.startsWith(q);
                            if (aStarts && !bStarts) return -1;
                            if (!aStarts && bStarts) return 1;
                            
                            return (b.p || 0) - (a.p || 0);
                        } catch (sortError) {
                            console.error('Error sorting skills:', sortError);
                            return 0;
                        }
                    })
                    .slice(0, 20);
                
                console.log('Found', results.length, 'results');
                console.log('=== searchSkills END ===');
                return results || []; // GUARANTEE array return
                
            } catch (error) {
                console.error('=== CRITICAL ERROR in searchSkills ===');
                console.error('Error:', error);
                console.error('Message:', error.message);
                console.error('Stack:', error.stack);
                return []; // ALWAYS return array, even on error
            }
        }

        function getCategoryColor(category) {
            const colors = {
                'Technology': '#3b82f6',
                'Business & Management': '#8b5cf6',
                'Finance & Accounting': '#10b981',
                'Marketing & Sales': '#f59e0b',
                'Human Resources': '#ec4899',
                'Healthcare & Medical': '#14b8a6',
                'Engineering & Manufacturing': '#6366f1',
                'Legal & Compliance': '#78716c',
                'Creative & Design': '#f97316',
                'General Professional': '#64748b'
            };
            return colors[category] || '#9ca3af';
        }

        function isSkillAlreadyAdded(skillName) {
            return userData.skills.some(s => 
                s.name.toLowerCase() === skillName.toLowerCase()
            );
        }

        // Load library on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSkillLibraryIndex();
        });
        
        // Load template into userData
        function loadTemplate(templateId) {
            const template = templates[templateId];
            if (!template) {
                console.error('Template not found:', templateId);
                return false;
            }
            
            console.log('ðŸ“‹ Loading template:', templateId);
            console.log('  â†’ Template has', template.skills.length, 'skills');
            console.log('  â†’ First skill:', template.skills[0].name);
            console.log('  â†’ First skill has evidence:', template.skills[0].evidence ? `YES (${template.skills[0].evidence.length} items)` : 'NO');
            
            userData = {
                initialized: true,
                profile: {...template.profile},
                skills: [...template.skills],
                skillDetails: {},
                values: template.values ? [...template.values] : [],
                purpose: template.purpose || "",
                roles: [...template.roles],
                preferences: {
                    seniorityLevel: template.profile.roleLevel || "Mid-Career",
                    targetTitles: [],
                    seniorityKeywords: ['vp', 'vice president', 'chief', 'head of', 'director', 'principal', 'senior director'],
                    excludeRoles: ['engineer', 'developer', 'designer', 'analyst', 'coordinator', 'specialist', 
                                  'junior', 'mid-level', 'associate', 'intern', 'entry', 'qa', 'frontend', 'backend',
                                  'full stack', 'fullstack', 'software', 'devops', 'ui/ux', 'data scientist'],
                    strategicKeywords: ['strategy', 'strategic', 'transformation', 'innovation', 'evangelist', 
                                       'thought leader', 'advisory', 'ai', 'ml', 'product', 'growth', 'business'],
                    targetIndustries: [],
                    minSalary: null,
                    locationPreferences: ["US", "Remote"],
                    minimumSkillMatches: 3,
                    minimumMatchScore: 50
                },
                applications: [],
                templateId: templateId  // Store which template this is
            };
            
            console.log('  â†’ userData.skills[0] has evidence:', userData.skills[0].evidence ? `YES (${userData.skills[0].evidence.length} items)` : 'NO');
            
            // Load skill evidence if it exists
            fetch('skill_evidence.json')
                .then(response => response.json())
                .then(data => {
                    userData.skillDetails = data;
                    console.log('âœ“ Loaded evidence for', Object.keys(data).length, 'skills');
                })
                .catch(error => console.log('No skill evidence file found'));
            
            saveUserData();
            console.log('âœ“ Template loaded:', template.templateName);
            return true;
        }
        
        // Initialize app - check for profile or show welcome
        async function initializeApp() {
            // Load profile manifest and templates dynamically
            try {
                const cacheBust = `?v=${Date.now()}`;
                
                // STEP 1: Load profiles manifest
                console.log('ðŸ“‹ Loading profiles manifest...');
                const manifest = await fetch(`profiles-manifest.json${cacheBust}`).then(r => r.json());
                window.profilesManifest = manifest; // Store for profile selector
                
                // STEP 2: Load all enabled profiles from manifest
                const enabledProfiles = manifest.profiles.filter(p => p.enabled);
                console.log(`âœ“ Found ${enabledProfiles.length} enabled profiles in manifest`);
                
                for (const profileMeta of enabledProfiles) {
                    try {
                        const template = await fetch(`${profileMeta.path}${cacheBust}`).then(r => r.json());
                        templates[profileMeta.id] = template;
                        console.log(`  âœ“ Loaded: ${profileMeta.name} (${profileMeta.title}) from ${profileMeta.path}`);
                    } catch (err) {
                        console.error(`  âœ— Failed to load ${profileMeta.path}:`, err);
                    }
                }
                
                // STEP 3: Load blank template
                const blankTemplate = await fetch(`profiles/templates/blank.json${cacheBust}`).then(r => r.json());
                templates['blank'] = blankTemplate;
                
                console.log(`âœ“ Profile loading complete: ${enabledProfiles.length} profiles ready`);
                
                // STEP 4: Build profile selector dropdown
                buildProfileSelector(enabledProfiles);
                
            } catch (e) {
                console.error('Error loading profiles:', e);
            }
            
            // Load O*NET skills library
            try {
                const onetLib = await fetch('onet-skills-library.json').then(r => r.json());
                window.onetSkillsLibrary = onetLib;
                console.log('âœ“ O*NET Skills Library loaded (35 official skills)');
            } catch (e) {
                console.error('Error loading O*NET skills library:', e);
            }
            
            // Load O*NET abilities library  
            try {
                const abilitiesLib = await fetch('onet-abilities-library.json').then(r => r.json());
                window.onetAbilitiesLibrary = abilitiesLib;
                console.log('âœ“ O*NET Abilities Library loaded (52 official abilities)');
            } catch (e) {
                console.error('Error loading O*NET abilities library:', e);
            }
            
            // Load O*NET work styles library
            try {
                const workStylesLib = await fetch('onet-workstyles-library.json').then(r => r.json());
                window.onetWorkStylesLibrary = workStylesLib;
                console.log('âœ“ O*NET Work Styles Library loaded (16 official work styles)');
            } catch (e) {
                console.error('Error loading O*NET work styles library:', e);
            }
            
            // Load values library
            try {
                const lib = await fetch('values-library.json').then(r => r.json());
                valuesLibrary = lib.values || [];
                console.log('âœ“ Values library loaded:', valuesLibrary.length, 'values');
            } catch (e) {
                console.error('Error loading values library:', e);
            }
            
            // Check if user has profile
            // NEW ARCHITECTURE: Templates are source of truth
            // localStorage only stores WHICH profile to load, not the data
            const currentProfile = localStorage.getItem('currentProfile') || 'cliff-jones-demo';
            console.log('ðŸ“‹ Loading profile:', currentProfile);
            
            // Set profile selector to match current profile
            const profileSelector = document.getElementById('profileSelector');
            if (profileSelector) {
                profileSelector.value = currentProfile;
            }
            
            if (templates[currentProfile]) {
                loadTemplate(currentProfile);
                initializeMainApp();
            } else {
                console.error('âŒ Profile not found:', currentProfile);
                // Fallback to Cliff
                loadTemplate('cliff-jones-demo');
                initializeMainApp();
            }
        }
        
        // Show welcome screen for new users
        function showWelcomeScreen() {
            console.log('ðŸ“‹ Showing welcome screen');
            console.log('Available templates:', Object.keys(templates));
            
            // Create welcome overlay (don't destroy existing DOM/scripts)
            const welcomeDiv = document.createElement('div');
            welcomeDiv.id = 'welcomeScreen';
            welcomeDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            welcomeDiv.innerHTML = `
                <div style="max-width: 800px; margin: 100px auto; padding: 40px; text-align: center;">
                    <h1 style="font-size: 3em; margin-bottom: 20px; color: #e0e0e0;">
                        ðŸ“‹ Work Blueprint v2.0
                    </h1>
                    <p style="font-size: 1.3em; color: #9ca3af; margin-bottom: 50px;">
                        Your Career Management Platform
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                        <div onclick="startWithTemplate('blank')" style="background: rgba(96, 165, 250, 0.1); padding: 40px; border-radius: 12px; cursor: pointer; border: 2px solid rgba(96, 165, 250, 0.3); transition: all 0.3s;" onmouseover="this.style.borderColor='#60a5fa'" onmouseout="this.style.borderColor='rgba(96, 165, 250, 0.3)'">
                            <div style="font-size: 3em; margin-bottom: 15px;">âœ¨</div>
                            <h3 style="color: #60a5fa; margin-bottom: 15px;">Start Fresh</h3>
                            <p style="color: #9ca3af; font-size: 0.95em;">
                                Build your profile from scratch. Add your own skills, values, and experience.
                            </p>
                        </div>
                        
                        <div onclick="startWithTemplate('cliff-jones-demo')" style="background: rgba(16, 185, 129, 0.1); padding: 40px; border-radius: 12px; cursor: pointer; border: 2px solid rgba(16, 185, 129, 0.3); transition: all 0.3s;" onmouseover="this.style.borderColor='#10b981'" onmouseout="this.style.borderColor='rgba(16, 185, 129, 0.3)'">
                            <div style="font-size: 3em; margin-bottom: 15px;">ðŸŽ¯</div>
                            <h3 style="color: #10b981; margin-bottom: 15px;">Use Template</h3>
                            <p style="color: #9ca3af; font-size: 0.95em;">
                                <strong>Executive Strategy Template</strong><br>
                                VP-level with 50 curated skills. Customize from there.
                            </p>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <label style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 8px; cursor: pointer; display: inline-block; border: 2px dashed rgba(255, 255, 255, 0.2);">
                            <div style="color: #9ca3af; margin-bottom: 10px;">ðŸ“ Import Saved Profile</div>
                            <input type="file" accept=".json" onchange="importProfile(event)" style="display: none;">
                            <div style="color: #60a5fa; font-size: 0.9em;">Click to select JSON file</div>
                        </label>
                    </div>
                </div>
            `;
            
            // Append to body (don't replace body - keeps JavaScript intact!)
            document.body.appendChild(welcomeDiv);
            
            // Hide all other content
            document.querySelectorAll('body > *:not(#welcomeScreen):not(script)').forEach(el => {
                el.style.display = 'none';
            });
        }
        
        // Start with selected template
        window.startWithTemplate = function(templateId) {
            console.log('ðŸŽ¯ Starting with template:', templateId);
            
            if (!templates[templateId]) {
                alert('Template not found. Please refresh the page and try again.');
                return;
            }
            
            if (loadTemplate(templateId)) {
                console.log('âœ“ Template loaded successfully');
                
                // If blank, show onboarding wizard
                if (templateId === 'blank') {
                    showOnboardingWizard();
                } else {
                    // Force hard reload with cache bypass
                    console.log('ðŸ”„ Reloading page...');
                    window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
                }
            } else {
                alert('Failed to load template. Please try again.');
            }
        };
        
        // Import profile from JSON file
        window.importProfile = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    userData = imported;
                    userData.initialized = true;
                    saveUserData();
                    location.reload();
                } catch (error) {
                    alert('Error importing profile: ' + error.message);
                }
            };
            reader.readAsText(file);
        };
        
        // Show onboarding wizard for blank profiles
        function showOnboardingWizard() {
            // For now, just reload to main app - wizard coming in next phase
            alert('Quick setup: Add your name and location in Settings, then start adding skills!');
            location.reload();
        }
        
        // Initialize main app with user data
        function initializeMainApp() {
            // Replace skillsData with userData
            skillsData.skills = userData.skills || [];
            skillsData.roles = userData.roles || skillsData.roles;
            skillsData.skillDetails = userData.skillDetails || {};
            
            // Render dynamic filter chips from profile data
            renderFilterChips();
            
            console.log('âœ“ Main app initialized with', userData.skills.length, 'skills');
        }
        
        // Export current profile
        function exportUserProfile() {
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `work-blueprint-${userData.profile.name || 'profile'}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // ===== END v2.0 USER DATA MANAGEMENT =====
        
        // Load skill evidence dynamically
        fetch('skill_evidence.json')
            .then(response => response.json())
            .then(data => {
                skillsData.skillDetails = data;
                console.log('âœ“ Loaded evidence for', Object.keys(data).length, 'skills');
            })
            .catch(error => console.error('Error loading skill evidence:', error));

        const levelColors = {
            "Mastery":    "#ef4444",
            "Expert":     "#f97316",
            "Advanced":   "#f59e0b",
            "Proficient": "#10b981",
            "Novice":     "#6b7280"
        };

        let currentView = 'network';
        let activeRole = 'all';
        let activeLevel = null;
        let simulation;

        function initNetwork() {
            const width = window.innerWidth;
            const height = window.innerHeight - 160;
            
            const svg = d3.select("#networkView")
                .attr("width", width)
                .attr("height", height);

            svg.selectAll("*").remove();

            // Create nodes
            const nodes = [
                { id: "center", name: userData.profile.name || "You", type: "center", x: width/2, y: height/2, fx: width/2, fy: height/2 }
            ];

            // Add role nodes
            skillsData.roles.forEach((role, i) => {
                const angle = (i / skillsData.roles.length) * 2 * Math.PI;
                const radius = 200;
                nodes.push({
                    id: role.id,
                    name: role.name,
                    type: "role",
                    color: role.color,
                    x: width/2 + Math.cos(angle) * radius,
                    y: height/2 + Math.sin(angle) * radius
                });
            });

            // Add skill nodes
            skillsData.skills.forEach((skill, i) => {
                nodes.push({
                    id: `skill-${i}`,
                    name: skill.name,
                    type: "skill",
                    level: skill.level,
                    roles: skill.roles,
                    key: skill.key
                });
            });

            // Create links
            const links = [];
            
            // Center to roles
            skillsData.roles.forEach(role => {
                links.push({ source: "center", target: role.id, type: "role" });
            });

            // Roles to skills
            skillsData.skills.forEach((skill, i) => {
                skill.roles.forEach(roleId => {
                    links.push({ 
                        source: roleId, 
                        target: `skill-${i}`,
                        type: "skill"
                    });
                });
            });

            // Create simulation
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.type === "role") return 140;  // Center to roles - balanced
                    return 160;  // Roles to skills - not too far
                }))
                .force("charge", d3.forceManyBody().strength(d => {
                    if (d.type === "center") return 0;
                    if (d.type === "role") return -250;  // Moderate repulsion
                    return -180;  // Skills push away moderately
                }))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(d => {
                    if (d.type === "center") return 70;
                    if (d.type === "role") return 65;  // Prevent overlap
                    return 45;  // Skills collision
                }))
                .force("x", d3.forceX(width / 2).strength(0.08))  // Stronger pull to center
                .force("y", d3.forceY(height / 2).strength(0.08))  // Keep things on screen
                .force("radial", d3.forceRadial(d => {
                    // Keep skills within viewport bounds
                    if (d.type === "skill") return Math.min(width, height) * 0.4;
                    return 0;
                }).strength(0.1));

            // Draw links
            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link");

            // Draw nodes
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", d => `node ${d.type}`)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("r", d => {
                    if (d.type === "center") return 40;
                    if (d.type === "role") return 30;
                    return d.key ? 12 : 8;
                })
                .attr("fill", d => {
                    if (d.type === "center") return "#60a5fa";
                    if (d.type === "role") return d.color;
                    return levelColors[d.level];
                })
                .on("click", (event, d) => {
                    if (d.type === "role") {
                        filterByRole(d.id);
                    } else if (d.type === "skill") {
                        event.stopPropagation();
                        // Look up full skill object from skillsData instead of using node data
                        const fullSkill = skillsData.skills.find(s => s.name === d.name);
                        if (fullSkill) {
                            openSkillModal(d.name, fullSkill);
                        } else {
                            console.error('Skill not found in skillsData:', d.name);
                        }
                    }
                })
                .on("mouseover", (event, d) => showTooltip(event, d))
                .on("mouseout", hideTooltip);

            node.append("text")
                .each(function(d) {
                    if (d.type === 'skill') {
                        // Split long skill names into multiple lines
                        const words = d.name.split(' ');
                        const maxWidth = 15; // characters per line
                        let lines = [];
                        let currentLine = '';
                        
                        words.forEach(word => {
                            if ((currentLine + ' ' + word).length > maxWidth && currentLine.length > 0) {
                                lines.push(currentLine);
                                currentLine = word;
                            } else {
                                currentLine = currentLine ? currentLine + ' ' + word : word;
                            }
                        });
                        if (currentLine) lines.push(currentLine);
                        
                        // Create tspan for each line
                        const text = d3.select(this);
                        lines.forEach((line, i) => {
                            text.append('tspan')
                                .text(line)
                                .attr('x', 0)
                                .attr('dy', i === 0 ? -13 - (lines.length - 1) * 5 : 10)
                                .attr('text-anchor', 'middle');
                        });
                    } else {
                        // Single line for center and role nodes
                        d3.select(this)
                            .text(d.name)
                            .attr("x", 0)
                            .attr("y", d => {
                                if (d.type === "center") return -45;
                                if (d.type === "role") return -35;
                                return -13;
                            })
                            .attr("text-anchor", "middle");
                    }
                });

            simulation.on("tick", () => {
                // Constrain nodes to viewport with padding
                const padding = 100;
                nodes.forEach(d => {
                    if (d.type !== "center") {  // Don't constrain center node
                        d.x = Math.max(padding, Math.min(width - padding, d.x));
                        d.y = Math.max(padding, Math.min(height - padding, d.y));
                    }
                });
                
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });

            window.networkData = { nodes, links, svg, link, node };
        }

        function initCardView() {
            const cardView = document.getElementById('cardView');
            
            // Group skills by domain
            const domains = {
                "Strategic Core": { icon: "ðŸŽ¯", skills: [] },
                "Technology & Product": { icon: "âš™ï¸", skills: [] },
                "Futurist & Innovation": { icon: "ðŸ”®", skills: [] },
                "Communication & Influence": { icon: "ðŸ“£", skills: [] },
                "Domain Expertise": { icon: "ðŸŽ“", skills: [] },
                "Leadership & Interpersonal": { icon: "ðŸ‘¥", skills: [] },
                "Creative & Performance": { icon: "ðŸŽµ", skills: [] },
                "Aviation & Operational": { icon: "âœˆï¸", skills: [] },
                "Analytical & Research": { icon: "ðŸ”¬", skills: [] },
                "Advocacy & Lived Experience": { icon: "ðŸ’š", skills: [] }
            };
            
            // Categorize skills
            skillsData.skills.forEach(skill => {
                const skillName = skill.name;
                
                if (skillName.includes("Strategy") || skillName.includes("Business") || skillName.includes("Revenue") || skillName.includes("Financial") || skillName.includes("Risk") || skillName.includes("Advisory") || skillName.includes("Transformation")) {
                    domains["Strategic Core"].skills.push(skill);
                } else if (skillName.includes("AI/ML") || skillName.includes("Technology") || skillName.includes("Platform") || skillName.includes("Computational") || skillName.includes("Integration") || skillName.includes("Spatial")) {
                    domains["Technology & Product"].skills.push(skill);
                } else if (skillName.includes("Trend") || skillName.includes("Predictive") || skillName.includes("Innovation") || skillName.includes("Scenario") || skillName.includes("Human-AI") || skillName.includes("Weak Signal")) {
                    domains["Futurist & Innovation"].skills.push(skill);
                } else if (skillName.includes("Narrative") || skillName.includes("Translation") || skillName.includes("Speaking") || skillName.includes("Authorship") || skillName.includes("Rhetorical") || skillName.includes("Media") || skillName.includes("Podcast") || skillName.includes("Improvisation") || skillName.includes("Evangelism") || skillName.includes("Teaching")) {
                    domains["Communication & Influence"].skills.push(skill);
                } else if (skillName.includes("Talent") || skillName.includes("Candidate") || skillName.includes("Ethics") || skillName.includes("Workforce") || skillName.includes("Marketplace") || skillName.includes("Behavioral") || skillName.includes("Future of Work") || skillName.includes("Generational") || skillName.includes("AI Impact")) {
                    domains["Domain Expertise"].skills.push(skill);
                } else if (skillName.includes("Client Relationship") || skillName.includes("Team Building") || skillName.includes("Mentorship") || skillName.includes("Stakeholder") || skillName.includes("Executive Presence") || skillName.includes("Crisis Leadership") || skillName.includes("High-Pressure")) {
                    domains["Leadership & Interpersonal"].skills.push(skill);
                } else if (skillName.includes("Creative") || skillName.includes("Musical") || skillName.includes("Music") || skillName.includes("Stage") || skillName.includes("Performance Logistics")) {
                    domains["Creative & Performance"].skills.push(skill);
                } else if (skillName.includes("Pilot") || skillName.includes("IFR") || skillName.includes("Weather") || skillName.includes("ATC") || skillName.includes("Emergency") || skillName.includes("Aeronautical") || skillName.includes("Situational Awareness") || skillName.includes("Cognitive Load")) {
                    domains["Aviation & Operational"].skills.push(skill);
                } else if (skillName.includes("Data-Driven") || skillName.includes("Market") || skillName.includes("Research") || skillName.includes("Critical Analysis")) {
                    domains["Analytical & Research"].skills.push(skill);
                } else if (skillName.includes("Recovery") || skillName.includes("Mental Health") || skillName.includes("Nonprofit") || skillName.includes("Vulnerability") || skillName.includes("Stigma") || skillName.includes("Diagnosis")) {
                    domains["Advocacy & Lived Experience"].skills.push(skill);
                }
            });
            
            let html = '<div class="cards-grid">';
            
            Object.entries(domains).forEach(([domainName, data]) => {
                if (data.skills.length === 0) return;
                
                html += `
                    <div class="domain-card">
                        <div class="domain-header">
                            <span class="domain-icon">${data.icon}</span>
                            <span class="domain-title">${domainName}</span>
                        </div>
                        <div class="skills-list">
                `;
                
                data.skills.forEach(skill => {
                    const levelClass = skill.level.toLowerCase();
                    const keyBadge = skill.key ? '<span class="skill-badge">CORE</span>' : '';
                    const rolesList = skill.roles.map(roleId => {
                        const role = skillsData.roles.find(r => r.id === roleId);
                        return role ? role.name : roleId;
                    }).join(', ');
                    
                    // Get years of experience from skillDetails
                    const details = skillsData.skillDetails && skillsData.skillDetails[skill.name];
                    const years = details && details.years ? details.years + ' yrs' : '';
                    const yearsBadge = years ? `<span class="skill-years">${years}</span>` : '';
                    
                    // Get market impact rating (instead of dollar value)
                    const skillImpact = calculateSkillValue(skill);
                    const impactColor = getImpactColor(skillImpact.level);
                    const impactBadge = `<span class="skill-impact-badge" style="background: rgba(${impactColor === '#ef4444' ? '239, 68, 68' : impactColor === '#f59e0b' ? '245, 158, 11' : impactColor === '#3b82f6' ? '59, 130, 246' : '107, 114, 128'}, 0.2); color: ${impactColor}; font-size: 0.7em; padding: 3px 8px; border-radius: 3px; margin-left: auto; font-weight: 600;">${skillImpact.icon} ${skillImpact.label.toUpperCase()}</span>`;
                    
                    // Category badge for all O*NET types + Unique
                    let categoryBadge = '';
                    if (skill.category === 'skill') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">SKILL</span>';
                    } else if (skill.category === 'ability') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(139, 92, 246, 0.2); color: #a78bfa; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">ABILITY</span>';
                    } else if (skill.category === 'workstyle') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">WORK STYLE</span>';
                    } else if (skill.category === 'unique') {
                        categoryBadge = '<span class="skill-badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">UNIQUE</span>';
                    }
                    
                    html += `
                        <div class="skill-item ${levelClass}" title="${rolesList}" onclick='openSkillModalFromCard("${skill.name.replace(/'/g, "\\'")}")' style="cursor: pointer;">
                            <div class="skill-dot" style="background: ${levelColors[skill.level]}"></div>
                            <span class="skill-name">${skill.name}</span>
                            ${categoryBadge}
                            ${yearsBadge}
                            ${keyBadge}
                            ${impactBadge}
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            cardView.innerHTML = html;
        }

        let currentSkillsView = 'network'; // Track whether showing network or card within Skills Ontology
        
        // Initialize user interface on load
        document.addEventListener('DOMContentLoaded', async () => {
            // v2.0: Initialize app (checks for profile, shows welcome if needed)
            await initializeApp();
            
            // If user has profile, continue with UI setup
            if (userData.initialized) {
                // Set user name in header
                const userNameEl = document.getElementById('userName');
                if (userData.profile.name) {
                    userNameEl.textContent = userData.profile.name + "'s";
                } else {
                    userNameEl.textContent = "Your";
                }
                
                // Default to card view on mobile
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    currentSkillsView = 'card';
                    document.getElementById('cardView').style.display = 'block';
                    document.getElementById('networkView').style.display = 'none';
                    document.getElementById('networkControls').style.display = 'none';
                    
                    // Update toggle button state
                    document.querySelectorAll('#skillsViewToggle .role-chip').forEach(chip => {
                        chip.classList.toggle('active', chip.dataset.view === 'card');
                    });
                } else {
                    initNetwork();
                }
                
                initCardView();
                
                // Auto-save every 30 seconds
                setInterval(() => {
                    saveUserData();
                }, 30000);
            } // Close if (userData.initialized)
        }); // Close DOMContentLoaded
        
        function switchView(view, event) {
            // Map new view names to existing views
            if (view === 'skills') view = 'network';
            if (view === 'jobs') view = 'opportunities';
            
            currentView = view;
            document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            const networkControls = document.getElementById('networkControls');
            const skillsViewToggle = document.getElementById('skillsViewToggle');
            const controls = document.querySelector('.controls');
            
            // Hide all views
            document.getElementById('networkView').style.display = 'none';
            document.getElementById('cardView').style.display = 'none';
            document.getElementById('opportunitiesView').style.display = 'none';
            document.getElementById('applicationsView').style.display = 'none';
            document.getElementById('blueprintView').style.display = 'none';
            document.getElementById('consentView').style.display = 'none';
            document.getElementById('settingsView').style.display = 'none';
            networkControls.style.display = 'none';
            controls.style.display = 'none';
            
            // Show selected view
            if (view === 'network') {
                // Skills Ontology view
                controls.style.display = 'flex';
                if (currentSkillsView === 'network') {
                    document.getElementById('networkView').style.display = 'block';
                    networkControls.style.display = 'flex';
                } else {
                    document.getElementById('cardView').style.display = 'block';
                }
                updateStatsBar();
            } else if (view === 'opportunities') {
                document.getElementById('opportunitiesView').style.display = 'block';
                if (!window.opportunitiesInitialized) {
                    initOpportunities();
                    window.opportunitiesInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'applications') {
                document.getElementById('applicationsView').style.display = 'block';
                if (!window.applicationsInitialized) {
                    initApplications();
                    window.applicationsInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'blueprint') {
                document.getElementById('blueprintView').style.display = 'block';
                if (!window.blueprintInitialized) {
                    initBlueprint();
                    window.blueprintInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'consent') {
                document.getElementById('consentView').style.display = 'block';
                if (!window.consentInitialized) {
                    initConsent();
                    window.consentInitialized = true;
                }
                updateStatsBar();
            } else if (view === 'settings') {
                document.getElementById('settingsView').style.display = 'block';
                if (!window.settingsInitialized) {
                    initSettings();
                    window.settingsInitialized = true;
                }
                updateStatsBar();
            }
        }
        
        function toggleSkillsView(view) {
            currentSkillsView = view;
            document.querySelectorAll('#skillsViewToggle .role-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.view === view);
            });
            
            const networkControls = document.getElementById('networkControls');
            
            if (view === 'network') {
                document.getElementById('networkView').style.display = 'block';
                document.getElementById('cardView').style.display = 'none';
                networkControls.style.display = 'flex';
            } else {
                document.getElementById('networkView').style.display = 'none';
                document.getElementById('cardView').style.display = 'block';
                networkControls.style.display = 'none';
            }
        }
        
        function updateStatsBar() {
            const statsBar = document.getElementById('statsBar');
            if (currentView === 'network') {
                // Calculate total market value
                const totalValue = calculateTotalMarketValue();
                const valueFormatted = totalValue.total > 0 ? `$${(totalValue.total/1000).toFixed(0)}k` : '';
                const valueDisplay = valueFormatted ? ` â€¢ <span style="color: #10b981; font-weight: 700;">Market Value: ${valueFormatted}/year</span>` : '';
                
                // Dynamic counts by category
                const skillCount = userData.skills?.length || 0;
                const roleCount = userData.roles?.length || 0;
                const onetSkillsCount = userData.skills?.filter(s => s.category === 'skill').length || 0;
                const abilitiesCount = userData.skills?.filter(s => s.category === 'ability').length || 0;
                const workStylesCount = userData.skills?.filter(s => s.category === 'workstyle').length || 0;
                const uniqueCount = userData.skills?.filter(s => s.category === 'unique').length || 0;
                
                // Show detailed breakdown for v2.0.6 comprehensive model
                let skillBreakdown = '';
                if (skillCount >= 90) {
                    // Comprehensive 90-skill model
                    skillBreakdown = ` (${onetSkillsCount} Skills + ${abilitiesCount} Abilities + ${workStylesCount} Work Styles + ${uniqueCount} Unique)`;
                } else if (onetSkillsCount > 0 && uniqueCount > 0) {
                    // Hybrid model (v2.0.5)
                    skillBreakdown = ` (${onetSkillsCount} O*NET + ${uniqueCount} Unique)`;
                }
                
                statsBar.innerHTML = `${skillCount} Total Skills${skillBreakdown} â€¢ ${roleCount} Career Roles${valueDisplay}`;
            } else if (currentView === 'opportunities') {
                const matches = opportunitiesData.filter(j => j.matchScore >= currentMatchThreshold).length;
                statsBar.innerHTML = `${matches} Matching Opportunities â€¢ ${currentMatchThreshold}%+ Match Threshold`;
            } else if (currentView === 'applications') {
                const total = userData.applications?.length || 0;
                const active = userData.applications?.filter(a => a.status !== 'rejected').length || 0;
                statsBar.innerHTML = `${total} Applications Tracked â€¢ ${active} Active`;
            } else if (currentView === 'blueprint') {
                const sharedOutcomes = blueprintData.outcomes.filter(o => o.shared).length;
                const selectedValues = blueprintData.values.filter(v => v.selected).length;
                statsBar.innerHTML = `${sharedOutcomes} Outcomes â€¢ ${selectedValues} Values â€¢ Purpose Statement`;
            } else if (currentView === 'consent') {
                const totalShared = blueprintData.outcomes.filter(o => o.shared).length + 
                                   blueprintData.values.filter(v => v.selected).length;
                statsBar.innerHTML = `${totalShared} Items Shared â€¢ Data Privacy & Control`;
            } else if (currentView === 'settings') {
                statsBar.innerHTML = `Profile Settings â€¢ ${userData.preferences.seniorityLevel} Level â€¢ Customize Your Experience`;
            }
        }
        
        function toggleLabels(type) {
            if (!window.networkData) return;
            const { node } = window.networkData;
            
            node.selectAll('text')
                .filter(d => d.type === type)
                .classed('hidden', function() {
                    return !this.classList.contains('hidden');
                });
        }

        // Render dynamic role chips and level counts from current profile data
        function renderFilterChips() {
            // --- ROLES ---
            const rolesContainer = document.getElementById('roleChipsContainer');
            if (rolesContainer && userData.roles) {
                rolesContainer.innerHTML = `<div class="role-chip active" data-role="all" onclick="filterByRole('all')">All</div>` +
                    userData.roles.map(role => 
                        `<div class="role-chip" data-role="${role.id}" onclick="filterByRole('${role.id}')">${role.name}</div>`
                    ).join('');
            }
            
            // --- LEVELS ---
            const levelContainer = document.getElementById('levelChipsContainer');
            if (levelContainer && userData.skills) {
                const levelDefs = [
                    { key: 'Mastery',    cls: 'mastery' },
                    { key: 'Expert',     cls: 'expert' },
                    { key: 'Advanced',   cls: 'advanced' },
                    { key: 'Proficient', cls: 'proficient' },
                    { key: 'Novice',     cls: 'novice' }
                ];
                levelContainer.innerHTML = levelDefs
                    .map(({ key, cls }) => {
                        const count = userData.skills.filter(s => s.level === key).length;
                        if (count === 0) return '';
                        return `<div class="level-chip ${cls}" onclick="filterByLevel('${key.toLowerCase()}')">${key} (${count})</div>`;
                    })
                    .join('');
            }
        }

        function filterByRole(roleId) {
            activeRole = roleId;
            
            // Update UI
            document.querySelectorAll('.role-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.role === roleId);
            });

            if (!window.networkData) return;

            const { nodes, links, node, link } = window.networkData;

            if (roleId === 'all') {
                node.classed('dimmed', false).classed('highlighted', false);
                link.classed('dimmed', false).classed('highlighted', false);
                
                // Show all labels
                node.selectAll('text').classed('hidden', false);
                return;
            }

            // Find skills that belong to this role
            const relevantSkills = skillsData.skills
                .filter(s => s.roles.includes(roleId))
                .map((s, i) => `skill-${skillsData.skills.indexOf(s)}`);

            node.classed('dimmed', d => {
                if (d.type === 'center') return false;
                if (d.type === 'role') return d.id !== roleId;
                return !relevantSkills.includes(d.id);
            });

            node.classed('highlighted', d => {
                if (d.type === 'role') return d.id === roleId;
                return relevantSkills.includes(d.id);
            });

            link.classed('dimmed', d => {
                return d.source.id !== roleId && !relevantSkills.includes(d.target.id);
            });

            link.classed('highlighted', d => {
                return d.source.id === roleId && relevantSkills.includes(d.target.id);
            });
            
            // STORYTELLING MODE: Hide skill labels that aren't in this role
            node.selectAll('text').classed('hidden', function(d) {
                if (d.type === 'center') return false;
                if (d.type === 'role') return d.id !== roleId; // Hide non-active role labels
                return !relevantSkills.includes(d.id); // Hide non-relevant skill labels
            });
        }

        function filterByLevel(level) {
            activeLevel = activeLevel === level ? null : level;
            
            event.target.classList.toggle('active');

            if (!window.networkData) return;
            const { node } = window.networkData;

            if (!activeLevel) {
                node.classed('dimmed', false);
                return;
            }

            node.classed('dimmed', d => {
                if (d.type !== 'skill') return false;
                return d.level.toLowerCase() !== activeLevel;
            });
        }

        function highlightSkill(skillData) {
            if (!window.networkData) return;
            const { node, link } = window.networkData;

            // Highlight the skill and its connected roles
            const connectedRoles = skillData.roles;

            node.classed('dimmed', d => {
                if (d.type === 'center') return false;
                if (d.type === 'role') return !connectedRoles.includes(d.id);
                return d.id !== skillData.id;
            });

            node.classed('highlighted', d => {
                if (d.type === 'role') return connectedRoles.includes(d.id);
                return d.id === skillData.id;
            });

            link.classed('highlighted', d => {
                return d.target.id === skillData.id;
            });
        }

        function showTooltip(event, d) {
            if (d.type === 'center') return;

            const tooltip = d3.select('#tooltip');
            let html = `<div class="tooltip-title">${d.name}</div>`;

            if (d.type === 'skill') {
                html += `<div class="tooltip-level">${d.level}${d.key ? ' â€¢ Core Differentiator' : ''}</div>`;
                html += `<div class="tooltip-roles">Used in: `;
                d.roles.forEach(roleId => {
                    const role = skillsData.roles.find(r => r.id === roleId);
                    html += `<span class="tooltip-role-tag">${role.name}</span>`;
                });
                html += `</div>`;
            } else if (d.type === 'role') {
                const skillCount = skillsData.skills.filter(s => s.roles.includes(d.id)).length;
                html += `<div class="tooltip-roles">${skillCount} skills in this role</div>`;
            }

            tooltip
                .html(html)
                .style('opacity', 1)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            d3.select('#tooltip').style('opacity', 0);
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            if (d.type !== 'center') {
                d.fx = null;
                d.fy = null;
            }
        }

        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }
        
        // ===== WORK BLUEPRINT GENERATOR =====
        
        function generateWorkBlueprint() {
            console.log('Generating Work Blueprint...');
            
            try {
                const profileData = gatherBlueprintData();
                const html = createBlueprintHTML(profileData);
                downloadBlueprint(html, `work-blueprint-${profileData.name.replace(/\s+/g, '-').toLowerCase()}.html`);
                
                alert('âœ… Work Blueprint downloaded!\n\nOpen the file in any browser to view your interactive Work Blueprint.\n\nYou can:\nâ€¢ Print it as PDF (File â†’ Print â†’ Save as PDF)\nâ€¢ Customize it per opportunity\nâ€¢ Email it as an attachment to recruiters');
            } catch (error) {
                console.error('Error generating blueprint:', error);
                alert('Error generating Work Blueprint. Please check console for details.');
            }
        }
        
        function gatherBlueprintData() {
            const skills = skillsData.skills || userData.skills || [];
            const topSkills = skills.map(skill => ({ ...skill, impact: getSkillImpact(skill) })).sort((a, b) => (b.impact?.score || 0) - (a.impact?.score || 0)).slice(0, 10);
            const compensation = calculateTotalMarketValue();

            // Pull real strategic outcomes from skill evidence â€” prefer items with metrics
            const allEvidence = [];
            skills.forEach(skill => {
                (skill.evidence || []).forEach(ev => {
                    const text = (ev.outcome || '') + ' ' + (ev.description || '');
                    let score = 0;
                    if (/\$[\d,]+[MBK]?/i.test(text)) score += 5;
                    if (/\d+%/.test(text)) score += 4;
                    if (/million|billion/i.test(text)) score += 5;
                    if (/\d+x|\d+ times/i.test(text)) score += 3;
                    if (skill.level === 'Mastery' || skill.level === 'Expert') score += 2;
                    if (skill.key) score += 2;
                    allEvidence.push({ skill: skill.name, description: ev.description, outcome: ev.outcome, score });
                });
            });
            allEvidence.sort((a, b) => b.score - a.score);

            // Build strategicOutcomes from top 5 real evidence items
            const strategicOutcomes = allEvidence.slice(0, 5).map(item => ({
                title: item.skill,
                metric: extractMetric(item.outcome),
                description: item.description || '',
                outcome: item.outcome || ''
            }));

            // Use real values from profile
            const selectedValues = (userData.values || []).filter(v => v.selected !== false).map(v => v.name || v);

            return {
                name: userData.profile.name || 'Your Name',
                title: userData.profile.currentTitle || 'Your Title',
                company: userData.profile.currentCompany || '',
                location: userData.profile.location || '',
                headline: userData.profile.headline || `${userData.profile.currentTitle || 'Strategic Professional'} Â· ${userData.profile.yearsExperience || ''}+ Years`,
                generatedDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                executiveSummary: userData.profile.executiveSummary || userData.purpose || 'Accomplished professional with proven track record of delivering measurable business impact.',
                purpose: userData.purpose || '',
                coreCompetencies: topSkills,
                strategicOutcomes,
                leadershipPhilosophy: userData.purpose || 'Leadership is about creating conditions where great work becomes inevitable.',
                marketPositioning: selectedValues.length > 0
                    ? `Core principles: ${selectedValues.join(' Â· ')}.`
                    : 'Strategic professional with deep domain expertise and proven track record.',
                compensation: compensation,
                careerNarrative: userData.profile.executiveSummary || 'A career defined by building bridges between technical innovation and business strategy.',
                futureVision: userData.purpose || 'Focused on creating lasting impact through authentic leadership and evidence-based strategy.'
            };
        }

        // Extract the most compelling metric from an outcome string
        function extractMetric(text) {
            if (!text) return '';
            const dollarMatch = text.match(/\$[\d.,]+[MBK]?(?:\s*\w+)?/i);
            if (dollarMatch) return dollarMatch[0];
            const pctMatch = text.match(/\d+%(?:\s*\w+)?/);
            if (pctMatch) return pctMatch[0];
            const multMatch = text.match(/\d+x(?:\s*\w+)?/i);
            if (multMatch) return multMatch[0];
            // Fallback: first 40 chars
            return text.slice(0, 40) + (text.length > 40 ? 'â€¦' : '');
        }
        
        function createBlueprintHTML(data) {
            const htmlContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Work Blueprint - ' + data.name + '</title><link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}:root{--primary:#1e40af;--accent:#f59e0b;--text:#1f2937;--text-light:#6b7280;--border:#e5e7eb;--bg:#fff;--bg-alt:#f9fafb}body{font-family:Crimson Pro,Georgia,serif;color:var(--text);background:var(--bg);line-height:1.7;font-size:18px}.container{max-width:900px;margin:0 auto;padding:60px 40px}header{border-bottom:3px solid var(--primary);padding-bottom:40px;margin-bottom:60px}h1{font-size:48px;font-weight:700;color:var(--primary);margin-bottom:10px}h2{font-size:32px;font-weight:700;color:var(--primary);margin-bottom:20px;border-left:4px solid var(--accent);padding-left:20px}section{margin-bottom:60px}p{margin-bottom:16px}.subtitle{font-size:24px;color:var(--text-light);margin-bottom:20px}.headline{font-size:20px;color:var(--accent);font-weight:600}.meta{font-family:JetBrains Mono,monospace;font-size:14px;color:var(--text-light);margin-top:20px}.skills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:30px}.skill-card{background:var(--bg-alt);border:1px solid var(--border);border-left:4px solid #3b82f6;padding:20px}.skill-name{font-size:18px;font-weight:600;color:var(--primary);margin-bottom:8px}.skill-level{font-family:JetBrains Mono,monospace;font-size:12px;color:var(--accent);text-transform:uppercase}.outcome{background:linear-gradient(to right,var(--bg-alt),var(--bg));border-left:4px solid var(--accent);padding:24px;margin-bottom:20px}.outcome-title{font-size:20px;font-weight:600;color:var(--primary);margin-bottom:8px}.outcome-metric{font-family:JetBrains Mono,monospace;font-size:16px;color:var(--accent);margin-bottom:10px}.comp-framework{background:var(--bg-alt);border:2px solid var(--primary);padding:30px;margin-top:30px}.comp-row{display:flex;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border)}.comp-label{font-weight:600}.comp-value{font-family:JetBrains Mono,monospace;color:var(--primary);font-weight:600}.quote-block{background:linear-gradient(135deg,var(--primary),#3b82f6);color:#fff;padding:40px;margin:40px 0;font-size:22px;font-style:italic}@media print{body{font-size:11pt}.container{padding:20px}h1{font-size:28pt}h2{font-size:18pt}}</style></head><body><div class="container"><header><h1>' + data.name + '</h1><div class="subtitle">' + data.title + '</div><div class="headline">' + data.headline + '</div><div class="meta">Generated: ' + data.generatedDate + '</div></header><section><h2>Executive Summary</h2><p>' + data.executiveSummary + '</p></section><section><h2>Core Competencies</h2><p>Strategic capabilities driving measurable impact:</p><div class="skills-grid">' + data.coreCompetencies.map(s => '<div class="skill-card"><div class="skill-name">' + s.name + '</div><div class="skill-level">' + (s.proficiency || 'Expert') + '</div></div>').join('') + '</div></section><section><h2>Strategic Outcomes</h2>' + data.strategicOutcomes.map(o => '<div class="outcome"><div class="outcome-title">' + o.title + '</div><div class="outcome-metric">' + o.metric + '</div><p>' + o.description + '</p></div>').join('') + '</section><section><h2>Leadership Philosophy</h2><p>' + data.leadershipPhilosophy + '</p></section><div class="quote-block">"' + data.marketPositioning + '"</div><section><h2>Compensation Framework</h2><p>Market-informed positioning based on skill depth and impact:</p><div class="comp-framework"><div class="comp-row"><span class="comp-label">Base Market Rate</span><span class="comp-value">$' + Math.round(data.compensation.marketRate || 200000).toLocaleString() + '</span></div><div class="comp-row"><span class="comp-label">Conservative Range</span><span class="comp-value">$' + Math.round(data.compensation.conservativeOffer || 225000).toLocaleString() + '</span></div><div class="comp-row"><span class="comp-label">Competitive Range</span><span class="comp-value">$' + Math.round(data.compensation.competitiveOffer || 275000).toLocaleString() + '</span></div></div></section><section><h2>Career Narrative</h2><p>' + data.careerNarrative + '</p></section><section><h2>Future Vision</h2><p>' + data.futureVision + '</p></section><footer style="margin-top:80px;padding-top:40px;border-top:2px solid var(--border);color:var(--text-light);font-size:14px"><p>This Work Blueprint is a living document representing strategic capabilities and market positioning as of ' + data.generatedDate + '.</p></footer></div></body></html>';
            return htmlContent;
        }
        
        function downloadBlueprint(html, filename) {
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function openSkillModal(skillName, skillData) {
            const modal = document.getElementById('skillModal');
            const title = document.getElementById('skillDetailTitle');
            const subtitle = document.getElementById('skillDetailSubtitle');
            const body = document.getElementById('skillDetailBody');
            
            // Set title
            title.textContent = skillName;
            
            // Set subtitle (level, years, core badge, category badge)
            const levelClass = skillData.level.toLowerCase();
            const coreBadge = skillData.key ? '<span class="modal-core-badge">â­ CORE DIFFERENTIATOR</span>' : '';
            const details = skillsData.skillDetails[skillName] || {};
            
            // DEBUG: Log evidence availability
            console.log('=== EVIDENCE DEBUG ===');
            console.log('Skill:', skillName);
            console.log('skillData.evidence:', skillData.evidence);
            console.log('details.evidence:', details.evidence);
            
            // Get evidence from skill object if not in skillDetails
            const evidence = details.evidence || (skillData.evidence ? skillData.evidence.map(e => `${e.description}<br><strong>Outcome:</strong> ${e.outcome}`) : null);
            console.log('Final evidence:', evidence);
            
            const years = details.years || skillData.yearsExperience || 'N/A';
            
            // Category badge for all O*NET types + Unique
            let categoryBadge = '';
            if (skillData.category === 'skill') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">ðŸ›ï¸ O*NET Skill</span>';
            } else if (skillData.category === 'ability') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(139, 92, 246, 0.2); color: #a78bfa;">ðŸ§  O*NET Ability</span>';
            } else if (skillData.category === 'workstyle') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981;">ðŸ’¼ O*NET Work Style</span>';
            } else if (skillData.category === 'unique') {
                categoryBadge = '<span class="modal-category-badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;">â­ Unique Differentiator</span>';
            }
            
            subtitle.innerHTML = `
                <span class="modal-level-badge ${levelClass}">${skillData.level}</span>
                <span class="modal-years">${years} years experience</span>
                ${categoryBadge}
                ${coreBadge}
            `;
            
            // Build body content
            let bodyHTML = '';
            
            // Roles section
            bodyHTML += `
                <div class="modal-section">
                    <div class="modal-section-title">
                        <span class="modal-section-icon">ðŸŽ¯</span>
                        Used in These Roles
                    </div>
                    <div class="roles-tags">
            `;
            skillData.roles.forEach(roleId => {
                const role = skillsData.roles.find(r => r.id === roleId);
                if (role) {
                    bodyHTML += `<div class="role-tag">${role.icon} ${role.name}</div>`;
                }
            });
            bodyHTML += `</div></div>`;
            
            // Evidence section
            if (evidence && evidence.length > 0) {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">âœ“</span>
                            Evidence & Defensibility
                        </div>
                        <ul class="evidence-list">
                `;
                evidence.forEach(item => {
                    bodyHTML += `<li class="evidence-item">${item}</li>`;
                });
                bodyHTML += `</ul></div>`;
            } else {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">âœ“</span>
                            Evidence & Defensibility
                        </div>
                        <p class="placeholder-text">Evidence for this skill will be added soon.</p>
                    </div>
                `;
            }
            
            // MARKET IMPACT SECTION
            const skillImpact = calculateSkillValue(skillData);
            const impactColor = getImpactColor(skillImpact.level);
            
            bodyHTML += `
                <div class="modal-section" style="background: rgba(${impactColor === '#ef4444' ? '239, 68, 68' : impactColor === '#f59e0b' ? '245, 158, 11' : impactColor === '#3b82f6' ? '59, 130, 246' : '107, 114, 128'}, 0.1); border-left: 3px solid ${impactColor}; padding: 20px; border-radius: 8px;">
                    <div class="modal-section-title">
                        <span class="modal-section-icon">ðŸ“Š</span>
                        Market Impact
                    </div>
                    <div style="margin-top: 15px;">
                        <div style="font-size: 1.8em; font-weight: 700; color: ${impactColor}; margin-bottom: 10px;">
                            ${skillImpact.icon} ${skillImpact.label}
                        </div>
                        
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px; line-height: 1.5;">
                            ${skillImpact.rationale || 'This skill contributes to your overall market value based on proficiency level and market demand.'}
                        </div>
                        
                        ${skillData.category === 'unique' && skillImpact.needsAssessment ? `
                            <div style="background: rgba(251, 191, 36, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #fbbf24;">
                                <div style="color: #fbbf24; font-weight: 600; margin-bottom: 8px;">âš ï¸ Estimated Rating</div>
                                <div style="color: #d1d5db; font-size: 0.9em; line-height: 1.5; margin-bottom: 12px;">
                                    ${skillImpact.rationale}
                                </div>
                                <button onclick="closeSkillModal(); openAssessSkillModal('${skillData.name.replace(/'/g, "\\'")}');" 
                                        style="padding: 8px 16px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: #000;">
                                    ðŸ“ Assess This Skill
                                </button>
                            </div>
                        ` : ''}
                        
                        ${skillData.category === 'unique' && skillImpact.userAssessed ? `
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="color: #10b981; font-weight: 600; margin-bottom: 5px;">âœ“ User Assessed</div>
                                <div style="color: #d1d5db; font-size: 0.85em;">
                                    Based on your assessment of this skill's experience, impact, and market scarcity.
                                    <button onclick="closeSkillModal(); openAssessSkillModal('${skillData.name.replace(/'/g, "\\'")}');" 
                                            style="margin-left: 10px; padding: 4px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                        Edit Assessment
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 6px; margin-top: 15px;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">ðŸ“Š Impact Scale</div>
                            <div style="color: #d1d5db; font-size: 0.9em; line-height: 1.6;">
                                â€¢ <strong style="color: #ef4444;">ðŸ”¥ Critical:</strong> Top 5% differentiators, significant premium<br>
                                â€¢ <strong style="color: #f59e0b;">â­ High:</strong> Top 20% skills, strong differentiator<br>
                                â€¢ <strong style="color: #3b82f6;">ðŸ’Ž Moderate:</strong> Expected for role level, valuable<br>
                                â€¢ <strong style="color: #6b7280;">âœ“ Standard:</strong> Baseline expectations<br>
                                â€¢ <strong style="color: #9ca3af;">â—‹ Supplementary:</strong> Supporting capabilities
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 5px;">ðŸ’¡ How This Affects Your Strategic Value</div>
                            <div style="color: #d1d5db; font-size: 0.85em; line-height: 1.5;">
                                Your compensation positioning is driven by your <strong>Critical and High Impact skills combined</strong> with your experience level. Focus on developing and demonstrating these capabilities to command premium offers.
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Story section
            if (details.story) {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">ðŸ“–</span>
                            Context & Story
                        </div>
                        <div class="story-text">${details.story}</div>
                    </div>
                `;
            }
            
            // Related skills section
            if (details.relatedSkills && details.relatedSkills.length > 0) {
                bodyHTML += `
                    <div class="modal-section">
                        <div class="modal-section-title">
                            <span class="modal-section-icon">ðŸ”—</span>
                            Related Skills
                        </div>
                        <div class="related-skills">
                `;
                details.relatedSkills.forEach(relatedSkill => {
                    bodyHTML += `<div class="related-skill-chip" onclick="openRelatedSkill('${relatedSkill}')">${relatedSkill}</div>`;
                });
                bodyHTML += `</div></div>`;
            }
            
            body.innerHTML = bodyHTML;
            modal.classList.add('active');
        }
        
        function closeSkillModal() {
            document.getElementById('skillModal').classList.remove('active');
        }
        
        function openRelatedSkill(skillName) {
            const skill = skillsData.skills.find(s => s.name === skillName);
            if (skill) {
                openSkillModal(skillName, skill);
            }
        }
        
        function openSkillModalFromCard(skillName) {
            const skill = skillsData.skills.find(s => s.name === skillName);
            console.log('ðŸ” Opening modal for:', skillName);
            console.log('  â†’ Found skill:', skill ? 'YES' : 'NO');
            if (skill) {
                console.log('  â†’ Skill has evidence:', skill.evidence ? `YES (${skill.evidence.length} items)` : 'NO');
                openSkillModal(skillName, skill);
            } else {
                console.error('  â†’ ERROR: Skill not found in skillsData.skills');
            }
        }

        function exportProfile(format) {
            closeExportModal();
            if (format === 'resume') {
                generateResume();
            } else if (format === 'capability') {
                alert('Capability Statement â€” coming in the next release.');
            } else if (format === 'linkedin') {
                alert('LinkedIn Profile export â€” coming in the next release.');
            } else if (format === 'interview') {
                alert('Interview Prep (STAR stories) â€” coming in the next release.');
            }
        }

        // ===== PROFESSIONAL RESUME GENERATOR =====
        // Produces a clean, ATS-readable HTML resume styled for print-to-PDF.
        // Pulls real data: executiveSummary, skill evidence outcomes, values, purpose, market value.

        function generateResume() {
            try {
                const data = gatherResumeData();
                const html = buildResumeHTML(data);
                const filename = `resume-${(data.name || 'profile').replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.html`;
                downloadBlueprint(html, filename);
            } catch (err) {
                console.error('Resume generation error:', err);
                alert('Error generating resume. See console for details.');
            }
        }

        function gatherResumeData() {
            const skills = skillsData.skills || userData.skills || [];
            const profile = userData.profile || {};
            const compensation = calculateTotalMarketValue();

            // --- Achievements: pull evidence items that have real outcomes ---
            // Score each evidence item: prefer items with metrics, dollar amounts, percentages
            const allEvidence = [];
            skills.forEach(skill => {
                (skill.evidence || []).forEach(ev => {
                    const text = (ev.outcome || '') + ' ' + (ev.description || '');
                    let score = 0;
                    if (/\$[\d,]+[MBK]?/i.test(text)) score += 5;
                    if (/\d+%/.test(text)) score += 4;
                    if (/\d+x|\d+ times/i.test(text)) score += 3;
                    if (/\d+ (months?|years?|days?)/i.test(text)) score += 2;
                    if (/million|billion/i.test(text)) score += 5;
                    if (/zero|perfect|first|award|recogni/i.test(text)) score += 2;
                    if (skill.level === 'Mastery') score += 3;
                    else if (skill.level === 'Expert') score += 2;
                    else if (skill.level === 'Advanced') score += 1;
                    if (skill.key) score += 2;
                    allEvidence.push({
                        skill: skill.name,
                        level: skill.level,
                        category: skill.category,
                        roles: skill.roles || [],
                        description: ev.description || '',
                        outcome: ev.outcome || '',
                        score
                    });
                });
            });
            allEvidence.sort((a, b) => b.score - a.score);
            const topAchievements = allEvidence.slice(0, 10);

            // --- Core competencies: key + mastery skills, deduplicated by category ---
            const keySkills = skills.filter(s => s.key || s.level === 'Mastery' || s.level === 'Expert');
            // Group into max 18 skills for the competencies grid â€” pick diverse ones
            const compSet = [];
            const seen = new Set();
            // Key skills first
            keySkills.forEach(s => { if (!seen.has(s.name) && compSet.length < 18) { compSet.push(s); seen.add(s.name); } });
            // Fill with advanced skills
            skills.filter(s => s.level === 'Advanced' && !seen.has(s.name))
                  .slice(0, 18 - compSet.length)
                  .forEach(s => { compSet.push(s); seen.add(s.name); });

            // --- Role groupings for skills section ---
            const roleGroups = {};
            (userData.roles || skillsData.roles || []).forEach(role => {
                const roleSkills = skills.filter(s => (s.roles || []).includes(role.id));
                if (roleSkills.length > 0) roleGroups[role.name] = roleSkills;
            });

            // --- Values (selected only) ---
            const selectedValues = (userData.values || [])
                .filter(v => v.selected !== false)
                .map(v => v.name || v);

            return {
                name: profile.name || 'Your Name',
                title: profile.currentTitle || 'Professional',
                company: profile.currentCompany || '',
                location: profile.location || '',
                yearsExperience: profile.yearsExperience || '',
                executiveSummary: profile.executiveSummary || userData.purpose || '',
                purpose: userData.purpose || '',
                topAchievements,
                competencies: compSet,
                roleGroups,
                values: selectedValues,
                compensation,
                generatedDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                totalSkills: skills.length,
                masteryCount: skills.filter(s => s.level === 'Mastery').length,
                expertCount: skills.filter(s => s.level === 'Expert').length
            };
        }

        function buildResumeHTML(d) {
            const name = d.name;
            const title = d.title;
            const location = d.location ? d.location.split(',').slice(-2).join(',').trim() : '';
            const comp = d.compensation;
            const salaryRange = comp && comp.standardOffer
                ? `$${Math.round(comp.conservativeOffer / 1000)}K â€“ $${Math.round(comp.competitiveOffer / 1000)}K`
                : '';

            // Achievement bullets
            const achievementHTML = d.topAchievements.map(item => {
                // Format as a strong bullet: lead with outcome, add context
                const outcome = item.outcome.trim().replace(/\.$/, '');
                const desc = item.description.trim().replace(/\.$/, '');
                // Keep description concise â€” truncate at ~120 chars
                const shortDesc = desc.length > 120 ? desc.slice(0, 117) + 'â€¦' : desc;
                return `<li><span class="ach-outcome">${outcome}.</span> <span class="ach-context">${shortDesc}.</span></li>`;
            }).join('\n');

            // Competencies grid â€” just clean names
            const compHTML = d.competencies.map(s => {
                const levelDot = s.level === 'Mastery' ? 'â—â—â—' : s.level === 'Expert' ? 'â—â—â—‹' : s.level === 'Advanced' ? 'â—â—‹â—‹' : 'â—‹â—‹â—‹';
                return `<div class="comp-item"><span class="comp-name">${s.name}</span><span class="comp-dots">${levelDot}</span></div>`;
            }).join('\n');

            // Values
            const valuesHTML = d.values.length
                ? d.values.map(v => `<span class="value-tag">${v}</span>`).join('')
                : '';

            // Salary target line (only if data exists)
            const salaryLine = salaryRange
                ? `<div class="contact-item">Target Range: ${salaryRange}</div>`
                : '';

            return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resume â€” ${name}</title>
<style>
/* =====================================================
   WORK BLUEPRINT RESUME â€” Professional Print-Ready
   Designed for: ATS readability + human presentation
   Print: File â†’ Print â†’ Save as PDF
   ===================================================== */

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --ink:       #111827;
  --ink-2:     #374151;
  --ink-3:     #6b7280;
  --rule:      #d1d5db;
  --accent:    #1d4ed8;
  --accent-lt: #eff6ff;
  --pg-w:      8.5in;
  --pg-pad:    0.65in;
}

html { font-size: 11pt; }

body {
  font-family: 'Georgia', 'Times New Roman', serif;
  color: var(--ink);
  background: #f3f4f6;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}

.page {
  width: var(--pg-w);
  min-height: 11in;
  margin: 0.4in auto;
  padding: var(--pg-pad);
  background: #fff;
  box-shadow: 0 4px 24px rgba(0,0,0,0.12);
}

/* ---- HEADER ---- */
.resume-header {
  border-bottom: 2.5pt solid var(--accent);
  padding-bottom: 14pt;
  margin-bottom: 18pt;
}

.resume-name {
  font-family: 'Arial', 'Helvetica Neue', sans-serif;
  font-size: 26pt;
  font-weight: 700;
  color: var(--ink);
  letter-spacing: -0.5pt;
  line-height: 1;
  margin-bottom: 4pt;
}

.resume-title {
  font-family: 'Arial', sans-serif;
  font-size: 12pt;
  font-weight: 400;
  color: var(--accent);
  letter-spacing: 0.3pt;
  margin-bottom: 10pt;
}

.contact-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6pt 18pt;
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--ink-2);
}

.contact-item {
  display: flex;
  align-items: center;
  gap: 4pt;
}

.contact-sep {
  color: var(--rule);
}

/* ---- SECTION STRUCTURE ---- */
.section {
  margin-bottom: 18pt;
}

.section-label {
  font-family: 'Arial', sans-serif;
  font-size: 8.5pt;
  font-weight: 700;
  letter-spacing: 1.5pt;
  text-transform: uppercase;
  color: var(--accent);
  border-bottom: 1pt solid var(--rule);
  padding-bottom: 3pt;
  margin-bottom: 10pt;
}

/* ---- SUMMARY ---- */
.summary-text {
  font-size: 10.5pt;
  line-height: 1.65;
  color: var(--ink-2);
  max-width: 100%;
}

/* ---- ACHIEVEMENTS ---- */
.achievements-list {
  list-style: none;
  padding: 0;
}

.achievements-list li {
  font-size: 10pt;
  line-height: 1.6;
  padding: 5pt 0 5pt 14pt;
  border-bottom: 0.5pt solid #f0f0f0;
  position: relative;
}

.achievements-list li::before {
  content: 'â–¸';
  position: absolute;
  left: 0;
  color: var(--accent);
  font-size: 9pt;
  top: 6pt;
}

.achievements-list li:last-child {
  border-bottom: none;
}

.ach-outcome {
  font-weight: 600;
  color: var(--ink);
}

.ach-context {
  color: var(--ink-2);
}

/* ---- COMPETENCIES GRID ---- */
.comp-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 5pt 16pt;
}

.comp-item {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  font-size: 9.5pt;
  padding: 3pt 0;
  border-bottom: 0.5pt solid #f5f5f5;
}

.comp-name {
  color: var(--ink-2);
}

.comp-dots {
  font-size: 7pt;
  color: var(--accent);
  letter-spacing: 2pt;
  flex-shrink: 0;
  margin-left: 6pt;
}

/* ---- EXPERIENCE BLOCK ---- */
.experience-block {
  margin-bottom: 12pt;
}

.exp-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 2pt;
}

.exp-title {
  font-family: 'Arial', sans-serif;
  font-size: 11pt;
  font-weight: 600;
  color: var(--ink);
}

.exp-dates {
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--ink-3);
}

.exp-company {
  font-family: 'Arial', sans-serif;
  font-size: 10pt;
  color: var(--ink-2);
  margin-bottom: 6pt;
}

/* ---- VALUES ---- */
.values-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6pt;
}

.value-tag {
  font-family: 'Arial', sans-serif;
  font-size: 9pt;
  color: var(--accent);
  background: var(--accent-lt);
  padding: 2pt 8pt;
  border-radius: 2pt;
  border: 0.5pt solid #bfdbfe;
}

/* ---- FOOTER ---- */
.resume-footer {
  margin-top: 24pt;
  padding-top: 8pt;
  border-top: 0.5pt solid var(--rule);
  font-family: 'Arial', sans-serif;
  font-size: 8pt;
  color: var(--ink-3);
  display: flex;
  justify-content: space-between;
}

/* ---- LEGEND ---- */
.legend {
  font-family: 'Arial', sans-serif;
  font-size: 8pt;
  color: var(--ink-3);
  margin-top: 6pt;
}

/* ---- PRINT ---- */
@media print {
  body { background: white; }
  .page {
    width: 100%;
    margin: 0;
    padding: 0.55in 0.65in;
    box-shadow: none;
    min-height: auto;
  }
  .section { page-break-inside: avoid; }
  .no-print { display: none !important; }
}

/* ---- SCREEN PRINT BUTTON ---- */
.print-bar {
  width: var(--pg-w);
  margin: 0 auto 10pt;
  display: flex;
  justify-content: flex-end;
  gap: 10pt;
}

.btn-print {
  font-family: 'Arial', sans-serif;
  font-size: 10pt;
  font-weight: 600;
  color: #fff;
  background: var(--accent);
  border: none;
  padding: 8pt 20pt;
  border-radius: 4pt;
  cursor: pointer;
  letter-spacing: 0.3pt;
}

.btn-print:hover { background: #1e40af; }

@media print { .print-bar { display: none; } }
</style>
</head>
<body>

<div class="print-bar no-print">
  <button class="btn-print" onclick="window.print()">â¬‡ Save as PDF</button>
</div>

<div class="page">

  <!-- HEADER -->
  <header class="resume-header">
    <div class="resume-name">${name}</div>
    <div class="resume-title">${title}</div>
    <div class="contact-row">
      ${d.company ? `<div class="contact-item">${d.company}</div><div class="contact-sep">Â·</div>` : ''}
      ${location ? `<div class="contact-item">${location}</div>` : ''}
      ${d.yearsExperience ? `<div class="contact-sep">Â·</div><div class="contact-item">${d.yearsExperience}+ Years Experience</div>` : ''}
      ${salaryLine}
    </div>
  </header>

  <!-- PROFESSIONAL SUMMARY -->
  ${d.executiveSummary ? `
  <section class="section">
    <div class="section-label">Professional Summary</div>
    <p class="summary-text">${d.executiveSummary}</p>
  </section>` : ''}

  <!-- CORE COMPETENCIES -->
  ${d.competencies.length > 0 ? `
  <section class="section">
    <div class="section-label">Core Competencies</div>
    <div class="comp-grid">
      ${compHTML}
    </div>
    <div class="legend" style="margin-top:8pt;">Proficiency: â—â—â— Mastery &nbsp;Â·&nbsp; â—â—â—‹ Expert &nbsp;Â·&nbsp; â—â—‹â—‹ Advanced</div>
  </section>` : ''}

  <!-- SELECTED ACHIEVEMENTS -->
  ${d.topAchievements.length > 0 ? `
  <section class="section">
    <div class="section-label">Selected Achievements</div>
    <ul class="achievements-list">
      ${achievementHTML}
    </ul>
  </section>` : ''}

  <!-- PROFESSIONAL EXPERIENCE -->
  <section class="section">
    <div class="section-label">Professional Experience</div>
    <div class="experience-block">
      <div class="exp-header">
        <div class="exp-title">${title}</div>
        <div class="exp-dates">Present${d.yearsExperience ? ` Â· ${d.yearsExperience}+ years` : ''}</div>
      </div>
      <div class="exp-company">${d.company}${location ? ` Â· ${location}` : ''}</div>
    </div>
    ${d.purpose ? `<p class="summary-text" style="font-size:9.5pt; color: #4b5563;">${d.purpose}</p>` : ''}
  </section>

  <!-- VALUES -->
  ${valuesHTML ? `
  <section class="section">
    <div class="section-label">Core Values &amp; Leadership Principles</div>
    <div class="values-row">${valuesHTML}</div>
  </section>` : ''}

  <!-- FOOTER -->
  <footer class="resume-footer">
    <span>Generated by Work Blueprint Â· ${d.generatedDate}</span>
    <span>${d.totalSkills} documented skills Â· ${d.masteryCount + d.expertCount} at Mastery/Expert level</span>
  </footer>

</div><!-- /page -->
</body>
</html>`;
        }
        // ===== END RESUME GENERATOR =====

        // Resize handler
        
        // ===== WORK BLUEPRINT SYSTEM =====
        
        let blueprintData = {
            outcomes: [],
            values: [],
            purpose: "",
            shareSettings: {}
        };
        
        function initBlueprint() {
            extractOutcomesFromEvidence();
            inferValues();
            renderBlueprint();
        }
        
        function extractOutcomesFromEvidence() {
            const outcomes = [];

            // Evidence now lives in userData.skills[].evidence as {description, outcome} objects.
            // We pull from there first, then fall back to the legacy skillDetails strings.
            const skills = userData.skills || skillsData.skills || [];

            skills.forEach(skill => {
                (skill.evidence || []).forEach(ev => {
                    // ev is {description, outcome} â€” use the outcome field for display
                    const outcomeText = (ev.outcome || '').trim();
                    const descText   = (ev.description || '').trim();
                    if (!outcomeText && !descText) return;

                    // Score the outcome â€” anything with a real metric qualifies
                    const combined = outcomeText + ' ' + descText;
                    const hasMetric = /\$[\d,]+[MBK]?|\d+%|\d+x|\d+ times|million|billion/i.test(combined);
                    const hasResult = /retained|increased|reduced|improved|delivered|generated|achieved|enabled|saved|prevented|launched|built|founded|established/i.test(combined);

                    if (hasMetric || hasResult) {
                        // Build a combined display text: outcome is the headline, description adds context
                        const displayText = outcomeText
                            ? (descText ? `${outcomeText} (${descText.slice(0, 100)}${descText.length > 100 ? 'â€¦' : ''})` : outcomeText)
                            : descText;

                        outcomes.push({
                            text: displayText,
                            outcome: outcomeText,
                            description: descText,
                            skill: skill.name,
                            level: skill.level,
                            category: categorizeOutcome(skill.name, combined),
                            shared: !isSensitiveContent(combined), // sensitive items default to unshared
                            sensitive: isSensitiveContent(combined),
                            coachingSuggestion: generateCoachingFor(outcomeText || descText)
                        });
                    }
                });
            });

            // Also check legacy skillDetails (skill_evidence.json strings) â€” only if no skill-based outcomes found
            if (outcomes.length === 0) {
                const quantifiedPattern = /\$[\d,]+[MBK]?|\d+%|\d+ years?/gi;
                Object.entries(skillsData.skillDetails || {}).forEach(([skillName, details]) => {
                    if (!details.evidence) return;
                    details.evidence.forEach(evidenceItem => {
                        if (typeof evidenceItem !== 'string') return;
                        const hasQuantity = quantifiedPattern.test(evidenceItem);
                        if (hasQuantity) {
                            outcomes.push({
                                text: evidenceItem,
                                skill: skillName,
                                category: categorizeOutcome(skillName, evidenceItem),
                                shared: true,
                                sensitive: isSensitiveContent(evidenceItem),
                                coachingSuggestion: generateCoachingFor(evidenceItem)
                            });
                        }
                    });
                });
            }

            // Sort: unshared (sensitive) last, then by metric strength
            outcomes.sort((a, b) => {
                if (a.sensitive && !b.sensitive) return 1;
                if (!a.sensitive && b.sensitive) return -1;
                const scoreA = /\$[\d,]+[MBK]?/i.test(a.outcome||a.text) ? 2 : /\d+%/i.test(a.outcome||a.text) ? 1 : 0;
                const scoreB = /\$[\d,]+[MBK]?/i.test(b.outcome||b.text) ? 2 : /\d+%/i.test(b.outcome||b.text) ? 1 : 0;
                return scoreB - scoreA;
            });

            blueprintData.outcomes = outcomes;
        }
        
        function categorizeOutcome(skillName, evidence) {
            if (evidence.includes('$') || evidence.includes('revenue') || evidence.includes('sales')) return 'Business Impact';
            if (evidence.includes('predict') || evidence.includes('accuracy') || evidence.includes('%')) return 'Strategic Foresight';
            if (evidence.includes('emergency') || evidence.includes('crisis') || evidence.includes('zero')) return 'Crisis Leadership';
            if (evidence.includes('founded') || evidence.includes('built') || evidence.includes('created')) return 'Entrepreneurial';
            if (evidence.includes('published') || evidence.includes('speaker') || evidence.includes('featured')) return 'Thought Leadership';
            if (evidence.includes('recovery') || evidence.includes('sobriety') || evidence.includes('advocacy')) return 'Advocacy Impact';
            return 'Professional Achievement';
        }
        
        function isSensitiveContent(text) {
            const sensitiveKeywords = ['recovery', 'sobriety', 'addiction', 'Kyle', 'son', 'death', 'overdose', 'mental health'];
            return sensitiveKeywords.some(keyword => text.toLowerCase().includes(keyword));
        }
        
        function generateCoachingFor(outcome) {
            if (!outcome.includes('$') && !outcome.includes('%')) {
                return "Consider adding quantification: What was the measurable impact?";
            }
            if (!outcome.includes('client') && !outcome.includes('company') && !outcome.includes('people')) {
                return "Strengthen by adding: Who benefited from this outcome?";
            }
            if (outcome.length < 50) {
                return "Add context: What decision did this enable or what changed as a result?";
            }
            return null;
        }
        
        function inferValues() {
            // STEP 1: Use profile values if they exist â€” they are the source of truth.
            // Only fall back to defaults if profile has no values at all.
            const profileValues = userData.values || [];
            
            if (profileValues.length > 0) {
                // Profile has values â€” use them, preserving selected state
                blueprintData.values = profileValues.map(v => ({
                    name: v.name,
                    description: v.description || '',
                    selected: v.selected !== undefined ? v.selected : true,
                    inferred: v.inferred || false
                }));
            } else {
                // No profile values â€” use a minimal generic set as starting point
                // (Wizard will replace these with AI-inferred values based on resume)
                blueprintData.values = [
                    { name: "Intellectual Integrity",      description: "Evidence-based decisions. Challenge assumptions before accepting conclusions.", selected: true,  inferred: true },
                    { name: "Outcome-Focused Excellence",  description: "Judge by impact delivered, not activity performed. Results drive everything.",  selected: true,  inferred: true },
                    { name: "Continuous Learning",         description: "Seek disconfirming evidence. Update beliefs when data changes.",                selected: true,  inferred: true },
                    { name: "Authentic Leadership",        description: "Lead with transparency and truth. Strength through self-awareness.",            selected: false, inferred: true },
                    { name: "Customer-Centric Innovation", description: "Solve real problems with elegant solutions. Understand needs before building.", selected: false, inferred: true }
                ];
            }
            
            // STEP 2: Use profile purpose if it exists.
            // Only use placeholder if profile has no purpose.
            if (userData.purpose && userData.purpose.trim().length > 0) {
                blueprintData.purpose = userData.purpose;
            } else {
                blueprintData.purpose = "";
            }
        }
        
        function renderBlueprint() {
            const view = document.getElementById('blueprintView');
            
            view.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-header">
                        <h1 class="blueprint-title">Work Blueprint</h1>
                        <p class="blueprint-subtitle">Your Consent-Based Professional Profile</p>
                        <p class="blueprint-tagline">Control what you share. Tell your story, your way.</p>
                    </div>
                    
                    ${renderMarketValuationSection()}
                    ${renderOutcomesSection()}
                    ${renderValuesSection()}
                    ${renderPurposeSection()}
                    ${renderExportSection()}
                </div>
            `;
        }
        
        function renderMarketValuationSection() {
            const totalValue = calculateTotalMarketValue();
            
            if (!totalValue || totalValue.total === 0 || !skillValuations || Object.keys(skillValuations.skillBaseValues || {}).length === 0) {
                return ''; // Don't show if data not loaded
            }
            
            const negotiationGap = totalValue.yourWorth - totalValue.standardOffer;
            
            return `
                <div class="blueprint-section" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(96, 165, 250, 0.1) 100%); border: 2px solid rgba(16, 185, 129, 0.3); margin-bottom: 30px;">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">ðŸ’°</span>
                            <span>Your Market Valuation</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; padding: 30px 20px;">
                        <div style="color: #9ca3af; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">
                            Your Market Worth
                        </div>
                        <div style="font-size: 3em; font-weight: 700; color: #10b981; margin-bottom: 10px;">
                            $${totalValue.yourWorth.toLocaleString()}<span style="font-size: 0.4em; color: #9ca3af;">/year</span>
                        </div>
                        <div style="color: #d1d5db; font-size: 1em; margin-bottom: 8px;">
                            ${totalValue.roleLevel} Level â€¢ ${totalValue.compaRatio}% of Market Median
                        </div>
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 30px;">
                            Based on top 10 skills â€¢ ${userData.profile.location}
                        </div>
                        
                        <div style="background: rgba(255, 255, 255, 0.03); padding: 25px; border-radius: 12px; margin-bottom: 25px;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 15px; text-align: left;">ðŸ“Š EXPECTED OFFER RANGES (Compa-Ratio Model)</div>
                            <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 20px; text-align: left;">
                                Companies typically offer 75-95% of market value. You negotiate within this range.
                            </div>
                            
                            <div style="display: grid; gap: 12px;">
                                <div style="background: rgba(107, 114, 128, 0.2); padding: 15px; border-radius: 8px; border-left: 3px solid #9ca3af; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #9ca3af; font-weight: 600; margin-bottom: 3px;">Conservative Offer (75%)</div>
                                            <div style="color: #d1d5db; font-size: 0.85em;">Budget-constrained companies</div>
                                        </div>
                                        <div style="color: #e0e0e0; font-size: 1.3em; font-weight: 700;">$${totalValue.conservativeOffer.toLocaleString()}</div>
                                    </div>
                                </div>
                                
                                <div style="background: rgba(96, 165, 250, 0.2); padding: 15px; border-radius: 8px; border-left: 3px solid #60a5fa; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 3px;">Standard Offer (85%)</div>
                                            <div style="color: #d1d5db; font-size: 0.85em;">Most common initial offers</div>
                                        </div>
                                        <div style="color: #e0e0e0; font-size: 1.3em; font-weight: 700;">$${totalValue.standardOffer.toLocaleString()}</div>
                                    </div>
                                </div>
                                
                                <div style="background: rgba(16, 185, 129, 0.2); padding: 15px; border-radius: 8px; border-left: 3px solid #10b981; text-align: left;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: #10b981; font-weight: 600; margin-bottom: 3px;">Competitive Offer (95%)</div>
                                            <div style="color: #d1d5db; font-size: 0.85em;">Top companies competing for talent</div>
                                        </div>
                                        <div style="color: #e0e0e0; font-size: 1.3em; font-weight: 700;">$${totalValue.competitiveOffer.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; padding: 15px; background: rgba(251, 191, 36, 0.2); border-radius: 8px; text-align: left;">
                                <div style="color: #fbbf24; font-weight: 600; margin-bottom: 5px;">ðŸ’¡ Your Negotiation Gap: $${negotiationGap.toLocaleString()}</div>
                                <div style="color: #d1d5db; font-size: 0.9em;">
                                    Between standard offer ($${totalValue.standardOffer.toLocaleString()}) and your worth ($${totalValue.yourWorth.toLocaleString()}). This is your leverage.
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; max-width: 800px; margin: 0 auto 25px;">
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 18px; border-radius: 10px;">
                                <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 5px;">Market Rate (${totalValue.percentile} %ile)</div>
                                <div style="color: #60a5fa; font-size: 1.3em; font-weight: 700;">$${totalValue.marketRate.toLocaleString()}</div>
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 18px; border-radius: 10px;">
                                <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 5px;">Your Premium</div>
                                <div style="color: #10b981; font-size: 1.3em; font-weight: 700;">+$${totalValue.premiumAmount.toLocaleString()}</div>
                                <div style="color: #9ca3af; font-size: 0.75em; margin-top: 3px;">+${Math.round(((totalValue.yourWorth - totalValue.marketRate) / totalValue.marketRate) * 100)}%</div>
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.05); padding: 18px; border-radius: 10px;">
                                <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 5px;">Compa-Ratio</div>
                                <div style="color: #e0e0e0; font-size: 1.3em; font-weight: 700;">${totalValue.compaRatio}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin: 20px;">
                        <div style="color: #60a5fa; font-weight: 600; margin-bottom: 10px;">ðŸŽ¯ How This Was Calculated</div>
                        <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">
                            <strong>Method:</strong> Impact-based role tier + skill premiums
                            <br><br>
                            <strong>Base Market Rate:</strong> $${totalValue.marketRate.toLocaleString()} (${totalValue.roleLevel} level, ${totalValue.percentile} percentile)
                            <br><strong>Critical Impact Skills (${totalValue.criticalSkills.length}):</strong> +$${totalValue.criticalBonus.toLocaleString()}
                            <br><strong>High Impact Skills (${totalValue.highSkills.length}):</strong> +$${totalValue.highBonus.toLocaleString()}
                            <br><strong>Rare Skill Combinations:</strong> +$${totalValue.rarityBonus.toLocaleString()}
                            <br><strong>Location:</strong> ${userData.profile.location} (Ã—${skillValuations.locationMultipliers[userData.profile.location] || 1.0})
                            <br><br>
                            <strong>Your Worth:</strong> $${totalValue.yourWorth.toLocaleString()} (${Math.round(((totalValue.yourWorth - totalValue.marketRate) / totalValue.marketRate) * 100)}% above market)
                        </div>
                    </div>
                    
                    <div style="margin: 20px;">
                        <div style="color: #60a5fa; font-weight: 600; margin-bottom: 15px;">ðŸ”¥ Top 10 Skills Used in Calculation:</div>
                        <div style="color: #9ca3af; font-size: 0.85em; margin-bottom: 12px;">
                            Roles typically require 10-15 core skills, not all ${skillsData.skills.length}. These are your highest impact:
                        </div>
                        <div style="display: grid; gap: 8px;">
                            ${totalValue.top10Skills.map((skill, idx) => {
                                const isCritical = skill.impact === 'Critical';
                                return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${isCritical ? 'rgba(239, 68, 68, 0.15)' : 'rgba(251, 191, 36, 0.15)'}; border-radius: 6px; border-left: 3px solid ${isCritical ? '#ef4444' : '#fbbf24'};">
                                    <div>
                                        <span style="color: #9ca3af; font-weight: 600; margin-right: 8px;">${idx + 1}.</span>
                                        <span style="color: #e0e0e0;">${skill.skill}</span>
                                        <span style="color: #9ca3af; font-size: 0.85em; margin-left: 8px;">(${skill.level})</span>
                                    </div>
                                    <div style="color: ${isCritical ? '#ef4444' : '#fbbf24'}; font-weight: 600; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px;">
                                        ${isCritical ? 'â­' : 'ðŸ”¥'} ${skill.impactLabel}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        <div style="color: #9ca3af; font-size: 0.8em; margin-top: 12px; font-style: italic;">
                            Note: Impact ratings show relative strategic value. Compensation based on combined skill portfolio + role tier.
                        </div>
                    </div>
                    
                    <div style="margin: 20px; padding: 20px; background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
                        <div style="color: #fbbf24; font-weight: 600; margin-bottom: 10px;">ðŸ’¼ USING THIS IN NEGOTIATIONS</div>
                        <div style="color: #d1d5db; font-size: 0.9em; line-height: 1.8;">
                            <strong>The Strategy:</strong>
                            <br>â€¢ Companies typically offer 75-90% of target range
                            <br>â€¢ You negotiate to 90-110% based on your skill profile
                            <br>â€¢ Your ${totalValue.criticalSkills.length} Critical Impact skills justify premium positioning
                            <br>â€¢ Combined with ${totalValue.highSkills.length} High Impact skills, you're in top competitive tier
                            <br><br>
                            <strong>Reference Your Top 10 Skills:</strong> These demonstrate why you command premium compensation above standard offers for ${totalValue.roleLevel} roles
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin: 20px; flex-wrap: wrap;">
                        <button class="export-btn-large" onclick="showValuationBreakdown()" style="flex: 1; min-width: 200px;">
                            ðŸ“Š View All ${skillsData.skills.length} Skills
                        </button>
                        <button class="export-btn-large" onclick="openSkillManagement()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; color: white;">
                            ðŸ“Š Manage Skills
                        </button>
                        <button class="export-btn-large" onclick="openCustomSkillBuilder()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; color: white;">
                            â­ Create Custom Skill
                        </button>
                        </button>
                        <button class="export-btn-large" onclick="showNegotiationGuide()" style="flex: 1; min-width: 200px; background: rgba(251, 191, 36, 0.2); border-color: #fbbf24; color: #fbbf24;">
                            ðŸ’¼ Detailed Negotiation Guide
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderOutcomesSection() {
            const outcomes = blueprintData.outcomes;
            
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">ðŸ“Š</span>
                            <span>Outcomes I Drive</span>
                            <span class="section-count">${outcomes.length}</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ðŸ’¡ COACHING TIP
                        </div>
                        <div class="coaching-tip-content">
                            Top performers quantify impact. Notice the pattern:
                            <ul>
                                <li><strong>Numbers:</strong> $200M, 85%, 5 years, zero injuries</li>
                                <li><strong>Comparisons:</strong> "5 years early", "before market consensus"</li>
                                <li><strong>Consequences:</strong> What changed because of this?</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div id="outcomesContainer">
                        ${outcomes.map((outcome, idx) => renderOutcomeItem(outcome, idx)).join('')}
                    </div>
                    
                    <button class="add-outcome-btn" onclick="addCustomOutcome()">
                        <span>âž•</span>
                        <span>Add Custom Outcome</span>
                    </button>
                    
                    <div class="reflection-prompts">
                        <div class="reflection-title">ðŸ’­ REFLECTION PROMPTS</div>
                        <ul>
                            <li>What problem did you solve that others couldn't?</li>
                            <li>What changed because of your work?</li>
                            <li>What would have happened without you?</li>
                            <li>How do you know this worked? (proof/evidence)</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function renderOutcomeItem(outcome, idx) {
            const shareChecked = outcome.shared ? 'checked' : '';
            const sensitiveWarning = outcome.sensitive ? 
                '<span class="meta-tag sensitive">âš ï¸ SENSITIVE: Consider context before sharing</span>' : '';
            const coachingNote = outcome.coachingSuggestion ? 
                `<div class="outcome-coaching">ðŸ’¡ ${outcome.coachingSuggestion}</div>` : '';
            
            return `
                <div class="outcome-item" data-idx="${idx}">
                    <div class="outcome-header">
                        <div class="outcome-text">${outcome.text}</div>
                        <div class="outcome-controls">
                            <label class="share-toggle">
                                <input type="checkbox" ${shareChecked} onchange="toggleOutcomeShare(${idx})">
                                <span class="share-toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="outcome-meta">
                        <span class="meta-tag category">ðŸ“‚ ${outcome.category}</span>
                        <span class="meta-tag evidence">âœ“ From: ${outcome.skill}</span>
                        ${sensitiveWarning}
                    </div>
                    
                    ${coachingNote}
                    
                    <div class="outcome-actions">
                        <button class="outcome-btn" onclick="editOutcome(${idx})">âœŽ Edit</button>
                        <button class="outcome-btn" onclick="viewOutcomeEvidence(${idx})">ðŸ” View Evidence</button>
                    </div>
                </div>
            `;
        }
        
        function renderValuesSection() {
            const values = blueprintData.values;
            const selectedCount = values.filter(v => v.selected).length;
            
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">â­</span>
                            <span>Values & Principles</span>
                            <span class="section-count">${selectedCount} selected</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ðŸ’¡ VALUES THAT SHOW, NOT TELL
                        </div>
                        <div class="coaching-tip-content">
                            These values are <strong>inferred from your evidence</strong> - they're not aspirational, they're demonstrated. 
                            Select 3-5 that best represent how you actually operate.
                        </div>
                    </div>
                    
                    <div class="values-grid">
                        ${values.map((value, idx) => renderValueCard(value, idx)).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderValueCard(value, idx) {
            const selectedClass = value.selected ? 'selected' : '';
            const inferredBadge = value.inferred ? '<span style="color: #10b981; font-size: 0.75em;">âœ“ Inferred from evidence</span>' : '';
            
            return `
                <div class="value-card ${selectedClass}" onclick="toggleValue(${idx})">
                    <div class="value-title">${value.name}</div>
                    <div class="value-description">${value.description}</div>
                    ${inferredBadge}
                </div>
            `;
        }
        
        function renderPurposeSection() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">ðŸŽ¯</span>
                            <span>Purpose Statement</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ðŸ’¡ YOUR "WHY"
                        </div>
                        <div class="coaching-tip-content">
                            This statement is inferred from your work and advocacy. Edit to make it yours.
                            Strong purpose statements connect what you do to why it matters.
                        </div>
                    </div>
                    
                    <textarea class="purpose-editor" onchange="updatePurpose(this.value)">${blueprintData.purpose}</textarea>
                </div>
            `;
        }
        
        function renderExportSection() {
            const sharedOutcomes = blueprintData.outcomes.filter(o => o.shared).length;
            const sharedValues = blueprintData.values.filter(v => v.selected).length;
            
            return `
                <div class="export-section">
                    <div class="export-title">ðŸ“¤ Export Your Work Blueprint</div>
                    <p style="color: #d1d5db; margin-bottom: 20px;">
                        Sharing: ${sharedOutcomes} outcomes, ${sharedValues} values, purpose statement
                    </p>
                    <div class="export-buttons">
                        <button class="export-btn-large" onclick="exportBlueprint('pdf')">
                            ðŸ“„ Export as PDF
                        </button>
                        <button class="export-btn-large" onclick="exportBlueprint('json')">
                            ðŸ’¾ Export as JSON
                        </button>
                        <button class="export-btn-large" onclick="exportBlueprint('link')">
                            ðŸ”— Create Shareable Link
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Blueprint interaction functions
        function toggleOutcomeShare(idx) {
            blueprintData.outcomes[idx].shared = !blueprintData.outcomes[idx].shared;
            saveUserData();  // Auto-save
        }
        
        function editOutcome(idx) {
            const outcome = blueprintData.outcomes[idx];
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Edit Outcome</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Refine how you describe this achievement</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Outcome Text
                        </label>
                        <textarea id="editOutcomeText" style="
                            width: 100%;
                            min-height: 120px;
                            padding: 15px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                            line-height: 1.6;
                            font-family: inherit;
                            resize: vertical;
                        ">${outcome.text}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Category
                        </label>
                        <select id="editOutcomeCategory" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                        ">
                            <option value="Business Impact" ${outcome.category === 'Business Impact' ? 'selected' : ''}>Business Impact</option>
                            <option value="Strategic Foresight" ${outcome.category === 'Strategic Foresight' ? 'selected' : ''}>Strategic Foresight</option>
                            <option value="Crisis Leadership" ${outcome.category === 'Crisis Leadership' ? 'selected' : ''}>Crisis Leadership</option>
                            <option value="Entrepreneurial" ${outcome.category === 'Entrepreneurial' ? 'selected' : ''}>Entrepreneurial</option>
                            <option value="Thought Leadership" ${outcome.category === 'Thought Leadership' ? 'selected' : ''}>Thought Leadership</option>
                            <option value="Advocacy Impact" ${outcome.category === 'Advocacy Impact' ? 'selected' : ''}>Advocacy Impact</option>
                            <option value="Professional Achievement" ${outcome.category === 'Professional Achievement' ? 'selected' : ''}>Professional Achievement</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="editOutcomeSensitive" ${outcome.sensitive ? 'checked' : ''} style="
                                width: 20px;
                                height: 20px;
                                cursor: pointer;
                            ">
                            <span style="color: #ef4444; font-weight: 600;">Mark as Sensitive Content</span>
                        </label>
                        <p style="color: #9ca3af; font-size: 0.85em; margin-top: 5px; margin-left: 30px;">
                            Flag personal stories (recovery, loss, etc.) that require context before sharing
                        </p>
                    </div>
                    
                    <div style="background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <strong style="color: #fbbf24;">ðŸ’¡ COACHING TIP:</strong>
                        <p style="color: #d1d5db; margin-top: 8px; font-size: 0.9em;">
                            Strong outcomes include:
                            <br>â€¢ Quantification (numbers, percentages, time saved)
                            <br>â€¢ Who benefited (clients, company, team)
                            <br>â€¢ What changed as a result
                            <br>â€¢ Comparison or context (vs industry average, timeline)
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="action-btn" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Cancel
                        </button>
                        <button class="export-btn-large" onclick="saveOutcomeEdit(${idx})" style="padding: 10px 20px;">
                            ðŸ’¾ Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function saveOutcomeEdit(idx) {
            const newText = document.getElementById('editOutcomeText').value;
            const newCategory = document.getElementById('editOutcomeCategory').value;
            const newSensitive = document.getElementById('editOutcomeSensitive').checked;
            
            // Update outcome
            blueprintData.outcomes[idx].text = newText;
            blueprintData.outcomes[idx].category = newCategory;
            blueprintData.outcomes[idx].sensitive = newSensitive;
            
            // Regenerate coaching suggestion
            blueprintData.outcomes[idx].coachingSuggestion = generateCoachingFor(newText);
            
            // Save to localStorage
            saveUserData();
            
            // Close modal and refresh
            closeExportModal();
            renderBlueprint();
            
            alert('Outcome updated successfully!');
        }
        
        function viewOutcomeEvidence(idx) {
            const outcome = blueprintData.outcomes[idx];
            const skill = skillsData.skills.find(s => s.name === outcome.skill);
            if (skill) {
                openSkillModal(outcome.skill, skill);
            }
        }
        
        function addCustomOutcome() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Add Custom Outcome</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Describe an achievement or impact you've made</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Outcome Template
                        </label>
                        <select id="outcomeTemplate" onchange="fillOutcomeTemplate(this.value)" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                            margin-bottom: 15px;
                        ">
                            <option value="">-- Choose a template (optional) --</option>
                            <option value="revenue">Revenue/Financial Impact</option>
                            <option value="team">Team Building/Leadership</option>
                            <option value="innovation">Innovation/New Capability</option>
                            <option value="efficiency">Efficiency/Process Improvement</option>
                            <option value="crisis">Crisis Management</option>
                            <option value="strategic">Strategic Initiative</option>
                            <option value="thought">Thought Leadership</option>
                        </select>
                        
                        <textarea id="customOutcomeText" placeholder="Example: Led strategic initiative that increased revenue by 40% year-over-year through new market expansion" style="
                            width: 100%;
                            min-height: 120px;
                            padding: 15px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                            line-height: 1.6;
                            font-family: inherit;
                            resize: vertical;
                        "></textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Category
                        </label>
                        <select id="customOutcomeCategory" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                        ">
                            <option value="Business Impact">Business Impact</option>
                            <option value="Strategic Foresight">Strategic Foresight</option>
                            <option value="Crisis Leadership">Crisis Leadership</option>
                            <option value="Entrepreneurial">Entrepreneurial</option>
                            <option value="Thought Leadership">Thought Leadership</option>
                            <option value="Advocacy Impact">Advocacy Impact</option>
                            <option value="Professional Achievement">Professional Achievement</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">
                            Related Skill (Optional)
                        </label>
                        <select id="customOutcomeSkill" style="
                            width: 100%;
                            padding: 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border: 1px solid rgba(96, 165, 250, 0.3);
                            border-radius: 8px;
                            color: #e0e0e0;
                            font-size: 1em;
                        ">
                            <option value="">-- None --</option>
                            ${skillsData.skills.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div style="background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <strong style="color: #fbbf24;">ðŸ’¡ REFLECTION PROMPTS:</strong>
                        <ul style="color: #d1d5db; margin-top: 8px; font-size: 0.9em; margin-left: 20px;">
                            <li>What problem did you solve that others couldn't?</li>
                            <li>What measurable change resulted from your work?</li>
                            <li>Who benefited and how do you know?</li>
                            <li>What would have happened without your contribution?</li>
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="action-btn" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Cancel
                        </button>
                        <button class="export-btn-large" onclick="saveCustomOutcome()" style="padding: 10px 20px;">
                            âž• Add Outcome
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function fillOutcomeTemplate(type) {
            const textarea = document.getElementById('customOutcomeText');
            const templates = {
                revenue: 'Led [initiative] that increased revenue by [X%/amount] through [approach/method]. Resulted in [specific outcome/benefit].',
                team: 'Built and scaled [team/function] from [starting point] to [end state]. Team delivered [key achievements] within [timeframe].',
                innovation: 'Created [new capability/system] that enabled [organization/team] to [achieve what]. Adopted by [number/scope] with [measurable impact].',
                efficiency: 'Redesigned [process/system] reducing [time/cost/effort] by [X%]. Eliminated [waste/bottleneck] affecting [scope/scale].',
                crisis: 'Managed [crisis/incident] under [constraints]. Achieved [outcome] with [metric: zero injuries/minimal impact/rapid resolution].',
                strategic: 'Developed [strategy/framework] for [challenge/opportunity]. Predicted [outcome] [timeframe] ahead of market, enabling [advantage/benefit].',
                thought: 'Published [content type] reaching [audience size]. [Recognition/adoption]: [specific examples of influence/impact].'
            };
            
            if (templates[type]) {
                textarea.value = templates[type];
                textarea.focus();
            }
        }
        
        function saveCustomOutcome() {
            const text = document.getElementById('customOutcomeText').value.trim();
            if (!text) {
                alert('Please enter an outcome description');
                return;
            }
            
            const category = document.getElementById('customOutcomeCategory').value;
            const skill = document.getElementById('customOutcomeSkill').value;
            
            // Create new outcome
            const newOutcome = {
                text: text,
                skill: skill || 'Custom',
                category: category,
                shared: true,
                sensitive: false,
                coachingSuggestion: generateCoachingFor(text)
            };
            
            // Add to beginning of outcomes array
            blueprintData.outcomes.unshift(newOutcome);
            
            // Save
            saveUserData();
            
            // Close and refresh
            closeExportModal();
            renderBlueprint();
            
            alert('Custom outcome added successfully!');
        }
        
        function toggleValue(idx) {
            blueprintData.values[idx].selected = !blueprintData.values[idx].selected;
            saveUserData();  // Auto-save
            renderBlueprint();
        }
        
        function updatePurpose(newPurpose) {
            blueprintData.purpose = newPurpose;
            saveUserData();  // Auto-save
        }
        
        function exportBlueprint(format) {
            const sharedData = {
                outcomes: blueprintData.outcomes.filter(o => o.shared),
                values: blueprintData.values.filter(v => v.selected),
                purpose: blueprintData.purpose
            };
            
            if (format === 'json') {
                const dataStr = JSON.stringify(sharedData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'work-blueprint.json';
                link.click();
                URL.revokeObjectURL(url);
            } else if (format === 'pdf') {
                generatePDF(sharedData);
            } else if (format === 'link') {
                generateShareableLink(sharedData);
            }
        }
        
        function generatePDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const maxWidth = pageWidth - (margin * 2);
            
            // Header
            doc.setFontSize(24);
            doc.setTextColor(96, 165, 250);
            doc.text(`${userData.profile.name || 'Your'} Work Blueprint`, margin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setTextColor(156, 163, 175);
            doc.text(new Date().toLocaleDateString(), margin, yPos);
            yPos += 15;
            
            // Outcomes Section
            if (data.outcomes.length > 0) {
                doc.setFontSize(16);
                doc.setTextColor(96, 165, 250);
                doc.text('Outcomes I Drive', margin, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(55, 65, 81);
                
                data.outcomes.forEach((outcome, idx) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Bullet point
                    doc.circle(margin + 2, yPos - 1.5, 1, 'F');
                    
                    // Wrap text
                    const lines = doc.splitTextToSize(outcome.text, maxWidth - 10);
                    doc.text(lines, margin + 6, yPos);
                    yPos += (lines.length * 5) + 3;
                    
                    // Category tag
                    doc.setFontSize(8);
                    doc.setTextColor(96, 165, 250);
                    doc.text(`[${outcome.category}]`, margin + 6, yPos);
                    yPos += 8;
                    doc.setFontSize(10);
                    doc.setTextColor(55, 65, 81);
                });
                
                yPos += 5;
            }
            
            // Values Section
            if (data.values.length > 0) {
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(16);
                doc.setTextColor(96, 165, 250);
                doc.text('Core Values', margin, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(55, 65, 81);
                
                data.values.forEach((value, idx) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`â€¢ ${value.name}`, margin, yPos);
                    yPos += 5;
                    
                    doc.setFont(undefined, 'normal');
                    const descLines = doc.splitTextToSize(value.description, maxWidth - 10);
                    doc.text(descLines, margin + 6, yPos);
                    yPos += (descLines.length * 5) + 5;
                });
                
                yPos += 5;
            }
            
            // Purpose Section
            if (data.purpose) {
                if (yPos > 240) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(16);
                doc.setTextColor(96, 165, 250);
                doc.text('Purpose Statement', margin, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(55, 65, 81);
                const purposeLines = doc.splitTextToSize(data.purpose, maxWidth);
                doc.text(purposeLines, margin, yPos);
                yPos += (purposeLines.length * 5) + 10;
            }
            
            // Professional Context
            if (yPos > 240) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(16);
            doc.setTextColor(96, 165, 250);
            doc.text('Professional Context', margin, yPos);
            yPos += 8;
            
            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81);
            
            if (userData.profile.location) {
                doc.text(`Location: ${userData.profile.location}`, margin, yPos);
                yPos += 6;
            }
            
            doc.text(`Seniority Level: ${userData.preferences.seniorityLevel}`, margin, yPos);
            yPos += 6;
            
            doc.text(`Skills: ${skillsData.skills.length} professional competencies`, margin, yPos);
            yPos += 6;
            
            doc.text(`Career Roles: ${skillsData.roles.length} dimensions`, margin, yPos);
            yPos += 10;
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(156, 163, 175);
            const footerText = 'Generated by Work Blueprint System';
            const footerWidth = doc.getTextWidth(footerText);
            doc.text(footerText, (pageWidth - footerWidth) / 2, 285);
            
            // Save
            const fileName = `work-blueprint-${userData.profile.name || 'profile'}.pdf`.replace(/\s+/g, '-').toLowerCase();
            doc.save(fileName);
        }
        
        function generateShareableLink(data) {
            // Basic implementation - encode data as base64 URL parameter
            const jsonStr = JSON.stringify(data);
            const base64 = btoa(jsonStr);
            const shareUrl = `${window.location.origin}${window.location.pathname}?share=${base64}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert(`Shareable link copied to clipboard!\n\nLink is valid and contains your selected data.\n\nNote: This is a basic implementation. For production, you'd want:\nâ€¢ Server-side storage\nâ€¢ Encryption\nâ€¢ Expiration dates\nâ€¢ Access tracking\n\n${shareUrl.substring(0, 100)}...`);
            }).catch(() => {
                alert(`Shareable link generated:\n\n${shareUrl}\n\nCopy this link to share your Work Blueprint.`);
            });
        }
        
        // ===== OPPORTUNITIES SYSTEM =====

        let currentMatchThreshold = 60;
        let opportunitiesData = [];
        
        function initOpportunities() {
            const view = document.getElementById('opportunitiesView');
            
            view.innerHTML = `
                <div class="opportunities-header">
                    <h2 class="opportunities-title">Job Opportunities</h2>
                    <p class="opportunities-subtitle">Matching your skills to open positions across the US</p>
                    
                    <div class="opportunities-filters">
                        <div class="filter-section">
                            <label class="filter-section-label">Minimum Match Score</label>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <input type="range" min="0" max="100" value="60" class="match-slider" 
                                       oninput="updateMatchThreshold(this.value)">
                                <span class="match-value" id="matchValue">60%+</span>
                            </div>
                        </div>
                        
                        <div class="filter-section">
                            <label class="filter-section-label">Search Roles</label>
                            <button class="action-btn" onclick="searchOpportunities()" style="width: auto;">
                                ðŸ” Find Matching Jobs
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="opportunitiesResults"></div>
            `;
            
            // Auto-fetch real jobs from multiple sources
            searchOpportunities();
        }
        
        function updateMatchThreshold(value) {
            currentMatchThreshold = parseInt(value);
            document.getElementById('matchValue').textContent = value + '%+';
            filterOpportunities();
        }
        
        function calculateMatchScore(jobSkills, requiredSkills) {
            let totalPoints = 0;
            let earnedPoints = 0;
            let matchedSkills = [];
            let gapSkills = [];
            
            // Build lookup of your skills
            const yourSkillsMap = {};
            skillsData.skills.forEach(skill => {
                yourSkillsMap[skill.name.toLowerCase()] = skill;
                // Also add simplified versions
                const simplified = skill.name.toLowerCase()
                    .replace(/\s*&\s*/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                yourSkillsMap[simplified] = skill;
            });
            
            // Score each required skill
            requiredSkills.forEach(reqSkill => {
                const reqLower = reqSkill.toLowerCase();
                let matched = false;
                let matchPoints = 5; // base points for any match
                
                // Try exact match first
                if (yourSkillsMap[reqLower]) {
                    const yourSkill = yourSkillsMap[reqLower];
                    matched = true;
                    
                    // Weight by proficiency
                    if (yourSkill.level === 'Mastery') {
                        matchPoints = 10;
                    } else if (yourSkill.level === 'Advanced') {
                        matchPoints = 7;
                    } else if (yourSkill.level === 'Proficient') {
                        matchPoints = 5;
                    }
                    
                    // Bonus for core differentiators
                    if (yourSkill.key) {
                        matchPoints += 5;
                    }
                    
                    matchedSkills.push(yourSkill.name);
                } else {
                    // Try fuzzy matching for related skills
                    for (const [skillName, skillData] of Object.entries(yourSkillsMap)) {
                        if (reqLower.includes(skillName) || skillName.includes(reqLower)) {
                            matched = true;
                            matchPoints = 3; // partial match points
                            matchedSkills.push(skillData.name);
                            break;
                        }
                    }
                }
                
                totalPoints += 10; // Each required skill worth 10 points max
                if (matched) {
                    earnedPoints += matchPoints;
                } else {
                    gapSkills.push(reqSkill);
                }
            });
            
            const matchPercent = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
            
            return {
                score: matchPercent,
                matched: [...new Set(matchedSkills)], // Remove duplicates
                gaps: gapSkills
            };
        }
        
        function loadSampleOpportunities() {
            // Show loading state
            const resultsDiv = document.getElementById('opportunitiesResults');
            resultsDiv.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p style="font-size: 1.2em;">Searching RemoteOK for real jobs...</p>
                    <p style="margin-top: 10px; color: #6b7280;">Fetching opportunities that match your skills</p>
                </div>
            `;
            
            // Fetch real jobs from RemoteOK API
            fetchRemoteOKJobs();
        }
        
        async function fetchRemoteOKJobs() {
            try {
                // RemoteOK provides a public JSON API
                const response = await fetch('https://remoteok.com/api');
                const data = await response.json();
                
                // First item is metadata, skip it
                const jobs = data.slice(1);
                
                // STEP 1: Filter by ROLE LEVEL using user preferences
                const seniorityKeywords = userData.preferences.seniorityKeywords;
                const excludeKeywords = userData.preferences.excludeRoles;
                
                const executiveJobs = jobs.filter(job => {
                    const titleLower = job.position.toLowerCase();
                    
                    // If user sets threshold VERY low (0-20%), bypass ALL seniority filtering
                    // This shows them everything including jobs they're overqualified for
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true; // Show everything
                    }
                    
                    // EXCLUDE: Roles user doesn't want
                    if (excludeKeywords.some(keyword => titleLower.includes(keyword))) {
                        return false;
                    }
                    
                    // INCLUDE: Must match user's seniority level
                    const hasSeniority = seniorityKeywords.some(keyword => titleLower.includes(keyword));
                    if (!hasSeniority) return false;
                    
                    // STEP 2: Filter by ROLE TYPE using user's strategic keywords
                    const strategicKeywords = userData.preferences.strategicKeywords;
                    const hasStrategicRole = strategicKeywords.some(keyword => titleLower.includes(keyword));
                    
                    return hasStrategicRole;
                });
                
                console.log(`RemoteOK: Filtered to ${executiveJobs.length} matching roles from ${jobs.length} total`);
                
                // STEP 3: Enhanced skill extraction and matching
                const qualifiedJobs = executiveJobs.map(job => {
                    const extractedSkills = extractSkillsFromJobEnhanced(job);
                    const match = calculateMatchScore(extractedSkills, extractedSkills);
                    
                    return {
                        id: job.id || Math.random().toString(36),
                        title: job.position,
                        company: job.company,
                        location: job.location || 'Remote',
                        type: 'Full-time',
                        url: job.url || `https://remoteok.com/remote-jobs/${job.slug}`,
                        salary: job.salary_max ? `$${Math.round(job.salary_min/1000) || 0}k-${Math.round(job.salary_max/1000)}k` : 'Not specified',
                        description: job.description,
                        tags: job.tags || [],
                        requiredSkills: extractedSkills,
                        matchScore: match.score,
                        matchedSkills: match.matched,
                        gapSkills: match.gaps,
                        source: 'RemoteOK'
                    };
                }).filter(job => {
                    // STEP 4: Apply flexible quality thresholds
                    // If threshold is VERY low (0-20%), show ALL jobs (user wants to see everything)
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true; // Bypass all quality filters
                    }
                    
                    // Otherwise use normal filters
                    const meetsSkillMinimum = job.matchedSkills.length >= userData.preferences.minimumSkillMatches;
                    const meetsScoreMinimum = job.matchScore >= userData.preferences.minimumMatchScore;
                    const meetsSalary = !userData.preferences.minSalary || 
                                       (job.salary && parseInt(job.salary.split('-')[1]) >= userData.preferences.minSalary/1000);
                    
                    return meetsSkillMinimum && meetsScoreMinimum && meetsSalary;
                });
                
                console.log(`RemoteOK: ${qualifiedJobs.length} qualified jobs`);
                return qualifiedJobs;
                
            } catch (error) {
                console.error('Error fetching RemoteOK jobs:', error);
                return [];
            }
        }
        
        function extractSkillsFromJobEnhanced(job) {
            const searchText = `${job.position} ${job.description || ''} ${(job.tags || []).join(' ')}`.toLowerCase();
            const extractedSkills = [];
            
            // ENHANCED: Expanded skill mapping with synonyms and variations
            const skillMapping = {
                // Strategic Core
                'Enterprise AI Strategy': ['ai strategy', 'artificial intelligence strategy', 'enterprise ai', 'ai transformation', 'ai roadmap', 'ai leadership'],
                'Strategic Foresight & Market Prediction': ['market prediction', 'strategic foresight', 'forecasting', 'trend analysis', 'future of work', 'market intelligence', 'competitive intelligence'],
                'Go-to-Market Strategy': ['go-to-market', 'gtm strategy', 'market strategy', 'launch strategy', 'product launch', 'market entry'],
                'Business Case Development': ['business case', 'roi analysis', 'business development', 'financial modeling', 'investment analysis'],
                'C-Suite Advisory & Influence': ['c-suite', 'executive advisory', 'board advisory', 'executive coaching', 'executive stakeholder', 'ceo advisor'],
                'Organizational Transformation': ['transformation', 'change management', 'organizational change', 'digital transformation', 'org transformation', 'restructuring'],
                
                // Technology & Innovation
                'AI/ML Product Strategy': ['ai product', 'ml product', 'machine learning strategy', 'ai/ml', 'ai product management', 'ml roadmap'],
                'Technology Trend Forecasting': ['technology trends', 'tech forecasting', 'innovation trends', 'emerging tech', 'technology radar'],
                'Disruptive Innovation Identification': ['disruptive innovation', 'innovation strategy', 'breakthrough innovation', 'radical innovation'],
                'Human-AI Collaboration Model Design': ['human-ai', 'ai collaboration', 'human-centered ai', 'ai interaction', 'human augmentation'],
                'Technology Lifecycle & Disruption Analysis': ['technology lifecycle', 'disruption analysis', 'tech adoption', 'innovation curve'],
                'Platform Integration Architecture': ['platform integration', 'system architecture', 'enterprise architecture', 'integration strategy'],
                
                // Communication & Leadership
                'Industry Evangelism': ['evangelist', 'developer relations', 'community building', 'developer advocacy', 'technical evangelism'],
                'Thought Leadership Authorship': ['thought leadership', 'content strategy', 'industry speaking', 'executive writing', 'industry expert'],
                'Technical Concept Translation': ['technical communication', 'executive communication', 'technical writing', 'concept translation'],
                'Public Speaking & Keynote Delivery': ['public speaking', 'keynote', 'conference speaking', 'presentations', 'speaker'],
                'Media Relations & Spokesperson Work': ['media relations', 'spokesperson', 'press relations', 'public relations', 'media spokesperson'],
                
                // Domain Expertise - Talent/HR Tech
                'Talent Intelligence Platform Design': ['talent platform', 'hr tech', 'talent technology', 'talent systems', 'hris', 'applicant tracking'],
                'Workforce Intelligence & Analytics': ['workforce analytics', 'people analytics', 'talent analytics', 'hr analytics', 'workforce planning'],
                'HR Technology Market Intelligence': ['hr technology', 'hrtech', 'talent tech', 'hr software', 'talent management'],
                'Talent Acquisition Strategy': ['talent acquisition', 'recruitment strategy', 'hiring strategy', 'sourcing strategy', 'recruiting'],
                'Candidate Experience Architecture': ['candidate experience', 'recruitment experience', 'hiring experience', 'candidate journey'],
                
                // Leadership & Management
                'Executive Presence & Authority': ['executive presence', 'executive leadership', 'leadership presence', 'executive impact'],
                'Crisis Leadership & Decision Making': ['crisis management', 'crisis leadership', 'emergency response', 'incident management'],
                'Strategic Team Building': ['team building', 'organizational design', 'team strategy', 'talent development', 'team leadership'],
                'Multi-Stakeholder Alignment': ['stakeholder management', 'stakeholder alignment', 'cross-functional', 'stakeholder engagement'],
                'Revenue Pipeline Development': ['pipeline development', 'revenue strategy', 'sales pipeline', 'pipeline management'],
                
                // Data & Analysis
                'Data-Driven Strategy Development': ['data-driven', 'data strategy', 'analytics strategy', 'data-informed', 'evidence-based'],
                'Predictive Framework Development': ['predictive framework', 'predictive modeling', 'forecasting models', 'prediction systems'],
                'Research Synthesis & Forecasting': ['research synthesis', 'market research', 'competitive analysis', 'industry research'],
                'Critical Analysis & Evaluation': ['critical analysis', 'evaluation', 'assessment', 'analytical thinking'],
                
                // Product & Strategy
                'Scenario Planning & Strategic Alternatives': ['scenario planning', 'strategic planning', 'contingency planning', 'alternative strategies'],
                'Rhetorical Strategy & Persuasion': ['persuasion', 'influence', 'negotiation', 'storytelling'],
                'Customer Advisory Board Leadership': ['advisory board', 'customer advisory', 'cab leadership', 'advisory council'],
                'Enterprise Client Relationship Management': ['enterprise sales', 'account management', 'client relationship', 'enterprise accounts']
            };
            
            // Weight skills by importance in job posting
            const skillMatches = {};
            
            Object.entries(skillMapping).forEach(([skill, keywords]) => {
                let matchCount = 0;
                let matchWeight = 0;
                
                keywords.forEach((keyword) => {
                    const regex = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                    const matches = searchText.match(regex);
                    if (matches) {
                        matchCount += matches.length;
                        
                        // Weight based on where keyword appears
                        if (job.position.toLowerCase().includes(keyword)) {
                            matchWeight += 3;  // Title match is most important
                        } else if (searchText.indexOf(keyword) < 200) {
                            matchWeight += 2;  // Early mention is important
                        } else {
                            matchWeight += 1;  // Later mention
                        }
                    }
                });
                
                if (matchCount > 0) {
                    skillMatches[skill] = matchWeight;
                }
            });
            
            // Sort by weight and extract top matches
            const sortedSkills = Object.entries(skillMatches)
                .sort((a, b) => b[1] - a[1])
                .map(([skill]) => skill);
            
            return sortedSkills;
        }
        
        function loadSampleData() {
            const sampleJobs = [
                {
                    id: 1,
                    title: "VP of AI Strategy",
                    company: "TechCorp",
                    location: "San Francisco, CA / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$200k-$300k",
                    requiredSkills: ["Enterprise AI Strategy", "Strategic Foresight & Market Prediction", "C-Suite Advisory & Influence", "Technology Trend Forecasting", "Business Case Development", "Go-to-Market Strategy"]
                },
                {
                    id: 2,
                    title: "Chief Strategy Officer",
                    company: "GrowthCo",
                    location: "New York, NY / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$250k-$350k",
                    requiredSkills: ["Go-to-Market Strategy", "Business Case Development", "Strategic Foresight & Market Prediction", "Multi-Stakeholder Alignment", "Revenue Pipeline Development", "Financial Management & Budget Discipline"]
                },
                {
                    id: 3,
                    title: "Director of Technology Strategy",
                    company: "Innovation Labs",
                    location: "Austin, TX / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$180k-$240k",
                    requiredSkills: ["Technology Lifecycle & Disruption Analysis", "Platform Integration Architecture", "Computational & Systems Thinking", "Data-Driven Strategy Development", "Market & Competitive Intelligence"]
                },
                {
                    id: 4,
                    title: "Head of Talent Intelligence",
                    company: "WorkTech Inc",
                    location: "Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$160k-$220k",
                    requiredSkills: ["Talent Intelligence Platform Design", "Workforce Intelligence & Analytics", "AI/ML Product Strategy", "Candidate Experience Architecture", "Talent Acquisition Strategy", "HR Technology Market Intelligence"]
                },
                {
                    id: 5,
                    title: "Chief Evangelist",
                    company: "AI Startup",
                    location: "Boston, MA / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$150k-$200k + equity",
                    requiredSkills: ["Industry Evangelism", "Technical Concept Translation", "Thought Leadership Authorship", "Public Speaking & Keynote Delivery", "Media Relations & Spokesperson Work"]
                },
                {
                    id: 6,
                    title: "VP of Product Strategy",
                    company: "SaaS Platform",
                    location: "Seattle, WA / Remote",
                    type: "Full-time",
                    url: "#",
                    salary: "$190k-$260k",
                    requiredSkills: ["AI/ML Product Strategy", "Human-AI Collaboration Model Design", "Predictive Framework Development", "Scenario Planning & Strategic Alternatives", "Disruptive Innovation Identification"]
                }
            ];
            
            opportunitiesData = sampleJobs.map(job => {
                const match = calculateMatchScore(job.requiredSkills, job.requiredSkills);
                return {
                    ...job,
                    matchScore: match.score,
                    matchedSkills: match.matched,
                    gapSkills: match.gaps
                };
            });
            
            opportunitiesData.sort((a, b) => b.matchScore - a.matchScore);
            renderOpportunities();
        }
        
        function extractSkillsFromJob(job) {
            // Extract skills from job description and tags
            const searchText = `${job.position} ${job.description || ''} ${(job.tags || []).join(' ')}`.toLowerCase();
            const extractedSkills = [];
            
            // Map common job keywords to Cliff's skills
            const skillKeywords = {
                'ai strategy': 'Enterprise AI Strategy',
                'artificial intelligence': 'AI/ML Product Strategy',
                'machine learning': 'AI/ML Product Strategy',
                'strategic planning': 'Strategic Foresight & Market Prediction',
                'business strategy': 'Go-to-Market Strategy',
                'product strategy': 'AI/ML Product Strategy',
                'thought leadership': 'Thought Leadership Authorship',
                'public speaking': 'Public Speaking & Keynote Delivery',
                'evangelist': 'Industry Evangelism',
                'technology strategy': 'Technology Lifecycle & Disruption Analysis',
                'data analytics': 'Data-Driven Strategy Development',
                'talent': 'Talent Acquisition Strategy',
                'hr tech': 'HR Technology Market Intelligence',
                'workforce': 'Workforce Intelligence & Analytics',
                'crisis management': 'Crisis Leadership & Decision Making',
                'team building': 'Strategic Team Building',
                'c-suite': 'C-Suite Advisory & Influence',
                'executive': 'Executive Presence & Authority',
                'innovation': 'Disruptive Innovation Identification',
                'transformation': 'Organizational Transformation',
                'advisory': 'C-Suite Advisory & Influence'
            };
            
            // Check which skills are mentioned
            Object.entries(skillKeywords).forEach(([keyword, skill]) => {
                if (searchText.includes(keyword) && !extractedSkills.includes(skill)) {
                    extractedSkills.push(skill);
                }
            });
            
            // If no specific skills found, add some generic strategic ones
            if (extractedSkills.length === 0) {
                extractedSkills.push('Strategic Foresight & Market Prediction', 'Go-to-Market Strategy', 'Business Case Development');
            }
            
            return extractedSkills;
        }
        
        function filterOpportunities() {
            renderOpportunities();
        }
        
        function renderOpportunities() {
            const filtered = opportunitiesData.filter(job => job.matchScore >= currentMatchThreshold);
            const resultsDiv = document.getElementById('opportunitiesResults');
            
            if (filtered.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="loading-state">
                        <p style="font-size: 1.2em;">No opportunities match your current filters</p>
                        <p style="margin-top: 10px;">Try lowering the match threshold or searching for new jobs</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="opportunities-grid">';
            
            filtered.forEach(job => {
                const matchClass = job.matchScore >= 80 ? 'high' : job.matchScore >= 60 ? 'medium' : 'low';
                const jobUrl = job.url || '#';
                const salary = job.salary || 'Salary not specified';
                
                html += `
                    <div class="opportunity-card">
                        <div class="opportunity-header">
                            <div>
                                <div class="opportunity-company">${job.company}</div>
                                <div class="opportunity-title">
                                    <a href="${jobUrl}" target="_blank" style="color: inherit; text-decoration: none;">
                                        ${job.title}
                                    </a>
                                </div>
                            </div>
                            <div class="match-score">
                                <div class="match-circle ${matchClass}">
                                    ${job.matchScore}%
                                </div>
                                <div class="match-label">Match</div>
                            </div>
                        </div>
                        
                        <div class="opportunity-meta">
                            <div class="meta-item">ðŸ“ ${job.location}</div>
                            <div class="meta-item">ðŸ’¼ ${job.type}</div>
                            <div class="meta-item">ðŸ’° ${salary}</div>
                            ${job.source ? `<div class="meta-item" style="color: #10b981;">ðŸŒ ${job.source}</div>` : ''}
                        </div>
                        
                        <div class="matched-skills">
                            <div class="matched-skills-title">Your Matching Skills (${job.matchedSkills.length})</div>
                            <div class="skill-chips">
                                ${job.matchedSkills.slice(0, 5).map(skill => 
                                    `<span class="skill-chip-match">${skill}</span>`
                                ).join('')}
                                ${job.matchedSkills.length > 5 ? 
                                    `<span class="skill-chip-match">+${job.matchedSkills.length - 5} more</span>` : ''}
                            </div>
                        </div>
                        
                        ${job.gapSkills.length > 0 ? `
                            <div class="matched-skills">
                                <div class="matched-skills-title">Skills to Highlight (${job.gapSkills.length})</div>
                                <div class="skill-chips">
                                    ${job.gapSkills.slice(0, 3).map(skill => 
                                        `<span class="skill-chip-gap">${skill}</span>`
                                    ).join('')}
                                    ${job.gapSkills.length > 3 ? 
                                        `<span class="skill-chip-gap">+${job.gapSkills.length - 3} more</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="opportunity-actions">
                            <button class="action-btn" onclick="event.stopPropagation(); window.open('${jobUrl}', '_blank')">
                                ðŸ”— View Job
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); generatePitch(${job.id})">
                                âœï¸ Generate Pitch
                            </button>
                            <button class="action-btn" onclick="event.stopPropagation(); viewOnNetwork(${job.id})">
                                ðŸ—ºï¸ View on Network
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }
        
        function searchOpportunities() {
            const resultsDiv = document.getElementById('opportunitiesResults');
            resultsDiv.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p style="font-size: 1.2em;">Searching 4 job boards...</p>
                    <p style="margin-top: 10px; color: #6b7280;">RemoteOK, Remotive, Arbeitnow, WeWorkRemotely</p>
                </div>
            `;
            
            // Fetch from multiple sources simultaneously
            Promise.all([
                fetchRemoteOKJobs().catch(e => { console.error('RemoteOK failed:', e); return []; }),
                fetchRemotiveJobs().catch(e => { console.error('Remotive failed:', e); return []; }),
                fetchArbeitnowJobs().catch(e => { console.error('Arbeitnow failed:', e); return []; }),
                fetchWeWorkRemotelyJobs().catch(e => { console.error('WeWorkRemotely failed:', e); return []; })
            ]).then(results => {
                // Combine and deduplicate
                const allJobs = results.flat();
                
                // Deduplicate by title + company
                const seen = new Set();
                opportunitiesData = allJobs.filter(job => {
                    const key = `${job.title}-${job.company}`.toLowerCase();
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
                
                // Sort by match score
                opportunitiesData.sort((a, b) => b.matchScore - a.matchScore);
                
                console.log(`Total jobs after deduplication: ${opportunitiesData.length}`);
                
                if (opportunitiesData.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="loading-state">
                            <p style="font-size: 1.2em;">No jobs match your criteria</p>
                            <p style="margin-top: 10px; color: #9ca3af;">
                                Current settings:
                                <br>â€¢ Seniority: ${userData.preferences.seniorityLevel}
                                <br>â€¢ Min Match Score: ${userData.preferences.minimumMatchScore}%
                                <br>â€¢ Min Skills: ${userData.preferences.minimumSkillMatches}
                                <br><br>
                                <strong style="color: #60a5fa;">ðŸ’¡ TIP:</strong> Lower the match threshold above to <strong>0-20%</strong> to see ALL jobs (including ones you're overqualified for).
                                <br><br>
                                Or try:
                                <br>â€¢ Adjusting preferences in Settings tab
                                <br>â€¢ Checking back later
                            </p>
                            <button class="action-btn" onclick="loadSampleData()" style="margin-top: 20px;">
                                View Sample Jobs Instead
                            </button>
                        </div>
                    `;
                    return;
                }
                
                renderOpportunities();
            });
        }
        
        async function fetchWeWorkRemotelyJobs() {
            try {
                // WeWorkRemotely doesn't have a public API, but we can try to fetch their RSS feed
                // This is a fallback approach - in production you'd want server-side scraping
                console.log('Attempting to fetch WeWorkRemotely jobs...');
                
                // For now, return sample data that looks like WeWorkRemotely results
                // In production, this would be replaced with actual scraping
                const wwrSampleJobs = [
                    {
                        title: "Director of Product Strategy",
                        company: "Remote Tech Co",
                        location: "Remote (Worldwide)",
                        type: "Full-time",
                        url: "https://weworkremotely.com/",
                        salary: "$160k-$220k",
                        description: "Lead product strategy for B2B SaaS platform. Work with executive team on roadmap and vision.",
                        requiredSkills: ["AI/ML Product Strategy", "Go-to-Market Strategy", "Strategic Foresight & Market Prediction"]
                    },
                    {
                        title: "VP of Customer Success",
                        company: "SaaS Growth Inc",
                        location: "Remote (US)",
                        type: "Full-time",
                        url: "https://weworkremotely.com/",
                        salary: "$180k-$240k",
                        description: "Build and scale customer success organization. Report to CEO.",
                        requiredSkills: ["Customer Advisory Board Leadership", "Enterprise Client Relationship Management", "Strategic Team Building"]
                    }
                ];
                
                return wwrSampleJobs.map(job => {
                    const match = calculateMatchScore(job.requiredSkills, job.requiredSkills);
                    return {
                        id: Math.random().toString(36).substr(2, 9),
                        ...job,
                        matchScore: match.score,
                        matchedSkills: match.matched,
                        gapSkills: match.gaps,
                        source: 'WeWorkRemotely'
                    };
                }).filter(job => {
                    const meetsSkillMinimum = job.matchedSkills.length >= userData.preferences.minimumSkillMatches;
                    const meetsScoreMinimum = job.matchScore >= userData.preferences.minimumMatchScore;
                    return meetsSkillMinimum && meetsScoreMinimum;
                });
                
            } catch (error) {
                console.error('WeWorkRemotely fetch error:', error);
                return [];
            }
        }
        
        async function fetchRemotiveJobs() {
            try {
                console.log('Fetching from Remotive.io API...');
                
                // Remotive has a free public API
                const response = await fetch('https://remotive.com/api/remote-jobs');
                const data = await response.json();
                
                if (!data.jobs || data.jobs.length === 0) {
                    console.log('Remotive: No jobs returned');
                    return [];
                }
                
                // Filter and map Remotive jobs
                const jobs = data.jobs.slice(0, 100); // Limit to first 100 for performance
                
                // Apply same filtering logic
                const seniorityKeywords = userData.preferences.seniorityKeywords;
                const excludeKeywords = userData.preferences.excludeRoles;
                const strategicKeywords = userData.preferences.strategicKeywords;
                
                const filteredJobs = jobs.filter(job => {
                    const titleLower = job.title.toLowerCase();
                    
                    // Bypass filters if threshold is very low
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true;
                    }
                    
                    // EXCLUDE
                    if (excludeKeywords.some(keyword => titleLower.includes(keyword))) {
                        return false;
                    }
                    
                    // INCLUDE seniority
                    const hasSeniority = seniorityKeywords.some(keyword => titleLower.includes(keyword));
                    if (!hasSeniority) return false;
                    
                    // Strategic keywords
                    const hasStrategicRole = strategicKeywords.some(keyword => titleLower.includes(keyword));
                    return hasStrategicRole;
                });
                
                const processedJobs = filteredJobs.map(job => {
                    const extractedSkills = extractSkillsFromJobEnhanced({
                        position: job.title,
                        description: job.description,
                        tags: job.tags || []
                    });
                    const match = calculateMatchScore(extractedSkills, extractedSkills);
                    
                    return {
                        id: `remotive-${job.id}`,
                        title: job.title,
                        company: job.company_name,
                        location: job.candidate_required_location || 'Remote',
                        type: job.job_type || 'Full-time',
                        url: job.url,
                        salary: job.salary || 'Not specified',
                        description: job.description,
                        tags: job.tags || [],
                        requiredSkills: extractedSkills,
                        matchScore: match.score,
                        matchedSkills: match.matched,
                        gapSkills: match.gaps,
                        source: 'Remotive'
                    };
                }).filter(job => {
                    // Apply quality thresholds
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true;
                    }
                    
                    const meetsSkillMinimum = job.matchedSkills.length >= userData.preferences.minimumSkillMatches;
                    const meetsScoreMinimum = job.matchScore >= userData.preferences.minimumMatchScore;
                    return meetsSkillMinimum && meetsScoreMinimum;
                });
                
                console.log(`Remotive: ${processedJobs.length} qualified jobs`);
                return processedJobs;
                
            } catch (error) {
                console.error('Remotive fetch error:', error);
                return [];
            }
        }
        
        async function fetchArbeitnowJobs() {
            try {
                console.log('Fetching from Arbeitnow API...');
                
                // Arbeitnow is a free job board API
                const response = await fetch('https://www.arbeitnow.com/api/job-board-api');
                const data = await response.json();
                
                if (!data.data || data.data.length === 0) {
                    console.log('Arbeitnow: No jobs returned');
                    return [];
                }
                
                const jobs = data.data.slice(0, 100);
                
                // Apply filtering
                const seniorityKeywords = userData.preferences.seniorityKeywords;
                const excludeKeywords = userData.preferences.excludeRoles;
                const strategicKeywords = userData.preferences.strategicKeywords;
                
                const filteredJobs = jobs.filter(job => {
                    const titleLower = job.title.toLowerCase();
                    
                    // Bypass if threshold very low
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true;
                    }
                    
                    // EXCLUDE
                    if (excludeKeywords.some(keyword => titleLower.includes(keyword))) {
                        return false;
                    }
                    
                    // INCLUDE seniority
                    const hasSeniority = seniorityKeywords.some(keyword => titleLower.includes(keyword));
                    if (!hasSeniority) return false;
                    
                    // Strategic
                    const hasStrategicRole = strategicKeywords.some(keyword => titleLower.includes(keyword));
                    return hasStrategicRole;
                });
                
                const processedJobs = filteredJobs.map(job => {
                    const extractedSkills = extractSkillsFromJobEnhanced({
                        position: job.title,
                        description: job.description,
                        tags: job.tags || []
                    });
                    const match = calculateMatchScore(extractedSkills, extractedSkills);
                    
                    return {
                        id: `arbeitnow-${job.slug}`,
                        title: job.title,
                        company: job.company_name,
                        location: job.location || 'Remote',
                        type: job.job_types?.[0] || 'Full-time',
                        url: job.url,
                        salary: 'Not specified',
                        description: job.description,
                        tags: job.tags || [],
                        requiredSkills: extractedSkills,
                        matchScore: match.score,
                        matchedSkills: match.matched,
                        gapSkills: match.gaps,
                        source: 'Arbeitnow'
                    };
                }).filter(job => {
                    if (userData.preferences.minimumMatchScore <= 20) {
                        return true;
                    }
                    
                    const meetsSkillMinimum = job.matchedSkills.length >= userData.preferences.minimumSkillMatches;
                    const meetsScoreMinimum = job.matchScore >= userData.preferences.minimumMatchScore;
                    return meetsSkillMinimum && meetsScoreMinimum;
                });
                
                console.log(`Arbeitnow: ${processedJobs.length} qualified jobs`);
                return processedJobs;
                
            } catch (error) {
                console.error('Arbeitnow fetch error:', error);
                return [];
            }
        }
        
        function viewOpportunityDetail(jobId) {
            const job = opportunitiesData.find(j => j.id === jobId);
            alert(`Detailed view for ${job.title} at ${job.company}\n\nMatch: ${job.matchScore}%\nMatched Skills: ${job.matchedSkills.length}\nGaps: ${job.gapSkills.length}\n\nFull detail view coming in next update!`);
        }
        
        function generatePitch(jobId) {
            const job = opportunitiesData.find(j => j.id === jobId);
            if (!job) return;
            
            // Get shared outcomes from blueprint
            const sharedOutcomes = blueprintData.outcomes.filter(o => o.shared);
            const selectedValues = blueprintData.values.filter(v => v.selected);
            
            // Build pitch using matched skills
            let pitch = `Dear Hiring Manager,\n\n`;
            pitch += `I'm writing to express my interest in the ${job.title} position at ${job.company}. `;
            pitch += `My background aligns strongly with your requirements, with a ${job.matchScore}% match to the role's key competencies.\n\n`;
            
            // Outcomes section
            if (sharedOutcomes.length > 0) {
                pitch += `**Key Outcomes I've Driven:**\n\n`;
                // Prioritize outcomes related to matched skills
                const relevantOutcomes = sharedOutcomes.filter(outcome => 
                    job.matchedSkills.some(skill => outcome.skill.includes(skill) || outcome.text.toLowerCase().includes(skill.toLowerCase()))
                ).slice(0, 3);
                
                if (relevantOutcomes.length > 0) {
                    relevantOutcomes.forEach(outcome => {
                        pitch += `â€¢ ${outcome.text}\n`;
                    });
                } else {
                    sharedOutcomes.slice(0, 3).forEach(outcome => {
                        pitch += `â€¢ ${outcome.text}\n`;
                    });
                }
                pitch += `\n`;
            }
            
            // Skills match section
            pitch += `**Your Requirements - My Experience:**\n\n`;
            job.matchedSkills.slice(0, 5).forEach(skill => {
                const skillData = skillsData.skills.find(s => s.name === skill);
                const evidence = skillsData.skillDetails[skill];
                if (evidence && evidence.evidence && evidence.evidence.length > 0) {
                    pitch += `â€¢ **${skill}**: ${evidence.evidence[0]}\n`;
                } else {
                    pitch += `â€¢ **${skill}**: ${skillData ? skillData.level + ' level proficiency' : 'Demonstrated expertise'}\n`;
                }
            });
            pitch += `\n`;
            
            // Values alignment
            if (selectedValues.length > 0) {
                pitch += `**My Approach:**\n\n`;
                pitch += `I bring ${selectedValues.map(v => v.name.toLowerCase()).slice(0, 3).join(', ')} to this role. `;
                if (blueprintData.purpose) {
                    pitch += blueprintData.purpose;
                }
                pitch += `\n\n`;
            }
            
            pitch += `I'd welcome the opportunity to discuss how my experience can contribute to ${job.company}'s success.\n\n`;
            pitch += `Best regards,\n${userData.profile.name || 'Your Name'}`;
            
            // Show pitch in modal
            showPitchModal(job, pitch);
        }
        
        function showPitchModal(job, pitch) {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Generated Pitch</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">${job.title} at ${job.company}</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <textarea id="pitchText" style="width: 100%; min-height: 400px; background: transparent; border: none; color: #e0e0e0; font-family: inherit; font-size: 0.95em; line-height: 1.7; resize: vertical;">${pitch}</textarea>
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button class="action-btn" onclick="copyPitch()" style="padding: 10px 20px;">
                            ðŸ“‹ Copy to Clipboard
                        </button>
                        <button class="action-btn" onclick="downloadPitch('${job.title}', '${job.company}')" style="padding: 10px 20px;">
                            ðŸ’¾ Download as Text
                        </button>
                        <button class="action-btn" onclick="trackFromPitch('${job.id}')" style="padding: 10px 20px; background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #10b981;">
                            âž• Track Application
                        </button>
                        <button class="export-btn-large" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Done
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function copyPitch() {
            const pitchText = document.getElementById('pitchText');
            pitchText.select();
            document.execCommand('copy');
            alert('Pitch copied to clipboard!');
        }
        
        function downloadPitch(jobTitle, company) {
            const pitchText = document.getElementById('pitchText').value;
            const blob = new Blob([pitchText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pitch-${jobTitle.replace(/\s+/g, '-')}-${company.replace(/\s+/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function trackFromPitch(jobId) {
            const job = opportunitiesData.find(j => j.id == jobId);
            if (!job) return;
            
            closeExportModal();
            addApplicationModal(job);
        }
        
        function viewOnNetwork(jobId) {
            const job = opportunitiesData.find(j => j.id === jobId);
            if (!job) return;
            
            // Store job for network highlighting
            window.currentHighlightJob = job;
            
            // Switch to Skills Ontology view (network mode)
            currentView = 'network';
            currentSkillsView = 'network';
            
            // Update navigation
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes('Skills Ontology')) {
                    btn.classList.add('active');
                }
            });
            
            // Show network view
            document.getElementById('networkView').style.display = 'block';
            document.getElementById('cardView').style.display = 'none';
            document.getElementById('opportunitiesView').style.display = 'none';
            document.getElementById('blueprintView').style.display = 'none';
            document.getElementById('consentView').style.display = 'none';
            document.getElementById('settingsView').style.display = 'none';
            document.getElementById('networkControls').style.display = 'flex';
            document.querySelector('.controls').style.display = 'flex';
            
            // Update toggle button state
            document.querySelectorAll('#skillsViewToggle .role-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.view === 'network');
            });
            
            // Reinitialize network with highlighting
            initNetworkWithHighlight(job);
            
            // Update stats bar
            updateStatsBar();
        }
        
        function initNetworkWithHighlight(job) {
            const svg = d3.select("#networkView");
            svg.selectAll("*").remove();
            
            const width = svg.node().getBoundingClientRect().width;
            const height = svg.node().getBoundingClientRect().height;
            
            // Prepare data
            const centerNode = { id: "center", name: userData.profile.name || "You", type: "center" };
            const roleNodes = skillsData.roles.map(role => ({
                id: role.id,
                name: role.name,
                type: "role",
                skills: role.skills
            }));
            
            const skillNodes = skillsData.skills.map(skill => ({
                id: skill.name,
                name: skill.name,
                type: "skill",
                level: skill.level,
                years: skill.years,
                roles: skill.roles,
                isMatch: job.matchedSkills.includes(skill.name)  // NEW: Track if matches job
            }));
            
            const nodes = [centerNode, ...roleNodes, ...skillNodes];
            
            // Create links
            const links = [];
            roleNodes.forEach(role => {
                links.push({ source: "center", target: role.id, type: "role" });
                role.skills.forEach(skillName => {
                    links.push({ source: role.id, target: skillName, type: "skill" });
                });
            });
            
            // Create simulation (same physics as before)
            simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.type === "role") return 140;
                    return 160;
                }))
                .force("charge", d3.forceManyBody().strength(d => {
                    if (d.type === "center") return 0;
                    if (d.type === "role") return -250;
                    return -180;
                }))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(d => {
                    if (d.type === "center") return 70;
                    if (d.type === "role") return 65;
                    return 45;
                }))
                .force("x", d3.forceX(width / 2).strength(0.08))
                .force("y", d3.forceY(height / 2).strength(0.08))
                .force("radial", d3.forceRadial(d => {
                    if (d.type === "skill") return Math.min(width, height) * 0.4;
                    return 0;
                }).strength(0.1));
            
            // Draw links with highlighting
            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link")
                .style("opacity", d => {
                    // Dim links that don't connect to matching skills
                    if (d.type === "skill") {
                        const targetNode = nodes.find(n => n.id === d.target);
                        return targetNode && targetNode.isMatch ? 0.6 : 0.1;
                    }
                    return 0.3;
                });
            
            // Draw nodes with highlighting
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", "node")
                .style("opacity", d => {
                    // Highlight matching skills, dim others
                    if (d.type === "skill") {
                        return d.isMatch ? 1 : 0.2;
                    }
                    return 1;  // Keep center and roles fully visible
                })
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
            
            // Add circles
            node.append("circle")
                .attr("r", d => {
                    if (d.type === "center") return 60;
                    if (d.type === "role") return 50;
                    return d.isMatch ? 25 : 15;  // Matching skills are larger
                })
                .attr("class", d => {
                    if (d.type === "center") return "node-center";
                    if (d.type === "role") return `node-role role-${d.id}`;
                    return `node-skill level-${d.level.toLowerCase().replace(/\s/g, '-')}`;
                })
                .style("stroke", d => {
                    // Green border for matching skills
                    return d.isMatch ? "#10b981" : null;
                })
                .style("stroke-width", d => d.isMatch ? 3 : null);
            
            // Add labels (only show matching skills and roles)
            node.filter(d => d.type === "center" || d.type === "role" || d.isMatch)
                .append("text")
                .text(d => d.name)
                .attr("class", "node-label")
                .style("font-weight", d => d.isMatch ? "bold" : "normal")
                .style("fill", d => d.isMatch ? "#10b981" : "#e0e0e0");
            
            // Update positions on tick
            simulation.on("tick", () => {
                const padding = 100;
                nodes.forEach(d => {
                    if (d.type !== "center") {
                        d.x = Math.max(padding, Math.min(width - padding, d.x));
                        d.y = Math.max(padding, Math.min(height - padding, d.y));
                    }
                });
                
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });
            
            // Add "Return to Opportunities" button overlay
            const buttonContainer = svg.append("foreignObject")
                .attr("x", 20)
                .attr("y", 20)
                .attr("width", 200)
                .attr("height", 50);
            
            buttonContainer.append("xhtml:div")
                .html(`
                    <button onclick="returnToOpportunities()" style="
                        padding: 10px 20px;
                        background: #10b981;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                    ">
                        â† Back to Jobs
                    </button>
                `);
        }
        
        function returnToOpportunities() {
            window.currentHighlightJob = null;
            switchView('opportunities');
        }
        
        // ===== SETTINGS SYSTEM =====
        
        function initSettings() {
            const view = document.getElementById('settingsView');
            
            // Initialize current tab if not set
            if (!window.currentSettingsTab) {
                window.currentSettingsTab = 'profile';
            }
            
            view.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-header">
                        <h1 class="blueprint-title">Settings</h1>
                        <p class="blueprint-subtitle">Configure Your Profile and Preferences</p>
                    </div>
                    
                    <div class="settings-tabs">
                        <button class="settings-tab ${window.currentSettingsTab === 'profile' ? 'active' : ''}" 
                                onclick="switchSettingsTab('profile')">
                            ðŸ‘¤ Profile
                        </button>
                        <button class="settings-tab ${window.currentSettingsTab === 'preferences' ? 'active' : ''}" 
                                onclick="switchSettingsTab('preferences')">
                            ðŸŽ¯ Preferences
                        </button>
                        <button class="settings-tab ${window.currentSettingsTab === 'data' ? 'active' : ''}" 
                                onclick="switchSettingsTab('data')">
                            ðŸ’¾ Data & Export
                        </button>
                    </div>
                    
                    <div id="settingsTabContent">
                        ${renderSettingsTabContent()}
                    </div>
                </div>
            `;
        }
        
        function switchSettingsTab(tab) {
            window.currentSettingsTab = tab;
            document.getElementById('settingsTabContent').innerHTML = renderSettingsTabContent();
            
            // Update tab styling
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function renderSettingsTabContent() {
            switch(window.currentSettingsTab) {
                case 'profile':
                    return renderProfileSettings();
                case 'preferences':
                    return renderJobPreferences();
                case 'data':
                    return renderDataExport();
                default:
                    return renderProfileSettings();
            }
        }
        
        function renderProfileSettings() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">ðŸ‘¤</span>
                            <span>Profile Information</span>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Your Name</label>
                        <input type="text" class="settings-input" id="settingName" 
                               value="${userData.profile.name}" 
                               placeholder="Enter your name">
                        <div class="settings-help">This appears in the header and exports</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Email (Optional)</label>
                        <input type="email" class="settings-input" id="settingEmail" 
                               value="${userData.profile.email}" 
                               placeholder="your.email@example.com">
                        <div class="settings-help">For export contact information</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Location (for market valuation)</label>
                        <select class="settings-select" id="settingLocation">
                            <option value="Philadelphia, PA" ${userData.profile.location === 'Philadelphia, PA' ? 'selected' : ''}>Philadelphia, PA</option>
                            <option value="San Francisco Bay Area, CA">San Francisco Bay Area, CA</option>
                            <option value="New York City, NY">New York City, NY</option>
                            <option value="Seattle, WA">Seattle, WA</option>
                            <option value="Boston, MA">Boston, MA</option>
                            <option value="Washington DC">Washington DC</option>
                            <option value="Los Angeles, CA">Los Angeles, CA</option>
                            <option value="San Diego, CA">San Diego, CA</option>
                            <option value="Denver, CO">Denver, CO</option>
                            <option value="Austin, TX">Austin, TX</option>
                            <option value="Chicago, IL">Chicago, IL</option>
                            <option value="Atlanta, GA">Atlanta, GA</option>
                            <option value="Remote">Remote</option>
                            <option value="Phoenix, AZ">Phoenix, AZ</option>
                            <option value="Dallas, TX">Dallas, TX</option>
                            <option value="Houston, TX">Houston, TX</option>
                            <option value="Miami, FL">Miami, FL</option>
                            <option value="Portland, OR">Portland, OR</option>
                            <option value="Charlotte, NC">Charlotte, NC</option>
                            <option value="Nashville, TN">Nashville, TN</option>
                            <option value="Indianapolis, IN">Indianapolis, IN</option>
                            <option value="Columbus, OH">Columbus, OH</option>
                            <option value="Kansas City, MO">Kansas City, MO</option>
                            <option value="Omaha, NE">Omaha, NE</option>
                            <option value="Lincoln, NE">Lincoln, NE</option>
                            <option value="Other US Metro">Other US Metro</option>
                            <option value="Rural US">Rural US</option>
                        </select>
                        <div class="settings-help">Your location affects skill market valuations (cost of living adjustment)</div>
                    </div>
                </div>
            `;
        }
        
        function renderJobPreferences() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">ðŸŽ¯</span>
                            <span>Job Matching Preferences</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ðŸ’¡ HOW JOB MATCHING WORKS
                        </div>
                        <div class="coaching-tip-content">
                            These settings control which jobs appear in your Opportunities feed. 
                            Set your seniority level to filter out irrelevant positions.
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Seniority Level</label>
                        <select class="settings-select" id="settingSeniority">
                            <option value="Entry" ${userData.preferences.seniorityLevel === 'Entry' ? 'selected' : ''}>Entry Level</option>
                            <option value="Mid" ${userData.preferences.seniorityLevel === 'Mid' ? 'selected' : ''}>Mid Level</option>
                            <option value="Senior" ${userData.preferences.seniorityLevel === 'Senior' ? 'selected' : ''}>Senior Level</option>
                            <option value="Executive" ${userData.preferences.seniorityLevel === 'Executive' ? 'selected' : ''}>Executive Level</option>
                        </select>
                        <div class="settings-help">
                            <strong>Entry:</strong> Includes junior, associate roles<br>
                            <strong>Mid:</strong> Includes senior, lead, manager roles<br>
                            <strong>Senior:</strong> Includes senior manager, director roles<br>
                            <strong>Executive:</strong> VP, Chief, Head of roles only
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Minimum Match Score</label>
                        <input type="range" min="0" max="100" value="${userData.preferences.minimumMatchScore}" 
                               class="match-slider" style="width: 100%;"
                               oninput="document.getElementById('matchScoreValue').textContent = this.value + '%'">
                        <div style="text-align: center; color: #fbbf24; font-weight: 600; font-size: 1.2em; margin-top: 10px;">
                            <span id="matchScoreValue">${userData.preferences.minimumMatchScore}%</span>
                        </div>
                        <div class="settings-help">Only show jobs with at least this match percentage</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Minimum Skill Matches</label>
                        <input type="number" min="1" max="10" class="settings-input" id="settingMinSkills"
                               value="${userData.preferences.minimumSkillMatches}">
                        <div class="settings-help">Jobs must match at least this many of your skills</div>
                    </div>
                    
                    <div class="settings-group">
                        <label class="settings-label">Minimum Salary (Optional)</label>
                        <input type="number" class="settings-input" id="settingMinSalary" 
                               value="${userData.preferences.minSalary || ''}"
                               placeholder="e.g., 150000">
                        <div class="settings-help">Leave blank for no minimum. Enter annual salary (USD).</div>
                    </div>
                    
                    <button class="save-settings-btn" onclick="saveSettings()">
                        ðŸ’¾ Save Settings
                    </button>
                </div>
            `;
        }
        
        function renderDataExport() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">ðŸ’¾</span>
                            <span>Backup & Restore</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ðŸ’¡ DATA PORTABILITY
                        </div>
                        <div class="coaching-tip-content">
                            Export your complete Work Blueprint as JSON to back up all your data. 
                            Import from a previous export to restore or transfer to another device.
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 20px;">
                            <h3 style="color: #60a5fa; margin-bottom: 10px;">ðŸ“¤ Export Profile</h3>
                            <p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">
                                Download complete backup including skills, outcomes, values, and all settings
                            </p>
                            <button class="export-btn-large" onclick="exportFullProfile()" style="width: 100%;">
                                Download Backup
                            </button>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 20px;">
                            <h3 style="color: #10b981; margin-bottom: 10px;">ðŸ“¥ Import Profile</h3>
                            <p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">
                                Restore from a previous backup or transfer from another device
                            </p>
                            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importFullProfile(this)">
                            <button class="export-btn-large" onclick="document.getElementById('importFileInput').click()" 
                                    style="width: 100%; background: #10b981;">
                                Select Backup File
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; border-radius: 4px;">
                        <strong style="color: #ef4444;">âš ï¸ Warning:</strong>
                        <span style="color: #d1d5db; font-size: 0.9em;">
                            Importing will replace all current data. Make sure to export first if you want to keep your current profile!
                        </span>
                    </div>
                </div>
            `;
        }
        
        function renderSkillManagement() {
            const skillCount = userData.skills?.length || 0;
            const onetSkillsCount = userData.skills?.filter(s => s.category === 'skill').length || 0;
            const abilitiesCount = userData.skills?.filter(s => s.category === 'ability').length || 0;
            const workStylesCount = userData.skills?.filter(s => s.category === 'workstyle').length || 0;
            const uniqueCount = userData.skills?.filter(s => s.category === 'unique').length || 0;
            
            return `
                <div class="blueprint-section" style="margin-top: 30px;">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">ðŸ› ï¸</span>
                            <span>Manage Skills (${skillCount})</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ðŸ’¡ BUILD YOUR SKILLS PROFILE
                        </div>
                        <div class="coaching-tip-content">
                            Add skills from the official O*NET library (validated by U.S. Department of Labor) or create custom skills unique to your experience. Your skills appear in the network graph and drive job matching.
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="export-btn-large" onclick="openSkillManagement()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);">
                            ðŸ“Š Manage Skills
                        </button>
                        <button class="export-btn-large" onclick="openCustomSkillBuilder()" style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
                            â­ Create Custom
                        </button>
                    </div>
                    
                    <div class="skill-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;">
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #60a5fa;">${onetSkillsCount}</div>
                            <div style="font-size: 0.8em; color: #9ca3af;">Skills</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #a78bfa;">${abilitiesCount}</div>
                            <div style="font-size: 0.8em; color: #9ca3af;">Abilities</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #10b981;">${workStylesCount}</div>
                            <div style="font-size: 0.8em; color: #9ca3af;">Work Styles</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); padding: 10px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5em; font-weight: 700; color: #fbbf24;">${uniqueCount}</div>
                            <div style="font-size: 0.8em; color: #9ca3af;">Unique</div>
                        </div>
                    </div>
                    
                    <div class="skill-filter-controls" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="skillCategoryFilter" onchange="filterSkillsList()" class="settings-select" style="max-width: 200px;">
                            <option value="all">All Categories</option>
                            <option value="skill">O*NET Skills (${onetSkillsCount})</option>
                            <option value="ability">O*NET Abilities (${abilitiesCount})</option>
                            <option value="workstyle">Work Styles (${workStylesCount})</option>
                            <option value="unique">Unique (${uniqueCount})</option>
                        </select>
                        <input type="text" id="skillSearchInput" placeholder="Search skills..." class="settings-input" 
                               style="max-width: 300px;" oninput="filterSkillsList()">
                    </div>
                    
                    <div id="skillsList" style="max-height: 600px; overflow-y: auto;">
                        ${renderSkillsList()}
                    </div>
                </div>
            `;
        }
        
        function renderSkillsList() {
            const categoryFilter = document.getElementById('skillCategoryFilter')?.value || 'all';
            const searchQuery = document.getElementById('skillSearchInput')?.value.toLowerCase() || '';
            
            let skills = userData.skills || [];
            
            // Apply filters
            if (categoryFilter !== 'all') {
                skills = skills.filter(s => s.category === categoryFilter);
            }
            if (searchQuery) {
                skills = skills.filter(s => s.name.toLowerCase().includes(searchQuery));
            }
            
            if (skills.length === 0) {
                return `<div style="text-align: center; padding: 40px; color: #9ca3af;">
                    No skills found. ${searchQuery ? 'Try a different search.' : 'Add some skills to get started!'}
                </div>`;
            }
            
            // Group by category
            const grouped = {
                skill: skills.filter(s => s.category === 'skill'),
                ability: skills.filter(s => s.category === 'ability'),
                workstyle: skills.filter(s => s.category === 'workstyle'),
                unique: skills.filter(s => s.category === 'unique')
            };
            
            const categoryLabels = {
                skill: { name: 'O*NET Skills', color: '#60a5fa', badge: 'SKILL' },
                ability: { name: 'O*NET Abilities', color: '#a78bfa', badge: 'ABILITY' },
                workstyle: { name: 'O*NET Work Styles', color: '#10b981', badge: 'WORK STYLE' },
                unique: { name: 'Unique Skills', color: '#fbbf24', badge: 'UNIQUE' }
            };
            
            let html = '';
            
            Object.entries(grouped).forEach(([category, categorySkills]) => {
                if (categorySkills.length === 0) return;
                
                const label = categoryLabels[category];
                html += `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: ${label.color}; font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>${label.name}</span>
                            <span style="font-size: 0.8em; opacity: 0.7;">(${categorySkills.length})</span>
                        </h3>
                        <div style="display: grid; gap: 10px;">
                `;
                
                categorySkills.forEach(skill => {
                    const roleNames = skill.roles.map(roleId => {
                        const role = userData.roles.find(r => r.id === roleId);
                        return role ? role.name : roleId;
                    }).join(', ');
                    
                    const levelColors = {
                        'Mastery':    '#ef4444',
                        'Expert':     '#f97316',
                        'Advanced':   '#f59e0b',
                        'Proficient': '#10b981',
                        'Novice':     '#6b7280'
                    };
                    
                    html += `
                        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                        <span style="font-weight: 600; font-size: 1.05em;">${skill.name}</span>
                                        <span style="background: rgba(${category === 'skill' ? '59, 130, 246' : category === 'ability' ? '139, 92, 246' : category === 'workstyle' ? '16, 185, 129' : '251, 191, 36'}, 0.2); 
                                                     color: ${label.color}; 
                                                     font-size: 0.7em; 
                                                     padding: 2px 6px; 
                                                     border-radius: 3px;">
                                            ${label.badge}
                                        </span>
                                        ${skill.key ? '<span style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; font-size: 0.7em; padding: 2px 6px; border-radius: 3px;">CORE</span>' : ''}
                                    </div>
                                    <div style="color: #9ca3af; font-size: 0.9em;">
                                        <span style="color: ${levelColors[skill.level]}; font-weight: 600;">${skill.level}</span>
                                        ${roleNames ? ` â€¢ ${roleNames}` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                    <button onclick="openEditSkillModal('${skill.name.replace(/'/g, "\\'")}', '${category}')" 
                                            style="padding: 6px 12px; background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 4px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
                                        âœï¸ Edit
                                    </button>
                                    <button onclick="confirmDeleteSkill('${skill.name.replace(/'/g, "\\'")}', '${category}')" 
                                            style="padding: 6px 12px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 4px; cursor: pointer; font-size: 0.9em; white-space: nowrap;">
                                        ðŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        function filterSkillsList() {
            const container = document.getElementById('skillsList');
            if (container) {
                container.innerHTML = renderSkillsList();
            }
        }
        
        // saveUserData and loadUserData: single source of truth is the profile JSON.
        // localStorage only stores which profile is currently active (handled in first saveUserData definition).
        // This comment replaces duplicate/conflicting definitions that were removed in v3.5.2.
        
        function exportFullProfile() {
            const fullData = {
                userData: userData,
                blueprintData: blueprintData,
                skillsData: {
                    skills: skillsData.skills,
                    roles: skillsData.roles,
                    skillDetails: skillsData.skillDetails
                },
                version: '1.0',
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(fullData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `work-blueprint-full-${userData.profile.name || 'profile'}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        function importFullProfile(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace your current Work Blueprint data. Continue?')) {
                        // Restore all data
                        if (imported.userData) Object.assign(userData, imported.userData);
                        if (imported.blueprintData) Object.assign(blueprintData, imported.blueprintData);
                        if (imported.skillsData) {
                            if (imported.skillsData.skills) skillsData.skills = imported.skillsData.skills;
                            if (imported.skillsData.roles) skillsData.roles = imported.skillsData.roles;
                            if (imported.skillsData.skillDetails) skillsData.skillDetails = imported.skillsData.skillDetails;
                        }
                        
                        // Save to localStorage
                        saveUserData();
                        
                        alert('Profile imported successfully! Refreshing page...');
                        location.reload();
                    }
                } catch (err) {
                    alert('Error importing profile: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        // ===== APPLICATIONS TRACKER SYSTEM =====
        
        function initApplications() {
            const view = document.getElementById('applicationsView');
            
            view.innerHTML = `
                <div class="applications-header">
                    <h2 style="font-size: 2em; color: #60a5fa; margin-bottom: 10px;">Application Tracker</h2>
                    <p style="color: #9ca3af; margin-bottom: 20px;">Track your job applications and follow-ups</p>
                    <button class="export-btn-large" onclick="addApplicationModal()" style="display: inline-flex; align-items: center; gap: 8px;">
                        âž• Add Application
                    </button>
                </div>
                
                <div id="applicationsContainer"></div>
            `;
            
            renderApplications();
        }
        
        function renderApplications() {
            const container = document.getElementById('applicationsContainer');
            
            if (!userData.applications || userData.applications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 3em; margin-bottom: 20px;">ðŸ“‹</div>
                        <h3 style="color: #d1d5db; margin-bottom: 10px;">No applications tracked yet</h3>
                        <p>Click "Add Application" above to start tracking your job search</p>
                        <div style="margin-top: 30px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                            <strong style="color: #60a5fa;">Track from Opportunities:</strong>
                            <p style="font-size: 0.9em; margin-top: 8px;">When you generate a pitch for a job, you'll have the option to automatically add it to your application tracker.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Group by status
            const grouped = {
                applied: userData.applications.filter(a => a.status === 'applied'),
                interviewing: userData.applications.filter(a => a.status === 'interviewing'),
                offer: userData.applications.filter(a => a.status === 'offer'),
                rejected: userData.applications.filter(a => a.status === 'rejected')
            };
            
            container.innerHTML = `
                <div style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="application-status status-applied">${grouped.applied.length} Applied</div>
                    <div class="application-status status-interviewing">${grouped.interviewing.length} Interviewing</div>
                    <div class="application-status status-offer">${grouped.offer.length} Offers</div>
                    <div class="application-status status-rejected">${grouped.rejected.length} Closed</div>
                </div>
                
                <div class="applications-grid">
                    ${userData.applications.map((app, idx) => renderApplicationCard(app, idx)).join('')}
                </div>
            `;
        }
        
        function renderApplicationCard(app, idx) {
            const statusLabels = {
                applied: 'Applied',
                interviewing: 'Interviewing',
                offer: 'Offer Received',
                rejected: 'Closed'
            };
            
            return `
                <div class="application-card">
                    <div class="application-status status-${app.status}">
                        ${statusLabels[app.status]}
                    </div>
                    
                    <div class="application-title">${app.title}</div>
                    <div class="application-company">${app.company}</div>
                    
                    <div class="application-meta-grid">
                        <div class="application-meta-item">
                            <div class="application-meta-label">Applied</div>
                            <div class="application-meta-value">${new Date(app.appliedDate).toLocaleDateString()}</div>
                        </div>
                        <div class="application-meta-item">
                            <div class="application-meta-label">Match</div>
                            <div class="application-meta-value">${app.matchScore || 'N/A'}%</div>
                        </div>
                        ${app.salary ? `
                            <div class="application-meta-item">
                                <div class="application-meta-label">Salary</div>
                                <div class="application-meta-value">${app.salary}</div>
                            </div>
                        ` : ''}
                        ${app.nextFollowUp ? `
                            <div class="application-meta-item">
                                <div class="application-meta-label">Follow Up</div>
                                <div class="application-meta-value">${new Date(app.nextFollowUp).toLocaleDateString()}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${app.notes ? `
                        <div class="application-notes">
                            ðŸ“ ${app.notes}
                        </div>
                    ` : ''}
                    
                    <div class="application-actions">
                        <button class="application-btn" onclick="updateApplicationStatus(${idx})">
                            ðŸ”„ Update Status
                        </button>
                        <button class="application-btn" onclick="editApplication(${idx})">
                            âœï¸ Edit
                        </button>
                        ${app.url ? `
                            <button class="application-btn" onclick="window.open('${app.url}', '_blank')">
                                ðŸ”— View Job
                            </button>
                        ` : ''}
                        <button class="application-btn delete" onclick="deleteApplication(${idx})">
                            ðŸ—‘ï¸ Remove
                        </button>
                    </div>
                </div>
            `;
        }
        
        function addApplicationModal(jobData = null) {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Add Application</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Track a job you've applied to</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Job Title *</label>
                            <input type="text" id="appTitle" value="${jobData?.title || ''}" class="settings-input" required>
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Company *</label>
                            <input type="text" id="appCompany" value="${jobData?.company || ''}" class="settings-input" required>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Applied Date *</label>
                                <input type="date" id="appDate" value="${new Date().toISOString().split('T')[0]}" class="settings-input" required>
                            </div>
                            <div>
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Status</label>
                                <select id="appStatus" class="settings-select">
                                    <option value="applied">Applied</option>
                                    <option value="interviewing">Interviewing</option>
                                    <option value="offer">Offer Received</option>
                                    <option value="rejected">Closed</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Salary Range</label>
                                <input type="text" id="appSalary" value="${jobData?.salary || ''}" placeholder="e.g., $150k-$200k" class="settings-input">
                            </div>
                            <div>
                                <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Match Score</label>
                                <input type="number" id="appMatch" value="${jobData?.matchScore || ''}" min="0" max="100" class="settings-input">
                            </div>
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Job URL</label>
                            <input type="url" id="appUrl" value="${jobData?.url || ''}" placeholder="https://" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Follow-Up Date</label>
                            <input type="date" id="appFollowUp" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Notes</label>
                            <textarea id="appNotes" class="purpose-editor" style="min-height: 80px;" placeholder="Contact names, interview details, etc."></textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                        <button class="action-btn" onclick="closeExportModal()" style="padding: 10px 20px;">
                            Cancel
                        </button>
                        <button class="export-btn-large" onclick="saveApplication()" style="padding: 10px 20px;">
                            âž• Add Application
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function saveApplication() {
            const title = document.getElementById('appTitle').value.trim();
            const company = document.getElementById('appCompany').value.trim();
            
            if (!title || !company) {
                alert('Please enter job title and company');
                return;
            }
            
            const newApp = {
                id: Date.now(),
                title: title,
                company: company,
                appliedDate: document.getElementById('appDate').value,
                status: document.getElementById('appStatus').value,
                salary: document.getElementById('appSalary').value.trim(),
                matchScore: document.getElementById('appMatch').value ? parseInt(document.getElementById('appMatch').value) : null,
                url: document.getElementById('appUrl').value.trim(),
                nextFollowUp: document.getElementById('appFollowUp').value || null,
                notes: document.getElementById('appNotes').value.trim()
            };
            
            if (!userData.applications) userData.applications = [];
            userData.applications.unshift(newApp);
            
            saveUserData();
            closeExportModal();
            renderApplications();
            
            alert('Application added successfully!');
        }
        
        function updateApplicationStatus(idx) {
            const app = userData.applications[idx];
            const newStatus = prompt(`Update status for "${app.title}":\n\n1 = Applied\n2 = Interviewing\n3 = Offer\n4 = Closed\n\nEnter number:`, 
                                     app.status === 'applied' ? '1' : app.status === 'interviewing' ? '2' : app.status === 'offer' ? '3' : '4');
            
            if (newStatus) {
                const statusMap = {'1': 'applied', '2': 'interviewing', '3': 'offer', '4': 'rejected'};
                userData.applications[idx].status = statusMap[newStatus] || app.status;
                saveUserData();
                renderApplications();
            }
        }
        
        function editApplication(idx) {
            const app = userData.applications[idx];
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Edit Application</h2>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Job Title</label>
                            <input type="text" id="editAppTitle" value="${app.title}" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Company</label>
                            <input type="text" id="editAppCompany" value="${app.company}" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Status</label>
                            <select id="editAppStatus" class="settings-select">
                                <option value="applied" ${app.status === 'applied' ? 'selected' : ''}>Applied</option>
                                <option value="interviewing" ${app.status === 'interviewing' ? 'selected' : ''}>Interviewing</option>
                                <option value="offer" ${app.status === 'offer' ? 'selected' : ''}>Offer Received</option>
                                <option value="rejected" ${app.status === 'rejected' ? 'selected' : ''}>Closed</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Follow-Up Date</label>
                            <input type="date" id="editAppFollowUp" value="${app.nextFollowUp || ''}" class="settings-input">
                        </div>
                        
                        <div>
                            <label style="color: #60a5fa; font-weight: 600; display: block; margin-bottom: 8px;">Notes</label>
                            <textarea id="editAppNotes" class="purpose-editor" style="min-height: 80px;">${app.notes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                        <button class="action-btn" onclick="closeExportModal()">Cancel</button>
                        <button class="export-btn-large" onclick="saveApplicationEdit(${idx})">ðŸ’¾ Save Changes</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function saveApplicationEdit(idx) {
            userData.applications[idx].title = document.getElementById('editAppTitle').value;
            userData.applications[idx].company = document.getElementById('editAppCompany').value;
            userData.applications[idx].status = document.getElementById('editAppStatus').value;
            userData.applications[idx].nextFollowUp = document.getElementById('editAppFollowUp').value || null;
            userData.applications[idx].notes = document.getElementById('editAppNotes').value.trim();
            
            saveUserData();
            closeExportModal();
            renderApplications();
        }
        
        function deleteApplication(idx) {
            const app = userData.applications[idx];
            if (confirm(`Remove "${app.title}" at ${app.company} from tracker?`)) {
                userData.applications.splice(idx, 1);
                saveUserData();
                renderApplications();
            }
        }
        
        // ===== CONSENT & SHARING SYSTEM =====
        
        let sharePresets = {
            'full': { name: 'Full Transparency', skills: 'all', outcomes: 'all', values: 'all', purpose: true },
            'executive': { name: 'Executive Brief', skills: 'top20', outcomes: 'all', values: 'all', purpose: true },
            'advisory': { name: 'Advisory Pitch', skills: 'strategic', outcomes: 'strategic', values: 'all', purpose: true },
            'board': { name: 'Board Candidate', skills: 'leadership', outcomes: 'business', values: 'selected', purpose: true },
            'custom': { name: 'Custom', skills: 'selected', outcomes: 'selected', values: 'selected', purpose: true }
        };
        
        let currentPreset = 'custom';
        
        function initConsent() {
            const view = document.getElementById('consentView');
            
            view.innerHTML = `
                <div class="blueprint-container">
                    <div class="blueprint-header">
                        <h1 class="blueprint-title">Consent & Sharing</h1>
                        <p class="blueprint-subtitle">Your Data, Your Control</p>
                        <p class="blueprint-tagline">Choose exactly what you share and with whom</p>
                    </div>
                    
                    ${renderSharePresets()}
                    ${renderSharingStatus()}
                    ${renderLegalSection()}
                </div>
            `;
        }
        
        function renderSharePresets() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">ðŸŽšï¸</span>
                            <span>Share Profile Presets</span>
                        </div>
                    </div>
                    
                    <div class="coaching-tip">
                        <div class="coaching-tip-title">
                            ðŸ’¡ CHOOSE YOUR SHARING LEVEL
                        </div>
                        <div class="coaching-tip-content">
                            Select a preset that matches your audience, or use Custom to choose exactly what to share.
                            All presets respect your individual item toggles from the Work Blueprint.
                        </div>
                    </div>
                    
                    <div class="values-grid">
                        ${Object.entries(sharePresets).map(([key, preset]) => renderPresetCard(key, preset)).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderPresetCard(key, preset) {
            const selectedClass = currentPreset === key ? 'selected' : '';
            const descriptions = {
                'full': 'Share everything - all 73 skills, outcomes, values, and purpose',
                'executive': 'Top 20 skills + all outcomes and values - ideal for executive search',
                'advisory': 'Strategic & thought leadership skills + relevant outcomes - for advisory/consulting',
                'board': 'Leadership & business outcomes + governance experience - for board positions',
                'custom': 'You choose exactly which skills, outcomes, and values to share'
            };
            
            return `
                <div class="value-card ${selectedClass}" onclick="selectPreset('${key}')">
                    <div class="value-title">${preset.name}</div>
                    <div class="value-description">${descriptions[key]}</div>
                </div>
            `;
        }
        
        function renderSharingStatus() {
            const sharedSkills = currentPreset === 'all' ? skillsData.skills.length : 
                                currentPreset === 'top20' ? 20 :
                                skillsData.skills.filter((s, idx) => idx < 20).length;
            const sharedOutcomes = blueprintData.outcomes.filter(o => o.shared).length;
            const sharedValues = blueprintData.values.filter(v => v.selected).length;
            
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">ðŸ“Š</span>
                            <span>What You're Sharing</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #60a5fa; font-weight: bold;">${sharedSkills}</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Skills</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #10b981; font-weight: bold;">${sharedOutcomes}</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Outcomes</div>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #fbbf24; font-weight: bold;">${sharedValues}</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Values</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; color: #a78bfa; font-weight: bold;">âœ“</div>
                            <div style="color: #9ca3af; margin-top: 5px;">Purpose</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(251, 191, 36, 0.1); border-left: 3px solid #fbbf24; border-radius: 4px;">
                        <strong style="color: #fbbf24;">Note:</strong> 
                        <span style="color: #d1d5db;">Sensitive content (recovery, personal loss) is flagged in Work Blueprint. Review before sharing.</span>
                    </div>
                </div>
            `;
        }
        
        function renderLegalSection() {
            return `
                <div class="blueprint-section">
                    <div class="blueprint-section-header">
                        <div class="blueprint-section-title">
                            <span class="section-icon">âš–ï¸</span>
                            <span>Legal & Privacy</span>
                        </div>
                    </div>
                    
                    <div style="color: #d1d5db; line-height: 1.7;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Your Rights & Protections</h3>
                        
                        <p style="margin-bottom: 20px;">
                            Your Work Blueprint data is stored locally in your browser. You have complete control over what you share, 
                            when you share it, and with whom. This tool respects your privacy and employment data rights.
                        </p>
                        
                        <h4 style="color: #60a5fa; margin-bottom: 10px; margin-top: 20px;">Relevant Privacy Laws:</h4>
                        <ul style="list-style: none; padding: 0;">
                            <li style="padding: 10px; background: rgba(255, 255, 255, 0.03); margin-bottom: 8px; border-radius: 6px;">
                                <strong>ðŸ‡ºðŸ‡¸ CCPA (California Consumer Privacy Act)</strong><br>
                                <span style="font-size: 0.9em; color: #9ca3af;">
                                    Right to know what data is collected, right to delete, right to opt-out of sale
                                </span><br>
                                <a href="https://oag.ca.gov/privacy/ccpa" target="_blank" style="color: #60a5fa; text-decoration: none; font-size: 0.85em;">Learn more â†’</a>
                            </li>
                            <li style="padding: 10px; background: rgba(255, 255, 255, 0.03); margin-bottom: 8px; border-radius: 6px;">
                                <strong>ðŸ‡ªðŸ‡º GDPR (General Data Protection Regulation)</strong><br>
                                <span style="font-size: 0.9em; color: #9ca3af;">
                                    Right to access, rectify, erase, and port your personal data
                                </span><br>
                                <a href="https://gdpr.eu/" target="_blank" style="color: #60a5fa; text-decoration: none; font-size: 0.85em;">Learn more â†’</a>
                            </li>
                            <li style="padding: 10px; background: rgba(255, 255, 255, 0.03); margin-bottom: 8px; border-radius: 6px;">
                                <strong>ðŸ“‹ Employment Data Rights (US)</strong><br>
                                <span style="font-size: 0.9em; color: #9ca3af;">
                                    Employers must handle your data fairly and can't discriminate based on protected characteristics
                                </span><br>
                                <a href="https://www.eeoc.gov/" target="_blank" style="color: #60a5fa; text-decoration: none; font-size: 0.85em;">EEOC Guidelines â†’</a>
                            </li>
                        </ul>
                        
                        <h4 style="color: #60a5fa; margin-bottom: 10px; margin-top: 25px;">Best Practices:</h4>
                        <ul style="margin-left: 20px; color: #d1d5db;">
                            <li style="margin: 8px 0;">Never share sensitive personal information (SSN, financial details)</li>
                            <li style="margin: 8px 0;">Review what you're sharing before exporting or creating links</li>
                            <li style="margin: 8px 0;">Use time-limited shareable links when possible</li>
                            <li style="margin: 8px 0;">Keep Work Blueprint data up to date but don't embellish</li>
                            <li style="margin: 8px 0;">Consider context before sharing recovery/advocacy work</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function saveSettings() {
            // Get values from form
            userData.profile.name = document.getElementById('settingName').value;
            userData.profile.email = document.getElementById('settingEmail').value;
            userData.profile.location = document.getElementById('settingLocation').value;
            
            const newSeniority = document.getElementById('settingSeniority').value;
            userData.preferences.seniorityLevel = newSeniority;
            userData.preferences.minimumMatchScore = parseInt(document.querySelector('#settingsView .match-slider').value);
            userData.preferences.minimumSkillMatches = parseInt(document.getElementById('settingMinSkills').value);
            const minSalaryInput = document.getElementById('settingMinSalary').value;
            userData.preferences.minSalary = minSalaryInput ? parseInt(minSalaryInput) : null;
            
            // Update seniority keywords based on level
            if (newSeniority === 'Entry') {
                userData.preferences.seniorityKeywords = ['junior', 'associate', 'entry', 'coordinator'];
                userData.preferences.excludeRoles = ['senior', 'lead', 'manager', 'director', 'vp', 'chief', 'principal'];
            } else if (newSeniority === 'Mid') {
                userData.preferences.seniorityKeywords = ['senior', 'lead', 'manager', 'specialist'];
                userData.preferences.excludeRoles = ['junior', 'entry', 'associate', 'intern'];
            } else if (newSeniority === 'Senior') {
                userData.preferences.seniorityKeywords = ['senior manager', 'director', 'senior director', 'principal'];
                userData.preferences.excludeRoles = ['junior', 'entry', 'mid-level', 'associate'];
            } else { // Executive
                userData.preferences.seniorityKeywords = ['vp', 'vice president', 'chief', 'head of', 'director', 'principal', 'senior director'];
                userData.preferences.excludeRoles = ['engineer', 'developer', 'designer', 'analyst', 'coordinator', 'specialist', 
                                                    'junior', 'mid-level', 'associate', 'intern', 'entry'];
            }
            
            // Update header
            const userNameEl = document.getElementById('userName');
            if (userData.profile.name) {
                userNameEl.textContent = userData.profile.name + "'s";
            } else {
                userNameEl.textContent = "Your";
            }
            
            // Save to localStorage
            saveUserData();
            
            alert('Settings saved successfully!\n\nGo to Opportunities tab and click "Find Matching Jobs" to see updated results.');
        }
        
        function selectPreset(key) {
            currentPreset = key;
            initConsent(); // Re-render to show selection
            
            // Apply preset logic (for future export functionality)
            if (key === 'full') {
                // Mark all items as shared
                blueprintData.outcomes.forEach(o => o.shared = true);
                blueprintData.values.forEach(v => v.selected = true);
            }
            // Other presets would filter accordingly during export
        }
        
        function filterSkillsView(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            
            if (currentSkillsView === 'network') {
                // Filter network nodes
                const svg = d3.select("#networkView");
                const nodes = svg.selectAll(".node");
                
                nodes.style("opacity", function(d) {
                    if (d.type !== "skill") return 1;  // Keep center and roles visible
                    if (!term) return 1;  // No search, show all
                    return d.name.toLowerCase().includes(term) ? 1 : 0.1;
                });
                
                // Also filter text labels
                const labels = svg.selectAll(".node-label");
                labels.style("opacity", function(d) {
                    if (d.type !== "skill") return 1;
                    if (!term) return 1;
                    return d.name.toLowerCase().includes(term) ? 1 : 0.1;
                });
                
            } else {
                // Filter card view
                const cards = document.querySelectorAll('.skill-card');
                cards.forEach(card => {
                    const skillName = card.querySelector('h3').textContent.toLowerCase();
                    if (!term || skillName.includes(term)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
        }
        
        function showValuationBreakdown() {
            const totalValue = calculateTotalMarketValue();
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Get all skills with their impact ratings
            const allSkillsWithImpact = skillsData.skills.map(skill => {
                const impact = getSkillImpact(skill);
                return {
                    name: skill.name,
                    level: skill.level,
                    category: skill.category,
                    impact: impact,
                    impactLevel: impact.level
                };
            });
            
            // Sort by impact level then alphabetically
            const impactOrder = { 'critical': 1, 'high': 2, 'moderate': 3, 'standard': 4, 'supplementary': 5 };
            allSkillsWithImpact.sort((a, b) => {
                const orderDiff = impactOrder[a.impactLevel] - impactOrder[b.impactLevel];
                if (orderDiff !== 0) return orderDiff;
                return a.name.localeCompare(b.name);
            });
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">All ${skillsData.skills.length} Skills</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Complete list with impact ratings</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                            <div>
                                <div style="color: #ef4444; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'critical').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">ðŸ”¥ Critical</div>
                            </div>
                            <div>
                                <div style="color: #f59e0b; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'high').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">â­ High</div>
                            </div>
                            <div>
                                <div style="color: #3b82f6; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'moderate').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">ðŸ’Ž Moderate</div>
                            </div>
                            <div>
                                <div style="color: #6b7280; font-size: 1.8em; font-weight: 700;">
                                    ${allSkillsWithImpact.filter(s => s.impactLevel === 'standard').length}
                                </div>
                                <div style="color: #9ca3af; font-size: 0.9em;">âœ“ Standard</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">All Skills (Sorted by Impact)</h3>
                        <div style="display: grid; gap: 8px; max-height: 500px; overflow-y: auto; padding-right: 10px;">
                            ${allSkillsWithImpact.map((skill, idx) => {
                                const impactColor = getImpactColor(skill.impactLevel);
                                const categoryBadge = skill.category === 'skill' ? 'SKILL' : 
                                                     skill.category === 'ability' ? 'ABILITY' : 
                                                     skill.category === 'workstyle' ? 'WORK STYLE' : 'UNIQUE';
                                return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255, 255, 255, 0.03); border-radius: 6px; border-left: 3px solid ${impactColor};">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="color: #e0e0e0; font-weight: 500;">${skill.name}</span>
                                            <span style="color: #6b7280; font-size: 0.75em; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">${categoryBadge}</span>
                                        </div>
                                        <div style="color: #9ca3af; font-size: 0.85em;">
                                            ${skill.level} â€¢ ${skill.impact.label}
                                        </div>
                                    </div>
                                    <div style="color: ${impactColor}; font-weight: 600; font-size: 1.2em; min-width: 40px; text-align: right;">
                                        ${skill.impact.icon}
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">Your Market Value</h3>
                        <div style="color: #d1d5db; line-height: 1.8;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>Base Market Rate (${totalValue.percentile} percentile):</span>
                                <strong>$${totalValue.marketRate.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>Critical Skills Premium (${totalValue.criticalSkills.length} skills):</span>
                                <strong style="color: #10b981;">+$${totalValue.criticalBonus.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>High Impact Skills (${totalValue.highSkills.length} skills):</span>
                                <strong style="color: #10b981;">+$${totalValue.highBonus.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span>Rare Combinations:</span>
                                <strong style="color: #10b981;">+$${totalValue.rarityBonus.toLocaleString()}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 1.2em; margin-top: 10px;">
                                <strong>Total Market Value:</strong>
                                <strong style="color: #10b981;">$${totalValue.total.toLocaleString()}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <button class="export-btn-large" onclick="closeExportModal()" style="width: 100%; background: rgba(96, 165, 250, 0.2); border-color: #60a5fa; color: #60a5fa;">
                        Close
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function showNegotiationGuide() {
            const totalValue = calculateTotalMarketValue();
            const negotiationGap = totalValue.yourWorth - totalValue.standardOffer;
            
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">ðŸ’¼ Salary Negotiation Strategy</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">Compa-ratio based negotiation guidance</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <div style="color: #10b981; font-weight: 600; margin-bottom: 10px;">Your Market Worth</div>
                        <div style="font-size: 2em; font-weight: 700; color: #e0e0e0;">
                            $${totalValue.yourWorth.toLocaleString()}/year
                        </div>
                        <div style="color: #9ca3af; margin-top: 8px;">
                            ${totalValue.roleLevel} â€¢ ${totalValue.compaRatio}% compa-ratio â€¢ ${userData.profile.location}
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">ðŸ“Š Understanding Compa-Ratios</h3>
                        <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.7;">
                            <strong>Compa-ratio</strong> = Your salary Ã· Market median Ã— 100%
                            <br><br>
                            <strong>How Companies Use This:</strong>
                            <br>â€¢ <strong>80-120%</strong> = Acceptable range
                            <br>â€¢ <strong>100%</strong> = Exactly at market median
                            <br>â€¢ <strong>&lt;80%</strong> = Underpaid (flight risk)
                            <br>â€¢ <strong>&gt;120%</strong> = Overpaid for role
                            <br><br>
                            <strong>Market Rate (50th percentile):</strong> $${totalValue.marketRate.toLocaleString()}
                            <br><strong>Your Worth (with premiums):</strong> $${totalValue.yourWorth.toLocaleString()} (${totalValue.compaRatio}%)
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #fbbf24; margin-bottom: 15px;">ðŸ’° Expected Offer Ranges</h3>
                        <div style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">
                            Companies typically offer <strong>75-95%</strong> of your market worth. Here's what to expect:
                        </div>
                        
                        <div style="background: rgba(107, 114, 128, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #9ca3af;">
                            <div style="color: #9ca3af; font-weight: 600; margin-bottom: 5px;">Conservative Offer (75%)</div>
                            <div style="font-size: 1.3em; color: #e0e0e0; font-weight: 600;">
                                $${totalValue.conservativeOffer.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                                Budget-constrained companies â€¢ Startups â€¢ Non-profits
                            </div>
                        </div>
                        
                        <div style="background: rgba(96, 165, 250, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid #60a5fa;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Standard Offer (85%) â† Most Common</div>
                            <div style="font-size: 1.3em; color: #e0e0e0; font-weight: 600;">
                                $${totalValue.standardOffer.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                                Typical initial offers â€¢ Room to negotiate up
                            </div>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #10b981;">
                            <div style="color: #10b981; font-weight: 600; margin-bottom: 5px;">Competitive Offer (95%)</div>
                            <div style="font-size: 1.3em; color: #e0e0e0; font-weight: 600;">
                                $${totalValue.competitiveOffer.toLocaleString()}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.9em; margin-top: 5px;">
                                High-demand roles â€¢ Top-tier companies â€¢ Multiple offers
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 15px; background: rgba(251, 191, 36, 0.2); border-radius: 8px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 5px;">ðŸ’¡ Your Negotiation Gap</div>
                            <div style="color: #d1d5db; font-size: 0.95em;">
                                <strong>$${negotiationGap.toLocaleString()}</strong> between standard offer and your worth
                                <br>This is your leverage. Start at your worth ($${totalValue.yourWorth.toLocaleString()}) and negotiate down to competitive range ($${totalValue.competitiveOffer.toLocaleString()}+).
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(251, 191, 36, 0.1); padding: 20px; border-radius: 8px; border-left: 3px solid #fbbf24; margin-bottom: 25px;">
                        <h3 style="color: #fbbf24; margin-bottom: 15px;">ðŸŽ¯ Your Talking Points</h3>
                        <div style="color: #d1d5db; line-height: 1.8;">
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">1. Lead with Your Worth:</strong><br>
                                "Based on my skill profile and market analysis, my value is in the $${Math.round(totalValue.yourWorth * 0.95 / 1000) * 1000}-$${Math.round(totalValue.yourWorth * 1.05 / 1000) * 1000} range for ${totalValue.roleLevel} roles in ${userData.profile.location}."
                            </p>
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">2. Reference Your Top 10 Skills:</strong><br>
                                "I bring ${totalValue.top10Skills.filter(s => s.level === 'Mastery').length} mastery-level skills including ${totalValue.top10Skills.slice(0, 3).map(s => s.skill).join(', ')}. These command premiums in the current market."
                            </p>
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">3. Show the Data:</strong><br>
                                "The market rate for ${totalValue.roleLevel} is $${totalValue.marketRate.toLocaleString()}. My critical and high-impact skills justify a ${Math.round(((totalValue.yourWorth - totalValue.marketRate) / totalValue.marketRate) * 100)}% premium."
                            </p>
                            <p style="margin-bottom: 15px;">
                                <strong style="color: #fbbf24;">4. Use Your Outcomes:</strong><br>
                                "I've consistently delivered [cite 2-3 quantified outcomes from your Work Blueprint]. This track record supports my valuation."
                            </p>
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">ðŸ“‹ Negotiation Script</h3>
                        <div style="color: #d1d5db; line-height: 1.8; font-size: 0.95em;">
                            <strong>When they ask for salary expectations:</strong>
                            <br><br>
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px; margin: 10px 0; font-style: italic;">
                            "I appreciate you asking. Based on my research and skill profile, I'm looking at the $${Math.round(totalValue.competitiveOffer / 1000) * 1000}-$${Math.round(totalValue.yourWorth / 1000) * 1000} range. But I'm flexible depending on the total compensation package, including equity and benefits. What range were you considering?"
                            </div>
                            <br>
                            <strong>When they give a low offer ($${totalValue.conservativeOffer.toLocaleString()}):</strong>
                            <br><br>
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 6px; margin: 10px 0; font-style: italic;">
                            "I appreciate the offer. Based on market data for ${totalValue.roleLevel} roles with my skill setâ€”particularly my ${totalValue.top10Skills[0].skill} expertiseâ€”the range is typically closer to $${totalValue.standardOffer.toLocaleString()}-$${totalValue.competitiveOffer.toLocaleString()}. Can we explore options in that range?"
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(96, 165, 250, 0.1); padding: 20px; border-radius: 8px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">âœ“ Best Practices</h3>
                        <div style="color: #d1d5db; line-height: 1.8;">
                            <div style="margin-bottom: 15px;">
                                <strong style="color: #10b981;">DO:</strong>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    <li>Start at your worth ($${totalValue.yourWorth.toLocaleString()})</li>
                                    <li>Reference the $${negotiationGap.toLocaleString()} gap as your leverage</li>
                                    <li>Cite your top 10 skills as justification</li>
                                    <li>Ask about total comp (equity, bonus, benefits)</li>
                                    <li>Get offers in writing before negotiating</li>
                                </ul>
                            </div>
                            <div>
                                <strong style="color: #ef4444;">DON'T:</strong>
                                <ul style="margin-left: 20px; margin-top: 8px;">
                                    <li>Accept the first offerâ€”they expect negotiation</li>
                                    <li>Give a range firstâ€”make them lead</li>
                                    <li>Focus only on base salary</li>
                                    <li>Negotiate without data</li>
                                    <li>Accept below $${totalValue.conservativeOffer.toLocaleString()} (75%)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <button class="export-btn-large" onclick="closeExportModal()" style="width: 100%; margin-top: 25px;">
                        Close Guide
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        // ===== IMPACT RATING ENGINE =====
        
        let impactRatings = null;
        
        async function loadImpactRatings() {
            try {
                const response = await fetch('onet-impact-ratings.json');
                impactRatings = await response.json();
                console.log('âœ“ Impact ratings loaded');
            } catch (e) {
                console.error('Error loading impact ratings:', e);
            }
        }
        
        // Load impact ratings on startup
        loadImpactRatings();
        
        function getSkillImpact(skill) {
            if (!impactRatings) {
                return { level: 'moderate', label: 'Moderate Impact', icon: 'ðŸ’Ž', rationale: 'Loading ratings...' };
            }
            
            // Handle unique skills (no O*NET match)
            if (skill.category === 'unique') {
                return getUniqueSkillImpact(skill);
            }
            
            // Get O*NET rating
            const category = skill.category; // 'skill', 'ability', 'workstyle'
            const categoryData = impactRatings[category + 's']; // 'skills', 'abilities', 'workstyles'
            
            if (!categoryData || !skill.onetId) {
                return { level: 'moderate', label: 'Moderate Impact', icon: 'ðŸ’Ž', rationale: 'No rating data available' };
            }
            
            const skillRating = categoryData[skill.onetId];
            if (!skillRating) {
                return { level: 'moderate', label: 'Moderate Impact', icon: 'ðŸ’Ž', rationale: 'Skill not found in ratings' };
            }
            
            // Apply proficiency multiplier
            const impactLevel = skillRating.proficiencyMultiplier[skill.level] || skillRating.baseImpact;
            
            return {
                level: impactLevel,
                label: getImpactLabel(impactLevel),
                icon: getImpactIcon(impactLevel),
                rationale: skillRating.rationale,
                executiveImportance: skillRating.executiveImportance,
                marketScarcity: skillRating.marketScarcity
            };
        }
        
        function getUniqueSkillImpact(skill) {
            // Check if user has assessed this skill
            if (skill.userAssessment) {
                return calculateUniqueSkillImpact(skill.userAssessment);
            }
            
            // Try to find comparable O*NET skill
            const comparable = findComparableSkill(skill.name);
            if (comparable) {
                return {
                    ...comparable,
                    rationale: `Estimated based on similar skills. Consider providing custom assessment for more accuracy.`,
                    needsAssessment: true
                };
            }
            
            // Default for unique skills without assessment
            return {
                level: 'high',
                label: 'High Impact',
                icon: 'â­',
                rationale: 'Unique differentiator. Provide assessment for accurate rating.',
                needsAssessment: true
            };
        }
        
        function findComparableSkill(skillName) {
            if (!impactRatings) return null;
            
            const name = skillName.toLowerCase();
            
            // Simple keyword matching to find comparable
            if (name.includes('ai') || name.includes('artificial intelligence')) {
                return getSkillImpact({ category: 'skill', onetId: 'systems-analysis', level: 'Mastery' });
            }
            if (name.includes('strategy')) {
                return getSkillImpact({ category: 'skill', onetId: 'complex-problem-solving', level: 'Mastery' });
            }
            if (name.includes('leadership')) {
                return getSkillImpact({ category: 'workstyle', onetId: 'leadership', level: 'Mastery' });
            }
            
            return null;
        }
        
        function calculateUniqueSkillImpact(assessment) {
            let score = 0;
            
            // Years experience (mastery indicator)
            if (assessment.years >= 10) score += 3;
            else if (assessment.years >= 5) score += 2;
            else score += 1;
            
            // Business impact
            if (assessment.impact === 'major') score += 3;
            else if (assessment.impact === 'significant') score += 2;
            else score += 1;
            
            // Scarcity
            if (assessment.rarity === 'rare') score += 3;
            else if (assessment.rarity === 'uncommon') score += 2;
            else score += 1;
            
            // Salary band
            if (assessment.salaryBand === '>$250k') score += 3;
            else if (assessment.salaryBand === '$150-250k') score += 2;
            else score += 1;
            
            // Total: 4-12
            let impactLevel;
            if (score >= 10) impactLevel = 'critical';
            else if (score >= 8) impactLevel = 'high';
            else if (score >= 6) impactLevel = 'moderate';
            else impactLevel = 'standard';
            
            return {
                level: impactLevel,
                label: getImpactLabel(impactLevel),
                icon: getImpactIcon(impactLevel),
                rationale: 'Based on your assessment',
                userAssessed: true
            };
        }
        
        function getImpactLabel(level) {
            const labels = {
                'critical': 'Critical Impact',
                'high': 'High Impact',
                'moderate': 'Moderate Impact',
                'standard': 'Standard',
                'supplementary': 'Supplementary'
            };
            return labels[level] || 'Moderate Impact';
        }
        
        function getImpactIcon(level) {
            const icons = {
                'critical': 'ðŸ”¥',
                'high': 'â­',
                'moderate': 'ðŸ’Ž',
                'standard': 'âœ“',
                'supplementary': 'â—‹'
            };
            return icons[level] || 'ðŸ’Ž';
        }
        
        function getImpactColor(level) {
            const colors = {
                'critical': '#ef4444',
                'high': '#f59e0b',
                'moderate': '#3b82f6',
                'standard': '#6b7280',
                'supplementary': '#9ca3af'
            };
            return colors[level] || '#3b82f6';
        }
        
        // ===== SKILL MANAGEMENT FUNCTIONS =====
        
        let onetSelectedSkills = [];
        let currentONETTab = 'skills';
        let currentEditingSkill = null;
        
        function openONETPicker() {
            const modal = document.getElementById('onetPickerModal');
            modal.classList.add('active');
            switchONETTab('skills');
            updateONETSelectedCount(); // Initialize count display
        }
        
        function closeONETPicker() {
            const modal = document.getElementById('onetPickerModal');
            modal.classList.remove('active');
            onetSelectedSkills = [];
        }
        
        function switchONETTab(tab) {
            currentONETTab = tab;
            
            // Update tab styling
            document.querySelectorAll('.onet-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('onetTab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            // Load content
            renderONETLibrary();
        }
        
        function renderONETLibrary() {
            const container = document.getElementById('onetLibraryContent');
            const searchQuery = document.getElementById('onetSearchInput').value.toLowerCase();
            
            let html = '';
            let library, categoryKey;
            
            if (currentONETTab === 'skills') {
                library = window.onetSkillsLibrary;
                categoryKey = 'skill';
            } else if (currentONETTab === 'abilities') {
                library = window.onetAbilitiesLibrary;
                categoryKey = 'ability';
            } else {
                library = window.onetWorkStylesLibrary;
                categoryKey = 'workstyle';
            }
            
            if (!library) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Library not loaded</div>';
                return;
            }
            
            // Get user's existing skills of this category
            const existingSkillNames = userData.skills
                .filter(s => s.category === categoryKey)
                .map(s => s.name);
            
            if (currentONETTab === 'workstyles') {
                // Work styles are a flat array
                library.workStyles.forEach(item => {
                    const isAdded = existingSkillNames.includes(item.name);
                    const isSelected = onetSelectedSkills.some(s => s.id === item.id);
                    const matchesSearch = !searchQuery || 
                        item.name.toLowerCase().includes(searchQuery) ||
                        item.definition.toLowerCase().includes(searchQuery);
                    
                    if (!matchesSearch) return;
                    
                    html += renderONETSkillItem(item, categoryKey, isAdded, isSelected);
                });
            } else {
                // Skills and abilities have category/subcategory structure
                const categories = currentONETTab === 'skills' ? library.categories : library.categories;
                
                Object.entries(categories).forEach(([catId, category]) => {
                    let categoryHtml = '';
                    let categoryHasResults = false;
                    
                    if (category.subcategories) {
                        Object.entries(category.subcategories).forEach(([subId, subcategory]) => {
                            let subcategoryHtml = '';
                            let subcategoryHasResults = false;
                            
                            const items = currentONETTab === 'skills' ? subcategory.skills : subcategory.abilities;
                            if (!items) return;
                            
                            items.forEach(item => {
                                const isAdded = existingSkillNames.includes(item.name);
                                const isSelected = onetSelectedSkills.some(s => s.id === item.id);
                                const matchesSearch = !searchQuery || 
                                    item.name.toLowerCase().includes(searchQuery) ||
                                    item.definition.toLowerCase().includes(searchQuery);
                                
                                if (!matchesSearch) return;
                                
                                subcategoryHtml += renderONETSkillItem(item, categoryKey, isAdded, isSelected);
                                subcategoryHasResults = true;
                                categoryHasResults = true;
                            });
                            
                            if (subcategoryHasResults) {
                                categoryHtml += `
                                    <div class="onet-subcategory">
                                        <div class="onet-subcategory-title">${subcategory.name}</div>
                                        ${subcategoryHtml}
                                    </div>
                                `;
                            }
                        });
                    }
                    
                    if (categoryHasResults) {
                        html += `
                            <div class="onet-category">
                                <div class="onet-category-title">â–¼ ${category.name}</div>
                                ${categoryHtml}
                            </div>
                        `;
                    }
                });
            }
            
            if (!html) {
                html = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No results found</div>';
            }
            
            container.innerHTML = html;
            updateONETSelectedCount();
        }
        
        function renderONETSkillItem(item, category, isAdded, isSelected) {
            const disabled = isAdded ? 'disabled' : '';
            const selectedClass = isSelected ? 'selected' : '';
            
            return `
                <div class="onet-skill-item ${disabled} ${selectedClass}" 
                     onclick="${isAdded ? '' : `toggleONETSkillSelection('${item.id}', '${item.name}', '${category}')`}">
                    <input type="checkbox" 
                           class="onet-skill-checkbox" 
                           ${isSelected ? 'checked' : ''}
                           ${isAdded ? 'disabled' : ''}
                           onclick="event.stopPropagation();">
                    <div class="onet-skill-content">
                        <div class="onet-skill-name">
                            ${item.name}
                            ${isAdded ? '<span class="onet-skill-added">âœ“ Added</span>' : ''}
                        </div>
                        <div class="onet-skill-definition">${item.definition}</div>
                    </div>
                </div>
            `;
        }
        
        function toggleONETSkillSelection(id, name, category) {
            const index = onetSelectedSkills.findIndex(s => s.id === id);
            
            if (index === -1) {
                onetSelectedSkills.push({ id, name, category });
            } else {
                onetSelectedSkills.splice(index, 1);
            }
            
            renderONETLibrary();
            updateONETSelectedCount(); // FIX: Update count display
        }
        
        function updateONETSelectedCount() {
            const count = onetSelectedSkills.length;
            const countEl = document.getElementById('onetSelectedCount');
            const buttonEl = document.getElementById('onetAddButton');
            
            if (count === 0) {
                countEl.textContent = 'Select skills to add';
                buttonEl.disabled = true;
                buttonEl.style.opacity = '0.5';
            } else {
                countEl.textContent = `${count} skill${count > 1 ? 's' : ''} selected`;
                buttonEl.disabled = false;
                buttonEl.style.opacity = '1';
            }
        }
        
        function filterONETLibrary() {
            renderONETLibrary();
        }
        
        function addSelectedONETSkills() {
            if (onetSelectedSkills.length === 0) return;
            
            onetSelectedSkills.forEach(selectedSkill => {
                // Create skill object
                const newSkill = {
                    name: selectedSkill.name,
                    category: selectedSkill.category,
                    onetId: selectedSkill.id,
                    level: 'Advanced', // Default
                    roles: [userData.roles[0].id], // Default to first role
                    key: false
                };
                
                // Add to userData
                userData.skills.push(newSkill);
                skillsData.skills.push(newSkill);
            });
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            closeONETPicker();
            
            // Show success message
            alert(`Added ${onetSelectedSkills.length} skill${onetSelectedSkills.length > 1 ? 's' : ''}!`);
        }
        
        function openCustomSkillBuilder() {
            const modal = document.getElementById('customSkillModal');
            
            // Populate roles checkboxes
            const rolesContainer = document.getElementById('customSkillRoles');
            rolesContainer.innerHTML = userData.roles.map(role => `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" value="${role.id}" class="custom-skill-role-checkbox">
                    <span>${role.name}</span>
                </label>
            `).join('');
            
            // Reset form
            document.getElementById('customSkillName').value = '';
            document.getElementById('customSkillCore').checked = false;
            
            modal.classList.add('active');
        }
        
        function closeCustomSkillBuilder() {
            const modal = document.getElementById('customSkillModal');
            modal.classList.remove('active');
        }
        
        function createCustomSkill() {
            const name = document.getElementById('customSkillName').value.trim();
            const level = document.querySelector('input[name="customSkillLevel"]:checked').value;
            const core = document.getElementById('customSkillCore').checked;
            const roles = Array.from(document.querySelectorAll('.custom-skill-role-checkbox:checked')).map(cb => cb.value);
            
            // Validate
            if (!name) {
                alert('Please enter a skill name');
                return;
            }
            
            if (roles.length === 0) {
                alert('Please select at least one role');
                return;
            }
            
            // Check for duplicates
            if (userData.skills.some(s => s.name === name)) {
                alert('A skill with this name already exists');
                return;
            }
            
            // Create skill
            const newSkill = {
                name: name,
                category: 'unique',
                level: level,
                roles: roles,
                key: core
            };
            
            // Add to userData
            userData.skills.push(newSkill);
            skillsData.skills.push(newSkill);
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            closeCustomSkillBuilder();
            
            alert(`Created "${name}"!`);
        }
        
        function openEditSkillModal(skillName, category) {
            const skill = userData.skills.find(s => s.name === skillName);
            if (!skill) return;
            
            currentEditingSkill = skillName;
            const modal = document.getElementById('editSkillModal');
            
            // Populate form
            document.getElementById('editSkillName').value = skill.name;
            document.querySelector(`input[name="editSkillLevel"][value="${skill.level}"]`).checked = true;
            document.getElementById('editSkillCore').checked = skill.key || false;
            
            // Populate roles
            const rolesContainer = document.getElementById('editSkillRoles');
            rolesContainer.innerHTML = userData.roles.map(role => `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" value="${role.id}" class="edit-skill-role-checkbox" ${skill.roles.includes(role.id) ? 'checked' : ''}>
                    <span>${role.name}</span>
                </label>
            `).join('');
            
            modal.classList.add('active');
        }
        
        function closeEditSkillModal() {
            const modal = document.getElementById('editSkillModal');
            modal.classList.remove('active');
            currentEditingSkill = null;
        }
        
        function saveSkillEdit() {
            if (!currentEditingSkill) return;
            
            const skill = userData.skills.find(s => s.name === currentEditingSkill);
            if (!skill) return;
            
            const level = document.querySelector('input[name="editSkillLevel"]:checked').value;
            const core = document.getElementById('editSkillCore').checked;
            const roles = Array.from(document.querySelectorAll('.edit-skill-role-checkbox:checked')).map(cb => cb.value);
            
            // Validate
            if (roles.length === 0) {
                alert('Please select at least one role');
                return;
            }
            
            // Update skill
            skill.level = level;
            skill.key = core;
            skill.roles = roles;
            
            // Update skillsData too
            const skillDataIndex = skillsData.skills.findIndex(s => s.name === currentEditingSkill);
            if (skillDataIndex !== -1) {
                skillsData.skills[skillDataIndex] = {...skill};
            }
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            closeEditSkillModal();
            
            alert(`Updated "${currentEditingSkill}"!`);
        }
        
        function confirmDeleteSkill(skillName, category) {
            if (!confirm(`Delete "${skillName}"?\n\nThis cannot be undone.`)) {
                return;
            }
            
            deleteSkill(skillName);
        }
        
        function deleteSkill(skillName) {
            // Remove from userData
            const userIndex = userData.skills.findIndex(s => s.name === skillName);
            if (userIndex !== -1) {
                userData.skills.splice(userIndex, 1);
            }
            
            // Remove from skillsData
            const skillsIndex = skillsData.skills.findIndex(s => s.name === skillName);
            if (skillsIndex !== -1) {
                skillsData.skills.splice(skillsIndex, 1);
            }
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            console.log(`Deleted skill: ${skillName}`);
        }
        
        // ===== SKILL ASSESSMENT FUNCTIONS =====
        
        let currentAssessingSkill = null;
        
        function openAssessSkillModal(skillName) {
            const skill = userData.skills.find(s => s.name === skillName);
            if (!skill) return;
            
            currentAssessingSkill = skillName;
            const modal = document.getElementById('assessSkillModal');
            
            // Set skill name
            document.getElementById('assessSkillName').textContent = skill.name;
            
            // Pre-fill with existing assessment if available
            if (skill.userAssessment) {
                document.getElementById('assessYears').value = skill.userAssessment.years || 5;
                document.querySelector(`input[name="assessImpact"][value="${skill.userAssessment.impact}"]`).checked = true;
                document.querySelector(`input[name="assessRarity"][value="${skill.userAssessment.rarity}"]`).checked = true;
                document.querySelector(`input[name="assessSalary"][value="${skill.userAssessment.salaryBand}"]`).checked = true;
            } else {
                // Defaults
                document.getElementById('assessYears').value = 5;
                document.querySelector('input[name="assessImpact"][value="significant"]').checked = true;
                document.querySelector('input[name="assessRarity"][value="uncommon"]').checked = true;
                document.querySelector('input[name="assessSalary"][value="$150-250k"]').checked = true;
            }
            
            updateAssessmentPreview();
            modal.classList.add('active');
            
            // Add listeners for live preview
            document.getElementById('assessYears').addEventListener('input', updateAssessmentPreview);
            document.querySelectorAll('input[name="assessImpact"]').forEach(r => 
                r.addEventListener('change', updateAssessmentPreview));
            document.querySelectorAll('input[name="assessRarity"]').forEach(r => 
                r.addEventListener('change', updateAssessmentPreview));
            document.querySelectorAll('input[name="assessSalary"]').forEach(r => 
                r.addEventListener('change', updateAssessmentPreview));
        }
        
        function closeAssessSkillModal() {
            const modal = document.getElementById('assessSkillModal');
            modal.classList.remove('active');
            currentAssessingSkill = null;
        }
        
        function updateAssessmentPreview() {
            const years = parseInt(document.getElementById('assessYears').value) || 0;
            const impact = document.querySelector('input[name="assessImpact"]:checked')?.value || 'significant';
            const rarity = document.querySelector('input[name="assessRarity"]:checked')?.value || 'uncommon';
            const salaryBand = document.querySelector('input[name="assessSalary"]:checked')?.value || '$150-250k';
            
            const assessment = { years, impact, rarity, salaryBand };
            const result = calculateUniqueSkillImpact(assessment);
            
            const preview = document.getElementById('assessmentPreview');
            const icon = getImpactIcon(result.level);
            const label = getImpactLabel(result.level);
            const color = getImpactColor(result.level);
            
            preview.innerHTML = `Predicted rating: <span style="color: ${color}; font-weight: 600;">${icon} ${label}</span>`;
        }
        
        function saveSkillAssessment() {
            if (!currentAssessingSkill) return;
            
            const skill = userData.skills.find(s => s.name === currentAssessingSkill);
            if (!skill) return;
            
            // Gather assessment data
            const years = parseInt(document.getElementById('assessYears').value) || 0;
            const impact = document.querySelector('input[name="assessImpact"]:checked')?.value || 'significant';
            const rarity = document.querySelector('input[name="assessRarity"]:checked')?.value || 'uncommon';
            const salaryBand = document.querySelector('input[name="assessSalary"]:checked')?.value || '$150-250k';
            
            // Save to skill object
            skill.userAssessment = {
                years: years,
                impact: impact,
                rarity: rarity,
                salaryBand: salaryBand,
                assessedDate: new Date().toISOString()
            };
            
            // Update skillsData too
            const skillDataIndex = skillsData.skills.findIndex(s => s.name === currentAssessingSkill);
            if (skillDataIndex !== -1) {
                skillsData.skills[skillDataIndex].userAssessment = skill.userAssessment;
            }
            
            // Save and refresh
            saveUserData();
            refreshAllViews();
            
            closeAssessSkillModal();
            
            const result = calculateUniqueSkillImpact(skill.userAssessment);
            alert(`Assessment saved!\n\n"${currentAssessingSkill}" rated as: ${result.label}`);
        }
        
        function refreshAllViews() {
            // Refresh settings skill list
            const skillsList = document.getElementById('skillsList');
            if (skillsList) {
                skillsList.innerHTML = renderSkillsList();
            }
            
            // Refresh network graph
            if (currentView === 'network') {
                initNetwork();
            }
            
            // Refresh card view
            if (currentView === 'network' && currentSkillsView === 'cards') {
                renderCardView();
            }
            
            // Update stats bar
            updateStatsBar();
            
            // Re-render settings (to update counts)
            if (currentView === 'settings') {
                initSettings();
            }
        }
        
        // ===== SKILL SEARCH MODAL FUNCTIONS (v2.3.0) =====
        
        // ===== UNIFIED SKILL MANAGEMENT SYSTEM (v2.4.0) =====
        
        let currentSkillManagementTab = 'yours';

        function openSkillManagement() {
            const modal = document.getElementById('skillManagementModal');
            modal.classList.add('active');
            
            // Force library load if not loaded
            if (!skillLibraryIndex || !skillLibraryIndex.index) {
                console.log('Skill library not loaded, loading now...');
                loadSkillLibraryIndex();
            }
            
            updateSkillManagementCounts();
            switchSkillManagementTab('yours');
        }

        function closeSkillManagement() {
            const modal = document.getElementById('skillManagementModal');
            modal.classList.remove('active');
        }

        function switchSkillManagementTab(tab) {
            currentSkillManagementTab = tab;
            
            document.getElementById('yourSkillsTab').classList.toggle('active', tab === 'yours');
            document.getElementById('addSkillsTab').classList.toggle('active', tab === 'add');
            
            document.getElementById('yourSkillsContent').style.display = tab === 'yours' ? 'block' : 'none';
            document.getElementById('addSkillsContent').style.display = tab === 'add' ? 'block' : 'none';
            
            if (tab === 'yours') {
                renderYourSkills();
            } else {
                showAddSkillsEmpty();
            }
        }

        function updateSkillManagementCounts() {
            const yourCount = userData.skills.length;
            const availableCount = skillLibraryIndex ? skillLibraryIndex.totalSkills : 2138;
            
            document.getElementById('yourSkillsCount').textContent = yourCount;
            document.getElementById('availableSkillsCount').textContent = availableCount.toLocaleString();
            document.getElementById('skillManagementCount').textContent = 
                `${yourCount} selected â€¢ ${availableCount.toLocaleString()} available`;
        }

        function renderYourSkills() {
            const container = document.getElementById('yourSkillsList');
            const searchQuery = document.getElementById('yourSkillsSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('yourSkillsCategoryFilter').value;
            const levelFilter = document.getElementById('yourSkillsLevelFilter').value;
            
            let skills = userData.skills.filter(skill => {
                const matchesSearch = !searchQuery || skill.name.toLowerCase().includes(searchQuery);
                const matchesCategory = categoryFilter === 'all' || skill.category === categoryFilter;
                const matchesLevel = levelFilter === 'all' || skill.level === levelFilter;
                return matchesSearch && matchesCategory && matchesLevel;
            });
            
            if (skills.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                        <div style="font-size: 3em; margin-bottom: 10px;">ðŸ“‹</div>
                        <div style="font-size: 1.1em;">No skills found</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">Try adjusting your filters</div>
                    </div>
                `;
                return;
            }
            
            const grouped = {};
            skills.forEach(skill => {
                const cat = skill.category || 'unique';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(skill);
            });
            
            const categoryNames = {
                'skill': 'Technology',
                'ability': 'General Professional',
                'workstyle': 'Work Styles',
                'unique': 'Custom Skills'
            };
            
            container.innerHTML = Object.entries(grouped).map(([cat, catSkills]) => `
                <div style="margin-bottom: 25px;">
                    <div style="color: #9ca3af; font-size: 0.85em; font-weight: 600; margin-bottom: 12px; text-transform: uppercase;">
                        ${categoryNames[cat] || cat} (${catSkills.length})
                    </div>
                    ${catSkills.map(skill => `
                        <div class="your-skill-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="color: #e0e0e0; font-weight: 600; margin-bottom: 6px; font-size: 1.05em;">
                                        ${skill.name}
                                    </div>
                                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                        <span style="color: #60a5fa; font-size: 0.8em; padding: 2px 8px; background: rgba(96, 165, 250, 0.2); border-radius: 3px;">
                                            ${skill.level}
                                        </span>
                                        ${skill.key ? '<span style="color: #fbbf24; font-size: 0.8em;">â­ Core</span>' : ''}
                                        ${skill.roles ? `<span style="color: #9ca3af; font-size: 0.8em;">${skill.roles.length} role${skill.roles.length > 1 ? 's' : ''}</span>` : ''}
                                    </div>
                                </div>
                                <button onclick="removeSkillFromProfile('${skill.name.replace(/'/g, "\\'")}', '${cat}')" 
                                        style="padding: 8px 16px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap; font-weight: 600; transition: all 0.2s;"
                                        onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                                        onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        function filterYourSkills() {
            renderYourSkills();
        }

        function removeSkillFromProfile(skillName, category) {
            if (!confirm(`Remove "${skillName}" from your profile?`)) return;
            
            const skillIndex = userData.skills.findIndex(s => s.name === skillName && s.category === category);
            if (skillIndex !== -1) {
                userData.skills.splice(skillIndex, 1);
            }
            
            const dataIndex = skillsData.skills.findIndex(s => s.name === skillName && s.category === category);
            if (dataIndex !== -1) {
                skillsData.skills.splice(dataIndex, 1);
            }
            
            saveUserData();
            updateSkillManagementCounts();
            renderYourSkills();
            refreshAllViews();
        }

        function showAddSkillsEmpty() {
            const container = document.getElementById('addSkillsResults');
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                    <div style="font-size: 3em; margin-bottom: 10px;">ðŸ”</div>
                    <div style="font-size: 1.1em;">Start typing to search skills</div>
                    <div style="font-size: 0.9em; margin-top: 10px;">Try: "python", "marketing", "leadership"</div>
                </div>
            `;
            document.getElementById('skillManagementStatus').textContent = '';
            document.getElementById('addSkillsCategories').style.display = 'block';
        }

        let addSkillsSearchTimeout;
        function handleAddSkillsSearch() {
            clearTimeout(addSkillsSearchTimeout);
            
            addSkillsSearchTimeout = setTimeout(() => {
                const query = document.getElementById('addSkillsSearchInput').value;
                console.log('Search triggered for:', query);
                
                if (!skillLibraryIndex || !skillLibraryIndex.index) {
                    console.error('Skill library not loaded!');
                    const container = document.getElementById('addSkillsResults');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #f59e0b;">
                            <div style="font-size: 3em; margin-bottom: 10px;">â³</div>
                            <div style="font-size: 1.1em;">Loading skill library...</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">Please wait</div>
                        </div>
                    `;
                    // Force reload
                    loadSkillLibraryIndex().then(() => {
                        console.log('Library loaded, retrying search');
                        handleAddSkillsSearch();
                    });
                    return;
                }
                
                console.log('Library loaded with', skillLibraryIndex.totalSkills, 'skills');
                
                if (!query || query.trim().length < 2) {
                    console.log('Query too short, showing empty state');
                    showAddSkillsEmpty();
                    return;
                }
                
                console.log('Performing search for:', query);
                performAddSkillsSearch(query);
            }, 300);
        }

        function performAddSkillsSearch(query) {
            console.log('=== performAddSkillsSearch START ===');
            console.log('Query:', query);
            console.log('skillLibraryIndex exists?', !!skillLibraryIndex);
            
            try {
                const results = searchSkills(query);
                console.log('searchSkills returned:', results);
                console.log('Results type:', typeof results);
                console.log('Results is array?', Array.isArray(results));
                
                // DEFENSIVE: Ensure results is always an array
                const safeResults = Array.isArray(results) ? results : [];
                console.log('Safe results length:', safeResults.length);
                
                const container = document.getElementById('addSkillsResults');
                if (!container) {
                    console.error('ERROR: addSkillsResults container not found!');
                    return;
                }
                
                const categoriesDiv = document.getElementById('addSkillsCategories');
                if (categoriesDiv) {
                    categoriesDiv.style.display = 'none';
                }
                
                if (safeResults.length === 0) {
                    console.log('No results found, showing empty state');
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                            <div style="font-size: 3em; margin-bottom: 10px;">âŒ</div>
                            <div style="font-size: 1.1em;">No skills found for "${query}"</div>
                            <div style="font-size: 0.9em; margin-top: 10px;">Try a different search term</div>
                        </div>
                    `;
                    const statusEl = document.getElementById('skillManagementStatus');
                    if (statusEl) statusEl.textContent = 'No results';
                    console.log('=== performAddSkillsSearch END (no results) ===');
                    return;
                }
                
                console.log('Rendering', safeResults.length, 'results');
                container.innerHTML = safeResults.map(skill => {
                    try {
                        const isAdded = isSkillAlreadyAdded(skill.n);
                        const categoryColor = getCategoryColor(skill.c);
                        
                        return `
                            <div class="skill-search-result ${isAdded ? 'added' : ''}" 
                                 style="padding: 12px; margin-bottom: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid ${categoryColor}; cursor: ${isAdded ? 'default' : 'pointer'}; transition: all 0.2s;"
                                 ${isAdded ? '' : `onclick="addSkillFromLibrary('${skill.id}')"`}
                                 onmouseover="if (!this.classList.contains('added')) this.style.background='rgba(255,255,255,0.06)'"
                                 onmouseout="if (!this.classList.contains('added')) this.style.background='rgba(255,255,255,0.03)'">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="color: #e0e0e0; font-weight: 600; margin-bottom: 4px;">
                                            ${skill.n}
                                            ${isAdded ? '<span style="color: #10b981; font-size: 0.85em; margin-left: 8px;">âœ“ Already have</span>' : ''}
                                        </div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <span style="color: ${categoryColor}; font-size: 0.75em; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                                                ${skill.c}
                                            </span>
                                            ${skill.sc ? `
                                                <span style="color: #9ca3af; font-size: 0.75em;">
                                                    ${skill.sc}
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${!isAdded ? `
                                        <button style="padding: 6px 12px; background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); border: none; border-radius: 6px; color: white; font-size: 0.85em; font-weight: 600; cursor: pointer;"
                                                onclick="event.stopPropagation(); addSkillFromLibrary('${skill.id}')">
                                            + Add
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    } catch (skillError) {
                        console.error('Error rendering skill:', skill, skillError);
                        return '';
                    }
                }).filter(Boolean).join('');
                
                const statusEl = document.getElementById('skillManagementStatus');
                if (statusEl) {
                    statusEl.textContent = `Found ${safeResults.length} skill${safeResults.length > 1 ? 's' : ''}`;
                }
                
                console.log('=== performAddSkillsSearch END (success) ===');
                
            } catch (error) {
                console.error('=== CRITICAL ERROR in performAddSkillsSearch ===');
                console.error('Error:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                const container = document.getElementById('addSkillsResults');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #ef4444;">
                            <div style="font-size: 3em; margin-bottom: 10px;">âš ï¸</div>
                            <div style="font-size: 1.1em; font-weight: bold;">Search Error</div>
                            <div style="font-size: 0.9em; margin-top: 10px; font-family: monospace;">
                                ${error.message}
                            </div>
                            <div style="font-size: 0.85em; margin-top: 10px; color: #9ca3af;">
                                Check browser console (F12) for details
                            </div>
                        </div>
                    `;
                }
                
                alert('Search error: ' + error.message + '\n\nCheck console (F12) for details');
            }
        }

        function searchAddSkillsByCategory(category) {
            document.getElementById('addSkillsSearchInput').value = category;
            handleAddSkillsSearch();
        }

        function addSkillFromLibrary(skillId) {
            if (!skillLibraryIndex) {
                alert('Skill library not loaded');
                return;
            }
            
            const skill = skillLibraryIndex.index.find(s => s.id === skillId);
            if (!skill) {
                alert('Skill not found');
                return;
            }
            
            if (isSkillAlreadyAdded(skill.n)) {
                return;
            }
            
            let category = 'unique';
            if (skill.c === 'Technology') category = 'skill';
            else if (skill.c.includes('General Professional')) category = 'ability';
            else if (skill.source === 'O*NET' && skill.sc && skill.sc.includes('Work Style')) category = 'workstyle';
            
            const newSkill = {
                name: skill.n,
                category: category,
                level: 'Advanced',
                roles: [userData.roles[0]?.id || 'default'],
                key: false,
                source: skill.source || 'library',
                libraryId: skill.id
            };
            
            userData.skills.push(newSkill);
            skillsData.skills.push(newSkill);
            
            saveUserData();
            updateSkillManagementCounts();
            refreshAllViews();
            
            const query = document.getElementById('addSkillsSearchInput').value;
            if (query) {
                performAddSkillsSearch(query);
            }
        }
        
        // ===== OVERFLOW MENU FUNCTIONS =====
        
        function toggleOverflowMenu(event) {
            if (event) {
                event.stopPropagation();
            }
            
            const menu = document.getElementById('overflowMenu');
            const btn = document.getElementById('overflowMenuBtn');
            const isVisible = menu.style.display === 'block';
            
            if (isVisible) {
                menu.style.display = 'none';
                btn.classList.remove('active');
            } else {
                menu.style.display = 'block';
                btn.classList.add('active');
            }
        }
        
        function closeOverflowMenu() {
            const menu = document.getElementById('overflowMenu');
            const btn = document.getElementById('overflowMenuBtn');
            if (menu) menu.style.display = 'none';
            if (btn) btn.classList.remove('active');
        }
        
        function showHelp() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">How to Use Work Blueprint</h2>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">ðŸ—ºï¸</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Skills Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">View your full skill network as an interactive graph or card view. Click any skill to see your evidence and outcomes. Use the role and level filters to explore different facets of your profile.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">ðŸ’¼</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Jobs Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">Find opportunities matched to your actual skill profile. Skills you have are highlighted green; gaps shown in red. Generate a personalized outreach message for any role.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">ðŸ“‹</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Applications Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">Track every role you've applied to. Log status, salary targets, contacts and notes. Keep your job search organized in one place.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">ðŸ“Š</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Work Blueprint Tab</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">See your market valuation, manage your outcomes, choose your values, and write your purpose statement. This is your source of truth. Export as a resume or personalized page to share with recruiters.</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: start;">
                            <div style="font-size: 2em; min-width: 40px;">âš™ï¸</div>
                            <div>
                                <div style="color: #60a5fa; font-weight: 600; margin-bottom: 5px;">Settings (More menu)</div>
                                <div style="color: #d1d5db; font-size: 0.95em; line-height: 1.6;">Update your profile info, preferences, and manage your skills. Export your full profile as JSON to save your work or move it to another device.</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.add('active');
        }
        
        function showAbout() {
            const modal = document.getElementById('exportModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Work Blueprint</h2>
                        <p style="color: #9ca3af; margin-top: 5px;">v3.5.2 Â· Your career, fully represented</p>
                    </div>
                    <button class="modal-close" onclick="closeExportModal()">Ã—</button>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <p style="color: #d1d5db; line-height: 1.8; margin-bottom: 20px;">
                        Most people underrepresent themselves when applying for work â€” not because they lack ability, 
                        but because they lack the tools to articulate it. Work Blueprint changes that.
                    </p>
                    <p style="color: #d1d5db; line-height: 1.8; margin-bottom: 20px;">
                        This tool guides you through fully discovering and documenting your skills, evidence, outcomes, 
                        values and purpose â€” then shows you what that profile is worth in the market. Export it as a 
                        traditional resume for ATS systems, or as a personalized interactive page for the humans 
                        making the actual hiring decision.
                    </p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                        <div style="background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #60a5fa; font-weight: 600; margin-bottom: 8px;">ðŸ—ºï¸ Skills Ontology</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">Map your full skill landscape â€” O*NET standard skills, abilities, work styles, and unique differentiators.</div>
                        </div>
                        <div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #10b981; font-weight: 600; margin-bottom: 8px;">ðŸ’° Market Valuation</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">See what your specific skill portfolio is worth â€” with negotiation ranges, not just a single number.</div>
                        </div>
                        <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #fbbf24; font-weight: 600; margin-bottom: 8px;">ðŸ“Š Work Blueprint</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">Build your complete professional narrative â€” outcomes, values, purpose â€” with full control over what you share.</div>
                        </div>
                        <div style="background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 8px; padding: 15px;">
                            <div style="color: #a78bfa; font-weight: 600; margin-bottom: 8px;">ðŸ”— Personalized Outreach</div>
                            <div style="color: #9ca3af; font-size: 0.9em;">Generate a company-specific page and recruiter email â€” one link that tells your story their way.</div>
                        </div>
                    </div>
                    <p style="color: #6b7280; font-size: 0.85em; text-align: center;">Free and open Â· No account required Â· Your data stays yours</p>
                </div>
            `;
            modal.classList.add('active');
        }
        
        // Close overflow menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('overflowMenu');
            const btn = document.getElementById('overflowMenuBtn');
            if (menu && btn && menu.style.display === 'block') {
                if (!menu.contains(event.target) && !btn.contains(event.target)) {
                    closeOverflowMenu();
                }
            }
        });
        
        // ===== BULK OPERATIONS =====
        
        let bulkSelectionMode = false;
        let selectedSkills = [];
        
        function toggleBulkMode() {
            bulkSelectionMode = !bulkSelectionMode;
            selectedSkills = [];
            refreshSkillsList();
        }
        
        function toggleSkillSelection(skillName) {
            const index = selectedSkills.indexOf(skillName);
            if (index === -1) {
                selectedSkills.push(skillName);
            } else {
                selectedSkills.splice(index, 1);
            }
            updateBulkModeBar();
        }
        
        function selectAllSkills() {
            selectedSkills = userData.skills.map(s => s.name);
            refreshSkillsList();
        }
        
        function deselectAllSkills() {
            selectedSkills = [];
            refreshSkillsList();
        }
        
        function updateBulkModeBar() {
            const bar = document.getElementById('bulkModeBar');
            if (bar) {
                const count = selectedSkills.length;
                bar.querySelector('.selected-count').textContent = `${count} selected`;
            }
        }
        
        function bulkDelete() {
            if (selectedSkills.length === 0) return;
            
            if (!confirm(`Delete ${selectedSkills.length} skills?\n\nThis cannot be undone.`)) {
                return;
            }
            
            // Remove from userData
            userData.skills = userData.skills.filter(s => !selectedSkills.includes(s.name));
            skillsData.skills = skillsData.skills.filter(s => !selectedSkills.includes(s.name));
            
            selectedSkills = [];
            saveUserData();
            refreshAllViews();
            
            alert('Skills deleted successfully!');
        }
        
        function bulkChangeProficiency(level) {
            if (selectedSkills.length === 0) return;
            
            // Update proficiency for all selected skills
            userData.skills.forEach(skill => {
                if (selectedSkills.includes(skill.name)) {
                    skill.level = level;
                }
            });
            
            skillsData.skills.forEach(skill => {
                if (selectedSkills.includes(skill.name)) {
                    skill.level = level;
                }
            });
            
            saveUserData();
            refreshAllViews();
            
            alert(`Updated ${selectedSkills.length} skills to ${level}!`);
        }
        
        function bulkAssignRole(roleId) {
            if (selectedSkills.length === 0) return;
            
            // Add role to all selected skills (don't remove existing roles)
            userData.skills.forEach(skill => {
                if (selectedSkills.includes(skill.name) && !skill.roles.includes(roleId)) {
                    skill.roles.push(roleId);
                }
            });
            
            skillsData.skills.forEach(skill => {
                if (selectedSkills.includes(skill.name) && !skill.roles.includes(roleId)) {
                    skill.roles.push(roleId);
                }
            });
            
            saveUserData();
            refreshAllViews();
            
            const role = userData.roles.find(r => r.id === roleId);
            alert(`Assigned ${selectedSkills.length} skills to "${role.name}"!`);
        }
        
        function bulkToggleCore() {
            if (selectedSkills.length === 0) return;
            
            // Toggle core status for all selected
            userData.skills.forEach(skill => {
                if (selectedSkills.includes(skill.name)) {
                    skill.key = !skill.key;
                }
            });
            
            skillsData.skills.forEach(skill => {
                if (selectedSkills.includes(skill.name)) {
                    skill.key = !skill.key;
                }
            });
            
            saveUserData();
            refreshAllViews();
            
            alert(`Toggled core status for ${selectedSkills.length} skills!`);
        }
        
        // ===== SKILL TEMPLATES =====
        
        function saveSkillTemplate() {
            const name = prompt('Template Name:', 'My Skill Set');
            if (!name) return;
            
            const description = prompt('Description (optional):', '');
            
            const template = {
                id: 'template-' + Date.now(),
                name: name,
                description: description || '',
                skills: selectedSkills.length > 0 
                    ? selectedSkills 
                    : userData.skills.map(s => s.name),
                created: new Date().toISOString(),
                skillCount: selectedSkills.length > 0 ? selectedSkills.length : userData.skills.length
            };
            
            if (!userData.skillTemplates) {
                userData.skillTemplates = [];
            }
            
            userData.skillTemplates.push(template);
            saveUserData();
            
            alert(`Template "${name}" saved with ${template.skillCount} skills!`);
        }
        
        function loadSkillTemplate() {
            if (!userData.skillTemplates || userData.skillTemplates.length === 0) {
                alert('No saved templates. Create one first by selecting skills and clicking "Save Template".');
                return;
            }
            
            let message = 'Select a template:\n\n';
            userData.skillTemplates.forEach((t, i) => {
                message += `${i + 1}. ${t.name} (${t.skillCount} skills)\n`;
            });
            
            const choice = prompt(message + '\nEnter number:');
            if (!choice) return;
            
            const index = parseInt(choice) - 1;
            if (index < 0 || index >= userData.skillTemplates.length) {
                alert('Invalid choice');
                return;
            }
            
            const template = userData.skillTemplates[index];
            
            if (!confirm(`Add ${template.skillCount} skills from "${template.name}"?`)) {
                return;
            }
            
            // Load template would require the full skill objects, not just names
            // For now, show message
            alert('Template loading feature coming soon!\n\nFor now, templates can be used to remember which skills go together.');
        }
        
        function deleteSkillTemplate() {
            if (!userData.skillTemplates || userData.skillTemplates.length === 0) {
                alert('No saved templates.');
                return;
            }
            
            let message = 'Select a template to delete:\n\n';
            userData.skillTemplates.forEach((t, i) => {
                message += `${i + 1}. ${t.name} (${t.skillCount} skills)\n`;
            });
            
            const choice = prompt(message + '\nEnter number:');
            if (!choice) return;
            
            const index = parseInt(choice) - 1;
            if (index < 0 || index >= userData.skillTemplates.length) {
                alert('Invalid choice');
                return;
            }
            
            const template = userData.skillTemplates[index];
            
            if (!confirm(`Delete template "${template.name}"?`)) {
                return;
            }
            
            userData.skillTemplates.splice(index, 1);
            saveUserData();
            
            alert('Template deleted!');
        }
        
        // ===== SORTING =====
        
        let currentSort = 'category'; // category, proficiency, alphabetical, role, core, recent
        
        function changeSortMethod(method) {
            currentSort = method;
            refreshSkillsList();
        }
        
        function sortSkills(skills, method) {
            const sorted = [...skills];
            
            switch(method) {
                case 'category':
                    // Skills, Abilities, Work Styles, Unique
                    const catOrder = { skill: 1, ability: 2, workstyle: 3, unique: 4 };
                    sorted.sort((a, b) => (catOrder[a.category] || 5) - (catOrder[b.category] || 5));
                    break;
                    
                case 'proficiency':
                    const levelOrder = { 'Mastery': 1, 'Expert': 2, 'Advanced': 3, 'Proficient': 4, 'Novice': 5 };
                    sorted.sort((a, b) => (levelOrder[a.level] || 4) - (levelOrder[b.level] || 4));
                    break;
                    
                case 'alphabetical':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                    
                case 'core':
                    sorted.sort((a, b) => (b.key ? 1 : 0) - (a.key ? 1 : 0));
                    break;
                    
                case 'recent':
                    // This would require adding timestamps when skills are added
                    // For now, just reverse the array
                    sorted.reverse();
                    break;
                    
                default:
                    break;
            }
            
            return sorted;
        }
        
        // Resize handler
        window.addEventListener('resize', () => {
            if (currentView === 'network') {
                initNetwork();
            }
        });
    </script>
</body>
</html>